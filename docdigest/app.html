<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DocDigest - AI PDF Summarizer | SUITE</title>
    <meta name="description" content="Upload any PDF and get an instant AI summary, key points, action items, and ask follow-up questions.">
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --bg: #0a0a0f;
            --bg-card: #1a1a2e;
            --bg-card-hover: #1e1e35;
            --border: #2a2a3e;
            --border-hover: #3a3a4e;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-glow: rgba(99, 102, 241, 0.15);
            --text: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-dim: #64748b;
            --success: #10b981;
            --error: #ef4444;
            --warning: #f59e0b;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 900px;
            padding: 24px 20px;
            flex: 1;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 32px;
        }

        .header-logo {
            display: inline-flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .header-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            background: linear-gradient(135deg, #e2e8f0, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 15px;
        }

        /* Upload Zone */
        .upload-zone {
            border: 2px dashed var(--border);
            border-radius: 16px;
            padding: 60px 24px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-card);
        }

        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--accent);
            background: var(--accent-glow);
        }

        .upload-zone-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, var(--accent), #8b5cf6);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upload-zone-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .upload-zone h3 {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-zone p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .upload-zone .browse-btn {
            display: inline-block;
            margin-top: 16px;
            padding: 10px 24px;
            background: var(--accent);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .upload-zone .browse-btn:hover {
            background: var(--accent-hover);
        }

        .file-info {
            display: none;
            margin-top: 20px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
        }

        .file-info.show {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-info-icon {
            width: 40px;
            height: 40px;
            background: rgba(239, 68, 68, 0.15);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .file-info-details {
            flex: 1;
            min-width: 0;
        }

        .file-info-name {
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .file-info-size {
            color: var(--text-secondary);
            font-size: 13px;
        }

        .file-info .remove-btn {
            background: none;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
            font-size: 18px;
            line-height: 1;
        }

        .file-info .remove-btn:hover {
            color: var(--error);
        }

        .analyze-btn {
            display: none;
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .analyze-btn.show {
            display: block;
        }

        .analyze-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .analyze-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Processing View */
        .processing-view {
            display: none;
            text-align: center;
            padding: 60px 24px;
        }

        .processing-view.show {
            display: block;
        }

        .processing-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .processing-view h3 {
            font-size: 18px;
            margin-bottom: 8px;
        }

        .processing-status {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 24px;
        }

        .progress-bar {
            width: 100%;
            max-width: 400px;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            margin: 0 auto;
            overflow: hidden;
        }

        .progress-bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6);
            border-radius: 3px;
            transition: width 0.3s;
            width: 0%;
        }

        /* Results View */
        .results-view {
            display: none;
        }

        .results-view.show {
            display: block;
        }

        .results-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .results-header h2 {
            font-size: 20px;
            font-weight: 700;
        }

        .results-doc-name {
            color: var(--text-secondary);
            font-size: 13px;
            margin-top: 2px;
        }

        .new-doc-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            color: var(--text);
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }

        .new-doc-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .tab {
            flex: 1;
            padding: 10px 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-radius: 7px;
            transition: all 0.2s;
            font-family: inherit;
            white-space: nowrap;
        }

        .tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .tab.active {
            background: var(--accent);
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Summary Tab */
        .summary-text {
            line-height: 1.7;
            color: var(--text);
            font-size: 15px;
        }

        .summary-text p {
            margin-bottom: 16px;
        }

        /* Key Points Tab */
        .key-points-list {
            list-style: none;
        }

        .key-points-list li {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .key-points-list li::before {
            content: '';
            width: 8px;
            height: 8px;
            background: var(--accent);
            border-radius: 50%;
            flex-shrink: 0;
            margin-top: 6px;
        }

        /* Action Items Tab */
        .action-items-list {
            list-style: none;
        }

        .action-items-list li {
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.5;
            display: flex;
            gap: 12px;
            align-items: flex-start;
        }

        .action-check {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 4px;
            flex-shrink: 0;
            margin-top: 1px;
        }

        .no-items {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
            font-size: 14px;
        }

        /* Q&A Tab */
        .qa-messages {
            max-height: 400px;
            overflow-y: auto;
            margin-bottom: 16px;
        }

        .qa-message {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 14px;
            line-height: 1.6;
        }

        .qa-message.user {
            background: var(--accent);
            color: white;
            margin-left: 40px;
        }

        .qa-message.ai {
            background: var(--bg-card);
            border: 1px solid var(--border);
            margin-right: 40px;
        }

        .qa-input-row {
            display: flex;
            gap: 8px;
        }

        .qa-input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            color: var(--text);
            font-size: 14px;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .qa-input:focus {
            border-color: var(--accent);
        }

        .qa-input::placeholder {
            color: var(--text-dim);
        }

        .qa-send-btn {
            padding: 12px 20px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            font-family: inherit;
            transition: background 0.2s;
            white-space: nowrap;
        }

        .qa-send-btn:hover:not(:disabled) {
            background: var(--accent-hover);
        }

        .qa-send-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .qa-placeholder {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
            font-size: 14px;
        }

        .qa-placeholder p:first-child {
            font-size: 24px;
            margin-bottom: 8px;
        }

        /* Error */
        .error-msg {
            display: none;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            color: var(--error);
            font-size: 14px;
            margin-top: 16px;
        }

        .error-msg.show {
            display: block;
        }

        /* Footer */
        .footer {
            text-align: center;
            padding: 20px;
            color: var(--text-dim);
            font-size: 12px;
        }

        .footer a {
            color: var(--accent);
            text-decoration: none;
        }

        /* Mobile */
        @media (max-width: 640px) {
            .container {
                padding: 16px 12px;
            }

            .header h1 {
                font-size: 22px;
            }

            .upload-zone {
                padding: 40px 16px;
            }

            .tabs {
                flex-wrap: wrap;
            }

            .tab {
                flex: 1 1 45%;
                font-size: 12px;
                padding: 8px 12px;
            }

            .qa-message.user {
                margin-left: 20px;
            }

            .qa-message.ai {
                margin-right: 20px;
            }

            .results-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="header-logo">
                <div class="header-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <polyline points="14 2 14 8 20 8"/>
                        <line x1="16" y1="13" x2="8" y2="13"/>
                        <line x1="16" y1="17" x2="8" y2="17"/>
                        <polyline points="10 9 9 9 8 9"/>
                    </svg>
                </div>
                <h1>DocDigest</h1>
            </div>
            <p>Upload any PDF — get instant summary, key points, and action items</p>
        </div>

        <!-- Upload View -->
        <div id="uploadView">
            <div class="upload-zone" id="uploadZone">
                <div class="upload-zone-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                        <polyline points="17 8 12 3 7 8"/>
                        <line x1="12" y1="3" x2="12" y2="15"/>
                    </svg>
                </div>
                <h3>Drop your PDF here</h3>
                <p>or click to browse</p>
                <span class="browse-btn">Choose PDF</span>
                <input type="file" id="fileInput" accept=".pdf" style="display:none">
            </div>

            <div class="file-info" id="fileInfo">
                <div class="file-info-icon">PDF</div>
                <div class="file-info-details">
                    <div class="file-info-name" id="fileName"></div>
                    <div class="file-info-size" id="fileSize"></div>
                </div>
                <button class="remove-btn" id="removeBtn" title="Remove file">&times;</button>
            </div>

            <button class="analyze-btn" id="analyzeBtn">Analyze Document</button>
            <div class="error-msg" id="errorMsg"></div>
        </div>

        <!-- Processing View -->
        <div class="processing-view" id="processingView">
            <div class="processing-spinner"></div>
            <h3 id="processingTitle">Extracting text...</h3>
            <p class="processing-status" id="processingStatus">Reading PDF pages...</p>
            <div class="progress-bar">
                <div class="progress-bar-fill" id="progressFill"></div>
            </div>
        </div>

        <!-- Results View -->
        <div class="results-view" id="resultsView">
            <div class="results-header">
                <div>
                    <h2>Analysis Complete</h2>
                    <div class="results-doc-name" id="resultsDocName"></div>
                </div>
                <button class="new-doc-btn" id="newDocBtn">New Document</button>
            </div>

            <div class="tabs">
                <button class="tab active" data-tab="summary">Summary</button>
                <button class="tab" data-tab="keypoints">Key Points</button>
                <button class="tab" data-tab="actions">Action Items</button>
                <button class="tab" data-tab="qa">Q&A</button>
            </div>

            <div class="tab-content active" id="tab-summary">
                <div class="summary-text" id="summaryContent"></div>
            </div>

            <div class="tab-content" id="tab-keypoints">
                <ul class="key-points-list" id="keyPointsList"></ul>
            </div>

            <div class="tab-content" id="tab-actions">
                <ul class="action-items-list" id="actionItemsList"></ul>
            </div>

            <div class="tab-content" id="tab-qa">
                <div class="qa-messages" id="qaMessages">
                    <div class="qa-placeholder">
                        <p>Ask anything about this document</p>
                        <p>e.g. "What are the main recommendations?" or "Summarize section 3"</p>
                    </div>
                </div>
                <div class="qa-input-row">
                    <input type="text" class="qa-input" id="qaInput" placeholder="Ask a question about this document...">
                    <button class="qa-send-btn" id="qaSendBtn">Ask</button>
                </div>
            </div>
        </div>
    </div>

    <div class="footer">
        Powered by <a href="https://suitegpt.app" target="_blank">SUITE</a> — 5 credits per analysis
    </div>

    <script>
        // State
        let selectedFile = null;
        let extractedText = '';
        let docName = '';
        let qaHistory = [];

        // Elements
        const uploadZone = document.getElementById('uploadZone');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const removeBtn = document.getElementById('removeBtn');
        const analyzeBtn = document.getElementById('analyzeBtn');
        const errorMsg = document.getElementById('errorMsg');
        const processingView = document.getElementById('processingView');
        const processingTitle = document.getElementById('processingTitle');
        const processingStatus = document.getElementById('processingStatus');
        const progressFill = document.getElementById('progressFill');
        const resultsView = document.getElementById('resultsView');
        const uploadView = document.getElementById('uploadView');
        const newDocBtn = document.getElementById('newDocBtn');
        const qaInput = document.getElementById('qaInput');
        const qaSendBtn = document.getElementById('qaSendBtn');
        const qaMessages = document.getElementById('qaMessages');

        // PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Credit charging
        function chargeCredits(feature) {
            if (window.parent !== window) {
                window.parent.postMessage({
                    type: 'suite-charge-credits',
                    appId: 'docdigest',
                    feature: feature,
                    chargeId: 'dd-' + Date.now(),
                    amount: 5
                }, '*');
            }
        }

        // File handling
        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/pdf') {
                handleFile(file);
            } else {
                showError('Please upload a PDF file');
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files[0]) handleFile(e.target.files[0]);
        });

        removeBtn.addEventListener('click', () => {
            selectedFile = null;
            fileInput.value = '';
            fileInfo.classList.remove('show');
            analyzeBtn.classList.remove('show');
            hideError();
        });

        function handleFile(file) {
            if (file.size > 50 * 1024 * 1024) {
                showError('File size must be under 50MB');
                return;
            }
            selectedFile = file;
            docName = file.name;
            fileName.textContent = file.name;
            fileSize.textContent = formatSize(file.size);
            fileInfo.classList.add('show');
            analyzeBtn.classList.add('show');
            hideError();
        }

        function formatSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
            return (bytes / 1048576).toFixed(1) + ' MB';
        }

        function showError(msg) {
            errorMsg.textContent = msg;
            errorMsg.classList.add('show');
        }

        function hideError() {
            errorMsg.classList.remove('show');
        }

        // Analyze
        analyzeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            analyzeBtn.disabled = true;

            uploadView.style.display = 'none';
            processingView.classList.add('show');
            progressFill.style.width = '0%';

            try {
                // Step 1: Extract text
                processingTitle.textContent = 'Extracting text...';
                processingStatus.textContent = 'Reading PDF pages...';

                const arrayBuffer = await selectedFile.arrayBuffer();
                const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                const totalPages = pdf.numPages;
                let text = '';

                for (let i = 1; i <= totalPages; i++) {
                    processingStatus.textContent = `Extracting page ${i} of ${totalPages}...`;
                    progressFill.style.width = `${(i / totalPages) * 50}%`;

                    const page = await pdf.getPage(i);
                    const content = await page.getTextContent();
                    const pageText = content.items.map(item => item.str).join(' ');
                    text += pageText + '\n\n';
                }

                extractedText = text.trim();

                if (!extractedText || extractedText.length < 50) {
                    throw new Error('Could not extract enough text from this PDF. It may be a scanned image or contain very little text.');
                }

                // Step 2: Send to AI
                processingTitle.textContent = 'Analyzing document...';
                processingStatus.textContent = 'AI is reading and summarizing...';
                progressFill.style.width = '60%';

                chargeCredits('summarize');

                const response = await fetch('/api/docdigest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode: 'summarize', text: extractedText })
                });

                progressFill.style.width = '90%';

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Analysis failed');
                }

                const result = await response.json();
                progressFill.style.width = '100%';

                // Show results
                showResults(result);

            } catch (err) {
                processingView.classList.remove('show');
                uploadView.style.display = 'block';
                analyzeBtn.disabled = false;
                showError(err.message || 'Failed to analyze document');
            }
        });

        function showResults(data) {
            processingView.classList.remove('show');
            resultsView.classList.add('show');
            document.getElementById('resultsDocName').textContent = docName;

            // Summary
            const summaryHtml = data.summary
                .split('\n\n')
                .filter(p => p.trim())
                .map(p => `<p>${escapeHtml(p.trim())}</p>`)
                .join('');
            document.getElementById('summaryContent').innerHTML = summaryHtml || '<p>No summary available.</p>';

            // Key Points
            const kpList = document.getElementById('keyPointsList');
            if (data.keyPoints && data.keyPoints.length > 0) {
                kpList.innerHTML = data.keyPoints
                    .map(p => `<li>${escapeHtml(p)}</li>`)
                    .join('');
            } else {
                kpList.innerHTML = '<div class="no-items">No key points extracted.</div>';
            }

            // Action Items
            const aiList = document.getElementById('actionItemsList');
            if (data.actionItems && data.actionItems.length > 0) {
                aiList.innerHTML = data.actionItems
                    .map(a => `<li><div class="action-check"></div>${escapeHtml(a)}</li>`)
                    .join('');
            } else {
                aiList.innerHTML = '<div class="no-items">No action items found in this document.</div>';
            }

            // Reset Q&A
            qaHistory = [];
            qaMessages.innerHTML = `
                <div class="qa-placeholder">
                    <p>Ask anything about this document</p>
                    <p>e.g. "What are the main recommendations?" or "Summarize section 3"</p>
                </div>
            `;
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Tabs
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', () => {
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                tab.classList.add('active');
                document.getElementById('tab-' + tab.dataset.tab).classList.add('active');
            });
        });

        // Q&A
        qaSendBtn.addEventListener('click', sendQuestion);
        qaInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuestion();
            }
        });

        async function sendQuestion() {
            const question = qaInput.value.trim();
            if (!question || !extractedText) return;

            // Clear placeholder
            const placeholder = qaMessages.querySelector('.qa-placeholder');
            if (placeholder) placeholder.remove();

            // Add user message
            qaMessages.innerHTML += `<div class="qa-message user">${escapeHtml(question)}</div>`;
            qaInput.value = '';
            qaSendBtn.disabled = true;
            qaInput.disabled = true;

            // Add loading message
            const loadingId = 'qa-loading-' + Date.now();
            qaMessages.innerHTML += `<div class="qa-message ai" id="${loadingId}">Thinking...</div>`;
            qaMessages.scrollTop = qaMessages.scrollHeight;

            try {
                chargeCredits('qa');

                const response = await fetch('/api/docdigest', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'qa',
                        text: extractedText,
                        question: question,
                        history: qaHistory
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    throw new Error(err.error || 'Failed to get answer');
                }

                const result = await response.json();

                // Update loading message with answer
                document.getElementById(loadingId).textContent = result.answer;

                // Update history
                qaHistory.push({ role: 'user', content: question });
                qaHistory.push({ role: 'model', content: result.answer });

            } catch (err) {
                document.getElementById(loadingId).textContent = 'Error: ' + err.message;
                document.getElementById(loadingId).style.borderColor = 'rgba(239,68,68,0.3)';
            }

            qaSendBtn.disabled = false;
            qaInput.disabled = false;
            qaInput.focus();
            qaMessages.scrollTop = qaMessages.scrollHeight;
        }

        // New Document
        newDocBtn.addEventListener('click', () => {
            selectedFile = null;
            extractedText = '';
            docName = '';
            qaHistory = [];
            fileInput.value = '';

            resultsView.classList.remove('show');
            uploadView.style.display = 'block';
            fileInfo.classList.remove('show');
            analyzeBtn.classList.remove('show');
            analyzeBtn.disabled = false;
            hideError();
        });
    </script>
</body>
</html>
