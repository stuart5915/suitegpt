<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | SUITE</title>
    <link rel="icon" type="image/png" href="assets/suite-mascot.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="suite-styles.css">
    <style>
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: white;
            font-family: 'Nunito', sans-serif;
        }

        .admin-container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 20px;
        }

        .admin-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .admin-header h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 900;
            color: #ff9500;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 8px;
        }

        .section-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
        }

        .table-container {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px;
            overflow: hidden;
            margin-bottom: 40px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th,
        td {
            padding: 16px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            background: rgba(255, 149, 0, 0.2);
            font-weight: 700;
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge-verified {
            background: #10b981;
        }

        .badge-unverified {
            background: #f59e0b;
        }

        .badge-flagged {
            background: #ef4444;
        }

        .login-prompt {
            text-align: center;
            padding: 80px 20px;
        }

        .login-btn {
            background: #5865F2;
            color: white;
            padding: 16px 32px;
            border-radius: 12px;
            border: none;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .login-btn:hover {
            background: #4752c4;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            opacity: 0.7;
        }
    </style>
</head>

<body>
    <div class="admin-container">
        <div class="admin-header">
            <h1>üõ°Ô∏è Admin Dashboard</h1>
            <p>Ad Revenue & Fraud Monitoring</p>
        </div>

        <!-- Login Section -->
        <div id="loginSection" class="login-prompt">
            <h2>Admin Access Required</h2>
            <p>Login with Discord to access the admin dashboard.</p>
            <button class="login-btn" onclick="loginWithDiscord()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515a.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0a12.64 12.64 0 0 0-.617-1.25a.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057a19.9 19.9 0 0 0 5.993 3.03a.078.078 0 0 0 .084-.028a14.09 14.09 0 0 0 1.226-1.994a.076.076 0 0 0-.041-.106a13.107 13.107 0 0 1-1.872-.892a.077.077 0 0 1-.008-.128a10.2 10.2 0 0 0 .372-.292a.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127a12.299 12.299 0 0 1-1.873.892a.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028a19.839 19.839 0 0 0 6.002-3.03a.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z" />
                </svg>
                Login with Discord
            </button>
        </div>

        <!-- Dashboard Section -->
        <div id="dashboardSection" style="display: none;">
            <button class="refresh-btn" onclick="loadDashboard()">üîÑ Refresh Data</button>

            <!-- Stats Grid -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalAds">--</div>
                    <div class="stat-label">Total Ads Today</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="verifiedAds">--</div>
                    <div class="stat-label">‚úÖ Verified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="unverifiedAds">--</div>
                    <div class="stat-label">‚ö†Ô∏è Unverified</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="suiteCredits">--</div>
                    <div class="stat-label">SUITE Credited</div>
                </div>
            </div>

            <!-- Suspicious Users -->
            <h2 class="section-title">üö© Suspicious Users (High Unverified Rate)</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Discord ID</th>
                            <th>Total Ads</th>
                            <th>Verified</th>
                            <th>Unverified</th>
                            <th>Rate</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="suspiciousUsers">
                        <tr>
                            <td colspan="6" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Recent Events -->
            <h2 class="section-title">üìã Recent Ad Events</h2>
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Time</th>
                            <th>Discord ID</th>
                            <th>Status</th>
                            <th>Verified</th>
                        </tr>
                    </thead>
                    <tbody id="recentEvents">
                        <tr>
                            <td colspan="4" class="loading">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.rTqKxT2LYhPt5nQEjLxMxdRDqvVoT7eILWHhBo1MVHU';

        // Owner Discord ID - only this user can access
        const OWNER_ID = '367831919327346690';

        const DISCORD_CLIENT_ID = '1457474266390986865';
        const REDIRECT_URI = window.location.origin + '/admin.html';

        let currentUser = null;

        document.addEventListener('DOMContentLoaded', () => {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');

            if (accessToken) {
                handleOAuthCallback(accessToken);
            } else {
                const savedUser = localStorage.getItem('suiteAdmin');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    if (currentUser.id === OWNER_ID) {
                        showDashboard();
                    } else {
                        alert('Access denied. Admin only.');
                        localStorage.removeItem('suiteAdmin');
                    }
                }
            }
        });

        function loginWithDiscord() {
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        async function handleOAuthCallback(accessToken) {
            try {
                const response = await fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const user = await response.json();

                if (user.id !== OWNER_ID) {
                    alert('Access denied. Admin only.');
                    return;
                }

                currentUser = user;
                localStorage.setItem('suiteAdmin', JSON.stringify(user));
                history.replaceState(null, '', window.location.pathname);
                showDashboard();
            } catch (error) {
                console.error('Auth error:', error);
                alert('Login failed.');
            }
        }

        function showDashboard() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('dashboardSection').style.display = 'block';
            loadDashboard();
        }

        async function loadDashboard() {
            await loadStats();
            await loadSuspiciousUsers();
            await loadRecentEvents();
        }

        async function loadStats() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ad_events?created_at=gte.${today}T00:00:00&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const events = await response.json();

                const credited = events.filter(e => e.event_type === 'credited');
                const verified = credited.filter(e => e.error_message?.includes('verified:true'));
                const unverified = credited.filter(e => e.error_message?.includes('verified:false'));

                document.getElementById('totalAds').textContent = credited.length;
                document.getElementById('verifiedAds').textContent = verified.length;
                document.getElementById('unverifiedAds').textContent = unverified.length;
                document.getElementById('suiteCredits').textContent = (credited.length * 2) + ' SUITE';
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadSuspiciousUsers() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ad_events?event_type=eq.credited&select=discord_id,error_message`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const events = await response.json();

                // Group by user
                const userStats = {};
                events.forEach(e => {
                    if (!userStats[e.discord_id]) {
                        userStats[e.discord_id] = { verified: 0, unverified: 0 };
                    }
                    if (e.error_message?.includes('verified:true')) {
                        userStats[e.discord_id].verified++;
                    } else {
                        userStats[e.discord_id].unverified++;
                    }
                });

                // Find suspicious (>50% unverified with 3+ ads)
                const suspicious = Object.entries(userStats)
                    .map(([id, stats]) => ({
                        discord_id: id,
                        total: stats.verified + stats.unverified,
                        verified: stats.verified,
                        unverified: stats.unverified,
                        rate: ((stats.unverified / (stats.verified + stats.unverified)) * 100).toFixed(0)
                    }))
                    .filter(u => u.total >= 3 && u.rate > 50)
                    .sort((a, b) => b.rate - a.rate);

                const tbody = document.getElementById('suspiciousUsers');
                if (suspicious.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; opacity: 0.7;">‚úÖ No suspicious users found</td></tr>';
                } else {
                    tbody.innerHTML = suspicious.map(u => `
                        <tr>
                            <td>${u.discord_id}</td>
                            <td>${u.total}</td>
                            <td>${u.verified}</td>
                            <td>${u.unverified}</td>
                            <td>${u.rate}% unverified</td>
                            <td><span class="badge badge-flagged">üö© Flagged</span></td>
                        </tr>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading suspicious users:', error);
            }
        }

        async function loadRecentEvents() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ad_events?order=created_at.desc&limit=20&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const events = await response.json();

                const tbody = document.getElementById('recentEvents');
                tbody.innerHTML = events.map(e => {
                    const time = new Date(e.created_at).toLocaleTimeString();
                    const verified = e.error_message?.includes('verified:true');
                    const status = e.event_type;
                    return `
                        <tr>
                            <td>${time}</td>
                            <td>${e.discord_id.substring(0, 10)}...</td>
                            <td><span class="badge ${status === 'credited' ? 'badge-verified' : 'badge-unverified'}">${status}</span></td>
                            <td>${verified ? '‚úÖ' : '‚ö†Ô∏è'}</td>
                        </tr>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }
    </script>
</body>

</html>