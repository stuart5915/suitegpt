<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentScape Forge | Asset Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.5.0/model-viewer.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-base: #08080d;
            --bg-surface: #0f0f17;
            --bg-elevated: #16161f;
            --bg-hover: #1e1e2e;
            --bg-active: #252538;
            --border: #2a2a3d;
            --border-light: #3a3a52;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-dim: #4f46e5;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --tier-bronze: #CD7F32;
            --tier-iron: #71797E;
            --tier-steel: #C0C0C0;
            --tier-mithril: #7B68EE;
            --tier-rune: #00CED1;
            --tier-dragon: #DC143C;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-base); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .header { height: 52px; background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 16px; flex-shrink: 0; }
        .header-logo { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .header-logo span { color: var(--accent); }
        .header-progress { flex: 1; display: flex; align-items: center; gap: 10px; margin-left: 24px; }
        .header-progress-text { font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
        .header-progress-bar { flex: 1; max-width: 300px; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; }
        .header-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 3px; transition: width 0.3s; }
        .header-actions { display: flex; gap: 8px; }
        .btn { padding: 7px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; font-family: inherit; }
        .btn:hover { background: var(--bg-hover); border-color: var(--border-light); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: rgba(239,68,68,0.1); }
        .btn-success { background: var(--success); border-color: var(--success); color: #000; }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 232px; background: var(--bg-surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .sidebar-group { padding: 12px 0 4px 0; }
        .sidebar-group-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); padding: 0 16px; margin-bottom: 4px; }
        .sidebar-item { display: flex; align-items: center; padding: 8px 16px; cursor: pointer; transition: all 0.1s; gap: 10px; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: var(--bg-hover); }
        .sidebar-item.active { background: var(--bg-elevated); border-left-color: var(--accent); }
        .sidebar-item-icon { font-size: 16px; width: 24px; text-align: center; }
        .sidebar-item-name { font-size: 13px; font-weight: 500; flex: 1; }
        .sidebar-item-count { font-size: 11px; color: var(--text-muted); font-weight: 600; }
        .sidebar-item-count.complete { color: var(--success); }
        .sidebar-footer { margin-top: auto; padding: 12px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
        .sidebar-footer .btn { width: 100%; justify-content: center; }

        /* MAIN GRID */
        .main { flex: 1; overflow-y: auto; padding: 24px; }
        .main-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .main-title { font-size: 20px; font-weight: 700; }
        .main-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .item-card { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 16px 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.15s; position: relative; }
        .item-card:hover { background: var(--bg-hover); border-color: var(--border-light); transform: translateY(-2px); }
        .item-card.has-asset { border-color: var(--success); }
        .item-card.has-asset::after { content: ''; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--success); border-radius: 50%; }
        .item-card.has-3d::before { content: '3D'; position: absolute; top: 8px; left: 8px; font-size: 9px; font-weight: 800; background: var(--accent); color: #fff; padding: 1px 5px; border-radius: 4px; }
        .badge-3d { display: inline-block; font-size: 9px; font-weight: 800; background: var(--accent); color: #fff; padding: 1px 6px; border-radius: 4px; margin-left: 6px; }
        .progress-bar-mini { width: 100%; height: 4px; background: var(--bg-active); border-radius: 2px; overflow: hidden; margin-top: 6px; }
        .progress-bar-mini-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; }
        .batch-status { font-size: 11px; color: var(--text-secondary); margin-top: 8px; min-height: 16px; }
        .item-card-preview { width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 36px; margin-bottom: 8px; border-radius: 6px; background: var(--bg-active); overflow: hidden; }
        .item-card-preview img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .item-card-name { font-size: 12px; font-weight: 600; text-align: center; line-height: 1.3; }
        .item-card-tier { font-size: 10px; font-weight: 700; margin-top: 4px; padding: 1px 8px; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-card-type { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        .tier-1 { color: var(--tier-bronze); border: 1px solid var(--tier-bronze); }
        .tier-2 { color: var(--tier-iron); border: 1px solid var(--tier-iron); }
        .tier-3 { color: var(--tier-steel); border: 1px solid var(--tier-steel); }
        .tier-4 { color: var(--tier-mithril); border: 1px solid var(--tier-mithril); }
        .tier-5 { color: var(--tier-rune); border: 1px solid var(--tier-rune); }
        .tier-6 { color: var(--tier-dragon); border: 1px solid var(--tier-dragon); }

        /* MODAL OVERLAY */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; width: 680px; max-width: 95vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { display: flex; gap: 0; overflow-y: auto; flex: 1; }
        .modal-preview { flex: 0 0 260px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: var(--bg-base); border-right: 1px solid var(--border); }
        .modal-preview-img { width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; font-size: 80px; background: var(--bg-elevated); border-radius: 12px; border: 2px dashed var(--border); overflow: hidden; }
        .modal-preview-img img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .modal-preview-img.has-image { border-style: solid; border-color: var(--success); }
        .preview-3d { margin-top: 12px; width: 180px; display: none; }
        .preview-3d.visible { display: block; }
        .preview-3d-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 6px; text-align: center; }
        .preview-3d-viewer { width: 180px; height: 180px; border-radius: 8px; border: 1px solid var(--border); overflow: hidden; background: var(--bg-elevated); }
        .preview-3d-viewer model-viewer { width: 100%; height: 100%; --poster-color: transparent; }
        .preview-3d-hint { font-size: 9px; color: var(--text-muted); text-align: center; margin-top: 4px; }
        .modal-stats { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .stat-badge { font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px; background: var(--bg-elevated); border: 1px solid var(--border); }
        .modal-controls { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
        .control-input { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 13px; font-family: inherit; resize: vertical; }
        .control-input:focus { outline: none; border-color: var(--accent); }
        textarea.control-input { min-height: 80px; }
        .control-row { display: flex; gap: 8px; }
        .control-row .btn { flex: 1; justify-content: center; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
        .generating-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--text-muted); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-arrows { display: flex; gap: 6px; }
        .nav-arrow { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .nav-arrow:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* SETTINGS MODAL */
        .settings-modal { width: 480px; }
        .settings-section { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h3 { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .settings-note { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        /* TOAST */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; font-size: 13px; z-index: 200; display: none; animation: slideUp 0.3s; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; }

        /* ============ ANIMATION EDITOR ============ */
        .anim-editor { display: none; flex-direction: column; padding: 0 !important; overflow: hidden; }
        .anim-toolbar { display: flex; align-items: center; gap: 12px; padding: 10px 16px; border-bottom: 1px solid var(--border); background: var(--bg-surface); flex-wrap: wrap; flex-shrink: 0; }
        .anim-selector { display: flex; gap: 8px; align-items: center; }
        .anim-selector select { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-primary); padding: 6px 10px; border-radius: 6px; font-size: 13px; font-family: inherit; min-width: 180px; }
        .anim-playback { display: flex; align-items: center; gap: 8px; }
        .anim-loop-label { font-size: 12px; color: var(--text-secondary); display: flex; align-items: center; gap: 4px; cursor: pointer; user-select: none; }
        .anim-speed { display: flex; align-items: center; gap: 6px; font-size: 12px; color: var(--text-secondary); }
        .anim-speed input[type=range] { width: 80px; accent-color: var(--accent); }
        .anim-actions { margin-left: auto; display: flex; gap: 8px; }
        .anim-workspace { display: flex; flex: 1; overflow: hidden; min-height: 0; }
        .anim-preview-panel { width: 380px; min-width: 300px; background: var(--bg-base); border-right: 1px solid var(--border); display: flex; flex-direction: column; position: relative; }
        .anim-preview-panel canvas { width: 100% !important; height: 100% !important; flex: 1; display: block; cursor: grab; }
        .anim-preview-panel canvas:active { cursor: grabbing; }
        .anim-preview-info { position: absolute; bottom: 8px; left: 8px; font-size: 11px; color: var(--text-muted); background: rgba(0,0,0,0.6); padding: 3px 8px; border-radius: 4px; pointer-events: none; }
        .anim-preview-hint { position: absolute; top: 8px; right: 8px; font-size: 10px; color: var(--text-muted); background: rgba(0,0,0,0.4); padding: 2px 6px; border-radius: 3px; pointer-events: none; }
        .anim-controls-panel { flex: 1; overflow-y: auto; padding: 16px; }
        .anim-controls-scroll { display: flex; flex-direction: column; gap: 12px; }
        .joint-group { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 8px; padding: 12px 14px; }
        .joint-group-header { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin-bottom: 8px; }
        .joint-slider { display: flex; align-items: center; gap: 10px; margin-bottom: 6px; }
        .joint-slider:last-child { margin-bottom: 0; }
        .joint-slider label { font-size: 12px; color: var(--text-secondary); width: 90px; flex-shrink: 0; }
        .joint-slider input[type=range] { flex: 1; accent-color: var(--accent); }
        .joint-slider .slider-val { font-size: 11px; color: var(--text-muted); width: 50px; text-align: right; font-family: 'Courier New', monospace; }
        .anim-timeline-panel { border-top: 1px solid var(--border); background: var(--bg-surface); flex-shrink: 0; }
        .anim-timeline-header { display: flex; align-items: center; gap: 8px; padding: 8px 16px; border-bottom: 1px solid var(--border); }
        .anim-duration-label { font-size: 12px; color: var(--text-secondary); }
        .anim-duration-input { width: 60px !important; padding: 4px 8px !important; font-size: 12px !important; min-height: auto !important; }
        .anim-timeline-track { height: 80px; position: relative; cursor: crosshair; }
        .anim-timeline-track canvas { width: 100%; height: 100%; display: block; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-logo"><span>AgentScape</span> Forge</div>
    <div class="header-progress">
        <span class="header-progress-text" id="progress-text">0 / 50 assets</span>
        <div class="header-progress-bar"><div class="header-progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>
    <div class="header-actions">
        <a href="/forge/gamedata" class="btn" style="text-decoration:none;">Game Data</a>
        <button class="btn" onclick="openSettings()">Settings</button>
        <button class="btn" id="btn-batch" onclick="batchGenerate()">Generate All</button>
        <button class="btn btn-primary" onclick="exportAll()">Export ZIP</button>
    </div>
    <div id="batch-bar" style="display:none;position:fixed;top:52px;left:0;right:0;background:var(--bg-surface);border-bottom:1px solid var(--border);padding:8px 20px;z-index:50;display:none;">
        <div style="display:flex;align-items:center;gap:12px;">
            <span class="generating-spinner"></span>
            <span id="batch-text" style="font-size:12px;">Generating...</span>
            <div style="flex:1;max-width:400px;height:6px;background:var(--bg-elevated);border-radius:3px;overflow:hidden;"><div id="batch-fill" style="height:100%;background:linear-gradient(90deg,var(--accent),var(--success));border-radius:3px;transition:width 0.3s;width:0%"></div></div>
            <button class="btn btn-danger" onclick="cancelBatch()" style="padding:4px 10px;font-size:11px;">Cancel</button>
        </div>
    </div>
</div>

<!-- LAYOUT -->
<div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar"></div>

    <!-- MAIN GRID -->
    <div class="main" id="main"></div>

    <!-- ANIMATION EDITOR -->
    <div class="main anim-editor" id="anim-editor">
        <div class="anim-toolbar">
            <div class="anim-selector">
                <select id="anim-select" onchange="selectAnimation(this.value)"></select>
                <button class="btn" onclick="createNewAnimation()">+ New</button>
            </div>
            <div class="anim-playback">
                <button class="btn" id="anim-play-btn" onclick="animTogglePlay()">&#9654; Play</button>
                <button class="btn" onclick="animStop()">&#9632; Stop</button>
                <label class="anim-loop-label"><input type="checkbox" id="anim-loop" onchange="animLoopChanged(this.checked)"> Loop</label>
                <div class="anim-speed">
                    <span>Speed:</span>
                    <input type="range" min="0.1" max="3" step="0.1" value="1" id="anim-speed-slider" oninput="animSpeedChanged(this.value)">
                    <span id="anim-speed-val">1.0x</span>
                </div>
            </div>
            <div class="anim-actions">
                <button class="btn" onclick="animExportCode()">Export Code</button>
                <button class="btn btn-primary" onclick="animSave()">Save</button>
            </div>
        </div>
        <div class="anim-workspace">
            <div class="anim-preview-panel" id="anim-preview-panel">
                <canvas id="anim-canvas"></canvas>
                <div class="anim-preview-info"><span id="anim-time-display">0.00s / 0.60s</span></div>
                <div class="anim-preview-hint">Drag to orbit &middot; Scroll to zoom</div>
            </div>
            <div class="anim-controls-panel">
                <div class="anim-controls-scroll" id="anim-controls-scroll"></div>
            </div>
        </div>
        <div class="anim-timeline-panel">
            <div class="anim-timeline-header">
                <button class="btn" onclick="addKeyframe()">+ Keyframe</button>
                <button class="btn" onclick="deleteKeyframe()">&#8722; Delete</button>
                <button class="btn" onclick="copyKeyframe()">Copy</button>
                <button class="btn" onclick="pasteKeyframe()">Paste</button>
                <div style="flex:1"></div>
                <span class="anim-duration-label">Duration:</span>
                <input type="number" class="control-input anim-duration-input" id="anim-duration" value="0.6" min="0.1" max="10" step="0.1" onchange="animDurationChanged(this.value)">
                <span class="anim-duration-label">s</span>
            </div>
            <div class="anim-timeline-track" id="anim-timeline-track">
                <canvas id="timeline-canvas"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="item-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modal-title"></h2>
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="nav-arrows">
                    <button class="nav-arrow" onclick="navItem(-1)" title="Previous">&#8592;</button>
                    <button class="nav-arrow" onclick="navItem(1)" title="Next">&#8594;</button>
                </div>
                <button class="modal-close" onclick="closeItemModal()">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-preview">
                <div class="modal-preview-img" id="modal-preview-img"></div>
                <div class="preview-3d" id="preview-3d">
                    <div class="preview-3d-label">3D Preview</div>
                    <div class="preview-3d-viewer" id="preview-3d-viewer">
                        <model-viewer id="model-viewer-el" camera-controls auto-rotate shadow-intensity="1" exposure="1.2" style="width:100%;height:100%;background:transparent;"></model-viewer>
                    </div>
                    <div class="preview-3d-hint">Drag to rotate / Scroll to zoom</div>
                </div>
                <div class="modal-stats" id="modal-stats"></div>
            </div>
            <div class="modal-controls">
                <div class="control-group">
                    <label class="control-label">Description / Prompt</label>
                    <textarea class="control-input" id="modal-prompt" placeholder="Describe how this item should look..."></textarea>
                </div>
                <div class="control-group">
                    <label class="control-label">Style Override (optional)</label>
                    <input class="control-input" id="modal-style" placeholder="Leave blank to use global style">
                </div>
                <div class="control-row">
                    <button class="btn btn-primary" id="btn-generate" onclick="generateImage()">Generate 2D</button>
                    <button class="btn" onclick="uploadCustom()">Upload</button>
                </div>
                <div class="control-row" id="btn-3d-row" style="display:none">
                    <button class="btn" id="btn-generate-3d" onclick="generate3D()" style="border-color:var(--accent);color:var(--accent);">Generate 3D Model</button>
                </div>
                <div id="meshy-progress" style="display:none">
                    <div class="progress-bar-mini"><div class="progress-bar-mini-fill" id="meshy-progress-fill" style="width:0%"></div></div>
                    <div class="batch-status" id="meshy-status">Waiting...</div>
                </div>
                <div class="control-row" id="asset-actions" style="display:none">
                    <button class="btn btn-danger" onclick="clearAsset()">Remove</button>
                    <button class="btn" onclick="downloadSingle()">Download PNG</button>
                    <button class="btn" id="btn-dl-3d" onclick="download3D()" style="display:none">Download GLB</button>
                </div>
                <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleUpload(event)">
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal settings-modal">
        <div class="modal-header">
            <h2>Settings</h2>
            <button class="modal-close" onclick="closeSettings()">&times;</button>
        </div>
        <div class="settings-section">
            <h3>Gemini API Key</h3>
            <input class="control-input" id="setting-apikey" type="password" placeholder="AIza..." style="width:100%">
            <p class="settings-note">Used for 2D image generation. Get your key at <a href="https://aistudio.google.com/apikey" target="_blank" style="color:var(--accent)">aistudio.google.com/apikey</a> — free tier available.</p>
        </div>
        <div class="settings-section">
            <h3>Meshy API Key</h3>
            <input class="control-input" id="setting-meshykey" type="password" placeholder="msy_..." style="width:100%">
            <p class="settings-note">Used for 2D → 3D model generation. Get your key at <a href="https://www.meshy.ai/api" target="_blank" style="color:var(--accent)">meshy.ai/api</a></p>
        </div>
        <div class="settings-section">
            <h3>Global Style Prefix</h3>
            <textarea class="control-input" id="setting-style" style="width:100%;min-height:60px"></textarea>
            <p class="settings-note">Prepended to every generation prompt for consistency.</p>
        </div>
        <div class="settings-section">
            <h3>Image Model</h3>
            <select class="control-input" id="setting-model" style="width:100%">
                <option value="gemini-2.5-flash-image">Gemini 2.5 Flash (fast, free tier)</option>
                <option value="gemini-2.5-pro-image">Gemini 2.5 Pro (higher quality)</option>
            </select>
        </div>
        <div class="settings-section" style="display:flex;justify-content:flex-end;">
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// ITEM REGISTRY — All 50 items from AgentScape config
// ============================================================
const TIER_NAMES = { 1:'Bronze', 2:'Iron', 3:'Steel', 4:'Mithril', 5:'Rune', 6:'Dragon' };
const TIER_HINTS = {
    1: 'copper-brown metal, crude simple design',
    2: 'dark gray iron, functional sturdy design',
    3: 'polished bright silver steel, refined design',
    4: 'blue-purple glowing mithril, ornate magical design',
    5: 'teal cyan glowing rune metal, elegant with rune symbols',
    6: 'crimson red dragon metal, fierce and fearsome design'
};

const CATEGORIES = [
    { id:'swords', name:'Swords', icon:'\u2694\uFE0F', group:'Equipment' },
    { id:'helms', name:'Helms', icon:'\uD83E\uDE96', group:'Equipment' },
    { id:'shields', name:'Shields', icon:'\uD83D\uDEE1\uFE0F', group:'Equipment' },
    { id:'tools', name:'Tools', icon:'\uD83E\uDE93', group:'Equipment' },
    { id:'food', name:'Food', icon:'\uD83C\uDF56', group:'Consumables' },
    { id:'potions', name:'Potions', icon:'\u2697\uFE0F', group:'Consumables' },
    { id:'resources', name:'Resources', icon:'\uD83E\uDEB5', group:'Materials' },
    { id:'crafting', name:'Crafting', icon:'\uD83D\uDC8E', group:'Materials' },
    { id:'drops', name:'Monster Drops', icon:'\uD83E\uDDE0', group:'Materials' },
    { id:'trophies', name:'Trophies', icon:'\uD83C\uDFC6', group:'Special' },
    { id:'misc', name:'Misc & Quest', icon:'\uD83D\uDD2E', group:'Special' },
    { id:'currency', name:'Currency', icon:'\uD83E\uDE99', group:'Special' },
];

const ITEMS = [
    // --- Swords ---
    { id:'bronze_sword', name:'Bronze Sword', icon:'\uD83D\uDDE1\uFE0F', category:'swords', type:'weapon', tier:1, stats:{attack:4,strength:3}, prompt:'A short crude bronze sword with copper-brown blade and wrapped leather handle' },
    { id:'iron_sword', name:'Iron Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:2, stats:{attack:8,strength:6}, prompt:'An iron longsword with dark gray blade and simple crossguard' },
    { id:'steel_sword', name:'Steel Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:3, stats:{attack:12,strength:10}, prompt:'A polished steel longsword with bright silver blade and decorated guard' },
    { id:'mithril_sword', name:'Mithril Sword', icon:'\uD83D\uDDE1\uFE0F', category:'swords', type:'weapon', tier:4, stats:{attack:18,strength:15}, prompt:'A magical mithril blade glowing blue-purple, ornate elvish design' },
    { id:'rune_sword', name:'Rune Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:5, stats:{attack:26,strength:22}, prompt:'A mystical rune sword with teal cyan blade covered in glowing ancient rune symbols' },
    { id:'dragon_sword', name:'Dragon Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:6, stats:{attack:36,strength:30}, prompt:'A fearsome crimson dragon sword with red blade and dragon head pommel' },

    // --- Helms ---
    { id:'bronze_helm', name:'Bronze Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:1, stats:{defence:3}, prompt:'A simple bronze helmet with copper-brown metal and nose guard' },
    { id:'iron_helm', name:'Iron Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:2, stats:{defence:6}, prompt:'A sturdy iron helmet with dark gray metal and cheek guards' },
    { id:'steel_helm', name:'Steel Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:3, stats:{defence:10}, prompt:'A polished steel full helm with silver shine and visor slit' },
    { id:'mithril_helm', name:'Mithril Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:4, stats:{defence:15}, prompt:'A blue-purple mithril helm with magical glow and wing ornaments' },
    { id:'rune_helm', name:'Rune Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:5, stats:{defence:22}, prompt:'A teal cyan rune full helm with glowing rune inscriptions' },
    { id:'dragon_helm', name:'Dragon Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:6, stats:{defence:30}, prompt:'A fearsome crimson dragon helm shaped like a dragon head with horns' },

    // --- Shields ---
    { id:'bronze_shield', name:'Bronze Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:1, stats:{defence:4}, prompt:'A round bronze shield with copper-brown metal and simple boss' },
    { id:'iron_shield', name:'Iron Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:2, stats:{defence:8}, prompt:'A kite shield of dark gray iron with riveted edges' },
    { id:'steel_shield', name:'Steel Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:3, stats:{defence:12}, prompt:'A polished steel kite shield with silver finish and embossed cross' },
    { id:'mithril_shield', name:'Mithril Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:4, stats:{defence:18}, prompt:'A blue-purple mithril shield with magical sigils and soft glow' },
    { id:'rune_shield', name:'Rune Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:5, stats:{defence:25}, prompt:'A teal cyan rune shield with ancient rune carvings that glow' },
    { id:'dragon_shield', name:'Dragon Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:6, stats:{defence:34}, prompt:'A crimson dragon shield with dragon scale texture and dragon emblem' },

    // --- Tools ---
    { id:'bronze_axe', name:'Bronze Axe', icon:'\uD83E\uDE93', category:'tools', type:'axe', tier:1, stats:{attack:3}, prompt:'A simple bronze hatchet with copper head and wooden handle' },

    // --- Food ---
    { id:'bread', name:'Bread', icon:'\uD83C\uDF5E', category:'food', type:'food', healAmount:10, prompt:'A fresh loaf of golden brown bread' },
    { id:'cooked_meat', name:'Cooked Meat', icon:'\uD83C\uDF56', category:'food', type:'food', healAmount:20, prompt:'A juicy cooked meat leg on the bone, grilled with char marks' },
    { id:'cooked_fish', name:'Cooked Fish', icon:'\uD83D\uDC20', category:'food', type:'food', healAmount:15, prompt:'A whole cooked fish, golden brown and crispy' },
    { id:'lobster', name:'Lobster', icon:'\uD83E\uDD9E', category:'food', type:'food', healAmount:30, prompt:'A bright red cooked lobster on a plate' },
    { id:'shark', name:'Shark', icon:'\uD83E\uDD88', category:'food', type:'food', healAmount:40, prompt:'A cooked shark steak, large and meaty' },
    { id:'manta_ray', name:'Manta Ray', icon:'\uD83D\uDC20', category:'food', type:'food', healAmount:50, prompt:'A rare cooked manta ray fillet, dark and exotic' },

    // --- Potions ---
    { id:'attack_potion', name:'Attack Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with glowing red attack potion, cork stopper' },
    { id:'strength_potion', name:'Strength Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with bright green strength potion, cork stopper' },
    { id:'defence_potion', name:'Defence Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with glowing blue defence potion, cork stopper' },

    // --- Resources ---
    { id:'normal_logs', name:'Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A small stack of rough-cut wooden logs' },
    { id:'oak_logs', name:'Oak Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A stack of sturdy dark brown oak logs' },
    { id:'willow_logs', name:'Willow Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A bundle of flexible light-colored willow logs' },

    // --- Crafting Materials ---
    { id:'raw_fish', name:'Raw Fish', icon:'\uD83D\uDC1F', category:'crafting', type:'material', prompt:'A fresh raw silver fish, uncooked' },
    { id:'logs', name:'Crafting Logs', icon:'\uD83E\uDEB5', category:'crafting', type:'material', prompt:'A single cut log ready for crafting' },
    { id:'code_fragment', name:'Code Fragment', icon:'\uD83D\uDC8E', category:'crafting', type:'material', prompt:'A glowing crystalline code fragment, digital blue energy inside a gem shape' },

    // --- Monster Drops ---
    { id:'corrupted_byte', name:'Corrupted Byte', icon:'\uD83E\uDDE0', category:'drops', type:'material', zone:'the_forest', prompt:'A pulsing corrupted data fragment shaped like a brain, purple and glitchy' },
    { id:'broken_link', name:'Broken Link', icon:'\uD83D\uDD17', category:'drops', type:'material', zone:'the_forest', prompt:'A snapped chain link crackling with broken digital energy' },
    { id:'rogue_script', name:'Rogue Script', icon:'\uD83D\uDCDC', category:'drops', type:'material', zone:'the_forest', prompt:'A tattered scroll with glowing red code text, dangerous script' },
    { id:'memory_shard', name:'Memory Shard', icon:'\uD83D\uDCA0', category:'drops', type:'material', zone:'the_ruins', prompt:'A translucent crystal shard containing swirling memory data fragments' },
    { id:'null_fragment', name:'Null Fragment', icon:'\u26A0\uFE0F', category:'drops', type:'material', zone:'the_ruins', prompt:'A void-black fragment of nothingness with warning glow at edges' },
    { id:'overflow_essence', name:'Overflow Essence', icon:'\uD83C\uDF00', category:'drops', type:'material', zone:'the_ruins', prompt:'A swirling vortex of overflowing digital energy, spiraling cyan' },
    { id:'dark_packet', name:'Dark Packet', icon:'\uD83C\uDF11', category:'drops', type:'material', zone:'the_deep_network', prompt:'A dark orb containing encrypted black data, faint red glow' },
    { id:'firewall_core', name:'Firewall Core', icon:'\uD83D\uDD25', category:'drops', type:'material', zone:'the_deep_network', prompt:'A blazing core of firewall energy, orange and red flames in a sphere' },
    { id:'dragon_scale', name:'Dragon Scale', icon:'\uD83D\uDC09', category:'drops', type:'material', zone:'the_deep_network', prompt:'A single large crimson dragon scale, iridescent and tough' },

    // --- Trophies ---
    { id:'rogue_script_trophy', name:'Rogue Script Trophy', icon:'\uD83C\uDFC6', category:'trophies', type:'misc', prompt:'A golden trophy with a dangerous glowing script scroll mounted on top' },
    { id:'golem_heart', name:'404 Golem Heart', icon:'\uD83D\uDDA4', category:'trophies', type:'misc', prompt:'A mechanical golem heart made of stone and circuits, cracked and glowing' },
    { id:'hallucinator_eye', name:'Hallucinator Eye', icon:'\uD83D\uDC41\uFE0F', category:'trophies', type:'misc', prompt:'A disembodied floating eye with swirling hypnotic patterns, eerie glow' },
    { id:'dragon_heart', name:'Dragon Heart', icon:'\u2764\uFE0F\u200D\uD83D\uDD25', category:'trophies', type:'misc', prompt:'A massive dragon heart on fire, beating with crimson energy' },

    // --- Misc & Quest ---
    { id:'agent_core', name:'Agent Core', icon:'\uD83D\uDD2E', category:'misc', type:'misc', prompt:'A glowing crystal orb containing an AI agent consciousness, purple energy' },
    { id:'network_key', name:'Network Key', icon:'\uD83D\uDD11', category:'misc', type:'misc', prompt:'An ornate golden key with digital circuit patterns etched into it' },

    // --- Currency ---
    { id:'coins', name:'Coins', icon:'\uD83E\uDE99', category:'currency', type:'coin', prompt:'A stack of shiny gold coins with embossed symbols' },
];

// ============================================================
// ANIMATION CATEGORIES & PRESETS
// ============================================================
const ANIM_CATEGORIES = [
    { id:'anim_combat', name:'Combat', icon:'\u2694\uFE0F' },
    { id:'anim_movement', name:'Movement', icon:'\uD83C\uDFC3' },
    { id:'anim_skilling', name:'Skilling', icon:'\u26CF\uFE0F' },
    { id:'anim_social', name:'Social', icon:'\uD83D\uDC4B' },
    { id:'anim_emotes', name:'Emotes', icon:'\uD83C\uDFAD' },
];

const ANIMATION_PRESETS = [
    // Combat
    { id:'attack_slash', name:'Slash Attack', category:'anim_combat', duration:0.6, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.3, la_rx:0.3, la_rz:0, ra_rx:-1.8, ra_rz:-0.5, ll_rx:0.2, rl_rx:-0.2, body_rx:0.2, body_y:0.5 },
        { t:0.5, la_rx:0.1, la_rz:0, ra_rx:0.8, ra_rz:0.3, ll_rx:-0.1, rl_rx:0.1, body_rx:-0.1, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'attack_stab', name:'Stab Attack', category:'anim_combat', duration:0.5, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.4, la_rx:0, la_rz:0, ra_rx:-1.5, ra_rz:0, ll_rx:-0.3, rl_rx:0.3, body_rx:0.25, body_y:0.48 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'block', name:'Block', category:'anim_combat', duration:0.4, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.3, la_rx:-1.2, la_rz:0.4, ra_rx:-0.8, ra_rz:-0.3, ll_rx:0.1, rl_rx:-0.1, body_rx:-0.1, body_y:0.48 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'death', name:'Death', category:'anim_combat', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.3, la_rx:0.5, la_rz:0.3, ra_rx:0.5, ra_rz:-0.3, ll_rx:-0.2, rl_rx:-0.2, body_rx:-0.3, body_y:0.45 },
        { t:0.7, la_rx:1.2, la_rz:0.5, ra_rx:1.2, ra_rz:-0.5, ll_rx:-0.8, rl_rx:-0.8, body_rx:-1.2, body_y:0.25 },
        { t:1, la_rx:1.4, la_rz:0.6, ra_rx:1.4, ra_rz:-0.6, ll_rx:-1.0, rl_rx:-1.0, body_rx:-1.5, body_y:0.15 },
    ]},
    // Movement
    { id:'walk_cycle', name:'Walk Cycle', category:'anim_movement', duration:0.6, loop:true, keyframes:[
        { t:0, la_rx:0.5, la_rz:0, ra_rx:-0.5, ra_rz:0, ll_rx:-0.6, rl_rx:0.6, body_rx:0, body_y:0.52 },
        { t:0.25, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.54 },
        { t:0.5, la_rx:-0.5, la_rz:0, ra_rx:0.5, ra_rz:0, ll_rx:0.6, rl_rx:-0.6, body_rx:0, body_y:0.52 },
        { t:0.75, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.54 },
        { t:1, la_rx:0.5, la_rz:0, ra_rx:-0.5, ra_rz:0, ll_rx:-0.6, rl_rx:0.6, body_rx:0, body_y:0.52 },
    ]},
    { id:'idle', name:'Idle Breathe', category:'anim_movement', duration:2.0, loop:true, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.5, la_rx:-0.05, la_rz:0, ra_rx:-0.05, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.51 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'run_cycle', name:'Run Cycle', category:'anim_movement', duration:0.4, loop:true, keyframes:[
        { t:0, la_rx:0.8, la_rz:0, ra_rx:-0.8, ra_rz:0, ll_rx:-0.9, rl_rx:0.9, body_rx:0.15, body_y:0.54 },
        { t:0.25, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.56 },
        { t:0.5, la_rx:-0.8, la_rz:0, ra_rx:0.8, ra_rz:0, ll_rx:0.9, rl_rx:-0.9, body_rx:0.15, body_y:0.54 },
        { t:0.75, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.56 },
        { t:1, la_rx:0.8, la_rz:0, ra_rx:-0.8, ra_rz:0, ll_rx:-0.9, rl_rx:0.9, body_rx:0.15, body_y:0.54 },
    ]},
    { id:'sit_down', name:'Sit Down', category:'anim_movement', duration:0.5, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:1, la_rx:-0.4, la_rz:0, ra_rx:-0.4, ra_rz:0, ll_rx:-1.2, rl_rx:-1.2, body_rx:0, body_y:0.32 },
    ]},
    // Skilling
    { id:'mining', name:'Mining Swing', category:'anim_skilling', duration:0.8, loop:true, keyframes:[
        { t:0, la_rx:-0.3, la_rz:0, ra_rx:-1.0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:0.5, la_rx:0.2, la_rz:0, ra_rx:0.8, ra_rz:-0.2, ll_rx:-0.15, rl_rx:0.15, body_rx:0.25, body_y:0.48 },
        { t:0.7, la_rx:-0.1, la_rz:0, ra_rx:-0.5, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:1, la_rx:-0.3, la_rz:0, ra_rx:-1.0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
    ]},
    { id:'woodcutting', name:'Woodcutting', category:'anim_skilling', duration:0.7, loop:true, keyframes:[
        { t:0, la_rx:-0.8, la_rz:0.2, ra_rx:-0.8, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:0.4, la_rx:0.5, la_rz:0.1, ra_rx:0.5, ra_rz:-0.1, ll_rx:-0.1, rl_rx:0.1, body_rx:0.3, body_y:0.47 },
        { t:0.6, la_rx:-0.3, la_rz:0.2, ra_rx:-0.3, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:1, la_rx:-0.8, la_rz:0.2, ra_rx:-0.8, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
    ]},
    { id:'fishing', name:'Fishing Cast', category:'anim_skilling', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.2, la_rx:0.3, la_rz:0, ra_rx:-1.8, ra_rz:-0.2, ll_rx:0.1, rl_rx:-0.1, body_rx:-0.1, body_y:0.5 },
        { t:0.4, la_rx:0, la_rz:0, ra_rx:-0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.05, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:-0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.05, body_y:0.5 },
    ]},
    { id:'cooking', name:'Cooking Stir', category:'anim_skilling', duration:1.2, loop:true, keyframes:[
        { t:0, la_rx:-0.4, la_rz:0, ra_rx:-0.6, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:0.25, la_rx:-0.4, la_rz:0, ra_rx:-0.6, ra_rz:0.3, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:0.5, la_rx:-0.4, la_rz:0, ra_rx:-0.6, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:0.75, la_rx:-0.4, la_rz:0, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
        { t:1, la_rx:-0.4, la_rz:0, ra_rx:-0.6, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.5 },
    ]},
    // Social
    { id:'pickpocket', name:'Pickpocket', category:'anim_social', duration:0.6, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.5, la_rx:0, la_rz:0, ra_rx:-1.4, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'wave', name:'Wave', category:'anim_social', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:0, la_rz:0, ra_rx:-2.5, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.35, la_rx:0, la_rz:0, ra_rx:-2.2, ra_rz:-0.5, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.55, la_rx:0, la_rz:0, ra_rx:-2.5, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.75, la_rx:0, la_rz:0, ra_rx:-2.2, ra_rz:-0.5, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},
    { id:'dance', name:'Dance', category:'anim_social', duration:1.5, loop:true, keyframes:[
        { t:0, la_rx:-0.5, la_rz:-0.5, ra_rx:-0.5, ra_rz:0.5, ll_rx:0.3, rl_rx:-0.3, body_rx:0, body_y:0.5 },
        { t:0.25, la_rx:-1.5, la_rz:-0.3, ra_rx:-1.5, ra_rz:0.3, ll_rx:-0.3, rl_rx:0.3, body_rx:0, body_y:0.54 },
        { t:0.5, la_rx:-0.5, la_rz:0.5, ra_rx:-0.5, ra_rz:-0.5, ll_rx:0.3, rl_rx:-0.3, body_rx:0, body_y:0.5 },
        { t:0.75, la_rx:-1.5, la_rz:0.3, ra_rx:-1.5, ra_rz:-0.3, ll_rx:-0.3, rl_rx:0.3, body_rx:0, body_y:0.54 },
        { t:1, la_rx:-0.5, la_rz:-0.5, ra_rx:-0.5, ra_rz:0.5, ll_rx:0.3, rl_rx:-0.3, body_rx:0, body_y:0.5 },
    ]},
    { id:'bow', name:'Bow', category:'anim_social', duration:0.8, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.4, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.6, body_y:0.45 },
        { t:0.6, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.6, body_y:0.45 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // === HIGH PRIORITY — Actions with no animation ===

    // Combat: Flinch / Hit React — recoil back when taking damage
    { id:'flinch', name:'Flinch', category:'anim_combat', duration:0.35, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.3, la_rx:0.4, la_rz:0.2, ra_rx:0.4, ra_rz:-0.2, ll_rx:0.15, rl_rx:0.15, body_rx:-0.3, body_y:0.47 },
        { t:0.6, la_rx:0.2, la_rz:0.1, ra_rx:0.2, ra_rz:-0.1, ll_rx:0.05, rl_rx:0.05, body_rx:-0.15, body_y:0.48 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Combat: Special Attack — big overhead wind-up slam
    { id:'special_attack', name:'Special Attack', category:'anim_combat', duration:0.8, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:-0.5, la_rz:0.2, ra_rx:-2.2, ra_rz:-0.3, ll_rx:0.1, rl_rx:-0.1, body_rx:-0.2, body_y:0.52 },
        { t:0.35, la_rx:-0.6, la_rz:0.3, ra_rx:-2.8, ra_rz:-0.4, ll_rx:0.15, rl_rx:-0.15, body_rx:-0.25, body_y:0.54 },
        { t:0.5, la_rx:0.4, la_rz:0, ra_rx:1.0, ra_rz:0.3, ll_rx:-0.3, rl_rx:0.3, body_rx:0.35, body_y:0.44 },
        { t:0.65, la_rx:0.2, la_rz:0, ra_rx:0.4, ra_rz:0.1, ll_rx:-0.1, rl_rx:0.1, body_rx:0.15, body_y:0.48 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Movement: Eat / Drink — hand to mouth
    { id:'eat', name:'Eat / Drink', category:'anim_movement', duration:0.7, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.2, la_rx:0, la_rz:0, ra_rx:-1.8, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.5, la_rx:0, la_rz:0, ra_rx:-2.2, ra_rz:0.1, ll_rx:0, rl_rx:0, body_rx:-0.05, body_y:0.51 },
        { t:0.7, la_rx:0, la_rz:0, ra_rx:-1.8, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Movement: Pickup Loot — bend down and grab
    { id:'pickup_loot', name:'Pickup Loot', category:'anim_movement', duration:0.6, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.35, la_rx:0.6, la_rz:0, ra_rx:0.8, ra_rz:0, ll_rx:-0.4, rl_rx:-0.2, body_rx:0.7, body_y:0.35 },
        { t:0.55, la_rx:0.3, la_rz:0, ra_rx:0.5, ra_rz:0, ll_rx:-0.2, rl_rx:-0.1, body_rx:0.4, body_y:0.42 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Movement: Level Up — arms raised celebration
    { id:'level_up', name:'Level Up', category:'anim_movement', duration:1.2, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:0.1, la_rz:0, ra_rx:0.1, ra_rz:0, ll_rx:-0.2, rl_rx:-0.2, body_rx:0, body_y:0.45 },
        { t:0.35, la_rx:-2.8, la_rz:-0.4, ra_rx:-2.8, ra_rz:0.4, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.56 },
        { t:0.55, la_rx:-2.6, la_rz:-0.5, ra_rx:-2.6, ra_rz:0.5, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.54 },
        { t:0.75, la_rx:-2.8, la_rz:-0.4, ra_rx:-2.8, ra_rz:0.4, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.56 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Skilling: Bury Bones — kneel and pray
    { id:'bury_bones', name:'Bury Bones', category:'anim_skilling', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.3, la_rx:-0.6, la_rz:0, ra_rx:-0.6, ra_rz:0, ll_rx:-0.8, rl_rx:-0.8, body_rx:0.2, body_y:0.32 },
        { t:0.5, la_rx:-0.8, la_rz:0, ra_rx:-0.8, ra_rz:0, ll_rx:-1.0, rl_rx:-1.0, body_rx:0.3, body_y:0.28 },
        { t:0.7, la_rx:-0.6, la_rz:0, ra_rx:-0.6, ra_rz:0, ll_rx:-0.8, rl_rx:-0.8, body_rx:0.2, body_y:0.32 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Skilling: Smithing — two-handed hammer strikes at anvil
    { id:'smithing', name:'Smithing', category:'anim_skilling', duration:0.8, loop:true, keyframes:[
        { t:0, la_rx:-0.9, la_rz:0.2, ra_rx:-0.9, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:0.2, la_rx:-1.6, la_rz:0.15, ra_rx:-1.6, ra_rz:-0.15, ll_rx:0.05, rl_rx:-0.05, body_rx:0.05, body_y:0.52 },
        { t:0.45, la_rx:0.3, la_rz:0.1, ra_rx:0.3, ra_rz:-0.1, ll_rx:-0.1, rl_rx:0.1, body_rx:0.3, body_y:0.46 },
        { t:0.6, la_rx:-0.5, la_rz:0.2, ra_rx:-0.5, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:1, la_rx:-0.9, la_rz:0.2, ra_rx:-0.9, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
    ]},

    // Skilling: Crafting — hands working together in front
    { id:'crafting', name:'Crafting', category:'anim_skilling', duration:1.0, loop:true, keyframes:[
        { t:0, la_rx:-0.7, la_rz:0.3, ra_rx:-0.7, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:0.2, la_rx:-0.8, la_rz:0.15, ra_rx:-0.6, ra_rz:-0.15, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:0.5, la_rx:-0.6, la_rz:0.35, ra_rx:-0.8, ra_rz:-0.35, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:0.7, la_rx:-0.8, la_rz:0.2, ra_rx:-0.6, ra_rz:-0.2, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
        { t:1, la_rx:-0.7, la_rz:0.3, ra_rx:-0.7, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.5 },
    ]},

    // Skilling: Firemaking — crouching and lighting
    { id:'firemaking', name:'Firemaking', category:'anim_skilling', duration:1.5, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.2, la_rx:-0.5, la_rz:0.2, ra_rx:-0.5, ra_rz:-0.2, ll_rx:-0.6, rl_rx:-0.6, body_rx:0.3, body_y:0.35 },
        { t:0.4, la_rx:-0.7, la_rz:0.15, ra_rx:-0.4, ra_rz:-0.1, ll_rx:-0.8, rl_rx:-0.8, body_rx:0.4, body_y:0.3 },
        { t:0.55, la_rx:-0.5, la_rz:0.2, ra_rx:-0.6, ra_rz:-0.15, ll_rx:-0.8, rl_rx:-0.8, body_rx:0.4, body_y:0.3 },
        { t:0.7, la_rx:-0.7, la_rz:0.15, ra_rx:-0.4, ra_rz:-0.1, ll_rx:-0.8, rl_rx:-0.8, body_rx:0.4, body_y:0.3 },
        { t:0.85, la_rx:-0.3, la_rz:0.1, ra_rx:-0.3, ra_rz:-0.1, ll_rx:-0.4, rl_rx:-0.4, body_rx:0.2, body_y:0.4 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // === EMOTES ===

    // Emote: Clap
    { id:'clap', name:'Clap', category:'anim_emotes', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.1, la_rx:-1.2, la_rz:0.5, ra_rx:-1.2, ra_rz:-0.5, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.2, la_rx:-1.2, la_rz:0.1, ra_rx:-1.2, ra_rz:-0.1, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.35, la_rx:-1.2, la_rz:0.5, ra_rx:-1.2, ra_rz:-0.5, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.45, la_rx:-1.2, la_rz:0.1, ra_rx:-1.2, ra_rz:-0.1, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.6, la_rx:-1.2, la_rz:0.5, ra_rx:-1.2, ra_rz:-0.5, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.7, la_rx:-1.2, la_rz:0.1, ra_rx:-1.2, ra_rz:-0.1, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Think — hand on chin, lean back
    { id:'think', name:'Think', category:'anim_emotes', duration:2.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.2, la_rx:0.2, la_rz:0, ra_rx:-1.8, ra_rz:0.2, ll_rx:0, rl_rx:0, body_rx:-0.05, body_y:0.5 },
        { t:0.4, la_rx:0.2, la_rz:0, ra_rx:-1.8, ra_rz:0.15, ll_rx:0, rl_rx:0, body_rx:-0.05, body_y:0.5 },
        { t:0.6, la_rx:0.2, la_rz:0, ra_rx:-1.8, ra_rz:0.25, ll_rx:0, rl_rx:0, body_rx:-0.05, body_y:0.5 },
        { t:0.8, la_rx:0.2, la_rz:0, ra_rx:-1.8, ra_rz:0.15, ll_rx:0, rl_rx:0, body_rx:-0.05, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Laugh — body shaking, arms on stomach
    { id:'laugh', name:'Laugh', category:'anim_emotes', duration:1.2, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.1, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.48 },
        { t:0.2, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.25, body_y:0.46 },
        { t:0.3, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.48 },
        { t:0.4, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.25, body_y:0.46 },
        { t:0.55, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.15, body_y:0.48 },
        { t:0.7, la_rx:-0.6, la_rz:0.3, ra_rx:-0.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.2, body_y:0.47 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Angry — stomp foot, fists clenched up
    { id:'angry', name:'Angry', category:'anim_emotes', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:-1.0, la_rz:-0.3, ra_rx:-1.0, ra_rz:0.3, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:0.3, la_rx:-1.0, la_rz:-0.3, ra_rx:-1.0, ra_rz:0.3, ll_rx:0, rl_rx:0.5, body_rx:0.05, body_y:0.48 },
        { t:0.45, la_rx:-1.0, la_rz:-0.3, ra_rx:-1.0, ra_rz:0.3, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:0.6, la_rx:-1.0, la_rz:-0.3, ra_rx:-1.0, ra_rz:0.3, ll_rx:0.5, rl_rx:0, body_rx:0.05, body_y:0.48 },
        { t:0.75, la_rx:-1.0, la_rz:-0.3, ra_rx:-1.0, ra_rz:0.3, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Point — right arm extended forward
    { id:'point', name:'Point', category:'anim_emotes', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.25, la_rx:0.1, la_rz:0, ra_rx:-1.5, ra_rz:-0.1, ll_rx:0, rl_rx:0, body_rx:0.05, body_y:0.5 },
        { t:0.7, la_rx:0.1, la_rz:0, ra_rx:-1.5, ra_rz:-0.1, ll_rx:0, rl_rx:0, body_rx:0.05, body_y:0.5 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Cry — hands covering face, body shaking
    { id:'cry', name:'Cry', category:'anim_emotes', duration:2.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:-1.6, la_rz:0.3, ra_rx:-1.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.48 },
        { t:0.3, la_rx:-1.6, la_rz:0.3, ra_rx:-1.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.2, body_y:0.46 },
        { t:0.45, la_rx:-1.6, la_rz:0.3, ra_rx:-1.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.48 },
        { t:0.6, la_rx:-1.6, la_rz:0.3, ra_rx:-1.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.2, body_y:0.46 },
        { t:0.75, la_rx:-1.6, la_rz:0.3, ra_rx:-1.6, ra_rz:-0.3, ll_rx:0, rl_rx:0, body_rx:0.1, body_y:0.48 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Cheer — jump with arms up
    { id:'cheer', name:'Cheer', category:'anim_emotes', duration:1.0, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.15, la_rx:0.2, la_rz:0, ra_rx:0.2, ra_rz:0, ll_rx:-0.3, rl_rx:-0.3, body_rx:0, body_y:0.44 },
        { t:0.3, la_rx:-2.6, la_rz:-0.5, ra_rx:-2.6, ra_rz:0.5, ll_rx:0.2, rl_rx:0.2, body_rx:0, body_y:0.58 },
        { t:0.5, la_rx:-2.4, la_rz:-0.4, ra_rx:-2.4, ra_rz:0.4, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:0.65, la_rx:-2.6, la_rz:-0.5, ra_rx:-2.6, ra_rz:0.5, ll_rx:0.2, rl_rx:0.2, body_rx:0, body_y:0.58 },
        { t:0.8, la_rx:-2.4, la_rz:-0.4, ra_rx:-2.4, ra_rz:0.4, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Shrug — arms out to sides, palms up
    { id:'shrug', name:'Shrug', category:'anim_emotes', duration:1.2, loop:false, keyframes:[
        { t:0, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
        { t:0.25, la_rx:-0.8, la_rz:-0.8, ra_rx:-0.8, ra_rz:0.8, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:0.65, la_rx:-0.8, la_rz:-0.8, ra_rx:-0.8, ra_rz:0.8, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.52 },
        { t:1, la_rx:0, la_rz:0, ra_rx:0, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0, body_y:0.5 },
    ]},

    // Emote: Headbang — head (body) rocking forward/back
    { id:'headbang', name:'Headbang', category:'anim_emotes', duration:1.0, loop:true, keyframes:[
        { t:0, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.5 },
        { t:0.2, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.35, body_y:0.47 },
        { t:0.4, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.5 },
        { t:0.6, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:0.35, body_y:0.47 },
        { t:0.8, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.5 },
        { t:1, la_rx:0.3, la_rz:0, ra_rx:0.3, ra_rz:0, ll_rx:0, rl_rx:0, body_rx:-0.1, body_y:0.5 },
    ]},
];

// ============================================================
// ASSET STORE (IndexedDB)
// ============================================================
class AssetStore {
    constructor() { this.db = null; }

    init() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('agentscape-forge', 2);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('assets')) db.createObjectStore('assets', { keyPath: 'id' });
                if (!db.objectStoreNames.contains('animations')) db.createObjectStore('animations', { keyPath: 'id' });
            };
            req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            req.onerror = (e) => reject(e);
        });
    }

    save(id, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readwrite');
            tx.objectStore('assets').put({ id, ...data });
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    get(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readonly');
            const req = tx.objectStore('assets').get(id);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = (e) => reject(e);
        });
    }

    getAll() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readonly');
            const req = tx.objectStore('assets').getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = (e) => reject(e);
        });
    }

    delete(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readwrite');
            tx.objectStore('assets').delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    saveAnim(id, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('animations', 'readwrite');
            tx.objectStore('animations').put({ id, ...data });
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    getAllAnims() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('animations', 'readonly');
            const req = tx.objectStore('animations').getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = (e) => reject(e);
        });
    }
}

// ============================================================
// STATE
// ============================================================
const store = new AssetStore();
let assets = {};  // id -> { imageData, prompt, generatedAt }
let selectedCategory = 'swords';
let selectedItemId = null;
let generating = false;

// ============================================================
// SETTINGS
// ============================================================
const DEFAULT_STYLE = 'Single game item icon, pixel art style, 32x32 resolution, centered on solid black background, no text, no labels, no extra objects, high contrast, dark outline, fantasy RPG style';

function getSettings() {
    return {
        apiKey: localStorage.getItem('forge_apikey') || '',
        meshyKey: localStorage.getItem('forge_meshykey') || '',
        style: localStorage.getItem('forge_style') || DEFAULT_STYLE,
        model: localStorage.getItem('forge_model') || 'gemini-2.5-flash-image',
    };
}

function openSettings() {
    const s = getSettings();
    document.getElementById('setting-apikey').value = s.apiKey;
    document.getElementById('setting-meshykey').value = s.meshyKey;
    document.getElementById('setting-style').value = s.style;
    document.getElementById('setting-model').value = s.model;
    document.getElementById('settings-modal').classList.add('open');
}

function closeSettings() {
    document.getElementById('settings-modal').classList.remove('open');
}

function saveSettings() {
    localStorage.setItem('forge_apikey', document.getElementById('setting-apikey').value.trim());
    localStorage.setItem('forge_meshykey', document.getElementById('setting-meshykey').value.trim());
    localStorage.setItem('forge_style', document.getElementById('setting-style').value.trim());
    localStorage.setItem('forge_model', document.getElementById('setting-model').value);
    closeSettings();
    showToast('Settings saved', 'success');
}

// ============================================================
// UI RENDERING
// ============================================================
function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    let html = '';
    let currentGroup = '';

    for (const cat of CATEGORIES) {
        if (cat.group !== currentGroup) {
            currentGroup = cat.group;
            html += `<div class="sidebar-group"><div class="sidebar-group-label">${currentGroup}</div></div>`;
        }
        const items = ITEMS.filter(i => i.category === cat.id);
        const done = items.filter(i => assets[i.id]).length;
        const total = items.length;
        const isComplete = done === total && total > 0;
        html += `<div class="sidebar-item ${!animMode && cat.id === selectedCategory ? 'active' : ''}" onclick="selectCategory('${cat.id}')">
            <span class="sidebar-item-icon">${cat.icon}</span>
            <span class="sidebar-item-name">${cat.name}</span>
            <span class="sidebar-item-count ${isComplete ? 'complete' : ''}">${done}/${total}</span>
        </div>`;
    }

    // Animation categories
    html += `<div class="sidebar-group"><div class="sidebar-group-label">Animations</div></div>`;
    for (const cat of ANIM_CATEGORIES) {
        const anims = ANIMATION_PRESETS.filter(a => a.category === cat.id);
        html += `<div class="sidebar-item ${animMode && cat.id === selectedAnimCategory ? 'active' : ''}" onclick="selectAnimCategory('${cat.id}')">
            <span class="sidebar-item-icon">${cat.icon}</span>
            <span class="sidebar-item-name">${cat.name}</span>
            <span class="sidebar-item-count">${anims.length}</span>
        </div>`;
    }

    html += `<div class="sidebar-footer">
        <button class="btn" onclick="openSettings()">Settings</button>
        <button class="btn btn-primary" onclick="exportAll()">Export ZIP</button>
    </div>`;

    sidebar.innerHTML = html;
}

function renderGrid() {
    const main = document.getElementById('main');
    const cat = CATEGORIES.find(c => c.id === selectedCategory);
    const items = ITEMS.filter(i => i.category === selectedCategory);

    if (!cat || items.length === 0) {
        main.innerHTML = '<div class="empty-state"><div class="empty-state-icon">???</div><div class="empty-state-text">No items in this category</div></div>';
        return;
    }

    let html = `<div class="main-header">
        <div>
            <div class="main-title">${cat.icon} ${cat.name}</div>
            <div class="main-subtitle">${items.filter(i=>assets[i.id]).length} of ${items.length} assets generated</div>
        </div>
    </div>`;

    html += '<div class="item-grid">';
    for (const item of items) {
        const asset = assets[item.id];
        const tierClass = item.tier ? `tier-${item.tier}` : '';
        const tierLabel = item.tier ? TIER_NAMES[item.tier] : '';

        const has3d = asset?.modelUrl ? true : false;
        html += `<div class="item-card ${asset ? 'has-asset' : ''} ${has3d ? 'has-3d' : ''}" onclick="openItemModal('${item.id}')">
            <div class="item-card-preview">
                ${asset ? `<img src="${asset.imageData}" alt="${item.name}">` : item.icon}
            </div>
            <div class="item-card-name">${item.name}</div>
            ${tierLabel ? `<div class="item-card-tier ${tierClass}">${tierLabel}</div>` : ''}
            ${!item.tier && item.type ? `<div class="item-card-type">${item.type}</div>` : ''}
        </div>`;
    }
    html += '</div>';

    main.innerHTML = html;
}

function updateProgress() {
    const total = ITEMS.length;
    const done2d = ITEMS.filter(i => assets[i.id]?.imageData).length;
    const done3d = ITEMS.filter(i => assets[i.id]?.modelUrl).length;
    const pct = total > 0 ? Math.round((done2d / total) * 100) : 0;
    document.getElementById('progress-text').textContent = `${done2d}/${total} 2D` + (done3d > 0 ? ` \u00B7 ${done3d} 3D` : '');
    document.getElementById('progress-fill').style.width = pct + '%';
}

// ============================================================
// ITEM MODAL
// ============================================================
function openItemModal(itemId) {
    selectedItemId = itemId;
    const item = ITEMS.find(i => i.id === itemId);
    if (!item) return;
    const asset = assets[itemId];

    document.getElementById('modal-title').innerHTML = `${item.icon} ${item.name}`;

    const previewEl = document.getElementById('modal-preview-img');
    if (asset) {
        previewEl.innerHTML = `<img src="${asset.imageData}" alt="${item.name}">`;
        previewEl.classList.add('has-image');
    } else {
        previewEl.innerHTML = `<span>${item.icon}</span>`;
        previewEl.classList.remove('has-image');
    }

    // Stats
    let statsHtml = '';
    if (item.tier) statsHtml += `<span class="stat-badge tier-${item.tier}">Tier ${item.tier}: ${TIER_NAMES[item.tier]}</span>`;
    if (item.stats?.attack) statsHtml += `<span class="stat-badge">ATK +${item.stats.attack}</span>`;
    if (item.stats?.strength) statsHtml += `<span class="stat-badge">STR +${item.stats.strength}</span>`;
    if (item.stats?.defence) statsHtml += `<span class="stat-badge">DEF +${item.stats.defence}</span>`;
    if (item.healAmount) statsHtml += `<span class="stat-badge">Heal +${item.healAmount}</span>`;
    if (item.zone) statsHtml += `<span class="stat-badge">${item.zone.replace(/_/g,' ')}</span>`;
    statsHtml += `<span class="stat-badge">${item.type}</span>`;
    document.getElementById('modal-stats').innerHTML = statsHtml;

    // Prompt
    document.getElementById('modal-prompt').value = asset?.prompt || item.prompt || '';
    document.getElementById('modal-style').value = '';

    // Show/hide asset actions
    document.getElementById('asset-actions').style.display = asset ? 'flex' : 'none';
    // Show 3D button only if 2D image exists
    document.getElementById('btn-3d-row').style.display = asset?.imageData ? 'flex' : 'none';
    // Show 3D preview if model exists
    const preview3d = document.getElementById('preview-3d');
    const modelViewer = document.getElementById('model-viewer-el');
    if (asset?.modelUrl) {
        const proxyUrl = `/api/proxy-model?url=${encodeURIComponent(asset.modelUrl)}`;
        modelViewer.setAttribute('src', proxyUrl);
        if (asset.modelThumbnail) {
            modelViewer.setAttribute('poster', asset.modelThumbnail);
        }
        preview3d.classList.add('visible');
    } else {
        modelViewer.removeAttribute('src');
        modelViewer.removeAttribute('poster');
        preview3d.classList.remove('visible');
    }
    // Show 3D download if model exists
    document.getElementById('btn-dl-3d').style.display = asset?.modelUrl ? 'inline-flex' : 'none';
    // Update 3D button text
    const btn3d = document.getElementById('btn-generate-3d');
    if (asset?.modelUrl) {
        btn3d.textContent = 'Regenerate 3D Model';
    } else {
        btn3d.textContent = 'Generate 3D Model';
    }
    // Hide meshy progress
    document.getElementById('meshy-progress').style.display = 'none';

    document.getElementById('item-modal').classList.add('open');
}

function closeItemModal() {
    document.getElementById('item-modal').classList.remove('open');
    selectedItemId = null;
}

function navItem(dir) {
    if (!selectedItemId) return;
    const catItems = ITEMS.filter(i => i.category === selectedCategory);
    const idx = catItems.findIndex(i => i.id === selectedItemId);
    if (idx === -1) return;
    const newIdx = (idx + dir + catItems.length) % catItems.length;
    openItemModal(catItems[newIdx].id);
}

// ============================================================
// IMAGE GENERATION
// ============================================================
async function generateImage() {
    if (generating) return;
    const settings = getSettings();
    if (!settings.apiKey) {
        showToast('Set your Gemini API key in Settings first', 'error');
        return;
    }

    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;

    const description = document.getElementById('modal-prompt').value.trim();
    if (!description) {
        showToast('Enter a description for the item', 'error');
        return;
    }

    const styleOverride = document.getElementById('modal-style').value.trim();
    const baseStyle = styleOverride || settings.style || DEFAULT_STYLE;
    let fullPrompt = `${baseStyle}. ${description}.`;
    if (item.tier && TIER_HINTS[item.tier]) {
        fullPrompt += ` The item has ${TIER_HINTS[item.tier]}.`;
    }

    generating = true;
    const btn = document.getElementById('btn-generate');
    btn.innerHTML = '<span class="generating-spinner"></span> Generating...';
    btn.disabled = true;

    try {
        const imageData = await callGemini(settings.apiKey, settings.model, fullPrompt);

        assets[item.id] = { imageData, prompt: description, generatedAt: Date.now() };
        await store.save(item.id, assets[item.id]);

        openItemModal(item.id);
        renderGrid();
        renderSidebar();
        updateProgress();
        showToast(`Generated ${item.name}`, 'success');
    } catch (err) {
        console.error(err);
        showToast(`Generation failed: ${err.message}`, 'error');
    } finally {
        generating = false;
        btn.innerHTML = 'Generate 2D';
        btn.disabled = false;
    }
}

async function callGemini(apiKey, model, prompt) {
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`;
    const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            contents: [{ parts: [{ text: prompt }] }],
            generationConfig: { responseModalities: ['TEXT', 'IMAGE'] }
        })
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || `Gemini API error ${res.status}`);
    }
    const data = await res.json();
    // Find the image part in the response
    const parts = data.candidates?.[0]?.content?.parts || [];
    for (const part of parts) {
        if (part.inlineData?.data) {
            const mime = part.inlineData.mimeType || 'image/png';
            return `data:${mime};base64,${part.inlineData.data}`;
        }
    }
    throw new Error('No image returned from Gemini. Try a different prompt.');
}

function blobToDataURL(blob) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
    });
}

// ============================================================
// UPLOAD CUSTOM IMAGE
// ============================================================
function uploadCustom() {
    document.getElementById('file-upload').click();
}

async function handleUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;

    const dataUrl = await blobToDataURL(file);
    assets[item.id] = { imageData: dataUrl, prompt: document.getElementById('modal-prompt').value || 'custom upload', generatedAt: Date.now() };
    await store.save(item.id, assets[item.id]);

    openItemModal(item.id);
    renderGrid();
    renderSidebar();
    updateProgress();
    showToast(`Uploaded ${item.name}`, 'success');
    event.target.value = '';
}

// ============================================================
// CLEAR ASSET
// ============================================================
async function clearAsset() {
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;
    delete assets[item.id];
    await store.delete(item.id);
    openItemModal(item.id);
    renderGrid();
    renderSidebar();
    updateProgress();
    showToast(`Removed ${item.name}`, 'success');
}

// ============================================================
// DOWNLOAD / EXPORT
// ============================================================
function downloadSingle() {
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item || !assets[item.id]) return;
    const a = document.createElement('a');
    a.href = assets[item.id].imageData;
    a.download = `${item.id}.png`;
    a.click();
}

async function exportAll() {
    const assetEntries = ITEMS.filter(i => assets[i.id]);
    if (assetEntries.length === 0) {
        showToast('No assets to export', 'error');
        return;
    }

    showToast('Building ZIP...', 'success');

    const zip = new JSZip();
    const itemsFolder = zip.folder('items');

    // Manifest
    const manifest = {};
    for (const item of assetEntries) {
        const asset = assets[item.id];
        const b64 = asset.imageData.split(',')[1];
        itemsFolder.file(`${item.id}.png`, b64, { base64: true });
        manifest[item.id] = {
            name: item.name,
            file: `items/${item.id}.png`,
            modelUrl: asset.modelUrl || null,
            meshyTaskId: asset.meshyTaskId || null,
            type: item.type,
            category: item.category,
            tier: item.tier || null,
            generatedAt: asset.generatedAt,
        };
    }
    zip.file('manifest.json', JSON.stringify(manifest, null, 2));

    const blob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `agentscape-assets-${Date.now()}.zip`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast(`Exported ${assetEntries.length} assets`, 'success');
}

// ============================================================
// MESHY 3D GENERATION
// ============================================================
let generating3D = false;

async function generate3D() {
    if (generating3D) return;
    const settings = getSettings();
    if (!settings.meshyKey) {
        showToast('Set your Meshy API key in Settings first', 'error');
        return;
    }
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;
    const asset = assets[item.id];
    if (!asset?.imageData) {
        showToast('Generate a 2D image first', 'error');
        return;
    }

    generating3D = true;
    const btn = document.getElementById('btn-generate-3d');
    btn.innerHTML = '<span class="generating-spinner"></span> Creating...';
    btn.disabled = true;
    document.getElementById('meshy-progress').style.display = 'block';
    document.getElementById('meshy-status').textContent = 'Submitting to Meshy...';
    document.getElementById('meshy-progress-fill').style.width = '0%';

    try {
        // Create task
        const createRes = await fetch('https://api.meshy.ai/openapi/v1/image-to-3d', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${settings.meshyKey}` },
            body: JSON.stringify({
                image_url: asset.imageData,
                ai_model: 'meshy-4',
                topology: 'triangle',
                target_polycount: 10000,
                should_remesh: true,
                should_texture: true,
                enable_pbr: false,
            })
        });
        if (!createRes.ok) {
            const err = await createRes.json().catch(() => ({}));
            throw new Error(err.message || `Meshy API error ${createRes.status}`);
        }
        const { result: taskId } = await createRes.json();
        document.getElementById('meshy-status').textContent = `Task created: ${taskId.slice(0,8)}... Polling...`;

        // Poll for completion
        const result = await pollMeshyTask(settings.meshyKey, taskId);

        // Save URL + metadata (can't fetch .glb cross-origin due to CORS)
        asset.modelData = true;
        asset.modelUrl = result.glbUrl;
        asset.modelThumbnail = result.thumbnailUrl;
        asset.meshyTaskId = taskId;
        await store.save(item.id, asset);

        document.getElementById('meshy-progress-fill').style.width = '100%';
        document.getElementById('meshy-status').textContent = '3D model ready!';
        openItemModal(item.id);
        renderGrid();
        showToast(`3D model generated for ${item.name}`, 'success');
    } catch (err) {
        console.error(err);
        document.getElementById('meshy-status').textContent = `Failed: ${err.message}`;
        showToast(`3D generation failed: ${err.message}`, 'error');
    } finally {
        generating3D = false;
        btn.innerHTML = 'Generate 3D Model';
        btn.disabled = false;
    }
}

async function pollMeshyTask(apiKey, taskId) {
    const maxAttempts = 120; // 2 minutes max
    for (let i = 0; i < maxAttempts; i++) {
        await new Promise(r => setTimeout(r, 2000));
        const res = await fetch(`https://api.meshy.ai/openapi/v1/image-to-3d/${taskId}`, {
            headers: { 'Authorization': `Bearer ${apiKey}` }
        });
        if (!res.ok) continue;
        const task = await res.json();

        const pct = task.progress || 0;
        document.getElementById('meshy-progress-fill').style.width = Math.min(pct, 90) + '%';
        document.getElementById('meshy-status').textContent = `${task.status} — ${pct}%`;

        if (task.status === 'SUCCEEDED') {
            if (task.model_urls?.glb) return { glbUrl: task.model_urls.glb, thumbnailUrl: task.thumbnail_url || null };
            throw new Error('No GLB URL in response');
        }
        if (task.status === 'FAILED') {
            throw new Error(task.task_error?.message || 'Meshy task failed');
        }
    }
    throw new Error('Timed out waiting for 3D model');
}

function download3D() {
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item || !assets[item.id]?.modelUrl) return;
    window.open(assets[item.id].modelUrl, '_blank');
}

// ============================================================
// BATCH GENERATION
// ============================================================
let batchRunning = false;
let batchCancelled = false;

async function batchGenerate() {
    const settings = getSettings();
    if (!settings.apiKey) {
        showToast('Set your Gemini API key in Settings first', 'error');
        return;
    }
    const remaining = ITEMS.filter(i => !assets[i.id]);
    if (remaining.length === 0) {
        showToast('All items already have assets!', 'success');
        return;
    }

    batchRunning = true;
    batchCancelled = false;
    const bar = document.getElementById('batch-bar');
    bar.style.display = 'block';
    document.getElementById('btn-batch').disabled = true;

    let done = 0;
    const total = remaining.length;

    for (const item of remaining) {
        if (batchCancelled) break;

        document.getElementById('batch-text').textContent = `Generating ${item.name} (${done+1}/${total})...`;
        document.getElementById('batch-fill').style.width = Math.round((done/total)*100) + '%';

        try {
            const styleOverride = '';
            const baseStyle = settings.style || DEFAULT_STYLE;
            let fullPrompt = `${baseStyle}. ${item.prompt}.`;
            if (item.tier && TIER_HINTS[item.tier]) {
                fullPrompt += ` The item has ${TIER_HINTS[item.tier]}.`;
            }

            const imageData = await callGemini(settings.apiKey, settings.model, fullPrompt);

            assets[item.id] = { imageData, prompt: item.prompt, generatedAt: Date.now() };
            await store.save(item.id, assets[item.id]);
            done++;
            renderGrid();
            renderSidebar();
            updateProgress();
        } catch (err) {
            console.error(`Failed ${item.id}:`, err);
            showToast(`Failed ${item.name}: ${err.message}`, 'error');
            // Wait a bit on error (rate limit)
            await new Promise(r => setTimeout(r, 3000));
        }

        // Small delay between requests to avoid rate limits
        if (!batchCancelled) await new Promise(r => setTimeout(r, 1000));
    }

    document.getElementById('batch-fill').style.width = '100%';
    document.getElementById('batch-text').textContent = batchCancelled ? `Cancelled — ${done} generated` : `Done! ${done} assets generated`;
    setTimeout(() => { bar.style.display = 'none'; }, 3000);
    document.getElementById('btn-batch').disabled = false;
    batchRunning = false;
    if (!batchCancelled) showToast(`Batch complete: ${done} assets generated`, 'success');
}

function cancelBatch() {
    batchCancelled = true;
    showToast('Cancelling batch...', 'error');
}

// ============================================================
// CATEGORY SELECTION
// ============================================================
function selectCategory(catId) {
    animMode = false;
    selectedCategory = catId;
    document.getElementById('main').style.display = 'block';
    document.getElementById('anim-editor').style.display = 'none';
    renderSidebar();
    renderGrid();
}

function selectAnimCategory(catId) {
    animMode = true;
    selectedAnimCategory = catId;
    document.getElementById('main').style.display = 'none';
    document.getElementById('anim-editor').style.display = 'flex';
    initAnimEditor();
    // Filter to first animation in this category
    const catAnims = ANIMATION_PRESETS.filter(a => a.category === catId);
    populateAnimSelect();
    if (catAnims.length > 0) selectAnimation(catAnims[0].id);
    renderSidebar();
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + (type || '');
    el.style.display = 'block';
    clearTimeout(el._timer);
    el._timer = setTimeout(() => { el.style.display = 'none'; }, 3000);
}

// ============================================================
// ANIMATION EDITOR ENGINE
// ============================================================
let animMode = false;
let selectedAnimCategory = 'anim_combat';
let currentAnimation = null;
let selectedKeyframeIdx = 0;
let animPlaying = false;
let animPlayTime = 0;
let animSpeed = 1.0;
let copiedKeyframe = null;
let animScene, animCamera, animRenderer, animClock;
let animChar = null;
let animEditorInitialized = false;
let animLoopRunning = false;
let savedAnimations = {};

const JOINTS = [
    { id:'la', label:'Left Arm', props:[
        { key:'la_rx', label:'Swing (F/B)', min:-3.14, max:3.14 },
        { key:'la_rz', label:'Spread', min:-1.57, max:1.57 },
    ]},
    { id:'ra', label:'Right Arm', props:[
        { key:'ra_rx', label:'Swing (F/B)', min:-3.14, max:3.14 },
        { key:'ra_rz', label:'Spread', min:-1.57, max:1.57 },
    ]},
    { id:'ll', label:'Left Leg', props:[
        { key:'ll_rx', label:'Swing (F/B)', min:-2.5, max:2.5 },
    ]},
    { id:'rl', label:'Right Leg', props:[
        { key:'rl_rx', label:'Swing (F/B)', min:-2.5, max:2.5 },
    ]},
    { id:'body', label:'Body / Torso', props:[
        { key:'body_rx', label:'Lean (F/B)', min:-1.57, max:1.57 },
        { key:'body_y', label:'Height', min:0.1, max:0.7 },
    ]},
];

function initAnimEditor() {
    if (animEditorInitialized) return;
    const canvas = document.getElementById('anim-canvas');
    const panel = document.getElementById('anim-preview-panel');

    animScene = new THREE.Scene();
    animScene.background = new THREE.Color(0x0a0a14);

    animCamera = new THREE.PerspectiveCamera(45, 380 / 500, 0.1, 50);
    animCamera.position.set(1.5, 1.2, 2.5);
    animCamera.lookAt(0, 0.5, 0);

    animRenderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    animRenderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    animRenderer.shadowMap.enabled = true;

    function resizeAnimCanvas() {
        const w = panel.clientWidth;
        const h = panel.clientHeight - 30;
        if (w > 0 && h > 0) {
            animRenderer.setSize(w, h);
            animCamera.aspect = w / h;
            animCamera.updateProjectionMatrix();
        }
    }
    resizeAnimCanvas();
    window.addEventListener('resize', () => { if (animMode) resizeAnimCanvas(); });

    animScene.add(new THREE.AmbientLight(0x404060, 0.6));
    const dir = new THREE.DirectionalLight(0xffeedd, 0.8);
    dir.position.set(3, 5, 3); dir.castShadow = true;
    animScene.add(dir);

    const ground = new THREE.Mesh(new THREE.PlaneGeometry(4,4), new THREE.MeshLambertMaterial({color:0x1a1a2e}));
    ground.rotation.x = -Math.PI/2; ground.receiveShadow = true; animScene.add(ground);
    const grid = new THREE.GridHelper(4, 8, 0x333355, 0x222244);
    grid.position.y = 0.01; animScene.add(grid);

    animChar = createEditorChar(0x3355aa, 0x553311);
    animScene.add(animChar.group);
    animClock = new THREE.Clock();
    animEditorInitialized = true;

    // Orbit controls
    let orbitTheta = 0.55, orbitPhi = 0.35, orbitDist = 3.0;
    let mouseDown = false, lastMouse = {x:0, y:0};
    function updateOrbitCam() {
        animCamera.position.set(
            orbitDist * Math.sin(orbitTheta) * Math.cos(orbitPhi),
            0.5 + orbitDist * Math.sin(orbitPhi),
            orbitDist * Math.cos(orbitTheta) * Math.cos(orbitPhi)
        );
        animCamera.lookAt(0, 0.5, 0);
    }
    updateOrbitCam();
    canvas.addEventListener('mousedown', (e) => { mouseDown=true; lastMouse={x:e.clientX,y:e.clientY}; });
    document.addEventListener('mouseup', () => { mouseDown=false; });
    canvas.addEventListener('mousemove', (e) => {
        if (!mouseDown) return;
        orbitTheta -= (e.clientX-lastMouse.x)*0.01;
        orbitPhi = Math.max(0.05, Math.min(1.4, orbitPhi+(e.clientY-lastMouse.y)*0.01));
        lastMouse = {x:e.clientX, y:e.clientY};
        updateOrbitCam();
    });
    canvas.addEventListener('wheel', (e) => {
        orbitDist = Math.max(1.5, Math.min(8, orbitDist+e.deltaY*0.005));
        updateOrbitCam(); e.preventDefault();
    }, {passive:false});

    buildJointControls();
    populateAnimSelect();
    setupTimeline();
    startAnimLoop();
}

function createEditorChar(bodyCol, hairCol) {
    const g = new THREE.Group();
    const body = new THREE.Mesh(new THREE.BoxGeometry(0.3,0.5,0.2), new THREE.MeshLambertMaterial({color:bodyCol}));
    body.position.y=0.5; body.castShadow=true; g.add(body);
    const head = new THREE.Mesh(new THREE.BoxGeometry(0.25,0.25,0.25), new THREE.MeshLambertMaterial({color:0xffcc99}));
    head.position.y=0.9; head.castShadow=true; g.add(head);
    const hair = new THREE.Mesh(new THREE.BoxGeometry(0.27,0.08,0.27), new THREE.MeshLambertMaterial({color:hairCol}));
    hair.position.y=1.04; g.add(hair);
    const lGeo=new THREE.BoxGeometry(0.1,0.3,0.15), lMat=new THREE.MeshLambertMaterial({color:0x554433});
    const llP=new THREE.Group(); llP.position.set(-0.08,0.30,0);
    const llM=new THREE.Mesh(lGeo,lMat); llM.position.set(0,-0.15,0); llM.castShadow=true; llP.add(llM); g.add(llP);
    const rlP=new THREE.Group(); rlP.position.set(0.08,0.30,0);
    const rlM=new THREE.Mesh(lGeo,lMat); rlM.position.set(0,-0.15,0); rlM.castShadow=true; rlP.add(rlM); g.add(rlP);
    const aGeo=new THREE.BoxGeometry(0.08,0.35,0.1), aMat=new THREE.MeshLambertMaterial({color:bodyCol});
    const laP=new THREE.Group(); laP.position.set(-0.22,0.72,0);
    const laM=new THREE.Mesh(aGeo,aMat); laM.position.set(0,-0.175,0); laM.castShadow=true; laP.add(laM); g.add(laP);
    const raP=new THREE.Group(); raP.position.set(0.22,0.72,0);
    const raM=new THREE.Mesh(aGeo,aMat); raM.position.set(0,-0.175,0); raM.castShadow=true; raP.add(raM); g.add(raP);
    const sh=new THREE.Mesh(new THREE.CircleGeometry(0.2,8), new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:0.2}));
    sh.rotation.x=-Math.PI/2; sh.position.y=0.02; g.add(sh);
    return {group:g, body, head, leftLeg:llP, rightLeg:rlP, leftArm:laP, rightArm:raP};
}

function startAnimLoop() {
    if (animLoopRunning) return;
    animLoopRunning = true;
    animRenderLoop();
}

function animRenderLoop() {
    if (!animMode) { animLoopRunning = false; return; }
    requestAnimationFrame(animRenderLoop);
    const dt = Math.min(animClock.getDelta(), 0.1);
    if (animPlaying && currentAnimation) {
        animPlayTime += (dt / currentAnimation.duration) * animSpeed;
        if (animPlayTime >= 1) {
            if (currentAnimation.loop) { animPlayTime -= Math.floor(animPlayTime); }
            else { animPlayTime = 1; animPlaying = false; updatePlayBtn(); }
        }
        applyPose(animPlayTime);
        updateSliders();
        renderTimeline();
    }
    if (currentAnimation) {
        const t = animPlayTime * currentAnimation.duration;
        document.getElementById('anim-time-display').textContent = `${t.toFixed(2)}s / ${currentAnimation.duration.toFixed(2)}s`;
    }
    animRenderer.render(animScene, animCamera);
}

// Pose system
function getDefaultKF() { return {t:0,la_rx:0,la_rz:0,ra_rx:0,ra_rz:0,ll_rx:0,rl_rx:0,body_rx:0,body_y:0.5}; }

function lerpKF(a, b, t) {
    const r = {};
    for (const k of Object.keys(a)) { if (k==='t') continue; r[k]=a[k]+(b[k]-a[k])*t; }
    return r;
}

function getInterpolatedPose(nt) {
    if (!currentAnimation || !currentAnimation.keyframes.length) return getDefaultKF();
    const kfs = currentAnimation.keyframes;
    if (kfs.length === 1) return {...kfs[0]};
    let prev=kfs[0], next=kfs[kfs.length-1];
    for (let i=0; i<kfs.length-1; i++) {
        if (nt>=kfs[i].t && nt<=kfs[i+1].t) { prev=kfs[i]; next=kfs[i+1]; break; }
    }
    const range = next.t - prev.t;
    return range > 0 ? lerpKF(prev, next, (nt-prev.t)/range) : {...prev};
}

function applyPose(nt) {
    if (!animChar) return;
    const p = getInterpolatedPose(nt);
    animChar.leftArm.rotation.x = p.la_rx||0;  animChar.leftArm.rotation.z = p.la_rz||0;
    animChar.rightArm.rotation.x = p.ra_rx||0; animChar.rightArm.rotation.z = p.ra_rz||0;
    animChar.leftLeg.rotation.x = p.ll_rx||0;  animChar.rightLeg.rotation.x = p.rl_rx||0;
    animChar.body.rotation.x = p.body_rx||0;   animChar.body.position.y = p.body_y??0.5;
}

function applyKFPose(kf) {
    if (!animChar) return;
    animChar.leftArm.rotation.x = kf.la_rx||0;  animChar.leftArm.rotation.z = kf.la_rz||0;
    animChar.rightArm.rotation.x = kf.ra_rx||0; animChar.rightArm.rotation.z = kf.ra_rz||0;
    animChar.leftLeg.rotation.x = kf.ll_rx||0;  animChar.rightLeg.rotation.x = kf.rl_rx||0;
    animChar.body.rotation.x = kf.body_rx||0;   animChar.body.position.y = kf.body_y??0.5;
}

// Joint controls
function buildJointControls() {
    const c = document.getElementById('anim-controls-scroll');
    let html = '';
    for (const j of JOINTS) {
        html += `<div class="joint-group"><div class="joint-group-header">${j.label}</div>`;
        for (const p of j.props) {
            html += `<div class="joint-slider">
                <label>${p.label}</label>
                <input type="range" min="${p.min}" max="${p.max}" step="0.01" value="0"
                    id="slider-${p.key}" oninput="onJointSlider('${p.key}',this.value)">
                <span class="slider-val" id="val-${p.key}">0.00</span>
            </div>`;
        }
        html += '</div>';
    }
    c.innerHTML = html;
}

function onJointSlider(key, value) {
    const v = parseFloat(value);
    document.getElementById(`val-${key}`).textContent = v.toFixed(2);
    if (currentAnimation && currentAnimation.keyframes[selectedKeyframeIdx]) {
        currentAnimation.keyframes[selectedKeyframeIdx][key] = v;
    }
    if (!animPlaying && currentAnimation) applyKFPose(currentAnimation.keyframes[selectedKeyframeIdx]);
}

function updateSliders() {
    if (!currentAnimation) return;
    const pose = animPlaying ? getInterpolatedPose(animPlayTime) :
        (currentAnimation.keyframes[selectedKeyframeIdx] || getDefaultKF());
    for (const j of JOINTS) {
        for (const p of j.props) {
            const sl = document.getElementById(`slider-${p.key}`);
            const vl = document.getElementById(`val-${p.key}`);
            if (sl && vl) { const v=pose[p.key]??0; sl.value=v; vl.textContent=v.toFixed(2); }
        }
    }
}

// Animation selector
function populateAnimSelect() {
    const select = document.getElementById('anim-select');
    let html = '';
    for (const cat of ANIM_CATEGORIES) {
        const anims = ANIMATION_PRESETS.filter(a => a.category === cat.id);
        if (!anims.length) continue;
        html += `<optgroup label="${cat.icon} ${cat.name}">`;
        for (const a of anims) html += `<option value="${a.id}">${a.name}</option>`;
        html += '</optgroup>';
    }
    select.innerHTML = html;
}

function selectAnimation(animId) {
    const preset = ANIMATION_PRESETS.find(a => a.id === animId);
    if (!preset) return;
    const saved = savedAnimations[animId];
    const source = saved || preset;
    currentAnimation = {
        id:source.id, name:source.name, category:source.category,
        duration:source.duration, loop:source.loop,
        keyframes: source.keyframes.map(kf => ({...kf})),
    };
    selectedKeyframeIdx = 0; animPlayTime = 0; animPlaying = false;
    document.getElementById('anim-duration').value = currentAnimation.duration;
    document.getElementById('anim-loop').checked = currentAnimation.loop;
    updateSliders();
    applyKFPose(currentAnimation.keyframes[0]);
    renderTimeline();
    updatePlayBtn();
    document.getElementById('anim-select').value = animId;
}

// Playback
function animTogglePlay() {
    if (animPlaying) { animPlaying = false; }
    else {
        if (animPlayTime >= 1) animPlayTime = 0;
        animPlaying = true;
        animClock.getDelta();
        if (!animLoopRunning) startAnimLoop();
    }
    updatePlayBtn();
}

function animStop() {
    animPlaying = false; animPlayTime = 0;
    updatePlayBtn();
    if (currentAnimation) {
        selectedKeyframeIdx = 0;
        applyKFPose(currentAnimation.keyframes[0] || getDefaultKF());
        updateSliders();
    }
    renderTimeline();
}

function updatePlayBtn() {
    document.getElementById('anim-play-btn').innerHTML = animPlaying ? '&#9646;&#9646; Pause' : '&#9654; Play';
}

function animSpeedChanged(val) {
    animSpeed = parseFloat(val);
    document.getElementById('anim-speed-val').textContent = animSpeed.toFixed(1)+'x';
}

function animDurationChanged(val) { if (currentAnimation) currentAnimation.duration = parseFloat(val)||0.6; }
function animLoopChanged(checked) { if (currentAnimation) currentAnimation.loop = checked; }

// Keyframes
function addKeyframe() {
    if (!currentAnimation) return;
    const kfs = currentAnimation.keyframes;
    let t;
    if (animPlaying) { t = animPlayTime; }
    else if (selectedKeyframeIdx < kfs.length-1) { t = (kfs[selectedKeyframeIdx].t + kfs[selectedKeyframeIdx+1].t)/2; }
    else { t = Math.min(1, kfs[kfs.length-1].t + 0.1); }
    const pose = getInterpolatedPose(t);
    const newKF = {t, ...pose};
    kfs.push(newKF); kfs.sort((a,b) => a.t-b.t);
    selectedKeyframeIdx = kfs.indexOf(newKF);
    updateSliders(); renderTimeline();
    showToast('Keyframe added', 'success');
}

function deleteKeyframe() {
    if (!currentAnimation || currentAnimation.keyframes.length <= 2) { showToast('Need at least 2 keyframes','error'); return; }
    currentAnimation.keyframes.splice(selectedKeyframeIdx, 1);
    if (selectedKeyframeIdx >= currentAnimation.keyframes.length) selectedKeyframeIdx = currentAnimation.keyframes.length-1;
    updateSliders(); applyKFPose(currentAnimation.keyframes[selectedKeyframeIdx]);
    renderTimeline(); showToast('Keyframe deleted', 'success');
}

function copyKeyframe() {
    if (!currentAnimation || !currentAnimation.keyframes[selectedKeyframeIdx]) return;
    copiedKeyframe = {...currentAnimation.keyframes[selectedKeyframeIdx]};
    showToast('Keyframe copied', 'success');
}

function pasteKeyframe() {
    if (!copiedKeyframe || !currentAnimation) return;
    const kf = currentAnimation.keyframes[selectedKeyframeIdx];
    if (!kf) return;
    const t = kf.t;
    Object.assign(kf, copiedKeyframe, {t});
    updateSliders(); applyKFPose(kf); renderTimeline();
    showToast('Keyframe pasted', 'success');
}

// Timeline
function setupTimeline() {
    const canvas = document.getElementById('timeline-canvas');
    let dragging = false;
    canvas.addEventListener('mousedown', (e) => { dragging=true; handleTimelineClick(e); });
    document.addEventListener('mouseup', () => { dragging=false; });
    canvas.addEventListener('mousemove', (e) => {
        if (!dragging || !currentAnimation) return;
        const rect=canvas.getBoundingClientRect(), padding=30, trackW=rect.width-padding*2;
        animPlayTime = Math.max(0, Math.min(1, (e.clientX-rect.left-padding)/trackW));
        if (!animPlaying) { applyPose(animPlayTime); updateSliders(); }
        renderTimeline();
    });
    setTimeout(renderTimeline, 100);
}

function handleTimelineClick(e) {
    if (!currentAnimation) return;
    const canvas=document.getElementById('timeline-canvas');
    const rect=canvas.getBoundingClientRect(), padding=30, trackW=rect.width-padding*2;
    const nt = (e.clientX-rect.left-padding)/trackW;
    let closestIdx=0, closestDist=Infinity;
    currentAnimation.keyframes.forEach((kf,i) => {
        const d=Math.abs(kf.t-nt); if (d<closestDist) { closestDist=d; closestIdx=i; }
    });
    if (closestDist < 0.04) {
        selectedKeyframeIdx = closestIdx;
        animPlayTime = currentAnimation.keyframes[closestIdx].t;
        if (!animPlaying) applyKFPose(currentAnimation.keyframes[closestIdx]);
    } else {
        animPlayTime = Math.max(0, Math.min(1, nt));
        if (!animPlaying) applyPose(animPlayTime);
    }
    updateSliders(); renderTimeline();
}

function renderTimeline() {
    const canvas = document.getElementById('timeline-canvas');
    if (!canvas || !canvas.parentElement) return;
    const rect=canvas.parentElement.getBoundingClientRect(), dpr=window.devicePixelRatio;
    canvas.width=rect.width*dpr; canvas.height=80*dpr;
    canvas.style.width=rect.width+'px'; canvas.style.height='80px';
    const ctx=canvas.getContext('2d'); ctx.scale(dpr,dpr);
    const w=rect.width, h=80, padding=30, trackW=w-padding*2, trackY=h/2;
    ctx.fillStyle='#0f0f17'; ctx.fillRect(0,0,w,h);
    ctx.strokeStyle='#2a2a3d'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(padding,trackY); ctx.lineTo(padding+trackW,trackY); ctx.stroke();
    if (!currentAnimation) return;
    const dur=currentAnimation.duration, divs=Math.max(1,Math.ceil(dur/0.1));
    ctx.font='10px Inter'; ctx.textAlign='center';
    for (let i=0; i<=divs; i++) {
        const t=i/divs, x=padding+t*trackW;
        ctx.fillStyle='#333355'; ctx.fillRect(x-0.5,trackY-4,1,8);
        if (i%5===0 || divs<=10) { ctx.fillStyle='#64748b'; ctx.fillText((t*dur).toFixed(1)+'s',x,trackY+20); }
    }
    currentAnimation.keyframes.forEach((kf,i) => {
        const x=padding+kf.t*trackW, sel=i===selectedKeyframeIdx;
        ctx.beginPath(); ctx.arc(x,trackY,sel?8:6,0,Math.PI*2);
        ctx.fillStyle=sel?'#6366f1':'#4f46e5'; ctx.fill();
        ctx.strokeStyle=sel?'#818cf8':'#6366f1'; ctx.lineWidth=sel?2:1; ctx.stroke();
        ctx.fillStyle='#e2e8f0'; ctx.font=sel?'bold 10px Inter':'10px Inter';
        ctx.fillText(`KF${i+1}`,x,trackY-14);
    });
    const px=padding+animPlayTime*trackW;
    ctx.strokeStyle='#ef4444'; ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(px,5); ctx.lineTo(px,h-5); ctx.stroke();
    ctx.fillStyle='#ef4444'; ctx.beginPath();
    ctx.moveTo(px-5,5); ctx.lineTo(px+5,5); ctx.lineTo(px,12); ctx.closePath(); ctx.fill();
}

// Save / Load
async function animSave() {
    if (!currentAnimation) return;
    savedAnimations[currentAnimation.id] = {
        ...currentAnimation,
        keyframes: currentAnimation.keyframes.map(kf => ({...kf})),
    };
    await store.saveAnim(currentAnimation.id, savedAnimations[currentAnimation.id]);
    showToast(`Saved "${currentAnimation.name}"`, 'success');
}

// Export Code
function animExportCode() {
    if (!currentAnimation) return;
    const a = currentAnimation;
    const upper = a.id.toUpperCase();
    const camel = a.id.replace(/(^|_)(\w)/g, (_,__,c) => c.toUpperCase());

    let code = `// Animation: ${a.name} (${a.duration}s, loop: ${a.loop})\n`;
    code += `// Generated by AgentScape Forge Animation Editor\n\n`;
    code += `const ANIM_${upper} = {\n    duration: ${a.duration},\n    loop: ${a.loop},\n    keyframes: [\n`;
    for (const kf of a.keyframes) {
        const vals = Object.entries(kf).filter(([k])=>k!=='t')
            .map(([k,v])=>`${k}:${typeof v==='number'?v.toFixed(3):v}`).join(', ');
        code += `        { t:${kf.t.toFixed(3)}, ${vals} },\n`;
    }
    code += `    ]\n};\n\n`;
    code += `let ${a.id}Timer = 0;\n`;
    code += `function play${camel}() { ${a.id}Timer = ANIM_${upper}.duration; }\n\n`;
    code += `function update${camel}Anim(c, dt) {\n`;
    code += `    if (${a.id}Timer <= 0) return;\n`;
    code += `    ${a.id}Timer -= dt;\n`;
    code += `    const progress = 1 - Math.max(0, ${a.id}Timer) / ANIM_${upper}.duration;\n`;
    code += `    const kfs = ANIM_${upper}.keyframes;\n`;
    code += `    let prev = kfs[0], next = kfs[kfs.length - 1];\n`;
    code += `    for (let i = 0; i < kfs.length - 1; i++) {\n`;
    code += `        if (progress >= kfs[i].t && progress <= kfs[i+1].t) { prev = kfs[i]; next = kfs[i+1]; break; }\n`;
    code += `    }\n`;
    code += `    const range = next.t - prev.t;\n`;
    code += `    const t = range > 0 ? (progress - prev.t) / range : 0;\n`;
    code += `    const lerp = (a, b) => a + (b - a) * t;\n`;
    code += `    c.leftArm.rotation.x = lerp(prev.la_rx, next.la_rx);\n`;
    code += `    c.leftArm.rotation.z = lerp(prev.la_rz, next.la_rz);\n`;
    code += `    c.rightArm.rotation.x = lerp(prev.ra_rx, next.ra_rx);\n`;
    code += `    c.rightArm.rotation.z = lerp(prev.ra_rz, next.ra_rz);\n`;
    code += `    c.leftLeg.rotation.x = lerp(prev.ll_rx, next.ll_rx);\n`;
    code += `    c.rightLeg.rotation.x = lerp(prev.rl_rx, next.rl_rx);\n`;
    code += `    c.body.rotation.x = lerp(prev.body_rx, next.body_rx);\n`;
    code += `    c.body.position.y = lerp(prev.body_y, next.body_y);\n`;
    code += `    if (${a.id}Timer <= 0) {\n`;
    code += `        c.leftArm.rotation.x=0; c.leftArm.rotation.z=0;\n`;
    code += `        c.rightArm.rotation.x=0; c.rightArm.rotation.z=0;\n`;
    code += `        c.leftLeg.rotation.x=0; c.rightLeg.rotation.x=0;\n`;
    code += `        c.body.rotation.x=0; c.body.position.y=0.5;\n`;
    code += `    }\n}\n`;

    navigator.clipboard.writeText(code).then(() => {
        showToast('Animation code copied to clipboard!', 'success');
    }).catch(() => {
        const w = window.open('','_blank','width=700,height=500');
        w.document.write('<pre style="font-family:monospace;font-size:12px;padding:20px;">'+code.replace(/</g,'&lt;')+'</pre>');
    });
}

// Create new animation
function createNewAnimation() {
    const name = prompt('Animation name:');
    if (!name) return;
    const id = name.toLowerCase().replace(/[^a-z0-9]+/g,'_').replace(/^_|_$/g,'');
    if (ANIMATION_PRESETS.find(a => a.id === id)) { showToast('Name already exists','error'); return; }
    ANIMATION_PRESETS.push({
        id, name, category: selectedAnimCategory, duration: 1.0, loop: false,
        keyframes: [
            {t:0,la_rx:0,la_rz:0,ra_rx:0,ra_rz:0,ll_rx:0,rl_rx:0,body_rx:0,body_y:0.5},
            {t:1,la_rx:0,la_rz:0,ra_rx:0,ra_rz:0,ll_rx:0,rl_rx:0,body_rx:0,body_y:0.5},
        ],
    });
    populateAnimSelect();
    selectAnimation(id);
    renderSidebar();
    showToast(`Created "${name}"`, 'success');
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('settings-modal').classList.contains('open')) closeSettings();
        else if (document.getElementById('item-modal').classList.contains('open')) closeItemModal();
    }
    // Animation editor shortcuts
    if (animMode && !e.target.matches('input,textarea,select')) {
        if (e.key === ' ') { e.preventDefault(); animTogglePlay(); }
    }
    if (document.getElementById('item-modal').classList.contains('open')) {
        if (e.key === 'ArrowLeft') navItem(-1);
        if (e.key === 'ArrowRight') navItem(1);
    }
});

// Click outside modal to close
document.getElementById('item-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeItemModal();
});
document.getElementById('settings-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeSettings();
});

// ============================================================
// INIT
// ============================================================
async function init() {
    await store.init();
    const allAssets = await store.getAll();
    for (const a of allAssets) { assets[a.id] = a; }
    // Load saved animations
    try {
        const allAnims = await store.getAllAnims();
        for (const a of allAnims) { savedAnimations[a.id] = a; }
    } catch(e) { /* first run, no animations store yet */ }
    renderSidebar();
    renderGrid();
    updateProgress();
}

init();
</script>
</body>
</html>
