<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentScape Forge | Asset Generator</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg-base: #08080d;
            --bg-surface: #0f0f17;
            --bg-elevated: #16161f;
            --bg-hover: #1e1e2e;
            --bg-active: #252538;
            --border: #2a2a3d;
            --border-light: #3a3a52;
            --text-primary: #e2e8f0;
            --text-secondary: #94a3b8;
            --text-muted: #64748b;
            --accent: #6366f1;
            --accent-hover: #818cf8;
            --accent-dim: #4f46e5;
            --success: #22c55e;
            --warning: #eab308;
            --danger: #ef4444;
            --tier-bronze: #CD7F32;
            --tier-iron: #71797E;
            --tier-steel: #C0C0C0;
            --tier-mithril: #7B68EE;
            --tier-rune: #00CED1;
            --tier-dragon: #DC143C;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-base); color: var(--text-primary); height: 100vh; overflow: hidden; display: flex; flex-direction: column; }

        /* HEADER */
        .header { height: 52px; background: var(--bg-surface); border-bottom: 1px solid var(--border); display: flex; align-items: center; padding: 0 20px; gap: 16px; flex-shrink: 0; }
        .header-logo { font-size: 18px; font-weight: 800; display: flex; align-items: center; gap: 8px; }
        .header-logo span { color: var(--accent); }
        .header-progress { flex: 1; display: flex; align-items: center; gap: 10px; margin-left: 24px; }
        .header-progress-text { font-size: 12px; color: var(--text-secondary); white-space: nowrap; }
        .header-progress-bar { flex: 1; max-width: 300px; height: 6px; background: var(--bg-elevated); border-radius: 3px; overflow: hidden; }
        .header-progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); border-radius: 3px; transition: width 0.3s; }
        .header-actions { display: flex; gap: 8px; }
        .btn { padding: 7px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--bg-elevated); color: var(--text-primary); font-size: 12px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.15s; font-family: inherit; }
        .btn:hover { background: var(--bg-hover); border-color: var(--border-light); }
        .btn-primary { background: var(--accent); border-color: var(--accent); }
        .btn-primary:hover { background: var(--accent-hover); }
        .btn-danger { border-color: var(--danger); color: var(--danger); }
        .btn-danger:hover { background: rgba(239,68,68,0.1); }
        .btn-success { background: var(--success); border-color: var(--success); color: #000; }

        /* LAYOUT */
        .layout { display: flex; flex: 1; overflow: hidden; }

        /* SIDEBAR */
        .sidebar { width: 232px; background: var(--bg-surface); border-right: 1px solid var(--border); display: flex; flex-direction: column; overflow-y: auto; flex-shrink: 0; }
        .sidebar-group { padding: 12px 0 4px 0; }
        .sidebar-group-label { font-size: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; color: var(--text-muted); padding: 0 16px; margin-bottom: 4px; }
        .sidebar-item { display: flex; align-items: center; padding: 8px 16px; cursor: pointer; transition: all 0.1s; gap: 10px; border-left: 3px solid transparent; }
        .sidebar-item:hover { background: var(--bg-hover); }
        .sidebar-item.active { background: var(--bg-elevated); border-left-color: var(--accent); }
        .sidebar-item-icon { font-size: 16px; width: 24px; text-align: center; }
        .sidebar-item-name { font-size: 13px; font-weight: 500; flex: 1; }
        .sidebar-item-count { font-size: 11px; color: var(--text-muted); font-weight: 600; }
        .sidebar-item-count.complete { color: var(--success); }
        .sidebar-footer { margin-top: auto; padding: 12px; border-top: 1px solid var(--border); display: flex; flex-direction: column; gap: 6px; }
        .sidebar-footer .btn { width: 100%; justify-content: center; }

        /* MAIN GRID */
        .main { flex: 1; overflow-y: auto; padding: 24px; }
        .main-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .main-title { font-size: 20px; font-weight: 700; }
        .main-subtitle { font-size: 13px; color: var(--text-secondary); margin-top: 2px; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        .item-card { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 10px; padding: 16px 12px; display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: all 0.15s; position: relative; }
        .item-card:hover { background: var(--bg-hover); border-color: var(--border-light); transform: translateY(-2px); }
        .item-card.has-asset { border-color: var(--success); }
        .item-card.has-asset::after { content: ''; position: absolute; top: 8px; right: 8px; width: 8px; height: 8px; background: var(--success); border-radius: 50%; }
        .item-card-preview { width: 64px; height: 64px; display: flex; align-items: center; justify-content: center; font-size: 36px; margin-bottom: 8px; border-radius: 6px; background: var(--bg-active); overflow: hidden; }
        .item-card-preview img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .item-card-name { font-size: 12px; font-weight: 600; text-align: center; line-height: 1.3; }
        .item-card-tier { font-size: 10px; font-weight: 700; margin-top: 4px; padding: 1px 8px; border-radius: 10px; text-transform: uppercase; letter-spacing: 0.5px; }
        .item-card-type { font-size: 10px; color: var(--text-muted); margin-top: 2px; }
        .tier-1 { color: var(--tier-bronze); border: 1px solid var(--tier-bronze); }
        .tier-2 { color: var(--tier-iron); border: 1px solid var(--tier-iron); }
        .tier-3 { color: var(--tier-steel); border: 1px solid var(--tier-steel); }
        .tier-4 { color: var(--tier-mithril); border: 1px solid var(--tier-mithril); }
        .tier-5 { color: var(--tier-rune); border: 1px solid var(--tier-rune); }
        .tier-6 { color: var(--tier-dragon); border: 1px solid var(--tier-dragon); }

        /* MODAL OVERLAY */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 100; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-overlay.open { display: flex; }
        .modal { background: var(--bg-surface); border: 1px solid var(--border); border-radius: 14px; width: 680px; max-width: 95vw; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .modal-header h2 { font-size: 16px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
        .modal-close { background: none; border: none; color: var(--text-secondary); font-size: 20px; cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .modal-close:hover { background: var(--bg-hover); color: var(--text-primary); }
        .modal-body { display: flex; gap: 0; overflow-y: auto; flex: 1; }
        .modal-preview { flex: 0 0 260px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 24px; background: var(--bg-base); border-right: 1px solid var(--border); }
        .modal-preview-img { width: 180px; height: 180px; display: flex; align-items: center; justify-content: center; font-size: 80px; background: var(--bg-elevated); border-radius: 12px; border: 2px dashed var(--border); overflow: hidden; }
        .modal-preview-img img { width: 100%; height: 100%; object-fit: contain; image-rendering: pixelated; }
        .modal-preview-img.has-image { border-style: solid; border-color: var(--success); }
        .modal-stats { margin-top: 16px; display: flex; flex-wrap: wrap; gap: 6px; justify-content: center; }
        .stat-badge { font-size: 11px; font-weight: 600; padding: 3px 10px; border-radius: 12px; background: var(--bg-elevated); border: 1px solid var(--border); }
        .modal-controls { flex: 1; padding: 20px; display: flex; flex-direction: column; gap: 14px; }
        .control-group { display: flex; flex-direction: column; gap: 4px; }
        .control-label { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; color: var(--text-muted); }
        .control-input { background: var(--bg-elevated); border: 1px solid var(--border); border-radius: 6px; padding: 8px 12px; color: var(--text-primary); font-size: 13px; font-family: inherit; resize: vertical; }
        .control-input:focus { outline: none; border-color: var(--accent); }
        textarea.control-input { min-height: 80px; }
        .control-row { display: flex; gap: 8px; }
        .control-row .btn { flex: 1; justify-content: center; }
        .modal-footer { padding: 14px 20px; border-top: 1px solid var(--border); display: flex; gap: 8px; justify-content: flex-end; }
        .generating-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid var(--text-muted); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.6s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .nav-arrows { display: flex; gap: 6px; }
        .nav-arrow { background: var(--bg-elevated); border: 1px solid var(--border); color: var(--text-secondary); width: 28px; height: 28px; border-radius: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .nav-arrow:hover { background: var(--bg-hover); color: var(--text-primary); }

        /* SETTINGS MODAL */
        .settings-modal { width: 480px; }
        .settings-section { padding: 16px 20px; border-bottom: 1px solid var(--border); }
        .settings-section:last-child { border-bottom: none; }
        .settings-section h3 { font-size: 13px; font-weight: 700; margin-bottom: 10px; }
        .settings-note { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

        /* TOAST */
        .toast { position: fixed; bottom: 24px; right: 24px; background: var(--bg-elevated); border: 1px solid var(--border); padding: 12px 20px; border-radius: 8px; font-size: 13px; z-index: 200; display: none; animation: slideUp 0.3s; }
        .toast.success { border-color: var(--success); }
        .toast.error { border-color: var(--danger); }
        @keyframes slideUp { from { transform: translateY(10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

        /* EMPTY STATE */
        .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
        .empty-state-icon { font-size: 48px; margin-bottom: 12px; }
        .empty-state-text { font-size: 14px; }
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <div class="header-logo"><span>AgentScape</span> Forge</div>
    <div class="header-progress">
        <span class="header-progress-text" id="progress-text">0 / 50 assets</span>
        <div class="header-progress-bar"><div class="header-progress-fill" id="progress-fill" style="width:0%"></div></div>
    </div>
    <div class="header-actions">
        <button class="btn" onclick="openSettings()">Settings</button>
        <button class="btn btn-primary" onclick="exportAll()">Export ZIP</button>
    </div>
</div>

<!-- LAYOUT -->
<div class="layout">
    <!-- SIDEBAR -->
    <div class="sidebar" id="sidebar"></div>

    <!-- MAIN GRID -->
    <div class="main" id="main"></div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="item-modal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="modal-title"></h2>
            <div style="display:flex;align-items:center;gap:10px;">
                <div class="nav-arrows">
                    <button class="nav-arrow" onclick="navItem(-1)" title="Previous">&#8592;</button>
                    <button class="nav-arrow" onclick="navItem(1)" title="Next">&#8594;</button>
                </div>
                <button class="modal-close" onclick="closeItemModal()">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <div class="modal-preview">
                <div class="modal-preview-img" id="modal-preview-img"></div>
                <div class="modal-stats" id="modal-stats"></div>
            </div>
            <div class="modal-controls">
                <div class="control-group">
                    <label class="control-label">Description / Prompt</label>
                    <textarea class="control-input" id="modal-prompt" placeholder="Describe how this item should look..."></textarea>
                </div>
                <div class="control-group">
                    <label class="control-label">Style Override (optional)</label>
                    <input class="control-input" id="modal-style" placeholder="Leave blank to use global style">
                </div>
                <div class="control-row">
                    <button class="btn btn-primary" id="btn-generate" onclick="generateImage()">Generate</button>
                    <button class="btn" onclick="uploadCustom()">Upload</button>
                </div>
                <div class="control-row" id="asset-actions" style="display:none">
                    <button class="btn btn-danger" onclick="clearAsset()">Remove</button>
                    <button class="btn" onclick="downloadSingle()">Download PNG</button>
                </div>
                <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleUpload(event)">
            </div>
        </div>
    </div>
</div>

<!-- SETTINGS MODAL -->
<div class="modal-overlay" id="settings-modal">
    <div class="modal settings-modal">
        <div class="modal-header">
            <h2>Settings</h2>
            <button class="modal-close" onclick="closeSettings()">&times;</button>
        </div>
        <div class="settings-section">
            <h3>OpenAI API Key</h3>
            <input class="control-input" id="setting-apikey" type="password" placeholder="sk-..." style="width:100%">
            <p class="settings-note">Used for DALL-E 3 image generation. Stored locally in your browser only.</p>
        </div>
        <div class="settings-section">
            <h3>Global Style Prefix</h3>
            <textarea class="control-input" id="setting-style" style="width:100%;min-height:60px"></textarea>
            <p class="settings-note">Prepended to every generation prompt for consistency.</p>
        </div>
        <div class="settings-section">
            <h3>Image Model</h3>
            <select class="control-input" id="setting-model" style="width:100%">
                <option value="dall-e-3">DALL-E 3 (1024x1024)</option>
                <option value="gpt-image-1">GPT Image 1</option>
            </select>
        </div>
        <div class="settings-section" style="display:flex;justify-content:flex-end;">
            <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
        </div>
    </div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// ITEM REGISTRY â€” All 50 items from AgentScape config
// ============================================================
const TIER_NAMES = { 1:'Bronze', 2:'Iron', 3:'Steel', 4:'Mithril', 5:'Rune', 6:'Dragon' };
const TIER_HINTS = {
    1: 'copper-brown metal, crude simple design',
    2: 'dark gray iron, functional sturdy design',
    3: 'polished bright silver steel, refined design',
    4: 'blue-purple glowing mithril, ornate magical design',
    5: 'teal cyan glowing rune metal, elegant with rune symbols',
    6: 'crimson red dragon metal, fierce and fearsome design'
};

const CATEGORIES = [
    { id:'swords', name:'Swords', icon:'\u2694\uFE0F', group:'Equipment' },
    { id:'helms', name:'Helms', icon:'\uD83E\uDE96', group:'Equipment' },
    { id:'shields', name:'Shields', icon:'\uD83D\uDEE1\uFE0F', group:'Equipment' },
    { id:'tools', name:'Tools', icon:'\uD83E\uDE93', group:'Equipment' },
    { id:'food', name:'Food', icon:'\uD83C\uDF56', group:'Consumables' },
    { id:'potions', name:'Potions', icon:'\u2697\uFE0F', group:'Consumables' },
    { id:'resources', name:'Resources', icon:'\uD83E\uDEB5', group:'Materials' },
    { id:'crafting', name:'Crafting', icon:'\uD83D\uDC8E', group:'Materials' },
    { id:'drops', name:'Monster Drops', icon:'\uD83E\uDDE0', group:'Materials' },
    { id:'trophies', name:'Trophies', icon:'\uD83C\uDFC6', group:'Special' },
    { id:'misc', name:'Misc & Quest', icon:'\uD83D\uDD2E', group:'Special' },
    { id:'currency', name:'Currency', icon:'\uD83E\uDE99', group:'Special' },
];

const ITEMS = [
    // --- Swords ---
    { id:'bronze_sword', name:'Bronze Sword', icon:'\uD83D\uDDE1\uFE0F', category:'swords', type:'weapon', tier:1, stats:{attack:4,strength:3}, prompt:'A short crude bronze sword with copper-brown blade and wrapped leather handle' },
    { id:'iron_sword', name:'Iron Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:2, stats:{attack:8,strength:6}, prompt:'An iron longsword with dark gray blade and simple crossguard' },
    { id:'steel_sword', name:'Steel Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:3, stats:{attack:12,strength:10}, prompt:'A polished steel longsword with bright silver blade and decorated guard' },
    { id:'mithril_sword', name:'Mithril Sword', icon:'\uD83D\uDDE1\uFE0F', category:'swords', type:'weapon', tier:4, stats:{attack:18,strength:15}, prompt:'A magical mithril blade glowing blue-purple, ornate elvish design' },
    { id:'rune_sword', name:'Rune Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:5, stats:{attack:26,strength:22}, prompt:'A mystical rune sword with teal cyan blade covered in glowing ancient rune symbols' },
    { id:'dragon_sword', name:'Dragon Sword', icon:'\u2694\uFE0F', category:'swords', type:'weapon', tier:6, stats:{attack:36,strength:30}, prompt:'A fearsome crimson dragon sword with red blade and dragon head pommel' },

    // --- Helms ---
    { id:'bronze_helm', name:'Bronze Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:1, stats:{defence:3}, prompt:'A simple bronze helmet with copper-brown metal and nose guard' },
    { id:'iron_helm', name:'Iron Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:2, stats:{defence:6}, prompt:'A sturdy iron helmet with dark gray metal and cheek guards' },
    { id:'steel_helm', name:'Steel Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:3, stats:{defence:10}, prompt:'A polished steel full helm with silver shine and visor slit' },
    { id:'mithril_helm', name:'Mithril Helm', icon:'\uD83E\uDE96', category:'helms', type:'helm', tier:4, stats:{defence:15}, prompt:'A blue-purple mithril helm with magical glow and wing ornaments' },
    { id:'rune_helm', name:'Rune Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:5, stats:{defence:22}, prompt:'A teal cyan rune full helm with glowing rune inscriptions' },
    { id:'dragon_helm', name:'Dragon Helm', icon:'\u26D1\uFE0F', category:'helms', type:'helm', tier:6, stats:{defence:30}, prompt:'A fearsome crimson dragon helm shaped like a dragon head with horns' },

    // --- Shields ---
    { id:'bronze_shield', name:'Bronze Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:1, stats:{defence:4}, prompt:'A round bronze shield with copper-brown metal and simple boss' },
    { id:'iron_shield', name:'Iron Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:2, stats:{defence:8}, prompt:'A kite shield of dark gray iron with riveted edges' },
    { id:'steel_shield', name:'Steel Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:3, stats:{defence:12}, prompt:'A polished steel kite shield with silver finish and embossed cross' },
    { id:'mithril_shield', name:'Mithril Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:4, stats:{defence:18}, prompt:'A blue-purple mithril shield with magical sigils and soft glow' },
    { id:'rune_shield', name:'Rune Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:5, stats:{defence:25}, prompt:'A teal cyan rune shield with ancient rune carvings that glow' },
    { id:'dragon_shield', name:'Dragon Shield', icon:'\uD83D\uDEE1\uFE0F', category:'shields', type:'shield', tier:6, stats:{defence:34}, prompt:'A crimson dragon shield with dragon scale texture and dragon emblem' },

    // --- Tools ---
    { id:'bronze_axe', name:'Bronze Axe', icon:'\uD83E\uDE93', category:'tools', type:'axe', tier:1, stats:{attack:3}, prompt:'A simple bronze hatchet with copper head and wooden handle' },

    // --- Food ---
    { id:'bread', name:'Bread', icon:'\uD83C\uDF5E', category:'food', type:'food', healAmount:10, prompt:'A fresh loaf of golden brown bread' },
    { id:'cooked_meat', name:'Cooked Meat', icon:'\uD83C\uDF56', category:'food', type:'food', healAmount:20, prompt:'A juicy cooked meat leg on the bone, grilled with char marks' },
    { id:'cooked_fish', name:'Cooked Fish', icon:'\uD83D\uDC20', category:'food', type:'food', healAmount:15, prompt:'A whole cooked fish, golden brown and crispy' },
    { id:'lobster', name:'Lobster', icon:'\uD83E\uDD9E', category:'food', type:'food', healAmount:30, prompt:'A bright red cooked lobster on a plate' },
    { id:'shark', name:'Shark', icon:'\uD83E\uDD88', category:'food', type:'food', healAmount:40, prompt:'A cooked shark steak, large and meaty' },
    { id:'manta_ray', name:'Manta Ray', icon:'\uD83D\uDC20', category:'food', type:'food', healAmount:50, prompt:'A rare cooked manta ray fillet, dark and exotic' },

    // --- Potions ---
    { id:'attack_potion', name:'Attack Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with glowing red attack potion, cork stopper' },
    { id:'strength_potion', name:'Strength Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with bright green strength potion, cork stopper' },
    { id:'defence_potion', name:'Defence Potion', icon:'\u2697\uFE0F', category:'potions', type:'potion', prompt:'A glass vial with glowing blue defence potion, cork stopper' },

    // --- Resources ---
    { id:'normal_logs', name:'Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A small stack of rough-cut wooden logs' },
    { id:'oak_logs', name:'Oak Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A stack of sturdy dark brown oak logs' },
    { id:'willow_logs', name:'Willow Logs', icon:'\uD83E\uDEB5', category:'resources', type:'resource', prompt:'A bundle of flexible light-colored willow logs' },

    // --- Crafting Materials ---
    { id:'raw_fish', name:'Raw Fish', icon:'\uD83D\uDC1F', category:'crafting', type:'material', prompt:'A fresh raw silver fish, uncooked' },
    { id:'logs', name:'Crafting Logs', icon:'\uD83E\uDEB5', category:'crafting', type:'material', prompt:'A single cut log ready for crafting' },
    { id:'code_fragment', name:'Code Fragment', icon:'\uD83D\uDC8E', category:'crafting', type:'material', prompt:'A glowing crystalline code fragment, digital blue energy inside a gem shape' },

    // --- Monster Drops ---
    { id:'corrupted_byte', name:'Corrupted Byte', icon:'\uD83E\uDDE0', category:'drops', type:'material', zone:'the_forest', prompt:'A pulsing corrupted data fragment shaped like a brain, purple and glitchy' },
    { id:'broken_link', name:'Broken Link', icon:'\uD83D\uDD17', category:'drops', type:'material', zone:'the_forest', prompt:'A snapped chain link crackling with broken digital energy' },
    { id:'rogue_script', name:'Rogue Script', icon:'\uD83D\uDCDC', category:'drops', type:'material', zone:'the_forest', prompt:'A tattered scroll with glowing red code text, dangerous script' },
    { id:'memory_shard', name:'Memory Shard', icon:'\uD83D\uDCA0', category:'drops', type:'material', zone:'the_ruins', prompt:'A translucent crystal shard containing swirling memory data fragments' },
    { id:'null_fragment', name:'Null Fragment', icon:'\u26A0\uFE0F', category:'drops', type:'material', zone:'the_ruins', prompt:'A void-black fragment of nothingness with warning glow at edges' },
    { id:'overflow_essence', name:'Overflow Essence', icon:'\uD83C\uDF00', category:'drops', type:'material', zone:'the_ruins', prompt:'A swirling vortex of overflowing digital energy, spiraling cyan' },
    { id:'dark_packet', name:'Dark Packet', icon:'\uD83C\uDF11', category:'drops', type:'material', zone:'the_deep_network', prompt:'A dark orb containing encrypted black data, faint red glow' },
    { id:'firewall_core', name:'Firewall Core', icon:'\uD83D\uDD25', category:'drops', type:'material', zone:'the_deep_network', prompt:'A blazing core of firewall energy, orange and red flames in a sphere' },
    { id:'dragon_scale', name:'Dragon Scale', icon:'\uD83D\uDC09', category:'drops', type:'material', zone:'the_deep_network', prompt:'A single large crimson dragon scale, iridescent and tough' },

    // --- Trophies ---
    { id:'rogue_script_trophy', name:'Rogue Script Trophy', icon:'\uD83C\uDFC6', category:'trophies', type:'misc', prompt:'A golden trophy with a dangerous glowing script scroll mounted on top' },
    { id:'golem_heart', name:'404 Golem Heart', icon:'\uD83D\uDDA4', category:'trophies', type:'misc', prompt:'A mechanical golem heart made of stone and circuits, cracked and glowing' },
    { id:'hallucinator_eye', name:'Hallucinator Eye', icon:'\uD83D\uDC41\uFE0F', category:'trophies', type:'misc', prompt:'A disembodied floating eye with swirling hypnotic patterns, eerie glow' },
    { id:'dragon_heart', name:'Dragon Heart', icon:'\u2764\uFE0F\u200D\uD83D\uDD25', category:'trophies', type:'misc', prompt:'A massive dragon heart on fire, beating with crimson energy' },

    // --- Misc & Quest ---
    { id:'agent_core', name:'Agent Core', icon:'\uD83D\uDD2E', category:'misc', type:'misc', prompt:'A glowing crystal orb containing an AI agent consciousness, purple energy' },
    { id:'network_key', name:'Network Key', icon:'\uD83D\uDD11', category:'misc', type:'misc', prompt:'An ornate golden key with digital circuit patterns etched into it' },

    // --- Currency ---
    { id:'coins', name:'Coins', icon:'\uD83E\uDE99', category:'currency', type:'coin', prompt:'A stack of shiny gold coins with embossed symbols' },
];

// ============================================================
// ASSET STORE (IndexedDB)
// ============================================================
class AssetStore {
    constructor() { this.db = null; }

    init() {
        return new Promise((resolve, reject) => {
            const req = indexedDB.open('agentscape-forge', 1);
            req.onupgradeneeded = (e) => {
                const db = e.target.result;
                if (!db.objectStoreNames.contains('assets')) db.createObjectStore('assets', { keyPath: 'id' });
            };
            req.onsuccess = (e) => { this.db = e.target.result; resolve(); };
            req.onerror = (e) => reject(e);
        });
    }

    save(id, data) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readwrite');
            tx.objectStore('assets').put({ id, ...data });
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }

    get(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readonly');
            const req = tx.objectStore('assets').get(id);
            req.onsuccess = () => resolve(req.result || null);
            req.onerror = (e) => reject(e);
        });
    }

    getAll() {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readonly');
            const req = tx.objectStore('assets').getAll();
            req.onsuccess = () => resolve(req.result || []);
            req.onerror = (e) => reject(e);
        });
    }

    delete(id) {
        return new Promise((resolve, reject) => {
            const tx = this.db.transaction('assets', 'readwrite');
            tx.objectStore('assets').delete(id);
            tx.oncomplete = () => resolve();
            tx.onerror = (e) => reject(e);
        });
    }
}

// ============================================================
// STATE
// ============================================================
const store = new AssetStore();
let assets = {};  // id -> { imageData, prompt, generatedAt }
let selectedCategory = 'swords';
let selectedItemId = null;
let generating = false;

// ============================================================
// SETTINGS
// ============================================================
const DEFAULT_STYLE = 'Single game item icon, pixel art style, 32x32 resolution, centered on solid black background, no text, no labels, no extra objects, high contrast, dark outline, fantasy RPG style';

function getSettings() {
    return {
        apiKey: localStorage.getItem('forge_apikey') || '',
        style: localStorage.getItem('forge_style') || DEFAULT_STYLE,
        model: localStorage.getItem('forge_model') || 'dall-e-3',
    };
}

function openSettings() {
    const s = getSettings();
    document.getElementById('setting-apikey').value = s.apiKey;
    document.getElementById('setting-style').value = s.style;
    document.getElementById('setting-model').value = s.model;
    document.getElementById('settings-modal').classList.add('open');
}

function closeSettings() {
    document.getElementById('settings-modal').classList.remove('open');
}

function saveSettings() {
    localStorage.setItem('forge_apikey', document.getElementById('setting-apikey').value.trim());
    localStorage.setItem('forge_style', document.getElementById('setting-style').value.trim());
    localStorage.setItem('forge_model', document.getElementById('setting-model').value);
    closeSettings();
    showToast('Settings saved', 'success');
}

// ============================================================
// UI RENDERING
// ============================================================
function renderSidebar() {
    const sidebar = document.getElementById('sidebar');
    let html = '';
    let currentGroup = '';

    for (const cat of CATEGORIES) {
        if (cat.group !== currentGroup) {
            currentGroup = cat.group;
            html += `<div class="sidebar-group"><div class="sidebar-group-label">${currentGroup}</div></div>`;
        }
        const items = ITEMS.filter(i => i.category === cat.id);
        const done = items.filter(i => assets[i.id]).length;
        const total = items.length;
        const isComplete = done === total && total > 0;
        html += `<div class="sidebar-item ${cat.id === selectedCategory ? 'active' : ''}" onclick="selectCategory('${cat.id}')">
            <span class="sidebar-item-icon">${cat.icon}</span>
            <span class="sidebar-item-name">${cat.name}</span>
            <span class="sidebar-item-count ${isComplete ? 'complete' : ''}">${done}/${total}</span>
        </div>`;
    }

    html += `<div class="sidebar-footer">
        <button class="btn" onclick="openSettings()">Settings</button>
        <button class="btn btn-primary" onclick="exportAll()">Export ZIP</button>
    </div>`;

    sidebar.innerHTML = html;
}

function renderGrid() {
    const main = document.getElementById('main');
    const cat = CATEGORIES.find(c => c.id === selectedCategory);
    const items = ITEMS.filter(i => i.category === selectedCategory);

    if (!cat || items.length === 0) {
        main.innerHTML = '<div class="empty-state"><div class="empty-state-icon">???</div><div class="empty-state-text">No items in this category</div></div>';
        return;
    }

    let html = `<div class="main-header">
        <div>
            <div class="main-title">${cat.icon} ${cat.name}</div>
            <div class="main-subtitle">${items.filter(i=>assets[i.id]).length} of ${items.length} assets generated</div>
        </div>
    </div>`;

    html += '<div class="item-grid">';
    for (const item of items) {
        const asset = assets[item.id];
        const tierClass = item.tier ? `tier-${item.tier}` : '';
        const tierLabel = item.tier ? TIER_NAMES[item.tier] : '';

        html += `<div class="item-card ${asset ? 'has-asset' : ''}" onclick="openItemModal('${item.id}')">
            <div class="item-card-preview">
                ${asset ? `<img src="${asset.imageData}" alt="${item.name}">` : item.icon}
            </div>
            <div class="item-card-name">${item.name}</div>
            ${tierLabel ? `<div class="item-card-tier ${tierClass}">${tierLabel}</div>` : ''}
            ${!item.tier && item.type ? `<div class="item-card-type">${item.type}</div>` : ''}
        </div>`;
    }
    html += '</div>';

    main.innerHTML = html;
}

function updateProgress() {
    const total = ITEMS.length;
    const done = ITEMS.filter(i => assets[i.id]).length;
    const pct = total > 0 ? Math.round((done / total) * 100) : 0;
    document.getElementById('progress-text').textContent = `${done} / ${total} assets`;
    document.getElementById('progress-fill').style.width = pct + '%';
}

// ============================================================
// ITEM MODAL
// ============================================================
function openItemModal(itemId) {
    selectedItemId = itemId;
    const item = ITEMS.find(i => i.id === itemId);
    if (!item) return;
    const asset = assets[itemId];

    document.getElementById('modal-title').innerHTML = `${item.icon} ${item.name}`;

    const previewEl = document.getElementById('modal-preview-img');
    if (asset) {
        previewEl.innerHTML = `<img src="${asset.imageData}" alt="${item.name}">`;
        previewEl.classList.add('has-image');
    } else {
        previewEl.innerHTML = `<span>${item.icon}</span>`;
        previewEl.classList.remove('has-image');
    }

    // Stats
    let statsHtml = '';
    if (item.tier) statsHtml += `<span class="stat-badge tier-${item.tier}">Tier ${item.tier}: ${TIER_NAMES[item.tier]}</span>`;
    if (item.stats?.attack) statsHtml += `<span class="stat-badge">ATK +${item.stats.attack}</span>`;
    if (item.stats?.strength) statsHtml += `<span class="stat-badge">STR +${item.stats.strength}</span>`;
    if (item.stats?.defence) statsHtml += `<span class="stat-badge">DEF +${item.stats.defence}</span>`;
    if (item.healAmount) statsHtml += `<span class="stat-badge">Heal +${item.healAmount}</span>`;
    if (item.zone) statsHtml += `<span class="stat-badge">${item.zone.replace(/_/g,' ')}</span>`;
    statsHtml += `<span class="stat-badge">${item.type}</span>`;
    document.getElementById('modal-stats').innerHTML = statsHtml;

    // Prompt
    document.getElementById('modal-prompt').value = asset?.prompt || item.prompt || '';
    document.getElementById('modal-style').value = '';

    // Show/hide asset actions
    document.getElementById('asset-actions').style.display = asset ? 'flex' : 'none';

    document.getElementById('item-modal').classList.add('open');
}

function closeItemModal() {
    document.getElementById('item-modal').classList.remove('open');
    selectedItemId = null;
}

function navItem(dir) {
    if (!selectedItemId) return;
    const catItems = ITEMS.filter(i => i.category === selectedCategory);
    const idx = catItems.findIndex(i => i.id === selectedItemId);
    if (idx === -1) return;
    const newIdx = (idx + dir + catItems.length) % catItems.length;
    openItemModal(catItems[newIdx].id);
}

// ============================================================
// IMAGE GENERATION
// ============================================================
async function generateImage() {
    if (generating) return;
    const settings = getSettings();
    if (!settings.apiKey) {
        showToast('Set your OpenAI API key in Settings first', 'error');
        return;
    }

    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;

    const description = document.getElementById('modal-prompt').value.trim();
    if (!description) {
        showToast('Enter a description for the item', 'error');
        return;
    }

    const styleOverride = document.getElementById('modal-style').value.trim();
    const baseStyle = styleOverride || settings.style || DEFAULT_STYLE;
    let fullPrompt = `${baseStyle}. ${description}.`;
    if (item.tier && TIER_HINTS[item.tier]) {
        fullPrompt += ` The item has ${TIER_HINTS[item.tier]}.`;
    }

    generating = true;
    const btn = document.getElementById('btn-generate');
    btn.innerHTML = '<span class="generating-spinner"></span> Generating...';
    btn.disabled = true;

    try {
        let imageData;
        if (settings.model === 'gpt-image-1') {
            imageData = await callGptImage(settings.apiKey, fullPrompt);
        } else {
            imageData = await callDalle3(settings.apiKey, fullPrompt);
        }

        assets[item.id] = { imageData, prompt: description, generatedAt: Date.now() };
        await store.save(item.id, assets[item.id]);

        openItemModal(item.id);
        renderGrid();
        renderSidebar();
        updateProgress();
        showToast(`Generated ${item.name}`, 'success');
    } catch (err) {
        console.error(err);
        showToast(`Generation failed: ${err.message}`, 'error');
    } finally {
        generating = false;
        btn.innerHTML = 'Generate';
        btn.disabled = false;
    }
}

async function callDalle3(apiKey, prompt) {
    const res = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({ model: 'dall-e-3', prompt, n: 1, size: '1024x1024', quality: 'standard', response_format: 'b64_json' })
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || `API error ${res.status}`);
    }
    const data = await res.json();
    return 'data:image/png;base64,' + data.data[0].b64_json;
}

async function callGptImage(apiKey, prompt) {
    const res = await fetch('https://api.openai.com/v1/images/generations', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${apiKey}` },
        body: JSON.stringify({ model: 'gpt-image-1', prompt, n: 1, size: '1024x1024', quality: 'medium' })
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.error?.message || `API error ${res.status}`);
    }
    const data = await res.json();
    // gpt-image-1 returns b64_json by default
    if (data.data[0].b64_json) {
        return 'data:image/png;base64,' + data.data[0].b64_json;
    }
    // Fallback: fetch the URL and convert
    const imgRes = await fetch(data.data[0].url);
    const blob = await imgRes.blob();
    return await blobToDataURL(blob);
}

function blobToDataURL(blob) {
    return new Promise((resolve) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.readAsDataURL(blob);
    });
}

// ============================================================
// UPLOAD CUSTOM IMAGE
// ============================================================
function uploadCustom() {
    document.getElementById('file-upload').click();
}

async function handleUpload(event) {
    const file = event.target.files[0];
    if (!file) return;
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;

    const dataUrl = await blobToDataURL(file);
    assets[item.id] = { imageData: dataUrl, prompt: document.getElementById('modal-prompt').value || 'custom upload', generatedAt: Date.now() };
    await store.save(item.id, assets[item.id]);

    openItemModal(item.id);
    renderGrid();
    renderSidebar();
    updateProgress();
    showToast(`Uploaded ${item.name}`, 'success');
    event.target.value = '';
}

// ============================================================
// CLEAR ASSET
// ============================================================
async function clearAsset() {
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item) return;
    delete assets[item.id];
    await store.delete(item.id);
    openItemModal(item.id);
    renderGrid();
    renderSidebar();
    updateProgress();
    showToast(`Removed ${item.name}`, 'success');
}

// ============================================================
// DOWNLOAD / EXPORT
// ============================================================
function downloadSingle() {
    const item = ITEMS.find(i => i.id === selectedItemId);
    if (!item || !assets[item.id]) return;
    const a = document.createElement('a');
    a.href = assets[item.id].imageData;
    a.download = `${item.id}.png`;
    a.click();
}

async function exportAll() {
    const assetEntries = ITEMS.filter(i => assets[i.id]);
    if (assetEntries.length === 0) {
        showToast('No assets to export', 'error');
        return;
    }

    showToast('Building ZIP...', 'success');

    const zip = new JSZip();
    const itemsFolder = zip.folder('items');

    // Manifest
    const manifest = {};
    for (const item of assetEntries) {
        const asset = assets[item.id];
        const b64 = asset.imageData.split(',')[1];
        itemsFolder.file(`${item.id}.png`, b64, { base64: true });
        manifest[item.id] = {
            name: item.name,
            file: `items/${item.id}.png`,
            type: item.type,
            category: item.category,
            tier: item.tier || null,
            generatedAt: asset.generatedAt,
        };
    }
    zip.file('manifest.json', JSON.stringify(manifest, null, 2));

    const blob = await zip.generateAsync({ type: 'blob' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `agentscape-assets-${Date.now()}.zip`;
    a.click();
    URL.revokeObjectURL(a.href);
    showToast(`Exported ${assetEntries.length} assets`, 'success');
}

// ============================================================
// CATEGORY SELECTION
// ============================================================
function selectCategory(catId) {
    selectedCategory = catId;
    renderSidebar();
    renderGrid();
}

// ============================================================
// TOAST
// ============================================================
function showToast(msg, type) {
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.className = 'toast ' + (type || '');
    el.style.display = 'block';
    clearTimeout(el._timer);
    el._timer = setTimeout(() => { el.style.display = 'none'; }, 3000);
}

// ============================================================
// KEYBOARD SHORTCUTS
// ============================================================
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (document.getElementById('settings-modal').classList.contains('open')) closeSettings();
        else if (document.getElementById('item-modal').classList.contains('open')) closeItemModal();
    }
    if (document.getElementById('item-modal').classList.contains('open')) {
        if (e.key === 'ArrowLeft') navItem(-1);
        if (e.key === 'ArrowRight') navItem(1);
    }
});

// Click outside modal to close
document.getElementById('item-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeItemModal();
});
document.getElementById('settings-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) closeSettings();
});

// ============================================================
// INIT
// ============================================================
async function init() {
    await store.init();
    const allAssets = await store.getAll();
    for (const a of allAssets) { assets[a.id] = a; }
    renderSidebar();
    renderGrid();
    updateProgress();
}

init();
</script>
</body>
</html>
