<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentScape | Multiplayer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { overflow: hidden; background: #000; font-family: 'Courier New', monospace; }
        #game-frame { display: grid; grid-template-columns: 1fr 220px; grid-template-rows: 1fr 160px; width: 100vw; height: 100vh; }
        #game-viewport { position: relative; overflow: hidden; background: #000; grid-row: 1; grid-column: 1; }
        #game-viewport canvas { display: block; width: 100%; height: 100%; }
        #npc-labels, #chat-bubbles { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }
        #game-sidebar { grid-row: 1 / 3; grid-column: 2; background: linear-gradient(180deg, #2a2a2e 0%, #1a1a1f 100%); border-left: 2px solid #4a4a50; display: flex; flex-direction: column; overflow: hidden; }
        #minimap-wrap { padding: 8px; text-align: center; border-bottom: 2px solid #4a4a50; background: #1a1a1f; }
        #minimap { border: 2px solid #5a5a60; border-radius: 2px; display: block; margin: 0 auto; }
        #orbs-row { display: flex; justify-content: center; gap: 16px; padding: 8px 0; border-bottom: 2px solid #4a4a50; background: #222226; }
        .orb { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #5a5a60; position: relative; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #fff; text-shadow: 0 0 3px #000; }
        .orb-hp { background: conic-gradient(#22c55e var(--hp-pct, 100%), #333 0); }
        .orb-energy { background: conic-gradient(#eab308 var(--energy-pct, 100%), #333 0); }
        .orb-combat { background: conic-gradient(#6366f1 100%, #333 0); }
        .orb-inner { width: 28px; height: 28px; border-radius: 50%; background: #1a1a1f; display: flex; align-items: center; justify-content: center; font-size: 11px; }
        #sidebar-tabs { display: flex; border-bottom: 2px solid #4a4a50; }
        .sidebar-tab { flex: 1; padding: 6px 2px; text-align: center; font-size: 10px; font-weight: bold; color: #9ca3af; background: #2a2a2e; border: none; cursor: pointer; border-right: 1px solid #4a4a50; border-top: 2px solid transparent; text-transform: uppercase; letter-spacing: 0.5px; }
        .sidebar-tab:last-child { border-right: none; }
        .sidebar-tab.active { background: #1a1a1f; color: #fff; border-top-color: #6366f1; }
        .sidebar-tab:hover { color: #fff; }
        .sidebar-content { flex: 1; overflow-y: auto; display: none; }
        .sidebar-content.active { display: block; }
        .sidebar-content::-webkit-scrollbar { width: 4px; }
        .sidebar-content::-webkit-scrollbar-thumb { background: #4a4a50; }
        #inv-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 2px; padding: 4px; }
        .inv-slot { aspect-ratio: 1; background: #1a1a1f; border: 1px solid #3a3a40; display: flex; align-items: center; justify-content: center; font-size: 20px; position: relative; cursor: pointer; border-radius: 2px; }
        .inv-slot:hover { border-color: #6366f1; background: #222230; }
        .inv-slot.equipped { border-color: #22c55e; box-shadow: inset 0 0 6px rgba(34,197,94,0.3); }
        .inv-slot-qty { position: absolute; bottom: 1px; right: 3px; font-size: 9px; color: #eab308; font-weight: bold; text-shadow: 0 0 2px #000; }
        #stats-content { padding: 8px; }
        .stat-skill { display: flex; align-items: center; gap: 6px; padding: 4px 6px; border-bottom: 1px solid #2a2a2e; }
        .stat-skill-icon { font-size: 16px; width: 22px; text-align: center; }
        .stat-skill-name { font-size: 11px; color: #9ca3af; flex: 1; }
        .stat-skill-lvl { font-size: 13px; color: #fff; font-weight: bold; width: 26px; text-align: center; }
        .stat-xp-bar { width: 100%; height: 4px; background: #2a2a2e; border-radius: 2px; margin-top: 2px; }
        .stat-xp-fill { height: 100%; background: #6366f1; border-radius: 2px; transition: width 0.3s; }
        .stat-player-info { padding: 8px; text-align: center; border-bottom: 2px solid #4a4a50; }
        .stat-player-name { font-size: 13px; color: #fff; font-weight: bold; }
        .stat-combat-lvl { font-size: 11px; color: #eab308; }
        #game-bottom { grid-row: 2; grid-column: 1; background: linear-gradient(0deg, #1a1a1f, #222226); border-top: 2px solid #4a4a50; display: flex; }
        #chat-area { flex: 1; display: flex; flex-direction: column; border-right: 2px solid #4a4a50; }
        #chat-tabs { display: flex; border-bottom: 1px solid #3a3a40; flex-shrink: 0; }
        .chat-tab { padding: 4px 10px; font-size: 10px; font-weight: bold; color: #6b7280; background: none; border: none; cursor: pointer; border-bottom: 2px solid transparent; }
        .chat-tab.active { color: #fff; border-bottom-color: #6366f1; }
        .chat-tab:hover { color: #ccc; }
        #chat-messages { flex: 1; overflow-y: auto; padding: 4px 8px; font-size: 11px; line-height: 1.5; color: #ccc; }
        #chat-messages::-webkit-scrollbar { width: 4px; }
        #chat-messages::-webkit-scrollbar-thumb { background: #4a4a50; }
        .chat-msg-system { color: #6366f1; }
        .chat-msg-combat { color: #ef4444; }
        .chat-msg-public { color: #eab308; }
        .chat-msg-agent { color: #22c55e; }
        #chat-input-area { display: flex; padding: 4px; gap: 4px; flex-shrink: 0; }
        #chat-input { flex: 1; background: #1a1a1f; border: 1px solid #3a3a40; color: #fff; padding: 4px 8px; font-size: 11px; font-family: inherit; border-radius: 2px; outline: none; }
        #chat-input:focus { border-color: #6366f1; }
        #action-area { width: 180px; padding: 8px; display: flex; flex-direction: column; gap: 4px; justify-content: center; }
        .action-btn { padding: 6px; font-size: 10px; font-weight: bold; background: #2a2a2e; color: #ccc; border: 1px solid #4a4a50; cursor: pointer; text-align: center; border-radius: 2px; text-transform: uppercase; letter-spacing: 0.5px; }
        .action-btn:hover { background: #3a3a3e; color: #fff; border-color: #6366f1; }
        .action-btn.active { background: #6366f122; color: #6366f1; border-color: #6366f1; }
        .npc-label { position: absolute; z-index: 15; pointer-events: none; font-family: 'Courier New', monospace; font-size: 10px; font-weight: bold; color: #fff; text-shadow: 0 0 4px rgba(0,0,0,0.9), 0 1px 2px rgba(0,0,0,0.8); white-space: nowrap; transform: translate(-50%, -100%); padding: 1px 6px; border-radius: 3px; background: rgba(0,0,0,0.5); }
        .chat-bubble { position: absolute; z-index: 16; pointer-events: none; font-family: 'Courier New', monospace; font-size: 11px; font-weight: bold; color: #ffff00; text-shadow: 0 0 4px rgba(0,0,0,0.9); white-space: nowrap; transform: translate(-50%, -100%); padding: 2px 8px; border-radius: 4px; background: rgba(0,0,0,0.6); animation: bubbleFade 5s forwards; }
        @keyframes bubbleFade { 0%, 70% { opacity: 1; transform: translate(-50%, -100%); } 100% { opacity: 0; transform: translate(-50%, -120%); } }
        #context-menu { position: fixed; z-index: 100; display: none; background: #1a1a1f; border: 1px solid #4a4a50; min-width: 140px; font-size: 12px; box-shadow: 2px 2px 8px rgba(0,0,0,0.5); }
        .ctx-option { padding: 5px 12px; color: #ccc; cursor: pointer; border-bottom: 1px solid #2a2a2e; }
        .ctx-option:hover { background: #2a2a3e; color: #fff; }
        .ctx-option:last-child { border-bottom: none; }
        .ctx-header { padding: 4px 12px; color: #6366f1; font-weight: bold; font-size: 11px; border-bottom: 1px solid #4a4a50; }
        .health-bar-wrap { position: absolute; z-index: 14; pointer-events: none; transform: translate(-50%, 0); width: 40px; }
        .health-bar { width: 100%; height: 5px; background: #333; border: 1px solid #000; }
        .health-bar-fill { height: 100%; background: #22c55e; transition: width 0.2s; }
        .hitsplat { position: absolute; z-index: 17; pointer-events: none; transform: translate(-50%, -50%); width: 24px; height: 24px; border-radius: 50%; background: #cc0000; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; color: #fff; text-shadow: 0 0 2px #000; animation: hitsplatAnim 1s forwards; }
        .hitsplat.miss { background: #4444ff; }
        .hitsplat.spec { background: #eab308; width: 30px; height: 30px; font-size: 13px; }
        @keyframes hitsplatAnim { 0% { opacity: 1; transform: translate(-50%, -50%); } 100% { opacity: 0; transform: translate(-50%, -100%); } }
        #death-screen { position: absolute; inset: 0; z-index: 50; background: rgba(139,0,0,0.7); display: none; align-items: center; justify-content: center; flex-direction: column; gap: 12px; }
        #death-screen h1 { color: #fff; font-size: 24px; }
        #death-screen p { color: #ccc; font-size: 14px; }
        .loot-label { position: absolute; z-index: 14; pointer-events: none; font-size: 10px; color: #eab308; font-weight: bold; text-shadow: 0 0 3px #000; transform: translate(-50%, 0); animation: lootPulse 1s infinite; }
        @keyframes lootPulse { 50% { transform: translate(-50%, -3px); } }
        .game-overlay { position: absolute; inset: 0; z-index: 40; background: rgba(0,0,0,0.75); display: none; align-items: center; justify-content: center; }
        .game-overlay.open { display: flex; }
        .overlay-panel { background: linear-gradient(180deg, #2a2a2e, #1a1a1f); border: 2px solid #4a4a50; border-radius: 4px; width: 520px; max-height: 80vh; overflow-y: auto; box-shadow: 0 8px 32px rgba(0,0,0,0.5); }
        .overlay-header { display: flex; justify-content: space-between; align-items: center; padding: 10px 14px; border-bottom: 2px solid #4a4a50; background: #222226; }
        .overlay-header h2 { font-size: 14px; color: #fff; margin: 0; }
        .overlay-close { background: none; border: none; color: #9ca3af; font-size: 18px; cursor: pointer; padding: 0 4px; }
        .overlay-close:hover { color: #fff; }
        .overlay-body { padding: 10px; }
        .quest-item { padding: 8px 10px; border-bottom: 1px solid #2a2a2e; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .quest-item:hover { background: #2a2a3e; }
        .quest-item.completed { opacity: 0.5; }
        .quest-difficulty { font-size: 9px; padding: 2px 6px; border-radius: 2px; font-weight: bold; text-transform: uppercase; }
        .quest-difficulty.easy { background: #22c55e33; color: #22c55e; }
        .quest-difficulty.medium { background: #eab30833; color: #eab308; }
        .quest-difficulty.hard { background: #ef444433; color: #ef4444; }
        .quest-name { flex: 1; font-size: 12px; color: #ccc; }
        .quest-status-icon { font-size: 14px; }
        .quest-detail { padding: 10px; }
        .quest-detail-desc { font-size: 11px; color: #9ca3af; margin-bottom: 8px; }
        .quest-detail-rewards { font-size: 11px; color: #eab308; margin-top: 6px; }
        .quest-accept-btn { margin-top: 8px; padding: 6px 16px; background: #6366f1; color: #fff; border: none; font-size: 11px; font-weight: bold; cursor: pointer; border-radius: 2px; font-family: inherit; }
        .quest-accept-btn:hover { background: #818cf8; }
        .quest-progress-bar { width: 100%; height: 4px; background: #2a2a2e; border-radius: 2px; margin-top: 3px; }
        .quest-progress-fill { height: 100%; background: #22c55e; border-radius: 2px; transition: width 0.3s; }
        .sidebar-quest { padding: 6px 8px; border-bottom: 1px solid #2a2a2e; cursor: pointer; }
        .sidebar-quest:hover { background: #2a2a3e; }
        .sidebar-quest-name { font-size: 11px; color: #ccc; font-weight: bold; }
        .sidebar-quest-progress { font-size: 9px; color: #9ca3af; }
        .sidebar-quest.done .sidebar-quest-name { color: #6b7280; text-decoration: line-through; }
        .shop-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1px; }
        .shop-panel { flex: 1; min-width: 0; }
        .shop-panel h3 { font-size: 11px; color: #9ca3af; padding: 6px 8px; margin: 0; border-bottom: 1px solid #2a2a2e; text-transform: uppercase; }
        .shop-item { display: flex; align-items: center; gap: 8px; padding: 6px 8px; border-bottom: 1px solid #2a2a2e; cursor: pointer; font-size: 11px; color: #ccc; }
        .shop-item:hover { background: #2a2a3e; }
        .shop-item-icon { font-size: 18px; width: 26px; text-align: center; }
        .shop-item-name { flex: 1; }
        .shop-item-price { color: #eab308; font-weight: bold; }
        .shop-item-stock { color: #6b7280; font-size: 9px; }
        .shop-coins { padding: 8px; text-align: center; font-size: 12px; color: #eab308; font-weight: bold; border-bottom: 1px solid #4a4a50; }
        .shop-buy-btn { padding: 3px 8px; font-size: 9px; font-weight: bold; background: #2a2a2e; color: #ccc; border: 1px solid #4a4a50; cursor: pointer; border-radius: 2px; font-family: inherit; }
        .shop-buy-btn:hover { background: #3a3a3e; border-color: #6366f1; color: #fff; }
        .skill-timer { width: 100%; height: 6px; background: #2a2a2e; border-radius: 3px; margin-top: 4px; }
        .skill-timer-fill { height: 100%; background: #22c55e; border-radius: 3px; transition: width 0.1s linear; }
        .loot-pile-dot { position: absolute; width: 8px; height: 8px; border-radius: 50%; background: #eab308; z-index: 13; cursor: pointer; pointer-events: auto; box-shadow: 0 0 6px #eab308; animation: lootPulse 1s infinite; }
        #conn-status { position: absolute; bottom: 4px; left: 4px; z-index: 20; font-size: 10px; padding: 2px 8px; border-radius: 3px; background: rgba(0,0,0,0.6); }
        #conn-status.connected { color: #22c55e; }
        #conn-status.connecting { color: #eab308; }
        #conn-status.disconnected { color: #ef4444; }
    </style>
</head>
<body>
    <div id="game-frame">
        <div id="game-viewport">
            <div id="npc-labels"></div>
            <div id="chat-bubbles"></div>
            <div id="conn-status" class="connecting">Connecting...</div>
            <div id="death-screen"><h1>Oh dear, you are dead!</h1><p>Respawning at Town Hall...</p></div>
            <div class="game-overlay" id="quest-overlay"><div class="overlay-panel"><div class="overlay-header"><h2>üìã Quest Board</h2><button class="overlay-close" onclick="closeOverlay('quest-overlay')">&times;</button></div><div class="overlay-body" id="quest-board-content"></div></div></div>
            <div class="game-overlay" id="shop-overlay"><div class="overlay-panel" style="width:600px;"><div class="overlay-header"><h2>üè™ Marketplace</h2><button class="overlay-close" onclick="closeOverlay('shop-overlay')">&times;</button></div><div class="shop-coins" id="shop-coins-display">ü™ô 0 Coins</div><div class="overlay-body" style="display:flex;gap:2px;" id="shop-body-content"></div></div></div>
            <div class="game-overlay" id="craft-overlay"><div class="overlay-panel"><div class="overlay-header"><h2>üî® Workshop ‚Äî Crafting</h2><button class="overlay-close" onclick="closeOverlay('craft-overlay')">&times;</button></div><div class="overlay-body" id="craft-content"></div></div></div>
        </div>
        <div id="game-sidebar">
            <div id="minimap-wrap"><canvas id="minimap" width="200" height="200"></canvas></div>
            <div id="orbs-row">
                <div class="orb orb-hp" id="orbHp"><div class="orb-inner" id="orbHpText">100</div></div>
                <div class="orb orb-combat" id="orbCombat"><div class="orb-inner" id="orbCombatText">3</div></div>
                <div class="orb orb-energy" id="orbEnergy"><div class="orb-inner" id="orbEnergyText">100</div></div>
            </div>
            <div id="sidebar-tabs">
                <button class="sidebar-tab active" onclick="switchSidebarTab('inv')">Inv</button>
                <button class="sidebar-tab" onclick="switchSidebarTab('stats')">Stats</button>
                <button class="sidebar-tab" onclick="switchSidebarTab('quests')">Quest</button>
            </div>
            <div class="sidebar-content active" id="tab-inv"><div id="inv-grid"></div></div>
            <div class="sidebar-content" id="tab-stats">
                <div class="stat-player-info"><div class="stat-player-name">Player</div><div class="stat-combat-lvl">Combat Level: <span id="statCombatLvl">3</span></div></div>
                <div id="stats-content"></div>
            </div>
            <div class="sidebar-content" id="tab-quests"><div style="padding:8px;color:#9ca3af;font-size:11px;text-align:center;"><p style="font-size:14px;margin-bottom:8px;">üìã Quests</p><p>Visit the Quest Board in town to see available bounties.</p></div></div>
        </div>
        <div id="game-bottom">
            <div id="chat-area">
                <div id="chat-tabs">
                    <button class="chat-tab active" onclick="switchChatTab('all')">All</button>
                    <button class="chat-tab" onclick="switchChatTab('public')">Public</button>
                    <button class="chat-tab" onclick="switchChatTab('agent')">Agent</button>
                    <button class="chat-tab" onclick="switchChatTab('system')">System</button>
                </div>
                <div id="chat-messages"></div>
                <div id="chat-input-area"><input id="chat-input" type="text" placeholder="Press Enter to chat..." maxlength="80"></div>
            </div>
            <div id="action-area">
                <button class="action-btn" id="btnAttackMode" onclick="toggleAttackMode()">Attack Mode</button>
                <button class="action-btn" id="btnSpec" onclick="sendSpec()">Spec (F)</button>
                <button class="action-btn" onclick="toggleDayNight()">Day/Night</button>
                <div id="skill-action-area"></div>
                <div style="font-size:9px;color:#6b7280;text-align:center;padding:4px;">WASD Move | Q/E Rotate<br>Scroll Zoom | F Spec</div>
            </div>
        </div>
    </div>
    <div id="context-menu"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
    // Node.js polyfills required by Colyseus.js browser bundle
    if(typeof global==='undefined')window.global=window;
    if(typeof process==='undefined')window.process={env:{},version:'v20.0.0',nextTick:function(fn){setTimeout(fn,0)},browser:true};
    if(typeof Buffer==='undefined'){
        window.Buffer={isBuffer:function(){return false},from:function(d){if(typeof d==='string')return new TextEncoder().encode(d);return new Uint8Array(d||[])},
        alloc:function(n){return new Uint8Array(n)},allocUnsafe:function(n){return new Uint8Array(n)},
        concat:function(l){var t=l.reduce(function(a,b){return a+b.length},0),r=new Uint8Array(t),o=0;l.forEach(function(b){r.set(b,o);o+=b.length});return r},
        byteLength:function(s){return new TextEncoder().encode(s).length}};
    }
    </script>
    <script src="https://unpkg.com/colyseus.js@0.15.24/dist/colyseus.js"></script>
    <script>
    (function() {
        // ============================================================
        // CONFIG
        // ============================================================
        const WS_URL = window.location.hostname === 'localhost' ? 'ws://localhost:2567' : 'wss://suitegpt-production.up.railway.app';
        const MAP_SIZE = 30, TILE_SIZE = 1, WATER_LEVEL = -0.15, MOVE_SPEED = 4, NPC_MOVE_SPEED = 2.5;
        const playerName = 'Player' + Math.floor(Math.random() * 9999);
        const playerColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6,'0');
        let room = null, mySessionId = null, attackMode = false;

        const ROLE_COLORS = {
            app_builder: { hex: '#6366f1', int: 0x6366f1, name: 'Builder' },
            app_refiner: { hex: '#f97316', int: 0xf97316, name: 'Refiner' },
            content_creator: { hex: '#22c55e', int: 0x22c55e, name: 'Creator' },
            growth_outreach: { hex: '#ec4899', int: 0xec4899, name: 'Growth' },
            qa_tester: { hex: '#eab308', int: 0xeab308, name: 'Tester' },
        };
        const ITEMS = {
            coins:{id:'coins',name:'Coins',icon:'\u{1FA99}',stackable:true,type:'coin'},
            bronze_sword:{id:'bronze_sword',name:'Bronze Sword',icon:'\u{1F5E1}\uFE0F',stackable:false,type:'weapon',stats:{attack:4,strength:3}},
            iron_sword:{id:'iron_sword',name:'Iron Sword',icon:'\u2694\uFE0F',stackable:false,type:'weapon',stats:{attack:8,strength:6}},
            steel_sword:{id:'steel_sword',name:'Steel Sword',icon:'\u2694\uFE0F',stackable:false,type:'weapon',stats:{attack:12,strength:10}},
            bread:{id:'bread',name:'Bread',icon:'\u{1F35E}',stackable:false,type:'food',healAmount:10},
            cooked_meat:{id:'cooked_meat',name:'Cooked Meat',icon:'\u{1F356}',stackable:false,type:'food',healAmount:20},
            cooked_fish:{id:'cooked_fish',name:'Cooked Fish',icon:'\u{1F420}',stackable:false,type:'food',healAmount:15},
            raw_fish:{id:'raw_fish',name:'Raw Fish',icon:'\u{1F41F}',stackable:true,type:'material'},
            logs:{id:'logs',name:'Logs',icon:'\u{1FAB5}',stackable:true,type:'material'},
            code_fragment:{id:'code_fragment',name:'Code Fragment',icon:'\u{1F48E}',stackable:true,type:'material'},
            agent_core:{id:'agent_core',name:'Agent Core',icon:'\u{1F52E}',stackable:false,type:'misc'},
            bronze_helm:{id:'bronze_helm',name:'Bronze Helm',icon:'\u{1FA96}',stackable:false,type:'helm',stats:{defence:3}},
            iron_helm:{id:'iron_helm',name:'Iron Helm',icon:'\u{1FA96}',stackable:false,type:'helm',stats:{defence:6}},
            steel_helm:{id:'steel_helm',name:'Steel Helm',icon:'\u26D1\uFE0F',stackable:false,type:'helm',stats:{defence:10}},
            bronze_shield:{id:'bronze_shield',name:'Bronze Shield',icon:'\u{1F6E1}\uFE0F',stackable:false,type:'shield',stats:{defence:4}},
            iron_shield:{id:'iron_shield',name:'Iron Shield',icon:'\u{1F6E1}\uFE0F',stackable:false,type:'shield',stats:{defence:8}},
        };
        const BUILDINGS = [
            {id:'quest_board',name:'Quest Board',icon:'\u{1F4CB}',x:15,z:13,w:1,d:1,h:1.2,wallColor:0x8B7355,roofColor:0x6366f1,signColor:'#6366f1',doorSide:'south',type:'pedestal'},
            {id:'workshop',name:'Workshop',icon:'\u{1F528}',x:20,z:10,w:3,d:2,h:1.5,wallColor:0xD2B48C,roofColor:0x6366f1,signColor:'#6366f1',doorSide:'south'},
            {id:'marketplace',name:'Marketplace',icon:'\u{1F3EA}',x:10,z:12,w:2.5,d:2,h:1.3,wallColor:0xBDB76B,roofColor:0xf97316,signColor:'#f97316',doorSide:'south'},
            {id:'farm',name:'Farm',icon:'\u{1F33E}',x:24,z:16,w:2,d:3,h:1.0,wallColor:0x8FBC8F,roofColor:0x22c55e,signColor:'#22c55e',doorSide:'west'},
            {id:'arena',name:'Arena',icon:'\u2694\uFE0F',x:12,z:26,w:3,d:3,h:1.6,wallColor:0xCD853F,roofColor:0xef4444,signColor:'#ef4444',doorSide:'north'},
            {id:'town_hall',name:'Town Hall',icon:'\u{1F3DB}\uFE0F',x:18,z:6,w:2.5,d:2,h:1.8,wallColor:0xE8DCC8,roofColor:0x8b5cf6,signColor:'#8b5cf6',doorSide:'south'},
        ];
        const SHOP_ITEMS = [
            {id:'bread',price:10,stock:99},{id:'cooked_meat',price:25,stock:50},{id:'cooked_fish',price:20,stock:50},
            {id:'bronze_sword',price:50,stock:10},{id:'iron_sword',price:150,stock:5},{id:'steel_sword',price:400,stock:3},
            {id:'bronze_helm',price:30,stock:10},{id:'iron_helm',price:100,stock:5},
            {id:'bronze_shield',price:40,stock:10},{id:'iron_shield',price:120,stock:5},
        ];
        const RECIPES = [
            {result:'bronze_shield',resultQty:1,ingredients:[{id:'logs',qty:3}],coinCost:5},
            {result:'iron_sword',resultQty:1,ingredients:[{id:'code_fragment',qty:5}],coinCost:10},
            {result:'steel_sword',resultQty:1,ingredients:[{id:'agent_core',qty:2}],coinCost:20},
        ];
        const QUESTS = {
            first_blood:{id:'first_blood',name:'First Blood',difficulty:'easy',description:'Defeat any agent in combat.',rewards:{coins:50,xp:{attack:20,strength:20}}},
            pest_control:{id:'pest_control',name:'Pest Control',difficulty:'medium',description:'Defeat 3 QA Testers.',rewards:{coins:150,xp:{attack:50,strength:50,defence:30},items:[{id:'iron_sword',qty:1}]},prereqs:['first_blood']},
            code_collector:{id:'code_collector',name:'Code Collector',difficulty:'medium',description:'Gather 5 Code Fragments.',rewards:{coins:200,xp:{hitpoints:40}}},
            world_tour:{id:'world_tour',name:'World Tour',difficulty:'easy',description:'Visit all 6 buildings.',rewards:{coins:100,xp:{hitpoints:30}}},
            arena_champion:{id:'arena_champion',name:'Arena Champion',difficulty:'hard',description:'Defeat 5 agents in the Arena.',rewards:{coins:300,xp:{attack:80,strength:80,defence:60},items:[{id:'steel_sword',qty:1}]},prereqs:['pest_control']},
            bread_run:{id:'bread_run',name:'Bread Run',difficulty:'easy',description:'Deliver 3 Bread to the Farm.',rewards:{coins:75,xp:{hitpoints:20}}},
            core_hunter:{id:'core_hunter',name:'Core Hunter',difficulty:'hard',description:'Collect 3 Agent Cores.',rewards:{coins:500,xp:{attack:100,strength:100},items:[{id:'steel_helm',qty:1}]},prereqs:['first_blood']},
            full_clear:{id:'full_clear',name:'Full Clear',difficulty:'hard',description:'Defeat one agent of every role.',rewards:{coins:400,xp:{attack:60,strength:60,defence:60,hitpoints:60}},prereqs:['first_blood']},
        };
        const NPC_COMBAT_STATS = {
            app_builder:{hp:60,attack:5,strength:4,defence:3},
            app_refiner:{hp:50,attack:4,strength:3,defence:5},
            content_creator:{hp:40,attack:3,strength:3,defence:2},
            growth_outreach:{hp:45,attack:4,strength:4,defence:3},
            qa_tester:{hp:70,attack:6,strength:5,defence:4},
        };

        function xpForLevel(l){return Math.floor(Math.pow(l,2.5));}

        // ============================================================
        // CHAT
        // ============================================================
        const chatHistory = [];
        let chatFilter = 'all', chatInputFocused = false;
        function addChat(type, text, sender, color) {
            chatHistory.push({type,text,sender,color,time:Date.now()});
            if (chatHistory.length > 100) chatHistory.shift();
            renderChat();
        }
        function renderChat() {
            const el = document.getElementById('chat-messages');
            const filtered = chatFilter==='all' ? chatHistory : chatHistory.filter(m=>m.type===chatFilter);
            el.innerHTML = filtered.slice(-50).map(m => {
                const cls='chat-msg-'+m.type;
                const pfx = m.sender ? `<span style="color:${m.color||'#fff'};font-weight:bold">${m.sender}:</span> ` : '';
                return `<div class="${cls}">${pfx}${m.text}</div>`;
            }).join('');
            el.scrollTop = el.scrollHeight;
        }
        window.switchChatTab = function(tab) { chatFilter=tab; document.querySelectorAll('.chat-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase()===tab)); renderChat(); };
        window.switchSidebarTab = function(tab) {
            document.querySelectorAll('.sidebar-tab').forEach(t=>t.classList.toggle('active',t.textContent.toLowerCase().startsWith(tab)));
            document.querySelectorAll('.sidebar-content').forEach(c=>c.classList.remove('active'));
            document.getElementById('tab-'+tab).classList.add('active');
        };
        window.closeOverlay = function(id) { document.getElementById(id).classList.remove('open'); };

        const chatInput = document.getElementById('chat-input');
        chatInput.addEventListener('focus',()=>{chatInputFocused=true;});
        chatInput.addEventListener('blur',()=>{chatInputFocused=false;});
        chatInput.addEventListener('keydown',(e)=>{
            if(e.key==='Enter'&&chatInput.value.trim()){
                sendAction('chat',{message:chatInput.value.trim()});
                chatInput.value=''; chatInput.blur();
            }
            if(e.key==='Escape') chatInput.blur();
            e.stopPropagation();
        });

        // ============================================================
        // THREE.JS SCENE
        // ============================================================
        const viewport = document.getElementById('game-viewport');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x87CEEB);
        scene.fog = new THREE.FogExp2(0x87CEEB, 0.025);
        const camera = new THREE.PerspectiveCamera(45, viewport.clientWidth/viewport.clientHeight, 0.1, 100);
        const renderer = new THREE.WebGLRenderer({antialias:true});
        renderer.setSize(viewport.clientWidth, viewport.clientHeight);
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap;
        viewport.insertBefore(renderer.domElement, viewport.firstChild);

        let camTargetX=15,camTargetZ=15,camAngle=Math.PI/4,camDist=18,camHeight=14;
        function updateCamera(){camera.position.set(camTargetX+Math.sin(camAngle)*camDist,camHeight,camTargetZ+Math.cos(camAngle)*camDist);camera.lookAt(camTargetX,0,camTargetZ);}
        updateCamera();

        const ambientLight=new THREE.AmbientLight(0x6688aa,0.5);scene.add(ambientLight);
        const sunLight=new THREE.DirectionalLight(0xffeedd,0.9);sunLight.position.set(10,20,10);sunLight.castShadow=true;sunLight.shadow.mapSize.set(2048,2048);sunLight.shadow.camera.near=0.5;sunLight.shadow.camera.far=60;sunLight.shadow.camera.left=-20;sunLight.shadow.camera.right=20;sunLight.shadow.camera.top=20;sunLight.shadow.camera.bottom=-20;scene.add(sunLight);
        const hemiLight=new THREE.HemisphereLight(0x88aacc,0x445522,0.3);scene.add(hemiLight);

        let isNight=false;
        window.toggleDayNight=function(){isNight=!isNight;if(isNight){scene.background.set(0x0a0a1a);scene.fog.color.set(0x0a0a1a);ambientLight.intensity=0.15;sunLight.intensity=0.1;sunLight.color.set(0x4466aa);hemiLight.intensity=0.05;}else{scene.background.set(0x87CEEB);scene.fog.color.set(0x87CEEB);ambientLight.intensity=0.5;sunLight.intensity=0.9;sunLight.color.set(0xffeedd);hemiLight.intensity=0.3;}};

        // ============================================================
        // TERRAIN (deterministic, same as server seed=42)
        // ============================================================
        const grid=[],heightMap=[];
        function seededRandom(seed){let s=seed;return function(){s=(s*16807+0)%2147483647;return(s-1)/2147483646;};}
        const rng=seededRandom(42);
        function simpleNoise(x,z){return Math.sin(x*0.3)*Math.cos(z*0.4)*0.3+Math.sin(x*0.7+1)*Math.cos(z*0.5+2)*0.15;}
        function isWater(x,z){if(Math.sqrt((x-6)**2+(z-6)**2)<3.5)return true;const rz=20+Math.sin(x*0.4)*2;if(Math.abs(z-rz)<1.5&&x>5&&x<28)return true;return false;}
        function isBridge(x,z){const rz=20+Math.sin(x*0.4)*2;return Math.abs(z-rz)<1.5&&x>=14&&x<=16;}
        function isInBuildingZone(x,z){for(const b of BUILDINGS){const hw=b.w/2,hd=b.d/2;if(x>=b.x-hw-0.5&&x<=b.x+hw+0.5&&z>=b.z-hd-0.5&&z<=b.z+hd+0.5)return true;}return false;}

        for(let x=0;x<MAP_SIZE;x++){grid[x]=[];heightMap[x]=[];for(let z=0;z<MAP_SIZE;z++){const w=isWater(x,z),br=isBridge(x,z);if(br){grid[x][z]=3;heightMap[x][z]=0.05;}else if(w){grid[x][z]=0;heightMap[x][z]=WATER_LEVEL;}else{grid[x][z]=1;heightMap[x][z]=simpleNoise(x,z)*0.2;}}}

        // Terrain mesh
        const grassColors=[0x4a7c3f,0x528745,0x5d9248,0x4b8040,0x3f7035],dirtColors=[0x8B7355,0x7a6548,0x6d5b40];
        for(let x=0;x<MAP_SIZE;x++)for(let z=0;z<MAP_SIZE;z++){const h=heightMap[x][z];let color;if(grid[x][z]===3)color=0x8B6914;else if(isWater(x,z))color=0x2288aa;else{let nw=false;for(let dx=-1;dx<=1;dx++)for(let dz=-1;dz<=1;dz++){const nx=x+dx,nz=z+dz;if(nx>=0&&nx<MAP_SIZE&&nz>=0&&nz<MAP_SIZE&&isWater(nx,nz)&&!isBridge(nx,nz))nw=true;}if(nw)color=0xc2b280;else{const pz=15+Math.sin(x*0.3)*1.5;if(Math.abs(z-pz)<0.8&&x>3&&x<27){color=dirtColors[Math.floor(rng()*dirtColors.length)];grid[x][z]=2;}else color=grassColors[Math.floor(rng()*grassColors.length)];}}const geo=new THREE.BoxGeometry(TILE_SIZE,grid[x][z]===3?0.15:0.3,TILE_SIZE);const mat=new THREE.MeshLambertMaterial({color});const tile=new THREE.Mesh(geo,mat);tile.position.set(x,h-0.15,z);tile.receiveShadow=true;tile.userData={tileX:x,tileZ:z,walkable:grid[x][z]>0,type:'tile'};scene.add(tile);}

        // Bridge railings
        for(let x=14;x<=16;x++)for(const s of[-1,1]){const rz2=20+Math.sin(x*0.4)*2,rr=Math.round(rz2+s*1.3);if(rr>=0&&rr<MAP_SIZE){const r=new THREE.Mesh(new THREE.BoxGeometry(0.08,0.4,0.08),new THREE.MeshLambertMaterial({color:0x5a3a1a}));r.position.set(x,0.25,rr);r.castShadow=true;scene.add(r);}}

        // Water
        const waterGeo=new THREE.PlaneGeometry(30,30,30,30);const waterMat=new THREE.MeshLambertMaterial({color:0x2288aa,transparent:true,opacity:0.6});const waterMesh=new THREE.Mesh(waterGeo,waterMat);waterMesh.rotation.x=-Math.PI/2;waterMesh.position.set(14.5,WATER_LEVEL+0.05,14.5);scene.add(waterMesh);

        // Trees
        const treePositions=[];
        for(let i=0;i<40;i++){const x=Math.floor(rng()*MAP_SIZE),z=Math.floor(rng()*MAP_SIZE);if(grid[x][z]>0&&!isWater(x,z)&&!isInBuildingZone(x,z)&&grid[x][z]!==2&&grid[x][z]!==3&&!(Math.abs(x-15)<3&&Math.abs(z-15)<3)){treePositions.push({x,z});grid[x][z]=0;}}
        function createTree(x,z,v){const g=new THREE.Group();const h=heightMap[x][z];const th=0.6+rng()*0.4;const trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.08,0.12,th,5),new THREE.MeshLambertMaterial({color:0x6B4226}));trunk.position.y=th/2;trunk.castShadow=true;g.add(trunk);if(v===0){[0.5,0.4,0.28].forEach((s,i)=>{const c=new THREE.Mesh(new THREE.ConeGeometry(s,0.5,5),new THREE.MeshLambertMaterial({color:[0x2d5a1e,0x3a6e28,0x468032][i]}));c.position.y=th+0.15+i*0.35;c.castShadow=true;g.add(c);});}else if(v===1){const l=new THREE.Mesh(new THREE.DodecahedronGeometry(0.45,0),new THREE.MeshLambertMaterial({color:0x3a8030}));l.position.y=th+0.35;l.castShadow=true;g.add(l);}else{const b2=new THREE.Mesh(new THREE.IcosahedronGeometry(0.35,0),new THREE.MeshLambertMaterial({color:0x2a6a20}));b2.position.y=th+0.2;b2.castShadow=true;g.add(b2);}g.position.set(x,h,z);scene.add(g);}
        treePositions.forEach(p=>createTree(p.x,p.z,Math.floor(rng()*3)));

        // Rocks & Flowers
        for(let i=0;i<15;i++){const x=Math.floor(rng()*MAP_SIZE),z=Math.floor(rng()*MAP_SIZE);if(grid[x][z]>0&&!isWater(x,z)&&!isInBuildingZone(x,z)){const r=new THREE.Mesh(new THREE.DodecahedronGeometry(0.15+rng()*0.15,0),new THREE.MeshLambertMaterial({color:0x888888}));r.position.set(x+rng()*0.3,heightMap[x][z]+0.1,z+rng()*0.3);r.rotation.set(rng(),rng(),rng());r.castShadow=true;scene.add(r);}}
        for(let i=0;i<25;i++){const x=Math.floor(rng()*MAP_SIZE),z=Math.floor(rng()*MAP_SIZE);if(grid[x][z]>0&&!isWater(x,z)&&!isInBuildingZone(x,z)){const fc=[0xff6b9d,0xffd93d,0xff8a5c,0xc084fc,0xfb7185];const f=new THREE.Mesh(new THREE.SphereGeometry(0.06,4,4),new THREE.MeshLambertMaterial({color:fc[Math.floor(rng()*fc.length)]}));f.position.set(x+rng()*0.6-0.3,heightMap[x][z]+0.15,z+rng()*0.6-0.3);scene.add(f);}}

        // Buildings
        const buildingDoors={};
        function createNamedBuilding(bData){const group=new THREE.Group();const baseH=heightMap[Math.min(Math.floor(bData.x),MAP_SIZE-1)][Math.min(Math.floor(bData.z),MAP_SIZE-1)]||0;if(bData.type==='pedestal'){const base=new THREE.Mesh(new THREE.CylinderGeometry(0.4,0.5,0.6,6),new THREE.MeshLambertMaterial({color:bData.wallColor}));base.position.y=0.3;base.castShadow=true;group.add(base);const board=new THREE.Mesh(new THREE.BoxGeometry(0.7,0.5,0.08),new THREE.MeshLambertMaterial({color:0x5a3a1a}));board.position.y=0.85;board.castShadow=true;group.add(board);[0xff4444,0x44ff44,0x4444ff,0xffff44].forEach((c,i)=>{const p=new THREE.Mesh(new THREE.SphereGeometry(0.04,4,4),new THREE.MeshBasicMaterial({color:c}));p.position.set(-0.2+(i%2)*0.4,0.75+Math.floor(i/2)*0.2,0.05);group.add(p);});const cx=Math.floor(bData.x),cz=Math.floor(bData.z);if(cx>=0&&cx<MAP_SIZE&&cz>=0&&cz<MAP_SIZE)grid[cx][cz]=0;buildingDoors[bData.id]={x:cx,z:cz+1};}else{const walls=new THREE.Mesh(new THREE.BoxGeometry(bData.w,bData.h,bData.d),new THREE.MeshLambertMaterial({color:bData.wallColor}));walls.position.y=bData.h/2;walls.castShadow=true;walls.receiveShadow=true;group.add(walls);const roof=new THREE.Mesh(new THREE.ConeGeometry(Math.max(bData.w,bData.d)*0.75,bData.h*0.5,4),new THREE.MeshLambertMaterial({color:bData.roofColor}));roof.position.y=bData.h+bData.h*0.2;roof.rotation.y=Math.PI/4;roof.castShadow=true;group.add(roof);const door=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.5,0.05),new THREE.MeshLambertMaterial({color:0x5a3a1a}));switch(bData.doorSide){case'south':door.position.set(0,0.25,bData.d/2+0.02);break;case'north':door.position.set(0,0.25,-bData.d/2-0.02);break;case'west':door.position.set(-bData.w/2-0.02,0.25,0);door.rotation.y=Math.PI/2;break;case'east':door.position.set(bData.w/2+0.02,0.25,0);door.rotation.y=Math.PI/2;break;}group.add(door);const hw=Math.ceil(bData.w/2),hd=Math.ceil(bData.d/2);for(let bx=Math.floor(bData.x)-hw;bx<=Math.floor(bData.x)+hw;bx++)for(let bz=Math.floor(bData.z)-hd;bz<=Math.floor(bData.z)+hd;bz++)if(bx>=0&&bx<MAP_SIZE&&bz>=0&&bz<MAP_SIZE)grid[bx][bz]=0;let dt;switch(bData.doorSide){case'south':dt={x:Math.floor(bData.x),z:Math.floor(bData.z)+hd+1};break;case'north':dt={x:Math.floor(bData.x),z:Math.floor(bData.z)-hd-1};break;case'west':dt={x:Math.floor(bData.x)-hw-1,z:Math.floor(bData.z)};break;case'east':dt={x:Math.floor(bData.x)+hw+1,z:Math.floor(bData.z)};break;}if(dt&&dt.x>=0&&dt.x<MAP_SIZE&&dt.z>=0&&dt.z<MAP_SIZE){grid[dt.x][dt.z]=1;buildingDoors[bData.id]=dt;}}group.position.set(bData.x,baseH,bData.z);group.traverse(c=>{if(c.isMesh){c.userData.buildingId=bData.id;c.userData.type='building';}});scene.add(group);}
        BUILDINGS.forEach(b=>createNamedBuilding(b));

        // Fireflies
        const particles=[];
        for(let i=0;i<30;i++){const p=new THREE.Mesh(new THREE.SphereGeometry(0.03,4,4),new THREE.MeshBasicMaterial({color:0xffff88}));p.position.set(rng()*MAP_SIZE,0.5+rng()*1.5,rng()*MAP_SIZE);p.userData.speed=0.2+rng()*0.5;p.userData.offset=rng()*Math.PI*2;p.visible=false;scene.add(p);particles.push(p);}

        // Tile highlight
        const highlightMat=new THREE.MeshBasicMaterial({color:0xffff00,transparent:true,opacity:0.3});
        const highlight=new THREE.Mesh(new THREE.BoxGeometry(TILE_SIZE,0.02,TILE_SIZE),highlightMat);highlight.visible=false;scene.add(highlight);

        // ============================================================
        // PLAYER CHARACTER (local visual)
        // ============================================================
        function createCharacterMesh(color){const g=new THREE.Group();const body=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.5,0.2),new THREE.MeshLambertMaterial({color}));body.position.y=0.5;body.castShadow=true;g.add(body);const head=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.25,0.25),new THREE.MeshLambertMaterial({color:0xffcc99}));head.position.y=0.9;head.castShadow=true;g.add(head);const lGeo=new THREE.BoxGeometry(0.1,0.3,0.15),lMat=new THREE.MeshLambertMaterial({color:0x554433});const ll=new THREE.Mesh(lGeo,lMat);ll.position.set(-0.08,0.15,0);g.add(ll);const rl=new THREE.Mesh(lGeo,lMat);rl.position.set(0.08,0.15,0);g.add(rl);const aGeo=new THREE.BoxGeometry(0.08,0.35,0.1),aMat=new THREE.MeshLambertMaterial({color});const la=new THREE.Mesh(aGeo,aMat);la.position.set(-0.22,0.5,0);g.add(la);const ra=new THREE.Mesh(aGeo,aMat);ra.position.set(0.22,0.5,0);g.add(ra);const sh=new THREE.Mesh(new THREE.CircleGeometry(0.2,8),new THREE.MeshBasicMaterial({color:0x000000,transparent:true,opacity:0.2}));sh.rotation.x=-Math.PI/2;sh.position.y=0.02;g.add(sh);return{group:g,body,leftLeg:ll,rightLeg:rl,leftArm:la,rightArm:ra};}

        const myChar = createCharacterMesh(0x3355aa);
        myChar.group.position.set(15,heightMap[15][15],15);
        scene.add(myChar.group);
        let myWorldX=15,myWorldZ=15;

        // Other player meshes
        const otherPlayerMeshes = new Map(); // sessionId -> { mesh, label }
        // NPC meshes
        const npcMeshes = new Map(); // npcId -> { mesh, label }

        function createNPCMesh(npcState){
            const role = npcState.role || 'app_builder';
            const roleInfo = ROLE_COLORS[role] || ROLE_COLORS.app_builder;
            const g = new THREE.Group();
            g.scale.set(0.85,0.85,0.85);
            const body=new THREE.Mesh(new THREE.BoxGeometry(0.3,0.5,0.2),new THREE.MeshLambertMaterial({color:roleInfo.int}));body.position.y=0.5;body.castShadow=true;g.add(body);
            const head=new THREE.Mesh(new THREE.BoxGeometry(0.25,0.25,0.25),new THREE.MeshLambertMaterial({color:0xffcc99}));head.position.y=0.9;head.castShadow=true;g.add(head);
            const lGeo=new THREE.BoxGeometry(0.1,0.3,0.15),lMat=new THREE.MeshLambertMaterial({color:0x444444});
            const ll=new THREE.Mesh(lGeo,lMat);ll.position.set(-0.08,0.15,0);g.add(ll);
            const rl=new THREE.Mesh(lGeo,lMat);rl.position.set(0.08,0.15,0);g.add(rl);
            const aGeo=new THREE.BoxGeometry(0.08,0.35,0.1),aMat=new THREE.MeshLambertMaterial({color:roleInfo.int});
            const la=new THREE.Mesh(aGeo,aMat);la.position.set(-0.22,0.5,0);g.add(la);
            const ra=new THREE.Mesh(aGeo,aMat);ra.position.set(0.22,0.5,0);g.add(ra);
            const sh=new THREE.Mesh(new THREE.CircleGeometry(0.18,8),new THREE.MeshBasicMaterial({color:0,transparent:true,opacity:0.15}));sh.rotation.x=-Math.PI/2;sh.position.y=0.02;g.add(sh);
            g.traverse(c=>{if(c.isMesh){c.userData.npcId=npcState.id;c.userData.type='npc';}});
            const tx=npcState.tileX||0,tz=npcState.tileZ||0;
            g.position.set(npcState.x,heightMap[tx]?heightMap[tx][tz]||0:0,npcState.z);
            g.rotation.y=npcState.rotation||0;
            scene.add(g);
            const label=document.createElement('div');label.className='npc-label';label.textContent=npcState.name;label.style.borderBottom=`2px solid ${roleInfo.hex}`;document.getElementById('npc-labels').appendChild(label);
            return{group:g,body,leftLeg:ll,rightLeg:rl,leftArm:la,rightArm:ra,label};
        }

        // ============================================================
        // COLYSEUS CONNECTION
        // ============================================================
        const connStatus = document.getElementById('conn-status');
        async function connect(){
            try{
                connStatus.textContent='Connecting...';connStatus.className='connecting';
                const client = new Colyseus.Client(WS_URL);
                room = await client.joinOrCreate('agentscape',{name:playerName,color:playerColor});
                mySessionId = room.sessionId;
                connStatus.textContent='Connected';connStatus.className='connected';
                addChat('system','Connected to AgentScape multiplayer!');
                setupRoomListeners();
            }catch(e){
                connStatus.textContent='Disconnected';connStatus.className='disconnected';
                addChat('system','Could not connect to server. Playing offline.');
                console.error('Connection failed:',e);
            }
        }

        function sendAction(type, payload){
            if(room) room.send('action',{type,payload:payload||{}});
        }

        function setupRoomListeners(){
            // Players
            room.state.players.onAdd((player, sessionId)=>{
                if(sessionId===mySessionId){
                    // Own player ‚Äî bind UI
                    document.querySelector('.stat-player-name').textContent=player.name;
                    updateOrbs(player);
                    renderInventoryFromState(player);
                    renderStatsFromState(player);
                    // Listen for changes
                    player.onChange(()=>{
                        updateOrbs(player);
                        renderStatsFromState(player);
                        myWorldX=player.x;myWorldZ=player.z;
                        const tx=player.tileX,tz=player.tileZ;
                        const h=heightMap[tx]?heightMap[tx][tz]||0:0;
                        myChar.group.position.set(player.x,h,player.z);
                        myChar.group.rotation.y=player.rotation;
                        if(player.isDead){document.getElementById('death-screen').style.display='flex';}
                        else{document.getElementById('death-screen').style.display='none';}
                    });
                    player.inventory.onAdd((item,idx)=>{renderInventoryFromState(player);});
                    player.inventory.onChange((item,idx)=>{renderInventoryFromState(player);});
                }else{
                    // Other player
                    const mesh=createCharacterMesh(parseInt(player.color.replace('#',''),16)||0x3355aa);
                    mesh.group.position.set(player.x,0,player.z);
                    scene.add(mesh.group);
                    const label=document.createElement('div');label.className='npc-label';label.textContent=player.name;label.style.borderBottom='2px solid '+player.color;document.getElementById('npc-labels').appendChild(label);
                    otherPlayerMeshes.set(sessionId,{...mesh,label,state:player});
                    player.onChange(()=>{
                        const m=otherPlayerMeshes.get(sessionId);
                        if(m){const tx=player.tileX,tz=player.tileZ;const h=heightMap[tx]?heightMap[tx][tz]||0:0;m.group.position.set(player.x,h,player.z);m.group.rotation.y=player.rotation;m.group.visible=!player.isDead;}
                    });
                }
            });
            room.state.players.onRemove((player, sessionId)=>{
                const m=otherPlayerMeshes.get(sessionId);
                if(m){scene.remove(m.group);m.label.remove();otherPlayerMeshes.delete(sessionId);}
            });

            // NPCs
            room.state.npcs.onAdd((npc, id)=>{
                const mesh=createNPCMesh(npc);
                npcMeshes.set(id,{...mesh,state:npc});
                npc.onChange(()=>{
                    const m=npcMeshes.get(id);
                    if(!m)return;
                    const tx=npc.tileX,tz=npc.tileZ;
                    const h=heightMap[tx]?heightMap[tx][tz]||0:0;
                    m.group.position.set(npc.x,h,npc.z);
                    m.group.rotation.y=npc.rotation;
                    m.group.visible=!npc.isDead;
                    m.label.style.display=npc.isDead?'none':'block';
                });
            });
            room.state.npcs.onRemove((npc, id)=>{
                const m=npcMeshes.get(id);
                if(m){scene.remove(m.group);m.label.remove();npcMeshes.delete(id);}
            });

            // Server messages
            room.onMessage('hitsplat',(data)=>{showHitsplat(data.x,data.z,data.damage,data.isMiss,data.isSpec);});
            room.onMessage('player_chat',(data)=>{addChat('public',data.message,data.sender,data.color);showChatBubble(data.x,data.z,data.message,data.color);});
            room.onMessage('npc_chat',(data)=>{addChat('agent',data.message,data.npcName,data.roleColor);showChatBubble(data.x,data.z,data.message,'#22c55e');});
            room.onMessage('system_message',(data)=>{addChat('system',data.message);});
            room.onMessage('error',(data)=>{addChat('system',data.message);});
            room.onMessage('death',(data)=>{if(data.entityType==='npc')addChat('combat','An agent has been defeated!');if(data.entityType==='player'&&data.entityId===mySessionId)addChat('combat','Oh dear, you are dead!');});
            room.onMessage('level_up',(data)=>{addChat('system',`Level up! ${data.skill} is now level ${data.level}!`);});
            room.onMessage('quest_event',(data)=>{if(data.type==='completed')addChat('system',`Quest complete: ${data.questName}!`);if(data.type==='accepted')addChat('system',`Quest accepted: ${data.questName}`);});
            room.onMessage('building_arrived',(data)=>{
                const bid=data.buildingId;
                document.getElementById('skill-action-area').innerHTML='';
                if(bid==='quest_board'){renderQuestBoard();document.getElementById('quest-overlay').classList.add('open');}
                else if(bid==='marketplace'){openShop();}
                else if(bid==='workshop'){openCrafting();}
                else if(bid==='farm'){document.getElementById('skill-action-area').innerHTML='<button class="action-btn" onclick="sendAction(\'start_harvest\')">üåæ Harvest</button>';addChat('system','You arrive at the Farm.');}
                else if(bid==='arena'){document.getElementById('skill-action-area').innerHTML='<button class="action-btn" onclick="sendAction(\'start_training\')">üéØ Train</button>';addChat('system','You enter the Arena.');}
                else{addChat('system','You arrive at the '+BUILDINGS.find(b=>b.id===bid)?.name+'.');}
            });
            room.onMessage('skilling_event',(data)=>{addChat('system',data.message);});
            room.onMessage('welcome',(data)=>{addChat('system','Welcome to AgentScape! Right-click to interact.');});

            room.onLeave(()=>{connStatus.textContent='Disconnected';connStatus.className='disconnected';addChat('system','Disconnected from server.');});
        }

        // ============================================================
        // UI RENDERING (from Colyseus state)
        // ============================================================
        function updateOrbs(p){
            if(!p)return;
            const hpPct=Math.max(0,(p.hp/p.maxHp)*100);
            document.getElementById('orbHp').style.setProperty('--hp-pct',hpPct+'%');
            document.getElementById('orbHpText').textContent=Math.max(0,p.hp);
            document.getElementById('orbCombatText').textContent=p.combatLevel;
            document.getElementById('orbEnergy').style.setProperty('--energy-pct',p.energy+'%');
            document.getElementById('orbEnergyText').textContent=p.energy;
        }
        function renderInventoryFromState(p){
            if(!p)return;
            const grid2=document.getElementById('inv-grid');grid2.innerHTML='';
            for(let i=0;i<28;i++){
                const slot=document.createElement('div');
                const isEq=(p.equippedWeaponSlot===i||p.equippedHelmSlot===i||p.equippedShieldSlot===i);
                slot.className='inv-slot'+(isEq?' equipped':'');
                slot.dataset.slot=i;
                const item=p.inventory[i];
                if(item&&item.id){
                    slot.textContent=item.icon||'?';
                    if(item.quantity>1){const qty=document.createElement('span');qty.className='inv-slot-qty';qty.textContent=item.quantity;slot.appendChild(qty);}
                }
                slot.addEventListener('contextmenu',(e)=>{e.preventDefault();e.stopPropagation();showInventoryMenu(e,i,p);});
                slot.addEventListener('click',()=>{if(!item||!item.id)return;if(item.type==='food')sendAction('eat_food',{inventorySlot:i});else if(item.type==='weapon'||item.type==='helm'||item.type==='shield')sendAction('equip_item',{inventorySlot:i});});
                grid2.appendChild(slot);
            }
        }
        function renderStatsFromState(p){
            if(!p)return;
            const skills=[{name:'Attack',key:'attack',xpKey:'attackXP',icon:'\u2694\uFE0F'},{name:'Strength',key:'strength',xpKey:'strengthXP',icon:'\u{1F4AA}'},{name:'Defence',key:'defence',xpKey:'defenceXP',icon:'\u{1F6E1}\uFE0F'},{name:'Hitpoints',key:'hitpoints',xpKey:'hitpointsXP',icon:'\u2764\uFE0F'}];
            const el=document.getElementById('stats-content');
            el.innerHTML=skills.map(s=>{const lvl=p[s.key];const xp=p[s.xpKey];const cur=xpForLevel(lvl);const next=xpForLevel(lvl+1);const pct=Math.min(100,((xp-cur)/(next-cur))*100);return`<div class="stat-skill"><span class="stat-skill-icon">${s.icon}</span><span class="stat-skill-name">${s.name}</span><span class="stat-skill-lvl">${lvl}</span></div><div style="padding:0 6px 6px;"><div class="stat-xp-bar"><div class="stat-xp-fill" style="width:${pct}%"></div></div><div style="font-size:8px;color:#6b7280;text-align:right">${xp} / ${next} XP</div></div>`;}).join('');
            document.getElementById('statCombatLvl').textContent=p.combatLevel;
        }

        // Shop
        function getMyPlayer(){return room?.state?.players?.get(mySessionId);}
        function openShop(){
            const p=getMyPlayer();const coins=p?countCoins(p):0;
            document.getElementById('shop-coins-display').textContent=`ü™ô ${coins} Coins`;
            const body=document.getElementById('shop-body-content');
            body.innerHTML=`<div class="shop-panel"><h3>Shop</h3>${SHOP_ITEMS.map(si=>{const item=ITEMS[si.id];return`<div class="shop-item" onclick="sendAction('buy_item',{itemId:'${si.id}',quantity:1})"><span class="shop-item-icon">${item.icon}</span><span class="shop-item-name">${item.name}</span><span class="shop-item-price">ü™ô ${si.price}</span></div>`;}).join('')}</div><div class="shop-panel"><h3>Your Items</h3>${p?getPlayerSellItems(p):'<div style="padding:8px;font-size:11px;color:#6b7280;">Nothing to sell.</div>'}</div>`;
            document.getElementById('shop-overlay').classList.add('open');
        }
        function getPlayerSellItems(p){
            let html='';
            for(let i=0;i<28;i++){const item=p.inventory[i];if(!item||!item.id||item.type==='coin')continue;const si=SHOP_ITEMS.find(s=>s.id===item.id);const sell=si?Math.floor(si.price/2):1;html+=`<div class="shop-item" onclick="sendAction('sell_item',{inventorySlot:${i}})"><span class="shop-item-icon">${item.icon}</span><span class="shop-item-name">${item.name}</span><span class="shop-item-price" style="color:#22c55e;">+ü™ô ${sell}</span></div>`;}
            return html||'<div style="padding:8px;font-size:11px;color:#6b7280;">Nothing to sell.</div>';
        }
        function countCoins(p){let t=0;for(let i=0;i<28;i++){if(p.inventory[i]&&p.inventory[i].id==='coins')t+=p.inventory[i].quantity;}return t;}

        // Crafting
        function openCrafting(){
            const p=getMyPlayer();
            const el=document.getElementById('craft-content');
            el.innerHTML=RECIPES.map((r,i)=>{const result=ITEMS[r.result];const ingText=r.ingredients.map(ing=>`${ITEMS[ing.id].icon} ${ing.qty}x ${ITEMS[ing.id].name}`).join(', ');return`<div class="shop-item" onclick="sendAction('craft_item',{recipeIndex:${i}})"><span class="shop-item-icon">${result.icon}</span><span class="shop-item-name">${result.name}</span><span style="font-size:9px;color:#9ca3af;">${ingText} + ü™ô ${r.coinCost}</span></div>`;}).join('');
            document.getElementById('craft-overlay').classList.add('open');
        }

        // Quests
        function renderQuestBoard(){
            const el=document.getElementById('quest-board-content');
            const available=Object.values(QUESTS).map(q=>q);
            el.innerHTML='<div style="font-size:10px;color:#6b7280;padding:4px;text-transform:uppercase;letter-spacing:1px;">Available Quests</div>'+available.map(q=>`<div class="quest-item" onclick="showQuestDetail('${q.id}')"><span class="quest-difficulty ${q.difficulty}">${q.difficulty}</span><span class="quest-name">${q.name}</span><span class="quest-status-icon">üìú</span></div>`).join('');
        }
        window.showQuestDetail=function(qid){
            const q=QUESTS[qid];if(!q)return;
            const el=document.getElementById('quest-board-content');
            const rewardText=[];
            if(q.rewards.coins)rewardText.push(`ü™ô ${q.rewards.coins} coins`);
            if(q.rewards.xp)Object.entries(q.rewards.xp).forEach(([s,a])=>rewardText.push(`${a} ${s} XP`));
            if(q.rewards.items)q.rewards.items.forEach(i=>rewardText.push(`${ITEMS[i.id].icon} ${i.qty}x ${ITEMS[i.id].name}`));
            el.innerHTML=`<div class="quest-detail"><div style="cursor:pointer;color:#6366f1;font-size:11px;margin-bottom:8px;" onclick="renderQuestBoard()">‚Üê Back</div><div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;"><span class="quest-difficulty ${q.difficulty}">${q.difficulty}</span><span style="font-size:14px;color:#fff;font-weight:bold;">${q.name}</span></div><div class="quest-detail-desc">${q.description}</div><div class="quest-detail-rewards">Rewards: ${rewardText.join(' ¬∑ ')}</div><button class="quest-accept-btn" onclick="sendAction('accept_quest',{questId:'${qid}'})">Accept Quest</button></div>`;
        };
        window.renderQuestBoard=renderQuestBoard;

        // Hitsplat + Chat bubble rendering
        function showHitsplat(wx,wz,dmg,miss,isSpec){const el=document.createElement('div');el.className='hitsplat'+(miss?' miss':'')+(isSpec?' spec':'');el.textContent=miss?'0':dmg;el.dataset.worldX=wx;el.dataset.worldZ=wz;document.getElementById('chat-bubbles').appendChild(el);setTimeout(()=>el.remove(),1000);}
        function showChatBubble(wx,wz,text,color){const b=document.createElement('div');b.className='chat-bubble';b.textContent=text.substring(0,40);if(color)b.style.color=color;b.dataset.worldX=wx;b.dataset.worldZ=wz;document.getElementById('chat-bubbles').appendChild(b);setTimeout(()=>b.remove(),5000);}

        // Inventory context menu
        function showInventoryMenu(e,slot,p){
            const item=p.inventory[slot];if(!item||!item.id)return;
            const opts=[];
            if(item.type==='food')opts.push({label:'Eat',action:`sendAction('eat_food',{inventorySlot:${slot}})`});
            if(item.type==='weapon')opts.push({label:p.equippedWeaponSlot===slot?'Unequip':'Wield',action:`sendAction('equip_item',{inventorySlot:${slot}})`});
            if(item.type==='helm')opts.push({label:p.equippedHelmSlot===slot?'Remove':'Wear',action:`sendAction('equip_item',{inventorySlot:${slot}})`});
            if(item.type==='shield')opts.push({label:p.equippedShieldSlot===slot?'Remove':'Wear',action:`sendAction('equip_item',{inventorySlot:${slot}})`});
            opts.push({label:'Drop',action:`sendAction('drop_item',{inventorySlot:${slot}})`});
            opts.push({label:'Cancel',action:'hideCtxMenu()'});
            showContextMenu(e,opts,item.icon+' '+item.name);
        }

        // ============================================================
        // CONTEXT MENU
        // ============================================================
        const ctxMenu=document.getElementById('context-menu');
        let ctxNPC=null,ctxBuilding=null;
        function hideCtxMenu(){ctxMenu.style.display='none';}
        window.hideCtxMenu=hideCtxMenu;
        document.addEventListener('click',e=>{if(!ctxMenu.contains(e.target))hideCtxMenu();});
        function showContextMenu(e,options,header){
            hideCtxMenu();
            ctxMenu.innerHTML=(header?`<div class="ctx-header">${header}</div>`:'')+options.map(o=>`<div class="ctx-option" onclick="${o.action}">${o.label}</div>`).join('');
            ctxMenu.style.display='block';
            ctxMenu.style.left=Math.min(e.clientX,window.innerWidth-160)+'px';
            ctxMenu.style.top=Math.min(e.clientY,window.innerHeight-(options.length*30+30))+'px';
        }

        // Raycasting
        const raycasterMain=new THREE.Raycaster();
        function getViewportMouse(e){const rect=viewport.getBoundingClientRect();return new THREE.Vector2(((e.clientX-rect.left)/rect.width)*2-1,-((e.clientY-rect.top)/rect.height)*2+1);}

        renderer.domElement.addEventListener('click',e=>{
            if(e.target!==renderer.domElement)return;
            const m=getViewportMouse(e);raycasterMain.setFromCamera(m,camera);
            const allObj=[];scene.traverse(o=>{if(o.isMesh)allObj.push(o);});
            const hits=raycasterMain.intersectObjects(allObj,false);
            let hitNPC=null,hitBld=null,hitTile=null;
            for(const h of hits){
                if(h.object.userData.type==='npc'&&!hitNPC)hitNPC=h.object.userData.npcId;
                if(h.object.userData.type==='building'&&!hitBld)hitBld=h.object.userData.buildingId;
                if(h.object.userData.tileX!==undefined&&!hitTile)hitTile=h.object.userData;
            }
            if(hitNPC){
                if(attackMode)sendAction('attack_npc',{npcId:hitNPC});
                else{const npc=npcMeshes.get(hitNPC);if(npc)addChat('agent','Hello there!',npc.state.name,npc.state.roleColor);}
                return;
            }
            if(hitBld){
                const door=buildingDoors[hitBld];
                if(door)sendAction('move_to',{tileX:door.x,tileZ:door.z});
                return;
            }
            if(hitTile&&hitTile.walkable){sendAction('move_to',{tileX:hitTile.tileX,tileZ:hitTile.tileZ});}
        });

        renderer.domElement.addEventListener('contextmenu',e=>{
            e.preventDefault();
            const m2=getViewportMouse(e);raycasterMain.setFromCamera(m2,camera);
            const allObj=[];scene.traverse(o=>{if(o.isMesh)allObj.push(o);});
            const hits=raycasterMain.intersectObjects(allObj,false);
            let hitNPC=null,hitBld=null,hitTile=null;
            for(const h of hits){
                if(h.object.userData.type==='npc'&&!hitNPC)hitNPC=h.object.userData.npcId;
                if(h.object.userData.type==='building'&&!hitBld)hitBld=h.object.userData.buildingId;
                if(h.object.userData.tileX!==undefined&&!hitTile)hitTile=h.object.userData;
            }
            if(hitNPC){
                const npc=npcMeshes.get(hitNPC);
                if(npc&&!npc.state.isDead){
                    ctxNPC=hitNPC;
                    showContextMenu(e,[
                        {label:'Talk to '+npc.state.name,action:`talkToNPC('${hitNPC}')`},
                        {label:'Attack '+npc.state.name,action:`sendAction('attack_npc',{npcId:'${hitNPC}'})`},
                        {label:'Examine',action:`examineNPC('${hitNPC}')`},
                        {label:'Cancel',action:'hideCtxMenu()'},
                    ],npc.state.name);
                }
                return;
            }
            if(hitBld){
                const bd=BUILDINGS.find(b=>b.id===hitBld);
                if(bd){showContextMenu(e,[{label:'Enter '+bd.name,action:`enterBuilding('${hitBld}')`},{label:'Cancel',action:'hideCtxMenu()'}],bd.icon+' '+bd.name);}
                return;
            }
            if(hitTile){showContextMenu(e,[{label:'Walk here',action:`sendAction('move_to',{tileX:${hitTile.tileX},tileZ:${hitTile.tileZ}})`},{label:'Cancel',action:'hideCtxMenu()'}]);}
        });

        renderer.domElement.addEventListener('mousemove',e=>{
            const m=getViewportMouse(e);raycasterMain.setFromCamera(m,camera);
            const allObj=[];scene.traverse(o=>{if(o.isMesh)allObj.push(o);});
            const hits=raycasterMain.intersectObjects(allObj,false);
            highlight.visible=false;let cursorSet=false;
            for(const h of hits){
                if(h.object.userData.type==='npc'){document.body.style.cursor=attackMode?'crosshair':'help';cursorSet=true;break;}
                if(h.object.userData.type==='building'){document.body.style.cursor='pointer';cursorSet=true;break;}
                if(h.object.userData.tileX!==undefined){const tx=h.object.userData.tileX,tz=h.object.userData.tileZ;highlight.position.set(tx,heightMap[tx][tz]+0.05,tz);highlight.visible=true;highlightMat.color.set(h.object.userData.walkable?0xffff00:0xff4444);highlightMat.opacity=h.object.userData.walkable?0.3:0.2;document.body.style.cursor=h.object.userData.walkable?'pointer':'not-allowed';cursorSet=true;break;}
            }
            if(!cursorSet)document.body.style.cursor='default';
        });

        window.talkToNPC=function(id){hideCtxMenu();const npc=npcMeshes.get(id);if(!npc)return;addChat('agent','Hello there!',npc.state.name,npc.state.roleColor);showChatBubble(npc.state.x,npc.state.z,'Hello there!','#22c55e');};
        window.examineNPC=function(id){hideCtxMenu();const npc=npcMeshes.get(id);if(!npc)return;const cs=NPC_COMBAT_STATS[npc.state.role]||{attack:3,strength:3,defence:3};addChat('system',`${npc.state.name} ‚Äî ${npc.state.role} (HP: ${npc.state.hp}/${npc.state.maxHp}, Atk: ${cs.attack}, Str: ${cs.strength}, Def: ${cs.defence})`);};
        window.enterBuilding=function(bid){hideCtxMenu();const door=buildingDoors[bid];if(door)sendAction('move_to',{tileX:door.x,tileZ:door.z});};
        window.sendAction=sendAction;
        window.sendSpec=function(){sendAction('use_special_attack');};
        window.toggleAttackMode=function(){attackMode=!attackMode;document.getElementById('btnAttackMode').classList.toggle('active',attackMode);};

        // Keyboard
        const keys={};
        window.addEventListener('keydown',e=>{if(!chatInputFocused){keys[e.key.toLowerCase()]=true;if(e.key.toLowerCase()==='f')sendAction('use_special_attack');}});
        window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);
        renderer.domElement.addEventListener('wheel',e=>{camDist+=e.deltaY*0.01;camDist=Math.max(6,Math.min(30,camDist));camHeight=camDist*0.78;});

        // ============================================================
        // MINIMAP
        // ============================================================
        const minimapCanvas=document.getElementById('minimap');const mctx=minimapCanvas.getContext('2d');
        function drawMinimap(){
            const s=200/MAP_SIZE;mctx.clearRect(0,0,200,200);
            for(let x=0;x<MAP_SIZE;x++)for(let z=0;z<MAP_SIZE;z++){if(grid[x][z]===3)mctx.fillStyle='#8B6914';else if(isWater(x,z))mctx.fillStyle='#2288aa';else if(grid[x][z]===0)mctx.fillStyle='#2d4a1e';else if(grid[x][z]===2)mctx.fillStyle='#8B7355';else mctx.fillStyle='#4a7c3f';mctx.fillRect(x*s,z*s,s+0.5,s+0.5);}
            BUILDINGS.forEach(b=>{mctx.fillStyle=b.signColor;mctx.globalAlpha=0.6;mctx.fillRect((b.x-b.w/2)*s,(b.z-b.d/2)*s,b.w*s,b.d*s);mctx.globalAlpha=1;});
            npcMeshes.forEach(n=>{if(!n.state.isDead){const rc=ROLE_COLORS[n.state.role];mctx.fillStyle=rc?rc.hex:'#fff';mctx.beginPath();mctx.arc(n.state.x*s,n.state.z*s,2,0,Math.PI*2);mctx.fill();}});
            otherPlayerMeshes.forEach(p=>{mctx.fillStyle=p.state.color||'#fff';mctx.beginPath();mctx.arc(p.state.x*s,p.state.z*s,2.5,0,Math.PI*2);mctx.fill();});
            mctx.fillStyle='#ffff00';mctx.beginPath();mctx.arc(myWorldX*s,myWorldZ*s,3,0,Math.PI*2);mctx.fill();
        }

        // ============================================================
        // OVERLAY PROJECTION
        // ============================================================
        function projectToScreen(wx,wz,yOffset){const pos=new THREE.Vector3(wx,yOffset,wz);pos.project(camera);const rect=viewport.getBoundingClientRect();return{x:(pos.x*0.5+0.5)*rect.width,y:(-pos.y*0.5+0.5)*rect.height,visible:pos.z>-1&&pos.z<1};}
        function updateOverlays(){
            npcMeshes.forEach(n=>{const p=projectToScreen(n.state.x,n.state.z,1.3);if(!p.visible||n.state.isDead){n.label.style.display='none';}else{n.label.style.display='block';n.label.style.left=p.x+'px';n.label.style.top=p.y+'px';}});
            otherPlayerMeshes.forEach(m=>{const p=projectToScreen(m.state.x,m.state.z,1.3);if(!p.visible||m.state.isDead){m.label.style.display='none';}else{m.label.style.display='block';m.label.style.left=p.x+'px';m.label.style.top=p.y+'px';}});
            document.querySelectorAll('.chat-bubble, .hitsplat').forEach(el=>{const wx=parseFloat(el.dataset.worldX),wz=parseFloat(el.dataset.worldZ);const p=projectToScreen(wx,wz,el.classList.contains('hitsplat')?1.5:1.6);if(p.visible){el.style.left=p.x+'px';el.style.top=p.y+'px';}else el.style.display='none';});
        }

        // ============================================================
        // GAME LOOP (rendering only ‚Äî logic on server)
        // ============================================================
        const clock=new THREE.Clock();
        function animate(){
            requestAnimationFrame(animate);
            const dt=clock.getDelta();const time=clock.getElapsedTime();
            // Camera
            if(!chatInputFocused){
                const ps=10*dt;
                if(keys['w']){camTargetZ-=ps*Math.cos(camAngle);camTargetX-=ps*Math.sin(camAngle);}
                if(keys['s']){camTargetZ+=ps*Math.cos(camAngle);camTargetX+=ps*Math.sin(camAngle);}
                if(keys['a']){camTargetX-=ps*Math.cos(camAngle);camTargetZ+=ps*Math.sin(camAngle);}
                if(keys['d']){camTargetX+=ps*Math.cos(camAngle);camTargetZ-=ps*Math.sin(camAngle);}
                if(keys['q'])camAngle-=1.5*dt;
                if(keys['e'])camAngle+=1.5*dt;
            }
            camTargetX=Math.max(-5,Math.min(MAP_SIZE+5,camTargetX));
            camTargetZ=Math.max(-5,Math.min(MAP_SIZE+5,camTargetZ));
            updateCamera();
            // Water animation
            const v=waterGeo.attributes.position;for(let i=0;i<v.count;i++){v.setY(i,Math.sin(v.getX(i)*2+time)*0.02+Math.cos(v.getZ(i)*2+time*1.3)*0.02);}v.needsUpdate=true;
            // Fireflies
            particles.forEach(p=>{p.visible=isNight;if(isNight){p.position.y+=Math.sin(time*p.userData.speed+p.userData.offset)*0.003;p.position.x+=Math.sin(time*0.3+p.userData.offset)*0.005;p.material.opacity=0.5+Math.sin(time*2+p.userData.offset)*0.5;}});
            updateOverlays();
            drawMinimap();
            renderer.render(scene,camera);
        }

        // ============================================================
        // INIT
        // ============================================================
        document.querySelector('.stat-player-name').textContent=playerName;
        addChat('system','Welcome to AgentScape! Connecting...');
        connect();
        animate();
        window.addEventListener('resize',()=>{camera.aspect=viewport.clientWidth/viewport.clientHeight;camera.updateProjectionMatrix();renderer.setSize(viewport.clientWidth,viewport.clientHeight);});
    })();
    </script>
</body>
</html>
