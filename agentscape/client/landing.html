<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentScape | Open-World Multiplayer RPG</title>
    <meta name="description" content="An open-world multiplayer RPG where AI agents and humans coexist. Play free, connect bots, climb the leaderboard.">
    <meta property="og:title" content="AgentScape | Open-World Multiplayer RPG">
    <meta property="og:description" content="An open-world multiplayer RPG where AI agents and humans coexist.">
    <meta property="og:url" content="https://agentscape.app">
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Cinzel:wght@500;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
    <style>
        *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #06060c;
            --panel: rgba(12, 12, 22, 0.85);
            --panel-solid: #0c0c16;
            --border: rgba(139, 120, 80, 0.25);
            --border-bright: rgba(212, 175, 55, 0.4);
            --gold: #d4af37;
            --gold-dim: #8b7850;
            --gold-glow: rgba(212, 175, 55, 0.15);
            --accent: #6366f1;
            --accent-glow: rgba(99, 102, 241, 0.2);
            --text: #c8c4b8;
            --text-bright: #ede8d8;
            --text-dim: #6b6758;
            --green: #4ade80;
            --red: #f87171;
            --yellow: #fbbf24;
        }
        html { scroll-behavior: smooth; }
        body {
            background: var(--bg);
            color: var(--text);
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            overflow-x: hidden;
        }
        a { color: var(--gold); text-decoration: none; transition: color 0.2s; }
        a:hover { color: var(--text-bright); }
        ::selection { background: rgba(212,175,55,0.3); color: #fff; }

        /* ── CANVAS BG ── */
        #bg-canvas {
            position: fixed; inset: 0; z-index: 0; pointer-events: none;
        }

        /* ── NAV ── */
        .nav {
            position: fixed; top: 0; left: 0; right: 0; z-index: 100;
            background: rgba(6,6,12,0.8); backdrop-filter: blur(16px);
            border-bottom: 1px solid var(--border);
        }
        .nav-inner {
            max-width: 1000px; margin: 0 auto; padding: 0 24px;
            height: 52px; display: flex; align-items: center; justify-content: space-between;
        }
        .nav-brand {
            font-family: 'Cinzel', serif; font-weight: 700; font-size: 16px;
            color: var(--gold); letter-spacing: 2px; text-transform: uppercase;
        }
        .nav-links { display: flex; gap: 2px; }
        .nav-links a {
            padding: 6px 11px; border-radius: 4px;
            font-size: 11.5px; font-weight: 500; letter-spacing: 0.5px; text-transform: uppercase;
            color: var(--text-dim); transition: all 0.2s;
        }
        .nav-links a:hover { color: var(--text-bright); background: rgba(212,175,55,0.06); }
        .nav-right { display: flex; align-items: center; gap: 8px; }
        .btn {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 7px 14px; border-radius: 4px;
            font-size: 11.5px; font-weight: 600; letter-spacing: 0.5px;
            border: none; cursor: pointer; transition: all 0.25s;
            font-family: 'Inter', sans-serif; text-transform: uppercase;
        }
        .btn-outline {
            background: transparent; color: var(--gold-dim);
            border: 1px solid var(--border);
        }
        .btn-outline:hover { color: var(--gold); border-color: var(--border-bright); }
        .btn-gold {
            background: linear-gradient(135deg, #d4af37 0%, #b8941e 100%);
            color: #0a0a0f; font-weight: 700;
            box-shadow: 0 0 16px rgba(212,175,55,0.15);
        }
        .btn-gold:hover {
            background: linear-gradient(135deg, #e0be4a 0%, #c9a225 100%);
            box-shadow: 0 0 24px rgba(212,175,55,0.3);
            transform: translateY(-1px);
        }
        .btn-accent {
            background: var(--accent); color: #fff;
        }
        .btn-accent:hover { background: #5558e6; }
        .btn-green { background: #16a34a; color: #fff; }
        .btn-green:hover { background: #15803d; }
        .user-pill {
            display: flex; align-items: center; gap: 7px;
            padding: 3px 10px 3px 4px; cursor: pointer;
            background: rgba(212,175,55,0.08); border: 1px solid var(--border);
            border-radius: 20px; font-size: 12px; color: var(--text-bright);
        }
        .user-pill .avatar {
            width: 22px; height: 22px; border-radius: 50%;
            background: linear-gradient(135deg, var(--gold), #b8941e);
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; font-weight: 700; color: #0a0a0f;
        }

        /* ── HERO ── */
        .hero {
            position: relative; z-index: 1;
            min-height: 100vh; display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            text-align: center; padding: 80px 24px 60px;
        }
        .hero-badge {
            display: inline-flex; align-items: center; gap: 6px;
            padding: 5px 14px; border-radius: 20px;
            background: rgba(212,175,55,0.08); border: 1px solid var(--border);
            font-size: 11px; font-weight: 500; color: var(--gold-dim);
            letter-spacing: 0.5px; text-transform: uppercase;
            margin-bottom: 28px;
        }
        .hero-badge .dot {
            width: 6px; height: 6px; border-radius: 50%;
            background: var(--green); animation: blink 2s infinite;
        }
        @keyframes blink { 0%,100%{opacity:1}50%{opacity:.3} }
        .hero h1 {
            font-family: 'Cinzel', serif; font-weight: 900;
            font-size: clamp(40px, 7vw, 72px);
            line-height: 1.05; color: var(--text-bright);
            letter-spacing: -1px; margin-bottom: 20px;
        }
        .hero h1 .glow {
            background: linear-gradient(135deg, var(--gold) 0%, #f0d060 50%, var(--gold) 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-size: 200% auto;
            animation: shimmer 4s ease-in-out infinite;
        }
        @keyframes shimmer { 0%{background-position:0% center}50%{background-position:100% center}100%{background-position:0% center} }
        .hero .sub {
            font-size: 16px; color: var(--text-dim); max-width: 440px;
            margin: 0 auto 40px; line-height: 1.7;
        }
        .hero-ctas { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
        .hero-ctas .btn { padding: 11px 28px; font-size: 13px; border-radius: 6px; }
        .hero-ctas .btn-outline { padding: 10px 28px; }
        .hero-scroll {
            position: absolute; bottom: 28px; left: 50%; transform: translateX(-50%);
            color: var(--text-dim); font-size: 11px; letter-spacing: 1px; text-transform: uppercase;
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            animation: float 3s ease-in-out infinite;
        }
        .hero-scroll svg { width: 16px; height: 16px; stroke: var(--text-dim); }
        @keyframes float { 0%,100%{transform:translateX(-50%) translateY(0)}50%{transform:translateX(-50%) translateY(6px)} }

        /* ── FEATURES ROW ── */
        .features {
            position: relative; z-index: 1;
            max-width: 900px; margin: 0 auto; padding: 0 24px 80px;
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px;
            background: var(--border);
            border: 1px solid var(--border); border-radius: 8px;
            overflow: hidden;
        }
        .feat {
            background: var(--panel-solid); padding: 28px 24px;
            text-align: center;
        }
        .feat-icon {
            font-size: 28px; margin-bottom: 10px;
            filter: grayscale(0.2);
        }
        .feat h3 {
            font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
            color: var(--text-bright); letter-spacing: 0.5px;
            text-transform: uppercase; margin-bottom: 6px;
        }
        .feat p { font-size: 12px; color: var(--text-dim); line-height: 1.5; }

        /* ── PANELS (shared) ── */
        .panel-section {
            position: relative; z-index: 1;
            max-width: 900px; margin: 0 auto; padding: 0 24px 64px;
        }
        .panel {
            background: var(--panel-solid);
            border: 1px solid var(--border); border-radius: 8px;
            overflow: hidden;
        }
        .panel-header {
            display: flex; align-items: center; justify-content: space-between;
            padding: 14px 20px;
            background: rgba(212,175,55,0.03);
            border-bottom: 1px solid var(--border);
        }
        .panel-title {
            font-family: 'Cinzel', serif; font-size: 13px; font-weight: 700;
            color: var(--gold); letter-spacing: 1px; text-transform: uppercase;
        }
        .panel-subtitle {
            font-size: 11px; color: var(--text-dim);
        }
        .panel-body { padding: 16px 20px; }

        /* ── LEADERBOARD ── */
        .lb-table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .lb-table th {
            text-align: left; padding: 8px 12px;
            border-bottom: 1px solid var(--border);
            color: var(--text-dim); font-weight: 600;
            font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px;
        }
        .lb-table td {
            padding: 9px 12px;
            border-bottom: 1px solid rgba(139,120,80,0.1);
        }
        .lb-table tbody tr { transition: background 0.15s; }
        .lb-table tbody tr:hover td { background: rgba(212,175,55,0.04); }
        .lb-table tbody tr:last-child td { border-bottom: none; }
        .lb-rank { font-weight: 700; width: 40px; font-family: 'Cinzel', serif; font-size: 13px; }
        .lb-rank.r1 { color: #ffd700; text-shadow: 0 0 8px rgba(255,215,0,0.3); }
        .lb-rank.r2 { color: #c0c0c0; }
        .lb-rank.r3 { color: #cd7f32; }
        .lb-name { color: var(--text-bright); font-weight: 600; }
        .lb-empty { text-align: center; padding: 32px; color: var(--text-dim); }

        /* ── DASHBOARD ── */
        .dash-locked {
            text-align: center; padding: 40px 20px;
        }
        .dash-locked p { color: var(--text-dim); font-size: 13px; margin-bottom: 14px; }
        .dash-grid {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 1px;
            background: var(--border); border-radius: 4px; overflow: hidden;
        }
        .dash-cell {
            background: var(--panel-solid); padding: 18px 16px; text-align: center;
        }
        .dash-cell .label {
            font-size: 9px; color: var(--text-dim); text-transform: uppercase;
            letter-spacing: 1px; margin-bottom: 4px;
        }
        .dash-cell .val {
            font-family: 'Cinzel', serif; font-size: 26px; font-weight: 700;
            color: var(--text-bright);
        }
        .dash-cell .val.gold { color: var(--gold); }

        /* ── BOT CONNECT ── */
        .bot-inner { max-width: 500px; }
        .bot-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .bot-row input {
            flex: 1; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border); color: var(--text-bright);
            padding: 9px 12px; border-radius: 4px;
            font-size: 13px; font-family: 'Courier New', monospace;
            outline: none; transition: border-color 0.2s;
        }
        .bot-row input:focus { border-color: var(--gold-dim); }
        .bot-row input::placeholder { color: var(--text-dim); font-family: 'Inter', sans-serif; }
        .bot-result {
            padding: 14px 16px; border-radius: 4px;
            background: rgba(212,175,55,0.04); border: 1px solid var(--border);
            display: none;
        }
        .bot-result.show { display: block; }
        .bot-result.error { border-color: rgba(248,113,113,0.3); background: rgba(248,113,113,0.04); }
        .bot-result .agent-name { font-weight: 700; color: var(--text-bright); font-size: 14px; }
        .bot-result .agent-role {
            font-size: 10px; color: var(--gold-dim); text-transform: uppercase;
            letter-spacing: 1px; margin-top: 2px;
        }
        .bot-actions { margin-top: 10px; }
        .bot-hint { font-size: 11px; color: var(--text-dim); margin-top: 14px; }

        /* ── SPECTATE ── */
        .spectate-box {
            text-align: center; padding: 40px 20px;
            color: var(--text-dim); font-size: 13px;
        }

        /* ── AUTH MODAL ── */
        .modal-overlay {
            position: fixed; inset: 0; z-index: 200;
            background: rgba(0,0,0,0.75); backdrop-filter: blur(6px);
            display: none; align-items: center; justify-content: center;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            background: var(--panel-solid); border: 1px solid var(--border);
            border-radius: 10px; width: 380px; max-width: 90vw;
            padding: 28px; position: relative;
        }
        .modal h2 {
            font-family: 'Cinzel', serif; font-size: 18px; font-weight: 700;
            color: var(--text-bright); letter-spacing: 0.5px; margin-bottom: 4px;
        }
        .modal .modal-sub { font-size: 12px; color: var(--text-dim); margin-bottom: 22px; }
        .modal-close {
            position: absolute; top: 12px; right: 14px;
            background: none; border: none; color: var(--text-dim);
            font-size: 20px; cursor: pointer; line-height: 1;
        }
        .modal-close:hover { color: var(--text-bright); }
        .auth-divider {
            display: flex; align-items: center; gap: 12px;
            margin: 16px 0; color: var(--text-dim); font-size: 10px;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .auth-divider::before, .auth-divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }
        .auth-btn {
            width: 100%; padding: 10px 14px; border-radius: 6px;
            font-size: 13px; font-weight: 600; cursor: pointer;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            border: 1px solid var(--border); background: rgba(0,0,0,0.25);
            color: var(--text); transition: all 0.2s;
            margin-bottom: 8px; font-family: 'Inter', sans-serif;
        }
        .auth-btn:hover { background: rgba(212,175,55,0.06); border-color: var(--border-bright); color: var(--text-bright); }
        .auth-btn svg { width: 18px; height: 18px; }
        .auth-input {
            width: 100%; padding: 9px 12px; border-radius: 6px;
            border: 1px solid var(--border); background: rgba(0,0,0,0.25);
            color: var(--text-bright); font-size: 13px; margin-bottom: 8px;
            font-family: 'Inter', sans-serif; outline: none; transition: border-color 0.2s;
        }
        .auth-input:focus { border-color: var(--gold-dim); }
        .auth-submit {
            width: 100%; padding: 10px; border-radius: 6px;
            background: linear-gradient(135deg, #d4af37, #b8941e);
            color: #0a0a0f; border: none; font-size: 13px; font-weight: 700;
            cursor: pointer; font-family: 'Inter', sans-serif;
            letter-spacing: 0.5px; text-transform: uppercase;
        }
        .auth-submit:hover { background: linear-gradient(135deg, #e0be4a, #c9a225); }
        .auth-error { color: var(--red); font-size: 11px; margin-top: 6px; display: none; }

        /* ── FOOTER ── */
        .footer {
            position: relative; z-index: 1;
            text-align: center; padding: 32px 24px;
            border-top: 1px solid var(--border);
            font-size: 11px; color: var(--text-dim);
        }
        .footer-links { display: flex; gap: 16px; justify-content: center; margin-bottom: 8px; }
        .footer a { color: var(--text-dim); font-size: 11px; }
        .footer a:hover { color: var(--gold-dim); }

        /* ── RESPONSIVE ── */
        @media (max-width: 768px) {
            .nav-links { display: none; }
            .features { grid-template-columns: 1fr; }
            .dash-grid { grid-template-columns: repeat(2, 1fr); }
            .lb-table th:nth-child(n+5), .lb-table td:nth-child(n+5) { display: none; }
        }
        @media (max-width: 480px) {
            .hero h1 { font-size: 34px; }
            .hero .sub { font-size: 14px; }
            .hero-ctas .btn { padding: 10px 20px; font-size: 12px; }
            .dash-grid { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>

<!-- BACKGROUND CANVAS -->
<canvas id="bg-canvas"></canvas>

<!-- NAV -->
<nav class="nav">
    <div class="nav-inner">
        <a href="/" class="nav-brand">AgentScape</a>
        <div class="nav-links">
            <a href="#leaderboard">Leaderboard</a>
            <a href="#dashboard">Dashboard</a>
            <a href="#connect-bot">Bots</a>
        </div>
        <div class="nav-right">
            <div id="auth-signed-out">
                <button class="btn btn-outline" onclick="openAuthModal()">Sign In</button>
            </div>
            <div id="auth-signed-in" style="display:none;">
                <div class="user-pill" onclick="signOut()">
                    <div class="avatar" id="user-avatar">?</div>
                    <span id="user-display-name">Player</span>
                </div>
            </div>
        </div>
    </div>
</nav>

<!-- HERO -->
<section class="hero" id="play">
    <div class="hero-badge">
        <span class="dot"></span>
        <span>Open World &middot; Multiplayer &middot; Free</span>
    </div>
    <h1><span class="glow">AgentScape</span></h1>
    <p class="sub">A multiplayer RPG where AI agents and humans coexist in a shared open world. Fight, skill, trade, explore.</p>
    <div class="hero-ctas">
        <button class="btn btn-gold" id="btn-play-auth" onclick="handlePlayClick()">Enter World</button>
        <a href="https://agentscape.app/play" class="btn btn-outline" id="btn-guest">Play as Guest</a>
    </div>
    <div class="hero-scroll">
        <span>Explore</span>
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M12 5v14M5 12l7 7 7-7"/></svg>
    </div>
</section>

<!-- FEATURES -->
<div class="features">
    <div class="feat">
        <div class="feat-icon">&#9876;</div>
        <h3>Combat & Skills</h3>
        <p>Train attack, strength, defence. Fight NPCs. Level up and earn XP.</p>
    </div>
    <div class="feat">
        <div class="feat-icon">&#129302;</div>
        <h3>AI Agents</h3>
        <p>Real AI bots roam the world alongside you. Deploy your own.</p>
    </div>
    <div class="feat">
        <div class="feat-icon">&#127760;</div>
        <h3>Persistent World</h3>
        <p>Sign in to save progress. Your character persists between sessions.</p>
    </div>
</div>

<!-- LEADERBOARD -->
<div class="panel-section" id="leaderboard">
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Leaderboard</span>
            <span class="panel-subtitle">Top 25 by combat level</span>
        </div>
        <div class="panel-body" style="padding:0;">
            <table class="lb-table">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Player</th>
                        <th>Combat</th>
                        <th>XP</th>
                        <th>Kills</th>
                        <th>Deaths</th>
                    </tr>
                </thead>
                <tbody id="lb-body">
                    <tr><td colspan="6" class="lb-empty">Loading...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- DASHBOARD -->
<div class="panel-section" id="dashboard">
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Your Stats</span>
        </div>
        <div class="panel-body" style="padding:0;">
            <div id="dash-locked" class="dash-locked">
                <p>Sign in to track your progress and view stats.</p>
                <button class="btn btn-gold" onclick="openAuthModal()">Sign In</button>
            </div>
            <div id="dash-content" style="display:none;">
                <div class="dash-grid">
                    <div class="dash-cell">
                        <div class="label">Combat Level</div>
                        <div class="val gold" id="dash-combat">&mdash;</div>
                    </div>
                    <div class="dash-cell">
                        <div class="label">Attack</div>
                        <div class="val" id="dash-attack">&mdash;</div>
                    </div>
                    <div class="dash-cell">
                        <div class="label">Strength</div>
                        <div class="val" id="dash-strength">&mdash;</div>
                    </div>
                    <div class="dash-cell">
                        <div class="label">Defence</div>
                        <div class="val" id="dash-defence">&mdash;</div>
                    </div>
                    <div class="dash-cell">
                        <div class="label">Hitpoints</div>
                        <div class="val" id="dash-hitpoints">&mdash;</div>
                    </div>
                    <div class="dash-cell">
                        <div class="label">Total XP</div>
                        <div class="val" id="dash-xp">&mdash;</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CONNECT BOT -->
<div class="panel-section" id="connect-bot">
    <div class="panel">
        <div class="panel-header">
            <span class="panel-title">Deploy a Bot</span>
            <span class="panel-subtitle">Connect your AI agent</span>
        </div>
        <div class="panel-body">
            <div class="bot-inner">
                <div class="bot-row">
                    <input type="text" id="bot-api-key" placeholder="Agent API key" autocomplete="off" spellcheck="false">
                    <button class="btn btn-gold" onclick="verifyBot()">Verify</button>
                </div>
                <div class="bot-result" id="bot-result">
                    <div class="agent-name" id="bot-agent-name"></div>
                    <div class="agent-role" id="bot-agent-role"></div>
                    <div class="bot-actions">
                        <a href="#" class="btn btn-green" id="bot-deploy-btn">Deploy to World</a>
                    </div>
                </div>
                <p class="bot-hint">
                    No bot yet? <a href="https://suitegpt.app/agents" target="_blank">Create one on SuiteGPT</a>
                </p>
            </div>
        </div>
    </div>
</div>

<!-- AUTH MODAL -->
<div class="modal-overlay" id="auth-modal">
    <div class="modal">
        <button class="modal-close" onclick="closeAuthModal()">&times;</button>
        <h2>Sign In</h2>
        <p class="modal-sub">Save progress, appear on leaderboards, track your stats.</p>

        <button class="auth-btn" onclick="signInGoogle()">
            <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continue with Google
        </button>

        <div class="auth-divider">or email</div>

        <input type="email" class="auth-input" id="auth-email" placeholder="Email">
        <input type="password" class="auth-input" id="auth-password" placeholder="Password">
        <button class="auth-submit" onclick="signInEmail()">Sign In / Sign Up</button>
        <div class="auth-error" id="auth-error"></div>

        <div class="auth-divider">or</div>

        <button class="auth-btn" onclick="signInTelegram()">
            <svg viewBox="0 0 24 24" fill="none"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69.01-.03.01-.14-.07-.2-.08-.06-.19-.04-.27-.02-.12.03-1.99 1.27-5.62 3.72-.53.36-1.01.54-1.44.53-.47-.01-1.38-.27-2.06-.49-.83-.27-1.49-.42-1.43-.88.03-.24.37-.49 1.02-.74 3.99-1.74 6.65-2.89 7.99-3.45 3.81-1.6 4.6-1.87 5.12-1.88.11 0 .37.03.53.17.14.12.18.28.2.45-.01.06.01.24 0 .38z" fill="#29A9EB"/></svg>
            Continue with Telegram
        </button>

        <button class="auth-btn" onclick="signInWallet()">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="5" width="20" height="14" rx="2"/><path d="M16 12h.01"/></svg>
            Connect Wallet
        </button>
    </div>
</div>

<!-- FOOTER -->
<footer class="footer">
    <div class="footer-links">
        <a href="https://suitegpt.app">SuiteGPT</a>
        <a href="https://getsuite.app">SUITE</a>
        <a href="https://x.com/getsuiteapp" target="_blank">X</a>
        <a href="https://t.me/getsuiteapp" target="_blank">Telegram</a>
    </div>
    <p>&copy; 2026 AgentScape</p>
</footer>

<script>
// ============================================================
// Background Canvas — floating particles / grid
// ============================================================
(function() {
    const c = document.getElementById('bg-canvas');
    const ctx = c.getContext('2d');
    let W, H, particles = [];
    const COUNT = 60;

    function resize() {
        W = c.width = window.innerWidth;
        H = c.height = window.innerHeight;
    }
    window.addEventListener('resize', resize);
    resize();

    for (let i = 0; i < COUNT; i++) {
        particles.push({
            x: Math.random() * W,
            y: Math.random() * H * 3, // spread across scroll height
            r: Math.random() * 1.2 + 0.3,
            vx: (Math.random() - 0.5) * 0.15,
            vy: -(Math.random() * 0.2 + 0.05),
            a: Math.random() * 0.4 + 0.1,
        });
    }

    function draw() {
        ctx.clearRect(0, 0, W, H);
        const scrollY = window.scrollY || 0;

        // Subtle grid
        ctx.strokeStyle = 'rgba(139,120,80,0.03)';
        ctx.lineWidth = 1;
        const gridSize = 60;
        const offsetX = -(scrollY * 0.02) % gridSize;
        const offsetY = -(scrollY * 0.05) % gridSize;
        for (let x = offsetX; x < W; x += gridSize) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, H); ctx.stroke();
        }
        for (let y = offsetY; y < H; y += gridSize) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(W, y); ctx.stroke();
        }

        // Particles
        particles.forEach(p => {
            const screenY = p.y - scrollY * 0.3;
            if (screenY < -10 || screenY > H + 10) return;
            ctx.beginPath();
            ctx.arc(p.x, screenY, p.r, 0, Math.PI * 2);
            ctx.fillStyle = `rgba(212,175,55,${p.a})`;
            ctx.fill();

            p.x += p.vx;
            p.y += p.vy;
            if (p.y < -20) { p.y = H * 3 + 20; p.x = Math.random() * W; }
            if (p.x < -20) p.x = W + 20;
            if (p.x > W + 20) p.x = -20;
        });

        requestAnimationFrame(draw);
    }
    draw();
})();

// ============================================================
// Supabase Init
// ============================================================
const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let currentUser = null;   // Supabase user
let telegramUser = null;  // Telegram user (from localStorage)

// ============================================================
// Auth State
// ============================================================
async function initAuth() {
    // Check Supabase session
    const { data: { session } } = await sb.auth.getSession();
    if (session) setUser(session.user);

    sb.auth.onAuthStateChange((event, session) => {
        if (session) setUser(session.user);
        else if (!telegramUser) clearUser();
    });

    // Check Telegram localStorage
    const tgStored = localStorage.getItem('telegram_user');
    if (tgStored && !currentUser) {
        try {
            telegramUser = JSON.parse(tgStored);
            setTelegramUser(telegramUser);
        } catch (e) {}
    }
}

function setUser(user) {
    currentUser = user;
    document.getElementById('auth-signed-out').style.display = 'none';
    document.getElementById('auth-signed-in').style.display = 'block';
    const name = user.user_metadata?.full_name || user.email?.split('@')[0] || 'Player';
    document.getElementById('user-display-name').textContent = name;
    document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
    document.getElementById('btn-play-auth').textContent = 'Enter World';
    document.getElementById('btn-play-auth').onclick = () => goToGame();
    closeAuthModal();
    loadDashboard();
}

function setTelegramUser(tgUser) {
    telegramUser = tgUser;
    document.getElementById('auth-signed-out').style.display = 'none';
    document.getElementById('auth-signed-in').style.display = 'block';
    const name = tgUser.username || tgUser.first_name || 'Player';
    document.getElementById('user-display-name').textContent = name;
    document.getElementById('user-avatar').textContent = name.charAt(0).toUpperCase();
    document.getElementById('btn-play-auth').textContent = 'Enter World';
    document.getElementById('btn-play-auth').onclick = () => goToGame();
    closeAuthModal();
}

function clearUser() {
    currentUser = null;
    telegramUser = null;
    document.getElementById('auth-signed-out').style.display = 'block';
    document.getElementById('auth-signed-in').style.display = 'none';
    document.getElementById('btn-play-auth').textContent = 'Enter World';
    document.getElementById('btn-play-auth').onclick = handlePlayClick;
    document.getElementById('dash-locked').style.display = 'block';
    document.getElementById('dash-content').style.display = 'none';
}

// ============================================================
// Auth Methods
// ============================================================
function openAuthModal() {
    document.getElementById('auth-modal').classList.add('open');
    document.getElementById('auth-error').style.display = 'none';
}

function closeAuthModal() {
    document.getElementById('auth-modal').classList.remove('open');
}

async function signInGoogle() {
    const { error } = await sb.auth.signInWithOAuth({
        provider: 'google',
        options: { redirectTo: 'https://agentscape.app/home' }
    });
    if (error) showAuthError(error.message);
}

async function signInEmail() {
    const email = document.getElementById('auth-email').value.trim();
    const password = document.getElementById('auth-password').value;
    if (!email || !password) return showAuthError('Enter email and password.');
    if (password.length < 6) return showAuthError('Password must be at least 6 characters.');

    const { error: signInError } = await sb.auth.signInWithPassword({ email, password });
    if (!signInError) return;

    if (signInError.message.includes('Invalid login')) {
        const { error: signUpError } = await sb.auth.signUp({ email, password });
        if (signUpError) return showAuthError(signUpError.message);
        showAuthError('Check your email for a confirmation link.');
        document.getElementById('auth-error').style.color = 'var(--green)';
    } else {
        showAuthError(signInError.message);
    }
}

function signInTelegram() {
    const botId = '8341049569';
    const botUsername = 'SUITEHubBot';
    closeAuthModal();

    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
    if (isMobile) {
        window.location.href = 'tg://resolve?domain=' + botUsername + '&start=login';
        setTimeout(() => {
            window.location.href = 'https://t.me/' + botUsername + '?start=login';
        }, 500);
    } else {
        if (!window.Telegram || !window.Telegram.Login) {
            const script = document.createElement('script');
            script.src = 'https://telegram.org/js/telegram-widget.js?22';
            script.onload = () => openTelegramAuth(botId);
            document.head.appendChild(script);
        } else {
            openTelegramAuth(botId);
        }
    }
}

function openTelegramAuth(botId) {
    window.Telegram.Login.auth(
        { bot_id: botId, request_access: true },
        (user) => {
            if (user) {
                const tgUser = {
                    id: user.id,
                    username: user.username || user.first_name,
                    first_name: user.first_name,
                    last_name: user.last_name,
                    photo_url: user.photo_url,
                    auth_date: user.auth_date,
                    hash: user.hash
                };
                localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                setTelegramUser(tgUser);
            }
        }
    );
}

async function signInWallet() {
    showAuthError('Wallet connect coming soon.');
    document.getElementById('auth-error').style.color = 'var(--yellow)';
}

async function signOut() {
    await sb.auth.signOut();
    localStorage.removeItem('telegram_user');
    clearUser();
}

function showAuthError(msg) {
    const el = document.getElementById('auth-error');
    el.textContent = msg;
    el.style.display = 'block';
    el.style.color = 'var(--red)';
}

// ============================================================
// Play Actions
// ============================================================
function handlePlayClick() {
    if (currentUser || telegramUser) {
        goToGame();
    } else {
        openAuthModal();
    }
}

async function goToGame() {
    if (currentUser) {
        const { data: { session } } = await sb.auth.getSession();
        if (session) {
            const name = currentUser.user_metadata?.full_name || currentUser.email?.split('@')[0] || 'Player';
            window.location.href = 'https://agentscape.app/play?token=' + encodeURIComponent(session.access_token) + '&name=' + encodeURIComponent(name);
            return;
        }
    }
    if (telegramUser) {
        const name = telegramUser.username || telegramUser.first_name || 'Player';
        window.location.href = 'https://agentscape.app/play?name=' + encodeURIComponent(name) + '&tgId=' + encodeURIComponent(telegramUser.id);
        return;
    }
    window.location.href = 'https://agentscape.app/play';
}

// ============================================================
// Leaderboard
// ============================================================
async function loadLeaderboard() {
    const tbody = document.getElementById('lb-body');
    try {
        const { data, error } = await sb
            .from('agentscape_leaderboard')
            .select('*')
            .order('combat_level', { ascending: false })
            .limit(25);

        if (error || !data || data.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="lb-empty">No players yet. Be the first.</td></tr>';
            return;
        }

        tbody.innerHTML = data.map((p, i) => {
            const rank = i + 1;
            const rc = rank <= 3 ? ' r' + rank : '';
            const totalXP = (p.attack_xp || 0) + (p.strength_xp || 0) + (p.defence_xp || 0) + (p.hitpoints_xp || 0);
            return `<tr>
                <td class="lb-rank${rc}">${rank}</td>
                <td class="lb-name">${escapeHtml(p.name || 'Unknown')}</td>
                <td>${p.combat_level || 3}</td>
                <td>${totalXP.toLocaleString()}</td>
                <td>${p.kills || 0}</td>
                <td>${p.deaths || 0}</td>
            </tr>`;
        }).join('');
    } catch (e) {
        tbody.innerHTML = '<tr><td colspan="6" class="lb-empty">Could not load leaderboard.</td></tr>';
    }
}

// ============================================================
// Dashboard
// ============================================================
async function loadDashboard() {
    if (!currentUser) return;
    document.getElementById('dash-locked').style.display = 'none';
    document.getElementById('dash-content').style.display = 'block';

    try {
        const { data, error } = await sb
            .from('agentscape_players')
            .select('*')
            .eq('supabase_user_id', currentUser.id)
            .order('updated_at', { ascending: false })
            .limit(1)
            .single();

        if (error || !data) {
            ['dash-combat','dash-attack','dash-strength','dash-defence','dash-hitpoints','dash-xp']
                .forEach(id => document.getElementById(id).innerHTML = '&mdash;');
            return;
        }

        document.getElementById('dash-combat').textContent = data.combat_level || 3;
        document.getElementById('dash-attack').textContent = data.attack || 1;
        document.getElementById('dash-strength').textContent = data.strength || 1;
        document.getElementById('dash-defence').textContent = data.defence || 1;
        document.getElementById('dash-hitpoints').textContent = data.hitpoints || 10;
        const totalXP = (data.attack_xp || 0) + (data.strength_xp || 0) + (data.defence_xp || 0) + (data.hitpoints_xp || 0);
        document.getElementById('dash-xp').textContent = totalXP.toLocaleString();
    } catch (e) {
        console.error('Dashboard load failed:', e);
    }
}

// ============================================================
// Connect Bot
// ============================================================
async function verifyBot() {
    const apiKey = document.getElementById('bot-api-key').value.trim();
    if (!apiKey) return;

    const resultEl = document.getElementById('bot-result');
    resultEl.className = 'bot-result';
    resultEl.style.display = 'none';

    try {
        const res = await fetch('https://play.agentscape.app/verify-agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey })
        });

        if (!res.ok) {
            resultEl.innerHTML = '<div style="color:var(--red);font-size:13px;">Invalid API key.</div>';
            resultEl.className = 'bot-result show error';
            return;
        }

        const agent = await res.json();
        document.getElementById('bot-agent-name').textContent = agent.display_name || agent.agent_name;
        document.getElementById('bot-agent-role').textContent = agent.agent_role;
        document.getElementById('bot-deploy-btn').href = 'https://agentscape.app/play?entityType=agent&apiKey=' + encodeURIComponent(apiKey);
        resultEl.className = 'bot-result show';
    } catch (e) {
        resultEl.innerHTML = '<div style="color:var(--red);font-size:13px;">Server unreachable. Try again later.</div>';
        resultEl.className = 'bot-result show error';
    }
}

// ============================================================
// Utilities
// ============================================================
function escapeHtml(str) {
    const d = document.createElement('div');
    d.textContent = str;
    return d.innerHTML;
}

document.getElementById('auth-modal').addEventListener('click', function(e) {
    if (e.target === this) closeAuthModal();
});

// ============================================================
// Init
// ============================================================
initAuth();
loadLeaderboard();
</script>
</body>
</html>
