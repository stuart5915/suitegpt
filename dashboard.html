<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Developer Dashboard | SUITE</title>
    <link rel="icon" type="image/png" href="assets/suite-mascot.png">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="suite-styles.css">
    <link rel="stylesheet" href="nav.css">
    <style>
        /* Critical nav styles inline */
        .nav {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
            padding: 16px 24px;
            background: transparent;
        }

        .nav-inner {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.92);
            backdrop-filter: blur(20px);
            padding: 12px 28px;
            border-radius: 100px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06);
        }

        .nav-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            font-size: 1.4rem;
            color: #2d1b4e;
            text-decoration: none;
        }

        .nav-logo-img {
            width: 36px !important;
            height: 36px !important;
            max-width: 36px !important;
            border-radius: 8px;
            object-fit: contain;
            flex-shrink: 0;
        }

        /* Override global img rule */
        .nav img,
        .nav-inner img,
        .nav-logo img {
            max-width: 36px !important;
            width: 36px !important;
            height: 36px !important;
        }

        .nav-links {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .nav-links a {
            font-size: 0.95rem;
            font-weight: 600;
            padding: 10px 18px;
            color: #5a4a6f;
            text-decoration: none;
            border-radius: 100px;
        }

        .nav-cta {
            background: linear-gradient(135deg, #ff9500, #ff6b9d) !important;
            color: white !important;
        }

        body {
            background: linear-gradient(135deg, #fff5eb 0%, #ffe4d4 20%, #ffd4e3 50%, #e8d5f9 80%, #d4e5ff 100%);
            min-height: 100vh;
            font-family: 'Nunito', sans-serif;
        }

        .dashboard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 120px 20px 40px;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .dashboard-header h1 {
            font-size: 2.2rem;
            font-weight: 900;
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .user-pill {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px 20px;
            border-radius: 100px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .user-pill img {
            width: 36px;
            height: 36px;
            border-radius: 50%;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 24px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            color: #ff9500;
        }

        .stat-label {
            font-size: 0.85rem;
            color: #666;
            margin-top: 8px;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 24px;
            padding: 0;
            margin-bottom: 24px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
            overflow: hidden;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 32px;
            cursor: pointer;
            user-select: none;
            transition: background 0.2s;
        }

        .section-header:hover {
            background: rgba(255, 149, 0, 0.05);
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 800;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .section-info {
            flex: 1;
        }

        .section-desc {
            font-size: 0.85rem;
            color: #888;
            font-weight: 400;
            margin-top: 4px;
        }

        .section-toggle {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: transform 0.3s ease;
            flex-shrink: 0;
        }

        .section.collapsed .section-toggle {
            transform: rotate(-90deg);
        }

        .section-content {
            padding: 0 32px 32px;
            max-height: 2000px;
            overflow: hidden;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.2s ease;
            opacity: 1;
        }

        .section.collapsed .section-content {
            max-height: 0;
            padding: 0 32px;
            opacity: 0;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 700;
            font-size: 0.9rem;
            color: #444;
        }

        .form-group input,
        .form-group select {
            padding: 14px 18px;
            border: 2px solid #eee;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #ff9500;
            box-shadow: 0 0 0 4px rgba(255, 149, 0, 0.1);
        }

        .toggle-group {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: #f8f9fa;
            border-radius: 12px;
        }

        .toggle-group input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #ff9500;
        }

        .btn-primary {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 100px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 8px 30px rgba(255, 149, 0, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 40px rgba(255, 149, 0, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .campaigns-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .campaign-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 16px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .campaign-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .campaign-info img {
            width: 50px;
            height: 50px;
            border-radius: 12px;
        }

        .campaign-stats {
            display: flex;
            gap: 24px;
            font-size: 0.9rem;
        }

        .campaign-stats span {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .campaign-stats strong {
            font-size: 1.1rem;
            color: #ff9500;
        }

        .badge {
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .badge-active {
            background: #dcfce7;
            color: #16a34a;
        }

        .badge-paused {
            background: #fef3c7;
            color: #d97706;
        }

        .badge-depleted {
            background: #fee2e2;
            color: #dc2626;
        }

        .login-section {
            text-align: center;
            padding: 80px 20px;
        }

        .discord-btn {
            background: #5865F2;
            color: white;
            padding: 16px 32px;
            border: none;
            border-radius: 100px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: #888;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-inner">
            <a href="index.html" class="nav-logo">
                <img src="assets/suite-token.png" alt="SUITE" class="nav-logo-img">
                SUITE
            </a>
            <div class="nav-links">
                <a href="apps.html">Apps</a>
                <a href="developer-portal.html">Build</a>
                <a href="discuss.html">Discuss</a>
                <a href="incubate.html">Incubate</a>
                <a href="docs/index.html">Docs</a>
                <div class="nav-dropdown">
                    <span class="nav-dropdown-trigger">SUITE</span>
                    <div class="nav-dropdown-menu">
                        <a href="wallet.html">üè¶ Vault</a>
                        <a href="earn.html">üí∞ Earn</a>
                        <a href="boost.html">üõí Store</a>
                        <a href="giving.html">üíù Giving</a>
                        <a href="content.html">üìö Content</a>
                        <a href="cadence.html">üéØ Cadence</a>
                        <a href="suitehub.html">üè† Hub</a>
                        <a href="dashboard.html">‚öôÔ∏è Dashboard</a>
                    </div>
                </div>
                <a href="start-building.html" class="nav-cta">üöÄ Start Building</a>
            </div>
            <button class="mobile-menu-btn">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Login Banner (shown when not logged in) -->
        <div id="loginBanner" class="section"
            style="background: linear-gradient(135deg, #5865F2, #7289da); margin-bottom: 24px; padding: 20px 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
            <div style="color: white;">
                <strong style="font-size: 1.1rem;">?? You're viewing in preview mode</strong>
                <p style="margin: 4px 0 0; opacity: 0.9; font-size: 0.9rem;">Login with Discord to manage your apps and
                    campaigns</p>
            </div>
            <button class="discord-btn" onclick="loginWithDiscord()" style="background: white; color: #5865F2;">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028 14.09 14.09 0 0 0 1.226-1.994.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03z" />
                </svg>
                Login with Discord
            </button>
        </div>

        <!-- Dashboard Content (always visible, shows demo data when not logged in) -->
        <div id="dashboardContent">
            <div class="dashboard-header">
                <h1>??? Developer Dashboard</h1>
                <div id="userPill" class="user-pill" style="display: none;">
                    <img id="userAvatar" src="" alt="">
                    <span id="userName">Loading...</span>
                    <button onclick="logout()"
                        style="background: none; border: none; color: #888; cursor: pointer;">Logout</button>
                </div>
            </div>

            <!-- Stats -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalApps">-</div>
                    <div class="stat-label">Your Apps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalCampaigns">-</div>
                    <div class="stat-label">Active Campaigns</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalClaims">-</div>
                    <div class="stat-label">Total Claims</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="suiteBalance">-</div>
                    <div class="stat-label">SUITE Balance</div>
                </div>
            </div>

            <!-- Treasury Operations (Admin Only) -->
            <div class="section" id="section-treasury" data-section="treasury"
                style="border: 2px solid rgba(168, 85, 247, 0.3); background: linear-gradient(135deg, rgba(168, 85, 247, 0.05), rgba(99, 102, 241, 0.05));">
                <div class="section-header" onclick="toggleSection('treasury')">
                    <div class="section-info">
                        <h3 class="section-title">üè¶ Treasury Operations</h3>
                        <div class="section-desc">Weekly yield distributions, buffer management, and REP tracking
                            (Admin)</div>
                    </div>
                    <div class="section-toggle">‚ñº</div>
                </div>
                <div class="section-content">
                    <!-- This Week's Yield -->
                    <div
                        style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                        <div style="background: white; border-radius: 16px; padding: 20px; text-align: center;">
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">This Week's Yield</div>
                            <div style="font-size: 1.8rem; font-weight: 900; color: #22c55e;">$2,340</div>
                        </div>
                        <div style="background: white; border-radius: 16px; padding: 20px; text-align: center;">
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">Liquid Buffer</div>
                            <div style="font-size: 1.8rem; font-weight: 900; color: #8b5cf6;">$12,500</div>
                            <div style="font-size: 0.75rem; color: #22c55e;">‚úÖ 10% (healthy)</div>
                        </div>
                        <div style="background: white; border-radius: 16px; padding: 20px; text-align: center;">
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">Total REP Issued</div>
                            <div style="font-size: 1.8rem; font-weight: 900; color: #ff9500;">142,500</div>
                        </div>
                    </div>

                    <!-- Pending Distributions -->
                    <h4 style="font-weight: 700; margin-bottom: 12px;">üìä Pending Distributions</h4>
                    <div style="background: #f8f9fa; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üîÑ Reinvest to Treasury</span>
                            <span style="font-weight: 700; color: #22c55e;">$1,800 (77%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span>üíù Charities</span>
                            <span style="font-weight: 700; color: #8b5cf6;">$340 (15%)</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span>üí∞ Self-claims</span>
                            <span style="font-weight: 700; color: #6b7280;">$200 (8%)</span>
                        </div>
                    </div>

                    <!-- Weekly Checklist -->
                    <h4 style="font-weight: 700; margin-bottom: 12px;">üìã Weekly Checklist</h4>
                    <div
                        style="background: rgba(255, 149, 0, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                        <label
                            style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" style="width: 20px; height: 20px; accent-color: #ff9500;">
                            <span>Review pending distributions</span>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" style="width: 20px; height: 20px; accent-color: #ff9500;">
                            <span>Check buffer levels (target 10%)</span>
                        </label>
                        <label
                            style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px; cursor: pointer;">
                            <input type="checkbox" style="width: 20px; height: 20px; accent-color: #ff9500;">
                            <span>Execute yield distribution</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 12px; cursor: pointer;">
                            <input type="checkbox" style="width: 20px; height: 20px; accent-color: #ff9500;">
                            <span>Update REP leaderboard</span>
                        </label>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                        <button onclick="runDistribution()" style="
                            padding: 14px 24px;
                            background: linear-gradient(135deg, #22c55e, #16a34a);
                            border: none;
                            border-radius: 12px;
                            color: white;
                            font-weight: 700;
                            cursor: pointer;
                        ">‚ñ∂Ô∏è Run Distribution Now</button>
                        <button onclick="rebalanceBuffer()" style="
                            padding: 14px 24px;
                            background: linear-gradient(135deg, #8b5cf6, #7c3aed);
                            border: none;
                            border-radius: 12px;
                            color: white;
                            font-weight: 700;
                            cursor: pointer;
                        ">‚öñÔ∏è Rebalance Buffer</button>
                        <a href="docs/utility.html" style="
                            padding: 14px 24px;
                            background: #f3f4f6;
                            border: none;
                            border-radius: 12px;
                            color: #5a4a6f;
                            font-weight: 700;
                            text-decoration: none;
                        ">üìñ View Docs</a>
                    </div>
                </div>
            </div>

            <!-- PC Prompt Server (Owner Only - Stuart) -->
            <div class="section" id="section-prompt-server" data-section="prompt-server"
                style="border: 2px solid rgba(34, 197, 94, 0.3); background: linear-gradient(135deg, rgba(34, 197, 94, 0.05), rgba(22, 163, 74, 0.05)); display: none;">
                <div class="section-header" onclick="toggleSection('prompt-server')">
                    <div class="section-info">
                        <h3 class="section-title">üñ•Ô∏è PC Prompt Server</h3>
                        <div class="section-desc">Remote coding system - send prompts to PC Antigravity (Owner only)
                        </div>
                    </div>
                    <div class="section-toggle">‚ñº</div>
                </div>
                <div class="section-content">
                    <div style="text-align: center; padding: 24px;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">üñ•Ô∏è</div>
                        <p style="font-size: 1.1rem; color: #444; margin-bottom: 20px;">
                            Send prompts to your PC's Antigravity from anywhere!
                        </p>
                        <a href="http://10.0.0.142:3000/" target="_blank" style="
                            display: inline-block;
                            padding: 16px 32px;
                            background: linear-gradient(135deg, #22c55e, #16a34a);
                            color: white;
                            font-weight: 700;
                            font-size: 1.1rem;
                            border-radius: 100px;
                            text-decoration: none;
                            box-shadow: 0 8px 30px rgba(34, 197, 94, 0.3);
                        ">ÔøΩ Open PC Prompt Server</a>
                        <p style="font-size: 0.85rem; color: #888; margin-top: 16px;">
                            http://10.0.0.142:3000/
                        </p>
                    </div>
                </div>
            </div>

            <div class="section collapsed" id="section-campaigns" data-section="campaigns">
                <div class="section-header" onclick="toggleSection('campaigns')">
                    <div class="section-info">
                        <h3 class="section-title">?? Create Campaign</h3>
                        <div class="section-desc">Pay users SUITE to try your app. Grow your user base with quality
                            engagement.</div>
                    </div>
                    <div class="section-toggle">?</div>
                </div>
                <div class="section-content">
                    <p style="color: #666; margin-bottom: 24px;">Pay SUITE to get users to try your app. Set
                        requirements to ensure quality engagement.</p>

                    <form id="campaignForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select App</label>
                                <select id="appSelect" required>
                                    <option value="">Choose an app...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Reward per User (SUITE)</label>
                                <input type="number" id="rewardAmount" value="100" min="10" max="1000" required>
                            </div>
                            <div class="form-group">
                                <label>Total Budget (SUITE)</label>
                                <input type="number" id="totalBudget" value="1000" min="100" required>
                            </div>
                            <div class="form-group">
                                <label>Max Claims (optional)</label>
                                <input type="number" id="maxClaims" placeholder="Unlimited">
                            </div>
                        </div>

                        <div style="margin-top: 24px;">
                            <h4 style="margin-bottom: 16px; color: #444;">Requirements (Optional)</h4>
                            <div class="form-grid">
                                <div class="toggle-group">
                                    <input type="checkbox" id="requireTime">
                                    <div>
                                        <label for="requireTime">Minimum Time in App</label>
                                        <input type="number" id="minTime" placeholder="10"
                                            style="width: 80px; margin-left: 12px;"> minutes
                                    </div>
                                </div>
                                <div class="toggle-group">
                                    <input type="checkbox" id="requireActions">
                                    <div>
                                        <label for="requireActions">Minimum Unique Actions</label>
                                        <input type="number" id="minActions" placeholder="50"
                                            style="width: 80px; margin-left: 12px;"> actions
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div
                            style="margin-top: 32px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div style="color: #666;">
                                Cost: <strong id="campaignCost" style="color: #ff9500; font-size: 1.2rem;">1,000
                                    SUITE</strong>
                            </div>
                            <button type="submit" class="btn-primary" id="createCampaignBtn">
                                ?? Launch Campaign
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Your Campaigns -->
            <div class="section collapsed" id="section-my-campaigns" data-section="my-campaigns">
                <div class="section-header" onclick="toggleSection('my-campaigns')">
                    <div class="section-info">
                        <h3 class="section-title">?? Your Campaigns</h3>
                        <div class="section-desc">Track performance, claims, and budget for your active user acquisition
                            campaigns.</div>
                    </div>
                    <div class="section-toggle">?</div>
                </div>
                <div class="section-content">
                    <div id="campaignsList" class="campaigns-list">
                        <div class="empty-state">
                            <p>No campaigns yet. Create one above!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Your Apps -->
            <div class="section" id="section-apps" data-section="apps">
                <div class="section-header" onclick="toggleSection('apps')">
                    <div class="section-info">
                        <h3 class="section-title">?? Your Apps</h3>
                        <div class="section-desc">Apps you've published to the SUITE Store. Manage settings and track
                            performance.</div>
                    </div>
                    <div class="section-toggle">?</div>
                </div>
                <div class="section-content">
                    <div id="appsList">
                        <div class="empty-state">
                            <p>No apps found. <a href="start-building.html" style="color: #ff9500;">Start building</a>
                                or submit via Discord!</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Request Reviews -->
            <div class="section collapsed" id="section-reviews" data-section="reviews">
                <div class="section-header" onclick="toggleSection('reviews')">
                    <div class="section-info">
                        <h3 class="section-title">?? Request Reviews</h3>
                        <div class="section-desc">Get honest reviews from real users. They use your app then share
                            feedback.</div>
                    </div>
                    <div class="section-toggle">?</div>
                </div>
                <div class="section-content">
                    <p style="color: #666; margin-bottom: 24px;">Pay SUITE tokens to get honest reviews from real users.
                        Users must use your app for a minimum time before they can review.</p>

                    <form id="reviewCampaignForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select App</label>
                                <select id="reviewAppSelect" required>
                                    <option value="">Choose an app...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>SUITE per Review</label>
                                <input type="number" id="reviewReward" value="50" min="10" max="500" required>
                                <small style="color: #888; font-size: 0.8rem;">10-500 SUITE per honest review</small>
                            </div>
                            <div class="form-group">
                                <label>Minimum Usage Time</label>
                                <select id="reviewMinTime" required>
                                    <option value="60">1 minute</option>
                                    <option value="180">3 minutes</option>
                                    <option value="300" selected>5 minutes</option>
                                    <option value="600">10 minutes</option>
                                    <option value="1800">30 minutes</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Total Budget (SUITE)</label>
                                <input type="number" id="reviewBudget" value="500" min="50" required>
                                <small style="color: #888; font-size: 0.8rem;">= <span
                                        id="reviewCountEstimate">10</span>
                                    reviews max</small>
                            </div>
                        </div>

                        <div
                            style="margin-top: 24px; padding: 16px; background: rgba(99, 102, 241, 0.1); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-weight: 700; color: #2d1b4e;">?? How it works</div>
                                <div style="font-size: 0.9rem; color: #666;">Users try your app ? Use it for min time ?
                                    Write honest review ? Get paid</div>
                            </div>
                            <button type="submit" class="btn-primary" id="createReviewCampaignBtn">
                                ?? Start Review Campaign
                            </button>
                        </div>
                    </form>

                    <!-- Active Review Campaigns -->
                    <div style="margin-top: 32px;">
                        <h4 style="font-weight: 700; margin-bottom: 16px;">Your Review Campaigns</h4>
                        <div id="reviewCampaignsList" class="campaigns-list">
                            <div class="empty-state">
                                <p>No review campaigns yet. Create one above to get feedback!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Power-Up -->
            <div class="section collapsed" id="section-powerups" data-section="powerups">
                <div class="section-header" onclick="toggleSection('powerups')">
                    <div class="section-info">
                        <h3 class="section-title">? Create Power-Up</h3>
                        <div class="section-desc">Sell in-app upgrades on the SUITE Store. You earn 70% of every sale!
                        </div>
                    </div>
                    <div class="section-toggle">?</div>
                </div>
                <div class="section-content">
                    <p style="color: #666; margin-bottom: 24px;">Create custom power-ups for your app. Users buy
                        them in the SUITE Store, you earn 70% of each sale!</p>

                    <form id="powerupForm">
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Select Your App</label>
                                <select id="powerupAppSelect" required>
                                    <option value="">Choose an app...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Power-Up Name</label>
                                <input type="text" id="powerupName" placeholder="e.g., Super Scan Mode" required
                                    maxlength="30">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <input type="text" id="powerupDesc"
                                    placeholder="e.g., Unlock premium features for 7 days" required maxlength="100">
                            </div>
                            <div class="form-group">
                                <label>Icon (emoji)</label>
                                <input type="text" id="powerupIcon" placeholder="??" maxlength="4"
                                    style="font-size: 1.5rem; text-align: center;">
                            </div>
                            <div class="form-group">
                                <label>Price (SUITE)</label>
                                <input type="number" id="powerupPrice" value="50" min="10" max="1000" required>
                            </div>
                            <div class="form-group">
                                <label>Duration (days, 0 = permanent)</label>
                                <input type="number" id="powerupDuration" value="7" min="0" max="365">
                            </div>
                        </div>

                        <div
                            style="margin-top: 24px; padding: 16px; background: rgba(255, 149, 0, 0.1); border-radius: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
                            <div>
                                <div style="font-weight: 700; color: #2d1b4e;">?? Revenue Split</div>
                                <div style="font-size: 0.9rem; color: #666;">You earn <strong
                                        style="color: #22c55e;">70%</strong> ÔøΩ Treasury gets 30%</div>
                            </div>
                            <button type="submit" class="btn-primary" id="createPowerupBtn">
                                ? Create Power-Up
                            </button>
                        </div>
                    </form>

                    <!-- Your Power-Ups List -->
                    <div style="margin-top: 32px;">
                        <h4 style="font-weight: 700; margin-bottom: 16px;">Your Power-Ups</h4>
                        <div id="powerupsList" class="campaigns-list">
                            <div class="empty-state">
                                <p>No power-ups yet. Create your first one above!</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- LP Incentives Section (Admin Only) -->
        <div class="section" id="lpIncentivesSection" style="display: none;">
            <div class="section-header" onclick="toggleSection('lpIncentivesSection')">
                <div style="display: flex; align-items: center; gap: 16px;">
                    <span class="section-icon">üíß</span>
                    <div>
                        <div class="section-title">LP Incentives</div>
                        <div class="section-subtitle">Manage liquidity pool rewards allocation</div>
                    </div>
                </div>
                <span class="section-toggle">‚ñº</span>
            </div>
            <div class="section-content">
                <!-- Current Pool Stats -->
                <div
                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
                    <div
                        style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(22, 163, 74, 0.05)); padding: 20px; border-radius: 16px; border-left: 4px solid #22c55e;">
                        <div style="font-size: 0.9rem; color: #666;">Pool TVL</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #22c55e;" id="poolTvl">$0</div>
                    </div>
                    <div
                        style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 107, 157, 0.05)); padding: 20px; border-radius: 16px; border-left: 4px solid #ff9500;">
                        <div style="font-size: 0.9rem; color: #666;">Current APY</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #ff9500;" id="poolApy">0%</div>
                    </div>
                    <div
                        style="background: rgba(139, 92, 246, 0.1); padding: 20px; border-radius: 16px; border-left: 4px solid #8b5cf6;">
                        <div style="font-size: 0.9rem; color: #666;">Allocated for Rewards</div>
                        <div style="font-size: 1.5rem; font-weight: 800; color: #8b5cf6;" id="allocatedSuite">0 SUITE
                        </div>
                    </div>
                </div>

                <!-- Allocation Form -->
                <div style="background: #f8f9fa; padding: 24px; border-radius: 16px;">
                    <h4 style="font-weight: 700; margin: 0 0 16px 0;">üìä Allocate LP Incentives</h4>
                    <p style="color: #666; font-size: 0.9rem; margin-bottom: 16px;">
                        Allocate SUITE from your balance to LP rewards. These will be distributed to liquidity providers
                        over the specified duration.
                    </p>

                    <div class="form-grid">
                        <div class="form-group">
                            <label>Amount (SUITE)</label>
                            <input type="number" id="lpIncentiveAmount" placeholder="350000" min="1000">
                        </div>
                        <div class="form-group">
                            <label>Duration (months)</label>
                            <select id="lpIncentiveDuration">
                                <option value="3">3 months</option>
                                <option value="6">6 months</option>
                                <option value="12" selected>12 months</option>
                                <option value="24">24 months</option>
                            </select>
                        </div>
                    </div>

                    <div style="background: white; padding: 16px; border-radius: 12px; margin-top: 16px;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="color: #666;">Monthly emission:</span>
                            <span style="font-weight: 700;" id="monthlyEmission">0 SUITE</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="color: #666;">Estimated APY (at current TVL):</span>
                            <span style="font-weight: 700; color: #22c55e;" id="estimatedApy">0%</span>
                        </div>
                    </div>

                    <button class="btn-primary" style="width: 100%; margin-top: 16px;" onclick="allocateLpIncentives()">
                        üíß Allocate to LP Rewards
                    </button>
                </div>

                <!-- Active Incentive Campaigns -->
                <div style="margin-top: 24px;">
                    <h4 style="font-weight: 700; margin-bottom: 12px;">Active Incentive Campaigns</h4>
                    <div id="incentiveCampaigns" class="campaigns-list">
                        <div class="empty-state">
                            <p>No active LP incentive campaigns. Allocate SUITE above to start rewarding LPs.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // Show LP Incentives section only for admin (Stuart)
            const isAdmin = true; // TODO: Check actual admin status
            if (isAdmin) {
                document.getElementById('lpIncentivesSection').style.display = 'block';
            }

            // Calculate estimated APY when inputs change
            function updateApyEstimate() {
                const amount = parseFloat(document.getElementById('lpIncentiveAmount').value) || 0;
                const months = parseInt(document.getElementById('lpIncentiveDuration').value);
                const monthlyAmount = amount / months;

                document.getElementById('monthlyEmission').textContent = monthlyAmount.toLocaleString() + ' SUITE';

                // Assuming pool TVL and SUITE price - this would be dynamic in prod
                const poolTvl = 3500; // $3500 example
                const yearlyRewards = monthlyAmount * 12;
                const apy = (yearlyRewards / poolTvl) * 100;
                document.getElementById('estimatedApy').textContent = apy.toFixed(1) + '%';
            }

            document.getElementById('lpIncentiveAmount')?.addEventListener('input', updateApyEstimate);
            document.getElementById('lpIncentiveDuration')?.addEventListener('change', updateApyEstimate);

            function allocateLpIncentives() {
                alert('LP Incentive allocation will be connected to smart contract. Coming soon!');
            }
        </script>
        <div id="editAppModal"
            style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; align-items: center; justify-content: center;">
            <div
                style="background: white; border-radius: 24px; padding: 32px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <h3 style="font-size: 1.5rem; font-weight: 800; margin: 0;">‚úèÔ∏è Edit App</h3>
                    <button onclick="closeEditAppModal()"
                        style="background: none; border: none; font-size: 1.5rem; cursor: pointer;">√ó</button>
                </div>

                <form id="editAppForm">
                    <input type="hidden" id="editAppId">

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: 700; display: block; margin-bottom: 8px;">App Name</label>
                        <input type="text" id="editAppName" disabled
                            style="padding: 14px; border: 2px solid #eee; border-radius: 12px; width: 100%; background: #f8f9fa;">
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: 700; display: block; margin-bottom: 8px;">Icon URL</label>
                        <input type="url" id="editAppIconUrl" placeholder="https://example.com/icon.png"
                            style="padding: 14px; border: 2px solid #eee; border-radius: 12px; width: 100%;">
                        <small style="color: #888; font-size: 0.8rem;">Upload your icon to Imgur, Discord CDN, or your
                            own hosting</small>
                        <div id="iconPreview" style="margin-top: 12px; text-align: center;"></div>
                    </div>

                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="font-weight: 700; display: block; margin-bottom: 8px;">Description</label>
                        <textarea id="editAppDescription" placeholder="What does your app do?" rows="3"
                            style="padding: 14px; border: 2px solid #eee; border-radius: 12px; width: 100%; resize: vertical;"></textarea>
                    </div>

                    <div class="form-group" style="margin-bottom: 24px;">
                        <label style="font-weight: 700; display: block; margin-bottom: 8px;">Category</label>
                        <select id="editAppCategory"
                            style="padding: 14px; border: 2px solid #eee; border-radius: 12px; width: 100%;">
                            <option value="productivity">Productivity</option>
                            <option value="health">Health & Fitness</option>
                            <option value="finance">Finance</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="education">Education</option>
                            <option value="utilities">Utilities</option>
                            <option value="social">Social</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 12px; justify-content: flex-end;">
                        <button type="button" onclick="closeEditAppModal()"
                            style="padding: 14px 24px; border: 2px solid #eee; background: white; border-radius: 12px; cursor: pointer; font-weight: 600;">Cancel</button>
                        <button type="submit" class="btn-primary" style="padding: 14px 24px;">üíæ Save Changes</button>
                    </div>
                </form>
            </div>
        </div>

        <script>
            const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';
            const DISCORD_CLIENT_ID = '1457474266390986865';
            const REDIRECT_URI = window.location.origin + '/dashboard.html';

            let currentUser = null;

            // ========== COLLAPSIBLE SECTIONS ==========
            function toggleSection(sectionName) {
                const section = document.getElementById(`section-${sectionName}`);
                if (!section) return;

                section.classList.toggle('collapsed');

                // Save state to localStorage
                const states = JSON.parse(localStorage.getItem('dashboardSections') || '{}');
                states[sectionName] = section.classList.contains('collapsed');
                localStorage.setItem('dashboardSections', JSON.stringify(states));
            }

            function initSectionStates() {
                const states = JSON.parse(localStorage.getItem('dashboardSections') || '{}');

                // Default: apps open, others collapsed
                const defaults = {
                    'campaigns': true,
                    'my-campaigns': true,
                    'apps': false,  // Open by default
                    'reviews': true,
                    'powerups': true
                };

                Object.keys(defaults).forEach(sectionName => {
                    const section = document.getElementById(`section-${sectionName}`);
                    if (!section) return;

                    const isCollapsed = states[sectionName] !== undefined ? states[sectionName] : defaults[sectionName];
                    if (isCollapsed) {
                        section.classList.add('collapsed');
                    } else {
                        section.classList.remove('collapsed');
                    }
                });
            }

            document.addEventListener('DOMContentLoaded', () => {
                // Initialize collapsible sections
                initSectionStates();

                const hash = window.location.hash.substring(1);
                const params = new URLSearchParams(hash);
                const accessToken = params.get('access_token');

                if (accessToken) {
                    handleOAuthCallback(accessToken);
                } else {
                    const savedUser = localStorage.getItem('suiteDev');
                    if (savedUser) {
                        currentUser = JSON.parse(savedUser);
                        showDashboard();
                    }
                }
            });

            function loginWithDiscord() {
                const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=token&scope=identify`;
                window.location.href = authUrl;
            }

            async function handleOAuthCallback(accessToken) {
                try {
                    const response = await fetch('https://discord.com/api/users/@me', {
                        headers: { 'Authorization': `Bearer ${accessToken}` }
                    });
                    const user = await response.json();

                    currentUser = {
                        id: user.id,
                        username: user.username,
                        avatar: user.avatar
                            ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                            : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator || '0') % 5}.png`
                    };

                    localStorage.setItem('suiteDev', JSON.stringify(currentUser));
                    history.replaceState(null, '', window.location.pathname);
                    showDashboard();
                } catch (error) {
                    console.error('OAuth error:', error);
                    alert('Login failed. Please try again.');
                }
            }

            function showDashboard() {
                // Hide login banner, show user pill
                document.getElementById('loginBanner').style.display = 'none';
                document.getElementById('userPill').style.display = 'flex';
                document.getElementById('userName').textContent = currentUser.username;
                document.getElementById('userAvatar').src = currentUser.avatar;

                loadDevData();
            }

            async function loadDevData() {
                await Promise.all([
                    loadApps(),
                    loadCampaigns(),
                    loadBalance()
                ]);
            }

            async function loadApps() {
                try {
                    // Query suite_apps table for apps created by this user
                    const url = `${SUPABASE_URL}/rest/v1/suite_apps?creator_discord_id=eq.${currentUser.id}&select=*`;
                    console.log('?? Loading apps for Discord ID:', currentUser.id);
                    console.log('?? API URL:', url);

                    const response = await fetch(url, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const apps = await response.json();

                    console.log('?? API Response:', apps);
                    console.log('?? Apps count:', Array.isArray(apps) ? apps.length : 'Not an array');

                    document.getElementById('totalApps').textContent = Array.isArray(apps) ? apps.length : 0;

                    const select = document.getElementById('appSelect');
                    const powerupSelect = document.getElementById('powerupAppSelect');
                    const reviewSelect = document.getElementById('reviewAppSelect');
                    select.innerHTML = '<option value="">Choose an app...</option>';
                    if (powerupSelect) powerupSelect.innerHTML = '<option value="">Choose an app...</option>';
                    if (reviewSelect) reviewSelect.innerHTML = '<option value="">Choose an app...</option>';

                    if (Array.isArray(apps)) {
                        apps.forEach(app => {
                            const option = `<option value="${app.id}">${app.name}</option>`;
                            select.innerHTML += option;
                            if (powerupSelect) powerupSelect.innerHTML += option;
                            if (reviewSelect) reviewSelect.innerHTML += option;
                        });
                    }

                    const appsList = document.getElementById('appsList');
                    if (!Array.isArray(apps) || apps.length === 0) {
                        appsList.innerHTML = '<div class="empty-state"><p>No apps yet. <a href="start-building.html" style="color: #ff9500;">Submit your first app!</a></p></div>';
                    } else {
                        appsList.innerHTML = apps.map(app => `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <img src="${app.icon_url || 'assets/suite-mascot.png'}" alt="${app.name}" style="border-radius: 12px;" onerror="this.src='assets/suite-mascot.png'">
                                <div>
                                    <strong>${app.name}</strong>
                                    <div style="font-size: 0.85rem; color: #888;">${app.tagline || app.description || 'No description'}</div>
                                </div>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button onclick="openEditAppModal('${app.id}', '${app.name}', '${app.icon_url || ''}', '${(app.description || '').replace(/'/g, "\\'")}', '${app.category || ''}')" 
                                    style="background: linear-gradient(135deg, #6366f1, #8b5cf6); color: white; border: none; padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer;">
                                    ‚úèÔ∏è Edit
                                </button>
                                <span class="badge badge-${app.status === 'published' || app.status === 'approved' ? 'active' : 'paused'}">${app.status || 'development'}</span>
                            </div>
                        </div>
                    `).join('');
                    }
                } catch (error) {
                    console.error('Error loading apps:', error);
                    document.getElementById('totalApps').textContent = '0';
                }
            }

            async function loadCampaigns() {
                try {
                    // Note: app_campaigns references suite_apps via app_id
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/app_campaigns?developer_discord_id=eq.${currentUser.id}&select=*,suite_apps(name,icon_url)`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const campaigns = await response.json();

                    if (!Array.isArray(campaigns)) {
                        document.getElementById('totalCampaigns').textContent = '0';
                        document.getElementById('totalClaims').textContent = '0';
                        return;
                    }

                    const active = campaigns.filter(c => c.status === 'active');
                    document.getElementById('totalCampaigns').textContent = active.length;
                    document.getElementById('totalClaims').textContent = campaigns.reduce((sum, c) => sum + (c.claims_count || 0), 0).toLocaleString();

                    const list = document.getElementById('campaignsList');
                    if (campaigns.length === 0) {
                        list.innerHTML = '<div class="empty-state"><p>No campaigns yet. Create one above!</p></div>';
                    } else {
                        list.innerHTML = campaigns.map(c => `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <img src="${c.suite_apps?.icon_url || 'assets/suite-mascot.png'}" alt="" style="border-radius: 12px;">
                                <div>
                                    <strong>${c.suite_apps?.name || 'Unknown App'}</strong>
                                    <div style="font-size: 0.85rem; color: #888;">+${c.suite_per_claim} SUITE per user</div>
                                </div>
                            </div>
                            <div class="campaign-stats">
                                <span><strong>${c.claims_count || 0}</strong> Claims</span>
                                <span><strong>${c.remaining_budget?.toLocaleString() || 0}</strong> Budget Left</span>
                            </div>
                            <span class="badge badge-${c.status}">${c.status}</span>
                        </div>
                    `).join('');
                    }
                } catch (error) {
                    console.error('Error loading campaigns:', error);
                    document.getElementById('totalCampaigns').textContent = '0';
                    document.getElementById('totalClaims').textContent = '0';
                }
            }

            async function loadBalance() {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/user_credits?discord_id=eq.${currentUser.id}&select=suite_balance`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const data = await response.json();
                    const balance = data[0]?.suite_balance || 0;
                    document.getElementById('suiteBalance').textContent = balance;
                } catch (error) {
                    console.error('Error loading balance:', error);
                }
            }

            // Update cost display
            document.getElementById('totalBudget').addEventListener('input', (e) => {
                document.getElementById('campaignCost').textContent = parseInt(e.target.value || 0).toLocaleString() + ' SUITE';
            });

            // Form submission
            document.getElementById('campaignForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const appId = document.getElementById('appSelect').value;
                const rewardAmount = parseInt(document.getElementById('rewardAmount').value);
                const totalBudget = parseInt(document.getElementById('totalBudget').value);
                const maxClaims = document.getElementById('maxClaims').value ? parseInt(document.getElementById('maxClaims').value) : null;
                const requireTime = document.getElementById('requireTime').checked;
                const minTime = requireTime ? parseInt(document.getElementById('minTime').value || 10) * 60 : 0;
                const requireActions = document.getElementById('requireActions').checked;
                const minActions = requireActions ? parseInt(document.getElementById('minActions').value || 50) : 0;

                if (!appId) {
                    alert('Please select an app');
                    return;
                }

                // Check balance
                const balance = parseInt(document.getElementById('suiteBalance').textContent);
                if (balance < totalBudget) {
                    alert(`Insufficient SUITE balance. You have ${balance} but need ${totalBudget}.`);
                    return;
                }

                try {
                    const btn = document.getElementById('createCampaignBtn');
                    btn.disabled = true;
                    btn.textContent = 'Creating...';

                    const response = await fetch('/api/create-campaign', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            app_id: appId,
                            developer_discord_id: currentUser.id,
                            suite_per_claim: rewardAmount,
                            total_budget: totalBudget,
                            max_claims: maxClaims,
                            require_time: requireTime,
                            min_time_seconds: minTime,
                            require_actions: requireActions,
                            min_actions: minActions
                        })
                    });

                    const result = await response.json();

                    if (result.success) {
                        alert('Campaign created successfully!');
                        await loadDevData();
                        document.getElementById('campaignForm').reset();
                    } else {
                        alert(result.error || 'Failed to create campaign');
                    }

                    btn.disabled = false;
                    btn.textContent = '?? Launch Campaign';
                } catch (error) {
                    console.error('Error creating campaign:', error);
                    alert('Error creating campaign');
                }
            });

            function logout() {
                localStorage.removeItem('suiteDev');
                currentUser = null;
                // Show login banner, hide user pill, reset to dashes
                document.getElementById('loginBanner').style.display = 'flex';
                document.getElementById('userPill').style.display = 'none';
                // Reset to dashes (not logged in state)
                document.getElementById('totalApps').textContent = '-';
                document.getElementById('totalCampaigns').textContent = '-';
                document.getElementById('totalClaims').textContent = '-';
                document.getElementById('suiteBalance').textContent = '-';
            }

            // ========== POWER-UP FUNCTIONS ==========

            let userApps = []; // Store apps for power-up dropdown

            async function loadPowerups() {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/store_powerups?creator_discord_id=eq.${currentUser.id}&select=*`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const powerups = await response.json();

                    const list = document.getElementById('powerupsList');
                    if (!powerups || powerups.length === 0) {
                        list.innerHTML = '<div class="empty-state"><p>No power-ups yet. Create your first one above!</p></div>';
                    } else {
                        list.innerHTML = powerups.map(p => `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <div style="font-size: 2rem; margin-right: 8px;">${p.icon || '?'}</div>
                                <div>
                                    <strong>${p.name}</strong>
                                    <div style="font-size: 0.85rem; color: #888;">${p.description}</div>
                                </div>
                            </div>
                            <div class="campaign-stats">
                                <span><strong>${p.total_sales || 0}</strong> Sales</span>
                                <span><strong>${p.price}</strong> SUITE</span>
                            </div>
                            <span class="badge ${p.status === 'active' ? 'badge-active' : 'badge-paused'}">${p.status || 'pending'}</span>
                        </div>
                    `).join('');
                    }
                } catch (error) {
                    console.error('Error loading power-ups:', error);
                }
            }

            function populatePowerupAppSelect(apps) {
                userApps = apps;
                const select = document.getElementById('powerupAppSelect');
                select.innerHTML = '<option value="">Choose an app...</option>';
                apps.forEach(app => {
                    select.innerHTML += `<option value="${app.id}">${app.name}</option>`;
                });
            }

            // Power-up form submission
            document.getElementById('powerupForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const appId = document.getElementById('powerupAppSelect').value;
                const name = document.getElementById('powerupName').value;
                const description = document.getElementById('powerupDesc').value;
                const icon = document.getElementById('powerupIcon').value || '?';
                const price = parseInt(document.getElementById('powerupPrice').value);
                const duration = parseInt(document.getElementById('powerupDuration').value);

                if (!appId) {
                    alert('Please select an app');
                    return;
                }

                const selectedApp = userApps.find(a => a.id == appId);

                try {
                    const btn = document.getElementById('createPowerupBtn');
                    btn.disabled = true;
                    btn.textContent = 'Creating...';

                    const response = await fetch(`${SUPABASE_URL}/rest/v1/store_powerups`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            creator_discord_id: currentUser.id,
                            app_id: appId,
                            app_name: selectedApp?.name || 'Unknown',
                            name: name,
                            description: description,
                            icon: icon,
                            price: price,
                            duration_days: duration,
                            status: 'pending', // Requires approval
                            total_sales: 0,
                            revenue_earned: 0
                        })
                    });

                    if (response.ok) {
                        alert('Power-up submitted for review! It will appear in the Store once approved.');
                        document.getElementById('powerupForm').reset();
                        document.getElementById('powerupIcon').value = '??';
                        await loadPowerups();
                    } else {
                        throw new Error('Failed to create power-up');
                    }

                    btn.disabled = false;
                    btn.textContent = '? Create Power-Up';
                } catch (error) {
                    console.error('Error creating power-up:', error);
                    alert('Error creating power-up. Please try again.');
                    document.getElementById('createPowerupBtn').disabled = false;
                    document.getElementById('createPowerupBtn').textContent = '? Create Power-Up';
                }
            });

            // Update loadApps to also populate power-up dropdown
            const originalLoadApps = loadApps;
            loadApps = async function () {
                await originalLoadApps();
                // Get apps for power-up select
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?creator_discord_id=eq.${currentUser.id}&select=*`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const apps = await response.json();
                    populatePowerupAppSelect(apps);
                } catch (e) { console.error('Error populating power-up select:', e); }
            };

            // Load power-ups when dashboard loads
            const originalLoadDevData = loadDevData;
            loadDevData = async function () {
                await originalLoadDevData();
                await loadPowerups();
                await loadReviewCampaigns();
            };

            // ========== REVIEW CAMPAIGN FUNCTIONS ==========

            // Update review count estimate
            function updateReviewEstimate() {
                const budget = parseInt(document.getElementById('reviewBudget').value) || 500;
                const reward = parseInt(document.getElementById('reviewReward').value) || 50;
                const estimate = Math.floor(budget / reward);
                document.getElementById('reviewCountEstimate').textContent = estimate;
            }

            document.getElementById('reviewBudget')?.addEventListener('input', updateReviewEstimate);
            document.getElementById('reviewReward')?.addEventListener('input', updateReviewEstimate);

            // Load existing review campaigns
            async function loadReviewCampaigns() {
                if (!currentUser) return;

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/review_campaigns?developer_discord_id=eq.${currentUser.id}&select=*,suite_apps(name,icon_url)`, {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                    });
                    const campaigns = await response.json();

                    const list = document.getElementById('reviewCampaignsList');
                    if (!campaigns || campaigns.length === 0 || campaigns.error) {
                        list.innerHTML = '<div class="empty-state"><p>No review campaigns yet. Create one above to get feedback!</p></div>';
                    } else {
                        list.innerHTML = campaigns.map(c => {
                            const minMins = Math.floor(c.min_usage_seconds / 60);
                            return `
                        <div class="campaign-item">
                            <div class="campaign-info">
                                <div style="font-size: 2rem; margin-right: 8px;"></div>
                                <div>
                                    <strong>${c.suite_apps?.name || 'Unknown App'}</strong>
                                    <div style="font-size: 0.85rem; color: #888;">+${c.suite_per_review} SUITE per review ÔøΩ ${minMins}min min</div>
                                </div>
                            </div>
                            <div class="campaign-stats">
                                <span><strong>${c.reviews_count || 0}</strong> Reviews</span>
                                <span><strong>${c.remaining_budget}</strong> Budget Left</span>
                            </div>
                            <span class="badge badge-${c.status}">${c.status}</span>
                        </div>
                    `}).join('');
                    }
                } catch (error) {
                    console.error('Error loading review campaigns:', error);
                }
            }

            // Create review campaign form handler
            document.getElementById('reviewCampaignForm')?.addEventListener('submit', async (e) => {
                e.preventDefault();
                if (!currentUser) {
                    alert('Please log in first');
                    return;
                }

                const appId = document.getElementById('reviewAppSelect').value;
                const suitePerReview = parseInt(document.getElementById('reviewReward').value);
                const minUsageSeconds = parseInt(document.getElementById('reviewMinTime').value);
                const totalBudget = parseInt(document.getElementById('reviewBudget').value);

                if (!appId) {
                    alert('Please select an app');
                    return;
                }

                // Check balance
                const balance = parseInt(document.getElementById('suiteBalance').textContent.replace(/,/g, '')) || 0;
                if (balance < totalBudget) {
                    alert(`Insufficient SUITE balance. You have ${balance} but need ${totalBudget}.`);
                    return;
                }

                const btn = document.getElementById('createReviewCampaignBtn');
                btn.disabled = true;
                btn.textContent = 'Creating...';

                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/review_campaigns`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            app_id: appId,
                            developer_discord_id: currentUser.id,
                            suite_per_review: suitePerReview,
                            min_usage_seconds: minUsageSeconds,
                            total_budget: totalBudget,
                            remaining_budget: totalBudget,
                            status: 'active'
                        })
                    });

                    if (response.ok) {
                        alert('Review campaign created! Users can now earn SUITE by reviewing your app.');
                        document.getElementById('reviewCampaignForm').reset();
                        document.getElementById('reviewReward').value = '50';
                        document.getElementById('reviewBudget').value = '500';
                        updateReviewEstimate();
                        await loadReviewCampaigns();
                    } else {
                        const err = await response.json();
                        throw new Error(err.message || 'Failed to create campaign');
                    }
                } catch (error) {
                    console.error('Error creating review campaign:', error);
                    alert('Error creating review campaign: ' + error.message);
                }

                btn.disabled = false;
                btn.textContent = 'üåü Start Review Campaign';
            });

            // ========== EDIT APP MODAL ==========
            function openEditAppModal(id, name, iconUrl, description, category) {
                document.getElementById('editAppId').value = id;
                document.getElementById('editAppName').value = name;
                document.getElementById('editAppIconUrl').value = iconUrl;
                document.getElementById('editAppDescription').value = description;
                document.getElementById('editAppCategory').value = category || 'productivity';

                // Show icon preview
                updateIconPreview(iconUrl);

                document.getElementById('editAppModal').style.display = 'flex';
            }

            function closeEditAppModal() {
                document.getElementById('editAppModal').style.display = 'none';
            }

            function updateIconPreview(url) {
                const preview = document.getElementById('iconPreview');
                if (url) {
                    preview.innerHTML = `<img src="${url}" alt="Preview" style="width: 80px; height: 80px; border-radius: 16px; object-fit: cover;" onerror="this.outerHTML='<span style=\\'color: red; font-size: 0.9rem;\\'>‚ö†Ô∏è Invalid image URL</span>'">`;
                } else {
                    preview.innerHTML = '';
                }
            }

            // Live preview as user types icon URL
            document.getElementById('editAppIconUrl').addEventListener('input', (e) => {
                updateIconPreview(e.target.value);
            });

            // Save app changes
            document.getElementById('editAppForm').addEventListener('submit', async (e) => {
                e.preventDefault();

                const id = document.getElementById('editAppId').value;
                const iconUrl = document.getElementById('editAppIconUrl').value;
                const description = document.getElementById('editAppDescription').value;
                const category = document.getElementById('editAppCategory').value;

                try {
                    // Try updating suite_apps first
                    let response = await fetch(`${SUPABASE_URL}/rest/v1/suite_apps?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            icon_url: iconUrl || null,
                            description: description,
                            category: category
                        })
                    });

                    // Also try updating the apps table (for apps there)
                    await fetch(`${SUPABASE_URL}/rest/v1/apps?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            icon_url: iconUrl || null,
                            description: description,
                            category: category
                        })
                    });

                    alert('‚úÖ App updated successfully!');
                    closeEditAppModal();
                    loadApps(); // Reload apps list
                } catch (error) {
                    console.error('Error updating app:', error);
                    alert('Error updating app: ' + error.message);
                }
            });

            // Close modal when clicking outside
            document.getElementById('editAppModal').addEventListener('click', (e) => {
                if (e.target.id === 'editAppModal') {
                    closeEditAppModal();
                }
            });

            // ‚ïê‚ïê‚ïê PC PROMPT SERVER FUNCTIONS (Owner Only) ‚ïê‚ïê‚ïê
            const PC_SERVER_URL = 'http://10.0.0.142:3000';  // Stuart's PC
            const OWNER_DISCORD_ID = '1135315153824993402';  // Stuart's Discord ID

            // Show prompt server section only for owner
            function checkOwnerAccess() {
                const isLocalhost = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1';
                const savedUser = localStorage.getItem('suiteDev');
                let isOwner = false;

                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    isOwner = user.id === OWNER_DISCORD_ID;
                }

                // Show on localhost (for testing) OR if logged in as Stuart
                if (isLocalhost || isOwner) {
                    document.getElementById('section-prompt-server').style.display = 'block';
                    checkPcStatus();
                    setInterval(checkPcStatus, 10000); // Check every 10 sec
                }
            }

            async function checkPcStatus() {
                try {
                    const res = await fetch(`${PC_SERVER_URL}/status`);
                    const data = await res.json();
                    document.getElementById('pcStatus').textContent = 'üü¢ Connected';
                    document.getElementById('pcStatus').style.color = '#22c55e';
                    document.getElementById('pendingPrompts').textContent = data.pending_prompts || 0;

                    // Update auto-pull status
                    if (data.auto_pull) {
                        document.getElementById('autoPullStatus').textContent = 'ON';
                        document.getElementById('autoPullStatus').style.color = '#22c55e';
                        document.getElementById('autoPullBtn').innerHTML = '‚ñ∂Ô∏è Auto-Pull: ON';
                        document.getElementById('autoPullBtn').style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';
                        document.getElementById('autoPullBtn').style.color = 'white';
                    } else {
                        document.getElementById('autoPullStatus').textContent = 'OFF';
                        document.getElementById('autoPullStatus').style.color = '#6b7280';
                        document.getElementById('autoPullBtn').innerHTML = '‚è∏Ô∏è Auto-Pull: OFF';
                        document.getElementById('autoPullBtn').style.background = '#f3f4f6';
                        document.getElementById('autoPullBtn').style.color = '#5a4a6f';
                    }
                } catch (err) {
                    document.getElementById('pcStatus').textContent = 'üî¥ Offline';
                    document.getElementById('pcStatus').style.color = '#ef4444';
                }
            }

            async function sendPcPrompt() {
                const prompt = document.getElementById('pcPrompt').value.trim();
                const responseEl = document.getElementById('pcResponse');

                if (!prompt) {
                    responseEl.style.display = 'block';
                    responseEl.style.background = 'rgba(239, 68, 68, 0.1)';
                    responseEl.style.color = '#ef4444';
                    responseEl.textContent = '‚ùå Please enter a prompt';
                    return;
                }

                try {
                    const res = await fetch(`${PC_SERVER_URL}/send`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ prompt })
                    });
                    const data = await res.json();

                    responseEl.style.display = 'block';
                    if (data.success) {
                        responseEl.style.background = 'rgba(34, 197, 94, 0.1)';
                        responseEl.style.color = '#22c55e';
                        responseEl.textContent = '‚úÖ Sent to PC! Watcher will process it.';
                        document.getElementById('pcPrompt').value = '';
                        checkPcStatus();
                    } else {
                        responseEl.style.background = 'rgba(239, 68, 68, 0.1)';
                        responseEl.style.color = '#ef4444';
                        responseEl.textContent = '‚ùå ' + (data.error || 'Failed to send');
                    }
                } catch (err) {
                    responseEl.style.display = 'block';
                    responseEl.style.background = 'rgba(239, 68, 68, 0.1)';
                    responseEl.style.color = '#ef4444';
                    responseEl.textContent = '‚ùå PC offline or not reachable';
                }
            }

            async function gitPullNow() {
                const responseEl = document.getElementById('pcResponse');
                try {
                    const res = await fetch(`${PC_SERVER_URL}/pull`, { method: 'POST' });
                    const data = await res.json();

                    responseEl.style.display = 'block';
                    if (data.success) {
                        responseEl.style.background = 'rgba(34, 197, 94, 0.1)';
                        responseEl.style.color = '#22c55e';
                        responseEl.textContent = 'üì• ' + (data.output || 'Already up to date');
                    } else {
                        responseEl.style.background = 'rgba(239, 68, 68, 0.1)';
                        responseEl.style.color = '#ef4444';
                        responseEl.textContent = '‚ùå Pull failed: ' + data.error;
                    }
                } catch (err) {
                    responseEl.style.display = 'block';
                    responseEl.style.background = 'rgba(239, 68, 68, 0.1)';
                    responseEl.style.color = '#ef4444';
                    responseEl.textContent = '‚ùå Could not reach PC';
                }
            }

            async function toggleAutoPull() {
                try {
                    const res = await fetch(`${PC_SERVER_URL}/auto-pull`, { method: 'POST' });
                    const data = await res.json();
                    checkPcStatus(); // Refresh status
                } catch (err) {
                    console.error('Failed to toggle auto-pull:', err);
                }
            }

            function sendQuickPrompt(prompt) {
                document.getElementById('pcPrompt').value = prompt;
                sendPcPrompt();
            }

            // Check owner access on load
            setTimeout(checkOwnerAccess, 1000);
        </script>

        <!-- Stu Helper Widget -->
        <link rel="stylesheet" href="stu-helper.css">
        <script src="stu-helper.js"></script>
</body>

</html>