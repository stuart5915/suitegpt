<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>getSuite Factory - Community Governance</title>
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/nav.css">
    <style>
        /* Dark theme override for nav on this page */
        .nav-inner {
            background: rgba(10, 10, 10, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .nav-logo {
            color: #ffffff !important;
        }
        .nav-links a {
            color: #9ca3af !important;
        }
        .nav-links a:hover,
        .nav-links a.active {
            color: #ffffff !important;
        }
        .mobile-menu-btn span {
            background: #ffffff !important;
        }
        .connect-btn {
            background: linear-gradient(135deg, #ff9500, #ff6b9d) !important;
        }

        :root {
            --bg: #0a0a0a;
            --bg-card: #111111;
            --bg-elevated: #1a1a1a;
            --text: #ffffff;
            --text-dim: #888888;
            --accent: #ff9500;
            --accent-dim: rgba(255, 149, 0, 0.2);
            --success: #22c55e;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        /* Header */
        .factory-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--border);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .factory-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .factory-logo h1 {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .factory-logo span {
            color: var(--accent);
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-rep {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .auth-btn {
            background: var(--accent);
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .auth-btn:hover {
            background: #ffaa33;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
        }

        /* Factory Tabs */
        .factory-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 12px;
        }

        .factory-tab {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factory-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-tab.active {
            background: var(--accent);
            color: #000;
        }

        .factory-tab .tab-icon {
            font-size: 1.1rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex: 1;
        }

        /* NoteBox Auth Prompt */
        .notebox-auth-prompt {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            text-align: center;
            padding: 40px;
        }

        .notebox-auth-icon {
            font-size: 4rem;
        }

        .notebox-auth-title {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .notebox-auth-subtitle {
            color: var(--text-dim);
            max-width: 400px;
        }

        .notebox-connect-btn {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notebox-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
        }

        /* NoteBox App Styles */
        .notebox-app {
            display: flex;
        }

        .notebox-quick-add {
            display: flex;
            gap: 8px;
        }

        .notebox-input {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .notebox-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notebox-add-btn {
            background: var(--accent);
            color: #000;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notebox-add-btn:hover {
            background: #ffaa33;
        }

        .notebox-kanban { display: flex; flex-wrap: wrap; gap: 16px; padding: 20px; overflow-y: auto; flex: 1; align-content: flex-start; }

        .notebox-kanban.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .notebox-column { width: 280px; flex-shrink: 0;
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            
        }

        .notebox-column-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .notebox-column-count {
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
        }

        .notebox-column-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .notebox-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 16px;
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
            position: relative;
        }

        .notebox-card:active {
            cursor: grabbing;
        }

        .notebox-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .notebox-card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .notebox-card:hover .notebox-card-delete {
            opacity: 1;
        }

        .notebox-card-delete:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .notebox-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            border-color: var(--accent);
        }

        .notebox-column-cards.drag-over {
            background: rgba(0, 212, 170, 0.1);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            min-height: 100px;
        }

        .archive-column {
            opacity: 0.8;
        }

        .archive-column .notebox-card {
            opacity: 0.7;
        }

        .archive-column .notebox-card:hover {
            opacity: 1;
        }

        .notebox-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .notebox-card-emoji {
            font-size: 1.2rem;
        }

        .notebox-card-category {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .notebox-card-title {
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .notebox-card-content {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .notebox-card-actions {
            display: flex;
            gap: 8px;
        }

        .notebox-card-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .notebox-card-btn.done {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .notebox-card-btn.done:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .notebox-card-btn.push {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent);
            flex: 2;
        }

        .notebox-card-btn.push:hover {
            background: rgba(0, 212, 170, 0.3);
        }

        /* Push To Dropdown - Global dropdown positioned at body level */
        .push-dropdown {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 9999;
            display: none;
            overflow: hidden;
            min-width: 200px;
        }

        .push-dropdown.active {
            display: block;
        }

        .push-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background 0.15s;
        }

        .push-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .push-dropdown-item.back {
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .push-dropdown-header {
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .destination-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .destination-btn:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .destination-btn .dest-icon {
            font-size: 1.5rem;
        }

        .destination-btn .dest-info {
            flex: 1;
        }

        .destination-btn .dest-name {
            font-weight: 600;
            color: var(--text);
        }

        .destination-btn .dest-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .notebox-card-reason {
            font-size: 0.8rem;
            color: var(--accent);
            background: var(--accent-dim);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .notebox-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .notebox-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Main Layout */
        .factory-main {
            display: flex;
            height: calc(100vh - 80px);
            margin-top: 80px;
        }

        /* Sidebar */
        .factory-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px;
            padding-top: 104px;
            margin-top: -80px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .rep-explainer {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.08) 0%, rgba(255, 153, 0, 0.02) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 153, 0, 0.2);
        }

        .rep-explainer .sidebar-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .rep-explainer .sidebar-title::before {
            content: '‚ö°';
            font-size: 1rem;
        }

        .rep-section {
            background: var(--bg);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .rep-section:last-child {
            margin-bottom: 0;
        }

        .rep-section-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }

        .rep-section.earn .rep-section-header {
            color: #22c55e;
        }

        .rep-section.spend .rep-section-header {
            color: var(--accent);
        }

        .rep-section.lose .rep-section-header {
            color: #ef4444;
        }

        .rep-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .rep-item-value {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        .rep-item-value.positive {
            color: #22c55e;
        }

        .rep-item-value.cost {
            color: var(--accent);
        }

        .rep-item-value.negative {
            color: #ef4444;
        }

        .rep-item-desc {
            flex: 1;
            font-size: 0.75rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .submit-btn {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .submit-btn:hover {
            background: #ffaa33;
            transform: translateY(-1px);
        }

        .stat-card {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .stat-value.accent {
            color: var(--accent);
        }

        .filter-btn {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 8px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
        }

        .filter-count {
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Content Area */
        .factory-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .content-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        /* NoteBox Connect Button & Badge */
        .governance-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 10px;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .view-tab.active {
            background: var(--accent);
            color: #000;
        }

        .notebox-connect-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px dashed var(--border);
            background: transparent;
            color: var(--text-dim);
            font-size: 18px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notebox-connect-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }

        .notebox-badge {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .notebox-badge a {
            color: var(--accent);
            text-decoration: none;
        }

        .notebox-badge a:hover {
            text-decoration: underline;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            min-height: 400px;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .column-icon {
            font-size: 1.2rem;
        }

        .column-title {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .column-count {
            margin-left: auto;
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Proposal Cards */
        .proposal-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .proposal-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .proposal-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .proposal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .proposal-author {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
        }

        .proposal-votes {
            display: flex;
            gap: 12px;
        }

        .vote-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vote-count.for {
            color: var(--success);
        }

        .vote-count.against {
            color: var(--error);
        }

        /* Quick Vote Buttons */
        .quick-vote {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .quick-vote-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .quick-vote-btn.for:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .quick-vote-btn.against:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .quick-vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Time remaining badge */
        .time-badge {
            background: var(--accent-dim);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Submit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .form-select {
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .modal-btn.submit {
            background: var(--accent);
            border: none;
            color: #000;
        }

        .modal-btn.submit:hover {
            background: #ffaa33;
        }

        /* Category badges */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .category-badge.feature { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .category-badge.bug { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .category-badge.app_idea { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .category-badge.improvement { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .category-badge.docs { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .category-badge.integration { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .category-badge.tokenomics { background: rgba(255, 149, 0, 0.2); color: #ff9500; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            border-color: var(--accent);
        }

        .leaderboard-item.gold {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border-color: rgba(255, 215, 0, 0.3);
        }

        .leaderboard-item.silver {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));
            border-color: rgba(192, 192, 192, 0.3);
        }

        .leaderboard-item.bronze {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));
            border-color: rgba(205, 127, 50, 0.3);
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            width: 32px;
            text-align: center;
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            gap: 8px;
        }

        .leaderboard-rep {
            color: var(--accent);
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .founder-badge {
            background: linear-gradient(135deg, #ff9500, #ff6b00);
            color: #000;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-left: 6px;
        }

        /* Auth required overlay */
        .auth-required {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }

        .auth-card h2 {
            margin-bottom: 12px;
        }

        .auth-card p {
            color: var(--text-dim);
            margin-bottom: 24px;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .telegram-btn:hover {
            background: #0099dd;
        }

        /* Governance Sections */
        .governance-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid var(--border);
        }

        .governance-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .governance-section-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .governance-section-header h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0;
        }

        .governance-section-count {
            background: var(--accent-dim);
            color: var(--accent);
            padding: 2px 10px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .section-kanban {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
        }

        .section-column {
            background: var(--bg-elevated);
            border-radius: 12px;
            padding: 12px;
            min-height: 120px;
        }

        .section-column-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-column-header span {
            opacity: 0.7;
        }

        .section-add-btn {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 12px;
            background: var(--accent);
            color: #000;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .section-add-btn:hover {
            background: #ffaa33;
        }

        /* Drag and Drop */
        .section-column.drag-over {
            background: rgba(255, 149, 0, 0.1);
            border: 2px dashed var(--accent);
        }

        .idea-card[draggable="true"] {
            cursor: grab;
            user-select: none;
            -webkit-user-drag: element;
        }

        .idea-card[draggable="true"] * {
            pointer-events: none;
        }

        .idea-card[draggable="true"] button {
            pointer-events: auto;
        }

        .idea-card[draggable="true"]:active {
            cursor: grabbing;
        }

        .idea-card.dragging {
            opacity: 0.5;
        }

        .empty-column {
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
            padding: 20px 10px;
            opacity: 0.6;
        }

        .idea-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 8px;
            transition: all 0.2s;
            position: relative;
        }

        .idea-card:hover {
            border-color: var(--accent);
        }

        .card-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .idea-card:hover .card-delete-btn {
            opacity: 1;
        }

        .card-delete-btn:hover {
            background: #ef4444;
        }

        .idea-card.building {
            border-left: 3px solid #ff9500;
        }

        .idea-card.considering {
            border-left: 3px solid #6366f1;
        }

        .idea-card.live {
            border-left: 3px solid #22c55e;
        }

        .idea-card.rejected {
            border-left: 3px solid #ef4444;
            opacity: 0.7;
        }

        .proposal-app-tag {
            display: inline-block;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.2));
            color: #a855f7;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 100px;
            margin-bottom: 8px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .idea-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 6px;
        }

        .idea-card-tagline {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .idea-card-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .rejection-reason {
            font-size: 0.8rem;
            color: #ef4444;
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border-left: 3px solid #ef4444;
        }

        .vote-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .vote-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn:hover {
            border-color: var(--accent);
            background: var(--bg-elevated);
        }

        .vote-btn.for:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .vote-btn.against:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        .vote-btn .vote-count {
            font-weight: 600;
        }

        .add-vote-btn {
            margin-left: auto;
            padding: 6px 10px;
            border: 1px dashed var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-vote-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .your-votes {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .factory-sidebar {
                display: none;
            }

            .factory-header {
                padding: 16px 20px;
            }

            .factory-content {
                padding: 16px;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .section-kanban {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Main Site Navigation -->
    <nav id="main-nav"></nav>

    <!-- User Panel (hidden - auth handled by nav) -->
    <div class="factory-user-panel" id="userPanel" style="display: none;"></div>

    <!-- Main Layout -->
    <div class="factory-main">
        <!-- TELOS Tab Content -->
        <div class="tab-content active" id="telosContent">
            <!-- Sidebar -->
            <aside class="factory-sidebar">
                <div class="sidebar-section rep-explainer">
                    <div class="sidebar-title">How Rep Works</div>
                    <div class="rep-section earn">
                        <div class="rep-section-header">
                            <span>üìà</span> Earn Rep
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">+1</span>
                            <span class="rep-item-desc">per $1 deposited to treasury</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">+1</span>
                            <span class="rep-item-desc">per $1 yield earned</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">+50</span>
                            <span class="rep-item-desc">when your proposal passes</span>
                        </div>
                    </div>
                    <div class="rep-section spend">
                        <div class="rep-section-header">
                            <span>üó≥Ô∏è</span> Spend Rep
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value cost">FREE</span>
                            <span class="rep-item-desc">1st vote on any proposal</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value cost">1‚Üí3‚Üí6</span>
                            <span class="rep-item-desc">quadratic cost for more votes</span>
                        </div>
                    </div>
                    <div class="rep-section" style="background: rgba(34, 197, 94, 0.1);">
                        <div class="rep-section-header" style="color: #22c55e;">
                            <span>üìù</span> Submit Proposals
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">FREE</span>
                            <span class="rep-item-desc">to submit any proposal</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value" style="color: var(--text-dim);">7 days</span>
                            <span class="rep-item-desc">to get moved to voting or removed</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Your Stats</div>
                    <div class="stat-card">
                        <div class="stat-label">Reputation</div>
                        <div class="stat-value accent" id="userRep">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Active Submissions</div>
                        <div class="stat-value" id="userSubmissions">0 / 5</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title" style="display: flex; align-items: center; gap: 8px;">
                        <span>üèÜ</span> Leaderboard
                    </div>
                    <div id="leaderboard">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </aside>

            <!-- Content -->
            <main class="factory-content">
                <div class="content-header">
                    <div class="governance-title-row">
                        <div class="view-tabs">
                            <button class="view-tab active" data-view="governance" onclick="switchView('governance')">
                                üèõÔ∏è Governance
                            </button>
                            <button class="view-tab" data-view="notebox" onclick="switchView('notebox')" id="noteboxTab" style="display: none;">
                                üì¶ Stuart Factory - Notebox
                            </button>
                        </div>
                        <button class="notebox-connect-btn" onclick="openConnectNoteboxModal()" title="Submit an idea">+</button>
                    </div>
                    <p class="notebox-badge" id="noteboxBadge" style="display: none;">Powered by <a href="https://getsuite.app/notebox" target="_blank">NoteBox</a>, a getSuite product</p>
                </div>

                <!-- Governance View -->
                <div id="governanceView">
                    <!-- SUITE Apps Section -->
                    <div class="governance-section" id="suiteAppsSection">
                        <div class="governance-section-header">
                            <h3>üì± SUITE Apps</h3>
                            <span class="governance-section-count" id="suiteAppsCount">0</span>
                        </div>
                        <div class="section-kanban" id="suiteAppsKanban">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Business/Ecosystem Section -->
                    <div class="governance-section" id="businessSection">
                        <div class="governance-section-header">
                            <h3>üí∞ Business/Ecosystem</h3>
                            <span class="governance-section-count" id="businessCount">0</span>
                        </div>
                        <div class="section-kanban" id="businessKanban">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Articles/Content Section -->
                    <div class="governance-section" id="contentSection">
                        <div class="governance-section-header">
                            <h3>üìù Articles/Content</h3>
                            <span class="governance-section-count" id="contentSectionCount">0</span>
                        </div>
                        <div class="section-kanban" id="contentKanban">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Social/Cadence Loops Section -->
                    <div class="governance-section" id="socialSection">
                        <div class="governance-section-header">
                            <h3>üîÑ Social/Cadence Loops</h3>
                            <span class="governance-section-count" id="socialCount">0</span>
                        </div>
                        <div class="section-kanban" id="socialKanban">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>

                <!-- NoteBox View (hidden by default) -->
                <div id="noteboxView" style="display: none;">
                    <!-- Auth Prompt (shown when not logged in) -->
                    <div class="notebox-auth-prompt" id="noteboxAuthPromptInline" style="min-height: 400px;">
                        <div class="notebox-auth-icon">üì¶</div>
                        <div class="notebox-auth-title">Connect to NoteBox</div>
                        <div class="notebox-auth-subtitle">
                            Your personal idea capture board. Jot down thoughts, tasks, and inspirations in one place.
                        </div>
                        <button class="notebox-connect-btn" onclick="showAuthModal()" style="background: linear-gradient(135deg, #a855f7, #6366f1);">
                            Connect Account
                        </button>
                    </div>

                    <!-- NoteBox App (shown when logged in) -->
                    <div id="noteboxAppInline" style="display: none;">
                        <div class="sidebar-section" style="margin-bottom: 20px;">
                            <div class="sidebar-title">Quick Add</div>
                            <div class="notebox-quick-add">
                                <input type="text" class="notebox-input" id="noteboxQuickInputInline" placeholder="Type an idea..." onkeypress="if(event.key==='Enter') addNoteboxIdeaInline()">
                                <button class="notebox-add-btn" onclick="addNoteboxIdeaInline()">+</button>
                            </div>
                        </div>

                        <div class="notebox-kanban" id="noteboxKanbanInline" style="padding: 0;">
                            <!-- Populated by JS -->
                        </div>
                    </div>
                </div>
            </main>
        </div>

    </div>

    <!-- NoteBox Archive Modal -->
    <div class="modal-overlay" id="noteboxArchiveModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="noteboxArchiveTitle">Mark as Done</h3>
                <button class="modal-close" onclick="hideNoteboxArchiveModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="noteboxArchiveLabel">What did you accomplish?</label>
                <textarea class="form-textarea" id="noteboxArchiveReason" rows="3" placeholder="Briefly describe what was done or why you're archiving this..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="form-btn secondary" onclick="hideNoteboxArchiveModal()" style="flex: 1;">Cancel</button>
                <button class="form-btn" id="noteboxArchiveConfirm" onclick="confirmNoteboxArchive()" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Push To Modal -->
    <div class="modal-overlay" id="pushToModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3 class="modal-title">Push To...</h3>
                <button class="modal-close" onclick="hidePushToModal()">&times;</button>
            </div>
            <div id="pushToDestinations" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add Destination Modal -->
    <div class="modal-overlay" id="addDestinationModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Destination</h3>
                <button class="modal-close" onclick="hideAddDestinationModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="newDestinationName" placeholder="e.g., artstu.ca">
            </div>
            <div class="form-group">
                <label class="form-label">Icon (emoji)</label>
                <input type="text" class="form-input" id="newDestinationIcon" placeholder="e.g., üé®" maxlength="2">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="newDestinationDesc" placeholder="What kind of ideas go here?">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="form-btn secondary" onclick="hideAddDestinationModal()" style="flex: 1;">Cancel</button>
                <button class="form-btn" onclick="createDestination()" style="flex: 1;">Create</button>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Proposal</h3>
                <button class="modal-close" onclick="hideSubmitModal()">&times;</button>
            </div>
            <form id="submitForm" onsubmit="submitProposal(event)">
                <input type="hidden" id="proposalSection" value="">

                <div class="form-group">
                    <label class="form-label">What's your idea?</label>
                    <textarea class="form-textarea" id="proposalContent"
                        placeholder="Describe your idea, feature request, bug, or suggestion..."
                        rows="6" required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Related App (optional)</label>
                    <select id="proposalApp" class="form-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-tertiary); color: var(--text); font-size: 0.95rem;">
                        <option value="">-- None (General Proposal) --</option>
                    </select>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 16px;">
                    AI will auto-generate title and category from your description.
                </p>

                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="hideSubmitModal()">Cancel</button>
                    <button type="submit" class="modal-btn submit" id="submitBtn">Submit Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">Connect to Participate</h3>
                <button class="modal-close" onclick="hideAuthModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 24px;">
                Connect your Telegram account to submit proposals, vote, and earn reputation.
            </p>
            <button class="telegram-btn" onclick="connectTelegram()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                </svg>
                Connect with Telegram
            </button>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--text-dim); font-size: 0.85rem;">
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
                <span>or</span>
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
            </div>
            <button onclick="connectWallet()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #627eea, #8b5cf6); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                <span style="font-size: 1.2rem;">üîó</span>
                Connect Wallet
            </button>
            <button onclick="connectDemo()" style="margin-top: 16px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                Try Demo Mode
            </button>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div class="modal-overlay" id="rejectionModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">‚ùå Rejection Reason</h3>
                <button class="modal-close" onclick="hideRejectionModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 16px;">
                Please provide a reason for rejecting this item:
            </p>
            <div class="form-group">
                <textarea class="form-textarea" id="rejectionReason" placeholder="Why is this being rejected?" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideRejectionModal()">Cancel</button>
                <button type="button" class="modal-btn submit" onclick="confirmRejection()" style="background: #ef4444;">Reject</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 class="modal-title">üóëÔ∏è Delete Item</h3>
                <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 20px;">
                Are you sure you want to delete this item? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideDeleteModal()">Cancel</button>
                <button type="button" class="modal-btn submit" onclick="confirmDelete()" style="background: #ef4444;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Vote Modal -->
    <div class="modal-overlay" id="voteModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 class="modal-title">üó≥Ô∏è Cast Your Vote</h3>
                <button class="modal-close" onclick="hideVoteModal()">&times;</button>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px;">
                    <span>Proposal:</span>
                    <span id="voteProposalId">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px;">
                    <span>Your votes on this proposal:</span>
                    <span id="voteCurrentCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px;">
                    <span>Cost for next vote:</span>
                    <span id="voteNextCost" style="color: var(--accent); font-weight: 600;">FREE</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim);">
                    <span>Your REP balance:</span>
                    <span id="voteUserRep">0</span>
                </div>
            </div>
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 8px;">Vote Direction:</div>
                <div style="display: flex; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="voteType" value="for" id="voteTypeFor" checked>
                        <span>üëç FOR</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="voteType" value="against" id="voteTypeAgainst">
                        <span>üëé AGAINST</span>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideVoteModal()">Cancel</button>
                <button type="button" class="modal-btn submit" id="voteSubmitBtn" onclick="submitVote()">Cast Vote</button>
            </div>
        </div>
    </div>

    <!-- Global Push Dropdown (lives at body level to avoid stacking context issues) -->
    <div class="push-dropdown" id="globalPushDropdown" data-idea-id="" data-step="destinations">
        <div class="push-dropdown-header">Push to...</div>
        <button class="push-dropdown-item" onclick="event.stopPropagation(); showSectionSelect()">
            üèõÔ∏è getSUITE Governance
        </button>
    </div>

    <!-- Connect NoteBox Modal -->
    <div class="modal-overlay" id="connectNoteboxModal">
        <div class="modal-content" style="text-align: center; max-width: 420px;">
            <div class="modal-header">
                <h3 class="modal-title">üìù Submit Ideas</h3>
                <button class="modal-close" onclick="closeConnectNoteboxModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 24px; line-height: 1.6;">
                Contribute ideas to getSuite Governance, vote on proposals, and earn reputation.
            </p>
            <div id="connectNoteboxContent">
                <!-- Content changes based on auth state -->
            </div>
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <a href="https://getsuite.app/notebox" target="_blank" style="color: var(--text-dim); font-size: 0.85rem; text-decoration: none;">
                    Learn more about NoteBox ‚Üí
                </a>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // State
        let currentUser = null;
        let proposals = [];
        let users = [];
        let currentFilter = 'all';
        let currentView = 'kanban';
        let userVotes = {}; // { proposalId: voteCount }
        let pendingVote = null; // { proposalId, voteType }

        // Factory Tab State
        let currentTab = 'telos';

        // NoteBox State
        let noteboxIdeas = [];
        let noteboxDestinations = [];
        let currentDestination = 'all'; // 'all' or destination slug
        let noteboxArchiveIdeaId = null;
        let noteboxArchiveAction = null; // 'done' or 'dismiss'
        let pushingIdeaId = null; // ID of idea being pushed

        // Governance Sections State
        let suiteAppsIdeas = [];  // From 'ideas' table (shared with /apps)
        let governanceProposals = [];  // From 'telos_proposals' table

        // Drag-Drop State
        let draggedItem = null;  // { id, type: 'idea' | 'proposal', section }
        let pendingRejection = null;  // { id, type, section, newStatus }

        // Category config
        const CATEGORIES = {
            feature: { emoji: '‚ö°', label: 'Feature', color: '#3b82f6' },
            bug: { emoji: 'üêõ', label: 'Bug', color: '#ef4444' },
            app_idea: { emoji: 'üí°', label: 'App Idea', color: '#a855f7' },
            improvement: { emoji: '‚ú®', label: 'Improvement', color: '#22c55e' },
            docs: { emoji: 'üìö', label: 'Docs', color: '#9ca3af' },
            integration: { emoji: 'üîó', label: 'Integration', color: '#14b8a6' },
            tokenomics: { emoji: 'üí∞', label: 'Tokenomics', color: '#ff9500' }
        };

        // Status config
        const STATUSES = {
            submitted: { icon: 'üì•', label: 'Submitted' },
            open_voting: { icon: 'üó≥Ô∏è', label: 'Voting' },
            passed: { icon: '‚úÖ', label: 'Passed' },
            rejected: { icon: '‚ùå', label: 'Rejected' },
            implemented: { icon: 'üöÄ', label: 'Implemented' },
            duplicate: { icon: 'üîÑ', label: 'Duplicate' }
        };

        // Apps list for proposal dropdown
        let factoryApps = [];

        async function loadAppsForDropdown() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/apps?select=slug,name&status=in.(live,approved,published)&order=name`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                if (response.ok) {
                    factoryApps = await response.json();
                    const select = document.getElementById('proposalApp');
                    if (select) {
                        factoryApps.forEach(app => {
                            const option = document.createElement('option');
                            option.value = app.slug;
                            option.textContent = app.name;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (err) {
                console.error('Error loading apps for dropdown:', err);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();  // Wait for user data including is_founder
            loadProposals();
            loadLeaderboard();
            await loadSuiteAppsIdeas();
            await loadGovernanceProposals();
            await loadAppsForDropdown();
            renderGovernanceSections();
            console.log('Initialized. currentUser:', currentUser);
        });

        // Check auth state
        async function checkAuth() {
            // First check for factory_user (legacy)
            const savedUser = localStorage.getItem('factory_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
                return;
            }

            // Check for nav component auth (wallet or telegram)
            const walletAddress = localStorage.getItem('connectedWallet');
            const telegramUser = localStorage.getItem('telegram_user');

            if (walletAddress) {
                console.log('[checkAuth] Found wallet from nav:', walletAddress);
                currentUser = { wallet_address: walletAddress.toLowerCase() };
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
            } else if (telegramUser) {
                const tgUser = JSON.parse(telegramUser);
                console.log('[checkAuth] Found telegram user from nav:', tgUser);
                currentUser = {
                    telegram_id: tgUser.id?.toString(),
                    display_name: tgUser.username || tgUser.first_name
                };
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
            }

            // Check if Stuart and show NoteBox tab
            updateNoteboxVisibility();
        }

        // Stuart's identifiers - only show NoteBox tab for Stuart
        const STUART_WALLET = '0x92d67d8ad8b986e78b369be0272e121ae5acad59';
        const STUART_TELEGRAM_ID = '1202786230';

        function isStuart() {
            if (!currentUser) {
                console.log('[isStuart] No currentUser');
                return false;
            }
            const wallet = currentUser.wallet_address?.toLowerCase();
            const tgId = currentUser.telegram_id?.toString();
            console.log('[isStuart] Checking:', { wallet, tgId, STUART_WALLET, STUART_TELEGRAM_ID });
            console.log('[isStuart] Match:', wallet === STUART_WALLET, tgId === STUART_TELEGRAM_ID);
            return wallet === STUART_WALLET || tgId === STUART_TELEGRAM_ID;
        }

        function updateNoteboxVisibility() {
            const noteboxTab = document.getElementById('noteboxTab');
            const noteboxBadge = document.getElementById('noteboxBadge');
            const showNotebox = isStuart();

            console.log('[NoteBox] Updating visibility:', showNotebox, 'currentUser:', currentUser);

            if (noteboxTab) noteboxTab.style.display = showNotebox ? 'inline-flex' : 'none';
            if (noteboxBadge) noteboxBadge.style.display = showNotebox ? 'block' : 'none';
        }

        // Refresh user data from database
        async function refreshUserData() {
            if (!currentUser) return;

            try {
                let query = '';
                if (currentUser.telegram_id) {
                    query = `telegram_id=eq.${currentUser.telegram_id}`;
                } else if (currentUser.wallet_address) {
                    // Use ilike for case-insensitive matching
                    query = `wallet_address=ilike.${currentUser.wallet_address}`;
                } else {
                    return; // Demo user, no database record
                }

                console.log('[refreshUserData] Query:', query);

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?${query}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const users = await response.json();
                    console.log('[refreshUserData] Found users:', users);
                    if (users.length > 0) {
                        const dbUser = users[0];
                        currentUser = {
                            ...currentUser,
                            id: dbUser.id,
                            reputation: dbUser.reputation,
                            active_submissions: dbUser.active_submissions,
                            is_founder: dbUser.is_founder,
                            display_name: dbUser.display_name,
                            // Also grab linked telegram_id if it exists (for NoteBox sync)
                            telegram_id: dbUser.telegram_id || currentUser.telegram_id
                        };
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        console.log('[refreshUserData] Updated user - rep:', currentUser.reputation, 'telegram_id:', currentUser.telegram_id);
                    } else {
                        console.warn('[refreshUserData] No user found in DB for wallet:', currentUser.wallet_address);
                    }
                } else {
                    console.error('[refreshUserData] Fetch failed:', await response.text());
                }
            } catch (err) {
                console.error('Error refreshing user data:', err);
            }
        }

        // Update user panel based on auth state
        function updateUserPanel() {
            const panel = document.getElementById('userPanel');
            if (currentUser) {
                // User is connected - panel is empty since wallet shown in nav
                panel.innerHTML = '';
                document.getElementById('userRep').textContent = currentUser.reputation || 0;
                const limit = 5 + Math.min(Math.floor((currentUser.reputation || 0) / 100), 10);
                document.getElementById('userSubmissions').textContent = `${currentUser.active_submissions || 0} / ${limit}`;
            } else {
                panel.innerHTML = '<button class="auth-btn" onclick="showAuthModal()">Connect</button>';
            }

            // Also update NoteBox view if on that tab
            if (currentTab === 'notebox') {
                updateNoteboxView();
            }
        }

        // Load proposals from Supabase
        async function loadProposals() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_proposals?select=*,author:factory_users(id,display_name,reputation)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    proposals = await response.json();
                    // Old kanban removed - sections now render via renderGovernanceSections()
                }
            } catch (err) {
                console.error('Error loading proposals:', err);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?select=id,display_name,telegram_id,wallet_address,reputation,is_founder,active_submissions&order=reputation.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    users = await response.json();
                    renderLeaderboard();
                }
            } catch (err) {
                console.error('Error loading leaderboard:', err);
            }
        }

        // Render leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem;">No contributors yet. Be the first!</p>';
                return;
            }

            const rankMedals = ['ü•á', 'ü•à', 'ü•â'];
            const rankClasses = ['gold', 'silver', 'bronze'];

            container.innerHTML = users.map((user, i) => {
                const medal = i < 3 ? rankMedals[i] : `#${i + 1}`;
                const rankClass = i < 3 ? rankClasses[i] : '';
                // Show telegram_id if available, otherwise wallet address
                const userIdentity = user.telegram_id || (user.wallet_address ? `${user.wallet_address.slice(0, 6)}...${user.wallet_address.slice(-4)}` : 'Anonymous');

                return `
                    <div class="leaderboard-item ${rankClass}">
                        <span class="leaderboard-rank">${medal}</span>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(userIdentity)}</div>
                            <div class="leaderboard-stats">
                                <span>${user.active_submissions || 0} proposals</span>
                            </div>
                        </div>
                        <div class="leaderboard-rep">
                            <span>${user.reputation} REP</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load SUITE Apps from ideas table (same as /apps page)
        async function loadSuiteAppsIdeas() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/ideas?select=*&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    suiteAppsIdeas = await response.json();
                    console.log('Loaded', suiteAppsIdeas.length, 'SUITE app ideas');
                }
            } catch (err) {
                console.error('Error loading SUITE apps ideas:', err);
            }
        }

        // Load governance proposals (Business, Content, Social sections)
        async function loadGovernanceProposals() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_proposals?select=*,author:factory_users(id,display_name,reputation)&section=in.(business,content,social)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    governanceProposals = await response.json();
                    console.log('Loaded', governanceProposals.length, 'governance proposals');
                }
            } catch (err) {
                console.error('Error loading governance proposals:', err);
            }
        }

        // Render all governance sections
        function renderGovernanceSections() {
            console.log('[renderGovernanceSections] currentUser:', currentUser, 'is_founder:', currentUser?.is_founder);
            renderSuiteAppsSection();
            renderGovernanceSection('business', 'businessKanban', 'businessCount');
            renderGovernanceSection('content', 'contentKanban', 'contentSectionCount');
            renderGovernanceSection('social', 'socialKanban', 'socialCount');
        }

        // Render SUITE Apps section (from ideas table)
        function renderSuiteAppsSection() {
            const building = suiteAppsIdeas.filter(i => i.status === 'building');
            const considering = suiteAppsIdeas.filter(i => i.status === 'considering');
            const live = suiteAppsIdeas.filter(i => i.status === 'live');
            const rejected = suiteAppsIdeas.filter(i => i.status === 'rejected');

            document.getElementById('suiteAppsCount').textContent = suiteAppsIdeas.length;

            document.getElementById('suiteAppsKanban').innerHTML = `
                <div class="section-column" data-status="considering" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'considering', 'suite_apps')">
                    <div class="section-column-header">ü§î Considering <span>(${considering.length})</span></div>
                    <button class="section-add-btn" onclick="showSubmitModal('suite_apps')">+ New Proposal</button>
                    ${considering.map(renderIdeaCard).join('') || '<div class="empty-column">No ideas under consideration</div>'}
                </div>
                <div class="section-column" data-status="building" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'building', 'suite_apps')">
                    <div class="section-column-header">üî® Building <span>(${building.length})</span></div>
                    ${building.map(renderIdeaCard).join('') || '<div class="empty-column">No ideas being built</div>'}
                </div>
                <div class="section-column" data-status="live" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'live', 'suite_apps')">
                    <div class="section-column-header">üöÄ Live <span>(${live.length})</span></div>
                    ${live.map(renderIdeaCard).join('') || '<div class="empty-column">No launched apps</div>'}
                </div>
                <div class="section-column" data-status="rejected" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'rejected', 'suite_apps')">
                    <div class="section-column-header">‚ùå Rejected <span>(${rejected.length})</span></div>
                    ${rejected.map(renderIdeaCard).join('') || '<div class="empty-column">No rejected ideas</div>'}
                </div>
            `;
        }

        // Render a single idea card (from ideas table)
        function renderIdeaCard(idea) {
            const categoryEmojis = {
                productivity: 'üìã',
                health: 'üí™',
                finance: 'üí∞',
                entertainment: 'üéÆ',
                education: 'üìö',
                utilities: 'üîß',
                social: 'üë•'
            };

            const categoryEmoji = categoryEmojis[idea.category] || 'üì±';
            const formattedDate = new Date(idea.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const authorName = idea.author?.display_name || idea.author_name || 'SUITE';
            const isAdmin = currentUser?.is_founder || false;
            const rejectionReason = idea.rejection_reason || idea.reject_reason;

            return `
                <div class="idea-card ${idea.status}" draggable="${isAdmin ? 'true' : 'false'}" ondragstart="handleDragStart(event, '${idea.id}', 'idea', 'suite_apps')" ondragend="handleDragEnd(event)">
                    ${isAdmin ? `<button class="card-delete-btn" onclick="showDeleteModal('${idea.id}', 'idea')" title="Delete">&times;</button>` : ''}
                    <div class="idea-card-title">${escapeHtml(idea.name)}</div>
                    <div class="idea-card-tagline">${escapeHtml(idea.tagline || idea.description || 'No description')}</div>
                    <div class="idea-card-meta">
                        <span>üë§ ${escapeHtml(authorName)}</span>
                        <span>${categoryEmoji} ${idea.category || 'App'}</span>
                        <span>üìÖ ${formattedDate}</span>
                    </div>
                    ${idea.status === 'rejected' && rejectionReason ? `<div class="rejection-reason">${escapeHtml(rejectionReason)}</div>` : ''}
                </div>
            `;
        }

        // Render governance section (for Business, Content, Social)
        function renderGovernanceSection(sectionType, containerId, countId) {
            const sectionProposals = governanceProposals.filter(p => p.section === sectionType);
            const submitted = sectionProposals.filter(p => p.status === 'submitted');
            const voting = sectionProposals.filter(p => p.status === 'open_voting');
            const passed = sectionProposals.filter(p => p.status === 'passed' || p.status === 'implemented');
            const rejected = sectionProposals.filter(p => p.status === 'rejected');

            document.getElementById(countId).textContent = sectionProposals.length;

            document.getElementById(containerId).innerHTML = `
                <div class="section-column" data-status="submitted" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'submitted', '${sectionType}')">
                    <div class="section-column-header">üì• Submitted <span>(${submitted.length})</span></div>
                    <button class="section-add-btn" onclick="showSubmitModal('${sectionType}')">+ New Proposal</button>
                    ${submitted.map(p => renderGovernanceProposalCard(p, sectionType)).join('') || '<div class="empty-column">No proposals</div>'}
                </div>
                <div class="section-column" data-status="open_voting" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'open_voting', '${sectionType}')">
                    <div class="section-column-header">üó≥Ô∏è Voting <span>(${voting.length})</span></div>
                    ${voting.map(p => renderGovernanceProposalCard(p, sectionType)).join('') || '<div class="empty-column">No proposals</div>'}
                </div>
                <div class="section-column" data-status="passed" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'passed', '${sectionType}')">
                    <div class="section-column-header">‚úÖ Passed <span>(${passed.length})</span></div>
                    ${passed.map(p => renderGovernanceProposalCard(p, sectionType)).join('') || '<div class="empty-column">No proposals</div>'}
                </div>
                <div class="section-column" data-status="rejected" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'rejected', '${sectionType}')">
                    <div class="section-column-header">‚ùå Rejected <span>(${rejected.length})</span></div>
                    ${rejected.map(p => renderGovernanceProposalCard(p, sectionType)).join('') || '<div class="empty-column">No proposals</div>'}
                </div>
            `;
        }

        // Render a governance proposal card
        function renderGovernanceProposalCard(proposal, sectionType) {
            const category = CATEGORIES[proposal.category] || { emoji: 'üìã', label: 'General' };
            const formattedDate = new Date(proposal.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const authorName = proposal.author?.display_name || proposal.author_name || 'Anonymous';
            const isAdmin = currentUser?.is_founder;
            const votesFor = proposal.votes_for || 0;
            const votesAgainst = proposal.votes_against || 0;
            const userVoteCount = getUserVoteCount(proposal.id);
            const nextVoteCost = getVoteCost(userVoteCount + 1);
            const canVote = currentUser && ['submitted', 'open_voting'].includes(proposal.status);

            const rejectionReason = proposal.reject_reason || proposal.rejection_reason;

            // Get app name if proposal is linked to an app
            const linkedApp = proposal.app_slug ? factoryApps.find(a => a.slug === proposal.app_slug) : null;
            const appTag = linkedApp ? `<span class="proposal-app-tag">üì± ${escapeHtml(linkedApp.name)}</span>` : '';

            return `
                <div class="idea-card ${proposal.status}" draggable="${isAdmin ? 'true' : 'false'}" ondragstart="handleDragStart(event, '${proposal.id}', 'proposal', '${sectionType}')" ondragend="handleDragEnd(event)">
                    ${isAdmin ? `<button class="card-delete-btn" onclick="showDeleteModal('${proposal.id}', 'proposal')" title="Delete">&times;</button>` : ''}
                    ${appTag}
                    <div class="idea-card-title">${escapeHtml(proposal.title)}</div>
                    <div class="idea-card-tagline">${escapeHtml(proposal.content || 'No description')}</div>
                    <div class="idea-card-meta">
                        <span>üë§ ${escapeHtml(authorName)}</span>
                        <span>${category.emoji} ${category.label}</span>
                        <span>üìÖ ${formattedDate}</span>
                    </div>
                    ${proposal.status === 'rejected' && rejectionReason ? `<div class="rejection-reason">${escapeHtml(rejectionReason)}</div>` : ''}
                    <div class="vote-buttons">
                        <button class="vote-btn for" onclick="addVote('${proposal.id}')" ${!canVote ? 'disabled' : ''} title="Add vote (${nextVoteCost === 0 ? 'FREE' : nextVoteCost + ' REP'})">
                            üëç <span class="vote-count">${votesFor}</span>
                        </button>
                        <button class="vote-btn against" onclick="removeVote('${proposal.id}')" ${!canVote || userVoteCount === 0 ? 'disabled' : ''} title="Remove vote (+${userVoteCount > 0 ? getRefundAmount(userVoteCount) : 0} REP)">
                            üëé <span class="vote-count">${userVoteCount}</span>
                        </button>
                        ${userVoteCount > 0 ? `<span class="your-votes">${userVoteCount} vote${userVoteCount > 1 ? 's' : ''} ¬∑ ${nextVoteCost} REP next</span>` : `<span class="your-votes">${nextVoteCost === 0 ? 'First vote FREE' : nextVoteCost + ' REP'}</span>`}
                    </div>
                </div>
            `;
        }

        // Drag and Drop Handlers
        function handleDragStart(event, id, type, section) {
            // Only founders/admins can drag
            if (!currentUser || !currentUser.is_founder) {
                console.log('[DragStart] Blocked - not admin');
                event.preventDefault();
                return;
            }
            console.log('[DragStart]', { id, type, section, user: currentUser });
            draggedItem = { id, type, section };
            event.target.classList.add('dragging');
            event.dataTransfer.setData('text/plain', id);  // Required for drag to work
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(event) {
            console.log('[DragEnd] Drag ended. draggedItem was:', draggedItem);
            event.target.classList.remove('dragging');
            draggedItem = null;
            // Remove drag-over class from all columns
            document.querySelectorAll('.section-column').forEach(col => col.classList.remove('drag-over'));
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newStatus, section) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            console.log('[handleDrop called]', { newStatus, section, draggedItem, currentUser, isFounder: currentUser?.is_founder });

            // Block non-admins from dropping
            if (!currentUser || !currentUser.is_founder) {
                console.log('[Drop] Blocked - not admin');
                return;
            }

            if (!draggedItem) {
                console.log('[Drop] No draggedItem!');
                return;
            }

            // Only allow drops in the same section type
            if (draggedItem.section !== section) {
                alert('Cannot move items between different sections');
                return;
            }

            // If dropping on rejected, show rejection reason modal
            if (newStatus === 'rejected') {
                pendingRejection = { ...draggedItem, newStatus };
                showRejectionModal();
                return;
            }

            // Otherwise, update status directly
            updateItemStatus(draggedItem.id, draggedItem.type, draggedItem.section, newStatus, null);
        }

        function showRejectionModal() {
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionModal').classList.add('active');
        }

        function hideRejectionModal() {
            document.getElementById('rejectionModal').classList.remove('active');
            pendingRejection = null;
        }

        async function confirmRejection() {
            const reason = document.getElementById('rejectionReason').value.trim();
            if (!reason) {
                alert('Please provide a rejection reason');
                return;
            }

            if (!pendingRejection) return;

            await updateItemStatus(
                pendingRejection.id,
                pendingRejection.type,
                pendingRejection.section,
                pendingRejection.newStatus,
                reason
            );

            hideRejectionModal();
        }

        async function updateItemStatus(id, type, section, newStatus, rejectionReason) {
            console.log('[updateItemStatus]', { id, type, section, newStatus, rejectionReason });

            // Only founders can update status
            if (!currentUser || !currentUser.is_founder) {
                console.log('[updateItemStatus] Blocked - not admin');
                alert('Only admins can move proposals');
                return;
            }

            try {
                let table, updateData;

                if (section === 'suite_apps') {
                    table = 'ideas';
                    updateData = { status: newStatus };
                    if (rejectionReason) {
                        updateData.rejection_reason = rejectionReason;
                    }
                } else {
                    table = 'factory_proposals';
                    updateData = { status: newStatus };
                    if (rejectionReason) {
                        updateData.reject_reason = rejectionReason;
                    }
                }

                console.log('[updateItemStatus] Updating table:', table, 'with data:', updateData);
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                console.log('[updateItemStatus] Response status:', response.status);
                if (response.ok) {
                    console.log('[updateItemStatus] Success! Reloading data...');
                    // Reload and re-render
                    if (section === 'suite_apps') {
                        await loadSuiteAppsIdeas();
                    } else {
                        await loadGovernanceProposals();
                    }
                    console.log('[updateItemStatus] Re-rendering...');
                    renderGovernanceSections();
                    console.log('[updateItemStatus] Done!');
                } else {
                    const errorText = await response.text();
                    console.error('Failed to update status:', errorText);
                    alert('Failed to update status: ' + errorText);
                }
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Error updating status');
            }
        }

        // Delete modal state
        let pendingDelete = null; // { id, type: 'proposal' | 'idea' }

        function showDeleteModal(id, type) {
            if (!currentUser?.is_founder) return;
            pendingDelete = { id, type };
            document.getElementById('deleteModal').classList.add('active');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            pendingDelete = null;
        }

        async function confirmDelete() {
            if (!pendingDelete) return;

            const { id, type } = pendingDelete;
            hideDeleteModal();

            try {
                const table = type === 'proposal' ? 'factory_proposals' : 'ideas';
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    if (type === 'proposal') {
                        await loadGovernanceProposals();
                    } else {
                        await loadSuiteAppsIdeas();
                    }
                    renderGovernanceSections();
                } else {
                    console.error('Failed to delete:', await response.text());
                    alert('Failed to delete');
                }
            } catch (err) {
                console.error('Error deleting:', err);
                alert('Error deleting');
            }
        }

        // ===== VIEW SWITCHING (Governance / NoteBox) =====
        let currentMainView = 'governance';

        function switchView(view) {
            currentMainView = view;

            // Update view tab buttons
            document.querySelectorAll('.view-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Toggle views
            const governanceView = document.getElementById('governanceView');
            const noteboxView = document.getElementById('noteboxView');

            if (view === 'governance') {
                governanceView.style.display = 'block';
                noteboxView.style.display = 'none';
            } else {
                governanceView.style.display = 'none';
                noteboxView.style.display = 'block';
                updateNoteboxViewInline();
            }
        }

        function updateNoteboxViewInline() {
            if (currentUser) {
                // User is logged in - show NoteBox app
                document.getElementById('noteboxAuthPromptInline').style.display = 'none';
                document.getElementById('noteboxAppInline').style.display = 'block';
                // Use the main NoteBox loading function and render to inline container
                loadNoteboxIdeasForInline();
            } else {
                // Not logged in - show auth prompt
                document.getElementById('noteboxAuthPromptInline').style.display = 'flex';
                document.getElementById('noteboxAppInline').style.display = 'none';
            }
        }

        async function loadNoteboxIdeasForInline() {
            if (!currentUser) return;

            // Build user_id filters - check both telegram and wallet if available
            const userIds = [];
            if (currentUser.telegram_id) {
                userIds.push(`tg_${currentUser.telegram_id}`);
            }
            if (currentUser.wallet_address) {
                userIds.push(`wallet_${currentUser.wallet_address}`);
            }

            if (userIds.length === 0) {
                console.log('No valid user ID for NoteBox');
                return;
            }

            try {
                // Use 'or' filter to match any of the user IDs
                let url;
                if (userIds.length === 1) {
                    url = `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&user_id=eq.${encodeURIComponent(userIds[0])}&order=created_at.desc`;
                } else {
                    // Multiple IDs - use or filter
                    const orFilter = userIds.map(id => `user_id.eq.${id}`).join(',');
                    url = `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&or=(${encodeURIComponent(orFilter)})&order=created_at.desc`;
                }

                console.log('Loading NoteBox ideas for:', userIds);

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const ideas = await response.json();
                    console.log('Loaded', ideas.length, 'NoteBox ideas');
                    noteboxIdeas = ideas; // Store in global array for Push To functionality
                    renderNoteboxKanbanInline(ideas);
                } else {
                    console.error('Failed to load NoteBox ideas:', await response.text());
                }
            } catch (err) {
                console.error('Error loading NoteBox ideas:', err);
            }
        }

        function renderNoteboxKanbanInline(ideas) {
            const kanban = document.getElementById('noteboxKanbanInline');
            if (!kanban) return;

            // Filter by status
            let activeIdeas = ideas.filter(i => i.status === 'inbox');
            let archivedIdeas = ideas.filter(i => i.status === 'implemented' || i.status === 'dismissed');

            // Group active ideas by category
            const grouped = {};
            activeIdeas.forEach(idea => {
                const cat = idea.category || 'brainstorm';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(idea);
            });

            // Render ALL columns in fixed order (even empty ones)
            let columnsHtml = NOTEBOX_COLUMN_ORDER.map(category => {
                const cat = NOTEBOX_CATEGORIES[category];
                const catIdeas = grouped[category] || [];
                return `
                    <div class="notebox-column" data-category="${category}">
                        <div class="notebox-column-header">
                            <span>${cat.emoji}</span>
                            <span>${cat.label}</span>
                            <span class="notebox-column-count">${catIdeas.length}</span>
                        </div>
                        <div class="notebox-column-cards" data-category="${category}">
                            ${catIdeas.map(idea => renderNoteboxCardInline(idea)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add Archive column
            columnsHtml += `
                <div class="notebox-column archive-column" data-category="archive">
                    <div class="notebox-column-header" style="opacity: 0.7;">
                        <span>üìÅ</span>
                        <span>Archive</span>
                        <span class="notebox-column-count">${archivedIdeas.length}</span>
                    </div>
                    <div class="notebox-column-cards" data-category="archive">
                        ${archivedIdeas.map(idea => renderNoteboxCardInline(idea)).join('')}
                    </div>
                </div>
            `;

            kanban.innerHTML = columnsHtml;

            // Setup drag and drop for inline kanban
            setupDragAndDropInline();
        }

        function setupDragAndDropInline() {
            const kanban = document.getElementById('noteboxKanbanInline');
            if (!kanban) return;

            const cards = kanban.querySelectorAll('.notebox-card[draggable="true"]');
            const dropZones = kanban.querySelectorAll('.notebox-column-cards');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.id);
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    dropZones.forEach(zone => zone.classList.remove('drag-over'));
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const ideaId = e.dataTransfer.getData('text/plain');
                    const newCategory = zone.dataset.category;
                    const draggedCard = kanban.querySelector(`.notebox-card[data-id="${ideaId}"]`);
                    const currentStatus = draggedCard?.dataset?.status;

                    console.log('[Inline Drop]', { ideaId, newCategory, currentStatus });

                    if (newCategory === 'archive') {
                        // Show archive modal for archiving
                        showNoteboxArchiveModal(ideaId, 'done');
                        return;
                    }

                    // If dragging FROM archive back to a category, restore it
                    if (currentStatus === 'implemented' || currentStatus === 'dismissed') {
                        console.log('[Inline Drop] Restoring from archive to', newCategory);
                        try {
                            const response = await fetch(
                                `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ status: 'inbox', category: newCategory })
                                }
                            );
                            if (response.ok) {
                                loadNoteboxIdeasForInline();
                            }
                        } catch (err) {
                            console.error('Error restoring idea:', err);
                        }
                        return;
                    }

                    // Update the idea's category (moving between active categories)
                    try {
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ category: newCategory })
                            }
                        );

                        if (response.ok) {
                            loadNoteboxIdeasForInline();
                        }
                    } catch (err) {
                        console.error('Error updating idea category:', err);
                    }
                });
            });
        }

        function renderNoteboxCardInline(idea) {
            const isArchived = idea.status === 'implemented' || idea.status === 'dismissed';
            return `
                <div class="notebox-card" draggable="true" data-id="${idea.id}" data-status="${idea.status}">
                    <button class="notebox-card-delete" onclick="event.stopPropagation(); deleteNoteboxIdea('${idea.id}')" title="Delete">√ó</button>
                    <div class="notebox-card-title">${idea.title || 'Untitled'}</div>
                    ${idea.content ? `<div class="notebox-card-content">${idea.content}</div>` : ''}
                    ${idea.ai_reason ? `<div class="notebox-card-reason">üí° ${idea.ai_reason}</div>` : ''}
                    ${!isArchived ? `
                        <div class="notebox-card-actions">
                            <button class="notebox-card-btn done" onclick="event.stopPropagation(); showNoteboxArchiveModal('${idea.id}', 'done')">‚úì Done</button>
                            <button class="notebox-card-btn push" onclick="event.stopPropagation(); togglePushDropdown('${idea.id}', event)">Push To ‚Üí</button>
                        </div>
                    ` : `
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 8px;">
                            ${idea.status === 'implemented' ? '‚úì Completed' : '‚úó Dismissed'}
                            ${idea.archive_reason ? `: ${idea.archive_reason}` : ''}
                        </div>
                    `}
                </div>
            `;
        }

        async function addNoteboxIdeaInline() {
            const input = document.getElementById('noteboxQuickInputInline');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            // Get user_id from currentUser (format: tg_xxx or wallet_xxx)
            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/personal_ideas`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        raw_input: text,
                        title: text.length > 60 ? text.slice(0, 60) + '...' : text,
                        category: 'brainstorm',
                        status: 'inbox',
                        user_id: userId
                    })
                });

                if (response.ok) {
                    input.value = '';
                    loadNoteboxIdeasForInline();
                }
            } catch (err) {
                console.error('Error adding idea:', err);
            }
        }

        // Legacy tab switching (kept for compatibility)
        function switchFactoryTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.factory-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab === 'telos' ? 'telosContent' : 'noteboxContent').classList.add('active');

            // Handle NoteBox tab
            if (tab === 'notebox') {
                updateNoteboxView();
            }
        }

        function updateNoteboxView() {
            if (currentUser) {
                // User is logged in - show NoteBox app
                const authPrompt = document.getElementById('noteboxAuthPrompt');
                const app = document.getElementById('noteboxApp');
                if (authPrompt) authPrompt.style.display = 'none';
                if (app) app.style.display = 'flex';
                loadDestinations();
                loadNoteboxIdeas();
            } else {
                // Not logged in - show auth prompt
                const authPrompt = document.getElementById('noteboxAuthPrompt');
                const app = document.getElementById('noteboxApp');
                if (authPrompt) authPrompt.style.display = 'flex';
                if (app) app.style.display = 'none';
            }
        }

        // Show/hide modals
        function showSubmitModal(section = null) {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            // Pre-select section if provided
            if (section) {
                const sectionSelect = document.getElementById('proposalSection');
                if (sectionSelect) {
                    sectionSelect.value = section;
                }
            }
            document.getElementById('submitModal').classList.add('active');
        }

        function hideSubmitModal() {
            document.getElementById('submitModal').classList.remove('active');
            document.getElementById('submitForm').reset();
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        // Connect NoteBox Modal
        function openConnectNoteboxModal() {
            const modal = document.getElementById('connectNoteboxModal');
            const content = document.getElementById('connectNoteboxContent');

            if (currentUser) {
                // User is logged in - show coming soon state
                content.innerHTML = `
                    <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">üì¶</div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;">NoteBox</div>
                        <div style="font-size: 0.85rem; color: var(--accent); font-weight: 600; margin-bottom: 8px;">Coming Soon</div>
                        <div style="font-size: 0.85rem; color: var(--text-dim);">Kanban on the go, powered by AI</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 0.9rem; color: var(--text); margin-bottom: 12px; font-weight: 600;">What you'll be able to do:</div>
                        <ul style="font-size: 0.85rem; color: var(--text-dim); margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Capture ideas on the go via Telegram</li>
                            <li>AI-powered insights and research</li>
                            <li>Create and publish X posts & articles</li>
                            <li>Connect with friends and businesses</li>
                            <li>Collaborate and share ideas back and forth</li>
                            <li>Push directly to Governance</li>
                        </ul>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-dim); text-align: center;">
                        Your personal AI-connected workspace for capturing, creating, and collaborating.
                    </p>
                `;
            } else {
                // User not logged in - prompt to connect
                content.innerHTML = `
                    <p style="margin-bottom: 20px; color: var(--text-dim);">
                        Connect your account to create your personal NoteBox and start contributing.
                    </p>
                    <button class="telegram-btn" onclick="connectTelegram()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: #0088cc; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-bottom: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                        </svg>
                        Connect with Telegram
                    </button>
                    <button onclick="connectWallet()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #627eea, #8b5cf6); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        <span style="font-size: 1.2rem;">üîó</span>
                        Connect Wallet
                    </button>
                `;
            }

            modal.classList.add('active');
        }

        function closeConnectNoteboxModal() {
            document.getElementById('connectNoteboxModal').classList.remove('active');
        }

        async function connectToGetsuiteNotebox() {
            // For now, just show a success message
            // Later this will create the connection in the database
            const content = document.getElementById('connectNoteboxContent');
            content.innerHTML = `
                <div style="color: var(--success); font-size: 2rem; margin-bottom: 12px;">‚úì</div>
                <p style="font-weight: 600; margin-bottom: 8px;">You're connected!</p>
                <p style="font-size: 0.9rem; color: var(--text-dim);">
                    Go to the NoteBox tab and use "Push To ‚Üí" to send ideas to getSuite Governance.
                </p>
            `;
        }

        // Submit proposal via edge function
        async function submitProposal(event) {
            event.preventDefault();
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const section = document.getElementById('proposalSection').value;
            const content = document.getElementById('proposalContent').value.trim();
            const appSlug = document.getElementById('proposalApp').value;

            if (!content) {
                alert('Please describe your idea');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing & Submitting...';

            try {
                const payload = {
                    content,
                    section,
                    app_slug: appSlug || null
                };

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else {
                    // Demo mode - use telegram auth with demo ID
                    payload.telegram_auth = { id: currentUser.id, username: currentUser.display_name };
                }

                console.log('[submitProposal] Sending payload:', payload);

                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-submit`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    // Update local user with returned data
                    if (result.user) {
                        currentUser = { ...currentUser, ...result.user };
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    hideSubmitModal();
                    // Reload governance data and re-render
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                    alert('Proposal submitted! AI generated title and category.');
                } else {
                    console.error('Submit error:', result);
                    alert(result.error || 'Failed to submit proposal.');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error submitting proposal.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // Quick vote via edge function (1 free vote)
        async function quickVote(proposalId, direction) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            // Disable vote buttons temporarily
            const btns = document.querySelectorAll(`.quick-vote-btn`);
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: direction,
                    vote_power: 1
                };

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else {
                    // Demo mode
                    payload.telegram_auth = { id: currentUser.id, username: currentUser.display_name };
                }

                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-vote`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    // Update local user with returned data
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    loadProposals();
                } else {
                    console.error('Vote error:', result);
                    alert(result.error || 'Failed to vote.');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error voting.');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // Award reputation
        async function awardRep(userId, amount, reason, proposalId = null) {
            try {
                // Add to history
                await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_rep_history`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            amount,
                            reason,
                            proposal_id: proposalId
                        })
                    }
                );

                // Update user rep (this should be done via edge function for security)
                // For now, update locally
                if (currentUser && currentUser.id === userId) {
                    currentUser.reputation += amount;
                    localStorage.setItem('factory_user', JSON.stringify(currentUser));
                    updateUserPanel();
                }
            } catch (err) {
                console.error('Error awarding rep:', err);
            }
        }

        // View proposal detail
        function viewProposal(proposalId) {
            // TODO: Open detail modal
            console.log('View proposal:', proposalId);
        }

        // Telegram OAuth
        function connectTelegram() {
            const botUsername = 'suitehubbot';
            const origin = window.location.origin;

            const width = 550;
            const height = 470;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);

            const authUrl = `https://oauth.telegram.org/auth?bot_id=8341049569&origin=${encodeURIComponent(origin)}&request_access=write`;

            const popup = window.open(
                authUrl,
                'telegram_auth',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            window.addEventListener('message', function handleTelegramAuth(event) {
                if (event.origin !== 'https://oauth.telegram.org') return;

                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'auth_result' && data.result) {
                        const user = data.result;

                        // Create factory user object
                        const factoryUser = {
                            id: user.id.toString(),
                            telegram_id: user.id.toString(),
                            display_name: user.username || user.first_name,
                            reputation: 0,
                            active_submissions: 0
                        };

                        currentUser = factoryUser;
                        localStorage.setItem('factory_user', JSON.stringify(factoryUser));
                        localStorage.setItem('telegram_user', JSON.stringify(user));

                        hideAuthModal();
                        updateUserPanel();
                        loadLeaderboard(); // Refresh to show user
                        renderGovernanceSections(); // Re-render to enable drag and drop
                        updateNoteboxVisibility(); // Show NoteBox tab if Stuart

                        window.removeEventListener('message', handleTelegramAuth);
                    }
                } catch (e) {
                    console.error('Telegram auth error:', e);
                }
            });

            if (!popup || popup.closed) {
                alert('Popup was blocked. Please allow popups for this site.');
            }
        }

        // Wallet connect via MetaMask
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const address = accounts[0].toLowerCase();
                    const displayName = `${address.slice(0, 6)}...${address.slice(-4)}`;

                    const walletUser = {
                        id: address,
                        wallet_address: address,
                        display_name: displayName,
                        reputation: 0,
                        active_submissions: 0
                    };

                    currentUser = walletUser;
                    localStorage.setItem('factory_user', JSON.stringify(walletUser));
                    localStorage.setItem('connectedWallet', address);

                    hideAuthModal();
                    // Fetch actual user data from database (including rep)
                    await refreshUserData();
                    updateUserPanel();
                    loadLeaderboard();
                    renderGovernanceSections(); // Re-render to enable drag and drop
                    updateNoteboxVisibility(); // Show NoteBox tab if Stuart
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    console.log('Connection cancelled by user');
                } else {
                    alert('Failed to connect wallet. Please try again.');
                }
            }
        }

        // Demo mode for testing
        function connectDemo() {
            const demoUser = {
                id: 'demo_' + Date.now(),
                display_name: 'Demo User',
                reputation: 0,
                active_submissions: 0
            };
            currentUser = demoUser;
            localStorage.setItem('factory_user', JSON.stringify(demoUser));
            hideAuthModal();
            updateUserPanel();
            renderGovernanceSections(); // Re-render to enable drag and drop
            updateNoteboxVisibility(); // Update NoteBox visibility
        }

        // User menu (logout)
        function showUserMenu() {
            // Build menu options
            let menuText = `üë§ ${currentUser.display_name}\n`;
            menuText += `‚≠ê ${currentUser.reputation || 0} REP\n\n`;

            // Show linked accounts status
            menuText += `Linked Accounts:\n`;
            menuText += currentUser.telegram_id ? `‚úÖ Telegram: ${currentUser.telegram_id}\n` : `‚ùå Telegram: Not linked\n`;
            menuText += currentUser.wallet_address ? `‚úÖ Wallet: ${currentUser.wallet_address.slice(0,6)}...${currentUser.wallet_address.slice(-4)}\n` : `‚ùå Wallet: Not linked\n`;
            menuText += `\n`;

            // Determine what actions to offer
            const canLinkTelegram = !currentUser.telegram_id && currentUser.wallet_address;
            const canLinkWallet = !currentUser.wallet_address && currentUser.telegram_id;

            if (canLinkTelegram) {
                menuText += `Press OK to link your Telegram account, or Cancel to logout.`;
                if (confirm(menuText)) {
                    linkTelegramAccount();
                    return;
                }
            } else if (canLinkWallet) {
                menuText += `Press OK to link your Wallet, or Cancel to logout.`;
                if (confirm(menuText)) {
                    linkWalletAccount();
                    return;
                }
            } else {
                menuText += `Press OK to logout.`;
                if (!confirm(menuText)) return;
            }

            // Logout
            currentUser = null;
            localStorage.removeItem('factory_user');
            localStorage.removeItem('telegram_user');
            localStorage.removeItem('connectedWallet');
            updateUserPanel();
            loadLeaderboard();
            renderGovernanceSections();
        }

        // Link Telegram to existing wallet account
        async function linkTelegramAccount() {
            const origin = window.location.origin;
            const width = 550;
            const height = 470;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);

            const authUrl = `https://oauth.telegram.org/auth?bot_id=8341049569&origin=${encodeURIComponent(origin)}&request_access=write`;

            const popup = window.open(
                authUrl,
                'telegram_auth',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            window.addEventListener('message', async function handleTelegramLink(event) {
                if (event.origin !== 'https://oauth.telegram.org') return;

                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'auth_result' && data.result) {
                        const telegramUser = data.result;
                        const telegramId = telegramUser.id.toString();

                        // Update the existing factory_users record to add telegram_id
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/factory_users?wallet_address=eq.${currentUser.wallet_address}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify({ telegram_id: telegramId })
                            }
                        );

                        if (response.ok) {
                            currentUser.telegram_id = telegramId;
                            localStorage.setItem('factory_user', JSON.stringify(currentUser));
                            localStorage.setItem('telegram_user', JSON.stringify(telegramUser));
                            alert('‚úÖ Telegram account linked successfully!');
                            updateUserPanel();
                            // Reload NoteBox to show Telegram ideas
                            if (document.getElementById('noteboxKanbanInline')) {
                                loadNoteboxIdeasForInline();
                            }
                        } else {
                            console.error('Failed to link Telegram:', await response.text());
                            alert('Failed to link Telegram account. Try again.');
                        }

                        window.removeEventListener('message', handleTelegramLink);
                    }
                } catch (e) {
                    console.error('Telegram link error:', e);
                }
            });
        }

        // Link Wallet to existing Telegram account
        async function linkWalletAccount() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet!');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const walletAddress = accounts[0].toLowerCase();

                    // Update the existing factory_users record to add wallet_address
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/factory_users?telegram_id=eq.${currentUser.telegram_id}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({ wallet_address: walletAddress })
                        }
                    );

                    if (response.ok) {
                        currentUser.wallet_address = walletAddress;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        localStorage.setItem('connectedWallet', walletAddress);
                        alert('‚úÖ Wallet linked successfully!');
                        updateUserPanel();
                    } else {
                        console.error('Failed to link wallet:', await response.text());
                        alert('Failed to link wallet. Try again.');
                    }
                }
            } catch (error) {
                console.error('Wallet link error:', error);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Quadratic voting cost formula: cost(n) = n * (n-1) / 2
        function getVoteCost(voteNumber) {
            if (voteNumber <= 1) return 0; // First vote is free
            return Math.floor(voteNumber * (voteNumber - 1) / 2);
        }

        // Get user's vote count for a proposal
        function getUserVoteCount(proposalId) {
            return userVotes[proposalId] || 0;
        }

        // Get refund amount for removing a vote (reverse of cost)
        function getRefundAmount(currentVotes) {
            if (currentVotes <= 1) return 0; // First vote was free, no refund
            return Math.floor(currentVotes * (currentVotes - 1) / 2);
        }

        // Add a vote directly (no modal)
        async function addVote(proposalId) {
            if (!currentUser) {
                alert('Please connect your wallet or Telegram to vote');
                return;
            }

            const currentVotes = getUserVoteCount(proposalId);
            const cost = getVoteCost(currentVotes + 1);
            const userRep = currentUser.reputation || 0;

            if (cost > userRep) {
                alert(`Not enough REP! You need ${cost} REP but have ${userRep}.`);
                return;
            }

            // Disable all vote buttons temporarily
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'for',
                    vote_power: 1
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    userVotes[proposalId] = (userVotes[proposalId] || 0) + 1;
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    alert(result.error || 'Failed to add vote');
                }
            } catch (err) {
                console.error('Vote error:', err);
                alert('Error adding vote');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // Remove a vote and refund REP
        async function removeVote(proposalId) {
            if (!currentUser) {
                alert('Please connect your wallet or Telegram');
                return;
            }

            const currentVotes = getUserVoteCount(proposalId);
            if (currentVotes <= 0) {
                alert('No votes to remove');
                return;
            }

            const refund = getRefundAmount(currentVotes);

            // Disable all vote buttons temporarily
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'remove',
                    vote_power: 1
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    userVotes[proposalId] = Math.max(0, (userVotes[proposalId] || 0) - 1);
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    alert(result.error || 'Failed to remove vote');
                }
            } catch (err) {
                console.error('Remove vote error:', err);
                alert('Error removing vote');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // Load user's votes from database
        async function loadUserVotes() {
            if (!currentUser) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${currentUser.id}&select=proposal_id,vote_power`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const votes = await response.json();
                    userVotes = {};
                    votes.forEach(v => {
                        userVotes[v.proposal_id] = (userVotes[v.proposal_id] || 0) + v.vote_power;
                    });
                }
            } catch (error) {
                console.error('Failed to load user votes:', error);
            }
        }

        // Show vote modal
        function showVoteModal(proposalId, voteType) {
            if (!currentUser) {
                alert('Please connect your wallet or Telegram to vote');
                return;
            }

            pendingVote = { proposalId, voteType };
            const currentVotes = getUserVoteCount(proposalId);
            const nextCost = getVoteCost(currentVotes + 1);
            const userRep = currentUser.reputation || 0;

            document.getElementById('voteProposalId').textContent = proposalId.slice(0, 8) + '...';
            document.getElementById('voteCurrentCount').textContent = currentVotes;
            document.getElementById('voteNextCost').textContent = nextCost === 0 ? 'FREE' : nextCost + ' REP';
            document.getElementById('voteUserRep').textContent = userRep;
            document.getElementById('voteTypeFor').checked = voteType === 'for';
            document.getElementById('voteTypeAgainst').checked = voteType === 'against';

            // Enable/disable submit based on rep
            const submitBtn = document.getElementById('voteSubmitBtn');
            if (nextCost > userRep) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Not enough REP';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = nextCost === 0 ? 'Cast Vote (FREE)' : `Cast Vote (${nextCost} REP)`;
            }

            document.getElementById('voteModal').classList.add('active');
        }

        function hideVoteModal() {
            document.getElementById('voteModal').classList.remove('active');
            pendingVote = null;
        }

        // Submit vote to edge function
        async function submitVote() {
            if (!pendingVote || !currentUser) return;

            const { proposalId, voteType } = pendingVote;
            const selectedType = document.querySelector('input[name="voteType"]:checked').value;

            const submitBtn = document.getElementById('voteSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        proposal_id: proposalId,
                        vote_type: selectedType,
                        wallet_address: currentUser.wallet_address,
                        telegram_auth: currentUser.telegram_id ? { id: currentUser.telegram_id } : null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to submit vote');
                }

                // Update local state
                userVotes[proposalId] = (userVotes[proposalId] || 0) + 1;
                if (data.user) {
                    currentUser.reputation = data.user.reputation;
                    document.getElementById('userRep').textContent = data.user.reputation;
                }

                hideVoteModal();

                // Reload proposals to show updated counts
                await loadGovernanceProposals();
                renderGovernanceSections();

            } catch (error) {
                console.error('Vote error:', error);
                alert('Failed to submit vote: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Try Again';
            }
        }

        // ===== NOTEBOX FUNCTIONS =====
        const NOTEBOX_CATEGORIES = {
            action_item: { emoji: '‚úÖ', label: 'Action' },
            suite_feature: { emoji: '‚ö°', label: 'SUITE' },
            suite_business: { emoji: 'üí∞', label: 'Business' },
            app_idea: { emoji: 'üí°', label: 'App Idea' },
            article: { emoji: 'üìù', label: 'Article' },
            personal: { emoji: 'üè†', label: 'Personal' },
            brainstorm: { emoji: 'üí≠', label: 'Brainstorm' },
            question: { emoji: '‚ùì', label: 'Question' }
        };

        // Fixed column order
        const NOTEBOX_COLUMN_ORDER = ['action_item', 'suite_feature', 'suite_business', 'app_idea', 'article', 'personal', 'brainstorm', 'question'];

        async function loadNoteboxIdeas() {
            if (!currentUser) return;

            // Get user_id from currentUser (format: tg_xxx or wallet_xxx)
            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) {
                console.log('No valid user ID for NoteBox');
                return;
            }

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&user_id=eq.${encodeURIComponent(userId)}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    noteboxIdeas = await response.json();
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                } else {
                    console.error('Failed to load NoteBox ideas:', await response.text());
                }
            } catch (err) {
                console.error('Error loading NoteBox ideas:', err);
            }
        }

        function updateNoteboxCounts() {
            // Update sidebar counts
            renderDestinationsSidebar();
        }

        function renderNoteboxKanban() {
            const container = document.getElementById('noteboxKanban');
            if (!container) return; // Not in NoteBox view

            // Filter by destination
            let activeIdeas = noteboxIdeas.filter(i => i.status === 'inbox');
            let archivedIdeas = noteboxIdeas.filter(i => i.status === 'implemented' || i.status === 'dismissed');

            // Apply destination filter
            if (currentDestination !== 'all') {
                activeIdeas = activeIdeas.filter(i => i.destination_slug === currentDestination);
                archivedIdeas = archivedIdeas.filter(i => i.destination_slug === currentDestination);
            }

            if (activeIdeas.length === 0 && archivedIdeas.length === 0) {
                const destName = currentDestination === 'all' ? 'NoteBox' :
                    (noteboxDestinations.find(d => d.slug === currentDestination)?.name || currentDestination);
                container.innerHTML = `
                    <div class="notebox-empty">
                        <div class="notebox-empty-icon">üì¶</div>
                        <div>No ideas in ${destName} yet. Add one above!</div>
                    </div>
                `;
                return;
            }

            // Group active ideas by category for display
            const grouped = {};
            activeIdeas.forEach(idea => {
                const cat = idea.category || 'brainstorm';
                if (!grouped[cat]) {
                    grouped[cat] = [];
                }
                grouped[cat].push(idea);
            });

            // Render grouped columns + Archive column
            let columnsHtml = Object.entries(grouped).map(([category, ideas]) => {
                const cat = NOTEBOX_CATEGORIES[category] || { emoji: 'üìù', label: category };
                return `
                    <div class="notebox-column" data-category="${category}">
                        <div class="notebox-column-header">
                            <span>${cat.emoji}</span>
                            <span>${cat.label}</span>
                            <span class="notebox-column-count">${ideas.length}</span>
                        </div>
                        <div class="notebox-column-cards" data-category="${category}">
                            ${ideas.map(idea => renderNoteboxCard(idea)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add Archive column at the end
            columnsHtml += `
                <div class="notebox-column archive-column" data-category="archive">
                    <div class="notebox-column-header" style="opacity: 0.7;">
                        <span>üìÅ</span>
                        <span>Archive</span>
                        <span class="notebox-column-count">${archivedIdeas.length}</span>
                    </div>
                    <div class="notebox-column-cards" data-category="archive">
                        ${archivedIdeas.map(idea => renderNoteboxCard(idea)).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = columnsHtml;

            // Setup drag and drop
            setupDragAndDrop();
        }

        function renderNoteboxCard(idea) {
            const cat = NOTEBOX_CATEGORIES[idea.category] || { emoji: 'üìù', label: idea.category };
            const isArchived = idea.status === 'implemented' || idea.status === 'dismissed';
            return `
                <div class="notebox-card" draggable="true" data-id="${idea.id}" data-status="${idea.status}">
                    <button class="notebox-card-delete" onclick="event.stopPropagation(); deleteNoteboxIdea('${idea.id}')" title="Delete">√ó</button>
                    <div class="notebox-card-header">
                        <span class="notebox-card-emoji">${cat.emoji}</span>
                        <span class="notebox-card-category">${cat.label}</span>
                    </div>
                    <div class="notebox-card-title">${escapeHtml(idea.title)}</div>
                    ${idea.content ? `<div class="notebox-card-content">${escapeHtml(idea.content)}</div>` : ''}
                    ${idea.status === 'inbox' ? `
                        <div class="notebox-card-actions">
                            <button class="notebox-card-btn push" onclick="event.stopPropagation(); togglePushDropdown('${idea.id}', event)">Push To ‚Üí</button>
                            <button class="notebox-card-btn done" onclick="markNoteboxDone('${idea.id}')">‚úì</button>
                        </div>
                    ` : `
                        ${idea.dismiss_reason ? `<div class="notebox-card-reason">${escapeHtml(idea.dismiss_reason)}</div>` : ''}
                        <div class="notebox-card-status">
                            <span style="font-size: 0.75rem; color: var(--text-dim);">${idea.status === 'implemented' ? '‚úì Completed' : '‚úï Dismissed'}</span>
                        </div>
                    `}
                </div>
            `;
        }

        // Drag and drop functionality
        let draggedCard = null;

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.notebox-card[draggable="true"]');
            const dropZones = document.querySelectorAll('.notebox-column-cards');
            console.log('[setupDragAndDrop] Found', cards.length, 'cards and', dropZones.length, 'drop zones');

            cards.forEach(card => {
                card.addEventListener('dragstart', noteboxHandleDragStart);
                card.addEventListener('dragend', noteboxHandleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', noteboxHandleDragOver);
                zone.addEventListener('dragenter', noteboxHandleDragEnter);
                zone.addEventListener('dragleave', noteboxHandleDragLeave);
                zone.addEventListener('drop', noteboxHandleDrop);
            });
        }

        function noteboxHandleDragStart(e) {
            console.log('[NoteBox DragStart]', e.target.dataset.id);
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }

        function noteboxHandleDragEnd(e) {
            console.log('[NoteBox DragEnd]', draggedCard?.dataset?.id);
            e.target.classList.remove('dragging');
            document.querySelectorAll('.notebox-column-cards').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedCard = null;
        }

        function noteboxHandleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function noteboxHandleDragEnter(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.notebox-column-cards');
            if (dropZone) {
                dropZone.classList.add('drag-over');
            }
        }

        function noteboxHandleDragLeave(e) {
            const dropZone = e.target.closest('.notebox-column-cards');
            if (dropZone && !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        }

        async function noteboxHandleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.notebox-column-cards');
            console.log('[NoteBox Drop]', { dropZone: dropZone?.dataset?.category, draggedCard: draggedCard?.dataset });
            if (!dropZone || !draggedCard) {
                console.log('[NoteBox Drop] No dropZone or draggedCard!');
                return;
            }

            dropZone.classList.remove('drag-over');

            const ideaId = draggedCard.dataset.id;
            const targetCategory = dropZone.dataset.category;
            const currentStatus = draggedCard.dataset.status;
            console.log('[NoteBox Drop] Moving:', { ideaId, from: currentStatus, to: targetCategory });

            // If dropping to archive, mark as implemented
            if (targetCategory === 'archive' && currentStatus === 'inbox') {
                console.log('[NoteBox Drop] -> Archive');
                await archiveNoteboxIdea(ideaId, 'implemented', 'Moved to archive');
                return;
            }

            // If dropping from archive back to a category, restore it
            if (targetCategory !== 'archive' && (currentStatus === 'implemented' || currentStatus === 'dismissed')) {
                console.log('[NoteBox Drop] -> Restore from archive to', targetCategory);
                await updateNoteboxIdea(ideaId, { status: 'inbox', category: targetCategory });
                return;
            }

            // If moving between active categories, just update category
            if (targetCategory !== 'archive' && currentStatus === 'inbox') {
                console.log('[NoteBox Drop] -> Change category to', targetCategory);
                await updateNoteboxIdea(ideaId, { category: targetCategory });
            }
        }

        async function updateNoteboxIdea(ideaId, updates) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    }
                );

                if (response.ok) {
                    // Update local data
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        Object.assign(idea, updates);
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error updating idea:', err);
            }
        }

        async function archiveNoteboxIdea(ideaId, status, reason) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            dismiss_reason: reason
                        })
                    }
                );

                if (response.ok) {
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        idea.status = status;
                        idea.dismiss_reason = reason;
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error archiving idea:', err);
            }
        }

        async function deleteNoteboxIdea(ideaId) {
            console.log('[deleteNoteboxIdea] Deleting:', ideaId);
            if (!confirm('Delete this idea permanently?')) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                console.log('[deleteNoteboxIdea] Response:', response.status);
                if (response.ok) {
                    noteboxIdeas = noteboxIdeas.filter(i => i.id !== ideaId);
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                    console.log('[deleteNoteboxIdea] Done!');
                } else {
                    console.error('[deleteNoteboxIdea] Failed:', await response.text());
                }
            } catch (err) {
                console.error('Error deleting idea:', err);
            }
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // DESTINATIONS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        async function loadDestinations() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/intake_destinations?active=eq.true&order=sort_order`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    noteboxDestinations = await response.json();
                    renderDestinationsSidebar();
                }
            } catch (err) {
                console.error('Error loading destinations:', err);
            }
        }

        function renderDestinationsSidebar() {
            const container = document.getElementById('noteboxDestinations');
            if (!container) return; // Not in NoteBox view

            // Add "All" option first
            let html = `
                <button class="filter-btn ${currentDestination === 'all' ? 'active' : ''}" onclick="selectDestination('all')">
                    üìã All Ideas <span class="filter-count">${noteboxIdeas.length}</span>
                </button>
            `;

            // Add each destination
            html += noteboxDestinations.map(dest => {
                const count = noteboxIdeas.filter(i => i.destination_slug === dest.slug && i.status === 'inbox').length;
                return `
                    <button class="filter-btn ${currentDestination === dest.slug ? 'active' : ''}" onclick="selectDestination('${dest.slug}')">
                        ${dest.icon || 'üìÅ'} ${dest.name} <span class="filter-count">${count}</span>
                    </button>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function selectDestination(slug) {
            currentDestination = slug;
            renderDestinationsSidebar();
            renderNoteboxKanban();
        }

        // Push To Dropdown Functions
        let activePushDropdown = null;

        function togglePushDropdown(ideaId, event) {
            const dropdown = document.getElementById('globalPushDropdown');
            const button = event ? event.target.closest('.notebox-card-btn.push') : null;

            // If clicking same button, close dropdown
            if (dropdown.classList.contains('active') && dropdown.dataset.ideaId === ideaId) {
                closePushDropdown();
                return;
            }

            // Store the idea ID on the dropdown
            dropdown.dataset.ideaId = ideaId;
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();

            // Position the dropdown relative to the button
            if (button) {
                const rect = button.getBoundingClientRect();
                dropdown.style.top = (rect.bottom + 4) + 'px';
                dropdown.style.left = rect.left + 'px';
            }

            dropdown.classList.add('active');
            activePushDropdown = dropdown;
        }

        function closePushDropdown() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.classList.remove('active');
            dropdown.dataset.ideaId = '';
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();
            activePushDropdown = null;
        }

        function resetDropdownContent() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.innerHTML = `
                <div class="push-dropdown-header">Push to...</div>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); showSectionSelect()">
                    üèõÔ∏è getSUITE Governance
                </button>
            `;
        }

        function showSectionSelect() {
            const dropdown = document.getElementById('globalPushDropdown');
            const ideaId = dropdown.dataset.ideaId;

            if (!ideaId) {
                console.error('No ideaId found in dropdown');
                alert('Error: Please try clicking the Push To button again');
                closePushDropdown();
                return;
            }

            console.log('showSectionSelect for idea:', ideaId);
            dropdown.dataset.step = 'sections';
            dropdown.innerHTML = `
                <button class="push-dropdown-item back" onclick="event.stopPropagation(); backToDestinations()">
                    ‚Üê Back
                </button>
                <div class="push-dropdown-header">Select Section</div>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'suite_apps')">
                    üì± SUITE Apps
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'business')">
                    üíº Business
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'content')">
                    üìù Content
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'social')">
                    üí¨ Social
                </button>
            `;
        }

        function backToDestinations() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();
        }

        async function pushToGovernance(ideaId, section) {
            console.log('pushToGovernance called:', ideaId, section);
            console.log('noteboxIdeas count:', noteboxIdeas.length);
            console.log('noteboxIdeas IDs:', noteboxIdeas.map(i => ({ id: i.id, type: typeof i.id })));

            // Compare as strings to handle type mismatches
            const idea = noteboxIdeas.find(i => String(i.id) === String(ideaId));
            if (!idea) {
                console.error('Idea not found. Looking for:', ideaId, 'Type:', typeof ideaId);
                alert('Error: Could not find the idea. Check console for details.');
                closePushDropdown();
                return;
            }

            console.log('Found idea:', idea);

            // Close dropdown and show loading state
            closePushDropdown();

            try {
                // Create a proposal from the idea
                const payload = {
                    content: idea.title + (idea.content ? '\n\n' + idea.content : ''),
                    section: section,
                    wallet_address: currentUser?.wallet_address || null,
                    telegram_auth: currentUser?.telegram_id ? { id: currentUser.telegram_id } : null
                };

                console.log('Submitting proposal:', payload);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    // Mark the idea as pushed/implemented
                    await fetch(`${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'implemented', dismiss_reason: `Pushed to Governance ‚Üí ${section}` })
                    });

                    // Reload and re-render (wrapped in try-catch to not break on missing elements)
                    try {
                        await loadGovernanceProposals();
                        renderGovernanceSections();
                    } catch (e) { console.log('Error reloading governance:', e); }

                    // Reload NoteBox for whichever view is active
                    try {
                        // Try inline view first (Stuart Factory tab)
                        if (document.getElementById('noteboxKanbanInline')) {
                            await loadNoteboxIdeasForInline();
                        }
                        // Also try regular NoteBox view
                        if (document.getElementById('noteboxKanban')) {
                            await loadNoteboxIdeas();
                            renderNoteboxKanban();
                        }
                    } catch (e) { console.log('Error reloading notebox:', e); }
                } else {
                    const data = await response.json();
                    console.error('Push failed:', data);
                    alert('Failed to push: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Push to governance error:', err);
                alert('Failed to push idea: ' + err.message);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (activePushDropdown && !e.target.closest('.push-dropdown') && !e.target.closest('.notebox-card-btn.push')) {
                closePushDropdown();
            }
        });

        function showPushToModal(ideaId) {
            pushingIdeaId = ideaId;
            const container = document.getElementById('pushToDestinations');

            // Get current idea's destination
            const idea = noteboxIdeas.find(i => i.id === ideaId);
            const currentSlug = idea?.destination_slug;

            container.innerHTML = noteboxDestinations
                .filter(dest => dest.slug !== currentSlug) // Don't show current destination
                .map(dest => `
                    <button class="destination-btn" onclick="pushToDestination('${dest.slug}')">
                        <span class="dest-icon">${dest.icon || 'üìÅ'}</span>
                        <div class="dest-info">
                            <div class="dest-name">${dest.name}</div>
                            <div class="dest-desc">${dest.description || ''}</div>
                        </div>
                    </button>
                `).join('');

            document.getElementById('pushToModal').classList.add('active');
        }

        function hidePushToModal() {
            document.getElementById('pushToModal').classList.remove('active');
            pushingIdeaId = null;
        }

        async function pushToDestination(destSlug) {
            if (!pushingIdeaId) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${pushingIdeaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ destination_slug: destSlug })
                    }
                );

                if (response.ok) {
                    const idea = noteboxIdeas.find(i => i.id === pushingIdeaId);
                    if (idea) {
                        idea.destination_slug = destSlug;
                    }
                    hidePushToModal();
                    renderDestinationsSidebar();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error pushing idea:', err);
            }
        }

        function showAddDestinationModal() {
            document.getElementById('newDestinationName').value = '';
            document.getElementById('newDestinationIcon').value = '';
            document.getElementById('newDestinationDesc').value = '';
            document.getElementById('addDestinationModal').classList.add('active');
        }

        function hideAddDestinationModal() {
            document.getElementById('addDestinationModal').classList.remove('active');
        }

        async function createDestination() {
            const name = document.getElementById('newDestinationName').value.trim();
            const icon = document.getElementById('newDestinationIcon').value.trim() || 'üìÅ';
            const description = document.getElementById('newDestinationDesc').value.trim();

            if (!name) {
                alert('Please enter a name');
                return;
            }

            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/intake_destinations`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            name,
                            slug,
                            icon,
                            description,
                            active: true,
                            sort_order: noteboxDestinations.length
                        })
                    }
                );

                if (response.ok) {
                    const [newDest] = await response.json();
                    noteboxDestinations.push(newDest);
                    hideAddDestinationModal();
                    renderDestinationsSidebar();
                }
            } catch (err) {
                console.error('Error creating destination:', err);
            }
        }

        async function addNoteboxIdea() {
            const input = document.getElementById('noteboxQuickInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) return;

            // Simple auto-categorization
            const categorized = autoCategorizeIdea(text);

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            raw_input: text,
                            category: categorized.category,
                            title: categorized.title,
                            content: categorized.content,
                            status: 'inbox',
                            user_id: userId
                        })
                    }
                );

                if (response.ok) {
                    const [newIdea] = await response.json();
                    noteboxIdeas.unshift(newIdea);
                    input.value = '';
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                } else {
                    console.error('Failed to add idea:', await response.text());
                }
            } catch (err) {
                console.error('Error adding idea:', err);
            }
        }

        function autoCategorizeIdea(text) {
            const lower = text.toLowerCase();
            let category = 'brainstorm';

            if (lower.includes('suite') || lower.includes('foodvitals') || lower.includes('cheshbon') || lower.includes('opticrep')) {
                category = 'suite_feature';
            } else if (lower.includes('app idea') || lower.includes('new app')) {
                category = 'app_idea';
            } else if (lower.includes('article') || lower.includes('blog') || lower.includes('write')) {
                category = 'article';
            } else if (lower.includes('todo') || lower.includes('call') || lower.includes('email') || lower.includes('contact')) {
                category = 'action_item';
            } else if (lower.includes('?')) {
                category = 'question';
            }

            return {
                category,
                title: text.length > 60 ? text.substring(0, 60) + '...' : text,
                content: text.length > 60 ? text : ''
            };
        }

        function markNoteboxDone(ideaId) {
            showNoteboxArchiveModal(ideaId, 'done');
        }

        function dismissNoteboxIdea(ideaId) {
            showNoteboxArchiveModal(ideaId, 'dismiss');
        }

        function showNoteboxArchiveModal(ideaId, action) {
            noteboxArchiveIdeaId = ideaId;
            noteboxArchiveAction = action;

            const modal = document.getElementById('noteboxArchiveModal');
            const title = document.getElementById('noteboxArchiveTitle');
            const label = document.getElementById('noteboxArchiveLabel');
            const textarea = document.getElementById('noteboxArchiveReason');
            const confirmBtn = document.getElementById('noteboxArchiveConfirm');

            if (action === 'done') {
                title.textContent = 'Mark as Done';
                label.textContent = 'What did you accomplish?';
                textarea.placeholder = 'Briefly describe what was done...';
                confirmBtn.textContent = '‚úì Mark Done';
                confirmBtn.style.background = 'var(--success)';
            } else {
                title.textContent = 'Dismiss Idea';
                label.textContent = 'Why are you dismissing this?';
                textarea.placeholder = 'Reason for dismissing (not relevant, duplicate, etc.)...';
                confirmBtn.textContent = '‚úï Dismiss';
                confirmBtn.style.background = 'var(--error)';
            }

            textarea.value = '';
            modal.classList.add('active');
            textarea.focus();
        }

        function hideNoteboxArchiveModal() {
            document.getElementById('noteboxArchiveModal').classList.remove('active');
            noteboxArchiveIdeaId = null;
            noteboxArchiveAction = null;
        }

        async function confirmNoteboxArchive() {
            if (!noteboxArchiveIdeaId || !noteboxArchiveAction) return;

            const reason = document.getElementById('noteboxArchiveReason').value.trim();
            if (!reason) {
                document.getElementById('noteboxArchiveReason').style.borderColor = 'var(--error)';
                return;
            }

            const status = noteboxArchiveAction === 'done' ? 'implemented' : 'dismissed';
            await updateNoteboxIdeaStatus(noteboxArchiveIdeaId, status, reason);
            hideNoteboxArchiveModal();
        }

        async function updateNoteboxIdeaStatus(ideaId, status, reason = null) {
            try {
                const updateData = { status };
                if (reason !== null) {
                    updateData.dismiss_reason = reason; // Using dismiss_reason for both done and dismiss
                }

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    // Update local state
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        idea.status = status;
                        if (reason !== null) idea.dismiss_reason = reason;
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error updating idea:', err);
            }
        }

        function filterNoteboxCategory(category) {
            noteboxCategoryFilter = category;

            // Update filter buttons
            document.querySelectorAll('.notebox-sidebar .filter-btn[data-category]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            renderNoteboxKanban();
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideSubmitModal();
                hideAuthModal();
                hideNoteboxArchiveModal();
            }
        });
    </script>

    <!-- Main Site Navigation Component -->
    <script src="/nav-component.js"></script>
</body>
</html>
