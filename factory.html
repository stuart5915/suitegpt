<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>getSuite Factory - Community Governance</title>
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Nunito:wght@400;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/nav.css">
    <style>
        /* Dark theme override for nav on this page */
        .nav-inner {
            background: rgba(18, 18, 26, 0.95) !important;
            border: 1px solid rgba(255, 255, 255, 0.08) !important;
            backdrop-filter: blur(20px);
        }
        .nav-logo {
            color: #ffffff !important;
        }
        .nav-links a {
            color: #a1a1aa !important;
        }
        .nav-links a:hover,
        .nav-links a.active {
            color: #ffffff !important;
        }
        .mobile-menu-btn span {
            background: #ffffff !important;
        }
        .connect-btn {
            background: linear-gradient(135deg, #ff8c42, #fbbf24) !important;
        }

        :root {
            /* Premium Dark Theme */
            --bg: #0a0a0f;
            --bg-card: #12121a;
            --bg-elevated: #1a1a28;
            --bg-surface: #22222f;
            --text: #f5f5f7;
            --text-dim: #a1a1aa;
            --accent: #ff8c42;
            --accent-amber: #fbbf24;
            --accent-dim: rgba(255, 140, 66, 0.2);
            --success: #22c55e;
            --error: #ef4444;
            --border: rgba(255, 255, 255, 0.08);
            --glass-bg: rgba(255, 255, 255, 0.03);
            --glass-border: rgba(255, 255, 255, 0.08);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            position: relative;
        }

        /* Ambient background effect */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(255, 140, 66, 0.06) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 60%, rgba(99, 102, 241, 0.05) 0%, transparent 50%),
                radial-gradient(ellipse 50% 30% at 50% 80%, rgba(251, 191, 36, 0.04) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
            animation: ambientFloat 20s ease-in-out infinite;
        }

        @keyframes ambientFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(1%, 1%) scale(1.02); }
            50% { transform: translate(-1%, 2%) scale(1); }
            75% { transform: translate(1%, -1%) scale(1.01); }
        }

        /* Header */
        .factory-header {
            background: var(--bg-card);
            border-bottom: 1px solid var(--glass-border);
            padding: 20px 40px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 1;
        }

        .factory-logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .factory-logo h1 {
            font-size: clamp(1.1rem, 4vw, 1.5rem);
            font-weight: 800;
        }

        .factory-logo span {
            color: var(--accent);
        }

        .user-panel {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .user-rep {
            display: flex;
            align-items: center;
            gap: 8px;
            background: var(--bg-elevated);
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 600;
        }

        .auth-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-amber));
            color: #000;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .auth-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            cursor: pointer;
        }

        /* Factory Tabs */
        .factory-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-surface);
            padding: 6px;
            border-radius: 14px;
            border: 1px solid var(--glass-border);
        }

        .factory-tab {
            padding: 10px 24px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factory-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-tab.active {
            background: linear-gradient(135deg, var(--accent), var(--accent-amber));
            color: #000;
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
        }

        .factory-tab .tab-icon {
            font-size: 1.1rem;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: flex;
            flex: 1;
        }

        /* NoteBox Auth Prompt */
        .notebox-auth-prompt {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 24px;
            text-align: center;
            padding: 40px;
        }

        .notebox-auth-icon {
            font-size: 4rem;
        }

        .notebox-auth-title {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            font-weight: 700;
        }

        .notebox-auth-subtitle {
            color: var(--text-dim);
            max-width: 400px;
        }

        .notebox-connect-btn {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: #fff;
            border: none;
            padding: 14px 32px;
            border-radius: 12px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notebox-connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.3);
        }

        /* NoteBox App Styles */
        .notebox-app {
            display: flex;
        }

        .notebox-quick-add {
            display: flex;
            gap: 8px;
        }

        .notebox-input {
            flex: 1;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px 14px;
            color: var(--text);
            font-size: 0.9rem;
        }

        .notebox-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .notebox-add-btn {
            background: linear-gradient(135deg, var(--accent), var(--accent-amber));
            color: #000;
            border: none;
            width: 42px;
            height: 42px;
            border-radius: 10px;
            font-size: 1.2rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .notebox-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
        }

        .notebox-kanban { display: flex; flex-wrap: wrap; gap: 16px; padding: 20px; overflow-y: auto; flex: 1; align-content: flex-start; }

        .notebox-kanban.grid-view {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        }

        .notebox-column { width: 280px; flex-shrink: 0;
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 16px;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--glass-border);
        }

        .notebox-column-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .notebox-column-count {
            background: var(--bg-card);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
        }

        .notebox-column-cards {
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow-y: auto;
            flex: 1;
        }

        .notebox-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 14px;
            padding: 16px;
            cursor: grab;
            transition: all 0.3s ease;
            user-select: none;
            position: relative;
        }

        .notebox-card:active {
            cursor: grabbing;
        }

        .notebox-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 140, 66, 0.15);
        }

        .notebox-card-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 20px;
            height: 20px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-size: 16px;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s, color 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
        }

        .notebox-card:hover .notebox-card-delete {
            opacity: 1;
        }

        .notebox-card-delete:hover {
            color: var(--error);
            background: rgba(239, 68, 68, 0.1);
        }

        .notebox-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            border-color: var(--accent);
        }

        .notebox-column-cards.drag-over {
            background: rgba(0, 212, 170, 0.1);
            border: 2px dashed var(--accent);
            border-radius: 8px;
            min-height: 100px;
        }

        .archive-column {
            opacity: 0.8;
        }

        .archive-column .notebox-card {
            opacity: 0.7;
        }

        .archive-column .notebox-card:hover {
            opacity: 1;
        }

        .notebox-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .notebox-card-emoji {
            font-size: 1.2rem;
        }

        .notebox-card-category {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--text-dim);
        }

        .notebox-card-title {
            font-weight: 600;
            margin-bottom: 8px;
            line-height: 1.3;
        }

        .notebox-card-content {
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .notebox-card-actions {
            display: flex;
            gap: 8px;
        }

        .notebox-card-btn {
            flex: 1;
            padding: 8px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
        }

        .notebox-card-btn.done {
            background: rgba(34, 197, 94, 0.2);
            color: var(--success);
        }

        .notebox-card-btn.done:hover {
            background: rgba(34, 197, 94, 0.3);
        }

        .notebox-card-btn.push {
            background: rgba(0, 212, 170, 0.2);
            color: var(--accent);
            flex: 2;
        }

        .notebox-card-btn.push:hover {
            background: rgba(0, 212, 170, 0.3);
        }

        /* Push To Dropdown - Global dropdown positioned at body level */
        .push-dropdown {
            position: fixed;
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 9999;
            display: none;
            overflow: hidden;
            min-width: 200px;
            backdrop-filter: blur(20px);
        }

        .push-dropdown.active {
            display: block;
        }

        .push-dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            font-size: 0.8rem;
            color: var(--text);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            transition: background 0.15s;
        }

        .push-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .push-dropdown-item.back {
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .push-dropdown-header {
            padding: 8px 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-dim);
            border-bottom: 1px solid var(--border);
        }

        .destination-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .destination-btn:hover {
            border-color: var(--accent);
            background: var(--accent-dim);
        }

        .destination-btn .dest-icon {
            font-size: 1.5rem;
        }

        .destination-btn .dest-info {
            flex: 1;
        }

        .destination-btn .dest-name {
            font-weight: 600;
            color: var(--text);
        }

        .destination-btn .dest-desc {
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .notebox-card-reason {
            font-size: 0.8rem;
            color: var(--accent);
            background: var(--accent-dim);
            padding: 8px 10px;
            border-radius: 6px;
            margin-bottom: 10px;
            font-style: italic;
        }

        .notebox-empty {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .notebox-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Main Layout */
        .factory-main {
            display: flex;
            height: 100vh;
            padding-top: 80px;
            overflow: hidden;
        }

        /* Sidebar */
        .factory-sidebar {
            width: 280px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            padding: 24px;
            padding-top: 104px;
            margin-top: -80px;
            height: calc(100% + 80px);
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .rep-explainer {
            background: linear-gradient(135deg, rgba(255, 153, 0, 0.08) 0%, rgba(255, 153, 0, 0.02) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(255, 153, 0, 0.2);
        }

        .rep-explainer .sidebar-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 14px;
        }

        .rep-explainer .sidebar-title::before {
            content: 'âš¡';
            font-size: 1rem;
        }

        .rep-section {
            background: var(--bg);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .rep-section:last-child {
            margin-bottom: 0;
        }

        .rep-section-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }

        .rep-section.earn .rep-section-header {
            color: #22c55e;
        }

        .rep-section.spend .rep-section-header {
            color: var(--accent);
        }

        .rep-section.lose .rep-section-header {
            color: #ef4444;
        }

        .rep-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .rep-item-value {
            font-weight: 600;
            color: var(--text);
            white-space: nowrap;
        }

        .rep-item-value.positive {
            color: #22c55e;
        }

        .rep-item-value.cost {
            color: var(--accent);
        }

        .rep-item-value.negative {
            color: #ef4444;
        }

        .rep-item-desc {
            flex: 1;
            font-size: 0.75rem;
        }

        .sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-dim);
            margin-bottom: 12px;
        }

        .submit-btn {
            width: 100%;
            background: var(--accent);
            color: #000;
            border: none;
            padding: 14px 20px;
            border-radius: 10px;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 20px;
        }

        .submit-btn:hover {
            background: #fbbf24;
            transform: translateY(-1px);
        }

        .stat-card {
            background: var(--bg-elevated);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 4px;
        }

        .stat-value {
            font-size: clamp(1.2rem, 4vw, 1.5rem);
            font-weight: 700;
        }

        .stat-value.accent {
            color: var(--accent);
        }

        .filter-btn {
            width: 100%;
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
            padding: 10px 14px;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            margin-bottom: 8px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.2s;
        }

        .filter-btn:hover, .filter-btn.active {
            background: var(--accent-dim);
            border-color: var(--accent);
        }

        .filter-count {
            background: var(--bg);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        /* Content Area */
        .factory-content {
            flex: 1;
            padding: 24px;
            padding-bottom: 0;
            overflow-y: auto;
            min-height: 0;
        }

        #governanceView {
            padding-bottom: 24px;
        }

        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .content-title {
            font-size: clamp(1.1rem, 3.5vw, 1.3rem);
            font-weight: 700;
        }

        /* NoteBox Connect Button & Badge */
        .governance-title-row {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .view-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-elevated);
            padding: 4px;
            border-radius: 10px;
        }

        .view-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-tab:hover {
            color: var(--text);
            background: rgba(255, 255, 255, 0.05);
        }

        .view-tab.active {
            background: var(--accent);
            color: #000;
        }

        .notebox-connect-btn {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px dashed var(--border);
            background: transparent;
            color: var(--text-dim);
            font-size: 18px;
            font-weight: 400;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .notebox-connect-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
            background: var(--accent-dim);
        }

        .notebox-badge {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-top: 4px;
        }

        .notebox-badge a {
            color: var(--accent);
            text-decoration: none;
        }

        .notebox-badge a:hover {
            text-decoration: underline;
        }

        .view-toggle {
            display: flex;
            gap: 8px;
        }

        .view-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-dim);
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: var(--accent);
            border-color: var(--accent);
            color: #000;
        }

        /* Kanban Board */
        .kanban-board {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
        }

        .kanban-column {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            min-height: 400px;
        }

        .column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .column-icon {
            font-size: 1.2rem;
        }

        .column-title {
            font-weight: 700;
            font-size: 0.95rem;
        }

        .column-count {
            margin-left: auto;
            background: var(--bg-elevated);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        /* Proposal Cards */
        .proposal-card {
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .proposal-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-bottom: 8px;
        }

        .proposal-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .proposal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .proposal-author {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            font-size: 0.6rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #000;
            font-weight: 700;
        }

        .proposal-votes {
            display: flex;
            gap: 12px;
        }

        .vote-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .vote-count.for {
            color: var(--success);
        }

        .vote-count.against {
            color: var(--error);
        }

        /* Quick Vote Buttons */
        .quick-vote {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .quick-vote-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border);
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .quick-vote-btn.for:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: var(--success);
            color: var(--success);
        }

        .quick-vote-btn.against:hover {
            background: rgba(239, 68, 68, 0.2);
            border-color: var(--error);
            color: var(--error);
        }

        .quick-vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Time remaining badge */
        .time-badge {
            background: var(--accent-dim);
            color: var(--accent);
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Submit Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: clamp(1.1rem, 3.5vw, 1.3rem);
            font-weight: 700;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-dim);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .refine-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            margin-top: 10px;
            padding: 8px 16px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.2));
            border: 1px solid rgba(168, 85, 247, 0.4);
            border-radius: 20px;
            color: #a855f7;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .refine-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(168, 85, 247, 0.3));
            border-color: rgba(168, 85, 247, 0.6);
            transform: translateY(-1px);
        }

        .refine-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .refine-btn .refine-icon {
            font-size: 1rem;
        }

        .refine-btn.refining .refine-text {
            display: none;
        }

        .refine-btn.refining::after {
            content: 'Refining...';
        }

        .form-select {
            cursor: pointer;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text);
        }

        .modal-btn.submit {
            background: var(--accent);
            border: none;
            color: #000;
        }

        .modal-btn.submit:hover {
            background: #fbbf24;
        }

        /* Category badges */
        .category-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .category-badge.feature { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .category-badge.bug { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
        .category-badge.app_idea { background: rgba(168, 85, 247, 0.2); color: #a855f7; }
        .category-badge.improvement { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .category-badge.docs { background: rgba(107, 114, 128, 0.2); color: #9ca3af; }
        .category-badge.integration { background: rgba(20, 184, 166, 0.2); color: #14b8a6; }
        .category-badge.tokenomics { background: rgba(255, 140, 66, 0.2); color: #ff8c42; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-dim);
        }

        .empty-state-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--bg-elevated);
            border-radius: 10px;
            margin-bottom: 8px;
            border: 1px solid var(--border);
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            border-color: var(--accent);
        }

        .leaderboard-item.gold {
            background: linear-gradient(135deg, rgba(255, 215, 0, 0.1), rgba(255, 215, 0, 0.05));
            border-color: rgba(255, 215, 0, 0.3);
        }

        .leaderboard-item.silver {
            background: linear-gradient(135deg, rgba(192, 192, 192, 0.1), rgba(192, 192, 192, 0.05));
            border-color: rgba(192, 192, 192, 0.3);
        }

        .leaderboard-item.bronze {
            background: linear-gradient(135deg, rgba(205, 127, 50, 0.1), rgba(205, 127, 50, 0.05));
            border-color: rgba(205, 127, 50, 0.3);
        }

        .leaderboard-rank {
            font-size: 1.2rem;
            width: 32px;
            text-align: center;
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-weight: 600;
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .leaderboard-stats {
            font-size: 0.75rem;
            color: var(--text-dim);
            display: flex;
            gap: 8px;
        }

        .leaderboard-rep {
            color: var(--accent);
            font-weight: 700;
            font-size: clamp(0.95rem, 3vw, 1.1rem);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .founder-badge {
            background: linear-gradient(135deg, #ff8c42, #ff6b00);
            color: #000;
            font-size: 0.65rem;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 700;
            margin-left: 6px;
        }

        /* Auth required overlay */
        .auth-required {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
        }

        .auth-card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            max-width: 400px;
        }

        .auth-card h2 {
            margin-bottom: 12px;
        }

        .auth-card p {
            color: var(--text-dim);
            margin-bottom: 24px;
        }

        .telegram-btn {
            background: #0088cc;
            color: white;
            border: none;
            padding: 14px 28px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            margin: 0 auto;
        }

        .telegram-btn:hover {
            background: #0099dd;
        }

        /* Technical Loops Section */
        .loops-section {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.05), rgba(168, 85, 247, 0.05));
            border: 1px solid rgba(255, 149, 0, 0.2);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
        }

        .loops-header {
            text-align: center;
            margin-bottom: 24px;
            cursor: pointer;
            padding: 8px;
            margin: -8px -8px 16px -8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .loops-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .loops-header-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .loops-toggle {
            font-size: 0.8rem;
            color: var(--text-dim);
            transition: transform 0.2s;
        }

        .loops-section.collapsed .loops-toggle {
            transform: rotate(-90deg);
        }

        .loops-header h3 {
            font-size: clamp(1.1rem, 3.5vw, 1.3rem);
            font-weight: 800;
            margin: 0;
            color: var(--accent);
        }

        .loops-header p {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin: 8px 0 0 0;
        }

        .loops-content {
            /* Content container for collapse */
        }

        .loops-section.collapsed .loops-content {
            display: none;
        }

        .loops-section.collapsed .loops-header {
            margin-bottom: 0;
        }

        .loops-section.collapsed {
            max-width: 500px;
            padding: 16px 20px;
        }

        .loops-section {
            transition: max-width 0.3s ease, padding 0.3s ease;
        }

        /* Grid layout for categories side by side */
        .loops-categories-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            align-items: start;
        }

        @media (max-width: 768px) {
            .loops-categories-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loop Category (AI Loops, Cadence Loops) */
        .loop-category {
            margin-bottom: 0;
            background: var(--bg-elevated);
            border-radius: 12px;
            border: 1px solid var(--border);
            overflow: hidden;
        }

        .loop-category-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 14px 16px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .loop-category-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .category-toggle {
            font-size: 0.7rem;
            color: var(--text-dim);
            transition: transform 0.2s;
        }

        .loop-category.collapsed .category-toggle {
            transform: rotate(-90deg);
        }

        .category-icon {
            font-size: 1.2rem;
        }

        .category-name {
            font-weight: 700;
            font-size: 1rem;
        }

        .category-count {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
        }

        .loop-category-content {
            border-top: 1px solid var(--border);
        }

        .loop-category.collapsed .loop-category-content {
            display: none;
        }

        /* Individual Loop Item */
        .loop-item {
            border-bottom: 1px solid var(--border);
        }

        .loop-item:last-child {
            border-bottom: none;
        }

        .loop-item-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px 12px 32px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .loop-item-header:hover {
            background: rgba(255, 255, 255, 0.03);
        }

        .loop-toggle {
            font-size: 0.65rem;
            color: var(--text-dim);
            transition: transform 0.2s;
        }

        .loop-item.expanded .loop-toggle {
            transform: rotate(90deg);
        }

        .loop-title {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .loop-status-badge {
            font-size: 0.7rem;
            padding: 2px 8px;
            border-radius: 100px;
            margin-left: auto;
        }

        .loop-status-badge.partial {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .loop-status-badge.full {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .loop-item-content {
            display: none;
            padding: 0 16px 16px 48px;
            font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', monospace;
            font-size: 0.8rem;
        }

        .loop-item.expanded .loop-item-content {
            display: block;
        }

        /* Loop Details */
        .loop-trigger, .loop-output {
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .trigger-label, .output-label {
            color: var(--accent);
            font-weight: 600;
        }

        .loop-steps {
            border-left: 2px solid var(--border);
            margin-left: 8px;
            padding-left: 16px;
        }

        .loop-step {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            padding: 6px 0;
            position: relative;
        }

        .loop-step::before {
            content: '';
            position: absolute;
            left: -18px;
            top: 12px;
            width: 8px;
            height: 2px;
            background: var(--border);
        }

        .step-tag {
            font-size: 0.6rem;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            flex-shrink: 0;
        }

        .step-tag.auto {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .step-tag.admin {
            background: rgba(234, 179, 8, 0.2);
            color: #eab308;
        }

        .step-text {
            color: var(--text-dim);
            line-height: 1.4;
        }

        /* Tree View for branching logic */
        .loop-steps.tree-view {
            border-left: none;
            margin-left: 0;
            padding-left: 0;
        }

        .loop-steps.tree-view .loop-step {
            padding-left: 0;
        }

        .loop-steps.tree-view .loop-step::before {
            display: none;
        }

        .loop-step.check {
            background: rgba(168, 85, 247, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            margin: 8px 0;
        }

        .loop-step.check .step-text {
            color: #a855f7;
            font-weight: 600;
        }

        .loop-step.rest .step-text {
            color: var(--text-dim);
        }

        .future-note {
            font-size: 0.7rem;
            color: var(--text-dim);
            opacity: 0.7;
        }

        .loop-branch {
            margin-left: 20px;
            padding: 8px 0 8px 16px;
            border-left: 2px solid rgba(34, 197, 94, 0.3);
        }

        .branch-label {
            color: #22c55e;
            font-weight: 600;
            font-size: 0.75rem;
        }

        .branch-steps {
            margin-top: 8px;
        }

        .branch-steps .loop-step {
            padding: 4px 0;
        }

        .branch-steps .loop-step::before {
            display: none;
        }

        /* Cadence List */
        .cadence-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .cadence-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 6px;
        }

        .cadence-item.placeholder {
            color: var(--text-dim);
            font-style: italic;
        }

        .cadence-time {
            font-weight: 700;
            color: var(--accent);
            font-size: 0.75rem;
            min-width: 90px;
        }

        .cadence-action {
            color: var(--text-dim);
        }

        /* Docs Links */
        .loops-docs-links {
            display: flex;
            gap: 12px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid var(--border);
        }

        .docs-link {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 8px;
            text-decoration: none;
            color: var(--text);
            transition: all 0.2s;
        }

        .docs-link:hover {
            border-color: var(--accent);
            background: rgba(255, 149, 0, 0.1);
        }

        .docs-icon {
            font-size: 1.2rem;
        }

        .docs-text {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .docs-arrow {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--accent);
        }

        .loops-footer {
            text-align: center;
            margin-top: 20px;
            font-size: 0.85rem;
            color: var(--text-dim);
        }

        @media (max-width: 600px) {
            .loops-docs-links {
                flex-direction: column;
            }
        }

        /* Governance Tabs */
        .governance-tabs-container {
            background: var(--glass-bg);
            border-radius: 20px;
            padding: 24px;
            border: 1px solid var(--glass-border);
            backdrop-filter: blur(20px);
            position: relative;
            z-index: 1;
        }

        .governance-tabs-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .governance-main-title {
            font-size: clamp(1rem, 3vw, 1.2rem);
            font-weight: 800;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .governance-main-title .governance-section-count {
            font-size: 0.75rem;
        }

        .governance-tabs {
            display: flex;
            gap: 8px;
        }

        .governance-tab {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .governance-tab:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text);
        }

        .governance-tab.active {
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.2), rgba(251, 191, 36, 0.2));
            border-color: var(--accent);
            color: var(--accent);
        }

        .governance-tab .tab-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 0.7rem;
        }

        .governance-tab.active .tab-count {
            background: rgba(34, 197, 94, 0.2);
        }

        .governance-tab-content {
            display: none;
        }

        .governance-tab-content.active {
            display: block;
        }

        @media (max-width: 768px) {
            .governance-tabs-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .governance-tabs {
                margin-left: 0;
                flex-wrap: wrap;
            }
        }

        .section-kanban {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 16px;
        }

        .section-column {
            background: var(--bg-elevated);
            border-radius: 16px;
            padding: 16px;
            min-height: 120px;
            border: 1px solid var(--glass-border);
        }

        .section-column-header {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-dim);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .section-column-header span {
            opacity: 0.7;
        }

        .section-add-btn {
            width: 100%;
            padding: 10px 14px;
            margin-bottom: 12px;
            background: linear-gradient(135deg, var(--accent), var(--accent-amber));
            color: #000;
            border: none;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .section-add-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3);
        }

        /* Drag and Drop */
        .section-column.drag-over {
            background: rgba(255, 140, 66, 0.1);
            border: 2px dashed var(--accent);
        }

        .idea-card[draggable="true"] {
            cursor: grab;
            user-select: none;
            -webkit-user-drag: element;
        }

        .idea-card[draggable="true"] * {
            pointer-events: none;
        }

        .idea-card[draggable="true"] button,
        .idea-card-drag-handle {
            pointer-events: auto;
        }

        .idea-card[draggable="true"]:active {
            cursor: grabbing;
        }

        .idea-card.dragging {
            opacity: 0.5;
        }

        .empty-column {
            color: var(--text-dim);
            font-size: 0.8rem;
            text-align: center;
            padding: 20px 10px;
            opacity: 0.6;
        }

        .idea-card {
            background: var(--bg-card);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            position: relative;
        }

        .idea-card:hover {
            border-color: var(--accent);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(255, 140, 66, 0.15);
        }

        .card-delete-btn {
            position: absolute;
            top: 6px;
            right: 6px;
            width: 20px;
            height: 20px;
            border: none;
            background: rgba(239, 68, 68, 0.8);
            color: white;
            border-radius: 50%;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .idea-card:hover .card-delete-btn {
            opacity: 1;
        }

        .card-delete-btn:hover {
            background: #ef4444;
        }

        .idea-card.building {
            border-left: 3px solid #ff8c42;
        }

        .idea-card.considering {
            border-left: 3px solid #6366f1;
        }

        .idea-card.live {
            border-left: 3px solid #22c55e;
        }

        .idea-card.rejected {
            border-left: 3px solid #ef4444;
            opacity: 0.7;
        }

        .proposal-app-tag {
            display: inline-block;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.2));
            color: #a855f7;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 8px;
            border-radius: 100px;
            margin-bottom: 8px;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        .proposal-app-tag.new-app-tag {
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.2), rgba(251, 191, 36, 0.2));
            color: #ff8c42;
            border-color: rgba(255, 140, 66, 0.4);
        }

        /* Agent Badge */
        .agent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(99, 102, 241, 0.2));
            color: #a855f7;
            font-size: 0.7rem;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 100px;
            margin-bottom: 8px;
            margin-right: 6px;
            border: 1px solid rgba(168, 85, 247, 0.4);
        }

        .agent-badge::before {
            content: 'ðŸ¤–';
            font-size: 0.8rem;
        }

        .agent-badge a {
            color: inherit;
            text-decoration: none;
        }

        .agent-badge a:hover {
            text-decoration: underline;
        }

        /* Agent Feedback Section */
        .agent-feedback-section {
            margin-top: 12px;
            padding: 12px;
            background: rgba(168, 85, 247, 0.1);
            border-radius: 8px;
            border: 1px solid rgba(168, 85, 247, 0.2);
        }

        .agent-feedback-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #a855f7;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .agent-feedback-input {
            width: 100%;
            background: var(--bg-elevated);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 10px;
            color: var(--text);
            font-size: 0.85rem;
            resize: vertical;
            min-height: 60px;
        }

        .agent-feedback-input:focus {
            outline: none;
            border-color: #a855f7;
        }

        .agent-feedback-input::placeholder {
            color: var(--text-dim);
        }

        .agent-feedback-btn {
            margin-top: 8px;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: #fff;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-feedback-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .agent-feedback-display {
            font-size: 0.85rem;
            color: var(--text-dim);
            padding: 10px;
            background: var(--bg-elevated);
            border-radius: 6px;
            border-left: 3px solid #a855f7;
        }

        .agent-feedback-display strong {
            color: var(--text);
        }

        /* Agents Tab Styles */
        .agents-container {
            padding: 20px;
        }

        .agents-header {
            margin-bottom: 20px;
        }

        .agents-description {
            color: var(--text-dim);
            font-size: 0.9rem;
            margin: 0;
        }

        .agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .loading-agents {
            grid-column: 1 / -1;
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }

        .agent-card {
            background: var(--bg-elevated);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s;
        }

        .agent-card:hover {
            border-color: #a855f7;
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(168, 85, 247, 0.15);
        }

        .agent-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .agent-card-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            flex-shrink: 0;
        }

        .agent-card-info {
            flex: 1;
            min-width: 0;
        }

        .agent-card-name {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 2px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .agent-card-status {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .agent-card-status.idle {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .agent-card-status.waiting {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .agent-card-status.working {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
        }

        .agent-card-app {
            font-size: 0.8rem;
            color: var(--text-dim);
        }

        .agent-card-app a {
            color: var(--accent);
            text-decoration: none;
        }

        .agent-card-app a:hover {
            text-decoration: underline;
        }

        .agent-card-mission {
            font-size: 0.85rem;
            color: var(--text-dim);
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .agent-card-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--bg-card);
            border-radius: 10px;
        }

        .agent-stat {
            text-align: center;
            flex: 1;
        }

        .agent-stat-value {
            font-size: 1.25rem;
            font-weight: 700;
        }

        .agent-stat-value.success { color: #22c55e; }
        .agent-stat-value.error { color: #ef4444; }
        .agent-stat-value.accent { color: var(--accent); }

        .agent-stat-label {
            font-size: 0.7rem;
            color: var(--text-dim);
            text-transform: uppercase;
        }

        .agent-card-actions {
            display: flex;
            gap: 8px;
        }

        .agent-action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .agent-action-btn.primary {
            background: linear-gradient(135deg, #a855f7, #6366f1);
            color: #fff;
        }

        .agent-action-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        .agent-action-btn.secondary {
            background: var(--bg-card);
            color: var(--text);
            border: 1px solid var(--border);
        }

        .agent-action-btn.secondary:hover {
            border-color: var(--accent);
        }

        .agent-action-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-agents {
            grid-column: 1 / -1;
            text-align: center;
            padding: 60px 20px;
            color: var(--text-dim);
        }

        .no-agents-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .no-agents-text {
            font-size: 1rem;
            margin-bottom: 8px;
        }

        .no-agents-subtext {
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .idea-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .idea-card-drag-handle {
            cursor: grab;
            color: var(--text-dim);
            font-size: 0.8rem;
            padding: 2px 4px;
            border-radius: 4px;
            pointer-events: auto !important;
            user-select: none;
            opacity: 0.5;
            transition: opacity 0.2s, background 0.2s;
        }

        .idea-card-drag-handle:hover {
            opacity: 1;
            background: rgba(255, 255, 255, 0.1);
        }

        .idea-card-drag-handle:active {
            cursor: grabbing;
        }

        .idea-card-toggle {
            font-size: 0.65rem;
            color: var(--text-dim);
            transition: transform 0.2s;
            flex-shrink: 0;
        }

        .idea-card.collapsed .idea-card-toggle {
            transform: rotate(-90deg);
        }

        .idea-card-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 0;
            flex: 1;
        }

        .idea-card:not(.collapsed) .idea-card-title {
            margin-bottom: 6px;
        }

        .idea-card-details {
            display: block;
        }

        .idea-card.collapsed .idea-card-details {
            display: none;
        }

        .idea-card-tagline {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-bottom: 8px;
            line-height: 1.4;
        }

        .idea-card-meta {
            display: flex;
            gap: 10px;
            font-size: 0.75rem;
            color: var(--text-dim);
        }

        .rejection-reason {
            font-size: 0.8rem;
            color: #ef4444;
            margin-top: 8px;
            padding: 8px 10px;
            background: rgba(239, 68, 68, 0.1);
            border-radius: 6px;
            border-left: 3px solid #ef4444;
        }

        .vote-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border);
        }

        .vote-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg);
            color: var(--text-secondary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .vote-btn:hover {
            border-color: var(--accent);
            background: var(--bg-elevated);
        }

        .vote-btn.for:hover {
            border-color: #22c55e;
            color: #22c55e;
        }

        .vote-btn.against:hover {
            border-color: #ef4444;
            color: #ef4444;
        }

        .vote-btn .vote-count {
            font-weight: 600;
        }

        .add-vote-btn {
            margin-left: auto;
            padding: 6px 10px;
            border: 1px dashed var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .add-vote-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .your-votes {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
            display: flex;
            align-items: center;
        }

        /* Comments Section */
        .comment-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: transparent;
            color: var(--text-dim);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comment-btn:hover {
            border-color: var(--accent);
            color: var(--accent);
        }

        .comment-btn.has-comments {
            color: var(--accent);
        }

        .comments-section {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .comments-section.open {
            display: block;
        }

        .comments-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 10px;
        }

        .comment-item {
            padding: 8px 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            margin-bottom: 6px;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .comment-author {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--accent);
        }

        .comment-time {
            font-size: 0.7rem;
            color: var(--text-dim);
        }

        .comment-content {
            font-size: 0.85rem;
            color: var(--text);
            line-height: 1.4;
        }

        .comment-form {
            display: flex;
            gap: 8px;
        }

        .comment-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--bg);
            color: var(--text);
            font-size: 0.85rem;
            font-family: inherit;
        }

        .comment-input:focus {
            outline: none;
            border-color: var(--accent);
        }

        .comment-submit {
            padding: 8px 16px;
            background: var(--accent);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .comment-submit:hover {
            opacity: 0.9;
        }

        .comment-submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .no-comments {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: center;
            padding: 10px;
        }

        .comment-login-prompt {
            font-size: 0.8rem;
            color: var(--text-dim);
            text-align: center;
            padding: 10px;
        }

        /* Collapsible App Groups in Governance */
        .proposal-group {
            margin-bottom: 12px;
        }

        .proposal-group-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: background 0.2s;
        }

        .proposal-group-header:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .group-toggle {
            font-size: 0.7rem;
            color: var(--text-dim);
            width: 12px;
        }

        .group-emoji {
            font-size: 0.9rem;
        }

        .group-name {
            font-weight: 600;
            font-size: 0.85rem;
            color: var(--text);
        }

        .group-count {
            font-size: 0.75rem;
            color: var(--text-dim);
            margin-left: auto;
        }

        .proposal-group-content {
            padding-left: 4px;
        }

        /* Work button for Working On column */
        .work-btn {
            width: 100%;
            margin-top: 8px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: not-allowed;
            opacity: 0.7;
            font-size: 0.85rem;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .section-kanban {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .section-kanban {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Mobile Voting Info - only show on mobile */
        .mobile-voting-info {
            display: none;
        }

        @media (max-width: 768px) {
            .factory-sidebar {
                display: none;
            }

            .factory-header {
                padding: 16px 20px;
            }

            .factory-content {
                padding: 16px;
            }

            .kanban-board {
                grid-template-columns: 1fr;
            }

            .section-kanban {
                grid-template-columns: 1fr;
            }

            /* Mobile voting info section */
            .mobile-voting-info {
                display: block;
                background: var(--bg-card);
                border: 1px solid var(--border);
                border-radius: 12px;
                margin-bottom: 16px;
                overflow: hidden;
            }

            .mobile-voting-header {
                display: flex;
                align-items: center;
                gap: 10px;
                padding: 14px 16px;
                cursor: pointer;
                background: rgba(255, 255, 255, 0.02);
            }

            .mobile-voting-header h3 {
                font-size: 0.95rem;
                font-weight: 700;
                margin: 0;
                color: var(--text-primary);
            }

            .mobile-voting-toggle {
                font-size: 0.75rem;
                color: var(--text-dim);
                transition: transform 0.2s ease;
            }

            .mobile-voting-info:not(.collapsed) .mobile-voting-toggle {
                transform: rotate(90deg);
            }

            .mobile-voting-content {
                padding: 0 16px 16px;
                display: none;
            }

            .mobile-voting-info:not(.collapsed) .mobile-voting-content {
                display: block;
            }

            .mobile-voting-section {
                padding: 12px 0;
                border-bottom: 1px solid var(--border);
            }

            .mobile-voting-section:last-child {
                border-bottom: none;
                padding-bottom: 0;
            }

            .mobile-voting-section strong {
                display: block;
                font-size: 0.85rem;
                margin-bottom: 6px;
                color: var(--text-primary);
            }

            .mobile-voting-section p {
                font-size: 0.8rem;
                color: var(--text-dim);
                margin: 4px 0;
                line-height: 1.4;
            }
        }

        /* Small phones (480px) */
        @media (max-width: 480px) {
            .factory-header {
                padding: 12px 16px;
                flex-wrap: wrap;
                gap: 12px;
            }

            .factory-tabs {
                width: 100%;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .factory-tab {
                padding: 8px 14px;
                font-size: 0.8rem;
                white-space: nowrap;
            }

            .factory-content {
                padding: 12px;
            }

            .loops-section {
                padding: 16px;
                border-radius: 12px;
            }

            .loops-header h3 {
                font-size: 1rem;
            }

            .loop-category-header {
                padding: 12px;
            }

            .loop-item-header {
                padding: 10px 12px 10px 24px;
            }

            .loop-item-content {
                padding: 0 12px 12px 32px;
            }

            .governance-tabs-container {
                padding: 16px;
                border-radius: 12px;
            }

            .governance-tabs {
                width: 100%;
            }

            .governance-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .section-column {
                padding: 10px;
                border-radius: 10px;
            }

            .idea-card {
                padding: 10px;
                border-radius: 8px;
            }

            .idea-card-title {
                font-size: 0.85rem;
            }

            .modal-content {
                padding: 16px;
                border-radius: 12px;
                margin: 12px;
                width: calc(100% - 24px);
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-btn {
                width: 100%;
            }

            .notebox-column {
                width: 100%;
                min-width: unset;
            }

            .notebox-card {
                padding: 12px;
            }

            .docs-link {
                padding: 10px 12px;
                flex-direction: column;
                text-align: center;
                gap: 6px;
            }

            .docs-arrow {
                display: none;
            }

            .auth-card {
                padding: 24px 16px;
                margin: 16px;
                max-width: calc(100% - 32px);
            }

            .telegram-btn {
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        /* Very small phones (375px) */
        @media (max-width: 375px) {
            .factory-header {
                padding: 10px 12px;
            }

            .factory-logo h1 {
                font-size: 1rem;
            }

            .factory-tab {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .factory-content {
                padding: 10px;
            }

            .loops-section {
                padding: 12px;
            }

            .loops-header h3 {
                font-size: 0.95rem;
            }

            .loops-header p {
                font-size: 0.8rem;
            }

            .loop-category-header {
                padding: 10px;
                gap: 8px;
            }

            .category-icon {
                font-size: 1rem;
            }

            .category-name {
                font-size: 0.9rem;
            }

            .loop-item-header {
                padding: 8px 10px 8px 20px;
                gap: 8px;
            }

            .loop-title {
                font-size: 0.8rem;
            }

            .loop-item-content {
                padding: 0 10px 10px 28px;
                font-size: 0.75rem;
            }

            .governance-tabs-container {
                padding: 12px;
            }

            .governance-main-title {
                font-size: 0.95rem;
            }

            .governance-tab {
                padding: 5px 8px;
                font-size: 0.7rem;
            }

            .section-column {
                padding: 8px;
            }

            .section-column-header {
                font-size: 0.75rem;
                margin-bottom: 8px;
            }

            .section-add-btn {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .idea-card {
                padding: 8px;
            }

            .idea-card-title {
                font-size: 0.8rem;
            }

            .idea-card-tagline {
                font-size: 0.75rem;
            }

            .idea-card-meta {
                font-size: 0.7rem;
                gap: 6px;
            }

            .vote-btn {
                padding: 5px 8px;
                font-size: 0.75rem;
            }

            .modal-content {
                padding: 14px;
                margin: 8px;
                width: calc(100% - 16px);
            }

            .modal-title {
                font-size: 1rem;
            }

            .form-label {
                font-size: 0.8rem;
            }

            .form-input,
            .form-select,
            .form-textarea {
                padding: 10px 12px;
                font-size: 0.9rem;
            }

            .modal-btn {
                padding: 10px;
                font-size: 0.9rem;
            }

            .notebox-card {
                padding: 10px;
            }

            .notebox-card-title {
                font-size: 0.9rem;
            }

            .notebox-card-content {
                font-size: 0.8rem;
            }

            .notebox-card-btn {
                padding: 6px;
                font-size: 0.75rem;
            }

            .mobile-voting-header {
                padding: 12px;
            }

            .mobile-voting-header h3 {
                font-size: 0.85rem;
            }

            .mobile-voting-content {
                padding: 0 12px 12px;
            }

            .mobile-voting-section strong {
                font-size: 0.8rem;
            }

            .mobile-voting-section p {
                font-size: 0.75rem;
            }

            .leaderboard-item {
                padding: 10px;
                gap: 8px;
            }

            .leaderboard-rank {
                font-size: 1rem;
                width: 28px;
            }

            .leaderboard-name {
                font-size: 0.75rem;
            }

            .leaderboard-stats {
                font-size: 0.7rem;
            }

            .leaderboard-rep {
                font-size: 0.95rem;
            }
        }
    </style>
</head>
<body>
    <!-- Main Site Navigation -->
    <nav id="main-nav"></nav>

    <!-- User Panel (hidden - auth handled by nav) -->
    <div class="factory-user-panel" id="userPanel" style="display: none;"></div>

    <!-- Main Layout -->
    <div class="factory-main">
        <!-- TELOS Tab Content -->
        <div class="tab-content active" id="telosContent">
            <!-- Sidebar -->
            <aside class="factory-sidebar">
                <div class="sidebar-section rep-explainer">
                    <div class="sidebar-title">How Voting Works</div>
                    <div class="rep-section earn">
                        <div class="rep-section-header">
                            <span>ðŸ’³</span> Get Credits
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">1,000</span>
                            <span class="rep-item-desc">credits per $1 USDC</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-desc" style="font-size: 0.75rem; color: var(--text-dim);">Buy credits on your <a href="/profile.html" style="color: var(--accent);">Profile</a></span>
                        </div>
                    </div>
                    <div class="rep-section spend">
                        <div class="rep-section-header">
                            <span>ðŸ—³ï¸</span> Spend Credits
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value cost">FREE</span>
                            <span class="rep-item-desc">1st vote on any proposal</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value cost">1â†’3â†’6</span>
                            <span class="rep-item-desc">quadratic cost for more votes</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-desc" style="font-size: 0.75rem; color: #22c55e;">Credits spent = removed from circulation</span>
                        </div>
                    </div>
                    <div class="rep-section" style="background: rgba(34, 197, 94, 0.1);">
                        <div class="rep-section-header" style="color: #22c55e;">
                            <span>ðŸ“</span> Submit Proposals
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value positive">FREE</span>
                            <span class="rep-item-desc">to submit any proposal</span>
                        </div>
                        <div class="rep-item">
                            <span class="rep-item-value" style="color: var(--text-dim);">7 days</span>
                            <span class="rep-item-desc">to get moved to voting or removed</span>
                        </div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title">Your Stats</div>
                    <div class="stat-card">
                        <div class="stat-label">Credits</div>
                        <div class="stat-value accent" id="userRep">0</div>
                    </div>
                </div>

                <div class="sidebar-section">
                    <div class="sidebar-title" style="display: flex; align-items: center; gap: 8px;">
                        <span>ðŸ†</span> Leaderboard
                    </div>
                    <div id="leaderboard">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </aside>

            <!-- Content -->
            <main class="factory-content">
                <div class="content-header">
                    <div class="governance-title-row">
                        <h2 style="font-size: 1.3rem; font-weight: 800; margin: 0;">ðŸ›ï¸ Governance</h2>
                        <button class="notebox-connect-btn" onclick="openConnectNoteboxModal()" title="Submit an idea">+</button>
                    </div>
                </div>

                <!-- Mobile How Voting Works (collapsed) -->
                <div class="mobile-voting-info collapsed" id="mobileVotingInfo">
                    <div class="mobile-voting-header" onclick="toggleMobileVotingInfo()">
                        <span class="mobile-voting-toggle">â–¶</span>
                        <h3>ðŸ“‹ How Voting Works</h3>
                    </div>
                    <div class="mobile-voting-content">
                        <div class="mobile-voting-section">
                            <strong>ðŸ’³ Get Credits</strong>
                            <p>1,000 credits per $1 USDC. <a href="/profile.html" style="color: var(--accent);">Buy on Profile â†’</a></p>
                        </div>
                        <div class="mobile-voting-section">
                            <strong>ðŸ—³ï¸ Spend Credits</strong>
                            <p><span style="color: #22c55e;">FREE</span> first vote on any proposal</p>
                            <p>Quadratic cost for more: 1 â†’ 3 â†’ 6 credits</p>
                            <p style="color: #22c55e; font-size: 0.8rem;">Credits spent = removed from circulation</p>
                        </div>
                        <div class="mobile-voting-section">
                            <strong>ðŸ“ Submit Proposals</strong>
                            <p><span style="color: #22c55e;">FREE</span> to submit â€¢ 7 days to get voted on</p>
                        </div>
                    </div>
                </div>

                <!-- Technical Loops Section -->
                <div class="loops-section collapsed" id="loops">
                    <div class="loops-header" onclick="toggleLoopsSection()">
                        <div class="loops-header-row">
                            <span class="loops-toggle">â–¼</span>
                            <h3>ðŸ”„ SUITE LOOPS</h3>
                        </div>
                        <p>The autonomous processes that make SUITE alive. Click to expand technical details.</p>
                    </div>
                    <div class="loops-content">
                    <div class="loops-categories-grid">

                    <!-- AI Loops Category -->
                    <div class="loop-category" id="aiLoopsCategory">
                        <div class="loop-category-header" onclick="toggleLoopCategory('aiLoopsCategory')">
                            <span class="category-toggle">â–¼</span>
                            <span class="category-icon">ðŸ¤–</span>
                            <span class="category-name">AI Loops</span>
                            <span class="category-count">2 loops</span>
                        </div>
                        <div class="loop-category-content">
                            <!-- AI Fleet Loop -->
                            <div class="loop-item" id="aiFleetLoop">
                                <div class="loop-item-header" onclick="toggleLoopItem('aiFleetLoop')">
                                    <span class="loop-toggle">â–¶</span>
                                    <span class="loop-title">AI Fleet Loop</span>
                                    <span class="loop-status-badge partial">ðŸŸ¡ Partial</span>
                                </div>
                                <div class="loop-item-content">
                                    <div class="loop-trigger">
                                        <span class="trigger-label">Trigger:</span> Daily at 10 AM EST
                                    </div>
                                    <div class="loop-steps">
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Fetch X poll winner from previous day</span>
                                        </div>
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Generate app specification from poll description</span>
                                        </div>
                                        <div class="loop-step admin">
                                            <span class="step-tag admin">ADMIN</span>
                                            <span class="step-text">Review spec, adjust if needed</span>
                                        </div>
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Build app with Claude Code</span>
                                        </div>
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Deploy to staging environment</span>
                                        </div>
                                        <div class="loop-step admin">
                                            <span class="step-tag admin">ADMIN</span>
                                            <span class="step-text">QA review and approve</span>
                                        </div>
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Publish to SUITE store</span>
                                        </div>
                                        <div class="loop-step auto">
                                            <span class="step-tag auto">AUTO</span>
                                            <span class="step-text">Post announcement to X</span>
                                        </div>
                                    </div>
                                    <div class="loop-output">
                                        <span class="output-label">Output:</span> New app live in store
                                    </div>
                                </div>
                            </div>

                            <!-- Get to Work Loop -->
                            <div class="loop-item" id="getToWorkLoop">
                                <div class="loop-item-header" onclick="toggleLoopItem('getToWorkLoop')">
                                    <span class="loop-toggle">â–¶</span>
                                    <span class="loop-title">Get to Work Loop</span>
                                    <span class="loop-status-badge partial">ðŸŸ¡ Partial</span>
                                </div>
                                <div class="loop-item-content">
                                    <div class="loop-trigger">
                                        <span class="trigger-label">Trigger:</span> Continuous / On-demand
                                    </div>
                                    <div class="loop-steps tree-view">
                                        <div class="loop-step check">
                                            <span class="step-text">Check: Items in VOTE column?</span>
                                        </div>
                                        <div class="loop-branch yes">
                                            <span class="branch-label">YES â†’</span>
                                            <div class="branch-steps">
                                                <div class="loop-step auto">
                                                    <span class="step-tag auto">AUTO</span>
                                                    <span class="step-text">Analyze requirements</span>
                                                </div>
                                                <div class="loop-step auto">
                                                    <span class="step-tag auto">AUTO</span>
                                                    <span class="step-text">Generate implementation plan</span>
                                                </div>
                                                <div class="loop-step admin">
                                                    <span class="step-tag admin">ADMIN</span>
                                                    <span class="step-text">Review and approve</span>
                                                </div>
                                                <div class="loop-step auto">
                                                    <span class="step-tag auto">AUTO</span>
                                                    <span class="step-text">Execute implementation</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="loop-step check">
                                            <span class="step-text">Check: Items in SUBMITTED column?</span>
                                        </div>
                                        <div class="loop-branch yes">
                                            <span class="branch-label">YES â†’</span>
                                            <div class="branch-steps">
                                                <div class="loop-step auto">
                                                    <span class="step-tag auto">AUTO</span>
                                                    <span class="step-text">Move top item to VOTE</span>
                                                </div>
                                                <div class="loop-step">
                                                    <span class="step-text">â†© Return to first check</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="loop-step check">
                                            <span class="step-text">Check: Nothing pending?</span>
                                        </div>
                                        <div class="loop-branch yes">
                                            <span class="branch-label">YES â†’</span>
                                            <div class="branch-steps">
                                                <div class="loop-step rest">
                                                    <span class="step-text">ðŸ’¤ REST <span class="future-note">(future: auto-generate proposals)</span></span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="loop-output">
                                        <span class="output-label">Output:</span> Governance items processed
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Cadence Loops Category -->
                    <div class="loop-category" id="cadenceLoopsCategory">
                        <div class="loop-category-header" onclick="toggleLoopCategory('cadenceLoopsCategory')">
                            <span class="category-toggle">â–¼</span>
                            <span class="category-icon">â°</span>
                            <span class="category-name">Cadence Loops</span>
                            <span class="category-count">2 active</span>
                            <span class="loop-status-badge full">ðŸŸ¢ Auto</span>
                        </div>
                        <div class="loop-category-content">
                            <!-- Daily Cadence -->
                            <div class="loop-item" id="dailyCadence">
                                <div class="loop-item-header" onclick="toggleLoopItem('dailyCadence')">
                                    <span class="loop-toggle">â–¶</span>
                                    <span class="loop-title">Daily Schedule</span>
                                </div>
                                <div class="loop-item-content">
                                    <div class="cadence-list">
                                        <div class="cadence-item">
                                            <span class="cadence-time">10:00 AM EST</span>
                                            <span class="cadence-action">AI Fleet app build trigger</span>
                                        </div>
                                        <div class="cadence-item">
                                            <span class="cadence-time">11:00 AM EST</span>
                                            <span class="cadence-action">X poll for next day's app</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Weekly Cadence -->
                            <div class="loop-item" id="weeklyCadence">
                                <div class="loop-item-header" onclick="toggleLoopItem('weeklyCadence')">
                                    <span class="loop-toggle">â–¶</span>
                                    <span class="loop-title">Weekly Schedule</span>
                                </div>
                                <div class="loop-item-content">
                                    <div class="cadence-list">
                                        <div class="cadence-item placeholder">
                                            <span class="cadence-action">No weekly automations configured yet</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Links to Docs -->
                    <div class="loops-docs-links">
                        <a href="/docs/user-flows/" class="docs-link">
                            <span class="docs-icon">ðŸ“–</span>
                            <span class="docs-text">Admin Flows</span>
                            <span class="docs-arrow">â†’ See Docs</span>
                        </a>
                        <a href="/docs/user-flows/" class="docs-link">
                            <span class="docs-icon">ðŸ“–</span>
                            <span class="docs-text">User Flows</span>
                            <span class="docs-arrow">â†’ See Docs</span>
                        </a>
                    </div>

                    <p class="loops-footer">These loops define what SUITE does. Propose changes below to adjust how they run.</p>
                    </div>
                </div>

                <!-- Governance View -->
                <div id="governanceView">
                    <div class="governance-tabs-container">
                        <div class="governance-tabs-header">
                            <div class="governance-tabs">
                                <button class="governance-tab active" data-tab="apps" onclick="switchGovernanceTab('apps')">
                                    ðŸ“± Apps <span class="tab-count" id="appsTabCount">0</span>
                                </button>
                                <button class="governance-tab" data-tab="business" onclick="switchGovernanceTab('business')">
                                    ðŸ’° Business <span class="tab-count" id="businessTabCount">0</span>
                                </button>
                                <button class="governance-tab" data-tab="articles" onclick="switchGovernanceTab('articles')">
                                    ðŸ“ Articles <span class="tab-count" id="articlesTabCount">0</span>
                                </button>
                                <button class="governance-tab" data-tab="social" onclick="switchGovernanceTab('social')">
                                    ðŸ”„ Social <span class="tab-count" id="socialTabCount">0</span>
                                </button>
                                <button class="governance-tab" data-tab="agents" onclick="switchGovernanceTab('agents')">
                                    ðŸ¤– Agents <span class="tab-count" id="agentsTabCount">0</span>
                                </button>
                            </div>
                        </div>

                        <!-- Tab Contents -->
                        <div class="governance-tab-content active" id="appsTabContent">
                            <div class="section-kanban" id="suiteAppsKanban">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="governance-tab-content" id="businessTabContent">
                            <div class="section-kanban" id="businessKanban">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="governance-tab-content" id="articlesTabContent">
                            <div class="section-kanban" id="contentKanban">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="governance-tab-content" id="socialTabContent">
                            <div class="section-kanban" id="socialKanban">
                                <!-- Populated by JS -->
                            </div>
                        </div>

                        <div class="governance-tab-content" id="agentsTabContent">
                            <div class="agents-container" id="agentsContainer">
                                <div class="agents-header">
                                    <p class="agents-description">Autonomous AI agents that propose improvements for SUITE apps. Each agent has a mission and learns from your feedback.</p>
                                </div>
                                <div class="agents-grid" id="agentsGrid">
                                    <!-- Populated by JS -->
                                    <div class="loading-agents">Loading agents...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

            </main>
        </div>

    </div>

    <!-- NoteBox Archive Modal -->
    <div class="modal-overlay" id="noteboxArchiveModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title" id="noteboxArchiveTitle">Mark as Done</h3>
                <button class="modal-close" onclick="hideNoteboxArchiveModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label" id="noteboxArchiveLabel">What did you accomplish?</label>
                <textarea class="form-textarea" id="noteboxArchiveReason" rows="3" placeholder="Briefly describe what was done or why you're archiving this..."></textarea>
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="form-btn secondary" onclick="hideNoteboxArchiveModal()" style="flex: 1;">Cancel</button>
                <button class="form-btn" id="noteboxArchiveConfirm" onclick="confirmNoteboxArchive()" style="flex: 1;">Confirm</button>
            </div>
        </div>
    </div>

    <!-- Push To Modal -->
    <div class="modal-overlay" id="pushToModal">
        <div class="modal-content" style="max-width: 350px;">
            <div class="modal-header">
                <h3 class="modal-title">Push To...</h3>
                <button class="modal-close" onclick="hidePushToModal()">&times;</button>
            </div>
            <div id="pushToDestinations" style="display: flex; flex-direction: column; gap: 8px;">
                <!-- Populated by JS -->
            </div>
        </div>
    </div>

    <!-- Add Destination Modal -->
    <div class="modal-overlay" id="addDestinationModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">Add Destination</h3>
                <button class="modal-close" onclick="hideAddDestinationModal()">&times;</button>
            </div>
            <div class="form-group">
                <label class="form-label">Name</label>
                <input type="text" class="form-input" id="newDestinationName" placeholder="e.g., artstu.ca">
            </div>
            <div class="form-group">
                <label class="form-label">Icon (emoji)</label>
                <input type="text" class="form-input" id="newDestinationIcon" placeholder="e.g., ðŸŽ¨" maxlength="2">
            </div>
            <div class="form-group">
                <label class="form-label">Description</label>
                <input type="text" class="form-input" id="newDestinationDesc" placeholder="What kind of ideas go here?">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 16px;">
                <button class="form-btn secondary" onclick="hideAddDestinationModal()" style="flex: 1;">Cancel</button>
                <button class="form-btn" onclick="createDestination()" style="flex: 1;">Create</button>
            </div>
        </div>
    </div>

    <!-- Submit Modal -->
    <div class="modal-overlay" id="submitModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">New Proposal</h3>
                <button class="modal-close" onclick="hideSubmitModal()">&times;</button>
            </div>
            <form id="submitForm" onsubmit="submitProposal(event)">
                <div class="form-group">
                    <label class="form-label">Section</label>
                    <select id="proposalSection" class="form-select" onchange="onSectionChange()" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #1a1a2e; color: #ffffff; font-size: 0.95rem;">
                        <option value="suite_apps" style="background: #1a1a2e; color: #ffffff;">ðŸ“± SUITE Apps</option>
                        <option value="business" style="background: #1a1a2e; color: #ffffff;">ðŸ’¼ Business</option>
                        <option value="content" style="background: #1a1a2e; color: #ffffff;">ðŸ“ Content</option>
                        <option value="social" style="background: #1a1a2e; color: #ffffff;">ðŸŒ Social</option>
                    </select>
                </div>

                <div class="form-group" id="newAppToggleGroup" style="display: none;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; padding: 12px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 8px;">
                        <input type="checkbox" id="isNewApp" onchange="onNewAppToggle()" style="width: 18px; height: 18px; accent-color: var(--accent);">
                        <span style="color: #fff; font-weight: 600;">ðŸ†• This is a NEW app idea</span>
                    </label>
                </div>

                <div class="form-group">
                    <label class="form-label">What's your idea?</label>
                    <textarea class="form-textarea" id="proposalContent"
                        placeholder="Describe your idea, feature request, bug, or suggestion..."
                        rows="6" required></textarea>
                    <button type="button" class="refine-btn" id="refineBtn" onclick="refineProposal()">
                        <span class="refine-icon">âœ¨</span>
                        <span class="refine-text">Refine with AI</span>
                    </button>
                </div>

                <div class="form-group">
                    <label class="form-label">Related App (optional)</label>
                    <select id="proposalApp" class="form-select" style="width: 100%; padding: 12px; border-radius: 8px; border: 1px solid var(--border); background: #1a1a2e; color: #ffffff; font-size: 0.95rem;">
                        <option value="" style="background: #1a1a2e; color: #ffffff;">-- None (General Proposal) --</option>
                    </select>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-dim); margin-bottom: 16px;">
                    AI will auto-generate title and category from your description.
                </p>

                <div class="modal-actions">
                    <button type="button" class="modal-btn cancel" onclick="hideSubmitModal()">Cancel</button>
                    <button type="submit" class="modal-btn submit" id="submitBtn">Submit Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal-overlay" id="authModal">
        <div class="modal-content" style="text-align: center;">
            <div class="modal-header">
                <h3 class="modal-title">Connect to Participate</h3>
                <button class="modal-close" onclick="hideAuthModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 24px;">
                Connect your Telegram account to submit proposals and vote.
            </p>
            <button class="telegram-btn" onclick="connectTelegram()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                </svg>
                Connect with Telegram
            </button>
            <div style="display: flex; align-items: center; gap: 12px; margin: 16px 0; color: var(--text-dim); font-size: 0.85rem;">
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
                <span>or</span>
                <div style="flex: 1; height: 1px; background: var(--border);"></div>
            </div>
            <button onclick="connectWallet()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #627eea, #8b5cf6); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                <span style="font-size: 1.2rem;">ðŸ”—</span>
                Connect Wallet
            </button>
            <button onclick="connectDemo()" style="margin-top: 16px; background: transparent; border: 1px solid var(--border); color: var(--text-dim); padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                Try Demo Mode
            </button>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div class="modal-overlay" id="rejectionModal">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3 class="modal-title">âŒ Rejection Reason</h3>
                <button class="modal-close" onclick="hideRejectionModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 16px;">
                Please provide a reason for rejecting this item:
            </p>
            <div class="form-group">
                <textarea class="form-textarea" id="rejectionReason" placeholder="Why is this being rejected?" rows="3"></textarea>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideRejectionModal()">Cancel</button>
                <button type="button" class="modal-btn submit" onclick="confirmRejection()" style="background: #ef4444;">Reject</button>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal -->
    <div class="modal-overlay" id="deleteModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 class="modal-title">ðŸ—‘ï¸ Delete Item</h3>
                <button class="modal-close" onclick="hideDeleteModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 20px;">
                Are you sure you want to delete this item? This action cannot be undone.
            </p>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideDeleteModal()">Cancel</button>
                <button type="button" class="modal-btn submit" onclick="confirmDelete()" style="background: #ef4444;">Delete</button>
            </div>
        </div>
    </div>

    <!-- Vote Modal -->
    <div class="modal-overlay" id="voteModal">
        <div class="modal-content" style="max-width: 380px;">
            <div class="modal-header">
                <h3 class="modal-title">ðŸ—³ï¸ Cast Your Vote</h3>
                <button class="modal-close" onclick="hideVoteModal()">&times;</button>
            </div>
            <div style="margin-bottom: 16px;">
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px;">
                    <span>Proposal:</span>
                    <span id="voteProposalId">-</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim); margin-bottom: 8px;">
                    <span>Your votes on this proposal:</span>
                    <span id="voteCurrentCount">0</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; margin-bottom: 8px;">
                    <span>Cost for next vote:</span>
                    <span id="voteNextCost" style="color: var(--accent); font-weight: 600;">FREE</span>
                </div>
                <div style="display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-dim);">
                    <span>Your Credits:</span>
                    <span id="voteUserRep">0</span>
                </div>
            </div>
            <div style="background: var(--bg); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                <div style="font-size: 0.8rem; font-weight: 600; margin-bottom: 8px;">Vote Direction:</div>
                <div style="display: flex; gap: 12px;">
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="voteType" value="for" id="voteTypeFor" checked>
                        <span>ðŸ‘ FOR</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 6px; cursor: pointer;">
                        <input type="radio" name="voteType" value="against" id="voteTypeAgainst">
                        <span>ðŸ‘Ž AGAINST</span>
                    </label>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="modal-btn cancel" onclick="hideVoteModal()">Cancel</button>
                <button type="button" class="modal-btn submit" id="voteSubmitBtn" onclick="submitVote()">Cast Vote</button>
            </div>
        </div>
    </div>

    <!-- Global Push Dropdown (lives at body level to avoid stacking context issues) -->
    <div class="push-dropdown" id="globalPushDropdown" data-idea-id="" data-step="destinations">
        <div class="push-dropdown-header">Push to...</div>
        <button class="push-dropdown-item" onclick="event.stopPropagation(); showSectionSelect()">
            ðŸ›ï¸ getSUITE Governance
        </button>
    </div>

    <!-- Connect NoteBox Modal -->
    <div class="modal-overlay" id="connectNoteboxModal">
        <div class="modal-content" style="text-align: center; max-width: 420px;">
            <div class="modal-header">
                <h3 class="modal-title">ðŸ“ Submit Ideas</h3>
                <button class="modal-close" onclick="closeConnectNoteboxModal()">&times;</button>
            </div>
            <p style="color: var(--text-dim); margin-bottom: 24px; line-height: 1.6;">
                Contribute ideas to getSuite Governance and vote on proposals.
            </p>
            <div id="connectNoteboxContent">
                <!-- Content changes based on auth state -->
            </div>
            <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid var(--border);">
                <a href="https://getsuite.app/notebox" target="_blank" style="color: var(--text-dim); font-size: 0.85rem; text-decoration: none;">
                    Learn more about NoteBox â†’
                </a>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // State
        let currentUser = null;
        let proposals = [];
        let users = [];
        let currentFilter = 'all';
        let currentView = 'kanban';
        let userVotes = {}; // { proposalId: voteCount }
        let pendingVote = null; // { proposalId, voteType }

        // Factory Tab State
        let currentTab = 'telos';

        // NoteBox State
        let noteboxIdeas = [];
        let noteboxDestinations = [];
        let currentDestination = 'all'; // 'all' or destination slug
        let noteboxArchiveIdeaId = null;
        let noteboxArchiveAction = null; // 'done' or 'dismiss'
        let pushingIdeaId = null; // ID of idea being pushed

        // Governance Sections State
        let governanceProposals = [];  // From 'factory_proposals' table

        // Drag-Drop State
        let draggedItem = null;  // { id, type: 'idea' | 'proposal', section }
        let pendingRejection = null;  // { id, type, section, newStatus }

        // Collapsed App Groups State (persisted to localStorage)
        let collapsedGroups = JSON.parse(localStorage.getItem('factory_collapsed_groups') || '{}');

        function toggleAppGroup(sectionType, status, appSlug) {
            const key = `${sectionType}-${status}-${appSlug}`;
            collapsedGroups[key] = !collapsedGroups[key];
            localStorage.setItem('factory_collapsed_groups', JSON.stringify(collapsedGroups));
            renderGovernanceSections();
        }

        function isGroupCollapsed(sectionType, status, appSlug) {
            const key = `${sectionType}-${status}-${appSlug}`;
            return collapsedGroups[key] || false;
        }

        // Group proposals by their linked app
        function groupProposalsByApp(proposals) {
            const groups = {};

            // Group by app_slug (null = "General", is_new_app = "New App Ideas")
            proposals.forEach(p => {
                let slug;
                // Check for new app (either is_new_app flag or app_slug='new_app')
                if (p.is_new_app || p.app_slug === 'new_app') {
                    slug = '_new_app';
                } else {
                    slug = p.app_slug || '_general';
                }

                if (!groups[slug]) {
                    if (slug === '_new_app') {
                        groups[slug] = {
                            slug: slug,
                            name: 'New App Ideas',
                            emoji: 'ðŸ†•',
                            proposals: []
                        };
                    } else {
                        const app = p.app_slug ? factoryApps.find(a => a.slug === p.app_slug) : null;
                        groups[slug] = {
                            slug: slug,
                            name: app ? app.name : 'General',
                            emoji: app ? 'ðŸ“±' : 'ðŸ“‹',
                            proposals: []
                        };
                    }
                }
                groups[slug].proposals.push(p);
            });

            // Sort: New App first, then apps (alphabetically), then General last
            return Object.values(groups).sort((a, b) => {
                if (a.slug === '_new_app') return -1;
                if (b.slug === '_new_app') return 1;
                if (a.slug === '_general') return 1;
                if (b.slug === '_general') return -1;
                return a.name.localeCompare(b.name);
            });
        }

        // Render grouped proposals in a column
        function renderGroupedColumn(proposals, sectionType, status) {
            const groups = groupProposalsByApp(proposals);

            if (groups.length === 0) {
                return '<div class="empty-column">No proposals</div>';
            }

            // If only one group AND it's General, render flat (no grouping needed)
            if (groups.length === 1 && groups[0].slug === '_general') {
                return proposals.map(p => renderGovernanceProposalCard(p, sectionType)).join('');
            }

            return groups.map(group => {
                const isCollapsed = isGroupCollapsed(sectionType, status, group.slug);
                const count = group.proposals.length;

                return `
                    <div class="proposal-group ${isCollapsed ? 'collapsed' : ''}">
                        <div class="proposal-group-header" onclick="toggleAppGroup('${sectionType}', '${status}', '${group.slug}')">
                            <span class="group-toggle">${isCollapsed ? 'â–¶' : 'â–¼'}</span>
                            <span class="group-emoji">${group.emoji}</span>
                            <span class="group-name">${escapeHtml(group.name)}</span>
                            <span class="group-count">(${count})</span>
                        </div>
                        <div class="proposal-group-content" style="${isCollapsed ? 'display: none;' : ''}">
                            ${group.proposals.map(p => renderGovernanceProposalCard(p, sectionType)).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Category config
        const CATEGORIES = {
            feature: { emoji: 'âš¡', label: 'Feature', color: '#3b82f6' },
            bug: { emoji: 'ðŸ›', label: 'Bug', color: '#ef4444' },
            app_idea: { emoji: 'ðŸ’¡', label: 'App Idea', color: '#a855f7' },
            improvement: { emoji: 'âœ¨', label: 'Improvement', color: '#22c55e' },
            docs: { emoji: 'ðŸ“š', label: 'Docs', color: '#9ca3af' },
            integration: { emoji: 'ðŸ”—', label: 'Integration', color: '#14b8a6' },
            tokenomics: { emoji: 'ðŸ’°', label: 'Tokenomics', color: '#ff8c42' }
        };

        // Status config
        const STATUSES = {
            submitted: { icon: 'ðŸ“¥', label: 'Submitted' },
            open_voting: { icon: 'ðŸ—³ï¸', label: 'Voting' },
            working_on: { icon: 'âš™ï¸', label: 'Working On' },
            passed: { icon: 'âœ…', label: 'Implemented' },
            rejected: { icon: 'âŒ', label: 'Rejected' },
            implemented: { icon: 'ðŸš€', label: 'Implemented' },
            duplicate: { icon: 'ðŸ”„', label: 'Duplicate' }
        };

        // Apps list for proposal dropdown
        let factoryApps = [];

        async function loadAppsForDropdown() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/apps?select=slug,name&status=in.(live,approved,published)&order=name`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                if (response.ok) {
                    factoryApps = await response.json();
                    const select = document.getElementById('proposalApp');
                    if (select) {
                        factoryApps.forEach(app => {
                            const option = document.createElement('option');
                            option.value = app.slug;
                            option.textContent = app.name;
                            option.style.background = '#1a1a2e';
                            option.style.color = '#ffffff';
                            select.appendChild(option);
                        });
                    }
                }
            } catch (err) {
                console.error('Error loading apps for dropdown:', err);
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await checkAuth();  // Wait for user data including is_founder
            loadProposals();
            loadLeaderboard();
            await loadGovernanceProposals();
            await loadAppsForDropdown();
            renderGovernanceSections();
            loadAgentsCount(); // Load agents tab count
            console.log('Initialized. currentUser:', currentUser);
        });

        // Load just the agents count for the tab badge
        async function loadAgentsCount() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?is_agent=eq.true&select=id`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Prefer': 'count=exact'
                        }
                    }
                );
                const countHeader = response.headers.get('content-range');
                const count = countHeader ? parseInt(countHeader.split('/')[1]) || 0 : 0;
                const countEl = document.getElementById('agentsTabCount');
                if (countEl) countEl.textContent = count;
            } catch (err) {
                console.error('Error loading agents count:', err);
            }
        }

        // Check auth state
        async function checkAuth() {
            // First check for factory_user (legacy)
            const savedUser = localStorage.getItem('factory_user');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
                return;
            }

            // Check for nav component auth (wallet or telegram)
            const walletAddress = localStorage.getItem('connectedWallet');
            const telegramUser = localStorage.getItem('telegram_user');

            if (walletAddress) {
                console.log('[checkAuth] Found wallet from nav:', walletAddress);
                currentUser = { wallet_address: walletAddress.toLowerCase() };
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
            } else if (telegramUser) {
                const tgUser = JSON.parse(telegramUser);
                console.log('[checkAuth] Found telegram user from nav:', tgUser);
                currentUser = {
                    telegram_id: tgUser.id?.toString(),
                    display_name: tgUser.username || tgUser.first_name
                };
                await refreshUserData();
                await loadUserVotes();
                updateUserPanel();
            }

            // Check if Stuart and show NoteBox tab
            updateNoteboxVisibility();
        }

        // Stuart's identifiers - only show NoteBox tab for Stuart
        const STUART_WALLET = '0x92d67d8ad8b986e78b369be0272e121ae5acad59';
        const STUART_TELEGRAM_ID = '1202786230';

        function isStuart() {
            if (!currentUser) {
                console.log('[isStuart] No currentUser');
                return false;
            }
            const wallet = currentUser.wallet_address?.toLowerCase();
            const tgId = currentUser.telegram_id?.toString();
            console.log('[isStuart] Checking:', { wallet, tgId, STUART_WALLET, STUART_TELEGRAM_ID });
            console.log('[isStuart] Match:', wallet === STUART_WALLET, tgId === STUART_TELEGRAM_ID);
            return wallet === STUART_WALLET || tgId === STUART_TELEGRAM_ID;
        }

        function updateNoteboxVisibility() {
            const noteboxTab = document.getElementById('noteboxTab');
            const noteboxBadge = document.getElementById('noteboxBadge');
            const showNotebox = isStuart();

            console.log('[NoteBox] Updating visibility:', showNotebox, 'currentUser:', currentUser);

            if (noteboxTab) noteboxTab.style.display = showNotebox ? 'inline-flex' : 'none';
            if (noteboxBadge) noteboxBadge.style.display = showNotebox ? 'block' : 'none';
        }

        // Refresh user data from database
        async function refreshUserData() {
            if (!currentUser) return;

            try {
                let query = '';
                if (currentUser.telegram_id) {
                    query = `telegram_id=eq.${currentUser.telegram_id}`;
                } else if (currentUser.wallet_address) {
                    // Use ilike for case-insensitive matching
                    query = `wallet_address=ilike.${currentUser.wallet_address}`;
                } else {
                    return; // Demo user, no database record
                }

                console.log('[refreshUserData] Query:', query);

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?${query}&select=*`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const users = await response.json();
                    console.log('[refreshUserData] Found users:', users);
                    if (users.length > 0) {
                        const dbUser = users[0];
                        currentUser = {
                            ...currentUser,
                            id: dbUser.id,
                            reputation: dbUser.reputation,
                            is_founder: dbUser.is_founder,
                            display_name: dbUser.display_name,
                            // Also grab linked telegram_id if it exists (for NoteBox sync)
                            telegram_id: dbUser.telegram_id || currentUser.telegram_id
                        };
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        console.log('[refreshUserData] Updated user - rep:', currentUser.reputation, 'telegram_id:', currentUser.telegram_id);
                    } else {
                        console.warn('[refreshUserData] No user found in DB for wallet:', currentUser.wallet_address);
                    }
                } else {
                    console.error('[refreshUserData] Fetch failed:', await response.text());
                }
            } catch (err) {
                console.error('Error refreshing user data:', err);
            }
        }

        // Update user panel based on auth state
        function updateUserPanel() {
            const panel = document.getElementById('userPanel');
            if (currentUser) {
                // User is connected - panel is empty since wallet shown in nav
                panel.innerHTML = '';
                document.getElementById('userRep').textContent = currentUser.reputation || 0;
            } else {
                panel.innerHTML = '<button class="auth-btn" onclick="showAuthModal()">Connect</button>';
            }

            // Also update NoteBox view if on that tab
            if (currentTab === 'notebox') {
                updateNoteboxView();
            }
        }

        // Load proposals from Supabase
        async function loadProposals() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_proposals?select=*,author:factory_users(id,display_name,reputation)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    proposals = await response.json();
                    // Old kanban removed - sections now render via renderGovernanceSections()
                }
            } catch (err) {
                console.error('Error loading proposals:', err);
            }
        }

        // Load leaderboard
        async function loadLeaderboard() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?select=id,display_name,telegram_id,wallet_address,reputation,is_founder&order=reputation.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    users = await response.json();
                    renderLeaderboard();
                }
            } catch (err) {
                console.error('Error loading leaderboard:', err);
            }
        }

        // Render leaderboard
        function renderLeaderboard() {
            const container = document.getElementById('leaderboard');
            if (users.length === 0) {
                container.innerHTML = '<p style="color: var(--text-dim); font-size: 0.85rem;">No contributors yet. Be the first!</p>';
                return;
            }

            const rankMedals = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'];
            const rankClasses = ['gold', 'silver', 'bronze'];

            container.innerHTML = users.map((user, i) => {
                const medal = i < 3 ? rankMedals[i] : `#${i + 1}`;
                const rankClass = i < 3 ? rankClasses[i] : '';
                // Show telegram_id if available, otherwise wallet address
                const userIdentity = user.telegram_id || (user.wallet_address ? `${user.wallet_address.slice(0, 6)}...${user.wallet_address.slice(-4)}` : 'Anonymous');

                return `
                    <div class="leaderboard-item ${rankClass}">
                        <span class="leaderboard-rank">${medal}</span>
                        <div class="leaderboard-info">
                            <div class="leaderboard-name">${escapeHtml(userIdentity)}</div>
                        </div>
                        <div class="leaderboard-rep">
                            <span>${user.reputation} Credits</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Load governance proposals (all sections including SUITE Apps)
        async function loadGovernanceProposals() {
            try {
                // Load proposals
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_proposals?select=*,author:factory_users(id,display_name,reputation)&section=in.(suite_apps,business,content,social)&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    governanceProposals = await response.json();
                    console.log('Loaded', governanceProposals.length, 'governance proposals');

                    // Load comment counts for all proposals
                    await loadCommentCounts();
                }
            } catch (err) {
                console.error('Error loading governance proposals:', err);
            }
        }

        // Load comment counts for all proposals
        async function loadCommentCounts() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_comments?select=proposal_id`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const comments = await response.json();
                    // Count comments per proposal
                    const counts = {};
                    comments.forEach(c => {
                        counts[c.proposal_id] = (counts[c.proposal_id] || 0) + 1;
                    });
                    // Merge into proposals
                    governanceProposals.forEach(p => {
                        p.comment_count = counts[p.id] || 0;
                    });
                }
            } catch (err) {
                console.error('Error loading comment counts:', err);
            }
        }

        // Toggle governance section collapse/expand
        function toggleGovernanceSection(sectionId) {
            const section = document.getElementById(sectionId);
            if (section) {
                section.classList.toggle('collapsed');
            }
        }

        // Switch governance tabs
        function switchGovernanceTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.governance-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`.governance-tab[data-tab="${tabName}"]`).classList.add('active');

            // Update tab content
            document.querySelectorAll('.governance-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}TabContent`).classList.add('active');

            // Load agents data when switching to agents tab
            if (tabName === 'agents') {
                loadAgents();
            }
        }

        // Agents data cache
        let agentsData = [];

        // Load agents from database
        async function loadAgents() {
            const grid = document.getElementById('agentsGrid');
            if (!grid) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?is_agent=eq.true&select=*&order=proposals_submitted.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load agents');

                agentsData = await response.json();

                // Update tab count
                const countEl = document.getElementById('agentsTabCount');
                if (countEl) countEl.textContent = agentsData.length;

                // Render agents
                if (agentsData.length === 0) {
                    grid.innerHTML = `
                        <div class="no-agents">
                            <div class="no-agents-icon">ðŸ¤–</div>
                            <div class="no-agents-text">No agents registered yet</div>
                            <div class="no-agents-subtext">Agents will appear here once created</div>
                        </div>
                    `;
                } else {
                    grid.innerHTML = agentsData.map(renderAgentCard).join('');
                }

            } catch (err) {
                console.error('Error loading agents:', err);
                grid.innerHTML = `
                    <div class="no-agents">
                        <div class="no-agents-icon">ðŸ˜µ</div>
                        <div class="no-agents-text">Failed to load agents</div>
                        <div class="no-agents-subtext">${escapeHtml(err.message)}</div>
                    </div>
                `;
            }
        }

        // App icons for agents
        const agentAppIcons = {
            'foodvitals': 'ðŸŽ',
            'opticrep': 'ðŸ’ª',
            'cheshbon': 'ðŸ“Š',
            'remcast': 'ðŸ””',
            'trueform': 'ðŸƒ',
            'defi-knowledge': 'ðŸ“š',
            'notebox': 'ðŸ“',
            'suitehub': 'ðŸ '
        };

        // Render a single agent card
        function renderAgentCard(agent) {
            const icon = agentAppIcons[agent.owned_app_slug] || 'ðŸ¤–';
            const status = agent.agent_status || 'idle';
            const submitted = agent.proposals_submitted || 0;
            const approved = agent.proposals_approved || 0;
            const rejected = agent.proposals_rejected || 0;
            const rate = submitted > 0 ? Math.round((approved / submitted) * 100) : 0;
            const isAdmin = currentUser?.is_founder;

            // Truncate mission
            let mission = agent.telos_objective || 'No mission defined';
            if (mission.length > 120) {
                mission = mission.slice(0, 117) + '...';
            }

            return `
                <div class="agent-card">
                    <div class="agent-card-header">
                        <div class="agent-card-avatar">${icon}</div>
                        <div class="agent-card-info">
                            <div class="agent-card-name">
                                ${escapeHtml(agent.display_name || agent.agent_slug)}
                                <span class="agent-card-status ${status}">${status}</span>
                            </div>
                            <div class="agent-card-app">
                                Managing: <a href="/apps.html?app=${escapeHtml(agent.owned_app_slug)}">${escapeHtml(agent.owned_app_slug || 'Unknown')}</a>
                            </div>
                        </div>
                    </div>
                    <div class="agent-card-mission">${escapeHtml(mission)}</div>
                    <div class="agent-card-stats">
                        <div class="agent-stat">
                            <div class="agent-stat-value accent">${submitted}</div>
                            <div class="agent-stat-label">Proposals</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value success">${approved}</div>
                            <div class="agent-stat-label">Approved</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value error">${rejected}</div>
                            <div class="agent-stat-label">Rejected</div>
                        </div>
                        <div class="agent-stat">
                            <div class="agent-stat-value">${rate}%</div>
                            <div class="agent-stat-label">Rate</div>
                        </div>
                    </div>
                    <div class="agent-card-actions">
                        <a href="/agent-profile.html?id=${escapeHtml(agent.agent_slug)}" class="agent-action-btn secondary">View Profile</a>
                        ${isAdmin ? `<button class="agent-action-btn primary" onclick="wakeAgent('${escapeHtml(agent.agent_slug)}')" ${status === 'waiting' ? 'disabled title="Waiting for response"' : ''}>Wake Agent</button>` : ''}
                    </div>
                </div>
            `;
        }

        // Wake an agent (admin only)
        async function wakeAgent(agentSlug) {
            if (!currentUser?.is_founder) {
                alert('Only founders can wake agents');
                return;
            }

            const confirmed = confirm(`Wake ${agentSlug}? This will trigger the agent to generate a new proposal.`);
            if (!confirmed) return;

            showNotification(`To wake ${agentSlug}, run: node scripts/wake-agent.js ${agentSlug}`);
        }

        // Toggle proposal card collapse/expand
        function toggleProposalCard(headerEl) {
            const card = headerEl.closest('.idea-card');
            if (card) {
                card.classList.toggle('collapsed');
            }
        }

        // Toggle entire SUITE LOOPS section collapse/expand
        function toggleLoopsSection() {
            const loopsSection = document.getElementById('loops');
            if (loopsSection) {
                loopsSection.classList.toggle('collapsed');
            }
        }

        // Toggle mobile voting info section
        function toggleMobileVotingInfo() {
            const votingInfo = document.getElementById('mobileVotingInfo');
            if (votingInfo) {
                votingInfo.classList.toggle('collapsed');
            }
        }

        // Toggle loop category collapse/expand (AI Loops, Cadence Loops)
        function toggleLoopCategory(categoryId) {
            const category = document.getElementById(categoryId);
            if (category) {
                category.classList.toggle('collapsed');
            }
        }

        // Toggle individual loop item expand/collapse
        function toggleLoopItem(loopId) {
            const loopItem = document.getElementById(loopId);
            if (loopItem) {
                loopItem.classList.toggle('expanded');
            }
        }

        // Render all governance sections
        function renderGovernanceSections() {
            console.log('[renderGovernanceSections] currentUser:', currentUser, 'is_founder:', currentUser?.is_founder);
            renderSuiteAppsSection();
            renderGovernanceSection('business', 'businessKanban');
            renderGovernanceSection('content', 'contentKanban');
            renderGovernanceSection('social', 'socialKanban');

            // Update tab counts
            const appCount = governanceProposals.filter(p => p.section === 'suite_apps').length;
            const bizCount = governanceProposals.filter(p => p.section === 'business').length;
            const artCount = governanceProposals.filter(p => p.section === 'content').length;
            const socCount = governanceProposals.filter(p => p.section === 'social').length;

            document.getElementById('appsTabCount').textContent = appCount;
            document.getElementById('businessTabCount').textContent = bizCount;
            document.getElementById('articlesTabCount').textContent = artCount;
            document.getElementById('socialTabCount').textContent = socCount;
        }

        // Render SUITE Apps section (now uses proposals like other sections)
        function renderSuiteAppsSection() {
            const sectionProposals = governanceProposals.filter(p => p.section === 'suite_apps');
            const submitted = sectionProposals.filter(p => p.status === 'submitted');
            const voting = sectionProposals.filter(p => p.status === 'open_voting');
            const workingOn = sectionProposals.filter(p => p.status === 'working_on');
            const implemented = sectionProposals.filter(p => p.status === 'passed' || p.status === 'implemented');
            const rejected = sectionProposals.filter(p => p.status === 'rejected');

            const isAdmin = currentUser?.is_founder;

            document.getElementById('suiteAppsKanban').innerHTML = `
                <div class="section-column" data-status="submitted" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'submitted', 'suite_apps')">
                    <div class="section-column-header">ðŸ“¥ Submitted <span>(${submitted.length})</span></div>
                    <button class="section-add-btn" onclick="showSubmitModal('suite_apps')">+ New Proposal</button>
                    ${renderGroupedColumn(submitted, 'suite_apps', 'submitted')}
                </div>
                <div class="section-column" data-status="open_voting" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'open_voting', 'suite_apps')">
                    <div class="section-column-header">ðŸ—³ï¸ Voting <span>(${voting.length})</span></div>
                    ${renderGroupedColumn(voting, 'suite_apps', 'open_voting')}
                </div>
                <div class="section-column" data-status="working_on" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'working_on', 'suite_apps')">
                    <div class="section-column-header">âš™ï¸ Working On <span>(${workingOn.length})</span></div>
                    ${renderGroupedColumn(workingOn, 'suite_apps', 'working_on')}
                </div>
                <div class="section-column" data-status="passed" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'passed', 'suite_apps')">
                    <div class="section-column-header">âœ… Implemented <span>(${implemented.length})</span></div>
                    ${renderGroupedColumn(implemented, 'suite_apps', 'passed')}
                </div>
                <div class="section-column" data-status="rejected" data-section="suite_apps"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'rejected', 'suite_apps')">
                    <div class="section-column-header">âŒ Rejected <span>(${rejected.length})</span></div>
                    ${renderGroupedColumn(rejected, 'suite_apps', 'rejected')}
                </div>
            `;
        }

        // Render governance section (for Business, Content, Social)
        function renderGovernanceSection(sectionType, containerId) {
            const sectionProposals = governanceProposals.filter(p => p.section === sectionType);
            const submitted = sectionProposals.filter(p => p.status === 'submitted');
            const voting = sectionProposals.filter(p => p.status === 'open_voting');
            const workingOn = sectionProposals.filter(p => p.status === 'working_on');
            const implemented = sectionProposals.filter(p => p.status === 'passed' || p.status === 'implemented');
            const rejected = sectionProposals.filter(p => p.status === 'rejected');

            document.getElementById(containerId).innerHTML = `
                <div class="section-column" data-status="submitted" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'submitted', '${sectionType}')">
                    <div class="section-column-header">ðŸ“¥ Submitted <span>(${submitted.length})</span></div>
                    <button class="section-add-btn" onclick="showSubmitModal('${sectionType}')">+ New Proposal</button>
                    ${renderGroupedColumn(submitted, sectionType, 'submitted')}
                </div>
                <div class="section-column" data-status="open_voting" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'open_voting', '${sectionType}')">
                    <div class="section-column-header">ðŸ—³ï¸ Voting <span>(${voting.length})</span></div>
                    ${renderGroupedColumn(voting, sectionType, 'open_voting')}
                </div>
                <div class="section-column" data-status="working_on" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'working_on', '${sectionType}')">
                    <div class="section-column-header">âš™ï¸ Working On <span>(${workingOn.length})</span></div>
                    ${renderGroupedColumn(workingOn, sectionType, 'working_on')}
                </div>
                <div class="section-column" data-status="passed" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'passed', '${sectionType}')">
                    <div class="section-column-header">âœ… Implemented <span>(${implemented.length})</span></div>
                    ${renderGroupedColumn(implemented, sectionType, 'passed')}
                </div>
                <div class="section-column" data-status="rejected" data-section="${sectionType}"
                     ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event, 'rejected', '${sectionType}')">
                    <div class="section-column-header">âŒ Rejected <span>(${rejected.length})</span></div>
                    ${renderGroupedColumn(rejected, sectionType, 'rejected')}
                </div>
            `;
        }

        // Render a governance proposal card
        function renderGovernanceProposalCard(proposal, sectionType) {
            const category = CATEGORIES[proposal.category] || { emoji: 'ðŸ“‹', label: 'General' };
            const formattedDate = new Date(proposal.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            const authorName = proposal.author?.display_name || proposal.author_name || 'Anonymous';
            const isAdmin = currentUser?.is_founder;
            const votesFor = proposal.votes_for || 0;
            const votesAgainst = proposal.votes_against || 0;
            const userVoteCount = getUserVoteCount(proposal.id);
            const nextVoteCost = getVoteCost(userVoteCount + 1);
            const canVote = currentUser && ['submitted', 'open_voting'].includes(proposal.status);
            const isFromAgent = proposal.from_agent === true;

            const rejectionReason = proposal.reject_reason || proposal.rejection_reason;
            const agentFeedback = proposal.agent_feedback;

            // Agent badge
            let agentBadge = '';
            if (isFromAgent) {
                const agentSlug = proposal.author?.agent_slug || '';
                agentBadge = `<span class="agent-badge"><a href="/agent-profile.html?id=${escapeHtml(agentSlug)}" onclick="event.stopPropagation()" title="View agent profile">AI Agent</a></span>`;
            }

            // Get app name if proposal is linked to an app, or show New App tag
            let appTag = '';
            if (proposal.is_new_app || proposal.app_slug === 'new_app') {
                appTag = '<span class="proposal-app-tag new-app-tag">New App</span>';
            } else if (proposal.app_slug || proposal.app_target) {
                const appSlug = proposal.app_slug || proposal.app_target;
                const linkedApp = factoryApps.find(a => a.slug === appSlug);
                if (linkedApp) {
                    appTag = `<span class="proposal-app-tag">${escapeHtml(linkedApp.name)}</span>`;
                }
            }

            // Agent feedback section for admins
            let agentFeedbackSection = '';
            if (isFromAgent && isAdmin && ['submitted', 'open_voting'].includes(proposal.status)) {
                agentFeedbackSection = `
                    <div class="agent-feedback-section" onclick="event.stopPropagation()">
                        <div class="agent-feedback-label">Respond to Agent</div>
                        <textarea class="agent-feedback-input" id="agent-feedback-${proposal.id}" placeholder="Optional: Add feedback for the agent (will be visible to the agent for learning)..."></textarea>
                        <div style="display: flex; gap: 8px; margin-top: 8px;">
                            <button class="agent-feedback-btn" style="background: linear-gradient(135deg, #22c55e, #16a34a);" onclick="respondToAgent('${proposal.id}', 'passed')">Approve</button>
                            <button class="agent-feedback-btn" style="background: linear-gradient(135deg, #ef4444, #dc2626);" onclick="respondToAgent('${proposal.id}', 'rejected')">Reject</button>
                        </div>
                    </div>
                `;
            }

            // Show agent feedback if already responded
            let agentFeedbackDisplay = '';
            if (isFromAgent && agentFeedback && ['passed', 'rejected', 'implemented'].includes(proposal.status)) {
                agentFeedbackDisplay = `
                    <div class="agent-feedback-display">
                        <strong>Agent Feedback:</strong> ${escapeHtml(agentFeedback)}
                    </div>
                `;
            }

            return `
                <div class="idea-card ${proposal.status} collapsed">
                    ${isAdmin ? `<button class="card-delete-btn" onclick="event.stopPropagation(); showDeleteModal('${proposal.id}', 'proposal')" title="Delete">&times;</button>` : ''}
                    ${agentBadge}${appTag}
                    <div class="idea-card-header" onclick="toggleProposalCard(this)">
                        ${isAdmin ? `<span class="idea-card-drag-handle" draggable="true" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" ondragstart="handleDragStart(event, '${proposal.id}', 'proposal', '${sectionType}')" ondragend="handleDragEnd(event)" title="Drag to move">&#x22EE;&#x22EE;</span>` : ''}
                        <span class="idea-card-toggle">&#x25BC;</span>
                        <div class="idea-card-title">${escapeHtml(proposal.title)}</div>
                    </div>
                    <div class="idea-card-details">
                        <div class="idea-card-tagline">${escapeHtml(proposal.content || 'No description')}</div>
                        <div class="idea-card-meta">
                            <span>ðŸ‘¤ ${escapeHtml(authorName)}</span>
                            <span>${category.emoji} ${category.label}</span>
                            <span>ðŸ“… ${formattedDate}</span>
                        </div>
                        ${proposal.status === 'rejected' && rejectionReason ? `<div class="rejection-reason">${escapeHtml(rejectionReason)}</div>` : ''}
                        ${agentFeedbackDisplay}
                        ${proposal.status === 'working_on' ? `<button class="work-btn" disabled>Get to work</button>` : ''}
                        ${agentFeedbackSection}
                        <div class="vote-buttons">
                            <button class="vote-btn for" onclick="event.stopPropagation(); addVote('${proposal.id}')" ${!canVote ? 'disabled' : ''} title="Add vote (${nextVoteCost === 0 ? 'FREE' : nextVoteCost + ' credits'})">
                                ðŸ‘ <span class="vote-count">${votesFor}</span>
                            </button>
                            <button class="vote-btn against" onclick="event.stopPropagation(); removeVote('${proposal.id}')" ${!canVote || userVoteCount === 0 ? 'disabled' : ''} title="Remove vote (+${userVoteCount > 0 ? getRefundAmount(userVoteCount) : 0} credits)">
                                ðŸ‘Ž <span class="vote-count">${userVoteCount}</span>
                            </button>
                            <button class="comment-btn ${(proposal.comment_count || 0) > 0 ? 'has-comments' : ''}" onclick="event.stopPropagation(); toggleComments('${proposal.id}')" title="Comments">
                                ðŸ’¬ <span class="comment-count">${proposal.comment_count || 0}</span>
                            </button>
                            ${userVoteCount > 0 ? `<span class="your-votes">${userVoteCount} vote${userVoteCount > 1 ? 's' : ''} Â· ${nextVoteCost} credits next</span>` : `<span class="your-votes">${nextVoteCost === 0 ? 'First vote FREE' : nextVoteCost + ' credits'}</span>`}
                        </div>
                        <div class="comments-section" id="comments-${proposal.id}">
                            <div class="comments-list" id="comments-list-${proposal.id}">
                                <div class="no-comments">Loading comments...</div>
                            </div>
                            ${currentUser ? `
                            <div class="comment-form">
                                <input type="text" class="comment-input" id="comment-input-${proposal.id}" placeholder="Add a comment..." maxlength="1000" onkeypress="if(event.key==='Enter') postComment('${proposal.id}')">
                                <button class="comment-submit" onclick="postComment('${proposal.id}')">Post</button>
                            </div>
                            ` : `<div class="comment-login-prompt">Connect to add comments</div>`}
                        </div>
                    </div>
                </div>
            `;
        }

        // Respond to an agent proposal with feedback
        async function respondToAgent(proposalId, newStatus) {
            if (!currentUser || !currentUser.is_founder) {
                alert('Only founders can respond to agent proposals');
                return;
            }

            const feedbackInput = document.getElementById(`agent-feedback-${proposalId}`);
            const feedback = feedbackInput ? feedbackInput.value.trim() : '';

            // For rejections, require feedback
            if (newStatus === 'rejected' && !feedback) {
                alert('Please provide feedback when rejecting an agent proposal. This helps the agent learn and improve.');
                return;
            }

            try {
                const updateData = {
                    status: newStatus,
                    agent_feedback: feedback || null,
                    feedback_at: new Date().toISOString()
                };

                if (newStatus === 'rejected') {
                    updateData.reject_reason = feedback;
                }

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_proposals?id=eq.${proposalId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (!response.ok) {
                    throw new Error('Failed to update proposal');
                }

                // Refresh the view
                showNotification(newStatus === 'passed' ? 'Proposal approved! Agent will be notified.' : 'Proposal rejected. Agent will receive your feedback.');
                await loadProposals('governance');

            } catch (err) {
                console.error('Error responding to agent:', err);
                alert('Failed to respond to agent proposal');
            }
        }

        // Drag and Drop Handlers
        function handleDragStart(event, id, type, section) {
            // Stop propagation to prevent card toggle
            event.stopPropagation();

            // Only founders/admins can drag
            if (!currentUser || !currentUser.is_founder) {
                console.log('[DragStart] Blocked - not admin');
                event.preventDefault();
                return;
            }
            console.log('[DragStart]', { id, type, section, user: currentUser });
            draggedItem = { id, type, section };
            event.target.classList.add('dragging');
            event.dataTransfer.setData('text/plain', id);  // Required for drag to work
            event.dataTransfer.effectAllowed = 'move';
        }

        function handleDragEnd(event) {
            console.log('[DragEnd] Drag ended. draggedItem was:', draggedItem);
            event.target.classList.remove('dragging');
            draggedItem = null;
            // Remove drag-over class from all columns
            document.querySelectorAll('.section-column').forEach(col => col.classList.remove('drag-over'));
        }

        function handleDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(event, newStatus, section) {
            event.preventDefault();
            event.stopPropagation();
            event.currentTarget.classList.remove('drag-over');
            console.log('[handleDrop called]', { newStatus, section, draggedItem, currentUser, isFounder: currentUser?.is_founder });

            // Block non-admins from dropping
            if (!currentUser || !currentUser.is_founder) {
                console.log('[Drop] Blocked - not admin');
                return;
            }

            if (!draggedItem) {
                console.log('[Drop] No draggedItem!');
                return;
            }

            // Only allow drops in the same section type
            if (draggedItem.section !== section) {
                alert('Cannot move items between different sections');
                return;
            }

            // If dropping on rejected, show rejection reason modal
            if (newStatus === 'rejected') {
                pendingRejection = { ...draggedItem, newStatus };
                showRejectionModal();
                return;
            }

            // Otherwise, update status directly
            updateItemStatus(draggedItem.id, draggedItem.type, draggedItem.section, newStatus, null);
        }

        function showRejectionModal() {
            document.getElementById('rejectionReason').value = '';
            document.getElementById('rejectionModal').classList.add('active');
        }

        function hideRejectionModal() {
            document.getElementById('rejectionModal').classList.remove('active');
            pendingRejection = null;
        }

        async function confirmRejection() {
            const reason = document.getElementById('rejectionReason').value.trim();
            if (!reason) {
                alert('Please provide a rejection reason');
                return;
            }

            if (!pendingRejection) return;

            await updateItemStatus(
                pendingRejection.id,
                pendingRejection.type,
                pendingRejection.section,
                pendingRejection.newStatus,
                reason
            );

            hideRejectionModal();
        }

        async function updateItemStatus(id, type, section, newStatus, rejectionReason) {
            console.log('[updateItemStatus]', { id, type, section, newStatus, rejectionReason });

            // Only founders can update status
            if (!currentUser || !currentUser.is_founder) {
                console.log('[updateItemStatus] Blocked - not admin');
                alert('Only admins can move proposals');
                return;
            }

            try {
                // All sections now use factory_proposals table
                const table = 'factory_proposals';
                const updateData = { status: newStatus };
                if (rejectionReason) {
                    updateData.reject_reason = rejectionReason;
                }

                console.log('[updateItemStatus] Updating table:', table, 'with data:', updateData);
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    const errorText = await response.text();
                    console.error('Failed to update status:', errorText);
                    alert('Failed to update status: ' + errorText);
                }
            } catch (err) {
                console.error('Error updating status:', err);
                alert('Error updating status');
            }
        }

        // Delete modal state
        let pendingDelete = null; // { id, type: 'proposal' | 'idea' }

        function showDeleteModal(id, type) {
            if (!currentUser?.is_founder) return;
            pendingDelete = { id, type };
            document.getElementById('deleteModal').classList.add('active');
        }

        function hideDeleteModal() {
            document.getElementById('deleteModal').classList.remove('active');
            pendingDelete = null;
        }

        async function confirmDelete() {
            if (!pendingDelete) return;

            const { id } = pendingDelete;
            hideDeleteModal();

            try {
                const payload = {
                    action: 'delete',
                    proposal_id: id
                };

                // Add auth
                if (currentUser.telegram_id) {
                    payload.telegram_id = currentUser.telegram_id;
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-admin`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    console.error('Failed to delete:', result);
                    alert(result.error || 'Failed to delete');
                }
            } catch (err) {
                console.error('Error deleting:', err);
                alert('Error deleting');
            }
        }

        // ===== VIEW SWITCHING (Governance / NoteBox) =====
        let currentMainView = 'governance';

        function switchView(view) {
            currentMainView = view;

            // Update view tab buttons
            document.querySelectorAll('.view-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === view);
            });

            // Toggle views
            const governanceView = document.getElementById('governanceView');
            const noteboxView = document.getElementById('noteboxView');

            if (view === 'governance') {
                governanceView.style.display = 'block';
                noteboxView.style.display = 'none';
            } else {
                governanceView.style.display = 'none';
                noteboxView.style.display = 'block';
                updateNoteboxViewInline();
            }
        }

        function updateNoteboxViewInline() {
            if (currentUser) {
                // User is logged in - show NoteBox app
                document.getElementById('noteboxAuthPromptInline').style.display = 'none';
                document.getElementById('noteboxAppInline').style.display = 'block';
                // Use the main NoteBox loading function and render to inline container
                loadNoteboxIdeasForInline();
            } else {
                // Not logged in - show auth prompt
                document.getElementById('noteboxAuthPromptInline').style.display = 'flex';
                document.getElementById('noteboxAppInline').style.display = 'none';
            }
        }

        async function loadNoteboxIdeasForInline() {
            if (!currentUser) return;

            // Build user_id filters - check both telegram and wallet if available
            const userIds = [];
            if (currentUser.telegram_id) {
                userIds.push(`tg_${currentUser.telegram_id}`);
            }
            if (currentUser.wallet_address) {
                userIds.push(`wallet_${currentUser.wallet_address}`);
            }

            if (userIds.length === 0) {
                console.log('No valid user ID for NoteBox');
                return;
            }

            try {
                // Use 'or' filter to match any of the user IDs
                let url;
                if (userIds.length === 1) {
                    url = `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&user_id=eq.${encodeURIComponent(userIds[0])}&order=created_at.desc`;
                } else {
                    // Multiple IDs - use or filter
                    const orFilter = userIds.map(id => `user_id.eq.${id}`).join(',');
                    url = `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&or=(${encodeURIComponent(orFilter)})&order=created_at.desc`;
                }

                console.log('Loading NoteBox ideas for:', userIds);

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const ideas = await response.json();
                    console.log('Loaded', ideas.length, 'NoteBox ideas');
                    noteboxIdeas = ideas; // Store in global array for Push To functionality
                    renderNoteboxKanbanInline(ideas);
                } else {
                    console.error('Failed to load NoteBox ideas:', await response.text());
                }
            } catch (err) {
                console.error('Error loading NoteBox ideas:', err);
            }
        }

        function renderNoteboxKanbanInline(ideas) {
            const kanban = document.getElementById('noteboxKanbanInline');
            if (!kanban) return;

            // Filter by status
            let activeIdeas = ideas.filter(i => i.status === 'inbox');
            let archivedIdeas = ideas.filter(i => i.status === 'implemented' || i.status === 'dismissed');

            // Group active ideas by category
            const grouped = {};
            activeIdeas.forEach(idea => {
                const cat = idea.category || 'brainstorm';
                if (!grouped[cat]) grouped[cat] = [];
                grouped[cat].push(idea);
            });

            // Render ALL columns in fixed order (even empty ones)
            let columnsHtml = NOTEBOX_COLUMN_ORDER.map(category => {
                const cat = NOTEBOX_CATEGORIES[category];
                const catIdeas = grouped[category] || [];
                return `
                    <div class="notebox-column" data-category="${category}">
                        <div class="notebox-column-header">
                            <span>${cat.emoji}</span>
                            <span>${cat.label}</span>
                            <span class="notebox-column-count">${catIdeas.length}</span>
                        </div>
                        <div class="notebox-column-cards" data-category="${category}">
                            ${catIdeas.map(idea => renderNoteboxCardInline(idea)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add Archive column
            columnsHtml += `
                <div class="notebox-column archive-column" data-category="archive">
                    <div class="notebox-column-header" style="opacity: 0.7;">
                        <span>ðŸ“</span>
                        <span>Archive</span>
                        <span class="notebox-column-count">${archivedIdeas.length}</span>
                    </div>
                    <div class="notebox-column-cards" data-category="archive">
                        ${archivedIdeas.map(idea => renderNoteboxCardInline(idea)).join('')}
                    </div>
                </div>
            `;

            kanban.innerHTML = columnsHtml;

            // Setup drag and drop for inline kanban
            setupDragAndDropInline();
        }

        function setupDragAndDropInline() {
            const kanban = document.getElementById('noteboxKanbanInline');
            if (!kanban) return;

            const cards = kanban.querySelectorAll('.notebox-card[draggable="true"]');
            const dropZones = kanban.querySelectorAll('.notebox-column-cards');

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    card.classList.add('dragging');
                    e.dataTransfer.setData('text/plain', card.dataset.id);
                    e.dataTransfer.effectAllowed = 'move';
                });

                card.addEventListener('dragend', () => {
                    card.classList.remove('dragging');
                    dropZones.forEach(zone => zone.classList.remove('drag-over'));
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    zone.classList.add('drag-over');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('drag-over');
                });

                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.classList.remove('drag-over');

                    const ideaId = e.dataTransfer.getData('text/plain');
                    const newCategory = zone.dataset.category;
                    const draggedCard = kanban.querySelector(`.notebox-card[data-id="${ideaId}"]`);
                    const currentStatus = draggedCard?.dataset?.status;

                    console.log('[Inline Drop]', { ideaId, newCategory, currentStatus });

                    if (newCategory === 'archive') {
                        // Show archive modal for archiving
                        showNoteboxArchiveModal(ideaId, 'done');
                        return;
                    }

                    // If dragging FROM archive back to a category, restore it
                    if (currentStatus === 'implemented' || currentStatus === 'dismissed') {
                        console.log('[Inline Drop] Restoring from archive to', newCategory);
                        try {
                            const response = await fetch(
                                `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                                {
                                    method: 'PATCH',
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({ status: 'inbox', category: newCategory })
                                }
                            );
                            if (response.ok) {
                                loadNoteboxIdeasForInline();
                            }
                        } catch (err) {
                            console.error('Error restoring idea:', err);
                        }
                        return;
                    }

                    // Update the idea's category (moving between active categories)
                    try {
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({ category: newCategory })
                            }
                        );

                        if (response.ok) {
                            loadNoteboxIdeasForInline();
                        }
                    } catch (err) {
                        console.error('Error updating idea category:', err);
                    }
                });
            });
        }

        function renderNoteboxCardInline(idea) {
            const isArchived = idea.status === 'implemented' || idea.status === 'dismissed';
            return `
                <div class="notebox-card" draggable="true" data-id="${idea.id}" data-status="${idea.status}">
                    <button class="notebox-card-delete" onclick="event.stopPropagation(); deleteNoteboxIdea('${idea.id}')" title="Delete">Ã—</button>
                    <div class="notebox-card-title">${idea.title || 'Untitled'}</div>
                    ${idea.content ? `<div class="notebox-card-content">${idea.content}</div>` : ''}
                    ${idea.ai_reason ? `<div class="notebox-card-reason">ðŸ’¡ ${idea.ai_reason}</div>` : ''}
                    ${!isArchived ? `
                        <div class="notebox-card-actions">
                            <button class="notebox-card-btn done" onclick="event.stopPropagation(); showNoteboxArchiveModal('${idea.id}', 'done')">âœ“ Done</button>
                            <button class="notebox-card-btn push" onclick="event.stopPropagation(); togglePushDropdown('${idea.id}', event)">Push To â†’</button>
                        </div>
                    ` : `
                        <div style="font-size: 0.75rem; color: var(--text-dim); margin-top: 8px;">
                            ${idea.status === 'implemented' ? 'âœ“ Completed' : 'âœ— Dismissed'}
                            ${idea.archive_reason ? `: ${idea.archive_reason}` : ''}
                        </div>
                    `}
                </div>
            `;
        }

        async function addNoteboxIdeaInline() {
            const input = document.getElementById('noteboxQuickInputInline');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            // Get user_id from currentUser (format: tg_xxx or wallet_xxx)
            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/personal_ideas`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        raw_input: text,
                        title: text.length > 60 ? text.slice(0, 60) + '...' : text,
                        category: 'brainstorm',
                        status: 'inbox',
                        user_id: userId
                    })
                });

                if (response.ok) {
                    input.value = '';
                    loadNoteboxIdeasForInline();
                }
            } catch (err) {
                console.error('Error adding idea:', err);
            }
        }

        // Legacy tab switching (kept for compatibility)
        function switchFactoryTab(tab) {
            currentTab = tab;

            // Update tab buttons
            document.querySelectorAll('.factory-tab').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tab);
            });

            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tab === 'telos' ? 'telosContent' : 'noteboxContent').classList.add('active');

            // Handle NoteBox tab
            if (tab === 'notebox') {
                updateNoteboxView();
            }
        }

        function updateNoteboxView() {
            if (currentUser) {
                // User is logged in - show NoteBox app
                const authPrompt = document.getElementById('noteboxAuthPrompt');
                const app = document.getElementById('noteboxApp');
                if (authPrompt) authPrompt.style.display = 'none';
                if (app) app.style.display = 'flex';
                loadDestinations();
                loadNoteboxIdeas();
            } else {
                // Not logged in - show auth prompt
                const authPrompt = document.getElementById('noteboxAuthPrompt');
                const app = document.getElementById('noteboxApp');
                if (authPrompt) authPrompt.style.display = 'flex';
                if (app) app.style.display = 'none';
            }
        }

        // Show/hide modals
        function showSubmitModal(section = null) {
            if (!currentUser) {
                showAuthModal();
                return;
            }
            // Pre-select section if provided
            if (section) {
                const sectionSelect = document.getElementById('proposalSection');
                if (sectionSelect) {
                    sectionSelect.value = section;
                }
            }
            // Show/hide new app toggle based on section
            onSectionChange();
            document.getElementById('submitModal').classList.add('active');
        }

        function onSectionChange() {
            const section = document.getElementById('proposalSection').value;
            const newAppToggle = document.getElementById('newAppToggleGroup');
            const appSelect = document.getElementById('proposalApp')?.parentElement;

            if (section === 'suite_apps') {
                newAppToggle.style.display = 'block';
            } else {
                newAppToggle.style.display = 'none';
                document.getElementById('isNewApp').checked = false;
            }
            // Reset app dropdown visibility
            if (appSelect) {
                appSelect.style.display = 'block';
            }
        }

        function onNewAppToggle() {
            const isNewApp = document.getElementById('isNewApp').checked;
            const appSelect = document.getElementById('proposalApp')?.parentElement;

            if (appSelect) {
                // Hide app selector when "New App" is checked
                appSelect.style.display = isNewApp ? 'none' : 'block';
            }
        }

        function hideSubmitModal() {
            document.getElementById('submitModal').classList.remove('active');
            document.getElementById('submitForm').reset();
        }

        function showAuthModal() {
            document.getElementById('authModal').classList.add('active');
        }

        function hideAuthModal() {
            document.getElementById('authModal').classList.remove('active');
        }

        // Connect NoteBox Modal
        function openConnectNoteboxModal() {
            const modal = document.getElementById('connectNoteboxModal');
            const content = document.getElementById('connectNoteboxContent');

            if (currentUser) {
                // User is logged in - show coming soon state
                content.innerHTML = `
                    <div style="background: var(--bg); border-radius: 12px; padding: 20px; margin-bottom: 16px; text-align: center;">
                        <div style="font-size: 2.5rem; margin-bottom: 8px;">ðŸ“¦</div>
                        <div style="font-weight: 700; font-size: 1.1rem; margin-bottom: 4px;">NoteBox</div>
                        <div style="font-size: 0.85rem; color: var(--accent); font-weight: 600; margin-bottom: 8px;">Coming Soon</div>
                        <div style="font-size: 0.85rem; color: var(--text-dim);">Kanban on the go, powered by AI</div>
                    </div>
                    <div style="background: var(--bg); border-radius: 10px; padding: 16px; margin-bottom: 16px;">
                        <div style="font-size: 0.9rem; color: var(--text); margin-bottom: 12px; font-weight: 600;">What you'll be able to do:</div>
                        <ul style="font-size: 0.85rem; color: var(--text-dim); margin: 0; padding-left: 20px; line-height: 1.8;">
                            <li>Capture ideas on the go via Telegram</li>
                            <li>AI-powered insights and research</li>
                            <li>Create and publish X posts & articles</li>
                            <li>Connect with friends and businesses</li>
                            <li>Collaborate and share ideas back and forth</li>
                            <li>Push directly to Governance</li>
                        </ul>
                    </div>
                    <p style="font-size: 0.8rem; color: var(--text-dim); text-align: center;">
                        Your personal AI-connected workspace for capturing, creating, and collaborating.
                    </p>
                `;
            } else {
                // User not logged in - prompt to connect
                content.innerHTML = `
                    <p style="margin-bottom: 20px; color: var(--text-dim);">
                        Connect your account to create your personal NoteBox and start contributing.
                    </p>
                    <button class="telegram-btn" onclick="connectTelegram()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: #0088cc; color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer; margin-bottom: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm4.64 6.8c-.15 1.58-.8 5.42-1.13 7.19-.14.75-.42 1-.68 1.03-.58.05-1.02-.38-1.58-.75-.88-.58-1.38-.94-2.23-1.5-.99-.65-.35-1.01.22-1.59.15-.15 2.71-2.48 2.76-2.69a.2.2 0 00-.05-.18c-.06-.05-.14-.03-.21-.02-.09.02-1.49.95-4.22 2.79-.4.27-.76.41-1.08.4-.36-.01-1.04-.2-1.55-.37-.63-.2-1.12-.31-1.08-.66.02-.18.27-.36.74-.55 2.92-1.27 4.86-2.11 5.83-2.51 2.78-1.16 3.35-1.36 3.73-1.36.08 0 .27.02.39.12.1.08.13.19.14.27-.01.06.01.24 0 .38z"/>
                        </svg>
                        Connect with Telegram
                    </button>
                    <button onclick="connectWallet()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 10px; background: linear-gradient(135deg, #627eea, #8b5cf6); color: white; border: none; padding: 14px 28px; border-radius: 10px; font-size: 1rem; font-weight: 700; cursor: pointer;">
                        <span style="font-size: 1.2rem;">ðŸ”—</span>
                        Connect Wallet
                    </button>
                `;
            }

            modal.classList.add('active');
        }

        function closeConnectNoteboxModal() {
            document.getElementById('connectNoteboxModal').classList.remove('active');
        }

        async function connectToGetsuiteNotebox() {
            // For now, just show a success message
            // Later this will create the connection in the database
            const content = document.getElementById('connectNoteboxContent');
            content.innerHTML = `
                <div style="color: var(--success); font-size: 2rem; margin-bottom: 12px;">âœ“</div>
                <p style="font-weight: 600; margin-bottom: 8px;">You're connected!</p>
                <p style="font-size: 0.9rem; color: var(--text-dim);">
                    Go to the NoteBox tab and use "Push To â†’" to send ideas to getSuite Governance.
                </p>
            `;
        }

        // Refine proposal with AI
        async function refineProposal() {
            const textarea = document.getElementById('proposalContent');
            const btn = document.getElementById('refineBtn');
            const text = textarea.value.trim();

            if (text.length < 10) {
                alert('Please write a bit more before refining');
                return;
            }

            btn.disabled = true;
            btn.classList.add('refining');

            try {
                const section = document.getElementById('proposalSection').value;
                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-refine`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({ text, section })
                    }
                );

                const data = await response.json();

                if (data.refined) {
                    textarea.value = data.refined;
                    textarea.style.borderColor = '#a855f7';
                    setTimeout(() => {
                        textarea.style.borderColor = '';
                    }, 2000);
                } else if (data.error) {
                    alert(data.error);
                }
            } catch (error) {
                console.error('Refine error:', error);
                alert('Failed to refine. Please try again.');
            } finally {
                btn.disabled = false;
                btn.classList.remove('refining');
            }
        }

        // Submit proposal via edge function
        async function submitProposal(event) {
            event.preventDefault();
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const section = document.getElementById('proposalSection').value;
            const content = document.getElementById('proposalContent').value.trim();
            const appSlug = document.getElementById('proposalApp').value;
            const isNewApp = document.getElementById('isNewApp')?.checked || false;

            if (!content) {
                alert('Please describe your idea');
                return;
            }

            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing & Submitting...';

            try {
                const payload = {
                    content,
                    section,
                    app_slug: isNewApp ? 'new_app' : (appSlug || null),
                    is_new_app: isNewApp
                };

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else {
                    // Demo mode - use telegram auth with demo ID
                    payload.telegram_auth = { id: currentUser.id, username: currentUser.display_name };
                }

                console.log('[submitProposal] Sending payload:', payload);

                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-submit`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    // Update local user with returned data
                    if (result.user) {
                        currentUser = { ...currentUser, ...result.user };
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    hideSubmitModal();
                    // Reload governance data and re-render
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    console.error('Submit error:', result);
                    alert(result.error || 'Failed to submit proposal.');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error submitting proposal.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // Quick vote via edge function (1 free vote)
        async function quickVote(proposalId, direction) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            // Disable vote buttons temporarily
            const btns = document.querySelectorAll(`.quick-vote-btn`);
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: direction,
                    vote_power: 1
                };

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else {
                    // Demo mode
                    payload.telegram_auth = { id: currentUser.id, username: currentUser.display_name };
                }

                const response = await fetch(
                    `${SUPABASE_URL}/functions/v1/factory-vote`,
                    {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify(payload)
                    }
                );

                const result = await response.json();

                if (response.ok && result.success) {
                    // Update local user with returned data
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    loadProposals();
                } else {
                    console.error('Vote error:', result);
                    alert(result.error || 'Failed to vote.');
                }
            } catch (err) {
                console.error('Error:', err);
                alert('Error voting.');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // Award reputation
        async function awardRep(userId, amount, reason, proposalId = null) {
            try {
                // Add to history
                await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_rep_history`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            amount,
                            reason,
                            proposal_id: proposalId
                        })
                    }
                );

                // Update user rep (this should be done via edge function for security)
                // For now, update locally
                if (currentUser && currentUser.id === userId) {
                    currentUser.reputation += amount;
                    localStorage.setItem('factory_user', JSON.stringify(currentUser));
                    updateUserPanel();
                }
            } catch (err) {
                console.error('Error awarding rep:', err);
            }
        }

        // View proposal detail
        function viewProposal(proposalId) {
            // TODO: Open detail modal
            console.log('View proposal:', proposalId);
        }

        // Telegram OAuth
        function connectTelegram() {
            const botUsername = 'suitehubbot';
            const origin = window.location.origin;

            const width = 550;
            const height = 470;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);

            const authUrl = `https://oauth.telegram.org/auth?bot_id=8341049569&origin=${encodeURIComponent(origin)}&request_access=write`;

            const popup = window.open(
                authUrl,
                'telegram_auth',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            window.addEventListener('message', function handleTelegramAuth(event) {
                if (event.origin !== 'https://oauth.telegram.org') return;

                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'auth_result' && data.result) {
                        const user = data.result;

                        // Create factory user object
                        const factoryUser = {
                            id: user.id.toString(),
                            telegram_id: user.id.toString(),
                            display_name: user.username || user.first_name,
                            reputation: 0
                        };

                        currentUser = factoryUser;
                        localStorage.setItem('factory_user', JSON.stringify(factoryUser));
                        localStorage.setItem('telegram_user', JSON.stringify(user));

                        hideAuthModal();
                        updateUserPanel();
                        loadLeaderboard(); // Refresh to show user
                        renderGovernanceSections(); // Re-render to enable drag and drop
                        updateNoteboxVisibility(); // Show NoteBox tab if Stuart

                        window.removeEventListener('message', handleTelegramAuth);
                    }
                } catch (e) {
                    console.error('Telegram auth error:', e);
                }
            });

            if (!popup || popup.closed) {
                alert('Popup was blocked. Please allow popups for this site.');
            }
        }

        // Wallet connect via MetaMask
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const address = accounts[0].toLowerCase();
                    const displayName = `${address.slice(0, 6)}...${address.slice(-4)}`;

                    const walletUser = {
                        id: address,
                        wallet_address: address,
                        display_name: displayName,
                        reputation: 0
                    };

                    currentUser = walletUser;
                    localStorage.setItem('factory_user', JSON.stringify(walletUser));
                    localStorage.setItem('connectedWallet', address);

                    hideAuthModal();
                    // Fetch actual user data from database (including rep)
                    await refreshUserData();
                    updateUserPanel();
                    loadLeaderboard();
                    renderGovernanceSections(); // Re-render to enable drag and drop
                    updateNoteboxVisibility(); // Show NoteBox tab if Stuart
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    console.log('Connection cancelled by user');
                } else {
                    alert('Failed to connect wallet. Please try again.');
                }
            }
        }

        // Demo mode for testing
        function connectDemo() {
            const demoUser = {
                id: 'demo_' + Date.now(),
                display_name: 'Demo User',
                reputation: 0
            };
            currentUser = demoUser;
            localStorage.setItem('factory_user', JSON.stringify(demoUser));
            hideAuthModal();
            updateUserPanel();
            renderGovernanceSections(); // Re-render to enable drag and drop
            updateNoteboxVisibility(); // Update NoteBox visibility
        }

        // User menu (logout)
        function showUserMenu() {
            // Build menu options
            let menuText = `ðŸ‘¤ ${currentUser.display_name}\n`;
            menuText += `â­ ${currentUser.reputation || 0} Credits\n\n`;

            // Show linked accounts status
            menuText += `Linked Accounts:\n`;
            menuText += currentUser.telegram_id ? `âœ… Telegram: ${currentUser.telegram_id}\n` : `âŒ Telegram: Not linked\n`;
            menuText += currentUser.wallet_address ? `âœ… Wallet: ${currentUser.wallet_address.slice(0,6)}...${currentUser.wallet_address.slice(-4)}\n` : `âŒ Wallet: Not linked\n`;
            menuText += `\n`;

            // Determine what actions to offer
            const canLinkTelegram = !currentUser.telegram_id && currentUser.wallet_address;
            const canLinkWallet = !currentUser.wallet_address && currentUser.telegram_id;

            if (canLinkTelegram) {
                menuText += `Press OK to link your Telegram account, or Cancel to logout.`;
                if (confirm(menuText)) {
                    linkTelegramAccount();
                    return;
                }
            } else if (canLinkWallet) {
                menuText += `Press OK to link your Wallet, or Cancel to logout.`;
                if (confirm(menuText)) {
                    linkWalletAccount();
                    return;
                }
            } else {
                menuText += `Press OK to logout.`;
                if (!confirm(menuText)) return;
            }

            // Logout
            currentUser = null;
            localStorage.removeItem('factory_user');
            localStorage.removeItem('telegram_user');
            localStorage.removeItem('connectedWallet');
            updateUserPanel();
            loadLeaderboard();
            renderGovernanceSections();
        }

        // Link Telegram to existing wallet account
        async function linkTelegramAccount() {
            const origin = window.location.origin;
            const width = 550;
            const height = 470;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);

            const authUrl = `https://oauth.telegram.org/auth?bot_id=8341049569&origin=${encodeURIComponent(origin)}&request_access=write`;

            const popup = window.open(
                authUrl,
                'telegram_auth',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            window.addEventListener('message', async function handleTelegramLink(event) {
                if (event.origin !== 'https://oauth.telegram.org') return;

                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'auth_result' && data.result) {
                        const telegramUser = data.result;
                        const telegramId = telegramUser.id.toString();

                        // Update the existing factory_users record to add telegram_id
                        const response = await fetch(
                            `${SUPABASE_URL}/rest/v1/factory_users?wallet_address=eq.${currentUser.wallet_address}`,
                            {
                                method: 'PATCH',
                                headers: {
                                    'apikey': SUPABASE_ANON_KEY,
                                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                    'Content-Type': 'application/json',
                                    'Prefer': 'return=representation'
                                },
                                body: JSON.stringify({ telegram_id: telegramId })
                            }
                        );

                        if (response.ok) {
                            currentUser.telegram_id = telegramId;
                            localStorage.setItem('factory_user', JSON.stringify(currentUser));
                            localStorage.setItem('telegram_user', JSON.stringify(telegramUser));
                            alert('âœ… Telegram account linked successfully!');
                            updateUserPanel();
                            // Reload NoteBox to show Telegram ideas
                            if (document.getElementById('noteboxKanbanInline')) {
                                loadNoteboxIdeasForInline();
                            }
                        } else {
                            console.error('Failed to link Telegram:', await response.text());
                            alert('Failed to link Telegram account. Try again.');
                        }

                        window.removeEventListener('message', handleTelegramLink);
                    }
                } catch (e) {
                    console.error('Telegram link error:', e);
                }
            });
        }

        // Link Wallet to existing Telegram account
        async function linkWalletAccount() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet!');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const walletAddress = accounts[0].toLowerCase();

                    // Update the existing factory_users record to add wallet_address
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/factory_users?telegram_id=eq.${currentUser.telegram_id}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=representation'
                            },
                            body: JSON.stringify({ wallet_address: walletAddress })
                        }
                    );

                    if (response.ok) {
                        currentUser.wallet_address = walletAddress;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        localStorage.setItem('connectedWallet', walletAddress);
                        alert('âœ… Wallet linked successfully!');
                        updateUserPanel();
                    } else {
                        console.error('Failed to link wallet:', await response.text());
                        alert('Failed to link wallet. Try again.');
                    }
                }
            } catch (error) {
                console.error('Wallet link error:', error);
            }
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        // Quadratic voting cost formula: cost(n) = n * (n-1) / 2
        function getVoteCost(voteNumber) {
            if (voteNumber <= 1) return 0; // First vote is free
            return Math.floor(voteNumber * (voteNumber - 1) / 2);
        }

        // Get user's vote count for a proposal
        function getUserVoteCount(proposalId) {
            return userVotes[proposalId] || 0;
        }

        // Get refund amount for removing a vote (reverse of cost)
        function getRefundAmount(currentVotes) {
            if (currentVotes <= 1) return 0; // First vote was free, no refund
            return Math.floor(currentVotes * (currentVotes - 1) / 2);
        }

        // Add a vote directly (no modal)
        async function addVote(proposalId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const currentVotes = getUserVoteCount(proposalId);
            const cost = getVoteCost(currentVotes + 1);
            const userRep = currentUser.reputation || 0;

            if (cost > userRep) {
                alert(`Not enough credits! You need ${cost} credits but have ${userRep}.`);
                return;
            }

            // Disable all vote buttons temporarily
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'for',
                    vote_power: 1
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    userVotes[proposalId] = (userVotes[proposalId] || 0) + 1;
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    alert(result.error || 'Failed to add vote');
                }
            } catch (err) {
                console.error('Vote error:', err);
                alert('Error adding vote');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // Remove a vote and refund REP
        async function removeVote(proposalId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const currentVotes = getUserVoteCount(proposalId);
            if (currentVotes <= 0) {
                alert('No votes to remove');
                return;
            }

            const refund = getRefundAmount(currentVotes);

            // Disable all vote buttons temporarily
            const btns = document.querySelectorAll('.vote-btn');
            btns.forEach(btn => btn.disabled = true);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'remove',
                    vote_power: 1
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    userVotes[proposalId] = Math.max(0, (userVotes[proposalId] || 0) - 1);
                    if (result.user) {
                        currentUser.reputation = result.user.reputation;
                        localStorage.setItem('factory_user', JSON.stringify(currentUser));
                        updateUserPanel();
                    }
                    await loadGovernanceProposals();
                    renderGovernanceSections();
                } else {
                    alert(result.error || 'Failed to remove vote');
                }
            } catch (err) {
                console.error('Remove vote error:', err);
                alert('Error removing vote');
            } finally {
                btns.forEach(btn => btn.disabled = false);
            }
        }

        // =============================================
        // COMMENTS FUNCTIONALITY
        // =============================================

        // Cache for loaded comments
        const commentsCache = {};

        // Toggle comments section visibility
        async function toggleComments(proposalId) {
            const section = document.getElementById(`comments-${proposalId}`);
            if (!section) return;

            const isOpen = section.classList.contains('open');

            // Close all other comment sections
            document.querySelectorAll('.comments-section.open').forEach(s => {
                s.classList.remove('open');
            });

            if (!isOpen) {
                section.classList.add('open');
                await loadComments(proposalId);
            }
        }

        // Load comments for a proposal
        async function loadComments(proposalId) {
            const listEl = document.getElementById(`comments-list-${proposalId}`);
            if (!listEl) return;

            // Show loading state
            listEl.innerHTML = '<div class="no-comments">Loading comments...</div>';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_comments?proposal_id=eq.${proposalId}&select=id,content,created_at,user_id,factory_users(display_name)&order=created_at.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const comments = await response.json();
                    commentsCache[proposalId] = comments;
                    renderComments(proposalId, comments);
                } else {
                    listEl.innerHTML = '<div class="no-comments">Failed to load comments</div>';
                }
            } catch (error) {
                console.error('Failed to load comments:', error);
                listEl.innerHTML = '<div class="no-comments">Error loading comments</div>';
            }
        }

        // Render comments list
        function renderComments(proposalId, comments) {
            const listEl = document.getElementById(`comments-list-${proposalId}`);
            if (!listEl) return;

            if (!comments || comments.length === 0) {
                listEl.innerHTML = '<div class="no-comments">No comments yet. Be the first!</div>';
                return;
            }

            listEl.innerHTML = comments.map(comment => {
                const authorName = comment.factory_users?.display_name || 'Anonymous';
                const timeAgo = formatTimeAgo(new Date(comment.created_at));
                return `
                    <div class="comment-item">
                        <div class="comment-header">
                            <span class="comment-author">@${escapeHtml(authorName)}</span>
                            <span class="comment-time">${timeAgo}</span>
                        </div>
                        <div class="comment-content">${escapeHtml(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        // Format time ago
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Post a new comment
        async function postComment(proposalId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const inputEl = document.getElementById(`comment-input-${proposalId}`);
            if (!inputEl) return;

            const content = inputEl.value.trim();
            if (!content) return;

            // Disable submit button
            const section = document.getElementById(`comments-${proposalId}`);
            const submitBtn = section?.querySelector('.comment-submit');
            if (submitBtn) submitBtn.disabled = true;

            try {
                const payload = {
                    proposal_id: proposalId,
                    content: content
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    // Clear input
                    inputEl.value = '';

                    // Update comment count in the button
                    const proposal = governanceProposals.find(p => p.id === proposalId);
                    if (proposal) {
                        proposal.comment_count = (proposal.comment_count || 0) + 1;
                    }

                    // Reload comments
                    await loadComments(proposalId);

                    // Update the comment count badge
                    const countEl = document.querySelector(`[onclick*="toggleComments('${proposalId}')"] .comment-count`);
                    if (countEl && proposal) {
                        countEl.textContent = proposal.comment_count;
                    }
                } else {
                    alert(result.error || 'Failed to post comment');
                }
            } catch (err) {
                console.error('Comment error:', err);
                alert('Error posting comment');
            } finally {
                if (submitBtn) submitBtn.disabled = false;
            }
        }

        // Load user's votes from database
        async function loadUserVotes() {
            if (!currentUser) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${currentUser.id}&select=proposal_id,vote_power`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const votes = await response.json();
                    userVotes = {};
                    votes.forEach(v => {
                        userVotes[v.proposal_id] = (userVotes[v.proposal_id] || 0) + v.vote_power;
                    });
                }
            } catch (error) {
                console.error('Failed to load user votes:', error);
            }
        }

        // Show vote modal
        function showVoteModal(proposalId, voteType) {
            if (!currentUser) {
                alert('Please connect your wallet or Telegram to vote');
                return;
            }

            pendingVote = { proposalId, voteType };
            const currentVotes = getUserVoteCount(proposalId);
            const nextCost = getVoteCost(currentVotes + 1);
            const userRep = currentUser.reputation || 0;

            document.getElementById('voteProposalId').textContent = proposalId.slice(0, 8) + '...';
            document.getElementById('voteCurrentCount').textContent = currentVotes;
            document.getElementById('voteNextCost').textContent = nextCost === 0 ? 'FREE' : nextCost + ' credits';
            document.getElementById('voteUserRep').textContent = userRep;
            document.getElementById('voteTypeFor').checked = voteType === 'for';
            document.getElementById('voteTypeAgainst').checked = voteType === 'against';

            // Enable/disable submit based on credits
            const submitBtn = document.getElementById('voteSubmitBtn');
            if (nextCost > userRep) {
                submitBtn.disabled = true;
                submitBtn.textContent = 'Not enough credits';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = nextCost === 0 ? 'Cast Vote (FREE)' : `Cast Vote (${nextCost} credits)`;
            }

            document.getElementById('voteModal').classList.add('active');
        }

        function hideVoteModal() {
            document.getElementById('voteModal').classList.remove('active');
            pendingVote = null;
        }

        // Submit vote to edge function
        async function submitVote() {
            if (!pendingVote || !currentUser) return;

            const { proposalId, voteType } = pendingVote;
            const selectedType = document.querySelector('input[name="voteType"]:checked').value;

            const submitBtn = document.getElementById('voteSubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        proposal_id: proposalId,
                        direction: selectedType,
                        wallet_address: currentUser.wallet_address,
                        telegram_auth: currentUser.telegram_id ? { id: currentUser.telegram_id } : null
                    })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to submit vote');
                }

                // Update local state
                userVotes[proposalId] = (userVotes[proposalId] || 0) + 1;
                if (data.user) {
                    currentUser.reputation = data.user.reputation;
                    document.getElementById('userRep').textContent = data.user.reputation;
                }

                hideVoteModal();

                // Reload proposals to show updated counts
                await loadGovernanceProposals();
                renderGovernanceSections();

            } catch (error) {
                console.error('Vote error:', error);
                alert('Failed to submit vote: ' + error.message);
                submitBtn.disabled = false;
                submitBtn.textContent = 'Try Again';
            }
        }

        // ===== NOTEBOX FUNCTIONS =====
        const NOTEBOX_CATEGORIES = {
            action_item: { emoji: 'âœ…', label: 'Action' },
            suite_feature: { emoji: 'âš¡', label: 'SUITE' },
            suite_business: { emoji: 'ðŸ’°', label: 'Business' },
            app_idea: { emoji: 'ðŸ’¡', label: 'App Idea' },
            article: { emoji: 'ðŸ“', label: 'Article' },
            personal: { emoji: 'ðŸ ', label: 'Personal' },
            brainstorm: { emoji: 'ðŸ’­', label: 'Brainstorm' },
            question: { emoji: 'â“', label: 'Question' }
        };

        // Fixed column order
        const NOTEBOX_COLUMN_ORDER = ['action_item', 'suite_feature', 'suite_business', 'app_idea', 'article', 'personal', 'brainstorm', 'question'];

        async function loadNoteboxIdeas() {
            if (!currentUser) return;

            // Get user_id from currentUser (format: tg_xxx or wallet_xxx)
            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) {
                console.log('No valid user ID for NoteBox');
                return;
            }

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?select=*&user_id=eq.${encodeURIComponent(userId)}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    noteboxIdeas = await response.json();
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                } else {
                    console.error('Failed to load NoteBox ideas:', await response.text());
                }
            } catch (err) {
                console.error('Error loading NoteBox ideas:', err);
            }
        }

        function updateNoteboxCounts() {
            // Update sidebar counts
            renderDestinationsSidebar();
        }

        function renderNoteboxKanban() {
            const container = document.getElementById('noteboxKanban');
            if (!container) return; // Not in NoteBox view

            // Filter by destination
            let activeIdeas = noteboxIdeas.filter(i => i.status === 'inbox');
            let archivedIdeas = noteboxIdeas.filter(i => i.status === 'implemented' || i.status === 'dismissed');

            // Apply destination filter
            if (currentDestination !== 'all') {
                activeIdeas = activeIdeas.filter(i => i.destination_slug === currentDestination);
                archivedIdeas = archivedIdeas.filter(i => i.destination_slug === currentDestination);
            }

            if (activeIdeas.length === 0 && archivedIdeas.length === 0) {
                const destName = currentDestination === 'all' ? 'NoteBox' :
                    (noteboxDestinations.find(d => d.slug === currentDestination)?.name || currentDestination);
                container.innerHTML = `
                    <div class="notebox-empty">
                        <div class="notebox-empty-icon">ðŸ“¦</div>
                        <div>No ideas in ${destName} yet. Add one above!</div>
                    </div>
                `;
                return;
            }

            // Group active ideas by category for display
            const grouped = {};
            activeIdeas.forEach(idea => {
                const cat = idea.category || 'brainstorm';
                if (!grouped[cat]) {
                    grouped[cat] = [];
                }
                grouped[cat].push(idea);
            });

            // Render grouped columns + Archive column
            let columnsHtml = Object.entries(grouped).map(([category, ideas]) => {
                const cat = NOTEBOX_CATEGORIES[category] || { emoji: 'ðŸ“', label: category };
                return `
                    <div class="notebox-column" data-category="${category}">
                        <div class="notebox-column-header">
                            <span>${cat.emoji}</span>
                            <span>${cat.label}</span>
                            <span class="notebox-column-count">${ideas.length}</span>
                        </div>
                        <div class="notebox-column-cards" data-category="${category}">
                            ${ideas.map(idea => renderNoteboxCard(idea)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Add Archive column at the end
            columnsHtml += `
                <div class="notebox-column archive-column" data-category="archive">
                    <div class="notebox-column-header" style="opacity: 0.7;">
                        <span>ðŸ“</span>
                        <span>Archive</span>
                        <span class="notebox-column-count">${archivedIdeas.length}</span>
                    </div>
                    <div class="notebox-column-cards" data-category="archive">
                        ${archivedIdeas.map(idea => renderNoteboxCard(idea)).join('')}
                    </div>
                </div>
            `;

            container.innerHTML = columnsHtml;

            // Setup drag and drop
            setupDragAndDrop();
        }

        function renderNoteboxCard(idea) {
            const cat = NOTEBOX_CATEGORIES[idea.category] || { emoji: 'ðŸ“', label: idea.category };
            const isArchived = idea.status === 'implemented' || idea.status === 'dismissed';
            return `
                <div class="notebox-card" draggable="true" data-id="${idea.id}" data-status="${idea.status}">
                    <button class="notebox-card-delete" onclick="event.stopPropagation(); deleteNoteboxIdea('${idea.id}')" title="Delete">Ã—</button>
                    <div class="notebox-card-header">
                        <span class="notebox-card-emoji">${cat.emoji}</span>
                        <span class="notebox-card-category">${cat.label}</span>
                    </div>
                    <div class="notebox-card-title">${escapeHtml(idea.title)}</div>
                    ${idea.content ? `<div class="notebox-card-content">${escapeHtml(idea.content)}</div>` : ''}
                    ${idea.status === 'inbox' ? `
                        <div class="notebox-card-actions">
                            <button class="notebox-card-btn push" onclick="event.stopPropagation(); togglePushDropdown('${idea.id}', event)">Push To â†’</button>
                            <button class="notebox-card-btn done" onclick="markNoteboxDone('${idea.id}')">âœ“</button>
                        </div>
                    ` : `
                        ${idea.dismiss_reason ? `<div class="notebox-card-reason">${escapeHtml(idea.dismiss_reason)}</div>` : ''}
                        <div class="notebox-card-status">
                            <span style="font-size: 0.75rem; color: var(--text-dim);">${idea.status === 'implemented' ? 'âœ“ Completed' : 'âœ• Dismissed'}</span>
                        </div>
                    `}
                </div>
            `;
        }

        // Drag and drop functionality
        let draggedCard = null;

        function setupDragAndDrop() {
            const cards = document.querySelectorAll('.notebox-card[draggable="true"]');
            const dropZones = document.querySelectorAll('.notebox-column-cards');
            console.log('[setupDragAndDrop] Found', cards.length, 'cards and', dropZones.length, 'drop zones');

            cards.forEach(card => {
                card.addEventListener('dragstart', noteboxHandleDragStart);
                card.addEventListener('dragend', noteboxHandleDragEnd);
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', noteboxHandleDragOver);
                zone.addEventListener('dragenter', noteboxHandleDragEnter);
                zone.addEventListener('dragleave', noteboxHandleDragLeave);
                zone.addEventListener('drop', noteboxHandleDrop);
            });
        }

        function noteboxHandleDragStart(e) {
            console.log('[NoteBox DragStart]', e.target.dataset.id);
            draggedCard = e.target;
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', e.target.dataset.id);
        }

        function noteboxHandleDragEnd(e) {
            console.log('[NoteBox DragEnd]', draggedCard?.dataset?.id);
            e.target.classList.remove('dragging');
            document.querySelectorAll('.notebox-column-cards').forEach(zone => {
                zone.classList.remove('drag-over');
            });
            draggedCard = null;
        }

        function noteboxHandleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function noteboxHandleDragEnter(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.notebox-column-cards');
            if (dropZone) {
                dropZone.classList.add('drag-over');
            }
        }

        function noteboxHandleDragLeave(e) {
            const dropZone = e.target.closest('.notebox-column-cards');
            if (dropZone && !dropZone.contains(e.relatedTarget)) {
                dropZone.classList.remove('drag-over');
            }
        }

        async function noteboxHandleDrop(e) {
            e.preventDefault();
            const dropZone = e.target.closest('.notebox-column-cards');
            console.log('[NoteBox Drop]', { dropZone: dropZone?.dataset?.category, draggedCard: draggedCard?.dataset });
            if (!dropZone || !draggedCard) {
                console.log('[NoteBox Drop] No dropZone or draggedCard!');
                return;
            }

            dropZone.classList.remove('drag-over');

            const ideaId = draggedCard.dataset.id;
            const targetCategory = dropZone.dataset.category;
            const currentStatus = draggedCard.dataset.status;
            console.log('[NoteBox Drop] Moving:', { ideaId, from: currentStatus, to: targetCategory });

            // If dropping to archive, mark as implemented
            if (targetCategory === 'archive' && currentStatus === 'inbox') {
                console.log('[NoteBox Drop] -> Archive');
                await archiveNoteboxIdea(ideaId, 'implemented', 'Moved to archive');
                return;
            }

            // If dropping from archive back to a category, restore it
            if (targetCategory !== 'archive' && (currentStatus === 'implemented' || currentStatus === 'dismissed')) {
                console.log('[NoteBox Drop] -> Restore from archive to', targetCategory);
                await updateNoteboxIdea(ideaId, { status: 'inbox', category: targetCategory });
                return;
            }

            // If moving between active categories, just update category
            if (targetCategory !== 'archive' && currentStatus === 'inbox') {
                console.log('[NoteBox Drop] -> Change category to', targetCategory);
                await updateNoteboxIdea(ideaId, { category: targetCategory });
            }
        }

        async function updateNoteboxIdea(ideaId, updates) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updates)
                    }
                );

                if (response.ok) {
                    // Update local data
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        Object.assign(idea, updates);
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error updating idea:', err);
            }
        }

        async function archiveNoteboxIdea(ideaId, status, reason) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: status,
                            dismiss_reason: reason
                        })
                    }
                );

                if (response.ok) {
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        idea.status = status;
                        idea.dismiss_reason = reason;
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error archiving idea:', err);
            }
        }

        async function deleteNoteboxIdea(ideaId) {
            console.log('[deleteNoteboxIdea] Deleting:', ideaId);
            if (!confirm('Delete this idea permanently?')) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                console.log('[deleteNoteboxIdea] Response:', response.status);
                if (response.ok) {
                    noteboxIdeas = noteboxIdeas.filter(i => i.id !== ideaId);
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                    console.log('[deleteNoteboxIdea] Done!');
                } else {
                    console.error('[deleteNoteboxIdea] Failed:', await response.text());
                }
            } catch (err) {
                console.error('Error deleting idea:', err);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DESTINATIONS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function loadDestinations() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/intake_destinations?active=eq.true&order=sort_order`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    noteboxDestinations = await response.json();
                    renderDestinationsSidebar();
                }
            } catch (err) {
                console.error('Error loading destinations:', err);
            }
        }

        function renderDestinationsSidebar() {
            const container = document.getElementById('noteboxDestinations');
            if (!container) return; // Not in NoteBox view

            // Add "All" option first
            let html = `
                <button class="filter-btn ${currentDestination === 'all' ? 'active' : ''}" onclick="selectDestination('all')">
                    ðŸ“‹ All Ideas <span class="filter-count">${noteboxIdeas.length}</span>
                </button>
            `;

            // Add each destination
            html += noteboxDestinations.map(dest => {
                const count = noteboxIdeas.filter(i => i.destination_slug === dest.slug && i.status === 'inbox').length;
                return `
                    <button class="filter-btn ${currentDestination === dest.slug ? 'active' : ''}" onclick="selectDestination('${dest.slug}')">
                        ${dest.icon || 'ðŸ“'} ${dest.name} <span class="filter-count">${count}</span>
                    </button>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function selectDestination(slug) {
            currentDestination = slug;
            renderDestinationsSidebar();
            renderNoteboxKanban();
        }

        // Push To Dropdown Functions
        let activePushDropdown = null;

        function togglePushDropdown(ideaId, event) {
            const dropdown = document.getElementById('globalPushDropdown');
            const button = event ? event.target.closest('.notebox-card-btn.push') : null;

            // If clicking same button, close dropdown
            if (dropdown.classList.contains('active') && dropdown.dataset.ideaId === ideaId) {
                closePushDropdown();
                return;
            }

            // Store the idea ID on the dropdown
            dropdown.dataset.ideaId = ideaId;
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();

            // Position the dropdown relative to the button
            if (button) {
                const rect = button.getBoundingClientRect();
                dropdown.style.top = (rect.bottom + 4) + 'px';
                dropdown.style.left = rect.left + 'px';
            }

            dropdown.classList.add('active');
            activePushDropdown = dropdown;
        }

        function closePushDropdown() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.classList.remove('active');
            dropdown.dataset.ideaId = '';
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();
            activePushDropdown = null;
        }

        function resetDropdownContent() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.innerHTML = `
                <div class="push-dropdown-header">Push to...</div>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); showSectionSelect()">
                    ðŸ›ï¸ getSUITE Governance
                </button>
            `;
        }

        function showSectionSelect() {
            const dropdown = document.getElementById('globalPushDropdown');
            const ideaId = dropdown.dataset.ideaId;

            if (!ideaId) {
                console.error('No ideaId found in dropdown');
                alert('Error: Please try clicking the Push To button again');
                closePushDropdown();
                return;
            }

            console.log('showSectionSelect for idea:', ideaId);
            dropdown.dataset.step = 'sections';
            dropdown.innerHTML = `
                <button class="push-dropdown-item back" onclick="event.stopPropagation(); backToDestinations()">
                    â† Back
                </button>
                <div class="push-dropdown-header">Select Section</div>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'suite_apps')">
                    ðŸ“± SUITE Apps
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'business')">
                    ðŸ’¼ Business
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'content')">
                    ðŸ“ Content
                </button>
                <button class="push-dropdown-item" onclick="event.stopPropagation(); pushToGovernance('${ideaId}', 'social')">
                    ðŸ’¬ Social
                </button>
            `;
        }

        function backToDestinations() {
            const dropdown = document.getElementById('globalPushDropdown');
            dropdown.dataset.step = 'destinations';
            resetDropdownContent();
        }

        async function pushToGovernance(ideaId, section) {
            console.log('pushToGovernance called:', ideaId, section);
            console.log('noteboxIdeas count:', noteboxIdeas.length);
            console.log('noteboxIdeas IDs:', noteboxIdeas.map(i => ({ id: i.id, type: typeof i.id })));

            // Compare as strings to handle type mismatches
            const idea = noteboxIdeas.find(i => String(i.id) === String(ideaId));
            if (!idea) {
                console.error('Idea not found. Looking for:', ideaId, 'Type:', typeof ideaId);
                alert('Error: Could not find the idea. Check console for details.');
                closePushDropdown();
                return;
            }

            console.log('Found idea:', idea);

            // Close dropdown and show loading state
            closePushDropdown();

            try {
                // Create a proposal from the idea
                const payload = {
                    content: idea.title + (idea.content ? '\n\n' + idea.content : ''),
                    section: section,
                    wallet_address: currentUser?.wallet_address || null,
                    telegram_auth: currentUser?.telegram_id ? { id: currentUser.telegram_id } : null
                };

                console.log('Submitting proposal:', payload);

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                console.log('Response status:', response.status);

                if (response.ok) {
                    // Mark the idea as pushed/implemented
                    await fetch(`${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ status: 'implemented', dismiss_reason: `Pushed to Governance â†’ ${section}` })
                    });

                    // Reload and re-render (wrapped in try-catch to not break on missing elements)
                    try {
                        await loadGovernanceProposals();
                        renderGovernanceSections();
                    } catch (e) { console.log('Error reloading governance:', e); }

                    // Reload NoteBox for whichever view is active
                    try {
                        // Try inline view first (Stuart Factory tab)
                        if (document.getElementById('noteboxKanbanInline')) {
                            await loadNoteboxIdeasForInline();
                        }
                        // Also try regular NoteBox view
                        if (document.getElementById('noteboxKanban')) {
                            await loadNoteboxIdeas();
                            renderNoteboxKanban();
                        }
                    } catch (e) { console.log('Error reloading notebox:', e); }
                } else {
                    const data = await response.json();
                    console.error('Push failed:', data);
                    alert('Failed to push: ' + (data.error || 'Unknown error'));
                }
            } catch (err) {
                console.error('Push to governance error:', err);
                alert('Failed to push idea: ' + err.message);
            }
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (activePushDropdown && !e.target.closest('.push-dropdown') && !e.target.closest('.notebox-card-btn.push')) {
                closePushDropdown();
            }
        });

        function showPushToModal(ideaId) {
            pushingIdeaId = ideaId;
            const container = document.getElementById('pushToDestinations');

            // Get current idea's destination
            const idea = noteboxIdeas.find(i => i.id === ideaId);
            const currentSlug = idea?.destination_slug;

            container.innerHTML = noteboxDestinations
                .filter(dest => dest.slug !== currentSlug) // Don't show current destination
                .map(dest => `
                    <button class="destination-btn" onclick="pushToDestination('${dest.slug}')">
                        <span class="dest-icon">${dest.icon || 'ðŸ“'}</span>
                        <div class="dest-info">
                            <div class="dest-name">${dest.name}</div>
                            <div class="dest-desc">${dest.description || ''}</div>
                        </div>
                    </button>
                `).join('');

            document.getElementById('pushToModal').classList.add('active');
        }

        function hidePushToModal() {
            document.getElementById('pushToModal').classList.remove('active');
            pushingIdeaId = null;
        }

        async function pushToDestination(destSlug) {
            if (!pushingIdeaId) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${pushingIdeaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ destination_slug: destSlug })
                    }
                );

                if (response.ok) {
                    const idea = noteboxIdeas.find(i => i.id === pushingIdeaId);
                    if (idea) {
                        idea.destination_slug = destSlug;
                    }
                    hidePushToModal();
                    renderDestinationsSidebar();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error pushing idea:', err);
            }
        }

        function showAddDestinationModal() {
            document.getElementById('newDestinationName').value = '';
            document.getElementById('newDestinationIcon').value = '';
            document.getElementById('newDestinationDesc').value = '';
            document.getElementById('addDestinationModal').classList.add('active');
        }

        function hideAddDestinationModal() {
            document.getElementById('addDestinationModal').classList.remove('active');
        }

        async function createDestination() {
            const name = document.getElementById('newDestinationName').value.trim();
            const icon = document.getElementById('newDestinationIcon').value.trim() || 'ðŸ“';
            const description = document.getElementById('newDestinationDesc').value.trim();

            if (!name) {
                alert('Please enter a name');
                return;
            }

            const slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/intake_destinations`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            name,
                            slug,
                            icon,
                            description,
                            active: true,
                            sort_order: noteboxDestinations.length
                        })
                    }
                );

                if (response.ok) {
                    const [newDest] = await response.json();
                    noteboxDestinations.push(newDest);
                    hideAddDestinationModal();
                    renderDestinationsSidebar();
                }
            } catch (err) {
                console.error('Error creating destination:', err);
            }
        }

        async function addNoteboxIdea() {
            const input = document.getElementById('noteboxQuickInput');
            const text = input.value.trim();
            if (!text || !currentUser) return;

            const userId = currentUser.telegram_id ? `tg_${currentUser.telegram_id}` :
                           currentUser.wallet_address ? `wallet_${currentUser.wallet_address}` : null;

            if (!userId) return;

            // Simple auto-categorization
            const categorized = autoCategorizeIdea(text);

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify({
                            raw_input: text,
                            category: categorized.category,
                            title: categorized.title,
                            content: categorized.content,
                            status: 'inbox',
                            user_id: userId
                        })
                    }
                );

                if (response.ok) {
                    const [newIdea] = await response.json();
                    noteboxIdeas.unshift(newIdea);
                    input.value = '';
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                } else {
                    console.error('Failed to add idea:', await response.text());
                }
            } catch (err) {
                console.error('Error adding idea:', err);
            }
        }

        function autoCategorizeIdea(text) {
            const lower = text.toLowerCase();
            let category = 'brainstorm';

            if (lower.includes('suite') || lower.includes('foodvitals') || lower.includes('cheshbon') || lower.includes('opticrep')) {
                category = 'suite_feature';
            } else if (lower.includes('app idea') || lower.includes('new app')) {
                category = 'app_idea';
            } else if (lower.includes('article') || lower.includes('blog') || lower.includes('write')) {
                category = 'article';
            } else if (lower.includes('todo') || lower.includes('call') || lower.includes('email') || lower.includes('contact')) {
                category = 'action_item';
            } else if (lower.includes('?')) {
                category = 'question';
            }

            return {
                category,
                title: text.length > 60 ? text.substring(0, 60) + '...' : text,
                content: text.length > 60 ? text : ''
            };
        }

        function markNoteboxDone(ideaId) {
            showNoteboxArchiveModal(ideaId, 'done');
        }

        function dismissNoteboxIdea(ideaId) {
            showNoteboxArchiveModal(ideaId, 'dismiss');
        }

        function showNoteboxArchiveModal(ideaId, action) {
            noteboxArchiveIdeaId = ideaId;
            noteboxArchiveAction = action;

            const modal = document.getElementById('noteboxArchiveModal');
            const title = document.getElementById('noteboxArchiveTitle');
            const label = document.getElementById('noteboxArchiveLabel');
            const textarea = document.getElementById('noteboxArchiveReason');
            const confirmBtn = document.getElementById('noteboxArchiveConfirm');

            if (action === 'done') {
                title.textContent = 'Mark as Done';
                label.textContent = 'What did you accomplish?';
                textarea.placeholder = 'Briefly describe what was done...';
                confirmBtn.textContent = 'âœ“ Mark Done';
                confirmBtn.style.background = 'var(--success)';
            } else {
                title.textContent = 'Dismiss Idea';
                label.textContent = 'Why are you dismissing this?';
                textarea.placeholder = 'Reason for dismissing (not relevant, duplicate, etc.)...';
                confirmBtn.textContent = 'âœ• Dismiss';
                confirmBtn.style.background = 'var(--error)';
            }

            textarea.value = '';
            modal.classList.add('active');
            textarea.focus();
        }

        function hideNoteboxArchiveModal() {
            document.getElementById('noteboxArchiveModal').classList.remove('active');
            noteboxArchiveIdeaId = null;
            noteboxArchiveAction = null;
        }

        async function confirmNoteboxArchive() {
            if (!noteboxArchiveIdeaId || !noteboxArchiveAction) return;

            const reason = document.getElementById('noteboxArchiveReason').value.trim();
            if (!reason) {
                document.getElementById('noteboxArchiveReason').style.borderColor = 'var(--error)';
                return;
            }

            const status = noteboxArchiveAction === 'done' ? 'implemented' : 'dismissed';
            await updateNoteboxIdeaStatus(noteboxArchiveIdeaId, status, reason);
            hideNoteboxArchiveModal();
        }

        async function updateNoteboxIdeaStatus(ideaId, status, reason = null) {
            try {
                const updateData = { status };
                if (reason !== null) {
                    updateData.dismiss_reason = reason; // Using dismiss_reason for both done and dismiss
                }

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/personal_ideas?id=eq.${ideaId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(updateData)
                    }
                );

                if (response.ok) {
                    // Update local state
                    const idea = noteboxIdeas.find(i => i.id === ideaId);
                    if (idea) {
                        idea.status = status;
                        if (reason !== null) idea.dismiss_reason = reason;
                    }
                    updateNoteboxCounts();
                    renderNoteboxKanban();
                }
            } catch (err) {
                console.error('Error updating idea:', err);
            }
        }

        function filterNoteboxCategory(category) {
            noteboxCategoryFilter = category;

            // Update filter buttons
            document.querySelectorAll('.notebox-sidebar .filter-btn[data-category]').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.category === category);
            });

            renderNoteboxKanban();
        }

        // Close modals on escape
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideSubmitModal();
                hideAuthModal();
                hideNoteboxArchiveModal();
            }
        });
    </script>

    <!-- Main Site Navigation Component -->
    <script src="/nav-component.js"></script>
</body>
</html>
