<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Proto Golf</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-ink: #1a1a1a;
            --color-carbon: #2d2d2d;
            --color-graphite: #404040;
            --color-steel: #6b6b6b;
            --color-silver: #a3a3a3;
            --color-ash: #d4d4d4;
            --color-mist: #e5e5e5;
            --color-bone: #f5f5f5;
            --color-paper: #fafafa;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--color-bone);
            color: var(--color-ink);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--color-ink);
        }

        .login-card {
            background: var(--color-paper);
            border-radius: 16px;
            padding: 48px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 64px;
            height: 64px;
            background: var(--color-ink);
            color: var(--color-paper);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0 auto 24px;
        }

        .login-card h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .login-card > p {
            color: var(--color-steel);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-ink);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-ink);
            color: var(--color-paper);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-carbon);
        }

        .btn-secondary {
            background: var(--color-mist);
            color: var(--color-ink);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 0.875rem;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            background: var(--color-ink);
            color: var(--color-paper);
            padding: 24px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--color-paper);
            color: var(--color-ink);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .sidebar-logo-text {
            font-weight: 700;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 4px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--color-silver);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-paper);
        }

        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--color-paper);
        }

        .main-content {
            margin-left: 240px;
            padding: 32px;
            min-height: 100vh;
            width: calc(100% - 240px);
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .main-header h1 {
            font-size: 1.75rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--color-paper);
            border: 1px solid var(--color-ash);
            border-radius: 12px;
            padding: 24px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--color-steel);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 8px;
        }

        .stat-change.positive { color: var(--color-success); }
        .stat-change.negative { color: var(--color-error); }
        .stat-change.neutral { color: var(--color-steel); }

        /* Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-card {
            background: var(--color-paper);
            border: 1px solid var(--color-ash);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-ash);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--color-bone);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--color-mist);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--color-bone);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--color-success); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--color-warning); }
        .badge-error { background: rgba(239, 68, 68, 0.15); color: var(--color-error); }
        .badge-neutral { background: var(--color-mist); color: var(--color-steel); }

        .stock-input {
            width: 80px;
            padding: 8px 12px;
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            text-align: center;
        }

        .stock-input:focus {
            outline: none;
            border-color: var(--color-ink);
        }

        /* Order Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--color-paper);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-ash);
        }

        .modal-header h3 {
            font-size: 1.25rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--color-bone);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-actions {
            padding: 20px 24px;
            border-top: 1px solid var(--color-ash);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Order Form (Printable) */
        .order-form {
            font-family: 'Space Mono', monospace;
        }

        .order-form-header {
            text-align: center;
            border-bottom: 2px solid var(--color-ink);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .order-form-header h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
        }

        .order-form-section {
            margin-bottom: 24px;
        }

        .order-form-section h4 {
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--color-ash);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .order-form-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--color-mist);
        }

        .order-form-row:last-child {
            border-bottom: none;
        }

        .order-form-label {
            color: var(--color-steel);
        }

        .order-form-specs {
            background: var(--color-bone);
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .order-form-notes {
            background: var(--color-bone);
            padding: 16px;
            min-height: 80px;
            border-radius: 8px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .modal, .modal * { visibility: visible; }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                box-shadow: none;
            }
            .modal-header, .modal-actions { display: none !important; }
        }

        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Setup Banner */
        .setup-banner {
            background: linear-gradient(135deg, var(--color-ink) 0%, var(--color-carbon) 100%);
            color: var(--color-paper);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .setup-banner h3 {
            margin-bottom: 8px;
        }

        .setup-banner p {
            color: var(--color-silver);
            margin-bottom: 16px;
        }

        .setup-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .setup-step {
            background: rgba(255,255,255,0.1);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setup-step-icon {
            width: 28px;
            height: 28px;
            background: var(--color-paper);
            color: var(--color-ink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .setup-step.done .setup-step-icon {
            background: var(--color-success);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">P</div>
            <h1>Proto Golf Admin</h1>
            <p>Enter your password to continue</p>

            <div class="login-error" id="loginError">Invalid password</div>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter admin password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">P</div>
                <span class="sidebar-logo-text">Proto Admin</span>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li><a href="#" class="active" onclick="showSection('overview', event)">Overview</a></li>
                    <li><a href="#" onclick="showSection('orders', event)">Orders</a></li>
                    <li><a href="#" onclick="showSection('inventory', event)">Inventory</a></li>
                    <li><a href="#" onclick="showSection('analytics', event)">Analytics</a></li>
                    <li style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <a href="../index.html" target="_blank">View Site ↗</a>
                    </li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <div class="content-section active" id="section-overview">
                <div class="main-header">
                    <h1>Dashboard</h1>
                    <span style="color: var(--color-steel);">Welcome back</span>
                </div>

                <!-- Setup Banner -->
                <div class="setup-banner" id="setupBanner">
                    <h3>Complete Your Setup</h3>
                    <p>Connect your services to enable full functionality</p>
                    <div class="setup-steps">
                        <div class="setup-step" id="step-supabase">
                            <div class="setup-step-icon">1</div>
                            <span>Supabase Database</span>
                        </div>
                        <div class="setup-step" id="step-stripe">
                            <div class="setup-step-icon">2</div>
                            <span>Stripe Payments</span>
                        </div>
                        <div class="setup-step" id="step-email">
                            <div class="setup-step-icon">3</div>
                            <span>Email Notifications</span>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Orders Today</div>
                        <div class="stat-value" id="ordersToday">0</div>
                        <div class="stat-change neutral">Demo mode</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue (This Week)</div>
                        <div class="stat-value" id="weeklyRevenue">$0</div>
                        <div class="stat-change neutral">Demo mode</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Orders</div>
                        <div class="stat-value" id="pendingOrders">0</div>
                        <div class="stat-change neutral">Awaiting shipment</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Low Stock Items</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div class="stat-change negative" id="lowStockLabel">Check inventory</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Recent Orders</h3>
                        <button class="btn btn-secondary btn-sm" onclick="showSection('orders', event)">View All</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: var(--color-steel); padding: 40px;">
                                    No orders yet. Orders will appear here once you connect Supabase.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="content-section" id="section-orders">
                <div class="main-header">
                    <h1>Orders</h1>
                    <button class="btn btn-secondary btn-sm" onclick="exportOrders()">Export CSV</button>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">All Orders</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Delivery</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--color-steel); padding: 40px;">
                                    No orders yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="content-section" id="section-inventory">
                <div class="main-header">
                    <h1>Inventory</h1>
                    <button class="btn btn-primary btn-sm" onclick="saveInventory()">Save Changes</button>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Product Stock</h3>
                        <span style="color: var(--color-steel); font-size: 0.875rem;">Stock is tracked per model, not per variant</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Base Price</th>
                                <th>Stock (Blanks)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Inventory Notes</h3>
                    </div>
                    <div style="padding: 24px; color: var(--color-steel);">
                        <p><strong>Stock = 1:</strong> Product shows as "Sold Out" on the website</p>
                        <p style="margin-top: 8px;"><strong>Stock = 0:</strong> Product is hidden from shop</p>
                        <p style="margin-top: 8px;">Stock count represents unfinished blanks. All variants (finishes, shaft colors) draw from the same stock pool.</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="section-analytics">
                <div class="main-header">
                    <h1>Analytics</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Page Views (7 days)</div>
                        <div class="stat-value" id="pageViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Product Views</div>
                        <div class="stat-value" id="productViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Add to Cart</div>
                        <div class="stat-value" id="addToCarts">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Checkouts</div>
                        <div class="stat-value" id="checkouts">-</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Conversion Funnel</h3>
                    </div>
                    <div style="padding: 40px; text-align: center; color: var(--color-steel);">
                        <p>Analytics data will appear here once you connect Supabase.</p>
                        <p style="margin-top: 8px;">Track: page views → product views → add to cart → checkout started → purchase completed</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">×</button>
            </div>
            <div class="modal-body">
                <div class="order-form" id="orderFormContent">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button class="btn btn-primary" onclick="printOrderForm()">Print Order Form</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // Data from Supabase
        let inventory = [];
        let orders = [];

        // Auth
        const ADMIN_PASSWORD = 'proto2026';

        // Supabase API helper
        async function supabaseQuery(table, method = 'GET', body = null, query = '') {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const options = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
                }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(url, options);
            if (method === 'GET') return response.json();
            return response.ok;
        }

        function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;

            if (password === ADMIN_PASSWORD) {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                sessionStorage.setItem('proto_admin_auth', 'true');
                initDashboard();
            } else {
                document.getElementById('loginError').style.display = 'block';
            }
        }

        function logout() {
            sessionStorage.removeItem('proto_admin_auth');
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginPassword').value = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('proto_admin_auth') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                initDashboard();
            }
        });

        async function initDashboard() {
            // Hide setup banner once connected
            document.getElementById('setupBanner').style.display = 'none';

            // Fetch data from Supabase
            await fetchInventory();
            await fetchOrders();
            renderInventory();
            renderOrders();
            updateStats();
        }

        async function fetchInventory() {
            try {
                const data = await supabaseQuery('proto_golf_products', 'GET', null, '?order=name');
                inventory = data.map(p => ({
                    id: p.id,
                    name: p.name,
                    basePrice: parseFloat(p.base_price),
                    stock: p.stock,
                    status: p.status
                }));
                console.log('Inventory loaded:', inventory);
            } catch (e) {
                console.error('Failed to fetch inventory:', e);
            }
        }

        async function fetchOrders() {
            try {
                const data = await supabaseQuery('proto_golf_orders', 'GET', null, '?order=created_at.desc&limit=50');
                orders = data.map(o => ({
                    id: o.id,
                    orderNumber: o.order_number,
                    date: new Date(o.created_at).toLocaleDateString(),
                    customerName: o.customer_name,
                    customerEmail: o.customer_email,
                    customerPhone: o.customer_phone,
                    productId: o.product_id,
                    productName: o.product_name,
                    finish: o.finish,
                    shaftColor: o.shaft_color,
                    deliveryMethod: o.delivery_method,
                    shippingAddress: o.shipping_address ?
                        `${o.shipping_address.line1}, ${o.shipping_address.city}, ${o.shipping_address.state}` : null,
                    pickupDate: o.pickup_date,
                    pickupTime: o.pickup_time,
                    total: parseFloat(o.total),
                    status: o.status,
                    paymentStatus: o.payment_status,
                    notes: o.notes
                }));
                console.log('Orders loaded:', orders);
            } catch (e) {
                console.error('Failed to fetch orders:', e);
            }
        }

        function showSection(sectionId, event) {
            if (event) event.preventDefault();

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + sectionId).classList.add('active');

            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
        }

        function renderInventory() {
            const table = document.getElementById('inventoryTable');
            table.innerHTML = inventory.map(item => {
                let statusBadge = '';
                if (item.status === 'coming_soon') {
                    statusBadge = '<span class="badge badge-neutral">Coming Soon</span>';
                } else if (item.stock <= 1) {
                    statusBadge = '<span class="badge badge-error">Sold Out</span>';
                } else if (item.stock <= 5) {
                    statusBadge = '<span class="badge badge-warning">Low Stock</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">In Stock</span>';
                }

                return `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>$${item.basePrice}</td>
                        <td>
                            <input type="number" class="stock-input" value="${item.stock}"
                                   onchange="updateStock('${item.id}', this.value)" min="0">
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateStock(id, value) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                item.stock = parseInt(value) || 0;
                item.changed = true;
                renderInventory();
                updateStats();
            }
        }

        async function saveInventory() {
            const changedItems = inventory.filter(i => i.changed);
            if (changedItems.length === 0) {
                alert('No changes to save');
                return;
            }

            let saved = 0;
            for (const item of changedItems) {
                try {
                    await supabaseQuery('proto_golf_products', 'PATCH',
                        { stock: item.stock },
                        `?id=eq.${item.id}`
                    );
                    item.changed = false;
                    saved++;
                } catch (e) {
                    console.error('Failed to save:', item.id, e);
                }
            }

            alert(`Saved ${saved} item(s) to database!`);
            renderInventory();
        }

        function renderOrders() {
            const table = document.getElementById('ordersTable');
            const recentTable = document.getElementById('recentOrdersTable');

            if (orders.length === 0) {
                const emptyRow = `<tr><td colspan="8" style="text-align: center; color: var(--color-steel); padding: 40px;">No orders yet</td></tr>`;
                table.innerHTML = emptyRow;
                recentTable.innerHTML = emptyRow.replace('8', '5');
                return;
            }

            // Full orders table
            table.innerHTML = orders.map(o => {
                const statusBadge = o.status === 'pending' ? 'badge-warning' :
                    o.status === 'shipped' || o.status === 'completed' ? 'badge-success' : 'badge-neutral';

                return `
                    <tr>
                        <td><strong>${o.orderNumber}</strong></td>
                        <td>${o.date}</td>
                        <td>${o.customerName}<br><small style="color:var(--color-steel)">${o.customerEmail}</small></td>
                        <td>${o.productName}<br><small style="color:var(--color-steel)">${o.finish}</small></td>
                        <td>${o.deliveryMethod === 'shipping' ? 'Ship' : 'Pickup'}</td>
                        <td><strong>$${o.total.toFixed(2)}</strong></td>
                        <td><span class="badge ${statusBadge}">${o.status}</span></td>
                        <td><button class="btn btn-secondary btn-sm" onclick="openOrderModal('${o.id}')">View</button></td>
                    </tr>
                `;
            }).join('');

            // Recent orders (first 5)
            recentTable.innerHTML = orders.slice(0, 5).map(o => {
                const statusBadge = o.status === 'pending' ? 'badge-warning' :
                    o.status === 'shipped' || o.status === 'completed' ? 'badge-success' : 'badge-neutral';

                return `
                    <tr>
                        <td><strong>${o.orderNumber}</strong></td>
                        <td>${o.customerName}</td>
                        <td>${o.productName}</td>
                        <td><strong>$${o.total.toFixed(2)}</strong></td>
                        <td><span class="badge ${statusBadge}">${o.status}</span></td>
                    </tr>
                `;
            }).join('');

            // Update stats
            document.getElementById('ordersToday').textContent = orders.filter(o =>
                o.date === new Date().toLocaleDateString()
            ).length;

            document.getElementById('pendingOrders').textContent = orders.filter(o =>
                o.status === 'pending'
            ).length;

            const weekRevenue = orders.filter(o => {
                const orderDate = new Date(o.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return orderDate >= weekAgo && o.paymentStatus === 'paid';
            }).reduce((sum, o) => sum + o.total, 0);

            document.getElementById('weeklyRevenue').textContent = '$' + weekRevenue.toFixed(0);
        }

        function updateStats() {
            const lowStock = inventory.filter(i => i.stock > 0 && i.stock <= 5).length;
            document.getElementById('lowStockCount').textContent = lowStock;

            if (lowStock > 0) {
                document.getElementById('lowStockLabel').textContent = 'Restock needed';
                document.getElementById('lowStockLabel').className = 'stat-change negative';
            } else {
                document.getElementById('lowStockLabel').textContent = 'All good';
                document.getElementById('lowStockLabel').className = 'stat-change positive';
            }
        }

        function openOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const content = document.getElementById('orderFormContent');
            content.innerHTML = generateOrderForm(order);

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function generateOrderForm(order) {
            return `
                <div class="order-form-header">
                    <h2>PROTO GOLF ORDER FORM</h2>
                    <p style="color: var(--color-steel);">${order.orderNumber}</p>
                </div>

                <div class="order-form-section">
                    <h4>Customer Information</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Name:</span>
                        <span>${order.customerName}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Email:</span>
                        <span>${order.customerEmail}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Phone:</span>
                        <span>${order.customerPhone || '-'}</span>
                    </div>
                </div>

                <div class="order-form-section">
                    <h4>Product Details</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Model:</span>
                        <span><strong>${order.productName}</strong></span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Finish:</span>
                        <span>${order.finish}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Shaft:</span>
                        <span>${order.shaftColor}</span>
                    </div>
                    <div class="order-form-specs">
                        <div class="order-form-row">
                            <span class="order-form-label">Length:</span>
                            <span>35"</span>
                        </div>
                        <div class="order-form-row">
                            <span class="order-form-label">Grip:</span>
                            <span>SuperStroke Pistol 2.0</span>
                        </div>
                    </div>
                </div>

                <div class="order-form-section">
                    <h4>Delivery</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Method:</span>
                        <span>${order.deliveryMethod === 'shipping' ? 'Ship to Customer' : 'Local Pickup'}</span>
                    </div>
                    ${order.deliveryMethod === 'shipping' ? `
                        <div class="order-form-row">
                            <span class="order-form-label">Address:</span>
                            <span>${order.shippingAddress}</span>
                        </div>
                    ` : `
                        <div class="order-form-row">
                            <span class="order-form-label">Pickup Date:</span>
                            <span>${order.pickupDate} at ${order.pickupTime}</span>
                        </div>
                    `}
                </div>

                <div class="order-form-section">
                    <h4>Notes</h4>
                    <div class="order-form-notes">${order.notes || 'No special notes'}</div>
                </div>

                <div class="order-form-section">
                    <h4>Payment</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Total:</span>
                        <span><strong>$${order.total.toFixed(2)} CAD</strong></span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Status:</span>
                        <span>${order.paymentStatus}</span>
                    </div>
                </div>
            `;
        }

        function printOrderForm() {
            window.print();
        }

        function exportOrders() {
            if (orders.length === 0) {
                alert('No orders to export');
                return;
            }

            const headers = ['Order #', 'Date', 'Customer', 'Email', 'Product', 'Finish', 'Shaft', 'Delivery', 'Total', 'Status'];
            const rows = orders.map(o => [
                o.orderNumber,
                o.date,
                o.customerName,
                o.customerEmail,
                o.productName,
                o.finish,
                o.shaftColor,
                o.deliveryMethod,
                o.total,
                o.status
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proto-golf-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
    </script>
</body>
</html>
