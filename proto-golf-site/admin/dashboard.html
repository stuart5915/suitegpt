<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Proto Golf</title>
    <link rel="icon" type="image/svg+xml" href="../assets/images/favicon.svg">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-ink: #1a1a1a;
            --color-carbon: #2d2d2d;
            --color-graphite: #404040;
            --color-steel: #6b6b6b;
            --color-silver: #a3a3a3;
            --color-ash: #d4d4d4;
            --color-mist: #e5e5e5;
            --color-bone: #f5f5f5;
            --color-paper: #fafafa;
            --color-success: #22c55e;
            --color-warning: #f59e0b;
            --color-error: #ef4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--color-bone);
            color: var(--color-ink);
            min-height: 100vh;
        }

        /* Login Screen */
        .login-screen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background: var(--color-ink);
        }

        .login-card {
            background: var(--color-paper);
            border-radius: 16px;
            padding: 48px;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }

        .login-logo {
            width: 64px;
            height: 64px;
            background: var(--color-ink);
            color: var(--color-paper);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0 auto 24px;
        }

        .login-card h1 {
            font-size: 1.5rem;
            margin-bottom: 8px;
        }

        .login-card > p {
            color: var(--color-steel);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-label {
            display: block;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 8px;
            font-family: inherit;
            font-size: 1rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--color-ink);
        }

        textarea.form-input {
            resize: vertical;
            min-height: 60px;
        }

        select.form-input {
            cursor: pointer;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 14px 28px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            border: none;
            transition: all 0.2s;
        }

        .btn-primary {
            background: var(--color-ink);
            color: var(--color-paper);
            width: 100%;
        }

        .btn-primary:hover {
            background: var(--color-carbon);
        }

        .btn-secondary {
            background: var(--color-mist);
            color: var(--color-ink);
        }

        .btn-sm {
            padding: 10px 16px;
            font-size: 0.875rem;
        }

        .login-error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        /* Dashboard Layout */
        .dashboard {
            display: none;
        }

        .dashboard.active {
            display: flex;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 240px;
            background: var(--color-ink);
            color: var(--color-paper);
            padding: 24px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 40px;
        }

        .sidebar-logo-icon {
            width: 40px;
            height: 40px;
            background: var(--color-paper);
            color: var(--color-ink);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
        }

        .sidebar-logo-text {
            font-weight: 700;
        }

        .sidebar-nav {
            list-style: none;
        }

        .sidebar-nav li {
            margin-bottom: 4px;
        }

        .sidebar-nav a {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--color-silver);
            text-decoration: none;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .sidebar-nav a:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--color-paper);
        }

        .sidebar-nav a.active {
            background: rgba(255, 255, 255, 0.15);
            color: var(--color-paper);
        }

        .main-content {
            margin-left: 240px;
            padding: 32px;
            min-height: 100vh;
            width: calc(100% - 240px);
        }

        .main-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .main-header h1 {
            font-size: 1.75rem;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--color-paper);
            border: 1px solid var(--color-ash);
            border-radius: 12px;
            padding: 24px;
        }

        .stat-label {
            font-size: 0.875rem;
            color: var(--color-steel);
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
        }

        .stat-change {
            font-size: 0.875rem;
            margin-top: 8px;
        }

        .stat-change.positive { color: var(--color-success); }
        .stat-change.negative { color: var(--color-error); }
        .stat-change.neutral { color: var(--color-steel); }

        /* Sections */
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-card {
            background: var(--color-paper);
            border: 1px solid var(--color-ash);
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-ash);
        }

        .section-title {
            font-size: 1.1rem;
            font-weight: 600;
        }

        /* Tables */
        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 14px 24px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: var(--color-bone);
        }

        .data-table td {
            padding: 16px 24px;
            border-bottom: 1px solid var(--color-mist);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover td {
            background: var(--color-bone);
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-success { background: rgba(34, 197, 94, 0.15); color: var(--color-success); }
        .badge-warning { background: rgba(245, 158, 11, 0.15); color: var(--color-warning); }
        .badge-error { background: rgba(239, 68, 68, 0.15); color: var(--color-error); }
        .badge-neutral { background: var(--color-mist); color: var(--color-steel); }

        .stock-input {
            width: 80px;
            padding: 8px 12px;
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 6px;
            font-family: 'Space Mono', monospace;
            text-align: center;
        }

        .stock-input:focus {
            outline: none;
            border-color: var(--color-ink);
        }

        /* Order Modal */
        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .modal-overlay.active {
            opacity: 1;
            pointer-events: all;
        }

        .modal {
            background: var(--color-paper);
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--color-ash);
        }

        .modal-header h3 {
            font-size: 1.25rem;
        }

        .modal-close {
            width: 36px;
            height: 36px;
            background: var(--color-bone);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.25rem;
        }

        .modal-body {
            padding: 24px;
        }

        .modal-actions {
            padding: 20px 24px;
            border-top: 1px solid var(--color-ash);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* Order Form (Printable) */
        .order-form {
            font-family: 'Space Mono', monospace;
        }

        .order-form-header {
            text-align: center;
            border-bottom: 2px solid var(--color-ink);
            padding-bottom: 16px;
            margin-bottom: 24px;
        }

        .order-form-header h2 {
            font-family: 'Outfit', sans-serif;
            font-size: 1.5rem;
        }

        .order-form-section {
            margin-bottom: 24px;
        }

        .order-form-section h4 {
            font-family: 'Outfit', sans-serif;
            font-size: 0.875rem;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--color-ash);
            padding-bottom: 8px;
            margin-bottom: 12px;
        }

        .order-form-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed var(--color-mist);
        }

        .order-form-row:last-child {
            border-bottom: none;
        }

        .order-form-label {
            color: var(--color-steel);
        }

        .order-form-specs {
            background: var(--color-bone);
            padding: 16px;
            border-radius: 8px;
            margin-top: 12px;
        }

        .order-form-notes {
            background: var(--color-bone);
            padding: 16px;
            min-height: 80px;
            border-radius: 8px;
        }

        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            .modal, .modal * { visibility: visible; }
            .modal {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                max-width: 100%;
                box-shadow: none;
            }
            .modal-header, .modal-actions { display: none !important; }
        }

        @media (max-width: 1024px) {
            .sidebar { display: none; }
            .main-content { margin-left: 0; width: 100%; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
        }

        @media (max-width: 600px) {
            .stats-grid { grid-template-columns: 1fr; }
        }

        /* Setup Banner */
        .setup-banner {
            background: linear-gradient(135deg, var(--color-ink) 0%, var(--color-carbon) 100%);
            color: var(--color-paper);
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .setup-banner h3 {
            margin-bottom: 8px;
        }

        .setup-banner p {
            color: var(--color-silver);
            margin-bottom: 16px;
        }

        .setup-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
        }

        .setup-step {
            background: rgba(255,255,255,0.1);
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .setup-step-icon {
            width: 28px;
            height: 28px;
            background: var(--color-paper);
            color: var(--color-ink);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .setup-step.done .setup-step-icon {
            background: var(--color-success);
            color: white;
        }

        /* Photo Grid */
        .photo-card {
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }

        .photo-card img {
            width: 100%;
            height: 140px;
            object-fit: cover;
            display: block;
        }

        .photo-card-actions {
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 8px;
        }

        .photo-card-actions input {
            width: 50px;
            padding: 4px 6px;
            background: var(--color-paper);
            border: 1px solid var(--color-ash);
            border-radius: 4px;
            font-family: 'Space Mono', monospace;
            text-align: center;
            font-size: 0.8rem;
        }

        .photo-delete-btn {
            background: var(--color-error);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }

        .photo-delete-btn:hover {
            opacity: 0.85;
        }

        /* ===== Site Editor Styles ===== */
        .site-editor-layout {
            display: flex;
            gap: 0;
            height: calc(100vh - 96px);
            margin: -32px;
            margin-top: 0;
        }

        .site-editor-controls {
            width: 360px;
            min-width: 360px;
            background: var(--color-paper);
            border-right: 1px solid var(--color-ash);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .site-editor-controls-header {
            padding: 20px;
            border-bottom: 1px solid var(--color-ash);
        }

        .site-editor-controls-header h3 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .site-editor-controls-header p {
            font-size: 0.85rem;
            color: var(--color-steel);
        }

        .site-editor-page-select {
            padding: 16px 20px;
            border-bottom: 1px solid var(--color-ash);
        }

        .site-editor-page-select label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--color-steel);
            margin-bottom: 8px;
            display: block;
        }

        .site-editor-page-select select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--color-ash);
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--color-bone);
        }

        .site-editor-selected {
            padding: 20px;
            border-bottom: 1px solid var(--color-ash);
        }

        .site-editor-selected-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .site-editor-selected-element {
            background: var(--color-bone);
            border: 1px solid var(--color-ash);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Space Mono', monospace;
            font-size: 0.8rem;
            color: var(--color-graphite);
            max-height: 80px;
            overflow-y: auto;
        }

        .site-editor-selected-none {
            color: var(--color-silver);
            font-style: italic;
        }

        .site-editor-input-area {
            padding: 20px;
            border-bottom: 1px solid var(--color-ash);
        }

        .site-editor-input-area label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }

        .site-editor-voice-btn {
            width: 100%;
            padding: 14px;
            border: 2px dashed var(--color-ash);
            border-radius: 8px;
            background: var(--color-bone);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.9rem;
            color: var(--color-steel);
            transition: all 0.2s;
            margin-bottom: 12px;
        }

        .site-editor-voice-btn:hover {
            border-color: var(--color-ink);
            color: var(--color-ink);
        }

        .site-editor-voice-btn.recording {
            border-color: var(--color-error);
            background: rgba(239, 68, 68, 0.05);
            color: var(--color-error);
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .site-editor-text-input {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--color-ash);
            border-radius: 8px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }

        .site-editor-text-input:focus {
            outline: none;
            border-color: var(--color-ink);
        }

        .site-editor-submit-btn {
            width: 100%;
            margin-top: 12px;
            padding: 14px;
            background: var(--color-ink);
            color: var(--color-paper);
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
        }

        .site-editor-submit-btn:hover {
            background: var(--color-carbon);
        }

        .site-editor-submit-btn:disabled {
            background: var(--color-ash);
            cursor: not-allowed;
        }

        .site-editor-history {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .site-editor-history-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--color-steel);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }

        .site-editor-history-item {
            background: var(--color-bone);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 10px;
            font-size: 0.85rem;
        }

        .site-editor-history-item-time {
            font-size: 0.75rem;
            color: var(--color-silver);
            margin-bottom: 4px;
        }

        .site-editor-history-item-element {
            font-family: 'Space Mono', monospace;
            font-size: 0.7rem;
            color: var(--color-steel);
            margin-bottom: 6px;
            padding: 4px 6px;
            background: var(--color-paper);
            border-radius: 4px;
            display: inline-block;
        }

        .site-editor-history-item-request {
            color: var(--color-ink);
        }

        .site-editor-iframe-container {
            flex: 1;
            background: var(--color-mist);
            position: relative;
            overflow: hidden;
        }

        .site-editor-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: white;
        }

        .site-editor-iframe-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            cursor: crosshair;
        }

        .site-editor-status {
            padding: 8px 12px;
            font-size: 0.8rem;
            text-align: center;
        }

        .site-editor-status.success {
            background: rgba(34, 197, 94, 0.1);
            color: var(--color-success);
        }

        .site-editor-status.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--color-error);
        }
    </style>
</head>
<body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
        <div class="login-card">
            <div class="login-logo">P</div>
            <h1>Proto Golf Admin</h1>
            <p>Enter your password to continue</p>

            <div class="login-error" id="loginError">Invalid password</div>

            <form onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Enter admin password">
                </div>
                <button type="submit" class="btn btn-primary">Login</button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div class="dashboard" id="dashboard">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="sidebar-logo">
                <div class="sidebar-logo-icon">P</div>
                <span class="sidebar-logo-text">Proto Admin</span>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li><a href="#" class="active" onclick="showSection('overview', event)">Overview</a></li>
                    <li><a href="#" onclick="showSection('orders', event)">Orders</a></li>
                    <li><a href="#" onclick="showSection('inventory', event)">Inventory</a></li>
                    <li><a href="#" onclick="showSection('analytics', event)">Analytics</a></li>
                    <li><a href="#" onclick="showSection('products', event)">Products</a></li>
                    <li><a href="#" onclick="showSection('variants', event)">Variants</a></li>
                    <li><a href="#" onclick="showSection('photos', event)">Photos</a></li>
                    <li><a href="#" onclick="showSection('bgremover', event)">BG Remover</a></li>
                    <li><a href="#" onclick="showSection('siteeditor', event)">Edit Site</a></li>
                    <li style="margin-top: 24px; padding-top: 24px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <a href="../index.html" target="_blank">View Site â†—</a>
                    </li>
                    <li><a href="#" onclick="logout()">Logout</a></li>
                </ul>
            </nav>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Overview Section -->
            <div class="content-section active" id="section-overview">
                <div class="main-header">
                    <h1>Dashboard</h1>
                    <span style="color: var(--color-steel);">Welcome back</span>
                </div>

                <!-- Setup Banner -->
                <div class="setup-banner" id="setupBanner">
                    <h3>Complete Your Setup</h3>
                    <p>Connect your services to enable full functionality</p>
                    <div class="setup-steps">
                        <div class="setup-step" id="step-supabase">
                            <div class="setup-step-icon">1</div>
                            <span>Supabase Database</span>
                        </div>
                        <div class="setup-step" id="step-stripe">
                            <div class="setup-step-icon">2</div>
                            <span>Stripe Payments</span>
                        </div>
                        <div class="setup-step" id="step-email">
                            <div class="setup-step-icon">3</div>
                            <span>Email Notifications</span>
                        </div>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Orders Today</div>
                        <div class="stat-value" id="ordersToday">0</div>
                        <div class="stat-change neutral">Demo mode</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Revenue (This Week)</div>
                        <div class="stat-value" id="weeklyRevenue">$0</div>
                        <div class="stat-change neutral">Demo mode</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Pending Orders</div>
                        <div class="stat-value" id="pendingOrders">0</div>
                        <div class="stat-change neutral">Awaiting shipment</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Low Stock Items</div>
                        <div class="stat-value" id="lowStockCount">0</div>
                        <div class="stat-change negative" id="lowStockLabel">Check inventory</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Recent Orders</h3>
                        <button class="btn btn-secondary btn-sm" onclick="showSection('orders', event)">View All</button>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Total</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="recentOrdersTable">
                            <tr>
                                <td colspan="5" style="text-align: center; color: var(--color-steel); padding: 40px;">
                                    No orders yet. Orders will appear here once you connect Supabase.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Orders Section -->
            <div class="content-section" id="section-orders">
                <div class="main-header">
                    <h1>Orders</h1>
                    <button class="btn btn-secondary btn-sm" onclick="exportOrders()">Export CSV</button>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">All Orders</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Order #</th>
                                <th>Date</th>
                                <th>Customer</th>
                                <th>Product</th>
                                <th>Delivery</th>
                                <th>Total</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ordersTable">
                            <tr>
                                <td colspan="8" style="text-align: center; color: var(--color-steel); padding: 40px;">
                                    No orders yet
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Inventory Section -->
            <div class="content-section" id="section-inventory">
                <div class="main-header">
                    <h1>Inventory</h1>
                    <button class="btn btn-primary btn-sm" onclick="saveInventory()">Save Changes</button>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Product Stock</h3>
                        <span style="color: var(--color-steel); font-size: 0.875rem;">Stock is tracked per model, not per variant</span>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Base Price</th>
                                <th>Stock (Blanks)</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable">
                            <!-- Populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Inventory Notes</h3>
                    </div>
                    <div style="padding: 24px; color: var(--color-steel);">
                        <p><strong>Stock = 1:</strong> Product shows as "Sold Out" on the website</p>
                        <p style="margin-top: 8px;"><strong>Stock = 0:</strong> Product is hidden from shop</p>
                        <p style="margin-top: 8px;">Stock count represents unfinished blanks. All variants (finishes, shaft colors) draw from the same stock pool.</p>
                    </div>
                </div>
            </div>

            <!-- Analytics Section -->
            <div class="content-section" id="section-analytics">
                <div class="main-header">
                    <h1>Analytics</h1>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Page Views (7 days)</div>
                        <div class="stat-value" id="pageViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Product Views</div>
                        <div class="stat-value" id="productViews">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Add to Cart</div>
                        <div class="stat-value" id="addToCarts">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Checkouts</div>
                        <div class="stat-value" id="checkouts">-</div>
                    </div>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Conversion Funnel</h3>
                    </div>
                    <div style="padding: 40px; text-align: center; color: var(--color-steel);">
                        <p>Analytics data will appear here once you connect Supabase.</p>
                        <p style="margin-top: 8px;">Track: page views â†’ product views â†’ add to cart â†’ checkout started â†’ purchase completed</p>
                    </div>
                </div>
            </div>
            <!-- Products Section -->
            <div class="content-section" id="section-products">
                <div class="main-header">
                    <h1>Products</h1>
                    <button class="btn btn-primary btn-sm" onclick="openProductModal()">Add Product</button>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">All Products</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>ID/Slug</th>
                                <th>Base Price</th>
                                <th>Status</th>
                                <th>Badge</th>
                                <th>Sort</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="productsTable">
                            <tr>
                                <td colspan="7" style="text-align: center; color: var(--color-steel); padding: 40px;">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Variants Section -->
            <div class="content-section" id="section-variants">
                <div class="main-header">
                    <h1>Variants</h1>
                    <button class="btn btn-primary btn-sm" onclick="openVariantModal()">Add Variant</button>
                </div>

                <div style="margin-bottom: 24px;">
                    <label class="form-label">Select Product</label>
                    <select class="form-input" id="variantProductSelect" onchange="loadVariantsForProduct()" style="max-width: 300px;">
                    </select>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Product Variants</h3>
                    </div>
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Finish</th>
                                <th>Shaft</th>
                                <th>Finish Addon</th>
                                <th>Shaft Addon</th>
                                <th>Hosel</th>
                                <th>Hosel Addon</th>
                                <th>Sort Order</th>
                                <th>Default</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="variantsTable">
                            <tr>
                                <td colspan="6" style="text-align: center; color: var(--color-steel); padding: 40px;">Select a product above</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Photos Section -->
            <div class="content-section" id="section-photos">
                <div class="main-header">
                    <h1>Product Photos</h1>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Manage Images</h3>
                    </div>
                    <div style="padding: 24px;">
                        <div style="display: flex; gap: 16px; margin-bottom: 24px; flex-wrap: wrap;">
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label class="form-label">Product</label>
                                <select class="form-input" id="photoProduct" onchange="onPhotoProductChange()">
                                    <!-- Populated from DB -->
                                </select>
                            </div>
                            <div class="form-group" style="margin-bottom: 0; flex: 1; min-width: 200px;">
                                <label class="form-label">Variant</label>
                                <select class="form-input" id="photoVariant" onchange="loadProductImages()">
                                </select>
                            </div>
                        </div>

                        <div style="margin-bottom: 24px;">
                            <label class="form-label">Upload New Image</label>
                            <input type="file" accept="image/*" id="photoFileInput" style="display: none;" onchange="updateFileLabel()" multiple>
                            <div style="display: flex; gap: 12px; align-items: center;">
                                <button class="btn btn-secondary btn-sm" onclick="document.getElementById('photoFileInput').click()" style="white-space: nowrap;" id="chooseFileBtn">Choose File</button>
                                <span style="color: var(--color-steel); font-size: 0.875rem; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" id="fileLabel">No file selected</span>
                                <button class="btn btn-sm" style="background: var(--color-ink); color: var(--color-paper); white-space: nowrap; width: auto;" onclick="uploadPhoto()" id="uploadPhotoBtn">Upload</button>
                            </div>
                        </div>

                        <div id="photoGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px;">
                            <div style="text-align: center; color: var(--color-steel); padding: 40px; grid-column: 1 / -1;">
                                Select a product and variant to view images
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- BG Remover Section -->
            <div class="content-section" id="section-bgremover">
                <div class="main-header">
                    <h1>Background Remover</h1>
                </div>

                <div class="section-card">
                    <div class="section-header">
                        <h3 class="section-title">Remove & Replace Backgrounds</h3>
                        <button class="btn btn-secondary btn-sm" id="bgResetBtn" style="display:none;" onclick="bgReset()">Start Over</button>
                    </div>
                    <div style="padding: 24px; max-width: 600px;">
                        <!-- Step 1: Background color -->
                        <div style="margin-bottom: 24px;">
                            <label class="form-label">Background Color</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 8px; align-items: center;" id="bgSwatches">
                                <div class="bg-swatch active" data-bg="#ffffff" style="background:#ffffff; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); cursor:pointer;" title="White"></div>
                                <div class="bg-swatch" data-bg="#111111" style="background:#111111; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); cursor:pointer;" title="Black"></div>
                                <div class="bg-swatch" data-bg="transparent" style="background:repeating-conic-gradient(#d4d4d4 0% 25%,#fff 0% 50%) 0 0/8px 8px; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); cursor:pointer;" title="Transparent"></div>
                                <div class="bg-swatch" data-bg="#d4d4d8" style="background:#d4d4d8; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); cursor:pointer;" title="Light Gray"></div>
                                <div class="bg-swatch" data-bg="#fef3c7" style="background:#fef3c7; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); cursor:pointer;" title="Warm Cream"></div>
                                <div style="position:relative; width:40px; height:40px; border-radius:8px; border:2px solid var(--color-ash); overflow:hidden; cursor:pointer;" title="Custom">
                                    <input type="color" id="bgCustomColor" value="#6d28d9" style="position:absolute; inset:-4px; width:calc(100% + 8px); height:calc(100% + 8px); border:none; cursor:pointer;">
                                </div>
                            </div>
                        </div>

                        <!-- Step 2: Upload -->
                        <div style="margin-bottom: 24px;">
                            <label class="form-label">Upload Photos</label>
                            <input type="file" accept="image/jpeg,image/png,image/webp" multiple id="bgFileInput" style="display:none;" onchange="bgHandleFiles(this.files)">
                            <div id="bgUploadArea" style="border: 2px dashed var(--color-ash); border-radius: 12px; padding: 32px 20px; text-align: center; cursor: pointer; transition: all 0.2s;" onclick="document.getElementById('bgFileInput').click()">
                                <div style="font-size: 24px; margin-bottom: 8px; opacity: 0.5;">+</div>
                                <div style="font-size: 14px; font-weight: 600; color: var(--color-steel);">Drop photos here or click to upload</div>
                                <div style="font-size: 12px; color: var(--color-silver); margin-top: 4px;">JPG, PNG, or WebP â€” select multiple for batch</div>
                                <div style="font-size: 13px; font-weight: 600; color: var(--color-ink); margin-top: 8px;" id="bgFileCount"></div>
                            </div>
                        </div>

                        <!-- Process button -->
                        <button class="btn btn-primary" style="width: 100%;" id="bgProcessBtn" disabled onclick="bgProcess()">Remove Backgrounds</button>

                        <!-- Progress -->
                        <div id="bgProgress" style="display: none; margin-top: 20px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                <span style="font-size: 13px; font-weight: 600;" id="bgProgressLabel">Processing...</span>
                            </div>
                            <div style="height: 6px; background: var(--color-mist); border-radius: 3px; overflow: hidden;">
                                <div id="bgProgressBar" style="height: 100%; width: 0%; background: var(--color-ink); border-radius: 3px; transition: width 0.3s;"></div>
                            </div>
                        </div>

                        <!-- Results -->
                        <div id="bgResults" style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;"></div>

                        <!-- Download All -->
                        <div id="bgBulkActions" style="display: none; margin-top: 16px;">
                            <button class="btn btn-primary" style="width: 100%;" id="bgDownloadAllBtn" onclick="bgDownloadAll()">Download All as ZIP</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Site Editor Section -->
            <div class="content-section" id="section-siteeditor">
                <div class="main-header">
                    <h1>Edit Site</h1>
                    <p style="color: var(--color-steel); font-size: 0.9rem;">Click any element on the site preview to select it, then describe what you want changed.</p>
                </div>

                <div class="site-editor-layout">
                    <!-- Controls Panel -->
                    <div class="site-editor-controls">
                        <div class="site-editor-controls-header">
                            <h3>Request a Change</h3>
                            <p>Click an element on the right, then describe your change below.</p>
                        </div>

                        <div class="site-editor-page-select">
                            <label>Page to Edit</label>
                            <select id="siteEditorPageSelect" onchange="loadSiteEditorPage()">
                                <optgroup label="Main Pages">
                                    <option value="../index.html">Home</option>
                                    <option value="../shop.html">Shop</option>
                                    <option value="../about.html">About</option>
                                    <option value="../contact.html">Contact</option>
                                    <option value="../faq.html">FAQ</option>
                                    <option value="../limited.html">Limited Editions</option>
                                    <option value="../checkout.html">Checkout</option>
                                </optgroup>
                                <optgroup label="Product Pages">
                                    <option value="../products/rough-mill.html">Rough Mill</option>
                                    <option value="../products/centre-blade.html">Centre Blade</option>
                                    <option value="../products/long-neck-blade.html">Long Neck Blade</option>
                                </optgroup>
                            </select>
                        </div>

                        <div class="site-editor-selected">
                            <div class="site-editor-selected-label">Selected Element</div>
                            <div class="site-editor-selected-element" id="siteEditorSelectedEl">
                                <span class="site-editor-selected-none">Click an element on the site preview â†’</span>
                            </div>
                        </div>

                        <div class="site-editor-input-area">
                            <label>What would you like changed?</label>
                            <button class="site-editor-voice-btn" id="siteEditorVoiceBtn" onclick="toggleSiteEditorVoice()">
                                <span id="siteEditorVoiceIcon">ðŸŽ¤</span>
                                <span id="siteEditorVoiceText">Click to speak</span>
                            </button>
                            <textarea class="site-editor-text-input" id="siteEditorTextInput" placeholder="Or type your change request here..."></textarea>
                            <button class="site-editor-submit-btn" id="siteEditorSubmitBtn" onclick="applySiteEditorChange()">Apply Change</button>
                            <div class="site-editor-status" id="siteEditorStatus" style="display: none;"></div>
                        </div>

                        <div class="site-editor-save-area" id="siteEditorSaveArea" style="display: none; padding: 16px 20px; border-bottom: 1px solid var(--color-ash); background: rgba(34, 197, 94, 0.05);">
                            <p style="font-size: 0.85rem; color: var(--color-success); margin-bottom: 12px;">âœ“ Preview updated! Like this change?</p>
                            <button class="btn btn-primary btn-sm" style="width: 100%;" onclick="saveSiteEditorChange()">Save & Publish</button>
                            <button class="btn btn-secondary btn-sm" style="width: 100%; margin-top: 8px;" onclick="revertSiteEditorChange()">Revert</button>
                        </div>

                        <div class="site-editor-history">
                            <div class="site-editor-history-label">Recent Requests</div>
                            <div id="siteEditorHistoryList">
                                <p style="color: var(--color-silver); font-size: 0.85rem;">No requests yet.</p>
                            </div>
                        </div>

                        <div class="site-editor-contact" style="margin-top: 24px; padding-top: 20px; border-top: 1px solid var(--color-mist);">
                            <p style="font-size: 0.85rem; color: var(--color-steel); margin-bottom: 12px;">Need a bigger change? New page, restructure, or something complex?</p>
                            <button class="btn btn-secondary btn-sm" style="width: 100%;" onclick="contactStu()">ðŸ’¬ Contact Stu</button>
                        </div>
                    </div>

                    <!-- Site Preview -->
                    <div class="site-editor-iframe-container">
                        <iframe id="siteEditorIframe" class="site-editor-iframe" src="../index.html"></iframe>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Order Detail Modal -->
    <div class="modal-overlay" id="orderModal">
        <div class="modal">
            <div class="modal-header">
                <h3>Order Details</h3>
                <button class="modal-close" onclick="closeOrderModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="order-form" id="orderFormContent">
                    <!-- Populated by JS -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeOrderModal()">Close</button>
                <button class="btn btn-primary" onclick="printOrderForm()">Print Order Form</button>
            </div>
        </div>
    </div>

    <!-- Product Modal -->
    <div class="modal-overlay" id="productModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="productModalTitle">Add Product</h3>
                <button class="modal-close" onclick="closeProductModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="productEditId">
                <div class="form-group">
                    <label class="form-label">Name</label>
                    <input type="text" class="form-input" id="productName" placeholder="e.g. Rough Mill">
                </div>
                <div class="form-group">
                    <label class="form-label">ID / Slug</label>
                    <input type="text" class="form-input" id="productSlug" placeholder="e.g. rough-mill">
                </div>
                <div class="form-group">
                    <label class="form-label">Base Price ($)</label>
                    <input type="number" class="form-input" id="productBasePrice" placeholder="399" step="0.01">
                </div>
                <div class="form-group">
                    <label class="form-label">Material</label>
                    <input type="text" class="form-input" id="productMaterial" placeholder="e.g. 304 Stainless Steel">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input" id="productDescription" rows="3" placeholder="Full product description"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Short Description</label>
                    <input type="text" class="form-input" id="productShortDesc" placeholder="Brief tagline for shop cards">
                </div>
                <div class="form-group">
                    <label class="form-label">Icon (single character)</label>
                    <input type="text" class="form-input" id="productIcon" placeholder="R" maxlength="2">
                </div>
                <div class="form-group">
                    <label class="form-label">Badge</label>
                    <input type="text" class="form-input" id="productBadge" placeholder="e.g. In Stock, New, Coming Soon">
                </div>
                <div class="form-group">
                    <label class="form-label">Status</label>
                    <select class="form-input" id="productStatus">
                        <option value="active">Active</option>
                        <option value="coming_soon">Coming Soon</option>
                        <option value="discontinued">Discontinued</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Sort Order</label>
                    <input type="number" class="form-input" id="productSortOrder" placeholder="1" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Hero Image (shown on shop cards)</label>
                    <div id="heroImagePreview" style="margin-bottom: 8px;"></div>
                    <input type="file" accept="image/*" id="heroImageFile" style="display: none;" onchange="previewHeroImage()">
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <button class="btn btn-secondary btn-sm" type="button" onclick="document.getElementById('heroImageFile').click()">Choose Image</button>
                        <span style="color: var(--color-steel); font-size: 0.875rem;" id="heroImageLabel">No file selected</span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Specs (JSON key/value pairs)</label>
                    <div id="specsContainer"></div>
                    <button class="btn btn-secondary btn-sm" onclick="addSpecRow()" style="margin-top: 8px;">+ Add Spec</button>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeProductModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
            </div>
        </div>
    </div>

    <!-- Variant Modal -->
    <div class="modal-overlay" id="variantModal">
        <div class="modal">
            <div class="modal-header">
                <h3 id="variantModalTitle">Add Variant</h3>
                <button class="modal-close" onclick="closeVariantModal()">Ã—</button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="variantEditId">
                <div class="form-group">
                    <label class="form-label">Finish Name</label>
                    <input type="text" class="form-input" id="variantFinish" placeholder="e.g. Raw, Brushed, Black DLC">
                </div>
                <div class="form-group">
                    <label class="form-label">Shaft Color</label>
                    <input type="text" class="form-input" id="variantShaft" placeholder="e.g. Chrome, Black">
                </div>
                <div class="form-group">
                    <label class="form-label">Finish Price Addon ($)</label>
                    <input type="number" class="form-input" id="variantPriceAddon" placeholder="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Shaft Price Addon ($)</label>
                    <input type="number" class="form-input" id="variantShaftPriceAddon" placeholder="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Hosel Type</label>
                    <select class="form-input" id="variantHoselType">
                        <option value="">None</option>
                        <option value="Brass">Brass</option>
                        <option value="Stainless">Stainless</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Hosel Finish</label>
                    <select class="form-input" id="variantHoselFinish">
                        <option value="">None</option>
                        <option value="Blasted">Blasted</option>
                        <option value="Black Oxide">Black Oxide</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Hosel Price Addon ($)</label>
                    <input type="number" class="form-input" id="variantHoselPriceAddon" placeholder="0" step="0.01" value="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Sort Order</label>
                    <input type="number" class="form-input" id="variantSortOrder" placeholder="1" value="0">
                </div>
                <div class="form-group" style="display: flex; align-items: center; gap: 8px;">
                    <input type="checkbox" id="variantIsDefault">
                    <label class="form-label" for="variantIsDefault" style="margin: 0;">Default variant (loads first)</label>
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeVariantModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveVariant()">Save Variant</button>
            </div>
        </div>
    </div>

    <script>
        // Supabase config
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // Data from Supabase
        let inventory = [];
        let orders = [];

        // Supabase API helper
        async function supabaseQuery(table, method = 'GET', body = null, query = '') {
            const url = `${SUPABASE_URL}/rest/v1/${table}${query}`;
            const options = {
                method,
                headers: {
                    'apikey': SUPABASE_KEY,
                    'Authorization': `Bearer ${SUPABASE_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': method === 'POST' ? 'return=representation' : 'return=minimal'
                }
            };
            if (body) options.body = JSON.stringify(body);

            const response = await fetch(url, options);
            if (method === 'GET') return response.json();
            return response.ok;
        }

        async function handleLogin(e) {
            e.preventDefault();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = e.target.querySelector('button');

            loginBtn.textContent = 'Checking...';
            loginBtn.disabled = true;

            try {
                const response = await fetch('/api/proto-admin-auth', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                if (response.ok) {
                    const data = await response.json();
                    document.getElementById('loginScreen').style.display = 'none';
                    document.getElementById('dashboard').classList.add('active');
                    sessionStorage.setItem('proto_admin_auth', data.token);
                    initDashboard();
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch (error) {
                // Fallback for local development
                console.warn('Auth API not available, using fallback');
                document.getElementById('loginError').style.display = 'block';
            }

            loginBtn.textContent = 'Login';
            loginBtn.disabled = false;
        }

        function logout() {
            sessionStorage.removeItem('proto_admin_auth');
            document.getElementById('dashboard').classList.remove('active');
            document.getElementById('loginScreen').style.display = 'flex';
            document.getElementById('loginPassword').value = '';
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('proto_admin_auth') === 'true') {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('dashboard').classList.add('active');
                initDashboard();
            }
        });

        async function initDashboard() {
            // Hide setup banner once connected
            document.getElementById('setupBanner').style.display = 'none';

            // Fetch data from Supabase
            await Promise.all([fetchInventory(), fetchOrders(), fetchProducts()]);
            renderInventory();
            renderOrders();
            renderProductsTable();
            populateProductDropdowns();
            updateStats();
        }

        async function fetchInventory() {
            try {
                const data = await supabaseQuery('proto_golf_products', 'GET', null, '?order=name');
                inventory = data.map(p => ({
                    id: p.id,
                    name: p.name,
                    basePrice: parseFloat(p.base_price),
                    stock: p.stock,
                    status: p.status
                }));
                console.log('Inventory loaded:', inventory);
            } catch (e) {
                console.error('Failed to fetch inventory:', e);
            }
        }

        async function fetchOrders() {
            try {
                const data = await supabaseQuery('proto_golf_orders', 'GET', null, '?order=created_at.desc&limit=50');
                orders = data.map(o => ({
                    id: o.id,
                    orderNumber: o.order_number,
                    date: new Date(o.created_at).toLocaleDateString(),
                    customerName: o.customer_name,
                    customerEmail: o.customer_email,
                    customerPhone: o.customer_phone,
                    productId: o.product_id,
                    productName: o.product_name,
                    finish: o.finish,
                    shaftColor: o.shaft_color,
                    deliveryMethod: o.delivery_method,
                    shippingAddress: o.shipping_address ?
                        `${o.shipping_address.line1}, ${o.shipping_address.city}, ${o.shipping_address.state}` : null,
                    pickupDate: o.pickup_date,
                    pickupTime: o.pickup_time,
                    total: parseFloat(o.total),
                    status: o.status,
                    paymentStatus: o.payment_status,
                    notes: o.notes
                }));
                console.log('Orders loaded:', orders);
            } catch (e) {
                console.error('Failed to fetch orders:', e);
            }
        }

        function showSection(sectionId, event) {
            if (event) event.preventDefault();

            document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
            document.getElementById('section-' + sectionId).classList.add('active');

            document.querySelectorAll('.sidebar-nav a').forEach(a => a.classList.remove('active'));
            if (event && event.target) event.target.classList.add('active');
        }

        function renderInventory() {
            const table = document.getElementById('inventoryTable');
            table.innerHTML = inventory.map(item => {
                let statusBadge = '';
                if (item.status === 'coming_soon') {
                    statusBadge = '<span class="badge badge-neutral">Coming Soon</span>';
                } else if (item.stock <= 1) {
                    statusBadge = '<span class="badge badge-error">Sold Out</span>';
                } else if (item.stock <= 5) {
                    statusBadge = '<span class="badge badge-warning">Low Stock</span>';
                } else {
                    statusBadge = '<span class="badge badge-success">In Stock</span>';
                }

                return `
                    <tr>
                        <td><strong>${item.name}</strong></td>
                        <td>$${item.basePrice}</td>
                        <td>
                            <input type="number" class="stock-input" value="${item.stock}"
                                   onchange="updateStock('${item.id}', this.value)" min="0">
                        </td>
                        <td>${statusBadge}</td>
                    </tr>
                `;
            }).join('');
        }

        function updateStock(id, value) {
            const item = inventory.find(i => i.id === id);
            if (item) {
                item.stock = parseInt(value) || 0;
                item.changed = true;
                renderInventory();
                updateStats();
            }
        }

        async function saveInventory() {
            const changedItems = inventory.filter(i => i.changed);
            if (changedItems.length === 0) {
                alert('No changes to save');
                return;
            }

            let saved = 0;
            for (const item of changedItems) {
                try {
                    await supabaseQuery('proto_golf_products', 'PATCH',
                        { stock: item.stock },
                        `?id=eq.${item.id}`
                    );
                    item.changed = false;
                    saved++;
                } catch (e) {
                    console.error('Failed to save:', item.id, e);
                }
            }

            alert(`Saved ${saved} item(s) to database!`);
            renderInventory();
        }

        function renderOrders() {
            const table = document.getElementById('ordersTable');
            const recentTable = document.getElementById('recentOrdersTable');

            if (orders.length === 0) {
                const emptyRow = `<tr><td colspan="8" style="text-align: center; color: var(--color-steel); padding: 40px;">No orders yet</td></tr>`;
                table.innerHTML = emptyRow;
                recentTable.innerHTML = emptyRow.replace('8', '5');
                return;
            }

            // Full orders table
            table.innerHTML = orders.map(o => {
                const statusBadge = o.status === 'pending' ? 'badge-warning' :
                    o.status === 'shipped' || o.status === 'completed' ? 'badge-success' : 'badge-neutral';

                return `
                    <tr>
                        <td><strong>${o.orderNumber}</strong></td>
                        <td>${o.date}</td>
                        <td>${o.customerName}<br><small style="color:var(--color-steel)">${o.customerEmail}</small></td>
                        <td>${o.productName}<br><small style="color:var(--color-steel)">${o.finish}</small></td>
                        <td>${o.deliveryMethod === 'shipping' ? 'Ship' : 'Pickup'}</td>
                        <td><strong>$${o.total.toFixed(2)}</strong></td>
                        <td><span class="badge ${statusBadge}">${o.status}</span></td>
                        <td><button class="btn btn-secondary btn-sm" onclick="openOrderModal('${o.id}')">View</button></td>
                    </tr>
                `;
            }).join('');

            // Recent orders (first 5)
            recentTable.innerHTML = orders.slice(0, 5).map(o => {
                const statusBadge = o.status === 'pending' ? 'badge-warning' :
                    o.status === 'shipped' || o.status === 'completed' ? 'badge-success' : 'badge-neutral';

                return `
                    <tr>
                        <td><strong>${o.orderNumber}</strong></td>
                        <td>${o.customerName}</td>
                        <td>${o.productName}</td>
                        <td><strong>$${o.total.toFixed(2)}</strong></td>
                        <td><span class="badge ${statusBadge}">${o.status}</span></td>
                    </tr>
                `;
            }).join('');

            // Update stats
            document.getElementById('ordersToday').textContent = orders.filter(o =>
                o.date === new Date().toLocaleDateString()
            ).length;

            document.getElementById('pendingOrders').textContent = orders.filter(o =>
                o.status === 'pending'
            ).length;

            const weekRevenue = orders.filter(o => {
                const orderDate = new Date(o.date);
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                return orderDate >= weekAgo && o.paymentStatus === 'paid';
            }).reduce((sum, o) => sum + o.total, 0);

            document.getElementById('weeklyRevenue').textContent = '$' + weekRevenue.toFixed(0);
        }

        function updateStats() {
            const lowStock = inventory.filter(i => i.stock > 0 && i.stock <= 5).length;
            document.getElementById('lowStockCount').textContent = lowStock;

            if (lowStock > 0) {
                document.getElementById('lowStockLabel').textContent = 'Restock needed';
                document.getElementById('lowStockLabel').className = 'stat-change negative';
            } else {
                document.getElementById('lowStockLabel').textContent = 'All good';
                document.getElementById('lowStockLabel').className = 'stat-change positive';
            }
        }

        function openOrderModal(orderId) {
            const order = orders.find(o => o.id === orderId);
            if (!order) return;

            const content = document.getElementById('orderFormContent');
            content.innerHTML = generateOrderForm(order);

            document.getElementById('orderModal').classList.add('active');
        }

        function closeOrderModal() {
            document.getElementById('orderModal').classList.remove('active');
        }

        function generateOrderForm(order) {
            return `
                <div class="order-form-header">
                    <h2>PROTO GOLF ORDER FORM</h2>
                    <p style="color: var(--color-steel);">${order.orderNumber}</p>
                </div>

                <div class="order-form-section">
                    <h4>Customer Information</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Name:</span>
                        <span>${order.customerName}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Email:</span>
                        <span>${order.customerEmail}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Phone:</span>
                        <span>${order.customerPhone || '-'}</span>
                    </div>
                </div>

                <div class="order-form-section">
                    <h4>Product Details</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Model:</span>
                        <span><strong>${order.productName}</strong></span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Finish:</span>
                        <span>${order.finish}</span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Shaft:</span>
                        <span>${order.shaftColor}</span>
                    </div>
                    <div class="order-form-specs">
                        <div class="order-form-row">
                            <span class="order-form-label">Length:</span>
                            <span>35"</span>
                        </div>
                        <div class="order-form-row">
                            <span class="order-form-label">Grip:</span>
                            <span>SuperStroke Pistol 2.0</span>
                        </div>
                    </div>
                </div>

                <div class="order-form-section">
                    <h4>Delivery</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Method:</span>
                        <span>${order.deliveryMethod === 'shipping' ? 'Ship to Customer' : 'Local Pickup'}</span>
                    </div>
                    ${order.deliveryMethod === 'shipping' ? `
                        <div class="order-form-row">
                            <span class="order-form-label">Address:</span>
                            <span>${order.shippingAddress}</span>
                        </div>
                    ` : `
                        <div class="order-form-row">
                            <span class="order-form-label">Pickup Date:</span>
                            <span>${order.pickupDate} at ${order.pickupTime}</span>
                        </div>
                    `}
                </div>

                <div class="order-form-section">
                    <h4>Notes</h4>
                    <div class="order-form-notes">${order.notes || 'No special notes'}</div>
                </div>

                <div class="order-form-section">
                    <h4>Payment</h4>
                    <div class="order-form-row">
                        <span class="order-form-label">Total:</span>
                        <span><strong>$${order.total.toFixed(2)} CAD</strong></span>
                    </div>
                    <div class="order-form-row">
                        <span class="order-form-label">Status:</span>
                        <span>${order.paymentStatus}</span>
                    </div>
                </div>
            `;
        }

        function printOrderForm() {
            window.print();
        }

        // ============================================
        // PRODUCTS MANAGEMENT
        // ============================================
        let allProducts = [];
        let allVariants = [];

        async function fetchProducts() {
            try {
                allProducts = await supabaseQuery('proto_golf_products', 'GET', null, '?order=sort_order,name');
            } catch (e) {
                console.error('Failed to fetch products:', e);
                allProducts = [];
            }
        }

        function renderProductsTable() {
            const table = document.getElementById('productsTable');
            if (!allProducts || allProducts.length === 0) {
                table.innerHTML = '<tr><td colspan="7" style="text-align: center; color: var(--color-steel); padding: 40px;">No products</td></tr>';
                return;
            }
            table.innerHTML = allProducts.map(p => {
                const statusBadge = p.status === 'active' ? 'badge-success' :
                    p.status === 'coming_soon' ? 'badge-neutral' : 'badge-error';
                return `
                    <tr>
                        <td><strong>${p.name}</strong></td>
                        <td style="font-family: 'Space Mono', monospace; font-size: 0.85rem;">${p.id}</td>
                        <td>$${parseFloat(p.base_price).toFixed(0)}</td>
                        <td><span class="badge ${statusBadge}">${p.status}</span></td>
                        <td>${p.badge || '-'}</td>
                        <td>${p.sort_order || 0}</td>
                        <td>
                            <button class="btn btn-secondary btn-sm" onclick="editProduct('${p.id}')">Edit</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openProductModal(productId) {
            document.getElementById('productEditId').value = '';
            document.getElementById('productName').value = '';
            document.getElementById('productSlug').value = '';
            document.getElementById('productBasePrice').value = '';
            document.getElementById('productMaterial').value = '';
            document.getElementById('productDescription').value = '';
            document.getElementById('productShortDesc').value = '';
            document.getElementById('productIcon').value = '';
            document.getElementById('productBadge').value = '';
            document.getElementById('productStatus').value = 'active';
            document.getElementById('productSortOrder').value = '0';
            document.getElementById('specsContainer').innerHTML = '';
            document.getElementById('productModalTitle').textContent = 'Add Product';

            // Add a few empty spec rows
            addSpecRow(); addSpecRow(); addSpecRow();

            document.getElementById('productModal').classList.add('active');
        }

        function editProduct(productId) {
            const p = allProducts.find(x => x.id === productId);
            if (!p) return;

            document.getElementById('productEditId').value = p.id;
            document.getElementById('productName').value = p.name || '';
            document.getElementById('productSlug').value = p.id;
            document.getElementById('productSlug').disabled = true;
            document.getElementById('productBasePrice').value = parseFloat(p.base_price) || '';
            document.getElementById('productMaterial').value = p.material || '';
            document.getElementById('productDescription').value = p.description || '';
            document.getElementById('productShortDesc').value = p.short_description || '';
            document.getElementById('productIcon').value = p.icon || '';
            document.getElementById('productBadge').value = p.badge || '';
            document.getElementById('productStatus').value = p.status || 'active';
            document.getElementById('productSortOrder').value = p.sort_order || 0;
            document.getElementById('productModalTitle').textContent = 'Edit Product';

            // Show current hero image
            const preview = document.getElementById('heroImagePreview');
            const heroLabel = document.getElementById('heroImageLabel');
            document.getElementById('heroImageFile').value = '';
            if (p.hero_image) {
                preview.innerHTML = `<img src="../${p.hero_image}" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--color-ash);">`;
                heroLabel.textContent = 'Current: ' + p.hero_image.split('/').pop();
            } else {
                preview.innerHTML = '';
                heroLabel.textContent = 'No image set';
            }

            // Populate specs
            const container = document.getElementById('specsContainer');
            container.innerHTML = '';
            const specs = p.specs || {};
            Object.entries(specs).forEach(([key, val]) => addSpecRow(key, val));
            if (Object.keys(specs).length === 0) { addSpecRow(); addSpecRow(); }

            document.getElementById('productModal').classList.add('active');
        }

        function previewHeroImage() {
            const input = document.getElementById('heroImageFile');
            const preview = document.getElementById('heroImagePreview');
            const label = document.getElementById('heroImageLabel');
            if (input.files && input.files[0]) {
                label.textContent = input.files[0].name;
                const url = URL.createObjectURL(input.files[0]);
                preview.innerHTML = `<img src="${url}" style="max-width: 200px; max-height: 120px; border-radius: 8px; border: 1px solid var(--color-ash);">`;
            }
        }

        function closeProductModal() {
            document.getElementById('productModal').classList.remove('active');
            document.getElementById('productSlug').disabled = false;
            document.getElementById('heroImageFile').value = '';
            document.getElementById('heroImagePreview').innerHTML = '';
            document.getElementById('heroImageLabel').textContent = 'No file selected';
        }

        function addSpecRow(key, value) {
            const container = document.getElementById('specsContainer');
            const row = document.createElement('div');
            row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 8px;';
            row.innerHTML = `
                <input type="text" class="form-input spec-key" placeholder="Label (e.g. headWeight)" value="${key || ''}" style="flex:1;">
                <input type="text" class="form-input spec-val" placeholder="Value (e.g. 370g)" value="${value || ''}" style="flex:1;">
                <button class="btn btn-secondary btn-sm" onclick="this.parentElement.remove()" style="padding:8px 12px;">X</button>
            `;
            container.appendChild(row);
        }

        async function saveProduct() {
            const editId = document.getElementById('productEditId').value;
            const slug = document.getElementById('productSlug').value.trim();
            const name = document.getElementById('productName').value.trim();
            const basePrice = parseFloat(document.getElementById('productBasePrice').value);

            if (!name || !slug || isNaN(basePrice)) {
                alert('Name, slug, and base price are required');
                return;
            }

            // Collect specs
            const specs = {};
            document.querySelectorAll('#specsContainer > div').forEach(row => {
                const key = row.querySelector('.spec-key').value.trim();
                const val = row.querySelector('.spec-val').value.trim();
                if (key && val) specs[key] = val;
            });

            const body = {
                name,
                base_price: basePrice,
                material: document.getElementById('productMaterial').value.trim() || null,
                description: document.getElementById('productDescription').value.trim() || null,
                short_description: document.getElementById('productShortDesc').value.trim() || null,
                icon: document.getElementById('productIcon').value.trim() || null,
                badge: document.getElementById('productBadge').value.trim() || null,
                status: document.getElementById('productStatus').value,
                sort_order: parseInt(document.getElementById('productSortOrder').value) || 0,
                specs
            };

            // Upload hero image if a new one was selected
            const heroFile = document.getElementById('heroImageFile').files[0];
            if (heroFile) {
                try {
                    const ext = heroFile.name.split('.').pop() || 'jpg';
                    const storagePath = `heroes/${slug}.${ext}`;
                    const uploadResp = await fetch(`${SUPABASE_URL}/storage/v1/object/proto-golf-images/${storagePath}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': heroFile.type || 'image/jpeg',
                            'x-upsert': 'true'
                        },
                        body: heroFile
                    });
                    if (uploadResp.ok) {
                        body.hero_image = `${SUPABASE_URL}/storage/v1/object/public/proto-golf-images/${storagePath}`;
                    } else {
                        console.error('Hero upload failed:', await uploadResp.text());
                    }
                } catch (e) {
                    console.error('Hero upload error:', e);
                }
            }

            try {
                if (editId) {
                    await supabaseQuery('proto_golf_products', 'PATCH', body, `?id=eq.${encodeURIComponent(editId)}`);
                } else {
                    body.id = slug;
                    body.stock = 0;
                    await supabaseQuery('proto_golf_products', 'POST', body);
                }

                closeProductModal();
                await fetchProducts();
                renderProductsTable();
                populateProductDropdowns();
                alert('Product saved!');
            } catch (e) {
                console.error('Save product error:', e);
                alert('Failed to save product: ' + e.message);
            }
        }

        // ============================================
        // VARIANTS MANAGEMENT
        // ============================================
        let currentVariantProductId = null;
        let currentVariants = [];

        function populateProductDropdowns() {
            // Variant product selector
            const variantSelect = document.getElementById('variantProductSelect');
            if (variantSelect) {
                variantSelect.innerHTML = allProducts.map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
                if (allProducts.length > 0) {
                    currentVariantProductId = allProducts[0].id;
                    loadVariantsForProduct();
                }
            }

            // Photo product selector
            const photoSelect = document.getElementById('photoProduct');
            if (photoSelect) {
                photoSelect.innerHTML = allProducts.map(p =>
                    `<option value="${p.id}">${p.name}</option>`
                ).join('');
            }
        }

        async function loadVariantsForProduct() {
            const productId = document.getElementById('variantProductSelect').value;
            currentVariantProductId = productId;
            if (!productId) return;

            try {
                currentVariants = await supabaseQuery('proto_golf_variants', 'GET', null,
                    `?product_id=eq.${encodeURIComponent(productId)}&order=sort_order`);
                renderVariantsTable();
            } catch (e) {
                console.error('Failed to load variants:', e);
            }
        }

        function renderVariantsTable() {
            const table = document.getElementById('variantsTable');
            if (!currentVariants || currentVariants.length === 0) {
                table.innerHTML = '<tr><td colspan="9" style="text-align: center; color: var(--color-steel); padding: 40px;">No variants for this product</td></tr>';
                return;
            }
            table.innerHTML = currentVariants.map(v => `
                <tr>
                    <td><strong>${v.finish_name}</strong></td>
                    <td>${v.shaft_color}</td>
                    <td>${parseFloat(v.price_addon) > 0 ? '+$' + parseFloat(v.price_addon).toFixed(0) : '-'}</td>
                    <td>${parseFloat(v.shaft_price_addon) > 0 ? '+$' + parseFloat(v.shaft_price_addon).toFixed(0) : '-'}</td>
                    <td>${v.hosel_type ? v.hosel_type + (v.hosel_finish ? ' / ' + v.hosel_finish : '') : '-'}</td>
                    <td>${parseFloat(v.hosel_price_addon) > 0 ? '+$' + parseFloat(v.hosel_price_addon).toFixed(0) : '-'}</td>
                    <td>${v.sort_order}</td>
                    <td>${v.is_default ? '<span class="badge badge-success">Default</span>' : ''}</td>
                    <td>
                        <button class="btn btn-secondary btn-sm" onclick="editVariant('${v.id}')" style="margin-right:4px;">Edit</button>
                        <button class="btn btn-sm" style="background:var(--color-error);color:white;" onclick="deleteVariant('${v.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        function openVariantModal() {
            if (!currentVariantProductId) {
                alert('Select a product first');
                return;
            }
            document.getElementById('variantEditId').value = '';
            document.getElementById('variantFinish').value = '';
            document.getElementById('variantShaft').value = '';
            document.getElementById('variantPriceAddon').value = '0';
            document.getElementById('variantShaftPriceAddon').value = '0';
            document.getElementById('variantHoselType').value = '';
            document.getElementById('variantHoselFinish').value = '';
            document.getElementById('variantHoselPriceAddon').value = '0';
            document.getElementById('variantSortOrder').value = '0';
            document.getElementById('variantIsDefault').checked = false;
            document.getElementById('variantModalTitle').textContent = 'Add Variant';
            document.getElementById('variantModal').classList.add('active');
        }

        function editVariant(variantId) {
            const v = currentVariants.find(x => x.id === variantId);
            if (!v) return;
            document.getElementById('variantEditId').value = v.id;
            document.getElementById('variantFinish').value = v.finish_name;
            document.getElementById('variantShaft').value = v.shaft_color;
            document.getElementById('variantPriceAddon').value = parseFloat(v.price_addon) || 0;
            document.getElementById('variantShaftPriceAddon').value = parseFloat(v.shaft_price_addon) || 0;
            document.getElementById('variantHoselType').value = v.hosel_type || '';
            document.getElementById('variantHoselFinish').value = v.hosel_finish || '';
            document.getElementById('variantHoselPriceAddon').value = parseFloat(v.hosel_price_addon) || 0;
            document.getElementById('variantSortOrder').value = v.sort_order || 0;
            document.getElementById('variantIsDefault').checked = v.is_default || false;
            document.getElementById('variantModalTitle').textContent = 'Edit Variant';
            document.getElementById('variantModal').classList.add('active');
        }

        function closeVariantModal() {
            document.getElementById('variantModal').classList.remove('active');
        }

        async function saveVariant() {
            const editId = document.getElementById('variantEditId').value;
            const finish = document.getElementById('variantFinish').value.trim();
            const shaft = document.getElementById('variantShaft').value.trim();

            if (!finish || !shaft) {
                alert('Finish name and shaft color are required');
                return;
            }

            const body = {
                finish_name: finish,
                shaft_color: shaft,
                price_addon: parseFloat(document.getElementById('variantPriceAddon').value) || 0,
                shaft_price_addon: parseFloat(document.getElementById('variantShaftPriceAddon').value) || 0,
                hosel_type: document.getElementById('variantHoselType').value || null,
                hosel_finish: document.getElementById('variantHoselFinish').value || null,
                hosel_price_addon: parseFloat(document.getElementById('variantHoselPriceAddon').value) || 0,
                sort_order: parseInt(document.getElementById('variantSortOrder').value) || 0,
                is_default: document.getElementById('variantIsDefault').checked
            };

            try {
                if (editId) {
                    await supabaseQuery('proto_golf_variants', 'PATCH', body, `?id=eq.${editId}`);
                } else {
                    body.product_id = currentVariantProductId;
                    await supabaseQuery('proto_golf_variants', 'POST', body);
                }

                closeVariantModal();
                await loadVariantsForProduct();
                alert('Variant saved!');
            } catch (e) {
                console.error('Save variant error:', e);
                alert('Failed to save variant: ' + e.message);
            }
        }

        async function deleteVariant(variantId) {
            if (!confirm('Delete this variant?')) return;
            try {
                await supabaseQuery('proto_golf_variants', 'DELETE', null, `?id=eq.${variantId}`);
                await loadVariantsForProduct();
            } catch (e) {
                alert('Delete failed: ' + e.message);
            }
        }

        // ============================================
        // PHOTOS MANAGEMENT (DB-driven)
        // ============================================
        let currentPhotos = [];

        function updateFileLabel() {
            const input = document.getElementById('photoFileInput');
            const label = document.getElementById('fileLabel');
            if (!input.files || input.files.length === 0) {
                label.textContent = 'No file selected';
            } else if (input.files.length === 1) {
                label.textContent = input.files[0].name;
            } else {
                label.textContent = input.files.length + ' files selected';
            }
        }

        async function onPhotoProductChange() {
            const productId = document.getElementById('photoProduct').value;
            const variantSelect = document.getElementById('photoVariant');

            if (!productId) {
                variantSelect.innerHTML = '';
                return;
            }

            // Fetch variants for this product from DB
            try {
                const variants = await supabaseQuery('proto_golf_variants', 'GET', null,
                    `?product_id=eq.${encodeURIComponent(productId)}&order=sort_order`);
                const variantKeys = variants.map(v => `${v.finish_name}|${v.shaft_color}`);
                // Deduplicate
                const unique = [...new Set(variantKeys)];
                variantSelect.innerHTML = unique.map(v =>
                    `<option value="${v}">${v}</option>`
                ).join('');
            } catch (e) {
                console.error('Failed to load photo variants:', e);
                variantSelect.innerHTML = '';
            }

            loadProductImages();
        }

        async function loadProductImages() {
            const productId = document.getElementById('photoProduct').value;
            const variantKey = document.getElementById('photoVariant').value;
            const grid = document.getElementById('photoGrid');

            if (!productId || !variantKey) {
                grid.innerHTML = '<div style="text-align: center; color: var(--color-steel); padding: 40px; grid-column: 1 / -1;">Select a product and variant to view images</div>';
                return;
            }

            grid.innerHTML = '<div style="text-align: center; color: var(--color-steel); padding: 40px; grid-column: 1 / -1;">Loading...</div>';

            try {
                const data = await supabaseQuery('proto_golf_product_images', 'GET', null,
                    `?product_id=eq.${encodeURIComponent(productId)}&variant_key=eq.${encodeURIComponent(variantKey)}&order=sort_order`
                );
                currentPhotos = Array.isArray(data) ? data : [];
                renderPhotoGrid();
            } catch (e) {
                console.error('Failed to load images:', e);
                grid.innerHTML = '<div style="text-align: center; color: var(--color-error); padding: 40px; grid-column: 1 / -1;">Failed to load images</div>';
            }
        }

        function renderPhotoGrid() {
            const grid = document.getElementById('photoGrid');

            if (currentPhotos.length === 0) {
                grid.innerHTML = '<div style="text-align: center; color: var(--color-steel); padding: 40px; grid-column: 1 / -1;">No images for this variant yet. Upload one above.</div>';
                return;
            }

            grid.innerHTML = currentPhotos.map(photo => `
                <div class="photo-card">
                    <img src="${photo.image_url}" alt="Product image" loading="lazy">
                    <div class="photo-card-actions">
                        <input type="number" value="${photo.sort_order}" min="0"
                               onchange="updatePhotoOrder('${photo.id}', this.value)"
                               title="Sort order">
                        <button class="photo-delete-btn" onclick="deletePhoto('${photo.id}')">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        async function uploadPhoto() {
            const fileInput = document.getElementById('photoFileInput');
            const productId = document.getElementById('photoProduct').value;
            const variantKey = document.getElementById('photoVariant').value;
            const btn = document.getElementById('uploadPhotoBtn');

            if (!fileInput.files || fileInput.files.length === 0) {
                alert('Please select image file(s)');
                return;
            }

            if (!productId || !variantKey) {
                alert('Please select a product and variant');
                return;
            }

            const files = Array.from(fileInput.files);
            const total = files.length;
            btn.textContent = `Uploading 0/${total}...`;
            btn.disabled = true;

            let uploaded = 0;
            let failed = 0;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                btn.textContent = `Uploading ${i + 1}/${total}...`;

                try {
                    // Upload directly to Supabase Storage
                    const ext = file.name.split('.').pop() || 'jpg';
                    const storagePath = `${productId}/${variantKey.replace(/\|/g, '-').replace(/\s/g, '_')}/${Date.now()}_${i}.${ext}`;

                    const uploadResp = await fetch(`${SUPABASE_URL}/storage/v1/object/proto-golf-images/${storagePath}`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_KEY,
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'Content-Type': file.type || 'image/jpeg'
                        },
                        body: file
                    });

                    if (!uploadResp.ok) {
                        const errText = await uploadResp.text();
                        throw new Error('Storage upload failed: ' + errText);
                    }

                    // Get public URL
                    const publicUrl = `${SUPABASE_URL}/storage/v1/object/public/proto-golf-images/${storagePath}`;

                    // Insert DB record
                    const ok = await supabaseQuery('proto_golf_product_images', 'POST', {
                        product_id: productId,
                        variant_key: variantKey,
                        image_url: publicUrl,
                        sort_order: currentPhotos.length + uploaded
                    });

                    if (ok) {
                        uploaded++;
                    } else {
                        failed++;
                        console.error('DB insert failed for', file.name);
                    }
                } catch (e) {
                    failed++;
                    console.error('Upload error for', file.name, e);
                }
            }

            fileInput.value = '';
            document.getElementById('fileLabel').textContent = 'No file selected';
            await loadProductImages();

            if (failed === 0) {
                alert(`${uploaded} image${uploaded !== 1 ? 's' : ''} uploaded successfully!`);
            } else {
                alert(`${uploaded} uploaded, ${failed} failed.`);
            }

            btn.textContent = 'Upload';
            btn.disabled = false;
        }

        async function deletePhoto(imageId) {
            if (!confirm('Delete this image? This cannot be undone.')) return;

            try {
                // Find the photo to get the storage path
                const photo = currentPhotos.find(p => p.id === imageId);
                if (photo && photo.image_url) {
                    const urlParts = photo.image_url.split('/proto-golf-images/');
                    if (urlParts.length === 2) {
                        const storagePath = decodeURIComponent(urlParts[1]);
                        await fetch(`${SUPABASE_URL}/storage/v1/object/proto-golf-images/${storagePath}`, {
                            method: 'DELETE',
                            headers: {
                                'apikey': SUPABASE_KEY,
                                'Authorization': `Bearer ${SUPABASE_KEY}`
                            }
                        });
                    }
                }

                // Delete DB record
                await supabaseQuery('proto_golf_product_images', 'DELETE', null, `?id=eq.${imageId}`);
                await loadProductImages();
            } catch (e) {
                console.error('Delete error:', e);
                alert('Delete failed: ' + e.message);
            }
        }

        async function updatePhotoOrder(imageId, newOrder) {
            try {
                await supabaseQuery('proto_golf_product_images', 'PATCH',
                    { sort_order: parseInt(newOrder) || 0 },
                    `?id=eq.${imageId}`
                );
            } catch (e) {
                console.error('Failed to update sort order:', e);
            }
        }

        // Photo/variant dropdowns are populated after initDashboard() via populateProductDropdowns()

        function exportOrders() {
            if (orders.length === 0) {
                alert('No orders to export');
                return;
            }

            const headers = ['Order #', 'Date', 'Customer', 'Email', 'Product', 'Finish', 'Shaft', 'Delivery', 'Total', 'Status'];
            const rows = orders.map(o => [
                o.orderNumber,
                o.date,
                o.customerName,
                o.customerEmail,
                o.productName,
                o.finish,
                o.shaftColor,
                o.deliveryMethod,
                o.total,
                o.status
            ]);

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `proto-golf-orders-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        // ============================================
        // BG REMOVER
        // ============================================
        let bgSelectedFiles = [];
        let bgCurrentBg = '#ffffff';
        let bgResultsList = [];

        // Swatch clicks
        document.getElementById('bgSwatches').addEventListener('click', e => {
            const swatch = e.target.closest('[data-bg]');
            if (!swatch) return;
            document.querySelectorAll('#bgSwatches .bg-swatch, #bgSwatches [data-bg]').forEach(s => s.style.borderColor = 'var(--color-ash)');
            swatch.style.borderColor = 'var(--color-ink)';
            bgCurrentBg = swatch.dataset.bg;
        });

        document.getElementById('bgCustomColor').addEventListener('input', function() {
            document.querySelectorAll('#bgSwatches .bg-swatch').forEach(s => s.style.borderColor = 'var(--color-ash)');
            this.parentElement.style.borderColor = 'var(--color-ink)';
            bgCurrentBg = this.value;
        });

        // Drag and drop
        const bgUploadArea = document.getElementById('bgUploadArea');
        bgUploadArea.addEventListener('dragover', e => { e.preventDefault(); bgUploadArea.style.borderColor = 'var(--color-ink)'; });
        bgUploadArea.addEventListener('dragleave', () => { bgUploadArea.style.borderColor = 'var(--color-ash)'; });
        bgUploadArea.addEventListener('drop', e => {
            e.preventDefault();
            bgUploadArea.style.borderColor = 'var(--color-ash)';
            bgHandleFiles(e.dataTransfer.files);
        });

        function bgHandleFiles(fileList) {
            const valid = [];
            for (const f of fileList) {
                if (f.type.match(/^image\/(jpeg|png|webp)$/)) valid.push(f);
            }
            if (valid.length === 0) return;
            bgSelectedFiles = valid;
            document.getElementById('bgFileCount').textContent = valid.length === 1 ? '1 photo selected' : valid.length + ' photos selected';
            bgUploadArea.style.borderColor = 'var(--color-ink)';
            bgUploadArea.style.borderStyle = 'solid';
            document.getElementById('bgProcessBtn').disabled = false;
        }

        function bgFileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read file'));
                reader.readAsDataURL(file);
            });
        }

        async function bgProcess() {
            if (bgSelectedFiles.length === 0) return;

            const btn = document.getElementById('bgProcessBtn');
            btn.disabled = true;
            btn.textContent = 'Processing...';
            document.getElementById('bgProgress').style.display = 'block';
            document.getElementById('bgResults').innerHTML = '';
            document.getElementById('bgBulkActions').style.display = 'none';
            document.getElementById('bgResetBtn').style.display = '';
            bgResultsList = [];

            const total = bgSelectedFiles.length;
            let completed = 0;
            let failed = 0;

            for (let i = 0; i < total; i++) {
                const file = bgSelectedFiles[i];
                const baseName = file.name.replace(/\.[^.]+$/, '');

                document.getElementById('bgProgressLabel').textContent = `Processing ${i + 1} of ${total}: ${file.name}`;
                document.getElementById('bgProgressBar').style.width = Math.round((i / total) * 100) + '%';

                try {
                    const base64 = await bgFileToBase64(file);
                    const resp = await fetch('/api/remove-bg', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ image: base64, background: bgCurrentBg })
                    });

                    if (!resp.ok) {
                        const err = await resp.json().catch(() => ({}));
                        throw new Error(err.error || 'Server error ' + resp.status);
                    }

                    const data = await resp.json();
                    const name = baseName + '.png';
                    bgResultsList.push({ name, dataUrl: data.image });
                    bgAddResultCard(name, data.image, bgResultsList.length - 1);
                    completed++;
                } catch (err) {
                    failed++;
                    bgAddErrorCard(file.name, err.message);
                }

                document.getElementById('bgProgressBar').style.width = Math.round(((completed + failed) / total) * 100) + '%';
            }

            document.getElementById('bgProgressLabel').textContent = `Done â€” ${completed} of ${total} succeeded` + (failed > 0 ? ` (${failed} failed)` : '');
            document.getElementById('bgProgressBar').style.width = '100%';
            btn.textContent = 'Remove Backgrounds';
            btn.disabled = false;

            if (bgResultsList.length > 1) {
                document.getElementById('bgBulkActions').style.display = 'block';
            }
        }

        function bgAddResultCard(name, dataUrl, index) {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.innerHTML = `
                <img src="${dataUrl}" alt="${name}" style="width: 100%; max-height: 300px; object-fit: contain; display: block; background: repeating-conic-gradient(var(--color-mist) 0% 25%, var(--color-paper) 0% 50%) 0 0/16px 16px;">
                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; border-top: 1px solid var(--color-ash);">
                    <span style="font-size: 13px; font-weight: 600; color: var(--color-steel); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex: 1; margin-right: 12px;">${name}</span>
                    <button class="btn btn-primary btn-sm" onclick="bgDownloadOne(${index})">Download</button>
                </div>
            `;
            document.getElementById('bgResults').appendChild(card);
        }

        function bgAddErrorCard(fileName, errMsg) {
            const card = document.createElement('div');
            card.className = 'section-card';
            card.style.borderColor = 'var(--color-error)';
            card.innerHTML = `<div style="padding: 16px; color: var(--color-error); font-size: 13px;">${fileName} â€” failed: ${errMsg}</div>`;
            document.getElementById('bgResults').appendChild(card);
        }

        function bgDownloadOne(index) {
            const r = bgResultsList[index];
            const a = document.createElement('a');
            a.href = r.dataUrl;
            a.download = r.name;
            a.click();
        }

        async function bgDownloadAll() {
            if (bgResultsList.length < 2) return;
            const btn = document.getElementById('bgDownloadAllBtn');
            btn.disabled = true;
            btn.textContent = 'Creating ZIP...';

            const { default: JSZip } = await import('https://cdn.jsdelivr.net/npm/jszip@3.10.1/+esm');
            const zip = new JSZip();
            for (const r of bgResultsList) {
                const base64 = r.dataUrl.split(',')[1];
                zip.file(r.name, base64, { base64: true });
            }
            const zipBlob = await zip.generateAsync({ type: 'blob' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(zipBlob);
            a.download = 'background-removed.zip';
            a.click();

            btn.disabled = false;
            btn.textContent = 'Download All as ZIP';
        }

        function bgReset() {
            bgSelectedFiles = [];
            bgResultsList = [];
            document.getElementById('bgFileInput').value = '';
            document.getElementById('bgFileCount').textContent = '';
            document.getElementById('bgUploadArea').style.borderColor = 'var(--color-ash)';
            document.getElementById('bgUploadArea').style.borderStyle = 'dashed';
            document.getElementById('bgProcessBtn').disabled = true;
            document.getElementById('bgProgress').style.display = 'none';
            document.getElementById('bgProgressBar').style.width = '0%';
            document.getElementById('bgResults').innerHTML = '';
            document.getElementById('bgBulkActions').style.display = 'none';
            document.getElementById('bgResetBtn').style.display = 'none';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Client Requests
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        async function submitRequest() {
            const title = document.getElementById('requestTitle').value.trim();
            const content = document.getElementById('requestContent').value.trim();
            const statusEl = document.getElementById('requestStatus');

            if (!title || !content) {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
                statusEl.style.color = 'var(--color-error)';
                statusEl.textContent = 'Please fill in both title and description.';
                return;
            }

            try {
                statusEl.style.display = 'block';
                statusEl.style.background = 'rgba(245, 158, 11, 0.1)';
                statusEl.style.color = 'var(--color-warning)';
                statusEl.textContent = 'Submitting...';

                await supabaseQuery('factory_proposals', 'POST', {
                    title: title,
                    content: content,
                    category: 'client_request',
                    client_app: 'proto-golf',
                    client_project_dir: 'proto-golf-site',
                    claude_prompt: content,
                    status: 'submitted',
                    section: 'suite_apps'
                });

                statusEl.style.background = 'rgba(34, 197, 94, 0.1)';
                statusEl.style.color = 'var(--color-success)';
                statusEl.textContent = 'Request submitted! Stuart will review it shortly.';
                document.getElementById('requestTitle').value = '';
                document.getElementById('requestContent').value = '';

                loadRequests();
            } catch (e) {
                statusEl.style.background = 'rgba(239, 68, 68, 0.1)';
                statusEl.style.color = 'var(--color-error)';
                statusEl.textContent = 'Failed to submit. Please try again.';
                console.error('Submit request error:', e);
            }
        }

        async function loadRequests() {
            const container = document.getElementById('requestsList');
            try {
                const data = await supabaseQuery('factory_proposals', 'GET', null,
                    '?category=eq.client_request&client_app=eq.proto-golf&order=created_at.desc&limit=20');

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-steel); text-align: center;">No requests yet. Submit one above!</p>';
                    return;
                }

                container.innerHTML = data.map(r => {
                    const date = new Date(r.created_at).toLocaleDateString();
                    const statusMap = {
                        'submitted': { label: 'Pending Review', cls: 'badge-warning' },
                        'approved': { label: 'Approved', cls: 'badge-success' },
                        'processing': { label: 'Processing...', cls: 'badge-warning' },
                        'completed': { label: 'Completed', cls: 'badge-success' },
                        'failed': { label: 'Failed', cls: 'badge-error' },
                        'rejected': { label: 'Rejected', cls: 'badge-error' }
                    };
                    const st = statusMap[r.status] || { label: r.status, cls: 'badge-neutral' };

                    let outputHtml = '';
                    if (r.claude_output) {
                        outputHtml = `<div style="margin-top: 12px; padding: 12px; background: var(--color-bone); border-radius: 8px; font-size: 0.85rem;">
                            <strong>Result:</strong><br>
                            <pre style="white-space: pre-wrap; margin-top: 4px; font-family: 'Space Mono', monospace; font-size: 0.8rem;">${escapeHtml(r.claude_output.substring(0, 500))}${r.claude_output.length > 500 ? '...' : ''}</pre>
                        </div>`;
                    }
                    if (r.error_message) {
                        outputHtml = `<div style="margin-top: 12px; padding: 12px; background: rgba(239,68,68,0.05); border-radius: 8px; font-size: 0.85rem; color: var(--color-error);">
                            <strong>Error:</strong> ${escapeHtml(r.error_message)}
                        </div>`;
                    }

                    return `<div style="padding: 16px; border-bottom: 1px solid var(--color-mist);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <strong>${escapeHtml(r.title)}</strong>
                            <span class="badge ${st.cls}">${st.label}</span>
                        </div>
                        <p style="color: var(--color-steel); font-size: 0.9rem; margin-bottom: 4px;">${escapeHtml(r.content || '').substring(0, 200)}</p>
                        <span style="font-size: 0.8rem; color: var(--color-silver);">${date}</span>
                        ${outputHtml}
                    </div>`;
                }).join('');
            } catch (e) {
                container.innerHTML = '<p style="color: var(--color-error); text-align: center;">Failed to load requests.</p>';
                console.error('Load requests error:', e);
            }
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function checkRequestDaemonStatus() {
            const dot = document.getElementById('reqDaemonDot');
            const text = document.getElementById('reqDaemonText');
            if (!dot || !text) return;

            try {
                const resp = await supabaseQuery('daemon_heartbeat', 'GET', null,
                    '?id=eq.client-request-daemon&select=last_heartbeat,enabled');
                if (resp && resp.length > 0) {
                    const age = (Date.now() - new Date(resp[0].last_heartbeat).getTime()) / 1000;
                    const enabled = resp[0].enabled !== false;
                    if (age < 60 && enabled) {
                        dot.style.background = 'var(--color-success)';
                        text.textContent = 'Requests Active';
                        document.getElementById('requestDaemonStatus').style.background = 'rgba(34, 197, 94, 0.1)';
                        document.getElementById('requestDaemonStatus').style.color = 'var(--color-success)';
                    } else if (age < 60 && !enabled) {
                        dot.style.background = 'var(--color-warning)';
                        text.textContent = 'Requests Paused';
                        document.getElementById('requestDaemonStatus').style.background = 'rgba(245, 158, 11, 0.1)';
                        document.getElementById('requestDaemonStatus').style.color = 'var(--color-warning)';
                    } else {
                        dot.style.background = 'var(--color-silver)';
                        text.textContent = 'Requests Offline';
                        document.getElementById('requestDaemonStatus').style.background = 'var(--color-mist)';
                        document.getElementById('requestDaemonStatus').style.color = 'var(--color-steel)';
                    }
                } else {
                    dot.style.background = 'var(--color-silver)';
                    text.textContent = 'Requests Offline';
                }
            } catch (e) {
                console.error('Daemon status check failed:', e);
            }
        }

        let reqDaemonInterval = null;

        // Load requests when section is shown
        const origShowSection = showSection;
        showSection = function(sectionId, event) {
            origShowSection(sectionId, event);
            if (sectionId === 'requests') {
                loadRequests();
                checkRequestDaemonStatus();
                if (!reqDaemonInterval) reqDaemonInterval = setInterval(checkRequestDaemonStatus, 15000);
            } else {
                if (reqDaemonInterval) { clearInterval(reqDaemonInterval); reqDaemonInterval = null; }
            }
            if (sectionId === 'siteeditor') {
                initSiteEditor();
            }
        };

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // Site Editor
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        let siteEditorSelectedElement = null;
        let siteEditorSelectedSelector = null;
        let siteEditorSelectedText = null;
        let siteEditorRecognition = null;
        let siteEditorIsRecording = false;
        let siteEditorHistory = [];

        function initSiteEditor() {
            loadSiteEditorPage();
            loadSiteEditorHistory();
        }

        // Whitelist of allowed Proto Golf pages - ONLY these can be edited
        const ALLOWED_PROTO_GOLF_PAGES = [
            '../index.html',
            '../shop.html',
            '../about.html',
            '../contact.html',
            '../faq.html',
            '../limited.html',
            '../checkout.html',
            '../products/product.html',
            '../products/rough-mill.html',
            '../products/centre-blade.html',
            '../products/long-neck-blade.html'
        ];

        function loadSiteEditorPage() {
            const iframe = document.getElementById('siteEditorIframe');
            const select = document.getElementById('siteEditorPageSelect');
            const selectedPage = select.value;

            // Security: Only allow whitelisted Proto Golf pages
            if (!ALLOWED_PROTO_GOLF_PAGES.includes(selectedPage)) {
                alert('Invalid page selected. Only Proto Golf pages can be edited.');
                select.value = '../index.html';
                return;
            }

            iframe.src = selectedPage;

            // Reset selection
            siteEditorSelectedElement = null;
            siteEditorSelectedSelector = null;
            siteEditorSelectedText = null;
            document.getElementById('siteEditorSelectedEl').innerHTML =
                '<span class="site-editor-selected-none">Click an element on the site preview â†’</span>';

            // Wait for iframe to load then attach click handler
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

                    // Inject styles for hover/selection
                    const style = iframeDoc.createElement('style');
                    style.textContent = `
                        .site-editor-hover { outline: 2px solid #22c55e !important; outline-offset: 2px; cursor: pointer !important; }
                        .site-editor-selected { outline: 3px solid #3b82f6 !important; outline-offset: 2px; }
                    `;
                    iframeDoc.head.appendChild(style);

                    // Attach event listeners
                    iframeDoc.body.addEventListener('mouseover', handleSiteEditorHover);
                    iframeDoc.body.addEventListener('mouseout', handleSiteEditorMouseOut);
                    iframeDoc.body.addEventListener('click', handleSiteEditorClick);
                } catch (e) {
                    console.error('Cannot access iframe (cross-origin?):', e);
                }
            };
        }

        function handleSiteEditorHover(e) {
            e.target.classList.add('site-editor-hover');
        }

        function handleSiteEditorMouseOut(e) {
            e.target.classList.remove('site-editor-hover');
        }

        function handleSiteEditorClick(e) {
            e.preventDefault();
            e.stopPropagation();

            const iframe = document.getElementById('siteEditorIframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            // Remove previous selection
            iframeDoc.querySelectorAll('.site-editor-selected').forEach(el => {
                el.classList.remove('site-editor-selected');
            });

            // Select new element
            e.target.classList.add('site-editor-selected');
            e.target.classList.remove('site-editor-hover');

            siteEditorSelectedElement = e.target;
            siteEditorSelectedSelector = generateSelector(e.target);
            siteEditorSelectedText = e.target.innerText?.substring(0, 150) || '[no text]';

            // Update UI
            const displayText = siteEditorSelectedText.length > 80
                ? siteEditorSelectedText.substring(0, 80) + '...'
                : siteEditorSelectedText;
            document.getElementById('siteEditorSelectedEl').innerHTML =
                `<strong>${e.target.tagName.toLowerCase()}</strong>: "${displayText}"`;
        }

        function generateSelector(el) {
            if (el.id) return '#' + el.id;

            let path = [];
            while (el && el.nodeType === Node.ELEMENT_NODE) {
                let selector = el.tagName.toLowerCase();
                if (el.id) {
                    selector = '#' + el.id;
                    path.unshift(selector);
                    break;
                } else if (el.className && typeof el.className === 'string') {
                    const classes = el.className.trim().split(/\s+/)
                        .filter(c => !c.startsWith('site-editor-'))
                        .slice(0, 2);
                    if (classes.length) selector += '.' + classes.join('.');
                }

                // Add nth-child if needed for uniqueness
                const parent = el.parentElement;
                if (parent) {
                    const siblings = Array.from(parent.children).filter(c => c.tagName === el.tagName);
                    if (siblings.length > 1) {
                        const idx = siblings.indexOf(el) + 1;
                        selector += `:nth-child(${idx})`;
                    }
                }

                path.unshift(selector);
                el = el.parentElement;

                if (path.length > 4) break; // Limit depth
            }
            return path.join(' > ');
        }

        function toggleSiteEditorVoice() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('Voice input is not supported in this browser. Please use Chrome or Edge.');
                return;
            }

            if (siteEditorIsRecording) {
                stopSiteEditorVoice();
            } else {
                startSiteEditorVoice();
            }
        }

        function startSiteEditorVoice() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            siteEditorRecognition = new SpeechRecognition();
            siteEditorRecognition.continuous = true;
            siteEditorRecognition.interimResults = true;
            siteEditorRecognition.lang = 'en-US';

            siteEditorRecognition.onstart = function() {
                siteEditorIsRecording = true;
                document.getElementById('siteEditorVoiceBtn').classList.add('recording');
                document.getElementById('siteEditorVoiceIcon').textContent = 'â¹ï¸';
                document.getElementById('siteEditorVoiceText').textContent = 'Recording... click to stop';
            };

            siteEditorRecognition.onresult = function(event) {
                let transcript = '';
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    transcript += event.results[i][0].transcript;
                }
                document.getElementById('siteEditorTextInput').value = transcript;
            };

            siteEditorRecognition.onerror = function(event) {
                console.error('Speech recognition error:', event.error);
                stopSiteEditorVoice();
                if (event.error === 'not-allowed') {
                    alert('Microphone access denied. Please allow microphone access in your browser settings.');
                }
            };

            siteEditorRecognition.onend = function() {
                stopSiteEditorVoice();
            };

            siteEditorRecognition.start();
        }

        function stopSiteEditorVoice() {
            if (siteEditorRecognition) {
                siteEditorRecognition.stop();
            }
            siteEditorIsRecording = false;
            document.getElementById('siteEditorVoiceBtn').classList.remove('recording');
            document.getElementById('siteEditorVoiceIcon').textContent = 'ðŸŽ¤';
            document.getElementById('siteEditorVoiceText').textContent = 'Click to speak';
        }

        let siteEditorOriginalHtml = null;
        let siteEditorModifiedHtml = null;
        let siteEditorCurrentPage = null;
        let siteEditorPendingRequest = null;

        // Helper to show step-by-step progress
        function updateEditorStatus(statusEl, step, total, message, isWarning = true) {
            const progress = `[${step}/${total}]`;
            statusEl.innerHTML = `<span style="opacity:0.7">${progress}</span> ${message}`;
            statusEl.className = 'site-editor-status';
            statusEl.style.display = 'block';
            statusEl.style.background = isWarning ? 'rgba(245, 158, 11, 0.1)' : 'rgba(34, 197, 94, 0.1)';
            statusEl.style.color = isWarning ? 'var(--color-warning)' : 'var(--color-success)';
        }

        async function applySiteEditorChange() {
            const request = document.getElementById('siteEditorTextInput').value.trim();
            const statusEl = document.getElementById('siteEditorStatus');
            const btn = document.getElementById('siteEditorSubmitBtn');
            const saveArea = document.getElementById('siteEditorSaveArea');

            if (!request) {
                statusEl.textContent = 'Please describe what you want changed.';
                statusEl.className = 'site-editor-status error';
                statusEl.style.display = 'block';
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Applying...';

            updateEditorStatus(statusEl, 1, 5, 'Reading current page...');

            const iframe = document.getElementById('siteEditorIframe');
            const page = document.getElementById('siteEditorPageSelect').value.replace('../', '');

            try {
                // Get current HTML from iframe
                const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                const currentHtml = '<!DOCTYPE html>\n' + iframeDoc.documentElement.outerHTML;

                // Get the base URL for this page
                const pageUrl = new URL(iframe.src, window.location.href);
                const baseUrl = pageUrl.href.substring(0, pageUrl.href.lastIndexOf('/') + 1);

                updateEditorStatus(statusEl, 2, 5, 'Fetching original file...');

                // Fetch the ORIGINAL HTML file from server (not iframe DOM which can be modified)
                const originalFileUrl = iframe.src;
                const fileResponse = await fetch(originalFileUrl);
                if (!fileResponse.ok) throw new Error('Failed to fetch original file');
                const originalHtml = await fileResponse.text();

                // Store original for revert
                if (!siteEditorOriginalHtml || siteEditorCurrentPage !== page) {
                    siteEditorOriginalHtml = originalHtml;
                    siteEditorCurrentPage = page;
                }

                updateEditorStatus(statusEl, 3, 5, 'AI is analyzing the change...');

                // Build prompt - ask AI for SURGICAL find/replace, not full regeneration
                const prompt = `You are a surgical HTML editor. Analyze this change request and return ONLY a JSON object with the exact find/replace needed.

USER REQUEST: "${request}"

${siteEditorSelectedSelector ? `SELECTED ELEMENT: ${siteEditorSelectedSelector}` : ''}
${siteEditorSelectedText ? `SELECTED TEXT: "${siteEditorSelectedText}"` : ''}

ORIGINAL HTML FILE (this is what we're editing):
${originalHtml.substring(0, 15000)}

Return ONLY a valid JSON object in this exact format (no other text):
{
  "find": "exact string to find in the HTML",
  "replace": "exact string to replace it with"
}

RULES:
- The "find" string must exist EXACTLY in the HTML (case-sensitive, whitespace-sensitive)
- For text changes: find the existing text, replace with new text
- For adding content: find the element/text AFTER which to insert, include it in replace with the new content appended
- Keep all HTML tags, classes, attributes intact - only change the specific text/content requested
- If adding a new FAQ item, find the last </div> of the faq-list and insert before it`;

                // Call Gemini API
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        model: 'gemini-3-flash-preview',
                        enableSearch: false,
                        generationConfig: {
                            temperature: 0,
                            maxOutputTokens: 4096
                        }
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    console.error('Gemini API error:', errData);
                    throw new Error(errData.error || 'Gemini API error');
                }

                updateEditorStatus(statusEl, 4, 5, 'Applying surgical edit...');

                const data = await response.json();
                let aiResponse = data.text || data.response || '';

                // Extract JSON from response
                const jsonMatch = aiResponse.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('AI did not return valid JSON');
                }

                let editInstruction;
                try {
                    editInstruction = JSON.parse(jsonMatch[0]);
                } catch (e) {
                    throw new Error('Failed to parse AI response as JSON');
                }

                if (!editInstruction.find || !editInstruction.replace) {
                    throw new Error('AI response missing find/replace fields');
                }

                // Apply the surgical edit to the ORIGINAL HTML
                if (!originalHtml.includes(editInstruction.find)) {
                    console.error('Find string not found:', editInstruction.find);
                    throw new Error('Could not locate the text to change. Try selecting a more specific element.');
                }

                let newHtml = originalHtml.replace(editInstruction.find, editInstruction.replace);

                // For preview in iframe, convert relative paths to absolute
                let previewHtml = newHtml.replace(/href="(?!http|\/\/|#|mailto:|tel:)([^"]+)"/g, `href="${baseUrl}$1"`);
                previewHtml = previewHtml.replace(/src="(?!http|\/\/|data:)([^"]+)"/g, `src="${baseUrl}$1"`);

                // Store modified HTML
                siteEditorModifiedHtml = newHtml;
                siteEditorPendingRequest = {
                    page: page,
                    element_selector: siteEditorSelectedSelector,
                    element_text: siteEditorSelectedText,
                    request_text: request
                };

                updateEditorStatus(statusEl, 5, 5, 'Updating preview...');

                // Update iframe with preview HTML (has absolute URLs for resources)
                iframeDoc.open();
                iframeDoc.write(previewHtml);
                iframeDoc.close();

                // Re-attach click handlers after a short delay
                setTimeout(() => {
                    try {
                        const newDoc = iframe.contentDocument || iframe.contentWindow.document;
                        const style = newDoc.createElement('style');
                        style.textContent = `
                            .site-editor-hover { outline: 2px solid #22c55e !important; outline-offset: 2px; cursor: pointer !important; }
                            .site-editor-selected { outline: 3px solid #3b82f6 !important; outline-offset: 2px; }
                        `;
                        newDoc.head.appendChild(style);
                        newDoc.body.addEventListener('mouseover', handleSiteEditorHover);
                        newDoc.body.addEventListener('mouseout', handleSiteEditorMouseOut);
                        newDoc.body.addEventListener('click', handleSiteEditorClick);
                    } catch (e) {}
                }, 100);

                // Show success + save/revert options
                statusEl.textContent = 'âœ“ Preview updated!';
                statusEl.className = 'site-editor-status success';
                saveArea.style.display = 'block';

            } catch (e) {
                console.error('Apply change error:', e);
                statusEl.textContent = 'Failed to apply change. Try again.';
                statusEl.className = 'site-editor-status error';
                statusEl.style.display = 'block';
            }

            btn.disabled = false;
            btn.textContent = 'Apply Change';
        }

        function revertSiteEditorChange() {
            if (!siteEditorOriginalHtml) return;

            const iframe = document.getElementById('siteEditorIframe');
            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;

            iframeDoc.open();
            iframeDoc.write(siteEditorOriginalHtml);
            iframeDoc.close();

            // Re-attach handlers
            setTimeout(() => {
                try {
                    const newDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const style = newDoc.createElement('style');
                    style.textContent = `
                        .site-editor-hover { outline: 2px solid #22c55e !important; outline-offset: 2px; cursor: pointer !important; }
                        .site-editor-selected { outline: 3px solid #3b82f6 !important; outline-offset: 2px; }
                    `;
                    newDoc.head.appendChild(style);
                    newDoc.body.addEventListener('mouseover', handleSiteEditorHover);
                    newDoc.body.addEventListener('mouseout', handleSiteEditorMouseOut);
                    newDoc.body.addEventListener('click', handleSiteEditorClick);
                } catch (e) {}
            }, 100);

            // Reset state
            siteEditorModifiedHtml = null;
            siteEditorPendingRequest = null;
            document.getElementById('siteEditorSaveArea').style.display = 'none';
            document.getElementById('siteEditorStatus').style.display = 'none';
            document.getElementById('siteEditorTextInput').value = '';
        }

        async function saveSiteEditorChange() {
            if (!siteEditorModifiedHtml || !siteEditorPendingRequest) return;

            const statusEl = document.getElementById('siteEditorStatus');
            const saveArea = document.getElementById('siteEditorSaveArea');

            updateEditorStatus(statusEl, 1, 5, 'Preparing HTML for publish...');

            try {
                // Convert absolute URLs back to relative for the actual file
                const iframe = document.getElementById('siteEditorIframe');
                const pageUrl = new URL(iframe.src, window.location.href);
                const baseUrl = pageUrl.href.substring(0, pageUrl.href.lastIndexOf('/') + 1);

                let htmlForPublish = siteEditorModifiedHtml;
                // Remove base URL to restore relative paths
                htmlForPublish = htmlForPublish.split(baseUrl).join('');

                updateEditorStatus(statusEl, 2, 5, 'Cleaning up HTML...');

                // Clean up browser extension junk and editor artifacts
                htmlForPublish = cleanHtmlForPublish(htmlForPublish);

                updateEditorStatus(statusEl, 3, 5, 'Connecting to GitHub...');

                // Publish to GitHub via API
                const publishResponse = await fetch('/api/publish-proto-golf', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        page: siteEditorPendingRequest.page,
                        html: htmlForPublish,
                        requestText: siteEditorPendingRequest.request_text
                    })
                });

                const publishResult = await publishResponse.json();

                if (!publishResponse.ok) {
                    throw new Error(publishResult.error || 'Failed to publish');
                }

                updateEditorStatus(statusEl, 4, 5, 'Committed to GitHub!');

                // Save to Supabase as a record (don't fail if this errors)
                try {
                    await supabaseQuery('proto_golf_requests', 'POST', {
                        page: siteEditorPendingRequest.page,
                        element_selector: siteEditorPendingRequest.element_selector,
                        element_text: siteEditorPendingRequest.element_text,
                        request_text: siteEditorPendingRequest.request_text,
                        input_type: 'ai_applied',
                        status: 'published'
                    });
                } catch (dbErr) {
                    console.warn('Failed to save to database (non-critical):', dbErr);
                }

                saveArea.style.display = 'none';

                // Store what we need for verification
                const verifyPage = siteEditorPendingRequest.page;
                const verifyHtml = siteEditorModifiedHtml;
                const liveUrl = `https://suitegpt.app/proto-golf-site/${verifyPage}`;

                // Update state
                siteEditorOriginalHtml = siteEditorModifiedHtml;
                siteEditorModifiedHtml = null;
                siteEditorPendingRequest = null;

                // Clear form
                document.getElementById('siteEditorTextInput').value = '';
                siteEditorSelectedElement = null;
                siteEditorSelectedSelector = null;
                siteEditorSelectedText = null;
                document.getElementById('siteEditorSelectedEl').innerHTML =
                    '<span class="site-editor-selected-none">Click an element on the site preview â†’</span>';

                // Reload history
                loadSiteEditorHistory();

                // Deployment countdown then verification
                updateEditorStatus(statusEl, 5, 5, 'Deploying to Vercel...', false);
                let countdown = 45;
                const countdownInterval = setInterval(async () => {
                    countdown--;
                    if (countdown <= 0) {
                        clearInterval(countdownInterval);
                        // Start verification
                        statusEl.innerHTML = 'ðŸ” Verifying deployment...';
                        await verifyDeployment(statusEl, liveUrl, verifyHtml);
                    } else {
                        const progress = Math.round((45 - countdown) / 45 * 100);
                        statusEl.innerHTML = `â³ Deploying... <strong>${countdown}s</strong> <span style="opacity:0.6">(${progress}%)</span>`;
                    }
                }, 1000);

            } catch (e) {
                console.error('Publish error:', e);
                statusEl.textContent = 'Failed to publish: ' + e.message;
                statusEl.className = 'site-editor-status error';
            }
        }

        async function verifyDeployment(statusEl, liveUrl, expectedHtml) {
            // Extract a unique snippet from the new HTML to verify
            // Look for something that was likely changed
            const snippetMatch = expectedHtml.match(/<(?:h1|h2|h3|p|span|div)[^>]*>([^<]{10,50})</);
            const verifySnippet = snippetMatch ? snippetMatch[1].trim() : null;

            let attempts = 0;
            const maxAttempts = 6; // Try for 30 more seconds (5s intervals)

            const checkLive = async () => {
                attempts++;
                try {
                    // Add cache-busting
                    const response = await fetch(liveUrl + '?_t=' + Date.now(), {
                        cache: 'no-store'
                    });
                    const liveHtml = await response.text();

                    // Check if the new content is in the live page
                    // Use a simple heuristic: check if key parts of expectedHtml are in liveHtml
                    const isLive = verifySnippet ? liveHtml.includes(verifySnippet) : true;

                    if (isLive) {
                        statusEl.innerHTML = 'âœ… <strong>Live!</strong> Changes verified on site. <a href="' + liveUrl + '" target="_blank" style="color:inherit;text-decoration:underline;">View page â†’</a>';
                        statusEl.style.background = 'rgba(34, 197, 94, 0.15)';
                        statusEl.style.color = 'var(--color-success)';
                        return;
                    }
                } catch (e) {
                    console.warn('Verify fetch error:', e);
                }

                if (attempts < maxAttempts) {
                    statusEl.innerHTML = `ðŸ” Verifying... (attempt ${attempts}/${maxAttempts})`;
                    setTimeout(checkLive, 5000);
                } else {
                    // Give up but assume it worked
                    statusEl.innerHTML = 'âœ“ <strong>Published!</strong> May take a moment to appear. <a href="' + liveUrl + '" target="_blank" style="color:inherit;text-decoration:underline;">Check page â†’</a>';
                    statusEl.style.background = 'rgba(34, 197, 94, 0.1)';
                    statusEl.style.color = 'var(--color-success)';
                }
            };

            await checkLive();
        }

        function cleanHtmlForPublish(html) {
            // Remove site editor classes
            html = html.replace(/\s*class="[^"]*site-editor-[^"]*"/g, (match) => {
                // Keep other classes, just remove site-editor-* ones
                const cleaned = match.replace(/site-editor-\w+/g, '').replace(/\s+/g, ' ').trim();
                return cleaned === 'class=""' ? '' : cleaned;
            });
            html = html.replace(/\ssite-editor-\w+/g, '');

            // Remove browser extension elements
            html = html.replace(/<input[^>]*__yoroi_connector[^>]*>/gi, '');
            html = html.replace(/<script[^>]*eternl-dom-script[^>]*>[\s\S]*?<\/script>/gi, '');
            html = html.replace(/<script[^>]*chrome-extension:\/\/[^>]*>[\s\S]*?<\/script>/gi, '');
            html = html.replace(/<grammarly-desktop-integration[^>]*>[\s\S]*?<\/grammarly-desktop-integration>/gi, '');
            html = html.replace(/<span[^>]*id="ctrlcCopy"[^>]*>[\s\S]*?<\/span>/gi, '');

            // Remove data attributes from extensions
            html = html.replace(/\s*data-new-gr-c-s-check-loaded="[^"]*"/g, '');
            html = html.replace(/\s*data-gr-ext-installed="[^"]*"/g, '');
            html = html.replace(/\s*data-grammarly-shadow-root="[^"]*"/g, '');

            // Remove site-editor styles that got injected
            html = html.replace(/<style>\s*\.site-editor-hover[\s\S]*?<\/style>/gi, '');

            // Clean up empty class attributes and extra whitespace in tags
            html = html.replace(/\sclass=""/g, '');
            html = html.replace(/\sclass="\s+"/g, '');
            html = html.replace(/\sstyle=""/g, '');

            // Fix crossorigin="" to crossorigin
            html = html.replace(/crossorigin=""/g, 'crossorigin');

            // Restore proper HTML entities
            html = html.replace(/&amp;/g, '&');

            return html;
        }

        async function loadSiteEditorHistory() {
            const container = document.getElementById('siteEditorHistoryList');

            try {
                const data = await supabaseQuery('proto_golf_requests', 'GET', null,
                    '?order=created_at.desc&limit=10');

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="color: var(--color-silver); font-size: 0.85rem;">No requests yet.</p>';
                    return;
                }

                siteEditorHistory = data;

                container.innerHTML = data.map(r => {
                    const time = new Date(r.created_at).toLocaleString();
                    const elementInfo = r.element_selector
                        ? `<div class="site-editor-history-item-element">${escapeHtml(r.element_selector.substring(0, 40))}</div>`
                        : '';
                    const statusBadge = (r.status === 'completed' || r.status === 'published')
                        ? '<span class="badge badge-success" style="font-size:0.7rem;">Live</span>'
                        : '<span class="badge badge-warning" style="font-size:0.7rem;">Pending</span>';

                    return `
                        <div class="site-editor-history-item">
                            <div class="site-editor-history-item-time">${time} ${statusBadge}</div>
                            ${elementInfo}
                            <div class="site-editor-history-item-request">${escapeHtml(r.request_text?.substring(0, 100) || '')}</div>
                        </div>
                    `;
                }).join('');

            } catch (e) {
                console.error('Failed to load history:', e);
                container.innerHTML = '<p style="color: var(--color-error); font-size: 0.85rem;">Failed to load history.</p>';
            }
        }

        function contactStu() {
            const page = document.getElementById('siteEditorPageSelect').value;
            const pageName = document.getElementById('siteEditorPageSelect').selectedOptions[0]?.text || page;
            const subject = encodeURIComponent(`Proto Golf Site Change Request - ${pageName}`);
            const body = encodeURIComponent(`Hi Stu,\n\nI'd like to request a change to the Proto Golf website.\n\nPage: ${pageName}\n\nWhat I need:\n[Describe your request here]\n\nThanks,\nRachel`);
            window.open(`mailto:stuart.hollinger@gmail.com?subject=${subject}&body=${body}`, '_blank');
        }
    </script>
</body>
</html>
