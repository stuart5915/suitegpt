<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- Clean up URL on suitegpt.app -->
    <script>
        if (window.location.hostname.includes('suitegpt.app') && window.location.pathname !== '/') {
            history.replaceState(null, '', '/');
        }
    </script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>SuiteGPT | Your Personal App Concierge</title>
    <meta name="description" content="Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers.">
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuiteGPT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    <link rel="manifest" href="/suitegpt-manifest.json">
    <link rel="apple-touch-icon" href="/assets/suitegpt-icon-192.png">

    <!-- Open Graph -->
    <meta property="og:title" content="SuiteGPT | Your Personal App Concierge">
    <meta property="og:description" content="Tell us what you need. We'll find it, change it, or build it for you.">
    <meta property="og:image" content="https://getsuite.app/assets/images/1200x630-getsuite.jpg">
    <meta property="og:url" content="https://getsuite.app/suitegpt.html">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link rel="stylesheet" href="/nav.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #0a0a0f;
            --bg-sidebar: #111118;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #ec4899;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --text-tertiary: rgba(248, 250, 252, 0.4);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* === MAIN LAYOUT === */
        .app-layout {
            display: flex;
            min-height: 100vh;
        }

        /* === LEFT SIDEBAR === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .sidebar-logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: contain;
        }

        .sidebar-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .sidebar-close-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-close-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .sidebar-close-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .bg-gradient.sidebar-collapsed {
            left: 0;
        }

        /* Show sidebar toggle when collapsed */
        .sidebar-open-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 200;
            transition: all 0.2s ease;
        }

        .sidebar-open-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .sidebar-open-btn.visible {
            display: flex;
        }

        .sidebar-open-btn svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 6px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            padding: 0 6px;
            margin-bottom: 8px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            max-width: 223px;
            text-align: left;
            font-family: inherit;
            height: 36px;
        }

        .sidebar-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .sidebar-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-item-icon svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-item-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 100px;
        }

        .sidebar-footer {
            padding: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
            margin-bottom: 12px;
        }

        .sidebar-profile-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .sidebar-profile-avatar svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-profile-info {
            flex: 1;
        }

        .sidebar-profile-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-profile-status {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .sidebar-profile-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sidebar-upgrade-btn {
            padding: 2px 8px;
            font-size: 0.65rem;
            font-weight: 600;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }

        .sidebar-upgrade-btn:hover {
            opacity: 0.9;
            transform: scale(1.02);
        }

        .sidebar-powered-by {
            text-align: center;
            padding: 8px;
        }

        .sidebar-powered-by a {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 0.75rem;
            transition: color 0.2s ease;
        }

        .sidebar-powered-by a:hover {
            color: var(--text-secondary);
        }

        .sidebar-powered-by strong {
            color: var(--accent-primary);
        }

        /* === MOBILE SIDEBAR === */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-sidebar);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 150;
            padding: 0 16px;
            align-items: center;
            gap: 12px;
        }

        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: var(--bg-card);
        }

        .mobile-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* === LOGGED OUT STATE === */
        body.logged-out .sidebar {
            display: none;
        }

        body.logged-out .sidebar-overlay {
            display: none !important;
        }

        body.logged-out .main-content {
            margin-left: 0;
        }

        body.logged-out .bg-gradient {
            left: 0;
        }

        body.logged-out .mobile-header {
            display: none !important;
        }

        /* Auth Header for logged-out state */
        .auth-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 200;
            padding: 0 24px;
            align-items: center;
            justify-content: space-between;
        }

        body.logged-out .auth-header {
            display: flex;
        }

        .auth-header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .auth-header-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 800;
            color: white;
        }

        .auth-header-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .auth-header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .auth-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .auth-btn-login {
            background: transparent;
            border: 1px solid var(--border-hover);
            color: var(--text-primary);
        }

        .auth-btn-login:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-secondary);
        }

        .auth-btn-signup {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .auth-btn-signup:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        body.logged-out .welcome-state {
            padding-top: 100px;
        }

        @media (max-width: 768px) {
            .auth-header {
                padding: 0 16px;
                height: 56px;
            }

            .auth-header-logo-text {
                display: none;
            }

            .auth-btn {
                padding: 8px 16px;
                font-size: 0.85rem;
            }

            body.logged-out .welcome-state {
                padding-top: 80px;
            }
        }

        /* === CONNECT MODAL === */
        .connect-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .connect-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .connect-modal {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .connect-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .connect-modal h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 1.2rem;
        }

        .connect-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .connect-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .connect-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .connect-option-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .connect-option.telegram .connect-option-icon {
            background: rgba(0, 136, 204, 0.2);
            color: #0088cc;
        }

        .connect-option-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .connect-option-desc {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .connect-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .connect-divider::before,
        .connect-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        /* === APPS PANEL === */
        .apps-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .apps-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .apps-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1001;
        }

        .apps-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .apps-panel-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .apps-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .apps-panel-search {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-search input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .apps-panel-search input::placeholder {
            color: var(--text-tertiary);
        }

        .apps-panel-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .apps-panel-grid {
            padding: 20px 24px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .apps-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.2s;
            text-decoration: none;
        }

        .apps-panel-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .apps-panel-item-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .apps-panel-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .apps-panel-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 4px;
            text-align: center;
        }

        .apps-panel-item-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-align: center;
            line-height: 1.3;
        }

        @media (max-width: 768px) {
            .apps-panel {
                width: 95%;
                max-height: 90vh;
            }

            .apps-panel-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
                padding: 16px;
            }

            .apps-panel-item {
                padding: 16px 12px;
            }

            .apps-panel-item-icon {
                width: 48px;
                height: 48px;
            }
        }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Background effects */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 50% 60% at 40% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(2%, -2%) rotate(1deg); }
            100% { transform: translate(1%, 2%) rotate(0.5deg); }
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
        }

        /* Hero/Welcome State */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.4s ease;
        }

        .welcome-state.chat-active {
            padding-top: 20px;
            justify-content: flex-start;
        }

        .welcome-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-state.chat-active .welcome-title {
            font-size: clamp(1.4rem, 3vw, 1.8rem);
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 480px;
        }

        .welcome-state.chat-active .welcome-subtitle {
            display: none;
        }

        /* Input Container */
        .input-container {
            width: 100%;
            max-width: 680px;
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 8px 8px 8px 24px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 1.05rem;
            font-family: inherit;
            color: var(--text-primary);
            outline: none;
            padding: 14px 0;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Quick Suggestions */
        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }

        .suggestion-chip {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .suggestion-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        /* Chat Container */
        .chat-container {
            width: 100%;
            max-width: 680px;
            margin: 0 auto;
            padding: 0 24px 40px;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 14px;
            max-width: 90%;
            animation: messageSlide 0.4s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            border: 1px solid var(--border-subtle);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
        }

        .message.assistant .message-avatar {
            background: var(--bg-card);
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.65;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 6px;
        }

        /* App Cards in Chat */
        .app-card-inline {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .app-card-inline:hover {
            background: rgba(99, 102, 241, 0.12);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .app-icon-inline {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            color: white;
        }

        .app-icon-inline img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        .app-icon-inline svg {
            width: 28px;
            height: 28px;
        }

        .app-info-inline h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .app-info-inline p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .app-arrow {
            margin-left: auto;
            width: 36px;
            height: 36px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .app-card-inline:hover .app-arrow {
            background: var(--accent-primary);
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 16px 20px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Feedback Buttons */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .feedback-btn {
            padding: 8px 14px;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feedback-btn:hover {
            background: var(--bg-card);
            border-color: var(--border-hover);
            color: var(--text-secondary);
        }

        .feedback-btn.active-good {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .feedback-btn.active-bad {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .quick-action-btn {
            padding: 10px 16px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.08);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        /* Use Cases Section */
        .use-cases-section {
            width: 100%;
            max-width: 900px;
            margin: 32px auto 0;
            padding: 0 24px;
        }

        .use-cases-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .use-cases-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .use-cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
        }

        .use-case-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .use-case-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .use-case-query {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .use-case-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .use-case-app {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .use-case-app-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: white;
        }

        .use-case-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .use-case-app-icon svg {
            width: 14px;
            height: 14px;
        }

        .use-case-app-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .use-case-helpful {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .use-case-helpful svg {
            width: 14px;
            height: 14px;
        }

        .intent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 100px;
            margin-bottom: 10px;
        }

        .intent-badge.problem { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .intent-badge.desire { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
        .intent-badge.idea { background: rgba(234, 179, 8, 0.15); color: #eab308; }
        .intent-badge.find { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .intent-badge.change { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .intent-badge.build { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

        /* Loading skeleton */
        .use-case-card.skeleton {
            pointer-events: none;
        }

        .skeleton-text {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === IMPORT MODAL === */
        .import-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .import-modal-overlay.active {
            display: flex;
        }

        .import-modal {
            background: linear-gradient(180deg, #151520 0%, #0d0d14 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .import-modal-header {
            padding: 28px 28px 0;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .import-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .import-modal-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-modal-close {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.2rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .import-modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .import-modal-body {
            padding: 28px;
        }

        .import-sources {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-source {
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-source:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-source.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .import-source-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .import-source-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .import-instructions {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-instructions h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-instructions ol {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding-left: 20px;
            line-height: 1.8;
        }

        .import-instructions code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .import-dropzone {
            border: 2px dashed var(--border-subtle);
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .import-dropzone:hover,
        .import-dropzone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .import-dropzone-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .import-dropzone h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-dropzone p {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .import-dropzone-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-file-input {
            display: none;
        }

        .import-privacy {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-privacy h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-privacy p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .import-consent {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .import-consent label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .import-consent input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        .import-progress {
            display: none;
            text-align: center;
            padding: 40px 24px;
        }

        .import-progress.active {
            display: block;
        }

        .import-progress-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .import-progress h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-progress p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .import-progress-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .import-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .import-results {
            display: none;
        }

        .import-results.active {
            display: block;
        }

        .import-results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .import-results-header .success-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .import-results-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .import-results-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-stat {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .import-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .import-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .import-insights {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .import-insights h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .import-insight-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .import-insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .import-insight-content h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-insight-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-recommendations {
            margin-bottom: 24px;
        }

        .import-recommendations h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-app-rec {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .import-app-rec:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .import-app-info h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-app-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .import-app-match {
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 100px;
        }

        .import-unmatched {
            margin-bottom: 24px;
        }

        .import-unmatched h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .unmatched-idea {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .unmatched-idea-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .unmatched-idea-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .unmatched-idea-category {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 100px;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .unmatched-idea-request {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            cursor: pointer;
        }

        .import-summary-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 8px;
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 10px;
            border-left: 3px solid var(--accent-primary);
        }

        .import-cta {
            display: flex;
            gap: 12px;
        }

        .import-cta-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
        }

        .import-cta-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .import-cta-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding-top: 56px;
            }

            .bg-gradient {
                left: 0;
            }

            .welcome-state {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: clamp(1.5rem, 6vw, 2rem);
            }

            .welcome-subtitle {
                font-size: 0.95rem;
                margin-bottom: 24px;
            }

            .chat-input-wrapper {
                padding: 6px 6px 6px 18px;
                border-radius: 16px;
            }

            .chat-input {
                font-size: 1rem;
                padding: 12px 0;
            }

            .send-btn {
                width: 46px;
                height: 46px;
                border-radius: 12px;
            }

            .quick-suggestions {
                gap: 6px;
            }

            .suggestion-chip {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .use-cases-section {
                padding: 0 16px;
            }

            .use-cases-grid {
                grid-template-columns: 1fr;
            }

            .chat-container {
                padding: 0 16px 30px;
            }

            .message {
                max-width: 95%;
            }

            .import-sources {
                grid-template-columns: 1fr;
            }

            .import-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

        /* PWA Install Prompt */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 16px;
            padding: 16px 20px;
            z-index: 200;
            max-width: 400px;
            width: calc(100% - 48px);
            animation: slideUp 0.3s ease;
        }

        .pwa-install-prompt.visible {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .pwa-install-icon {
            width: 32px;
            height: 32px;
            color: var(--accent-primary);
        }

        .pwa-install-icon svg {
            width: 100%;
            height: 100%;
        }

        .pwa-install-text h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .pwa-install-text p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .pwa-install-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .pwa-install-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .pwa-install-btn.primary {
            background: white;
            color: var(--accent-primary);
        }

        .pwa-install-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Hide main nav in this view */
        #main-nav {
            display: none !important;
        }
    </style>
</head>
<body>
    <!-- Auth Header (shown when logged out) -->
    <header class="auth-header" id="authHeader">
        <a href="https://getsuite.app" class="auth-header-logo">
            <div class="auth-header-logo-icon">S</div>
            <span class="auth-header-logo-text">SuiteGPT</span>
        </a>
        <div class="auth-header-buttons">
            <button class="auth-btn auth-btn-login" onclick="openLoginModal()">Log in</button>
            <button class="auth-btn auth-btn-signup" onclick="openSignupModal()">Sign up for free</button>
        </div>
    </header>

    <!-- Sidebar Open Button (shown when sidebar collapsed) -->
    <button class="sidebar-open-btn" id="sidebarOpenBtn" onclick="openSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18" stroke-linecap="round"/>
        </svg>
    </button>

    <!-- App Layout -->
    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <img src="/assets/suite-logo-new.png" alt="SUITE" class="sidebar-logo-icon">
                    <span class="sidebar-logo-text">SuiteGPT</span>
                </a>
                <button class="sidebar-close-btn" onclick="closeSidebar()" title="Close sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <button class="sidebar-item new-chat-btn" id="newChatBtn" onclick="startNewChat()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>New Chat</span>
                    </button>
                    <button class="sidebar-item" id="searchChatsBtn" onclick="toggleChatSearch()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>Search Chats</span>
                    </button>
                    <button class="sidebar-item" id="appsBtn">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                        </span>
                        <span>Apps</span>
                    </button>
                    <a href="/factory.html" class="sidebar-item">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>Your Apps/Projects</span>
                    </a>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Your chats</div>
                    <button class="sidebar-item" id="chatHistoryBtn">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>Chat History</span>
                    </button>
                    <button class="sidebar-item" id="myRequestsBtn">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>My Requests</span>
                        <span class="sidebar-item-badge" style="display: none;">0</span>
                    </button>
                    <button class="sidebar-item" id="importHistoryBtn">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>Import History</span>
                    </button>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="sidebar-profile">
                    <div class="sidebar-profile-avatar" id="sidebarAvatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="sidebar-profile-info">
                        <div class="sidebar-profile-name" id="sidebarProfileName">Guest</div>
                        <div class="sidebar-profile-row" id="sidebarProfileRow">
                            <span class="sidebar-profile-status" id="sidebarProfileStatus">Not signed in</span>
                            <button class="sidebar-upgrade-btn" id="sidebarUpgradeBtn" style="display: none;">Upgrade</button>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn"></button>
            <span class="mobile-title">SuiteGPT</span>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Background -->
            <div class="bg-gradient"></div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome State -->
                <section class="welcome-state" id="welcomeState">
                    <h1 class="welcome-title">What do you need?</h1>
                    <p class="welcome-subtitle">Describe your problem, and we'll find or build the solution.</p>

                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <input
                                type="text"
                                class="chat-input"
                                id="chatInput"
                                placeholder="I need help with..."
                                autocomplete="off"
                            >
                            <button class="send-btn" id="sendBtn" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Quick Suggestions -->
                        <div class="quick-suggestions">
                            <button class="suggestion-chip" data-query="I want to track my fitness">Fitness</button>
                            <button class="suggestion-chip" data-query="I can't sleep well at night">Sleep</button>
                            <button class="suggestion-chip" data-query="I want to build better habits">Habits</button>
                            <button class="suggestion-chip" data-query="I need help focusing at work">Focus</button>
                            <button class="suggestion-chip" data-query="I feel stressed and anxious">Stress</button>
                            <button class="suggestion-chip" data-query="I never drink enough water">Water</button>
                            <button class="suggestion-chip" data-query="I want to read more books">Reading</button>
                            <button class="suggestion-chip" data-query="I need date night ideas">Date</button>
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages" id="chatMessages"></div>
                    </div>

                    <!-- Use Cases Section -->
                    <div class="use-cases-section" id="useCasesSection">
                        <div class="use-cases-header">
                            <div class="use-cases-title">Example conversations <span id="useCaseCount"></span></div>
                        </div>
                        <div class="use-cases-grid" id="useCasesGrid">
                            <!-- Loading skeletons -->
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 90%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 70%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 40%;"></div>
                            </div>
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 85%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 60%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 45%;"></div>
                            </div>
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 80%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 65%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 35%;"></div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Import Modal -->
    <div class="import-modal-overlay" id="importModal">
        <div class="import-modal">
            <div class="import-modal-header">
                <div>
                    <h2>Import Your AI History</h2>
                    <p>Your conversations reveal what you actually need. Let us analyze them and recommend the perfect tools for you.</p>
                </div>
                <button class="import-modal-close" id="importModalClose">&times;</button>
            </div>

            <div class="import-modal-body">
                <!-- Step 1: Source Selection & Upload -->
                <div class="import-step import-step-upload" id="importStepUpload">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 16px;">Select your source</h4>

                    <div class="import-sources">
                        <div class="import-source selected" data-source="chatgpt">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">ChatGPT</div>
                        </div>
                        <div class="import-source" data-source="claude">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Claude</div>
                        </div>
                        <div class="import-source" data-source="gemini">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Gemini</div>
                        </div>
                    </div>

                    <div class="import-instructions" id="importInstructions">
                        <h4>How to export from ChatGPT</h4>
                        <ol>
                            <li>Go to <code>chat.openai.com</code></li>
                            <li>Click your profile then <strong>Settings</strong></li>
                            <li>Go to <strong>Data controls</strong></li>
                            <li>Click <strong>Export data</strong></li>
                            <li>Check your email for the download link</li>
                            <li>Upload the <code>conversations.json</code> file below</li>
                        </ol>
                    </div>

                    <div class="import-dropzone" id="importDropzone">
                        <div class="import-dropzone-icon"></div>
                        <h3>Drop your export file here</h3>
                        <p>or click to browse</p>
                        <button class="import-dropzone-btn">Choose File</button>
                        <input type="file" class="import-file-input" id="importFileInput" accept=".json,.zip">
                    </div>

                    <!-- Test mode option -->
                    <div style="text-align: center; margin-bottom: 16px;">
                        <button id="loadTestData" style="background: none; border: 1px dashed var(--border-subtle); padding: 10px 20px; border-radius: 8px; color: var(--text-tertiary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease;">
                            Load sample data to test the flow
                        </button>
                    </div>

                    <div class="import-privacy">
                        <h4>Your data, your choice</h4>
                        <p>We analyze your conversations to understand your needs. We extract themes and topics, not personal details.</p>
                        <div class="import-consent">
                            <label>
                                <input type="checkbox" id="consentAnalyze" checked>
                                <span>Analyze my chats for personalized recommendations</span>
                            </label>
                            <label>
                                <input type="checkbox" id="consentImprove" checked>
                                <span>Help improve SUITE by sharing anonymized insights</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Processing -->
                <div class="import-progress" id="importProgress">
                    <div class="import-progress-spinner"></div>
                    <h3>Analyzing your conversations...</h3>
                    <p id="importProgressText">Reading your chat history</p>
                    <div class="import-progress-bar">
                        <div class="import-progress-fill" id="importProgressFill"></div>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div class="import-results" id="importResults">
                    <div class="import-results-header">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke-linecap="round"/>
                                <polyline points="22 4 12 14.01 9 11.01" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>Analysis Complete!</h3>
                        <p>Here's what we learned about you</p>
                    </div>

                    <div class="import-stats">
                        <div class="import-stat">
                            <div class="import-stat-value" id="statConversations">0</div>
                            <div class="import-stat-label">Conversations</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statMessages">0</div>
                            <div class="import-stat-label">Messages</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statTopics">0</div>
                            <div class="import-stat-label">Topics Found</div>
                        </div>
                    </div>

                    <div class="import-insights">
                        <h4>Key Insights</h4>
                        <div id="insightsList"></div>
                    </div>

                    <div class="import-recommendations">
                        <h4>Matched to Existing Apps</h4>
                        <div id="recommendationsList"></div>
                    </div>

                    <div class="import-unmatched" id="importUnmatched" style="display: none;">
                        <h4>App Ideas We Can Build For You</h4>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 16px;">
                            These ideas from your chats don't match existing apps. Click to request!
                        </p>
                        <div id="unmatchedList"></div>
                    </div>

                    <div class="import-cta">
                        <button class="import-cta-btn secondary" id="importDone">Done</button>
                        <button class="import-cta-btn primary" id="importRequestCustom">Request Custom App</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div class="connect-modal-overlay" id="connectModalOverlay" onclick="if(event.target === this) closeConnectModal()">
        <div class="connect-modal">
            <button class="connect-modal-close" onclick="closeConnectModal()">&times;</button>
            <h3>Connect to SUITE</h3>
            <div class="connect-options">
                <div class="connect-option" onclick="connectWallet()">
                    <div class="connect-option-icon"></div>
                    <div>
                        <div class="connect-option-title">Connect Wallet</div>
                        <div class="connect-option-desc">Full access with credits</div>
                    </div>
                </div>
                <div class="connect-divider"><span>or</span></div>
                <div class="connect-option telegram" onclick="loginWithTelegram()">
                    <div class="connect-option-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                        </svg>
                    </div>
                    <div>
                        <div class="connect-option-title">Login with Telegram</div>
                        <div class="connect-option-desc">Quick access via Telegram</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Apps Panel -->
    <div class="apps-panel-overlay" id="appsPanelOverlay" onclick="if(event.target === this) closeAppsPanel()">
        <div class="apps-panel">
            <div class="apps-panel-header">
                <h2>All Apps</h2>
                <button class="apps-panel-close" onclick="closeAppsPanel()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="apps-panel-search">
                <input type="text" id="appsPanelSearch" placeholder="Search apps..." oninput="filterApps(this.value)">
            </div>
            <div class="apps-panel-grid" id="appsPanelGrid">
                <!-- Apps will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // ========================
        // AUTH STATE MANAGEMENT
        // ========================

        // Check for Telegram WebApp (Mini App) data
        function checkTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                const initData = webApp.initDataUnsafe;

                if (initData && initData.user) {
                    const user = initData.user;
                    const tgUser = {
                        id: user.id,
                        username: user.username || user.first_name,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        photo_url: user.photo_url,
                        auth_date: Math.floor(Date.now() / 1000),
                        from_webapp: true
                    };

                    localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                    console.log('Logged in via Telegram WebApp:', tgUser.username);

                    // Expand the WebApp to full height
                    webApp.expand();

                    return true;
                }
            }
            return false;
        }

        // Check if user is logged in
        function checkAuthState() {
            // First check if opened as Telegram WebApp
            checkTelegramWebApp();

            const wallet = localStorage.getItem('connectedWallet') ||
                          localStorage.getItem('walletAddress') ||
                          localStorage.getItem('suiteWalletAddress') ||
                          localStorage.getItem('suiteWallet');
            const telegramUserStr = localStorage.getItem('telegram_user');
            const telegramUser = telegramUserStr ? JSON.parse(telegramUserStr) : null;

            const isLoggedIn = !!(wallet || telegramUser);

            // Update sidebar profile
            const profileName = document.getElementById('sidebarProfileName');
            const profileStatus = document.getElementById('sidebarProfileStatus');
            const profileAvatar = document.getElementById('sidebarAvatar');
            const upgradeBtn = document.getElementById('sidebarUpgradeBtn');

            if (isLoggedIn) {
                document.body.classList.remove('logged-out');

                if (telegramUser) {
                    // Telegram user
                    const displayName = telegramUser.username || telegramUser.first_name || 'User';
                    if (profileName) profileName.textContent = displayName;
                    if (profileStatus) profileStatus.textContent = 'Free';
                    if (upgradeBtn) upgradeBtn.style.display = 'inline-block';
                    if (profileAvatar && telegramUser.photo_url) {
                        profileAvatar.innerHTML = `<img src="${telegramUser.photo_url}" alt="${displayName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    }
                } else if (wallet) {
                    // Wallet user
                    const shortWallet = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                    if (profileName) profileName.textContent = shortWallet;
                    if (profileStatus) profileStatus.textContent = 'Free';
                    if (upgradeBtn) upgradeBtn.style.display = 'inline-block';
                }
            } else {
                document.body.classList.add('logged-out');
                if (profileName) profileName.textContent = 'Guest';
                if (profileStatus) profileStatus.textContent = 'Not signed in';
                if (upgradeBtn) upgradeBtn.style.display = 'none';
                if (profileAvatar) {
                    profileAvatar.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>`;
                }
            }

            return isLoggedIn;
        }

        // Start a new chat
        function startNewChat() {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');

            // Clear chat
            if (chatMessages) chatMessages.innerHTML = '';

            // Reset conversation history
            if (typeof conversationHistory !== 'undefined') {
                conversationHistory = [];
            }

            // Reset UI to welcome state
            if (welcomeState) {
                welcomeState.classList.remove('chat-active');
            }
            if (useCasesSection) {
                useCasesSection.style.display = 'block';
            }
            if (chatInput) {
                chatInput.value = '';
                chatInput.focus();
            }

            // Close mobile sidebar if open
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebar = document.getElementById('sidebar');
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
            if (sidebar) sidebar.classList.remove('mobile-open');
        }

        // Toggle chat search (placeholder for future implementation)
        function toggleChatSearch() {
            // For now, focus the chat input and show a search hint
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.placeholder = 'Search your chats...';
                chatInput.focus();
                // Reset placeholder after a delay
                setTimeout(() => {
                    chatInput.placeholder = 'I need help with...';
                }, 3000);
            }
        }

        // Open login modal
        function openLoginModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Open signup modal (same as login)
        function openSignupModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Close connect modal
        function closeConnectModal() {
            document.getElementById('connectModalOverlay').classList.remove('active');
        }

        // Sidebar toggle functions
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('collapsed');
            document.querySelector('.main-content').classList.add('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.add('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.add('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'true');
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.remove('collapsed');
            document.querySelector('.main-content').classList.remove('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.remove('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.remove('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'false');
        }

        // Restore sidebar state on load
        if (localStorage.getItem('suitegpt_sidebar_collapsed') === 'true') {
            closeSidebar();
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const address = accounts[0];
                    localStorage.setItem('connectedWallet', address);
                    localStorage.setItem('suiteWalletAddress', address);
                    localStorage.setItem('suiteWallet', address);
                    window.walletAddress = address;

                    console.log('Wallet connected:', address);
                    closeConnectModal();
                    checkAuthState();

                    // Dispatch event for other components
                    window.dispatchEvent(new CustomEvent('navAuthChanged', { detail: { wallet: address } }));
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    console.log('Connection cancelled by user');
                }
            }
        }

        // Telegram login
        function loginWithTelegram() {
            const botId = '8341049569'; // SUITEHubBot
            const botUsername = 'SUITEHubBot';
            closeConnectModal();

            // Check if mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile: Open Telegram app directly to bot
                // User can tap the Menu button in bot to login via web app
                window.location.href = `tg://resolve?domain=${botUsername}&start=login`;

                // Fallback to t.me link if tg:// doesn't work
                setTimeout(() => {
                    window.location.href = `https://t.me/${botUsername}?start=login`;
                }, 500);
            } else {
                // On desktop: Use standard widget
                if (!window.Telegram || !window.Telegram.Login) {
                    const script = document.createElement('script');
                    script.src = 'https://telegram.org/js/telegram-widget.js?22';
                    script.onload = () => openTelegramAuth(botId);
                    document.head.appendChild(script);
                } else {
                    openTelegramAuth(botId);
                }
            }
        }

        function openTelegramAuth(botId) {
            window.Telegram.Login.auth(
                { bot_id: botId, request_access: true },
                (user) => {
                    if (user) {
                        const tgUser = {
                            id: user.id,
                            username: user.username || user.first_name,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            photo_url: user.photo_url,
                            auth_date: user.auth_date,
                            hash: user.hash
                        };

                        localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                        checkAuthState();
                        window.location.reload();
                    }
                }
            );
        }

        // Check auth state on page load
        checkAuthState();

        // Listen for auth changes
        window.addEventListener('storage', (e) => {
            if (['connectedWallet', 'walletAddress', 'suiteWalletAddress', 'telegram_user'].includes(e.key)) {
                checkAuthState();
            }
        });

        // Listen for custom auth events from nav component
        window.addEventListener('navAuthChanged', () => {
            checkAuthState();
        });

        // ========================
        // SUITE Apps Catalog
        // ========================
        const SUITE_APPS = {
            'foodvitals': {
                name: 'FoodVitals',
                description: 'Weekly meal tracking + AI nutrition insights',
                iconUrl: '/assets/icons/foodvitals-icon.jpg',
                iconBg: 'linear-gradient(135deg, #22c55e, #16a34a)',
                url: '/suite-shell.html?app=foodvitals'
            },
            'trueform': {
                name: 'TrueForm AI',
                description: 'AI physiotherapy and exercise guidance',
                iconUrl: '/assets/icons/trueform-icon.jpg',
                iconBg: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                url: '/suite-shell.html?app=trueform'
            },
            'opticrep': {
                name: 'OpticRep',
                description: 'AI workout trainer with form analysis',
                iconUrl: '/assets/icons/opticrep-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f97316, #ea580c)',
                url: '/suite-shell.html?app=opticrep'
            },
            'cheshbon': {
                name: 'Cheshbon',
                description: 'Financial reflection and tracking app',
                iconUrl: '/assets/icons/cheshbon-icon.jpg',
                iconBg: 'linear-gradient(135deg, #eab308, #ca8a04)',
                url: '/suite-shell.html?app=cheshbon'
            },
            'remcast': {
                name: 'RemCast',
                description: 'Smart reminder and notification system',
                iconUrl: '/assets/icons/remcast-icon.jpg',
                iconBg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                url: '/suite-shell.html?app=remcast'
            },
            'defi-knowledge': {
                name: 'DeFi Knowledge',
                description: 'Learn DeFi concepts and strategies',
                iconUrl: '/assets/icons/defiknowledge-icon.png',
                iconBg: 'linear-gradient(135deg, #06b6d4, #0891b2)',
                url: '/suite-shell.html?app=defiknowledge'
            },
            // Health & Wellness Apps
            'hydrotrack': {
                name: 'HydroTrack',
                description: 'Track your daily water intake',
                icon: '',
                iconBg: 'linear-gradient(135deg, #38bdf8, #0284c7)',
                url: '/hydrotrack.html'
            },
            'sleepwell': {
                name: 'SleepWell',
                description: 'AI sleep quality tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #818cf8, #4f46e5)',
                url: '/sleepwell.html'
            },
            'moodlog': {
                name: 'MoodLog',
                description: 'Track emotions, find patterns',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f472b6, #db2777)',
                url: '/moodlog.html'
            },
            'pillpal': {
                name: 'PillPal',
                description: 'Never miss a medication',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fb7185, #e11d48)',
                url: '/pillpal.html'
            },
            'breatheasy': {
                name: 'BreathEasy',
                description: 'Guided breathing exercises',
                icon: '',
                iconBg: 'linear-gradient(135deg, #5eead4, #14b8a6)',
                url: '/breatheasy.html'
            },
            'stepgoal': {
                name: 'StepGoal',
                description: 'Daily step counter & goals',
                icon: '',
                iconBg: 'linear-gradient(135deg, #a3e635, #65a30d)',
                url: '/stepgoal.html'
            },
            'stretchtimer': {
                name: 'StretchTimer',
                description: 'Desk break reminders',
                icon: '',
                iconBg: 'linear-gradient(135deg, #c084fc, #9333ea)',
                url: '/stretchtimer.html'
            },
            // Productivity & Learning Apps
            'focusflow': {
                name: 'FocusFlow',
                description: 'Pomodoro timer with stats',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f97316, #c2410c)',
                url: '/focusflow.html'
            },
            'quickbudget': {
                name: 'QuickBudget',
                description: 'Simple expense tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #4ade80, #16a34a)',
                url: '/quickbudget.html'
            },
            'flashmind': {
                name: 'FlashMind',
                description: 'AI-powered flashcards',
                icon: '',
                iconBg: 'linear-gradient(135deg, #60a5fa, #2563eb)',
                url: '/flashmind.html'
            },
            'bookshelf': {
                name: 'BookShelf',
                description: 'Track books & reading goals',
                icon: '',
                iconBg: 'linear-gradient(135deg, #a78bfa, #7c3aed)',
                url: '/bookshelf.html'
            },
            'skilltree': {
                name: 'SkillTree',
                description: 'Track learning progress',
                icon: '',
                iconBg: 'linear-gradient(135deg, #34d399, #059669)',
                url: '/skilltree.html'
            },
            'mealprep': {
                name: 'MealPrep',
                description: 'Weekly meal planner',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fbbf24, #d97706)',
                url: '/mealprep.html'
            },
            'cleanhome': {
                name: 'CleanHome',
                description: 'Cleaning schedule & tasks',
                icon: '',
                iconBg: 'linear-gradient(135deg, #2dd4bf, #0d9488)',
                url: '/cleanhome.html'
            },
            // Lifestyle & Social Apps
            'datenight': {
                name: 'DateNight',
                description: 'Date ideas & planning',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fb7185, #be123c)',
                url: '/datenight.html'
            },
            'petcare': {
                name: 'PetCare',
                description: 'Pet health & care tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fdba74, #ea580c)',
                url: '/petcare.html'
            },
            'packlight': {
                name: 'PackLight',
                description: 'Smart packing lists',
                icon: '',
                iconBg: 'linear-gradient(135deg, #93c5fd, #1d4ed8)',
                url: '/packlight.html'
            },
            'giftguru': {
                name: 'GiftGuru',
                description: 'Gift ideas & tracking',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f0abfc, #a855f7)',
                url: '/giftguru.html'
            },
            'habitstack': {
                name: 'HabitStack',
                description: 'Chain habits together',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fcd34d, #b45309)',
                url: '/habitstack.html'
            },
            'quickdecide': {
                name: 'QuickDecide',
                description: 'Decision helper & coin flip',
                icon: '',
                iconBg: 'linear-gradient(135deg, #67e8f9, #0891b2)',
                url: '/quickdecide.html'
            }
        };

        // ========================
        // APPS PANEL FUNCTIONALITY
        // ========================
        function openAppsPanel() {
            const overlay = document.getElementById('appsPanelOverlay');
            const grid = document.getElementById('appsPanelGrid');

            // Populate apps grid
            grid.innerHTML = '';
            Object.entries(SUITE_APPS).forEach(([key, app]) => {
                const item = document.createElement('div');
                item.className = 'apps-panel-item';
                item.dataset.name = app.name.toLowerCase();
                item.dataset.desc = app.description.toLowerCase();
                item.onclick = () => launchApp(app.url, app.name);

                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';

                item.innerHTML = `
                    <div class="apps-panel-item-icon" style="background: ${app.iconBg}">
                        ${iconHtml}
                    </div>
                    <div class="apps-panel-item-name">${app.name}</div>
                    <div class="apps-panel-item-desc">${app.description}</div>
                `;
                grid.appendChild(item);
            });

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';

            // Focus search input
            setTimeout(() => {
                document.getElementById('appsPanelSearch').focus();
            }, 100);
        }

        function closeAppsPanel() {
            const overlay = document.getElementById('appsPanelOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            document.getElementById('appsPanelSearch').value = '';
        }

        function filterApps(query) {
            const items = document.querySelectorAll('.apps-panel-item');
            const lower = query.toLowerCase();

            items.forEach(item => {
                const name = item.dataset.name;
                const desc = item.dataset.desc;
                const matches = name.includes(lower) || desc.includes(lower);
                item.style.display = matches ? '' : 'none';
            });
        }

        function launchApp(url, name) {
            closeAppsPanel();
            // Open in new tab for now - could embed in iframe later
            window.open(url, '_blank');
        }

        // Apps button click handler
        document.addEventListener('DOMContentLoaded', () => {
            const appsBtn = document.getElementById('appsBtn');
            if (appsBtn) {
                appsBtn.addEventListener('click', openAppsPanel);
            }
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const overlay = document.getElementById('appsPanelOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeAppsPanel();
                }
            }
        });

        // Supabase config
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // DOM Elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeState = document.getElementById('welcomeState');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const useCasesGrid = document.getElementById('useCasesGrid');
        const useCasesSection = document.getElementById('useCasesSection');
        const useCaseCount = document.getElementById('useCaseCount');

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const importHistoryBtn = document.getElementById('importHistoryBtn');
        const myRequestsBtn = document.getElementById('myRequestsBtn');
        const chatHistoryBtn = document.getElementById('chatHistoryBtn');

        // State
        let isLoading = false;
        let conversationHistory = [];
        let useCases = [];
        let currentIntent = 'all';

        // Mobile sidebar toggle
        mobileMenuBtn.addEventListener('click', () => {
            sidebar.classList.toggle('open');
            sidebarOverlay.classList.toggle('active');
        });

        sidebarOverlay.addEventListener('click', () => {
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Sidebar navigation
        importHistoryBtn.addEventListener('click', () => {
            document.getElementById('importModal').classList.add('active');
            resetImportModal();
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        myRequestsBtn.addEventListener('click', () => {
            alert('My Requests feature coming soon!');
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        chatHistoryBtn.addEventListener('click', () => {
            alert('Chat History feature coming soon!');
            sidebar.classList.remove('open');
            sidebarOverlay.classList.remove('active');
        });

        // Load use cases from Supabase
        async function loadUseCases() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/use_cases?is_visible=eq.true&order=helpful_count.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    useCases = await response.json();
                    renderUseCases();
                } else {
                    useCases = getHardcodedUseCases();
                    renderUseCases();
                }
            } catch (error) {
                console.error('Failed to load use cases:', error);
                useCases = getHardcodedUseCases();
                renderUseCases();
            }
        }

        // Hardcoded fallback
        function getHardcodedUseCases() {
            return [
                // Original use cases
                { query: "I can't focus at work anymore", response: "FocusFlow uses the Pomodoro technique to help you concentrate in focused sprints.", recommended_app: "focusflow", intent: "problems", helpful_count: 58 },
                { query: "I have back pain from sitting all day", response: "StretchTimer reminds you to take breaks and suggests desk stretches.", recommended_app: "stretchtimer", intent: "problems", helpful_count: 56 },
                { query: "I want to become financially free", response: "Start by tracking where your money goes with QuickBudget.", recommended_app: "quickbudget", intent: "desires", helpful_count: 89 },
                { query: "I want to get healthier without obsessing", response: "FoodVitals takes a gentle approach - weekly reflections instead of daily tracking.", recommended_app: "foodvitals", intent: "desires", helpful_count: 67 },
                { query: "Show me what apps you have for fitness", response: "We've got OpticRep (AI workout trainer), StepGoal (walking), and TrueForm AI (physio).", recommended_app: "opticrep", intent: "find", helpful_count: 61 },
                { query: "How can I make money building apps?", response: "With SUITE, you build apps and earn from every user through our credit system.", recommended_app: null, intent: "build", helpful_count: 94 },
                // Health & Wellness
                { query: "I never drink enough water", response: "HydroTrack makes it easy - just tap to log each glass and watch your progress.", recommended_app: "hydrotrack", intent: "problems", helpful_count: 72 },
                { query: "I can't sleep well at night", response: "SleepWell helps you track sleep patterns and find what works for you.", recommended_app: "sleepwell", intent: "problems", helpful_count: 68 },
                { query: "I feel anxious all the time", response: "MoodLog helps you track emotions and spot patterns. BreathEasy has calming exercises.", recommended_app: "moodlog", intent: "problems", helpful_count: 81 },
                { query: "I keep forgetting my vitamins", response: "PillPal tracks all your medications and helps you never miss a dose.", recommended_app: "pillpal", intent: "problems", helpful_count: 65 },
                { query: "I need to calm down right now", response: "BreathEasy has guided 4-7-8 and box breathing exercises to help you relax.", recommended_app: "breatheasy", intent: "problems", helpful_count: 77 },
                { query: "I want to walk more", response: "StepGoal lets you set daily targets and track your progress over time.", recommended_app: "stepgoal", intent: "desires", helpful_count: 59 },
                // Productivity & Learning
                { query: "I procrastinate too much", response: "FocusFlow's Pomodoro timer helps you work in focused bursts with built-in breaks.", recommended_app: "focusflow", intent: "problems", helpful_count: 84 },
                { query: "Where does all my money go?", response: "QuickBudget tracks your expenses by category so you can see exactly where it goes.", recommended_app: "quickbudget", intent: "problems", helpful_count: 79 },
                { query: "I need to study for an exam", response: "FlashMind creates flashcards with spaced repetition to help you memorize.", recommended_app: "flashmind", intent: "problems", helpful_count: 71 },
                { query: "I want to read more books", response: "BookShelf tracks your reading list, progress, and helps you hit your goals.", recommended_app: "bookshelf", intent: "desires", helpful_count: 63 },
                { query: "I want to learn a new skill", response: "SkillTree breaks skills into milestones and tracks your progress visually.", recommended_app: "skilltree", intent: "desires", helpful_count: 66 },
                { query: "I never know what to cook", response: "MealPrep helps you plan your whole week and generates a shopping list.", recommended_app: "mealprep", intent: "problems", helpful_count: 74 },
                { query: "My house is always messy", response: "CleanHome creates a cleaning schedule so you know exactly what to do when.", recommended_app: "cleanhome", intent: "problems", helpful_count: 62 },
                // Lifestyle & Social
                { query: "I need date night ideas", response: "DateNight has tons of ideas - romantic, budget-friendly, adventurous, or at-home.", recommended_app: "datenight", intent: "desires", helpful_count: 69 },
                { query: "I need to track my pet's vet visits", response: "PetCare keeps track of all your pet's health info, feeding, and appointments.", recommended_app: "petcare", intent: "problems", helpful_count: 57 },
                { query: "I always forget things when traveling", response: "PackLight generates packing lists based on your trip type and duration.", recommended_app: "packlight", intent: "problems", helpful_count: 73 },
                { query: "I never know what gift to buy", response: "GiftGuru helps you track gift ideas for everyone and never forget a birthday.", recommended_app: "giftguru", intent: "problems", helpful_count: 64 },
                { query: "I want to build better habits", response: "HabitStack lets you chain habits together and track your streaks.", recommended_app: "habitstack", intent: "desires", helpful_count: 82 },
                { query: "I can't decide between options", response: "QuickDecide has a random picker, coin flip, and pro/con lists to help you choose.", recommended_app: "quickdecide", intent: "problems", helpful_count: 55 }
            ];
        }

        // Render use cases
        function renderUseCases() {
            if (!useCasesGrid) return;

            const filtered = currentIntent === 'all'
                ? useCases
                : useCases.filter(uc => uc.intent === currentIntent);

            if (useCaseCount) useCaseCount.textContent = `(${filtered.length})`;

            const intentStyles = {
                'problems': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>', label: 'Problem', class: 'problem' },
                'desires': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>', label: 'Desire', class: 'desire' },
                'ideas': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', label: 'Idea', class: 'idea' },
                'find': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>', label: 'Find', class: 'find' },
                'change': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>', label: 'Change', class: 'change' },
                'build': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>', label: 'Build', class: 'build' }
            };

            useCasesGrid.innerHTML = filtered.map(uc => {
                const app = SUITE_APPS[uc.recommended_app] || {};
                const intentInfo = intentStyles[uc.intent] || intentStyles['find'];

                return `
                    <div class="use-case-card" data-query="${encodeURIComponent(uc.query)}" data-response="${encodeURIComponent(uc.response)}" data-app="${uc.recommended_app || ''}">
                        <span class="intent-badge ${intentInfo.class}">
                            <span>${intentInfo.icon}</span>
                            <span>${intentInfo.label}</span>
                        </span>
                        <div class="use-case-query">"${uc.query}"</div>
                        <div class="use-case-meta">
                            <div class="use-case-app">
                                ${uc.recommended_app ? `
                                    <div class="use-case-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                                    <span class="use-case-app-name">${app.name || 'Custom App'}</span>
                                ` : `
                                    <div class="use-case-app-icon" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                                    <span class="use-case-app-name">Custom / Build & Earn</span>
                                `}
                            </div>
                            <div class="use-case-helpful">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                                ${uc.helpful_count || 0}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers - each click starts a fresh chat
            document.querySelectorAll('.use-case-card').forEach(card => {
                card.addEventListener('click', () => {
                    const query = decodeURIComponent(card.dataset.query);
                    const response = decodeURIComponent(card.dataset.response);
                    const app = card.dataset.app;

                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    welcomeState.classList.add('chat-active');
                    chatContainer.classList.add('active');
                    addMessage(query, 'user');
                    addMessage(response, 'assistant', app);
                    conversationHistory.push({ role: 'user', content: query });
                    conversationHistory.push({ role: 'assistant', content: response });
                });
            });
        }

        // Enable/disable send button
        chatInput.addEventListener('input', () => {
            sendBtn.disabled = !chatInput.value.trim() || isLoading;
        });

        // Send on Enter
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // Quick suggestion chips - each click starts a fresh chat
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const query = chip.dataset.query;
                if (query) {
                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    chatInput.value = query;
                    sendMessage();
                }
            });
        });

        // Add message to chat
        function addMessage(content, role, appRecommendation = null, userQuery = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');

            if (appRecommendation && SUITE_APPS[appRecommendation]) {
                const app = SUITE_APPS[appRecommendation];
                const appCard = document.createElement('a');
                appCard.href = app.url;
                appCard.className = 'app-card-inline';
                appCard.innerHTML = `
                    <div class="app-icon-inline" style="background: ${app.iconBg}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                    <div class="app-info-inline">
                        <h4>${app.name}</h4>
                        <p>${app.description}</p>
                    </div>
                    <span class="app-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                `;
                contentDiv.appendChild(appCard);

                const quickActionsDiv = document.createElement('div');
                quickActionsDiv.className = 'quick-actions';
                quickActionsDiv.innerHTML = `
                    <button class="quick-action-btn" data-action="use-case" data-app="${appRecommendation}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
                        How does this help?
                    </button>
                    <button class="quick-action-btn primary" data-action="open" data-app="${appRecommendation}" data-url="${app.url}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                        Open ${app.name}
                    </button>
                `;
                contentDiv.appendChild(quickActionsDiv);

                quickActionsDiv.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleQuickAction(btn.dataset.action, btn.dataset.app, btn.dataset.url, userQuery));
                });
            }

            if (role === 'assistant' && !appRecommendation) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons';
                feedbackDiv.innerHTML = `
                    <button class="feedback-btn" data-feedback="good"> Helpful</button>
                    <button class="feedback-btn" data-feedback="bad"> Not helpful</button>
                `;
                contentDiv.appendChild(feedbackDiv);

                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        feedbackDiv.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('active-good', 'active-bad'));
                        btn.classList.add(btn.dataset.feedback === 'good' ? 'active-good' : 'active-bad');
                    });
                });
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle quick action button clicks
        function handleQuickAction(action, appId, url, originalQuery) {
            const app = SUITE_APPS[appId];
            if (!app) return;

            switch (action) {
                case 'use-case':
                    const useCaseQuery = `Tell me specifically how ${app.name} can help with my situation`;
                    addMessage(useCaseQuery, 'user');
                    conversationHistory.push({ role: 'user', content: useCaseQuery });
                    addTypingIndicator();

                    setTimeout(() => {
                        removeTypingIndicator();
                        const response = getUseCaseResponse(app, originalQuery);
                        addMessage(response, 'assistant');
                        conversationHistory.push({ role: 'assistant', content: response });
                    }, 1200);
                    break;

                case 'open':
                    window.location.href = url;
                    break;
            }
        }

        function getUseCaseResponse(app, originalQuery) {
            const responses = {
                'foodvitals': `Here's how FoodVitals specifically helps you:\n\n1. **Weekly Check-ins, Not Daily Logging** - Less pressure, more sustainable.\n\n2. **AI-Powered Insights** - Personalized suggestions based on YOUR habits.\n\n3. **No Calorie Counting** - Focus on how food makes you feel.\n\nWant to try it?`,
                'trueform': `Here's how TrueForm AI specifically helps you:\n\n1. **AI Posture Assessment** - Use your camera to analyze your posture.\n\n2. **Personalized Stretching Routines** - Based on YOUR specific issues.\n\n3. **Form Correction in Real-Time** - The AI watches and corrects you.\n\nReady to start?`,
                'opticrep': `Here's how OpticRep specifically helps you:\n\n1. **AI Rep Counter** - Automatically counts your reps using your camera.\n\n2. **Form Analysis** - Real-time feedback on your exercise form.\n\n3. **Workout Programs** - AI-generated programs based on your goals.\n\nWant to start your first workout?`,
                'cheshbon': `Here's how Cheshbon specifically helps you:\n\n1. **Reflection, Not Restriction** - Weekly prompts about how you FEEL about spending.\n\n2. **Pattern Recognition** - Identifies emotional spending triggers.\n\n3. **Values Alignment** - See if your spending matches what you care about.\n\nReady to start?`,
                'remcast': `Here's how RemCast specifically helps you:\n\n1. **Smart Reminders** - Learns when you're most likely to act.\n\n2. **Gentle Habit Building** - No streaks or guilt.\n\n3. **Routine Builder** - Chain habits together.\n\nReady to build better habits?`,
                'defi-knowledge': `Here's how DeFi Knowledge specifically helps you:\n\n1. **Structured Learning Path** - From basics to advanced.\n\n2. **No Shill, Just Education** - We teach concepts, not promote protocols.\n\n3. **Interactive Simulations** - Practice without risking real money.\n\nReady to start learning?`,
                // Health & Wellness
                'hydrotrack': `Here's how HydroTrack specifically helps you:\n\n1. **Simple One-Tap Logging** - Just tap to add a glass of water.\n\n2. **Visual Progress** - See your daily progress with a satisfying progress ring.\n\n3. **Streak Tracking** - Build consistency with daily streaks.\n\nReady to stay hydrated?`,
                'sleepwell': `Here's how SleepWell specifically helps you:\n\n1. **Sleep Quality Tracking** - Log bedtime, wake time, and rate your rest.\n\n2. **Pattern Recognition** - See weekly averages and spot trends.\n\n3. **Personalized Tips** - Get suggestions based on your sleep patterns.\n\nReady to sleep better?`,
                'moodlog': `Here's how MoodLog specifically helps you:\n\n1. **Quick Mood Check-ins** - 5 simple moods to choose from.\n\n2. **Calendar View** - See your emotional patterns over time.\n\n3. **Optional Notes** - Add context when you need to.\n\nReady to understand your emotions better?`,
                'pillpal': `Here's how PillPal specifically helps you:\n\n1. **Medication Schedules** - Set up all your meds with their times.\n\n2. **Check-off System** - Mark when you've taken each dose.\n\n3. **Streak Tracking** - Stay consistent with visual progress.\n\nReady to never miss a dose?`,
                'breatheasy': `Here's how BreathEasy specifically helps you:\n\n1. **Guided Breathing** - 4-7-8 and box breathing animations.\n\n2. **Visual Guides** - Watch the circle expand and contract.\n\n3. **Session Options** - Choose 1-5 minute sessions.\n\nReady to feel calmer?`,
                'stepgoal': `Here's how StepGoal specifically helps you:\n\n1. **Daily Goal Setting** - Set your target steps.\n\n2. **Manual Entry** - Log steps easily without a fitness tracker.\n\n3. **Weekly Charts** - Track your progress over time.\n\nReady to move more?`,
                'stretchtimer': `Here's how StretchTimer specifically helps you:\n\n1. **Break Reminders** - Set intervals (30/45/60 min).\n\n2. **Stretch Suggestions** - Get quick stretches when the timer hits.\n\n3. **Daily Tracking** - See how many breaks you've taken.\n\nReady to take better care of yourself at work?`,
                // Productivity & Learning
                'focusflow': `Here's how FocusFlow specifically helps you:\n\n1. **Pomodoro Technique** - 25 min work, 5 min break by default.\n\n2. **Session Counter** - Track your focus sessions.\n\n3. **Customizable** - Adjust durations to fit your style.\n\nReady to focus better?`,
                'quickbudget': `Here's how QuickBudget specifically helps you:\n\n1. **Quick Expense Entry** - Amount, category, done.\n\n2. **Category Breakdown** - See where your money goes.\n\n3. **Budget Limits** - Set monthly limits and track against them.\n\nReady to take control of your spending?`,
                'flashmind': `Here's how FlashMind specifically helps you:\n\n1. **Create Decks** - Organize flashcards by topic.\n\n2. **Flip Animation** - Study with satisfying card flips.\n\n3. **Spaced Repetition** - Cards you struggle with appear more often.\n\nReady to study smarter?`,
                'bookshelf': `Here's how BookShelf specifically helps you:\n\n1. **Track Your Books** - Want to Read, Reading, Finished.\n\n2. **Page Progress** - See how far you are in each book.\n\n3. **Reading Stats** - Track books per month.\n\nReady to read more?`,
                'skilltree': `Here's how SkillTree specifically helps you:\n\n1. **Add Skills** - List what you want to learn.\n\n2. **Set Milestones** - Break skills into achievable steps.\n\n3. **Track Progress** - Visual progress bars keep you motivated.\n\nReady to level up your skills?`,
                'mealprep': `Here's how MealPrep specifically helps you:\n\n1. **Weekly Grid** - Plan breakfast, lunch, dinner for 7 days.\n\n2. **Favorite Meals** - Save meals you make often.\n\n3. **Shopping List** - Auto-generate from your meal plan.\n\nReady to simplify meal planning?`,
                'cleanhome': `Here's how CleanHome specifically helps you:\n\n1. **Add Rooms** - Set up areas to clean.\n\n2. **Set Frequency** - Daily, weekly, or monthly tasks.\n\n3. **Overdue Alerts** - See what needs attention.\n\nReady for a cleaner home?`,
                // Lifestyle & Social
                'datenight': `Here's how DateNight specifically helps you:\n\n1. **Random Ideas** - Get surprise date suggestions.\n\n2. **Categories** - Romantic, Adventure, Budget, Home.\n\n3. **History** - Track dates you've done together.\n\nReady for your next date?`,
                'petcare': `Here's how PetCare specifically helps you:\n\n1. **Pet Profiles** - Add all your pets with details.\n\n2. **Activity Logging** - Track feeding, walks, vet visits.\n\n3. **Reminders** - Never miss important pet care.\n\nReady to be a better pet parent?`,
                'packlight': `Here's how PackLight specifically helps you:\n\n1. **Trip Templates** - Beach, Business, Winter, Camping.\n\n2. **Auto-Generate Lists** - Based on trip type and duration.\n\n3. **Check Items Off** - Know exactly what's packed.\n\nReady for stress-free packing?`,
                'giftguru': `Here's how GiftGuru specifically helps you:\n\n1. **People Profiles** - Store interests, sizes, preferences.\n\n2. **Gift Ideas** - Track ideas for each person.\n\n3. **Status Tracking** - Bought, wrapped, given.\n\nReady to nail gift-giving?`,
                'habitstack': `Here's how HabitStack specifically helps you:\n\n1. **Chain Habits** - Link habits in sequence.\n\n2. **Streak Counter** - Don't break the chain!\n\n3. **Morning/Evening Routines** - Build powerful routines.\n\nReady to build lasting habits?`,
                'quickdecide': `Here's how QuickDecide specifically helps you:\n\n1. **Random Picker** - Add options and let fate decide.\n\n2. **Coin Flip** - Simple yes/no decisions.\n\n3. **Pro/Con Lists** - Think it through when needed.\n\nReady to stop overthinking?`
            };

            return responses[app.id] || `${app.name} is designed to help with exactly what you described. Let me know if you want to dive deeper!`;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isLoading) return;

            const userQuery = message;

            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            addTypingIndicator();

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/suitegpt-chat`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        message: message,
                        history: conversationHistory.slice(-10)
                    })
                });

                removeTypingIndicator();

                if (!response.ok) throw new Error('Failed');

                const data = await response.json();
                addMessage(data.response, 'assistant', data.recommendedApp, userQuery);
                conversationHistory.push({ role: 'assistant', content: data.response });

            } catch (error) {
                removeTypingIndicator();
                const fallback = getLocalResponse(message);
                addMessage(fallback.response, 'assistant', fallback.recommendedApp, userQuery);
                conversationHistory.push({ role: 'assistant', content: fallback.response });
            }

            isLoading = false;
            sendBtn.disabled = !chatInput.value.trim();
            chatInput.focus();
        }

        function getLocalResponse(message) {
            const keywords = {
                'foodvitals': ['nutrition', 'diet', 'calories', 'food', 'meals', 'weight', 'eating', 'healthy'],
                'trueform': ['back pain', 'posture', 'stretching', 'physical therapy', 'mobility', 'pain', 'sitting'],
                'opticrep': ['workout', 'gym', 'fitness', 'exercise', 'training', 'muscle', 'strength'],
                'cheshbon': ['money', 'finance', 'budget', 'spending', 'savings', 'financial'],
                'remcast': ['reminder', 'routine', 'morning', 'habits', 'schedule', 'notification'],
                'defi-knowledge': ['defi', 'crypto', 'blockchain', 'yield', 'trading'],
                // Health & Wellness
                'hydrotrack': ['water', 'hydration', 'thirsty', 'drink', 'dehydrated', 'glasses'],
                'sleepwell': ['sleep', 'insomnia', 'tired', 'rest', 'bedtime', 'wake up', 'fatigue'],
                'moodlog': ['mood', 'anxiety', 'stressed', 'mental health', 'depression', 'emotions', 'feelings'],
                'pillpal': ['medication', 'pills', 'vitamins', 'medicine', 'prescription', 'supplements'],
                'breatheasy': ['breathing', 'panic', 'calm', 'relax', 'meditation', 'stress relief', 'anxious'],
                'stepgoal': ['steps', 'walking', 'sedentary', 'move more', 'pedometer', '10000 steps'],
                'stretchtimer': ['desk', 'breaks', 'sitting too much', 'neck pain', 'computer', 'office'],
                // Productivity & Learning
                'focusflow': ['focus', 'concentrate', 'procrastinate', 'pomodoro', 'distracted', 'productivity'],
                'quickbudget': ['expenses', 'track spending', 'where my money', 'budget tracker', 'bills'],
                'flashmind': ['study', 'memorize', 'flashcards', 'exam', 'learn language', 'vocabulary'],
                'bookshelf': ['read', 'books', 'reading list', 'book tracker', 'library'],
                'skilltree': ['learn', 'skill', 'improve', 'progress', 'guitar', 'coding', 'new skill'],
                'mealprep': ['cook', 'meal plan', 'dinner ideas', 'recipe', 'what to eat', 'weekly meals'],
                'cleanhome': ['clean', 'messy', 'chores', 'housework', 'tidying', 'cleaning schedule'],
                // Lifestyle & Social
                'datenight': ['date', 'romantic', 'couple', 'date ideas', 'date night', 'anniversary'],
                'petcare': ['pet', 'dog', 'cat', 'vet', 'pet health', 'animal', 'feeding schedule'],
                'packlight': ['pack', 'travel', 'trip', 'packing list', 'vacation', 'luggage', 'forget'],
                'giftguru': ['gift', 'present', 'birthday', 'christmas', 'what to buy', 'gift ideas'],
                'habitstack': ['habit', 'routine', 'daily habit', 'streak', 'habit chain', 'build habits'],
                'quickdecide': ['decide', 'choice', 'flip coin', 'can\'t choose', 'which one', 'decision']
            };

            const lower = message.toLowerCase();
            let matchedApp = null;

            for (const [app, words] of Object.entries(keywords)) {
                if (words.some(w => lower.includes(w))) {
                    matchedApp = app;
                    break;
                }
            }

            if (matchedApp) {
                const appData = SUITE_APPS[matchedApp];
                return {
                    response: `${appData.name} is perfect for this!\n\n${appData.description}.`,
                    recommendedApp: matchedApp
                };
            }

            return {
                response: `We don't have an app for that yet, but we can build one!\n\nAI Fleet creates custom apps in 1-12 hours. Just describe:\n What problem you're solving\n Key features you need\n\nWant me to start a request?`,
                recommendedApp: null
            };
        }

        // Initialize
        loadUseCases();

        // ============================================
        // CHAT IMPORT FEATURE
        // ============================================

        const importModal = document.getElementById('importModal');
        const importModalClose = document.getElementById('importModalClose');
        const importSources = document.querySelectorAll('.import-source');
        const importInstructions = document.getElementById('importInstructions');
        const importDropzone = document.getElementById('importDropzone');
        const importFileInput = document.getElementById('importFileInput');
        const importStepUpload = document.getElementById('importStepUpload');
        const importProgress = document.getElementById('importProgress');
        const importProgressText = document.getElementById('importProgressText');
        const importProgressFill = document.getElementById('importProgressFill');
        const importResults = document.getElementById('importResults');
        const importDone = document.getElementById('importDone');
        const importRequestCustom = document.getElementById('importRequestCustom');

        let selectedSource = 'chatgpt';
        let analysisResults = null;

        const sourceInstructions = {
            chatgpt: {
                icon: '',
                title: 'How to export from ChatGPT',
                steps: [
                    'Go to <code>chat.openai.com</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Data controls</strong>',
                    'Click <strong>Export data</strong>',
                    'Check your email for the download link',
                    'Upload the <code>conversations.json</code> file below'
                ]
            },
            claude: {
                icon: '',
                title: 'How to export from Claude',
                steps: [
                    'Go to <code>claude.ai</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Account</strong> tab',
                    'Click <strong>Export Data</strong>',
                    'Download the JSON file',
                    'Upload it below'
                ]
            },
            gemini: {
                icon: '',
                title: 'How to export from Gemini',
                steps: [
                    'Go to <code>takeout.google.com</code>',
                    'Deselect all, then select <strong>Gemini Apps</strong>',
                    'Click <strong>Next step</strong>  <strong>Create export</strong>',
                    'Download when ready',
                    'Extract and upload the conversations JSON'
                ]
            }
        };

        importModalClose.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                importModal.classList.remove('active');
            }
        });

        importSources.forEach(source => {
            source.addEventListener('click', () => {
                importSources.forEach(s => s.classList.remove('selected'));
                source.classList.add('selected');
                selectedSource = source.dataset.source;
                updateInstructions();
            });
        });

        function updateInstructions() {
            const instructions = sourceInstructions[selectedSource];
            importInstructions.innerHTML = `
                <h4>${instructions.icon} ${instructions.title}</h4>
                <ol>
                    ${instructions.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
        }

        importDropzone.addEventListener('click', () => importFileInput.click());

        importDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            importDropzone.classList.add('dragover');
        });

        importDropzone.addEventListener('dragleave', () => {
            importDropzone.classList.remove('dragover');
        });

        importDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            importDropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        let isTestMode = false;

        function checkRateLimit() {
            if (isTestMode) return { allowed: true };

            const lastImport = localStorage.getItem('suitegpt_last_import');
            if (lastImport) {
                const lastTime = new Date(lastImport);
                const now = new Date();
                const hoursSince = (now - lastTime) / (1000 * 60 * 60);

                if (hoursSince < 24) {
                    const hoursLeft = Math.ceil(24 - hoursSince);
                    return { allowed: false, hoursLeft };
                }
            }
            return { allowed: true };
        }

        function setRateLimitTimestamp() {
            if (!isTestMode) {
                localStorage.setItem('suitegpt_last_import', new Date().toISOString());
            }
        }

        const loadTestDataBtn = document.getElementById('loadTestData');
        loadTestDataBtn.addEventListener('click', async () => {
            isTestMode = true;
            loadTestDataBtn.textContent = 'Loading test data...';

            try {
                const response = await fetch('/test-data/sample-chatgpt-export.json');
                if (!response.ok) throw new Error('Could not load test data');

                const testData = await response.json();
                const blob = new Blob([JSON.stringify(testData)], { type: 'application/json' });
                const fakeFile = new File([blob], 'test-conversations.json', { type: 'application/json' });

                processFile(fakeFile);
            } catch (error) {
                console.error('Error loading test data:', error);
                alert('Could not load test data. Try uploading your own file.');
                loadTestDataBtn.textContent = 'Load sample data to test the flow';
            }
        });

        function resetImportModal() {
            importStepUpload.style.display = 'block';
            importProgress.classList.remove('active');
            importResults.classList.remove('active');
            importProgressFill.style.width = '0%';
            importFileInput.value = '';
            isTestMode = false;
            loadTestDataBtn.textContent = 'Load sample data to test the flow';
        }

        async function processFile(file) {
            const rateCheck = checkRateLimit();
            if (!rateCheck.allowed) {
                alert(`You can only import once per day. Please try again in ${rateCheck.hoursLeft} hours.`);
                return;
            }

            const consentAnalyze = document.getElementById('consentAnalyze').checked;
            if (!consentAnalyze) {
                alert('Please consent to analysis to continue.');
                return;
            }

            importStepUpload.style.display = 'none';
            importProgress.classList.add('active');
            updateProgress(10, 'Reading file...');

            try {
                let conversations = [];

                if (file.name.endsWith('.zip')) {
                    updateProgress(20, 'Extracting zip file...');
                    const JSZip = await loadJSZip();
                    const zip = await JSZip.loadAsync(file);
                    const conversationsFile = zip.file('conversations.json');
                    if (conversationsFile) {
                        const content = await conversationsFile.async('string');
                        conversations = JSON.parse(content);
                    } else {
                        throw new Error('conversations.json not found in zip');
                    }
                } else {
                    const content = await file.text();
                    conversations = JSON.parse(content);
                }

                updateProgress(40, 'Parsing conversations...');

                const extractedData = extractMessages(conversations, selectedSource);

                updateProgress(60, 'Analyzing patterns...');

                const analysis = await analyzeChats(extractedData);

                updateProgress(100, 'Complete!');

                setRateLimitTimestamp();

                setTimeout(() => {
                    displayResults(analysis, extractedData);
                }, 500);

            } catch (error) {
                console.error('Import error:', error);
                alert('Error processing file: ' + error.message);
                resetImportModal();
            }
        }

        async function loadJSZip() {
            if (window.JSZip) return window.JSZip;

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = () => resolve(window.JSZip);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function extractMessages(data, source) {
            let messages = [];
            let conversationCount = 0;

            if (source === 'chatgpt') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.mapping) {
                            Object.values(conv.mapping).forEach(node => {
                                if (node.message && node.message.author && node.message.author.role === 'user') {
                                    const content = node.message.content;
                                    if (content && content.parts) {
                                        messages.push(...content.parts.filter(p => typeof p === 'string'));
                                    }
                                }
                            });
                        }
                    });
                }
            } else if (source === 'claude') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.messages) {
                            conv.messages.forEach(msg => {
                                if (msg.role === 'human' || msg.role === 'user') {
                                    messages.push(msg.content || msg.text);
                                }
                            });
                        }
                    });
                }
            } else if (source === 'gemini') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.parts) {
                            conv.parts.forEach(part => {
                                if (part.role === 'user') {
                                    messages.push(part.text);
                                }
                            });
                        }
                    });
                }
            }

            return {
                source,
                conversationCount,
                messageCount: messages.length,
                messages: messages.filter(m => m && m.length > 0)
            };
        }

        async function analyzeChats(extractedData) {
            const consentImprove = document.getElementById('consentImprove').checked;

            const sampleSize = Math.min(extractedData.messages.length, 200);
            const sampledMessages = extractedData.messages
                .sort(() => Math.random() - 0.5)
                .slice(0, sampleSize);

            const messagesSummary = sampledMessages.join('\n---\n').slice(0, 50000);

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-chat-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        messages: messagesSummary,
                        source: extractedData.source,
                        messageCount: extractedData.messageCount,
                        conversationCount: extractedData.conversationCount,
                        storeInsights: consentImprove
                    })
                });

                if (!response.ok) {
                    throw new Error('Analysis API failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error, using local analysis:', error);
                return localAnalysis(extractedData);
            }
        }

        function localAnalysis(extractedData) {
            const messages = extractedData.messages;
            const allText = messages.join(' ').toLowerCase();

            const topics = {
                'Health & Fitness': ['workout', 'exercise', 'diet', 'nutrition', 'weight', 'health', 'fitness', 'gym', 'steps', 'walking'],
                'Finance & Money': ['money', 'budget', 'invest', 'savings', 'financial', 'income', 'expenses', 'crypto', 'spending'],
                'Productivity': ['productivity', 'schedule', 'task', 'todo', 'organize', 'habit', 'routine', 'reminder', 'focus', 'pomodoro'],
                'Sleep & Wellness': ['sleep', 'tired', 'insomnia', 'rest', 'meditation', 'stress', 'anxiety', 'mood', 'mental health'],
                'Learning': ['study', 'learn', 'read', 'book', 'course', 'skill', 'flashcard', 'memorize'],
                'Home & Life': ['clean', 'cook', 'meal', 'recipe', 'home', 'pet', 'travel', 'pack']
            };

            const detectedTopics = [];
            for (const [topic, keywords] of Object.entries(topics)) {
                const count = keywords.reduce((acc, keyword) => {
                    const regex = new RegExp(keyword, 'gi');
                    const matches = allText.match(regex);
                    return acc + (matches ? matches.length : 0);
                }, 0);
                if (count > 2) {
                    detectedTopics.push({ topic, count });
                }
            }
            detectedTopics.sort((a, b) => b.count - a.count);

            const recommendations = [];
            // Fitness
            if (allText.includes('fitness') || allText.includes('workout') || allText.includes('exercise')) {
                recommendations.push({ id: 'opticrep', ...SUITE_APPS['opticrep'], matchScore: 88 });
            }
            // Nutrition
            if (allText.includes('nutrition') || allText.includes('food') || allText.includes('diet')) {
                recommendations.push({ id: 'foodvitals', ...SUITE_APPS['foodvitals'], matchScore: 90 });
            }
            // Money
            if (allText.includes('money') || allText.includes('budget') || allText.includes('financial')) {
                recommendations.push({ id: 'quickbudget', ...SUITE_APPS['quickbudget'], matchScore: 85 });
            }
            // Habits
            if (allText.includes('habit') || allText.includes('routine')) {
                recommendations.push({ id: 'habitstack', ...SUITE_APPS['habitstack'], matchScore: 82 });
            }
            // Sleep
            if (allText.includes('sleep') || allText.includes('tired') || allText.includes('insomnia')) {
                recommendations.push({ id: 'sleepwell', ...SUITE_APPS['sleepwell'], matchScore: 87 });
            }
            // Mental health
            if (allText.includes('stress') || allText.includes('anxiety') || allText.includes('mood')) {
                recommendations.push({ id: 'moodlog', ...SUITE_APPS['moodlog'], matchScore: 86 });
            }
            // Focus
            if (allText.includes('focus') || allText.includes('concentrate') || allText.includes('procrastin')) {
                recommendations.push({ id: 'focusflow', ...SUITE_APPS['focusflow'], matchScore: 84 });
            }
            // Reading
            if (allText.includes('book') || allText.includes('read')) {
                recommendations.push({ id: 'bookshelf', ...SUITE_APPS['bookshelf'], matchScore: 80 });
            }
            // Water
            if (allText.includes('water') || allText.includes('hydrat')) {
                recommendations.push({ id: 'hydrotrack', ...SUITE_APPS['hydrotrack'], matchScore: 83 });
            }
            // Meal planning
            if (allText.includes('cook') || allText.includes('meal') || allText.includes('recipe')) {
                recommendations.push({ id: 'mealprep', ...SUITE_APPS['mealprep'], matchScore: 81 });
            }

            const topicIcons = {
                'Health & Fitness': '',
                'Finance & Money': '',
                'Productivity': '',
                'Sleep & Wellness': '',
                'Learning': '',
                'Home & Life': ''
            };

            return {
                topics: detectedTopics.slice(0, 5),
                insights: detectedTopics.slice(0, 3).map(({ topic, count }) => ({
                    category: topic,
                    description: `You frequently discuss ${topic.toLowerCase()} topics (${count}+ mentions)`,
                    icon: topicIcons[topic] || ''
                })),
                recommendations: recommendations.slice(0, 4),
                extractedIdeas: [],
                matchedIdeas: [],
                unmatchedIdeas: [],
                summary: `Based on ${extractedData.messageCount} messages, we found ${detectedTopics.length} main topics of interest.`
            };
        }

        function updateProgress(percent, text) {
            importProgressFill.style.width = percent + '%';
            importProgressText.textContent = text;
        }

        function displayResults(analysis, extractedData) {
            analysisResults = analysis;

            importProgress.classList.remove('active');
            importResults.classList.add('active');

            document.getElementById('statConversations').textContent = extractedData.conversationCount.toLocaleString();
            document.getElementById('statMessages').textContent = extractedData.messageCount.toLocaleString();
            document.getElementById('statTopics').textContent = (analysis.topics?.length || 0);

            const insightsList = document.getElementById('insightsList');
            let insightsHtml = '';

            if (analysis.summary) {
                insightsHtml += `<div class="import-summary-text">${analysis.summary}</div>`;
            }

            insightsHtml += (analysis.insights || []).map(insight => `
                <div class="import-insight-item">
                    <div class="import-insight-icon" style="background: rgba(99, 102, 241, 0.15);">
                        ${insight.icon || ''}
                    </div>
                    <div class="import-insight-content">
                        <h5>${insight.category}</h5>
                        <p>${insight.description}</p>
                    </div>
                </div>
            `).join('');

            insightsList.innerHTML = insightsHtml;

            const recommendationsList = document.getElementById('recommendationsList');
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsList.innerHTML = analysis.recommendations.map(app => `
                    <a href="${app.url || '#'}" class="import-app-rec">
                        <div class="import-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                            ${app.icon || ''}
                        </div>
                        <div class="import-app-info">
                            <h5>${app.name}</h5>
                            <p>${app.description}</p>
                        </div>
                        <div class="import-app-match">${app.matchScore || 85}% match</div>
                    </a>
                `).join('');
            } else {
                recommendationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
                        <p>No exact matches found, but we can build something custom!</p>
                    </div>
                `;
            }

            const unmatchedSection = document.getElementById('importUnmatched');
            const unmatchedList = document.getElementById('unmatchedList');

            if (analysis.unmatchedIdeas && analysis.unmatchedIdeas.length > 0) {
                unmatchedSection.style.display = 'block';
                unmatchedList.innerHTML = analysis.unmatchedIdeas.map((idea) => `
                    <div class="unmatched-idea">
                        <div class="unmatched-idea-text">"${idea.text}"</div>
                        <div class="unmatched-idea-meta">
                            <span class="unmatched-idea-category">${idea.category}</span>
                            <button class="unmatched-idea-request" data-idea="${encodeURIComponent(idea.text)}">
                                Request This App 
                            </button>
                        </div>
                    </div>
                `).join('');

                unmatchedList.querySelectorAll('.unmatched-idea-request').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idea = decodeURIComponent(btn.dataset.idea);
                        requestAppIdea(idea);
                    });
                });
            } else {
                unmatchedSection.style.display = 'none';
            }
        }

        function requestAppIdea(idea) {
            importModal.classList.remove('active');

            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');

            const message = `I'd like to request an app that: ${idea}`;

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            addTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const response = `Great idea! We can build this for you.\n\n` +
                    `Here's how it works:\n` +
                    `1. We'll review your request\n` +
                    `2. AI Fleet will design and build the app\n` +
                    `3. You'll have it within 1-12 hours\n\n` +
                    `Want to submit this request?`;
                addMessage(response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: response });
            }, 1500);
        }

        importDone.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importRequestCustom.addEventListener('click', () => {
            importModal.classList.remove('active');

            if (analysisResults && analysisResults.summary) {
                welcomeState.classList.add('chat-active');
                chatContainer.classList.add('active');

                const message = `Based on my chat history, I'm interested in: ${analysisResults.topics?.slice(0, 3).map(t => t.topic).join(', ')}. Can you help me find or build something for this?`;

                addMessage(message, 'user');
                conversationHistory.push({ role: 'user', content: message });

                addTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const response = `Great! Based on your interests, I can see you're focused on ${analysisResults.topics?.[0]?.topic?.toLowerCase() || 'several areas'}.\n\nWe can either:\n1. Set you up with existing apps that match your needs\n2. Build something custom tailored to your specific workflow\n\nWhat sounds better to you?`;
                    addMessage(response, 'assistant');
                    conversationHistory.push({ role: 'assistant', content: response });
                }, 1500);
            }
        });

        // ============================================
        // PWA SERVICE WORKER REGISTRATION
        // ============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/suitegpt-sw.js')
                    .then((registration) => {
                        console.log('SuiteGPT SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SuiteGPT SW registration failed:', error);
                    });
            });
        }

        let deferredPrompt = null;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            setTimeout(() => {
                showInstallPrompt();
            }, 30000);
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;

            if (sessionStorage.getItem('pwa-prompt-shown')) return;
            sessionStorage.setItem('pwa-prompt-shown', 'true');

            const promptDiv = document.createElement('div');
            promptDiv.className = 'pwa-install-prompt visible';
            promptDiv.innerHTML = `
                <div class="pwa-install-content">
                    <div class="pwa-install-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                    </div>
                    <div class="pwa-install-text">
                        <h4>Add SuiteGPT to Home Screen</h4>
                        <p>Quick access to your app concierge anytime</p>
                    </div>
                </div>
                <div class="pwa-install-actions">
                    <button class="pwa-install-btn secondary" id="pwaLater">Later</button>
                    <button class="pwa-install-btn primary" id="pwaInstall">Add to Home</button>
                </div>
            `;
            document.body.appendChild(promptDiv);

            document.getElementById('pwaInstall').addEventListener('click', async () => {
                promptDiv.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install outcome:', outcome);
                deferredPrompt = null;
            });

            document.getElementById('pwaLater').addEventListener('click', () => {
                promptDiv.remove();
            });
        }
    </script>
</body>
</html>
