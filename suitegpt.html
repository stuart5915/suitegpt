<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS zoom fix -->
    <script>
        // Capture OAuth hash IMMEDIATELY before anything can strip it
        const _oauthHash = window.location.hash;
        if (_oauthHash) {
            console.log('[Auth EARLY] Hash detected on page load:', _oauthHash);
        }

        // iOS zoom fix - reset on load
        window.addEventListener('load', function() {
            setTimeout(function() {
                window.scrollTo(0, 1);
                window.scrollTo(0, 0);
            }, 0);
        });
    </script>
    <title>SuiteGPT | Your Personal App Concierge</title>
    <meta name="description" content="Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers.">
    <link rel="icon" type="image/png" href="/suitegpt-logo.png">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuiteGPT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    <link rel="manifest" href="/suitegpt-manifest.json">
    <link rel="apple-touch-icon" href="/assets/suitegpt-icon-192.png">

    <!-- Open Graph -->
    <meta property="og:title" content="SuiteGPT | Your Personal App Concierge">
    <meta property="og:description" content="Tell us what you need. We'll find it, change it, or build it for you.">
    <meta property="og:image" content="https://getsuite.app/assets/images/1200x630-getsuite.jpg">
    <meta property="og:url" content="https://getsuite.app/suitegpt.html">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SuiteGPT | Your Personal App Concierge">
    <meta name="twitter:description" content="Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers.">
    <meta name="twitter:image" content="https://getsuite.app/assets/images/1200x630-getsuite.jpg">

    <!-- Structured Data - SoftwareApplication -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "SuiteGPT",
        "alternateName": "Your Personal App Concierge",
        "description": "Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers. SuiteGPT is an AI-powered app concierge that helps you discover, customize, or request new apps.",
        "url": "https://suitegpt.app",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "description": "Free to use with optional credits"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "100"
        },
        "author": {
            "@type": "Organization",
            "name": "SUITE",
            "url": "https://getsuite.app"
        },
        "featureList": [
            "AI-powered app discovery",
            "Custom app requests",
            "20+ free productivity apps",
            "Multiple AI models (Claude, GPT-4, Gemini)",
            "Web search capability",
            "Image generation",
            "Voice mode"
        ]
    }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="/nav.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            max-width: 100vw;
            width: 100%;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
            overscroll-behavior-y: none;
        }

        /* Prevent iOS zoom on input focus */
        @media screen and (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        :root {
            --bg-dark: #0a0a0f;
            --bg-sidebar: #111118;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #ec4899;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --text-tertiary: rgba(248, 250, 252, 0.4);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
            overscroll-behavior-y: none;
        }

        /* === MAIN LAYOUT === */
        .app-layout {
            display: flex;
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* === LEFT SIDEBAR === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px;
            box-sizing: border-box;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .sidebar-logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: contain;
        }

        .sidebar-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .sidebar-close-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-close-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .sidebar-close-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
        }

        .bg-gradient.sidebar-collapsed {
            left: 0;
        }

        /* Show sidebar toggle when collapsed */
        .sidebar-open-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 200;
            transition: all 0.2s ease;
        }

        .sidebar-open-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .sidebar-open-btn.visible {
            display: flex;
        }

        .sidebar-open-btn svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 6px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            padding: 0 6px;
            margin-bottom: 8px;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            max-width: 223px;
            text-align: left;
            font-family: inherit;
            height: 36px;
        }

        .sidebar-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .sidebar-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-item-icon svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-item-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 100px;
        }

        /* Your Apps Sidebar Section */
        .sidebar-your-apps {
            margin-top: 8px;
        }

        .sidebar-expandable {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            user-select: none;
        }

        .sidebar-expandable:hover {
            background: var(--bg-card-hover);
        }

        .sidebar-expandable .expand-arrow {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
        }

        .sidebar-expandable.collapsed .expand-arrow {
            transform: rotate(-90deg);
        }

        .sidebar-apps-list {
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }

        .sidebar-apps-list.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .sidebar-app-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 20px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .sidebar-app-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-app-tab.active {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .sidebar-app-tab-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .sidebar-app-tab-icon img {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            object-fit: cover;
        }

        .sidebar-app-tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar-app-tab-remove {
            opacity: 0;
            padding: 2px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .sidebar-app-tab:hover .sidebar-app-tab-remove {
            opacity: 1;
        }

        .sidebar-app-tab-remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sidebar-apps-empty {
            padding: 8px 20px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .sidebar-footer {
            padding: 6px;
            width: 245px;
            height: 63px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-subtle);
            position: relative;
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid transparent;
            width: 233px;
            height: 51px;
            box-sizing: border-box;
        }

        .sidebar-profile-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .sidebar-profile-avatar svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-profile-info {
            flex: 1;
        }

        .sidebar-profile-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-profile-status {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .sidebar-profile-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Add to Home Screen Button */
        .add-to-home-btn {
            display: none;
            align-items: center;
            gap: 10px;
            width: calc(100% - 32px);
            margin: 0 16px 12px 16px;
            padding: 12px 14px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .add-to-home-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.25));
            border-color: var(--accent-primary);
        }

        .add-to-home-btn svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .add-to-home-btn span {
            flex: 1;
            text-align: left;
        }

        .add-to-home-dismiss {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .add-to-home-dismiss:hover {
            color: var(--text-primary);
        }

        .add-to-home-btn.visible {
            display: flex;
        }

        .add-to-home-btn.hidden {
            display: none;
        }

        /* Profile Dropdown (Dropup) */

        .profile-dropdown {
            position: absolute;
            bottom: 100%;
            left: 16px;
            right: 16px;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            height: 36px;
            box-sizing: border-box;
        }

        .profile-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        a.profile-dropdown-item {
            text-decoration: none;
            color: var(--text-primary);
        }

        a.profile-dropdown-item:hover {
            text-decoration: none;
        }

        .profile-dropdown-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .profile-dropdown-item.logout {
            color: #f87171;
        }

        .profile-dropdown-item.logout svg {
            color: #f87171;
        }

        .profile-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* AI Notifications Settings Styles */
        .ai-settings-section {
            padding: 12px;
        }

        .ai-settings-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .ai-settings-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .ai-setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ai-setting-item:last-child {
            border-bottom: none;
        }

        .ai-setting-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ai-setting-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .ai-setting-help {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .ai-setting-select {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .ai-apps-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .ai-apps-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .ai-apps-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-tertiary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .profile-dropdown-back {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .profile-dropdown-back:hover {
            color: var(--text-primary);
        }

        .profile-dropdown-view {
            display: block;
        }

        .sidebar-profile {
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-profile:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile Dropdown Credits Section */
        .profile-dropdown-credits {
            padding: 0;
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            height: 36px;
            box-sizing: border-box;
        }

        .credits-display.clickable {
            cursor: pointer;
            border-radius: 6px;
            justify-content: space-between;
        }

        .credits-display.clickable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .credits-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .credits-info {
            display: flex;
            flex-direction: column;
        }

        .credits-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .withdrawal-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            background: none;
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            height: 36px;
            box-sizing: border-box;
            text-align: left;
        }

        .withdrawal-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .withdrawal-btn:disabled {
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        /* Linked Accounts Section */
        .linked-accounts-section {
            padding: 0;
        }

        .linked-accounts-header {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px 4px;
        }

        .linked-account {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .linked-account-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .linked-account-status .checkmark {
            color: #10b981;
            font-size: 0.85rem;
        }

        .linked-account-value {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-account-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            background: none;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            height: 36px;
            box-sizing: border-box;
            text-align: left;
        }

        .link-account-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .link-account-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .link-account-btn.connected {
            justify-content: space-between;
            color: var(--text-primary);
        }

        .link-account-btn.connected .linked-account-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .link-account-btn.connected .checkmark {
            color: #10b981;
        }

        .link-account-btn.connected .linked-account-value {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Credits Modal */
        .credits-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .credits-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .credits-modal {
            background: #1a1a2e;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 360px;
            padding: 24px;
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5), 0 0 0 1px rgba(255, 255, 255, 0.05);
        }

        .credits-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .credits-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .credits-modal h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0 0 16px 0;
        }

        .credits-modal-balance {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 20px;
        }

        .credits-modal-amount {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            display: block;
        }

        .credits-modal-label {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 4px;
            display: block;
        }

        .credits-modal-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .credits-modal-option {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: left;
        }

        .credits-modal-option:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--accent-color);
        }

        .credits-modal-option-icon {
            width: 40px;
            height: 40px;
            background: rgba(124, 58, 237, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-color);
            flex-shrink: 0;
        }

        .credits-modal-option-text {
            flex: 1;
        }

        .credits-modal-option-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .credits-modal-option-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .credits-modal-bonus {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .credits-modal-bonus-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .credits-modal-bonus-header span:first-child {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .credits-modal-bonus-amount {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .credits-modal-bonus-toggle {
            font-size: 0.8rem;
            color: var(--accent-color);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }

        .credits-modal-bonus-toggle:hover {
            opacity: 0.8;
        }

        .credits-modal-bonus-toggle .toggle-arrow {
            transition: transform 0.3s;
        }

        .credits-modal-bonus.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .credits-modal-bonus-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, margin-top 0.3s ease;
            margin-top: 0;
        }

        .credits-modal-bonus.expanded .credits-modal-bonus-content {
            max-height: 200px;
            margin-top: 12px;
        }

        .credits-modal-bonus-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0 0 10px 0;
        }

        .credits-modal-docs-link {
            font-size: 0.75rem;
            color: var(--accent-color);
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .credits-modal-docs-link:hover {
            opacity: 1;
        }

        /* Withdrawal Modal */
        .withdrawal-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .withdrawal-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .withdrawal-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 24px;
            position: relative;
        }

        .withdrawal-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .withdrawal-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .withdrawal-modal h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .withdrawal-balance {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .withdrawal-balance-credits {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .withdrawal-balance-value {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .withdrawal-input-group {
            margin: 16px 0;
        }

        .withdrawal-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .withdrawal-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .withdrawal-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .withdrawal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .withdrawal-max-btn {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .withdrawal-max-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .withdrawal-note {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin: 12px 0;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
        }

        .withdrawal-confirm-btn {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }

        .withdrawal-confirm-btn:hover {
            opacity: 0.9;
            transform: scale(1.01);
        }

        .withdrawal-confirm-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        /* Upgrade Modal */
        .upgrade-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upgrade-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .upgrade-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        .upgrade-modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .upgrade-modal-header h2 {
            font-size: 1.75rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .upgrade-modal-header p {
            color: var(--text-secondary);
            margin: 0;
        }

        .upgrade-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .upgrade-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .upgrade-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .upgrade-tab {
            padding: 10px 24px;
            border: 1px solid var(--border-color);
            border-radius: 100px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .upgrade-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .upgrade-tab:hover:not(.active) {
            border-color: var(--text-secondary);
        }

        .upgrade-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .upgrade-plan {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            transition: border-color 0.2s, transform 0.2s;
        }

        .upgrade-plan:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .upgrade-plan.popular {
            border-color: var(--accent-primary);
        }

        .upgrade-plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .upgrade-plan-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upgrade-plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .upgrade-plan-price span {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .upgrade-plan-desc {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .upgrade-plan-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }

        .upgrade-plan-features li {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .upgrade-plan-features li svg {
            width: 16px;
            height: 16px;
            color: #22c55e;
            flex-shrink: 0;
        }

        .upgrade-plan-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upgrade-plan-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .upgrade-plan-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .upgrade-plan-btn:hover {
            opacity: 0.9;
        }

        .credits-section {
            display: none;
        }

        .credits-section.active {
            display: block;
        }

        .subscription-section {
            display: none;
        }

        .subscription-section.active {
            display: block;
        }

        .credit-packs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .credit-pack {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
        }

        .credit-pack:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .credit-pack.best-value {
            border-color: #22c55e;
            position: relative;
        }

        .credit-pack-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .credit-pack-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .credit-pack-price {
            font-size: 1.1rem;
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .credit-pack-per {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        @media (max-width: 768px) {
            .upgrade-modal {
                padding: 24px 16px;
                margin: 16px;
            }

            .upgrade-plans {
                grid-template-columns: 1fr;
            }

            .credit-packs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sidebar-powered-by {
            text-align: center;
            padding: 8px;
        }

        .sidebar-powered-by a {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 0.75rem;
            transition: color 0.2s ease;
        }

        .sidebar-powered-by a:hover {
            color: var(--text-secondary);
        }

        .sidebar-powered-by strong {
            color: var(--accent-primary);
        }

        /* === MOBILE SIDEBAR === */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-sidebar);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 150;
            padding: 0 16px;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: var(--bg-card);
        }

        .mobile-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* === LOGGED OUT STATE === */
        /* Guests see full sidebar - no hiding */

        /* Auth Header for logged-out state */
        .auth-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 200;
            padding: 0 24px;
            align-items: center;
            justify-content: space-between;
        }

        /* Auth header hidden - guests use sidebar profile instead */
        body.logged-out .auth-header {
            display: none;
        }

        .auth-header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .auth-header-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 800;
            color: white;
        }

        .auth-header-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .auth-header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .auth-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .auth-btn-login {
            background: transparent;
            border: 1px solid var(--border-hover);
            color: var(--text-primary);
        }

        .auth-btn-login:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-secondary);
        }

        .auth-btn-signup {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .auth-btn-signup:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        /* No extra padding needed - auth header hidden, sidebar visible */

        /* === CONNECT MODAL === */
        .connect-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .connect-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .connect-modal {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .connect-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .connect-modal h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 1.2rem;
        }

        .connect-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .connect-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .connect-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .connect-option-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .connect-option.telegram .connect-option-icon {
            background: rgba(0, 136, 204, 0.2);
            color: #0088cc;
        }

        .connect-option-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .connect-option-desc {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .connect-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .connect-divider::before,
        .connect-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .connect-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: -12px 0 20px 0;
            text-align: center;
        }

        .connect-options-primary {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .connect-option-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-subtle);
        }

        .connect-option-btn.google {
            background: white;
            color: #333;
        }

        .connect-option-btn.google:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }

        .connect-option-btn.email {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .connect-option-btn.email:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .connect-options-secondary {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .connect-option-small {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .connect-option-small:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .connect-option-small.telegram {
            color: #0088cc;
        }

        .connect-option-small.telegram:hover {
            background: rgba(0, 136, 204, 0.1);
            border-color: rgba(0, 136, 204, 0.3);
        }

        .email-auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .email-auth-form input {
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .email-auth-form input:focus {
            border-color: var(--accent-primary);
        }

        .email-auth-form input::placeholder {
            color: var(--text-tertiary);
        }

        .email-back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .email-back-btn:hover {
            color: var(--text-primary);
        }

        /* === APP PREVIEW (Full Screen Inline) === */
        .app-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: none;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        }

        .app-preview-overlay.active {
            display: flex;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
        }

        .app-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-subtle);
            gap: 16px;
            flex-shrink: 0;
        }

        .app-preview-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-preview-back:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .app-preview-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }

        .app-preview-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .app-preview-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-preview-title span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .app-preview-add {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-preview-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .app-preview-add.added {
            background: #22c55e;
            pointer-events: none;
        }

        .app-preview-content {
            flex: 1;
            overflow: hidden;
        }

        .app-preview-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Mobile responsive for app preview */
        @media (max-width: 600px) {
            .app-preview-header {
                padding: 10px 12px;
                gap: 8px;
            }

            .app-preview-back {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .app-preview-back svg {
                width: 16px;
                height: 16px;
            }

            .app-preview-title span {
                font-size: 0.95rem;
            }

            .app-preview-icon {
                width: 28px;
                height: 28px;
                border-radius: 8px;
            }

            .app-preview-add {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .app-preview-add span {
                display: none;
            }

            .app-preview-add::after {
                content: 'Add';
            }
        }

        @media (max-width: 400px) {
            .app-preview-back span {
                display: none;
            }

            .app-preview-title {
                gap: 8px;
            }
        }

        /* === APP LAUNCH MODAL === */
        .app-launch-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .app-launch-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .app-launch-modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
        }

        .app-launch-modal-icon {
            width: 72px;
            height: 72px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
            overflow: hidden;
        }

        .app-launch-modal-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-launch-modal h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .app-launch-modal p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 28px;
        }

        .app-launch-options {
            display: flex;
            gap: 16px;
        }

        .app-launch-option {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-launch-option:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .app-launch-option-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .app-launch-option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .app-launch-option-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .app-launch-modal-close {
            margin-top: 20px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 16px;
        }

        .app-launch-modal-close:hover {
            color: var(--text-primary);
        }

        /* === MOBILE APP CONTAINER (Draggable Phone View) === */
        .mobile-app-container {
            position: fixed;
            width: 375px;
            height: 700px;
            background: #000;
            border-radius: 40px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 2px #333, inset 0 0 0 2px #1a1a1a;
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            min-width: 320px;
            min-height: 500px;
            max-width: 90vw;
            max-height: 90vh;
        }

        .mobile-app-container.active {
            display: flex;
        }

        .mobile-app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            cursor: grab;
            user-select: none;
            border-bottom: 1px solid #333;
        }

        .mobile-app-header:active {
            cursor: grabbing;
        }

        .mobile-app-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-app-header-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .mobile-app-header-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mobile-app-header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
        }

        .mobile-app-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-app-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mobile-app-btn-fullscreen {
            background: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
        }

        .mobile-app-btn-fullscreen:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .mobile-app-btn-minimize {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .mobile-app-btn-minimize:hover {
            background: rgba(34, 197, 94, 0.5);
        }

        .mobile-app-content {
            flex: 1;
            background: #fff;
            overflow: hidden;
            border-radius: 0 0 38px 38px;
        }

        .mobile-app-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Phone notch decoration */
        .mobile-app-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 28px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mobile-app-notch::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .mobile-app-notch::after {
            content: '';
            width: 50px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        /* Toast notification */
        .app-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: calc(100vw - 40px);
            white-space: nowrap;
        }

        .app-toast.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* === APPS PANEL === */
        .apps-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .apps-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .apps-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1001;
        }

        .apps-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .apps-panel-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .apps-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .apps-panel-search {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-search input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .apps-panel-search input::placeholder {
            color: var(--text-tertiary);
        }

        .apps-panel-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .apps-panel-grid {
            padding: 20px 24px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .apps-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.2s;
            text-decoration: none;
        }

        .apps-panel-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .apps-panel-item-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .apps-panel-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .apps-panel-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 4px;
            text-align: center;
        }

        .apps-panel-item-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-align: center;
            line-height: 1.3;
        }

        @media (max-width: 768px) {
            .apps-panel {
                width: 95%;
                max-height: 90vh;
            }

            .apps-panel-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
                padding: 16px;
            }

            .apps-panel-item {
                padding: 16px 12px;
            }

            .apps-panel-item-icon {
                width: 48px;
                height: 48px;
            }
        }

        /* === INLINE APPS VIEW === */
        .apps-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            padding-top: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .apps-view.active {
            display: flex;
        }

        .apps-view-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .apps-view-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apps-view-back:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .apps-view-back svg {
            width: 18px;
            height: 18px;
        }

        .apps-view-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .apps-view-search {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            margin-bottom: 32px;
            transition: border-color 0.2s;
        }

        .apps-view-search:focus-within {
            border-color: var(--accent-primary);
        }

        .apps-view-search svg {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .apps-view-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .apps-view-search input::placeholder {
            color: var(--text-tertiary);
        }

        .apps-view-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .apps-view-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .apps-view-item:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .apps-view-item-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .apps-view-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .apps-view-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 6px;
            text-align: center;
        }

        .apps-view-item-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-align: center;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .apps-view {
                padding: 20px;
            }

            .apps-view-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .apps-view-grid {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .apps-view-item {
                padding: 16px 12px;
            }

            .apps-view-item-icon {
                width: 52px;
                height: 52px;
            }
        }

        /* Apps View Tabs */
        .apps-view-tabs {
            display: flex !important;
            flex-direction: row !important;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        .apps-view-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            z-index: 10;
        }

        .apps-view-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .apps-view-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .apps-view-tab-icon {
            font-size: 1.1rem;
        }

        .apps-view-tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .apps-view-tab.active .apps-view-tab-count {
            background: rgba(255, 255, 255, 0.25);
        }

        .apps-view-panel {
            display: none;
        }

        .apps-view-panel.active {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        @media (max-width: 768px) {
            .apps-view-tabs {
                gap: 6px;
            }

            .apps-view-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .apps-view-panel.active {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
        }

        /* === INLINE LEARN VIEW === */
        .learn-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            padding-top: 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .learn-view.active {
            display: flex;
        }

        .learn-view-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .learn-view-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .learn-view-back:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .learn-view-back svg {
            width: 18px;
            height: 18px;
        }

        .learn-view-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .learn-view-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 32px;
        }

        .learn-articles-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .learn-article-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .learn-article-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .learn-article-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }

        .learn-article-content {
            flex: 1;
        }

        .learn-article-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .learn-article-tag {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .learn-article-tag.new {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .learn-article-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .learn-article-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .learn-article-meta {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .learn-article-arrow {
            color: var(--accent-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .learn-view {
                padding: 20px;
            }

            .learn-article-card {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .learn-article-arrow {
                display: none;
            }

            .learn-article-tags {
                justify-content: center;
            }
        }

        /* === ARTICLE READER === */
        .learn-article-reader {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border-color);
        }

        .learn-article-reader-header {
            margin-bottom: 24px;
        }

        .learn-article-reader-content {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .learn-article-reader-content h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .learn-article-reader-content h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 32px;
            margin-bottom: 16px;
        }

        .learn-article-reader-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .learn-article-reader-content p {
            margin-bottom: 16px;
        }

        .learn-article-reader-content .article-meta-info {
            display: flex;
            gap: 16px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
            margin-bottom: 24px;
        }

        .learn-article-reader-content .article-highlight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
        }

        .learn-article-reader-content .article-highlight p {
            margin-bottom: 0;
            font-size: 1.05rem;
        }

        .learn-article-reader-content .app-feature-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }

        .learn-article-reader-content .app-feature-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .learn-article-reader-content .app-feature-card .app-icon {
            font-size: 1.5rem;
        }

        .learn-article-reader-content .app-feature-card .app-icon-img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
            vertical-align: middle;
        }

        .learn-article-reader-content ul {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .learn-article-reader-content li {
            margin-bottom: 8px;
        }

        .learn-article-reader-content a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .learn-article-reader-content a:hover {
            text-decoration: underline;
        }

        .learn-article-reader-content .cta-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-top: 40px;
        }

        .learn-article-reader-content .cta-section h3 {
            margin-top: 0;
            font-size: 1.4rem;
        }

        .learn-article-reader-content .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            margin-top: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .learn-article-reader-content .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            text-decoration: none;
        }

        /* === CREATOR DASHBOARD === */
        .creator-dashboard {
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            padding: 40px;
            padding-top: 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .creator-dashboard.active {
            display: flex;
        }

        .creator-dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .creator-dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .creator-dashboard-title svg {
            width: 28px;
            height: 28px;
            color: var(--accent-primary);
        }

        .creator-dashboard-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.03);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 32px;
        }

        .creator-dashboard-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .creator-dashboard-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .creator-dashboard-tab.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .creator-dashboard-tab svg {
            width: 18px;
            height: 18px;
        }

        .creator-dashboard-panel {
            display: none;
        }

        .creator-dashboard-panel.active {
            display: block;
        }

        @media (max-width: 768px) {
            .creator-dashboard {
                padding: 20px;
            }

            .creator-dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .creator-dashboard-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .creator-dashboard-tab {
                padding: 10px 16px;
                font-size: 0.85rem;
                white-space: nowrap;
            }
        }

        /* === YOUR APPS VIEW === */
        .your-apps-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .your-apps-view.active {
            display: flex;
        }

        .your-apps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .your-apps-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .your-apps-create-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 12px;
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .your-apps-create-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        }

        .your-apps-create-btn svg {
            width: 18px;
            height: 18px;
        }

        .your-apps-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .your-apps-empty-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .your-apps-empty-icon svg {
            width: 40px;
            height: 40px;
            color: var(--accent-primary);
        }

        .your-apps-empty h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .your-apps-empty p {
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            max-width: 400px;
        }

        .your-apps-tier {
            margin-bottom: 40px;
        }

        .your-apps-tier-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }

        .your-apps-tier-icon {
            font-size: 1.25rem;
        }

        .your-apps-tier-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .your-apps-tier-count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.05);
            padding: 4px 10px;
            border-radius: 20px;
        }

        .your-apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
            gap: 20px;
        }

        .your-apps-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            transition: all 0.2s ease;
        }

        .your-apps-card:hover {
            border-color: var(--border-hover);
            background: rgba(255, 255, 255, 0.04);
        }

        .your-apps-card-header {
            display: flex;
            align-items: center;
            gap: 14px;
            margin-bottom: 12px;
            cursor: pointer;
        }

        .your-apps-card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .your-apps-card-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .your-apps-card-info {
            flex: 1;
            min-width: 0;
        }

        .your-apps-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-card-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-card-creator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }

        .your-apps-card-actions {
            display: flex;
            gap: 10px;
        }

        .your-apps-card-btn {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .your-apps-card-btn.propose {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
        }

        .your-apps-card-btn.propose:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }

        .your-apps-card-btn.remove {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .your-apps-card-btn.remove:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        .your-apps-card-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Proposal Modal */
        .proposal-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .proposal-modal-overlay.active {
            display: flex;
        }

        .proposal-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .proposal-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .proposal-modal-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .proposal-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .proposal-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .proposal-modal-close svg {
            width: 18px;
            height: 18px;
        }

        .proposal-modal-body {
            padding: 24px;
        }

        .proposal-modal-app {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .proposal-modal-app-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            overflow: hidden;
        }

        .proposal-modal-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .proposal-modal-app-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .proposal-modal-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .proposal-modal-textarea {
            width: 100%;
            min-height: 140px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .proposal-modal-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .proposal-modal-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .proposal-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .proposal-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-modal-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .proposal-modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .proposal-modal-btn.submit {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .proposal-modal-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .proposal-modal-btn.submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Create New App Modal - Tier Selection */
        .tier-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tier-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tier-option:hover {
            border-color: var(--border-hover);
            background: rgba(255, 255, 255, 0.05);
        }

        .tier-option.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tier-option-icon {
            font-size: 1.5rem;
        }

        .tier-option-info {
            flex: 1;
        }

        .tier-option-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .tier-option-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .tier-option-check {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tier-option.selected .tier-option-check {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .tier-option-check svg {
            width: 14px;
            height: 14px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tier-option.selected .tier-option-check svg {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .your-apps-view {
                padding: 20px;
            }

            .your-apps-header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .your-apps-grid {
                grid-template-columns: 1fr;
            }

            .proposal-modal {
                max-width: none;
                margin: 0;
            }
        }

        /* === INLINE CREATE VIEW === */
        .create-view {
            flex: 1;
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .create-view-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 0 0 32px 0;
        }

        .create-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .create-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .create-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .create-card-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .create-card-content {
            flex: 1;
        }

        .create-card-content h3 {
            margin: 0 0 6px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .create-card-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        .create-section {
            margin-bottom: 40px;
        }

        .create-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
        }

        .create-section-title svg {
            width: 22px;
            height: 22px;
            color: var(--text-secondary);
        }

        .create-section-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            background: linear-gradient(135deg, #eab308, #ca8a04);
            color: #000;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .create-card.premium {
            border-color: rgba(234, 179, 8, 0.3);
        }

        .create-card.premium:hover {
            border-color: #eab308;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.15);
        }

        @media (max-width: 768px) {
            .create-view {
                padding: 20px;
            }

            .create-view-grid {
                grid-template-columns: 1fr;
            }

            .create-card {
                padding: 20px;
            }

            .create-card-icon {
                width: 48px;
                height: 48px;
            }

            .create-card-icon svg {
                width: 24px;
                height: 24px;
            }

            .create-section {
                margin-bottom: 32px;
            }
        }

        /* === CREATOR EARNINGS VIEW === */
        .earnings-view {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 24px;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .earnings-view.active {
            display: flex;
        }

        .earnings-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .earnings-header-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earnings-header-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .earnings-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .earnings-header p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .earnings-steps {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .earnings-step {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .earnings-step-num {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
        }

        .earnings-step-text h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .earnings-step-text p {
            margin: 4px 0 0 0;
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .earnings-cta {
            text-align: center;
            margin-bottom: 32px;
        }

        .earnings-enroll-btn {
            padding: 14px 40px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .earnings-enroll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .earnings-terms {
            margin: 12px 0 0 0;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .earnings-terms a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .earnings-cards {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .earnings-card {
            padding: 20px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            text-align: center;
        }

        .earnings-card-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earnings-card-icon svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
        }

        .earnings-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .earnings-card p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .earnings-view {
                padding: 24px 16px;
            }

            .earnings-header h1 {
                font-size: 1.4rem;
            }

            .earnings-cards {
                grid-template-columns: 1fr;
            }
        }

        /* === MY REQUESTS PANEL === */
        .my-requests-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .my-requests-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .my-requests-header p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .my-requests-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .my-requests-empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--bg-elevated);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .my-requests-empty-icon svg {
            width: 32px;
            height: 32px;
            color: var(--text-tertiary);
        }

        .my-requests-empty h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .my-requests-empty p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .my-requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .my-request-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-request-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .my-request-status.pending {
            background: #f59e0b;
        }

        .my-request-status.approved {
            background: #22c55e;
        }

        .my-request-status.rejected {
            background: #ef4444;
        }

        .my-request-content {
            flex: 1;
            min-width: 0;
        }

        .my-request-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .my-request-meta {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        /* === SETTINGS MODAL === */
        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: var(--bg-elevated);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .settings-nav {
            width: 200px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border-subtle);
            padding: 16px 0;
            flex-shrink: 0;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            transition: all 0.15s ease;
        }

        .settings-nav-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .settings-nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .settings-nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .settings-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #1a1a28;
        }

        .settings-content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .settings-content-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .settings-close-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .settings-close-btn:hover {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .settings-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .settings-action-btn:hover {
            background: var(--accent-hover);
        }

        .settings-action-btn svg {
            width: 18px;
            height: 18px;
        }

        @media (max-width: 600px) {
            .settings-modal {
                flex-direction: column;
                max-height: 90vh;
            }

            .settings-nav {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 8px;
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
            }

            .settings-nav-item {
                padding: 8px 16px;
                white-space: nowrap;
            }
        }

        /* === FACTORY/GOVERNANCE VIEW === */
        .factory-view {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
        }

        .factory-view.active {
            display: flex;
        }

        .factory-view-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .factory-view-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .factory-view-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .factory-main-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
        }

        .factory-main-tab {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factory-main-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-main-tab.active {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .factory-main-tab .tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .factory-view-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .factory-sidebar-panel {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .factory-sidebar-section {
            margin-bottom: 24px;
        }

        .factory-sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .factory-rep-explainer {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.04) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .factory-rep-section {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .factory-rep-section:last-child {
            margin-bottom: 0;
        }

        .factory-rep-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }

        .factory-rep-header.earn { color: #22c55e; }
        .factory-rep-header.spend { color: var(--accent-primary); }

        .factory-rep-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .factory-rep-value {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .factory-rep-value.positive { color: #22c55e; }
        .factory-rep-value.cost { color: var(--accent-primary); }

        .factory-stat-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .factory-stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .factory-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .factory-proposals-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .factory-new-proposal-row {
            margin-bottom: 16px;
        }

        .factory-proposals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .factory-section-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
        }

        .factory-section-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .factory-section-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-section-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .factory-section-tab .section-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .factory-submit-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .factory-submit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Governance layout with sidebar */
        .factory-governance-layout {
            display: flex;
            gap: 20px;
        }

        .factory-app-filter {
            width: 200px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .factory-filter-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .factory-filter-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .factory-filter-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .factory-filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .factory-filter-option.active {
            background: var(--accent-primary);
            color: white;
        }

        .factory-filter-count {
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .factory-filter-option.active .factory-filter-count {
            background: rgba(255, 255, 255, 0.25);
        }

        /* App tags on cards */
        .factory-app-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            margin-bottom: 8px;
        }

        .factory-app-tag.new-app {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .factory-app-tag.general {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        /* Checkbox styling */
        .factory-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .factory-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .factory-kanban {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            flex: 1;
        }

        .factory-column {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            min-height: 300px;
        }

        .factory-column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .factory-column-count {
            margin-left: auto;
            background: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .factory-submitted-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: var(--bg-dark);
            padding: 4px;
            border-radius: 8px;
        }

        .factory-submitted-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .factory-submitted-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-submitted-tab.active {
            background: var(--accent-primary);
            color: white;
        }

        .factory-submitted-tab span {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        .factory-subtab-content {
            display: none;
        }

        .factory-subtab-content.active {
            display: block;
        }

        .factory-proposal-card {
            background: var(--bg-card-hover);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .factory-proposal-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .factory-admin-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .factory-admin-delete:hover {
            background: rgba(239, 68, 68, 0.4);
            opacity: 1;
        }

        .factory-proposal-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .factory-proposal-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .factory-proposal-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .factory-proposal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .factory-proposal-author {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .factory-vote-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .factory-vote-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .factory-vote-btn.for:hover:not(:disabled) {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }

        .factory-vote-btn.against:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .factory-vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .factory-vote-count {
            font-weight: 600;
        }

        .factory-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .factory-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* How it Works View */
        .factory-howitworks-content {
            max-width: 900px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .factory-howitworks-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
            gap: 24px;
        }

        .factory-howitworks-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
            text-align: center;
        }

        .factory-howitworks-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .factory-howitworks-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: var(--text-primary);
        }

        .factory-howitworks-detail {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .factory-howitworks-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-primary);
        }

        .factory-howitworks-value.highlight {
            color: #22c55e;
        }

        .factory-howitworks-note {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 16px 0 0 0;
        }

        .factory-howitworks-btn {
            margin-top: 16px;
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .factory-howitworks-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        /* Leaderboard View */
        .factory-leaderboard-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .factory-leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .factory-leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .factory-leaderboard-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .factory-leaderboard-rank {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }

        .factory-leaderboard-name {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .factory-leaderboard-credits {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* Factory Submit Modal */
        .factory-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .factory-modal-overlay.active {
            display: flex;
        }

        .factory-modal-content {
            background: var(--bg-sidebar);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .factory-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .factory-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .factory-modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .factory-form-group {
            margin-bottom: 16px;
        }

        .factory-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .factory-form-input,
        .factory-form-select,
        .factory-form-textarea {
            width: 100%;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 14px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
        }

        .factory-form-input:focus,
        .factory-form-select:focus,
        .factory-form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .factory-form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .factory-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .factory-modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .factory-modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .factory-modal-btn.submit {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .factory-modal-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Factory Comments */
        .factory-comments-section {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .factory-comments-section.open {
            display: block;
        }

        .factory-comments-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .factory-comment-item {
            padding: 10px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .factory-comment-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .factory-comment-author {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .factory-comment-time {
            color: var(--text-tertiary);
        }

        .factory-comment-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .factory-comment-form {
            display: flex;
            gap: 8px;
        }

        .factory-comment-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .factory-comment-submit {
            padding: 8px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .factory-no-comments {
            text-align: center;
            padding: 16px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .factory-comment-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .factory-comment-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
        }

        .factory-comment-btn.has-comments {
            color: var(--accent-primary);
        }

        @media (max-width: 900px) {
            .factory-sidebar-panel {
                display: none;
            }

            .factory-proposals-area {
                padding: 16px;
            }
        }

        @media (max-width: 768px) {
            .factory-view-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .factory-main-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .factory-proposals-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .factory-section-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .factory-kanban {
                grid-template-columns: 1fr;
            }

            .factory-governance-layout {
                flex-direction: column;
            }

            .factory-app-filter {
                width: 100%;
                position: static;
            }

            .factory-filter-options {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }

            .factory-filter-option {
                padding: 8px 12px;
                flex: 0 0 auto;
            }
        }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        /* Background effects */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 50% 60% at 40% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(2%, -2%) rotate(1deg); }
            100% { transform: translate(1%, 2%) rotate(0.5deg); }
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            overflow-x: hidden;
            max-width: 100%;
        }

        /* Hero/Welcome State */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.4s ease;
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }

        .welcome-state.chat-active {
            padding-top: 20px;
            justify-content: flex-start;
        }

        .welcome-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-state.chat-active .welcome-title {
            font-size: clamp(1.4rem, 3vw, 1.8rem);
            margin-bottom: 16px;
        }

        .welcome-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 480px;
        }

        .welcome-state.chat-active .welcome-subtitle {
            display: none;
        }

        /* Input Container */
        .input-container {
            width: 100%;
            max-width: min(680px, calc(100% - 24px));
        }

        .chat-input-wrapper {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 8px 8px 8px 24px;
            backdrop-filter: blur(20px);
            transition: all 0.3s ease;
        }

        .chat-input-wrapper:focus-within {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .chat-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 1.05rem;
            font-family: inherit;
            color: var(--text-primary);
            outline: none;
            padding: 14px 0;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .send-btn {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            border: none;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.4);
        }

        .send-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Chat Input Actions (+ and Tools buttons) */
        .chat-input-actions {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-right: 12px;
        }

        .chat-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.06);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            position: relative;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .chat-action-btn svg {
            width: 18px;
            height: 18px;
        }

        .chat-action-btn.attach-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Tools Dropdown */
        .tools-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            min-width: 200px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .tools-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .tools-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.85rem;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .tools-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tools-dropdown-item svg {
            width: 16px;
            height: 16px;
            color: var(--text-secondary);
        }

        .tools-dropdown-item span {
            flex: 1;
        }

        .tools-dropdown-item .tool-badge {
            font-size: 0.65rem;
            padding: 2px 6px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 4px;
        }

        /* Model Selector */
        .model-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            cursor: pointer;
            transition: all 0.2s;
            margin-right: 8px;
        }

        .model-selector:hover {
            border-color: var(--border-color);
            background: rgba(255, 255, 255, 0.06);
        }

        .model-selector-icon {
            width: 18px;
            height: 18px;
            border-radius: 4px;
        }

        .model-selector-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .model-selector svg {
            width: 12px;
            height: 12px;
            color: var(--text-tertiary);
        }

        /* Model Dropdown */
        .model-dropdown {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 8px;
            min-width: 280px;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
            z-index: 100;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .model-dropdown.active {
            opacity: 1;
            visibility: visible;
        }

        .model-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .model-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .model-dropdown-item.active {
            background: rgba(99, 102, 241, 0.1);
        }

        .model-dropdown-item img {
            width: 28px;
            height: 28px;
            border-radius: 6px;
        }

        .model-dropdown-item-info {
            flex: 1;
        }

        .model-dropdown-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-dropdown-item-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .model-dropdown-item .model-pro-badge {
            font-size: 0.6rem;
            padding: 2px 6px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 4px;
            font-weight: 600;
        }

        /* Quick Suggestions */
        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            justify-content: center;
        }

        .suggestion-chip {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid var(--border-subtle);
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
        }

        .suggestion-chip:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-1px);
        }

        /* Chat Container */
        .chat-container {
            width: 100%;
            max-width: min(680px, calc(100% - 24px));
            margin: 0 auto;
            padding: 0 24px 40px;
            display: none;
        }

        .chat-container.active {
            display: block;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-x: hidden;
            max-width: 100%;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 14px;
            max-width: 90%;
            animation: messageSlide 0.4s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            border: 1px solid var(--border-subtle);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
        }

        .message.assistant .message-avatar {
            background: var(--bg-card);
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.65;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: var(--bg-card);
            color: var(--text-primary);
            border: 1px solid var(--border-subtle);
            border-bottom-left-radius: 6px;
        }

        /* Ensure code blocks don't overflow */
        .message-content pre,
        .message-content code {
            max-width: 100%;
            overflow-x: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        /* App Cards in Chat */
        .app-card-inline {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .app-card-inline:hover {
            background: rgba(99, 102, 241, 0.12);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .app-icon-inline {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            color: white;
        }

        .app-icon-inline img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        .app-icon-inline svg {
            width: 28px;
            height: 28px;
        }

        .app-info-inline h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .app-info-inline p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .app-arrow {
            margin-left: auto;
            width: 36px;
            height: 36px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .app-card-inline:hover .app-arrow {
            background: var(--accent-primary);
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 16px 20px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Feedback Buttons */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .feedback-btn {
            padding: 8px 14px;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feedback-btn:hover {
            background: var(--bg-card);
            border-color: var(--border-hover);
            color: var(--text-secondary);
        }

        .feedback-btn.active-good {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .feedback-btn.active-bad {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .quick-action-btn {
            padding: 10px 16px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.08);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        /* Use Cases Section */
        .use-cases-section {
            width: 100%;
            max-width: min(900px, calc(100% - 32px));
            margin: 32px auto 0;
            padding: 0 16px;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .use-cases-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .use-cases-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .use-cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(280px, 100%), 1fr));
            gap: 16px;
        }

        .use-case-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .use-case-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .use-case-query {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .use-case-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .use-case-app {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .use-case-app-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: white;
        }

        .use-case-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .use-case-app-icon svg {
            width: 14px;
            height: 14px;
        }

        .use-case-app-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .use-case-helpful {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .use-case-helpful svg {
            width: 14px;
            height: 14px;
        }

        .intent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 100px;
            margin-bottom: 10px;
        }

        .intent-badge.problem { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .intent-badge.desire { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
        .intent-badge.idea { background: rgba(234, 179, 8, 0.15); color: #eab308; }
        .intent-badge.find { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .intent-badge.change { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .intent-badge.build { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

        /* Loading skeleton */
        .use-case-card.skeleton {
            pointer-events: none;
        }

        .skeleton-text {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === IMPORT MODAL === */
        .import-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .import-modal-overlay.active {
            display: flex;
        }

        .import-modal {
            background: linear-gradient(180deg, #151520 0%, #0d0d14 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .import-modal-header {
            padding: 28px 28px 0;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .import-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .import-modal-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-modal-close {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.2rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .import-modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .import-modal-body {
            padding: 28px;
        }

        .import-sources {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-source {
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-source:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-source.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .import-source-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .import-source-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .import-instructions {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-instructions h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-instructions ol {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding-left: 20px;
            line-height: 1.8;
        }

        .import-instructions code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .import-dropzone {
            border: 2px dashed var(--border-subtle);
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .import-dropzone:hover,
        .import-dropzone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .import-dropzone-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .import-dropzone h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-dropzone p {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .import-dropzone-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-file-input {
            display: none;
        }

        .import-privacy {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-privacy h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-privacy p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .import-consent {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .import-consent label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .import-consent input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        .import-progress {
            display: none;
            text-align: center;
            padding: 40px 24px;
        }

        .import-progress.active {
            display: block;
        }

        .import-progress-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .import-progress h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-progress p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .import-progress-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .import-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .import-results {
            display: none;
        }

        .import-results.active {
            display: block;
        }

        .import-results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .import-results-header .success-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .import-results-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .import-results-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-stat {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .import-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .import-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .import-insights {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .import-insights h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .import-insight-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .import-insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .import-insight-content h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-insight-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-recommendations {
            margin-bottom: 24px;
        }

        .import-recommendations h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-app-rec {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .import-app-rec:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .import-app-info h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-app-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .import-app-match {
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 100px;
        }

        .import-unmatched {
            margin-bottom: 24px;
        }

        .import-unmatched h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .unmatched-idea {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .unmatched-idea-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .unmatched-idea-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .unmatched-idea-category {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 100px;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .unmatched-idea-request {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            cursor: pointer;
        }

        .import-summary-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 8px;
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 10px;
            border-left: 3px solid var(--accent-primary);
        }

        .import-cta {
            display: flex;
            gap: 12px;
        }

        .import-cta-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
        }

        .import-cta-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .import-cta-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                flex-direction: row !important;
                justify-content: flex-start !important;
                align-items: center !important;
            }

            .mobile-header > * {
                margin-left: 0 !important;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding-top: 56px;
                max-width: 100vw;
                width: 100%;
            }

            .bg-gradient {
                left: 0;
            }

            .welcome-state {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: clamp(1.25rem, 5vw, 1.75rem);
            }

            .welcome-subtitle {
                font-size: 0.95rem;
                margin-bottom: 24px;
            }

            .chat-input-wrapper {
                padding: 6px 6px 6px 18px;
                border-radius: 16px;
            }

            .chat-input {
                font-size: 1rem;
                padding: 12px 0;
            }

            .send-btn {
                width: 46px;
                height: 46px;
                border-radius: 12px;
            }

            .quick-suggestions {
                gap: 6px;
            }

            .suggestion-chip {
                padding: 6px 12px;
                font-size: 0.8rem;
            }

            .use-cases-section {
                padding: 0 16px;
            }

            .use-cases-grid {
                grid-template-columns: 1fr;
            }

            .chat-container {
                padding: 0 16px 30px;
                padding-bottom: max(30px, env(safe-area-inset-bottom));
            }

            .message {
                max-width: 88%;
            }

            .input-container {
                max-width: 100%;
                padding: 0 12px;
            }

            .chat-area {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            .sidebar {
                padding-top: max(16px, env(safe-area-inset-top));
                z-index: 1000;
                width: 280px;
            }

            .sidebar-overlay {
                z-index: 999;
            }

            .import-sources {
                grid-template-columns: 1fr;
            }

            .import-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .send-btn {
                width: 40px;
                height: 40px;
                border-radius: 10px;
            }

            .send-btn svg {
                width: 18px;
                height: 18px;
            }

            .apps-view-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .apps-view-item {
                padding: 12px 8px;
            }

            .apps-view-item-icon {
                width: 48px;
                height: 48px;
            }

            .quick-suggestions {
                display: none;
            }

            .welcome-title {
                font-size: 1.25rem;
            }

            .chat-input-wrapper {
                padding: 4px 4px 4px 14px;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .welcome-state {
                padding: 12px 24px;
            }

            .welcome-title {
                font-size: 1.25rem;
                margin-bottom: 8px;
            }

            .welcome-subtitle {
                display: none;
            }

            .main-content {
                padding-top: 48px;
            }

            .mobile-header {
                height: 48px;
            }

            .use-cases-section {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

        /* PWA Install Prompt */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 16px;
            padding: 16px 20px;
            z-index: 200;
            max-width: 400px;
            width: calc(100% - 48px);
            animation: slideUp 0.3s ease;
        }

        .pwa-install-prompt.visible {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .pwa-install-icon {
            width: 32px;
            height: 32px;
            color: var(--accent-primary);
        }

        .pwa-install-icon svg {
            width: 100%;
            height: 100%;
        }

        .pwa-install-text h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .pwa-install-text p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .pwa-install-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .pwa-install-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .pwa-install-btn.primary {
            background: white;
            color: var(--accent-primary);
        }

        .pwa-install-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Hide main nav in this view */
        #main-nav {
            display: none !important;
        }
    </style>
</head>
<body class="logged-out">
    <!-- Auth Header (shown when logged out) -->
    <header class="auth-header" id="authHeader">
        <a href="https://getsuite.app" class="auth-header-logo">
            <div class="auth-header-logo-icon">S</div>
            <span class="auth-header-logo-text">SuiteGPT</span>
        </a>
        <div class="auth-header-buttons">
            <button class="auth-btn auth-btn-login" onclick="openLoginModal()">Log in</button>
            <button class="auth-btn auth-btn-signup" onclick="openSignupModal()">Sign up for free</button>
        </div>
    </header>

    <!-- Sidebar Open Button (shown when sidebar collapsed) -->
    <button class="sidebar-open-btn" id="sidebarOpenBtn" onclick="openSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18" stroke-linecap="round"/>
        </svg>
    </button>

    <!-- App Layout -->
    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo">
                    <img src="/suitegpt-logo.png" alt="SuiteGPT" class="sidebar-logo-icon">
                    <span class="sidebar-logo-text">SuiteGPT</span>
                </a>
                <button class="sidebar-close-btn" onclick="closeSidebar()" title="Close sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <button class="sidebar-item new-chat-btn" id="newChatBtn" onclick="startNewChat()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>New Chat</span>
                    </button>
                    <button class="sidebar-item" id="searchChatsBtn" onclick="toggleChatSearch()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35" stroke-linecap="round"/>
                            </svg>
                        </span>
                        <span>Search Chats</span>
                    </button>
                    <button class="sidebar-item" id="appsBtn" onclick="openAppsPanel()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                        </span>
                        <span>Apps</span>
                    </button>
                    <button class="sidebar-item" id="creatorDashboardBtn" onclick="openCreatorDashboard()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                        </span>
                        <span>Creator Dashboard</span>
                    </button>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-title">Your chats</div>
                    <button class="sidebar-item" id="chatHistoryBtn">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </span>
                        <span>Chat History</span>
                    </button>
                </div>
                <div class="sidebar-section sidebar-your-apps">
                    <div class="sidebar-section-title sidebar-expandable" onclick="toggleYourApps()">
                        <span>Your Apps <span id="yourAppsCount">(0)</span></span>
                        <svg class="expand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="sidebar-apps-list" id="sidebarAppsList">
                        <!-- Dynamically populated app tabs -->
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <!-- Main View -->
                    <div class="profile-dropdown-view" id="profileMainView">
                        <!-- Credits Section -->
                        <div class="profile-dropdown-credits" id="profileCreditsSection">
                            <div class="credits-display clickable" onclick="openCreditsModal()">
                                <div class="credits-info">
                                    <span class="credits-label">Credits: <span id="dropdownCredits">0</span></span>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-tertiary);">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <!-- Linked Accounts Section -->
                        <div class="linked-accounts-section" id="linkedAccountsSection">
                            <div class="linked-accounts-header">Linked Accounts</div>
                            <div id="linkedAccountsList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <button onclick="showSettingsView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                            </svg>
                            Settings
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-tertiary);">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Settings View -->
                    <div class="profile-dropdown-view" id="profileSettingsView" style="display: none;">
                        <button onclick="showMainView()" class="profile-dropdown-item profile-dropdown-back">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Back
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <button onclick="openDocsView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                            </svg>
                            Documentation
                        </button>
                        <button onclick="openLearnView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            Learn
                        </button>
                        <a href="https://t.me/getsuiteapp" target="_blank" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                            </svg>
                            Community Chat
                        </a>
                        <button onclick="showMainView(); toggleProfileDropdown(); openFactory();" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M2 20h20M5 20V8l7-5 7 5v12M9 20v-6h6v6"/>
                                <path d="M9 12h.01M15 12h.01"/>
                            </svg>
                            Factory (Governance)
                        </button>
                        <button onclick="showMainView(); toggleProfileDropdown(); triggerHistoryImport();" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import History
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <button onclick="showAIDashboardView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1a7 7 0 01-7 7H9a7 7 0 01-7-7H1a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/>
                                <circle cx="12" cy="14" r="3"/>
                            </svg>
                            AI Notifications
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-tertiary);">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>

                    <!-- AI Notifications Settings View -->
                    <div class="profile-dropdown-view" id="profileAIDashboardView" style="display: none;">
                        <button onclick="showSettingsView()" class="profile-dropdown-item profile-dropdown-back">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Back
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <div class="ai-settings-section">
                            <div class="ai-settings-header">Personal AI Notifications</div>
                            <p class="ai-settings-desc">Enable cloud sync and AI insights to get personalized analysis across your apps.</p>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">Cloud Sync</span>
                                    <span class="ai-setting-help">Sync app data across devices</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="aiSettingCloudSync" onchange="toggleAISetting('data_sync_enabled', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">AI Insights</span>
                                    <span class="ai-setting-help">Allow AI to analyze your data</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="aiSettingInsights" onchange="toggleAISetting('ai_insights_enabled', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">Notifications</span>
                                    <span class="ai-setting-help">Insight digest frequency</span>
                                </div>
                                <select class="ai-setting-select" id="aiSettingNotifications" onchange="updateNotificationFrequency(this.value)">
                                    <option value="never">Never</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>

                            <div class="ai-apps-section" id="aiAppsSection" style="display: none;">
                                <div class="ai-setting-label" style="margin-bottom: 8px;">Apps AI can access:</div>
                                <div id="aiAppsCheckboxes">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sidebar-profile" id="sidebarProfile" onclick="toggleProfileDropdown()">
                    <div class="sidebar-profile-avatar" id="sidebarAvatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="sidebar-profile-info">
                        <div class="sidebar-profile-name" id="sidebarProfileName">Guest</div>
                        <div class="sidebar-profile-row" id="sidebarProfileRow">
                            <span class="sidebar-profile-status" id="sidebarProfileStatus">Not signed in</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn"></button>
            <span class="mobile-title">SuiteGPT</span>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Background -->
            <div class="bg-gradient"></div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome State -->
                <section class="welcome-state" id="welcomeState">
                    <h1 class="welcome-title">What do you need?</h1>
                    <p class="welcome-subtitle">Describe your problem, and we'll find or build the solution.</p>

                    <div class="input-container">
                        <div class="chat-input-wrapper">
                            <div class="chat-input-actions">
                                <button class="chat-action-btn attach-btn" id="attachBtn" title="Attach file">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,.pdf,.txt,.doc,.docx">
                                </button>
                                <button class="chat-action-btn tools-btn" id="toolsBtn" title="Tools">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                                    </svg>
                                    <div class="tools-dropdown" id="toolsDropdown">
                                        <button class="tools-dropdown-item" onclick="selectTool('web-search')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <line x1="2" y1="12" x2="22" y2="12"/>
                                                <path d="M12 2a15.3 15.3 0 014 10 15.3 15.3 0 01-4 10 15.3 15.3 0 01-4-10 15.3 15.3 0 014-10z"/>
                                            </svg>
                                            <span>Web Search</span>
                                        </button>
                                        <button class="tools-dropdown-item" onclick="selectTool('image-gen')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                <circle cx="8.5" cy="8.5" r="1.5"/>
                                                <polyline points="21 15 16 10 5 21"/>
                                            </svg>
                                            <span>Image Generation</span>
                                            <span class="tool-badge">Pro</span>
                                        </button>
                                        <button class="tools-dropdown-item" onclick="selectTool('code')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <polyline points="16 18 22 12 16 6"/>
                                                <polyline points="8 6 2 12 8 18"/>
                                            </svg>
                                            <span>Code Interpreter</span>
                                        </button>
                                        <button class="tools-dropdown-item" onclick="selectTool('voice')">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                                                <path d="M19 10v2a7 7 0 01-14 0v-2"/>
                                                <line x1="12" y1="19" x2="12" y2="23"/>
                                                <line x1="8" y1="23" x2="16" y2="23"/>
                                            </svg>
                                            <span>Voice Mode</span>
                                            <span class="tool-badge">Pro</span>
                                        </button>
                                    </div>
                                </button>
                            </div>
                            <input
                                type="text"
                                class="chat-input"
                                id="chatInput"
                                placeholder="I need help with..."
                                autocomplete="off"
                            >
                            <div class="model-selector" id="modelSelector" onclick="toggleModelDropdown(event)">
                                <img src="/assets/icons/claude-icon.png" alt="Claude" class="model-selector-icon" id="modelIcon" onerror="this.style.display='none'">
                                <span class="model-selector-name" id="modelName">Claude</span>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="6 9 12 15 18 9"/>
                                </svg>
                                <div class="model-dropdown" id="modelDropdown">
                                    <button class="model-dropdown-item active" onclick="selectModel('claude', 'Claude Sonnet', '/assets/icons/claude-icon.png')">
                                        <img src="/assets/icons/claude-icon.png" alt="Claude" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23d97706%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">
                                        <div class="model-dropdown-item-info">
                                            <div class="model-dropdown-item-name">Claude Sonnet</div>
                                            <div class="model-dropdown-item-desc">Fast & intelligent</div>
                                        </div>
                                    </button>
                                    <button class="model-dropdown-item" onclick="selectModel('claude-opus', 'Claude Opus', '/assets/icons/claude-icon.png')">
                                        <img src="/assets/icons/claude-icon.png" alt="Claude" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%23d97706%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">
                                        <div class="model-dropdown-item-info">
                                            <div class="model-dropdown-item-name">Claude Opus</div>
                                            <div class="model-dropdown-item-desc">Most capable</div>
                                        </div>
                                        <span class="model-pro-badge">Pro</span>
                                    </button>
                                    <button class="model-dropdown-item" onclick="selectModel('gpt4o', 'GPT-4o', '/assets/icons/openai-icon.png')">
                                        <img src="/assets/icons/openai-icon.png" alt="GPT-4" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%2310a37f%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">
                                        <div class="model-dropdown-item-info">
                                            <div class="model-dropdown-item-name">GPT-4o</div>
                                            <div class="model-dropdown-item-desc">OpenAI's flagship</div>
                                        </div>
                                    </button>
                                    <button class="model-dropdown-item" onclick="selectModel('gemini', 'Gemini Pro', '/assets/icons/gemini-icon.png')">
                                        <img src="/assets/icons/gemini-icon.png" alt="Gemini" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%234285f4%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">
                                        <div class="model-dropdown-item-info">
                                            <div class="model-dropdown-item-name">Gemini Pro</div>
                                            <div class="model-dropdown-item-desc">Google's best</div>
                                        </div>
                                    </button>
                                    <button class="model-dropdown-item" onclick="selectModel('llama', 'Llama 3', '/assets/icons/meta-icon.png')">
                                        <img src="/assets/icons/meta-icon.png" alt="Llama" onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%230668E1%22><circle cx=%2212%22 cy=%2212%22 r=%2210%22/></svg>'">
                                        <div class="model-dropdown-item-info">
                                            <div class="model-dropdown-item-name">Llama 3</div>
                                            <div class="model-dropdown-item-desc">Open source</div>
                                        </div>
                                    </button>
                                </div>
                            </div>
                            <button class="send-btn" id="sendBtn" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M5 12h14M12 5l7 7-7 7" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </button>
                        </div>

                        <!-- Quick Suggestions -->
                        <div class="quick-suggestions">
                            <button class="suggestion-chip" data-query="I want to track my fitness">Fitness</button>
                            <button class="suggestion-chip" data-query="I can't sleep well at night">Sleep</button>
                            <button class="suggestion-chip" data-query="I want to build better habits">Habits</button>
                            <button class="suggestion-chip" data-query="I need help focusing at work">Focus</button>
                            <button class="suggestion-chip" data-query="I feel stressed and anxious">Stress</button>
                            <button class="suggestion-chip" data-query="I never drink enough water">Water</button>
                            <button class="suggestion-chip" data-query="I want to read more books">Reading</button>
                            <button class="suggestion-chip" data-query="I need date night ideas">Date</button>
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages" id="chatMessages"></div>
                    </div>

                    <!-- Use Cases Section -->
                    <div class="use-cases-section" id="useCasesSection">
                        <div class="use-cases-header">
                            <div class="use-cases-title">Example conversations <span id="useCaseCount"></span></div>
                        </div>
                        <div class="use-cases-grid" id="useCasesGrid">
                            <!-- Loading skeletons -->
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 90%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 70%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 40%;"></div>
                            </div>
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 85%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 60%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 45%;"></div>
                            </div>
                            <div class="use-case-card skeleton">
                                <div class="skeleton-text" style="height: 20px; width: 80%; margin-bottom: 8px;"></div>
                                <div class="skeleton-text" style="height: 20px; width: 65%; margin-bottom: 16px;"></div>
                                <div class="skeleton-text" style="height: 16px; width: 35%;"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Inline Apps View -->
                <section class="apps-view" id="appsView">
                    <div class="apps-view-header">
                        <h2 class="apps-view-title">All Apps</h2>
                    </div>
                    <div class="apps-view-search">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"/>
                            <path d="M21 21l-4.35-4.35"/>
                        </svg>
                        <input type="text" id="appsViewSearch" placeholder="Search apps..." oninput="filterAppsInline(this.value)">
                    </div>
                    <div class="apps-view-grid" id="appsViewGrid">
                        <!-- Apps will be populated by JavaScript -->
                    </div>
                </section>

                <!-- Inline Learn View -->
                <section class="learn-view" id="learnView">
                    <div class="learn-view-header">
                        <h2 class="learn-view-title">Learn</h2>
                    </div>
                    <p class="learn-view-subtitle">Articles, guides, and deep dives into SUITE and AI-powered apps.</p>

                    <div class="learn-articles-grid" id="learnArticlesGrid">
                        <!-- Fitness Apps Article -->
                        <div class="learn-article-card" data-article="fitness" onclick="showArticle('fitness')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag new">NEW</span>
                                    <span class="learn-article-tag">Fitness</span>
                                    <span class="learn-article-tag">Apps</span>
                                </div>
                                <div class="learn-article-title">5 Best Free AI Fitness Apps (2026)</div>
                                <p class="learn-article-desc">Discover the best free AI-powered fitness apps for tracking water, sleep, steps, meals, and stretching. No ads, no subscriptions.</p>
                                <div class="learn-article-meta">5 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>

                        <!-- AI Fleet Article -->
                        <div class="learn-article-card" data-article="ai-fleet" onclick="showArticle('ai-fleet')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag">AI</span>
                                    <span class="learn-article-tag">Philosophy</span>
                                </div>
                                <div class="learn-article-title">The AI Fleet: Apps That Build Themselves</div>
                                <p class="learn-article-desc">Every day, our AI builds a new app. Stake to keep it alive. Earn from its success. This is inside-out UBI.</p>
                                <div class="learn-article-meta">6 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>

                        <!-- Yield-Powered App Article -->
                        <div class="learn-article-card" data-article="yield" onclick="showArticle('yield')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag">DeFi</span>
                                    <span class="learn-article-tag">Tokenomics</span>
                                </div>
                                <div class="learn-article-title">The Yield-Powered App: Free to Use, Paid by DeFi</div>
                                <p class="learn-article-desc">How we killed the monthly subscription. Your deposit generates yield that pays for AI  forever.</p>
                                <div class="learn-article-meta">5 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>
                    </div>

                    <!-- Article Content Area -->
                    <div class="learn-article-reader" id="learnArticleReader" style="display: none;">
                        <div class="learn-article-reader-header">
                            <button class="learn-view-back" onclick="hideArticle()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 18l-6-6 6-6"/>
                                </svg>
                                Back to Articles
                            </button>
                        </div>
                        <div class="learn-article-reader-content" id="learnArticleContent">
                            <!-- Article content loads here -->
                        </div>
                    </div>
                </section>

                <!-- Inline Docs View -->
                <section class="learn-view" id="docsView">
                    <div class="learn-view-header">
                        <h2 class="learn-view-title">Documentation</h2>
                    </div>
                    <p class="learn-view-subtitle">Guides and references for using SUITE.</p>

                    <div class="learn-articles-grid">
                        <a href="https://getsuite.app/docs/suitegpt-guide.html" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">SuiteGPT Guide</div>
                                <p class="learn-article-desc">Learn how to use SuiteGPT to find, change, or build any app you need.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>

                        <a href="https://getsuite.app/docs/earning.html" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">Earning on SUITE</div>
                                <p class="learn-article-desc">How to earn credits and rewards by participating in the ecosystem.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>

                        <a href="https://getsuite.app/docs/vault.html" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">The Vault</div>
                                <p class="learn-article-desc">Deposit crypto, earn yield, and use apps for free forever.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>

                        <a href="https://getsuite.app/docs/app-operators.html" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">App Operators</div>
                                <p class="learn-article-desc">Become an operator and help run SUITE apps.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>

                        <a href="https://getsuite.app/docs/governance.html" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">Governance</div>
                                <p class="learn-article-desc">How community voting and proposals work in the Factory.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>

                        <a href="https://getsuite.app/docs/" target="_blank" class="learn-article-card">
                            <div class="learn-article-content">
                                <div class="learn-article-title">View All Docs</div>
                                <p class="learn-article-desc">Browse the complete documentation on getsuite.app.</p>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </a>
                    </div>
                </section>

                <!-- Creator Dashboard -->
                <section class="creator-dashboard" id="creatorDashboard">
                    <div class="creator-dashboard-header">
                        <h2 class="creator-dashboard-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                            Creator Dashboard
                        </h2>
                    </div>

                    <div class="creator-dashboard-tabs">
                        <button class="creator-dashboard-tab active" data-tab="your-apps" onclick="switchDashboardTab('your-apps')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            Your Apps
                        </button>
                        <button class="creator-dashboard-tab" data-tab="create" onclick="switchDashboardTab('create')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Create
                        </button>
                        <button class="creator-dashboard-tab" data-tab="earnings" onclick="switchDashboardTab('earnings')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                            Earnings
                        </button>
                        <button class="creator-dashboard-tab" data-tab="my-requests" onclick="switchDashboardTab('my-requests')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            My Requests
                        </button>
                    </div>

                    <!-- Your Apps Tab Panel -->
                    <div class="creator-dashboard-panel active" id="dashboardPanelYourApps">
                        <div class="your-apps-header">
                            <h3 class="your-apps-title">Your Apps / Projects</h3>
                            <button class="your-apps-create-btn" onclick="switchDashboardTab('create')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                </svg>
                                Create New
                            </button>
                        </div>

                        <!-- Empty State -->
                        <div class="your-apps-empty" id="dashboardAppsEmpty" style="display: none;">
                            <div class="your-apps-empty-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                </svg>
                            </div>
                            <h3>No apps saved yet</h3>
                            <p>Add apps to your profile from the Apps gallery, or create a new app proposal.</p>
                            <button class="your-apps-create-btn" onclick="switchDashboardTab('create')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                </svg>
                                Create Something
                            </button>
                        </div>

                        <!-- Apps Content -->
                        <div class="your-apps-content" id="dashboardAppsContent">
                            <div class="your-apps-tier" id="dashboardTierTools" style="display: none;">
                                <div class="your-apps-tier-header">
                                    <span class="your-apps-tier-icon"></span>
                                    <h3 class="your-apps-tier-title">Tools</h3>
                                    <span class="your-apps-tier-count" id="dashboardToolsCount">0</span>
                                </div>
                                <div class="your-apps-grid" id="dashboardToolsGrid"></div>
                            </div>
                            <div class="your-apps-tier" id="dashboardTierApps" style="display: none;">
                                <div class="your-apps-tier-header">
                                    <span class="your-apps-tier-icon"></span>
                                    <h3 class="your-apps-tier-title">Apps</h3>
                                    <span class="your-apps-tier-count" id="dashboardAppsCount">0</span>
                                </div>
                                <div class="your-apps-grid" id="dashboardAppsGrid"></div>
                            </div>
                            <div class="your-apps-tier" id="dashboardTierSolutions" style="display: none;">
                                <div class="your-apps-tier-header">
                                    <span class="your-apps-tier-icon"></span>
                                    <h3 class="your-apps-tier-title">Solutions</h3>
                                    <span class="your-apps-tier-count" id="dashboardSolutionsCount">0</span>
                                </div>
                                <div class="your-apps-grid" id="dashboardSolutionsGrid"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Create Tab Panel -->
                    <div class="creator-dashboard-panel" id="dashboardPanelCreate">
                        <p class="create-view-subtitle">Choose what you'd like to build</p>

                        <!-- AI Agents & Bots Section -->
                    <div class="create-section">
                        <h3 class="create-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1v1a2 2 0 01-2 2H5a2 2 0 01-2-2v-1H2a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/>
                                <circle cx="9" cy="13" r="1"/><circle cx="15" cy="13" r="1"/>
                                <path d="M9 17h6"/>
                            </svg>
                            AI Agents & Bots
                        </h3>
                        <div class="create-view-grid">
                            <div class="create-card" onclick="startCreate('chatbot')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #6366f1, #8b5cf6);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Custom Chatbot</h3>
                                    <p>Build an AI assistant trained on your data</p>
                                </div>
                            </div>

                            <div class="create-card" onclick="startCreate('agent')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #ec4899, #db2777);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>AI Agent</h3>
                                    <p>Autonomous agent that takes actions for you</p>
                                </div>
                            </div>

                            <div class="create-card" onclick="startCreate('voice-bot')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 1a3 3 0 00-3 3v8a3 3 0 006 0V4a3 3 0 00-3-3z"/>
                                        <path d="M19 10v2a7 7 0 01-14 0v-2"/>
                                        <line x1="12" y1="19" x2="12" y2="23"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Voice Assistant</h3>
                                    <p>Voice-enabled bot for calls and interactions</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Mini Apps & Gadgets Section -->
                    <div class="create-section">
                        <h3 class="create-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                            Mini Apps & Gadgets
                        </h3>
                        <div class="create-view-grid">
                            <div class="create-card" onclick="startCreate('utility')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #22c55e, #16a34a);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Utility Tool</h3>
                                    <p>Quick calculators, converters, generators</p>
                                </div>
                            </div>

                            <div class="create-card" onclick="startCreate('tracker')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #f97316, #ea580c);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <line x1="18" y1="20" x2="18" y2="10"/>
                                        <line x1="12" y1="20" x2="12" y2="4"/>
                                        <line x1="6" y1="20" x2="6" y2="14"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Personal Tracker</h3>
                                    <p>Track habits, goals, health, or finances</p>
                                </div>
                            </div>

                            <div class="create-card" onclick="startCreate('widget')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #a855f7, #7c3aed);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                        <line x1="3" y1="9" x2="21" y2="9"/>
                                        <line x1="9" y1="21" x2="9" y2="9"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Dashboard Widget</h3>
                                    <p>Embeddable components for your workspace</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Business & Enterprise Section -->
                    <div class="create-section">
                        <h3 class="create-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
                                <path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16"/>
                            </svg>
                            Business & Enterprise
                            <span class="create-section-badge">Premium</span>
                        </h3>
                        <div class="create-view-grid">
                            <div class="create-card premium" onclick="startCreate('saas')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #eab308, #ca8a04);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                                        <path d="M2 17l10 5 10-5"/>
                                        <path d="M2 12l10 5 10-5"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Full SaaS Application</h3>
                                    <p>Complete web app with auth, database, payments</p>
                                </div>
                            </div>

                            <div class="create-card premium" onclick="startCreate('internal-tool')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #64748b, #475569);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"/>
                                        <line x1="8" y1="21" x2="16" y2="21"/>
                                        <line x1="12" y1="17" x2="12" y2="21"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Internal Tool</h3>
                                    <p>Admin panels, CRMs, inventory systems</p>
                                </div>
                            </div>

                            <div class="create-card premium" onclick="startCreate('automation')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #06b6d4, #0891b2);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="16 18 22 12 16 6"/>
                                        <polyline points="8 6 2 12 8 18"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Workflow Automation</h3>
                                    <p>Connect APIs, automate processes at scale</p>
                                </div>
                            </div>

                            <div class="create-card premium" onclick="startCreate('mobile-app')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #f43f5e, #e11d48);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                                        <line x1="12" y1="18" x2="12.01" y2="18"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Mobile App</h3>
                                    <p>Native iOS & Android applications</p>
                                </div>
                            </div>

                            <div class="create-card premium" onclick="startCreate('api')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #8b5cf6, #6d28d9);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                                        <polyline points="22,6 12,13 2,6"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>API Service</h3>
                                    <p>Backend APIs and microservices</p>
                                </div>
                            </div>

                            <div class="create-card premium" onclick="startCreate('enterprise')">
                                <div class="create-card-icon" style="background: linear-gradient(135deg, #1e293b, #0f172a);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 21h18"/>
                                        <path d="M5 21V7l8-4v18"/>
                                        <path d="M19 21V11l-6-4"/>
                                        <path d="M9 9v.01M9 12v.01M9 15v.01M9 18v.01"/>
                                    </svg>
                                </div>
                                <div class="create-card-content">
                                    <h3>Enterprise Solution</h3>
                                    <p>Custom enterprise-grade systems</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    </div>

                    <!-- Earnings Tab Panel -->
                    <div class="creator-dashboard-panel" id="dashboardPanelEarnings">
                        <div class="earnings-header">
                        <div class="earnings-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <h1>Creator Monetization Program</h1>
                        <p>Get paid when users engage with your bots and apps.</p>
                    </div>

                    <div class="earnings-steps">
                        <div class="earnings-step">
                            <div class="earnings-step-num">1</div>
                            <div class="earnings-step-text">
                                <h3>Enroll</h3>
                                <p>Join the creator program below</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">2</div>
                            <div class="earnings-step-text">
                                <h3>Configure</h3>
                                <p>Set monetization for each bot or app</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">3</div>
                            <div class="earnings-step-text">
                                <h3>Share</h3>
                                <p>Promote your apps to attract users</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">4</div>
                            <div class="earnings-step-text">
                                <h3>Earn</h3>
                                <p>Get paid when users interact</p>
                            </div>
                        </div>
                    </div>

                    <div class="earnings-cta">
                        <button class="earnings-enroll-btn" onclick="enrollCreator()">Enroll Now</button>
                        <p class="earnings-terms">
                            By enrolling, you agree to SUITE's <a href="/terms/creator-earnings.html">Creator Terms</a>.
                        </p>
                    </div>

                    <div class="earnings-cards">
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                                </svg>
                            </div>
                            <h4>70% Revenue</h4>
                            <p>Keep most of what you earn</p>
                        </div>
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                                </svg>
                            </div>
                            <h4>Per Message</h4>
                            <p>Earn on every interaction</p>
                        </div>
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                            </div>
                            <h4>Analytics</h4>
                            <p>Track growth in real-time</p>
                        </div>
                    </div>
                    </div>

                    <!-- My Requests Tab Panel -->
                    <div class="creator-dashboard-panel" id="dashboardPanelMyRequests">
                        <div class="my-requests-header">
                            <h3>My Requests</h3>
                            <p>Track your app proposals and feature requests</p>
                        </div>

                        <div class="my-requests-empty" id="myRequestsEmpty">
                            <div class="my-requests-empty-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h4>No requests yet</h4>
                            <p>When you submit app proposals or feature requests, they'll appear here so you can track their progress.</p>
                            <button class="your-apps-create-btn" onclick="switchDashboardTab('create')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                </svg>
                                Create Something
                            </button>
                        </div>

                        <div class="my-requests-list" id="myRequestsList" style="display: none;">
                            <!-- Requests will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Legacy Your Apps/Projects View (kept for backwards compatibility) -->
                <section class="your-apps-view" id="yourAppsView" style="display: none !important;">
                    <div class="your-apps-header">
                        <h2 class="your-apps-title">Your Apps / Projects</h2>
                        <button class="your-apps-create-btn" onclick="openCreateAppModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Create New
                        </button>
                    </div>

                    <!-- Empty State (shown when no apps saved) -->
                    <div class="your-apps-empty" id="yourAppsEmpty" style="display: none;">
                        <div class="your-apps-empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>No apps saved yet</h3>
                        <p>Add apps to your profile from the Apps gallery, or create a new app proposal below.</p>
                        <button class="your-apps-create-btn" onclick="openCreateAppModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Propose New App
                        </button>
                    </div>

                    <!-- Apps Content (shown when apps exist) -->
                    <div class="your-apps-content" id="yourAppsContent">
                        <!-- Tools Tier -->
                        <div class="your-apps-tier" id="yourAppsTierTools" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Tools</h3>
                                <span class="your-apps-tier-count" id="yourAppsToolsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsToolsGrid"></div>
                        </div>

                        <!-- Apps Tier -->
                        <div class="your-apps-tier" id="yourAppsTierApps" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Apps</h3>
                                <span class="your-apps-tier-count" id="yourAppsAppsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsAppsGrid"></div>
                        </div>

                        <!-- Solutions Tier -->
                        <div class="your-apps-tier" id="yourAppsTierSolutions" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Solutions</h3>
                                <span class="your-apps-tier-count" id="yourAppsSolutionsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsSolutionsGrid"></div>
                        </div>
                    </div>
                </section>

                <!-- Proposal Modal -->
                <div class="proposal-modal-overlay" id="proposalModalOverlay" onclick="closeProposalModal(event)">
                    <div class="proposal-modal" onclick="event.stopPropagation()">
                        <div class="proposal-modal-header">
                            <h3 class="proposal-modal-title" id="proposalModalTitle">Propose Refinement</h3>
                            <button class="proposal-modal-close" onclick="closeProposalModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="proposal-modal-body">
                            <!-- App Info (for refinements) -->
                            <div class="proposal-modal-app" id="proposalModalApp" style="display: none;">
                                <div class="proposal-modal-app-icon" id="proposalModalAppIcon"></div>
                                <div class="proposal-modal-app-name" id="proposalModalAppName"></div>
                            </div>

                            <!-- Tier Selection (for new apps) -->
                            <div class="tier-options" id="proposalTierOptions" style="display: none;">
                                <label class="proposal-modal-label">What type of app?</label>
                                <div class="tier-option" data-tier="tool" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">Tool</div>
                                        <div class="tier-option-desc">Quick utilities like calculators, timers, converters</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="tier-option" data-tier="app" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">App</div>
                                        <div class="tier-option-desc">Full-featured apps with state, history, accounts</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="tier-option" data-tier="solution" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">Solution</div>
                                        <div class="tier-option-desc">Business solutions, integrations, enterprise tools</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <label class="proposal-modal-label" id="proposalModalLabel">What would you like to improve?</label>
                            <textarea
                                class="proposal-modal-textarea"
                                id="proposalModalTextarea"
                                placeholder="Describe your idea..."
                                oninput="updateProposalSubmitState()"
                            ></textarea>
                        </div>
                        <div class="proposal-modal-footer">
                            <button class="proposal-modal-btn cancel" onclick="closeProposalModal()">Cancel</button>
                            <button class="proposal-modal-btn submit" id="proposalModalSubmit" onclick="submitProposal()" disabled>Submit Proposal</button>
                        </div>
                    </div>
                </div>

                <!-- Factory/Governance View -->
                <section class="factory-view" id="factoryView">
                    <div class="factory-view-header">
                        <div class="factory-view-title">
                            <h1>Factory</h1>
                        </div>
                        <div class="factory-main-tabs">
                            <button class="factory-main-tab active" data-view="governance" onclick="switchFactoryMainView('governance')">
                                Governance
                            </button>
                            <button class="factory-main-tab" data-view="agents" onclick="switchFactoryMainView('agents')">
                                Agents <span class="tab-count" id="factoryAgentsCount">0</span>
                            </button>
                            <button class="factory-main-tab" data-view="stream" onclick="switchFactoryMainView('stream')">
                                Stream
                            </button>
                            <button class="factory-main-tab" data-view="howitworks" onclick="switchFactoryMainView('howitworks')">
                                How it Works
                            </button>
                            <button class="factory-main-tab" data-view="leaderboard" onclick="switchFactoryMainView('leaderboard')">
                                Leaderboard
                            </button>
                        </div>
                    </div>

                    <div class="factory-view-content">
                        <!-- Proposals Area -->
                        <div class="factory-proposals-area">
                            <!-- Governance Main View -->
                            <div class="factory-main-view active" id="factoryGovernanceView">
                                <div class="factory-new-proposal-row">
                                    <button class="factory-submit-btn" onclick="showFactorySubmitModal()">
                                        + New Proposal
                                    </button>
                                </div>
                                <div class="factory-proposals-header">
                                    <div class="factory-section-tabs">
                                        <button class="factory-section-tab active" data-section="suite_apps" onclick="switchFactorySection('suite_apps')">
                                             Apps <span class="section-count" id="factoryAppsCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="business" onclick="switchFactorySection('business')">
                                             Business <span class="section-count" id="factoryBusinessCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="content" onclick="switchFactorySection('content')">
                                             Content <span class="section-count" id="factoryContentCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="social" onclick="switchFactorySection('social')">
                                             Social <span class="section-count" id="factorySocialCount">0</span>
                                        </button>
                                    </div>
                                </div>

                                <div class="factory-governance-layout">
                                    <!-- Sidebar Filter -->
                                    <aside class="factory-app-filter" id="factoryAppFilterSidebar">
                                        <div class="factory-filter-title">Filter by App</div>
                                        <div class="factory-filter-options" id="factoryAppFilterOptions">
                                            <div class="factory-filter-option active" data-filter="all" onclick="filterFactoryByApp('all')">
                                                <span>All</span>
                                                <span class="factory-filter-count" id="factoryFilterAllCount">0</span>
                                            </div>
                                            <!-- Additional filter options populated dynamically -->
                                        </div>
                                    </aside>

                                    <!-- Kanban Board -->
                                    <div class="factory-kanban" id="factoryKanban">
                                        <div class="factory-column">
                                            <div class="factory-column-header">Submitted <span class="factory-column-count" id="factorySubmittedCount">0</span></div>
                                            <div class="factory-submitted-tabs">
                                                <button class="factory-submitted-tab active" data-subtab="newapps" onclick="switchSubmittedTab('newapps')">
                                                    New App Ideas <span id="factoryNewAppsCount">0</span>
                                                </button>
                                                <button class="factory-submitted-tab" data-subtab="refinements" onclick="switchSubmittedTab('refinements')">
                                                    Refinements <span id="factoryRefinementsCount">0</span>
                                                </button>
                                            </div>
                                            <div id="factoryNewAppsCards" class="factory-subtab-content active">
                                                <div class="factory-empty-state">
                                                    <p>No new app ideas yet</p>
                                                </div>
                                            </div>
                                            <div id="factoryRefinementsCards" class="factory-subtab-content" style="display: none;">
                                                <div class="factory-empty-state">
                                                    <p>No refinements yet</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Voting <span class="factory-column-count" id="factoryVotingCount">0</span></div>
                                            <div id="factoryVotingCards">
                                                <div class="factory-empty-state">
                                                    <p>No proposals in voting</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Working On <span class="factory-column-count" id="factoryWorkingCount">0</span></div>
                                            <div id="factoryWorkingCards">
                                                <div class="factory-empty-state">
                                                    <p>No active work</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Implemented <span class="factory-column-count" id="factoryImplementedCount">0</span></div>
                                            <div id="factoryImplementedCards">
                                                <div class="factory-empty-state">
                                                    <p>No implemented proposals</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Agents View -->
                            <div class="factory-main-view" id="factoryAgentsView" style="display: none;">
                                <div class="factory-empty-state">
                                    <p>Agent proposals will appear here</p>
                                </div>
                            </div>

                            <!-- Stream View -->
                            <div class="factory-main-view" id="factoryStreamView" style="display: none;">
                                <div class="factory-empty-state">
                                    <p>Real-time updates will appear here</p>
                                </div>
                            </div>

                            <!-- How it Works View -->
                            <div class="factory-main-view" id="factoryHowItWorksView" style="display: none;">
                                <div class="factory-howitworks-content">
                                    <h2 style="text-align: center; margin-bottom: 32px;">How Governance Works</h2>
                                    <div class="factory-howitworks-cards">
                                        <div class="factory-howitworks-card">
                                            <h3>Get Credits</h3>
                                            <div class="factory-howitworks-detail">
                                                <span class="factory-howitworks-value">1,000</span>
                                                <span>credits per $1 USDC</span>
                                            </div>
                                            <button class="factory-howitworks-btn" onclick="openCreditsModal()">Buy Now</button>
                                        </div>
                                        <div class="factory-howitworks-card">
                                            <h3>Spend Credits</h3>
                                            <div class="factory-howitworks-detail">
                                                <span class="factory-howitworks-value highlight">FREE</span>
                                                <span>1st vote on any proposal</span>
                                            </div>
                                            <div class="factory-howitworks-detail">
                                                <span class="factory-howitworks-value">136</span>
                                                <span>quadratic cost for more votes</span>
                                            </div>
                                            <p class="factory-howitworks-note">Credits spent = removed from circulation</p>
                                        </div>
                                        <div class="factory-howitworks-card">
                                            <h3>Submit Proposals</h3>
                                            <div class="factory-howitworks-detail">
                                                <span class="factory-howitworks-value highlight">FREE</span>
                                                <span>to submit any proposal</span>
                                            </div>
                                            <p class="factory-howitworks-note">7 days to get moved to voting or removed</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Leaderboard View -->
                            <div class="factory-main-view" id="factoryLeaderboardView" style="display: none;">
                                <div class="factory-leaderboard-content">
                                    <h2 style="text-align: center; margin-bottom: 32px;">Leaderboard</h2>
                                    <div class="factory-leaderboard-list" id="factoryLeaderboardList">
                                        <p style="text-align: center; color: var(--text-tertiary);">Loading...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Factory Submit Modal -->
    <div class="factory-modal-overlay" id="factorySubmitModal">
        <div class="factory-modal-content">
            <div class="factory-modal-header">
                <h3 class="factory-modal-title">New Proposal</h3>
                <button class="factory-modal-close" onclick="hideFactorySubmitModal()">&times;</button>
            </div>
            <form id="factorySubmitForm" onsubmit="submitFactoryProposal(event)">
                <div class="factory-form-group">
                    <label class="factory-form-label">Section</label>
                    <select id="factoryProposalSection" class="factory-form-select" onchange="onFactorySectionChange()">
                        <option value="suite_apps"> SUITE Apps</option>
                        <option value="business"> Business</option>
                        <option value="content"> Content</option>
                        <option value="social"> Social</option>
                    </select>
                </div>

                <!-- App dropdown (only shown when section = suite_apps) -->
                <div class="factory-form-group" id="factoryAppGroup">
                    <label class="factory-form-label">Related App</label>
                    <select id="factoryProposalApp" class="factory-form-select">
                        <option value="">-- General (no specific app) --</option>
                        <!-- Populated dynamically from apps table -->
                    </select>
                </div>

                <!-- New App checkbox (only shown when section = suite_apps) -->
                <div class="factory-form-group" id="factoryNewAppGroup">
                    <label class="factory-checkbox-label">
                        <input type="checkbox" id="factoryIsNewApp" onchange="onFactoryNewAppToggle()">
                        <span> This is a NEW app idea</span>
                    </label>
                </div>

                <div class="factory-form-group">
                    <label class="factory-form-label">What's your idea?</label>
                    <textarea class="factory-form-textarea" id="factoryProposalContent"
                        placeholder="Describe your idea, feature request, bug, or suggestion..."
                        rows="6" required></textarea>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 16px;">
                    AI will auto-generate title and category from your description.
                </p>

                <div class="factory-modal-actions">
                    <button type="button" class="factory-modal-btn cancel" onclick="hideFactorySubmitModal()">Cancel</button>
                    <button type="submit" class="factory-modal-btn submit" id="factorySubmitBtn">Submit Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Factory Auth Modal -->
    <div class="factory-modal-overlay" id="factoryAuthModal">
        <div class="factory-modal-content" style="text-align: center;">
            <div class="factory-modal-header">
                <h3 class="factory-modal-title">Connect to Participate</h3>
                <button class="factory-modal-close" onclick="hideFactoryAuthModal()">&times;</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Connect an account to submit proposals and vote.
            </p>
            <button onclick="openConnectModal(); hideFactoryAuthModal();" class="factory-submit-btn" style="width: 100%; padding: 14px;">
                Connect Account
            </button>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="import-modal-overlay" id="importModal">
        <div class="import-modal">
            <div class="import-modal-header">
                <div>
                    <h2>Import Your AI History</h2>
                    <p>Your conversations reveal what you actually need. Let us analyze them and recommend the perfect tools for you.</p>
                </div>
                <button class="import-modal-close" id="importModalClose">&times;</button>
            </div>

            <div class="import-modal-body">
                <!-- Step 1: Source Selection & Upload -->
                <div class="import-step import-step-upload" id="importStepUpload">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 16px;">Select your source</h4>

                    <div class="import-sources">
                        <div class="import-source selected" data-source="chatgpt">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">ChatGPT</div>
                        </div>
                        <div class="import-source" data-source="claude">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Claude</div>
                        </div>
                        <div class="import-source" data-source="gemini">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Gemini</div>
                        </div>
                    </div>

                    <div class="import-instructions" id="importInstructions">
                        <h4>How to export from ChatGPT</h4>
                        <ol>
                            <li>Go to <code>chat.openai.com</code></li>
                            <li>Click your profile then <strong>Settings</strong></li>
                            <li>Go to <strong>Data controls</strong></li>
                            <li>Click <strong>Export data</strong></li>
                            <li>Check your email for the download link</li>
                            <li>Upload the <code>conversations.json</code> file below</li>
                        </ol>
                    </div>

                    <div class="import-dropzone" id="importDropzone">
                        <div class="import-dropzone-icon"></div>
                        <h3>Drop your export file here</h3>
                        <p>or click to browse</p>
                        <button class="import-dropzone-btn">Choose File</button>
                        <input type="file" class="import-file-input" id="importFileInput" accept=".json,.zip">
                    </div>

                    <!-- Test mode option -->
                    <div style="text-align: center; margin-bottom: 16px;">
                        <button id="loadTestData" style="background: none; border: 1px dashed var(--border-subtle); padding: 10px 20px; border-radius: 8px; color: var(--text-tertiary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease;">
                            Load sample data to test the flow
                        </button>
                    </div>

                    <div class="import-privacy">
                        <h4>Your data, your choice</h4>
                        <p>We analyze your conversations to understand your needs. We extract themes and topics, not personal details.</p>
                        <div class="import-consent">
                            <label>
                                <input type="checkbox" id="consentAnalyze" checked>
                                <span>Analyze my chats for personalized recommendations</span>
                            </label>
                            <label>
                                <input type="checkbox" id="consentImprove" checked>
                                <span>Help improve SUITE by sharing anonymized insights</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Processing -->
                <div class="import-progress" id="importProgress">
                    <div class="import-progress-spinner"></div>
                    <h3>Analyzing your conversations...</h3>
                    <p id="importProgressText">Reading your chat history</p>
                    <div class="import-progress-bar">
                        <div class="import-progress-fill" id="importProgressFill"></div>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div class="import-results" id="importResults">
                    <div class="import-results-header">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke-linecap="round"/>
                                <polyline points="22 4 12 14.01 9 11.01" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>Analysis Complete!</h3>
                        <p>Here's what we learned about you</p>
                    </div>

                    <div class="import-stats">
                        <div class="import-stat">
                            <div class="import-stat-value" id="statConversations">0</div>
                            <div class="import-stat-label">Conversations</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statMessages">0</div>
                            <div class="import-stat-label">Messages</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statTopics">0</div>
                            <div class="import-stat-label">Topics Found</div>
                        </div>
                    </div>

                    <div class="import-insights">
                        <h4>Key Insights</h4>
                        <div id="insightsList"></div>
                    </div>

                    <div class="import-recommendations">
                        <h4>Matched to Existing Apps</h4>
                        <div id="recommendationsList"></div>
                    </div>

                    <div class="import-unmatched" id="importUnmatched" style="display: none;">
                        <h4>App Ideas We Can Build For You</h4>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 16px;">
                            These ideas from your chats don't match existing apps. Click to request!
                        </p>
                        <div id="unmatchedList"></div>
                    </div>

                    <div class="import-cta">
                        <button class="import-cta-btn secondary" id="importDone">Done</button>
                        <button class="import-cta-btn primary" id="importRequestCustom">Request Custom App</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div class="connect-modal-overlay" id="connectModalOverlay" onclick="if(event.target === this) closeConnectModal()">
        <div class="connect-modal">
            <button class="connect-modal-close" onclick="closeConnectModal()">&times;</button>
            <h3>Log in or sign up</h3>
            <p class="connect-modal-subtitle">Get smarter responses and track your credits</p>

            <!-- Primary Options -->
            <div class="connect-options-primary" id="connectOptionsPrimary">
                <button class="connect-option-btn google" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                <button class="connect-option-btn email" onclick="showEmailForm()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M22 6l-10 7L2 6"/>
                    </svg>
                    Continue with Email
                </button>
            </div>

            <!-- Email Form (hidden by default) -->
            <div class="email-auth-form" id="emailAuthForm" style="display: none;">
                <input type="email" id="authEmail" placeholder="Email address" autocomplete="email">
                <input type="password" id="authPassword" placeholder="Password (min 6 characters)" autocomplete="current-password" style="display: none;">
                <button class="connect-option-btn email" id="emailAuthBtn" onclick="handleEmailAuth()">Continue</button>
                <button class="email-back-btn" onclick="hideEmailForm()"> Back to login options</button>
            </div>

            <!-- Divider -->
            <div class="connect-divider"><span>or continue with</span></div>

            <!-- Secondary Options -->
            <div class="connect-options-secondary">
                <button class="connect-option-small telegram" onclick="loginWithTelegram()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                    </svg>
                    Telegram
                </button>
                <button class="connect-option-small wallet" onclick="connectWallet()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <path d="M1 10h22"/>
                    </svg>
                    Wallet
                </button>
            </div>
        </div>
    </div>

    <!-- App Preview Container (Full Screen Inline) -->
    <div class="app-preview-overlay" id="appPreviewOverlay">
        <div class="app-preview-header">
            <button class="app-preview-back" onclick="closeAppPreview()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back to Chat
            </button>
            <div class="app-preview-title">
                <div class="app-preview-icon" id="appPreviewIcon"></div>
                <span id="appPreviewName">App Name</span>
            </div>
            <button class="app-preview-add" id="appPreviewAddBtn" onclick="addAppToProfile()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Add to Profile
            </button>
        </div>
        <div class="app-preview-content">
            <iframe id="appPreviewFrame" src="" frameborder="0" allow="camera; microphone; geolocation"></iframe>
        </div>
    </div>

    <!-- App Launch Modal (Desktop only) -->
    <div class="app-launch-modal-overlay" id="appLaunchModalOverlay" onclick="if(event.target === this) closeAppLaunchModal()">
        <div class="app-launch-modal">
            <div class="app-launch-modal-icon" id="appLaunchModalIcon"></div>
            <h3 id="appLaunchModalName">App Name</h3>
            <p>How would you like to view this app?</p>
            <div class="app-launch-options">
                <div class="app-launch-option" onclick="launchAppFullscreen()">
                    <div class="app-launch-option-icon"></div>
                    <div class="app-launch-option-title">Fullscreen</div>
                    <div class="app-launch-option-desc">Full browser view</div>
                </div>
                <div class="app-launch-option" onclick="launchAppMobile()">
                    <div class="app-launch-option-icon"></div>
                    <div class="app-launch-option-title">Mobile View</div>
                    <div class="app-launch-option-desc">Draggable phone window</div>
                </div>
            </div>
            <button class="app-launch-modal-close" onclick="closeAppLaunchModal()">Cancel</button>
        </div>
    </div>

    <!-- Mobile App Container (Draggable Phone View) -->
    <div class="mobile-app-container" id="mobileAppContainer">
        <div class="mobile-app-notch"></div>
        <div class="mobile-app-header" id="mobileAppHeader">
            <div class="mobile-app-header-left">
                <div class="mobile-app-header-icon" id="mobileAppIcon"></div>
                <span class="mobile-app-header-title" id="mobileAppTitle">App Name</span>
            </div>
            <div class="mobile-app-header-actions">
                <button class="mobile-app-btn mobile-app-btn-fullscreen" onclick="switchToFullscreen()" title="Switch to Fullscreen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                    </svg>
                </button>
                <button class="mobile-app-btn mobile-app-btn-minimize" onclick="minimizeToSidebar()" title="Save & Minimize">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="mobile-app-content">
            <iframe id="mobileAppFrame" src="" frameborder="0" allow="camera; microphone; geolocation"></iframe>
        </div>
    </div>

    <!-- Apps Panel -->
    <div class="apps-panel-overlay" id="appsPanelOverlay" onclick="if(event.target === this) closeAppsPanel()">
        <div class="apps-panel">
            <div class="apps-panel-header">
                <h2>All Apps</h2>
                <button class="apps-panel-close" onclick="closeAppsPanel()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="apps-panel-search">
                <input type="text" id="appsPanelSearch" placeholder="Search apps..." oninput="filterApps(this.value)">
            </div>
            <div class="apps-panel-grid" id="appsPanelGrid">
                <!-- Apps will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="upgrade-modal-overlay" id="upgradeModalOverlay" onclick="if(event.target === this) closeUpgradeModal()">
        <div class="upgrade-modal">
            <button class="upgrade-modal-close" onclick="closeUpgradeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="upgrade-modal-header">
                <h2>Upgrade Your Plan</h2>
                <p>Get more out of SuiteGPT with premium features</p>
            </div>

            <div class="upgrade-tabs">
                <button class="upgrade-tab active" onclick="switchUpgradeTab('subscription')">Subscription</button>
                <button class="upgrade-tab" onclick="switchUpgradeTab('credits')">Buy Credits</button>
            </div>

            <!-- Subscription Plans -->
            <div class="subscription-section active" id="subscriptionSection">
                <div class="upgrade-plans">
                    <div class="upgrade-plan">
                        <div class="upgrade-plan-name">Free</div>
                        <div class="upgrade-plan-price">$0 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For casual users</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                50 messages/day
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Access to all apps
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Basic support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn secondary" disabled>Current Plan</button>
                    </div>

                    <div class="upgrade-plan popular">
                        <div class="upgrade-plan-badge">Most Popular</div>
                        <div class="upgrade-plan-name">Pro</div>
                        <div class="upgrade-plan-price">$9.99 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For power users</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Unlimited messages
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Priority AI responses
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Advanced app features
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Priority support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn primary" onclick="selectPlan('pro')">Upgrade to Pro</button>
                    </div>

                    <div class="upgrade-plan">
                        <div class="upgrade-plan-name">Business</div>
                        <div class="upgrade-plan-price">$29.99 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For teams & professionals</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Everything in Pro
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Team collaboration
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                API access
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Custom integrations
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Dedicated support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn primary" onclick="selectPlan('business')">Upgrade to Business</button>
                    </div>
                </div>
            </div>

            <!-- Credit Packs -->
            <div class="credits-section" id="creditsSection">
                <div class="credit-packs">
                    <div class="credit-pack" onclick="selectCreditPack(100)">
                        <div class="credit-pack-amount">100 Credits</div>
                        <div class="credit-pack-price">$4.99</div>
                        <div class="credit-pack-per">$0.05 per credit</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(500)">
                        <div class="credit-pack-amount">500 Credits</div>
                        <div class="credit-pack-price">$19.99</div>
                        <div class="credit-pack-per">$0.04 per credit</div>
                    </div>
                    <div class="credit-pack best-value" onclick="selectCreditPack(1000)">
                        <div class="credit-pack-badge">Best Value</div>
                        <div class="credit-pack-amount">1,000 Credits</div>
                        <div class="credit-pack-price">$34.99</div>
                        <div class="credit-pack-per">$0.035 per credit</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(5000)">
                        <div class="credit-pack-amount">5,000 Credits</div>
                        <div class="credit-pack-price">$149.99</div>
                        <div class="credit-pack-per">$0.03 per credit</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credits Modal -->
    <div class="credits-modal-overlay" id="creditsModalOverlay" onclick="if(event.target === this) closeCreditsModal()">
        <div class="credits-modal">
            <button class="credits-modal-close" onclick="closeCreditsModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2>Your Credits</h2>

            <div class="credits-modal-balance">
                <span class="credits-modal-amount" id="creditsModalAmount">0</span>
                <span class="credits-modal-label">credits available</span>
            </div>

            <div class="credits-modal-options">
                <button class="credits-modal-option" onclick="closeCreditsModal(); openUpgradeModal();">
                    <div class="credits-modal-option-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v12M6 12h12"/>
                        </svg>
                    </div>
                    <div class="credits-modal-option-text">
                        <div class="credits-modal-option-title">Buy Credits</div>
                        <div class="credits-modal-option-desc">Purchase more credits to use</div>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>

                <button class="credits-modal-option" onclick="closeCreditsModal(); openWithdrawalModal();">
                    <div class="credits-modal-option-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 5v14M5 12l7 7 7-7"/>
                        </svg>
                    </div>
                    <div class="credits-modal-option-text">
                        <div class="credits-modal-option-title">Request Withdrawal</div>
                        <div class="credits-modal-option-desc">Cash out your available credits</div>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>
            </div>

            <div class="credits-modal-bonus" id="bonusCreditsSection">
                <div class="credits-modal-bonus-header">
                    <span>Bonus Credits</span>
                    <span class="credits-modal-bonus-amount">0</span>
                </div>
                <button class="credits-modal-bonus-toggle" onclick="toggleBonusExplanation()">
                    Learn more <span class="toggle-arrow"></span>
                </button>
                <div class="credits-modal-bonus-content" id="bonusExplanation">
                    <p>Bonus Credits are community rewards. Use them for AI interactions or withdraw when available.</p>
                    <a href="/learn/bonus-credits.html" class="credits-modal-docs-link" onclick="closeCreditsModal()">
                        Read full documentation 
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal-overlay" id="settingsModalOverlay" onclick="if(event.target === this) closeSettingsModal()">
        <div class="settings-modal">
            <nav class="settings-nav">
                <button class="settings-nav-item active" data-panel="docs" onclick="switchSettingsPanel('docs')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    Documentation
                </button>
                <button class="settings-nav-item" data-panel="learn" onclick="switchSettingsPanel('learn')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    Learn
                </button>
                <button class="settings-nav-item" data-panel="community" onclick="switchSettingsPanel('community')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    </svg>
                    Community Chat
                </button>
                <button class="settings-nav-item" data-panel="factory" onclick="switchSettingsPanel('factory')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 20h20M5 20V8l7-5 7 5v12M9 20v-6h6v6"/>
                        <path d="M9 12h.01M15 12h.01"/>
                    </svg>
                    Factory (Governance)
                </button>
                <button class="settings-nav-item" data-panel="import" onclick="switchSettingsPanel('import')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Import History
                </button>
            </nav>
            <div class="settings-content">
                <div class="settings-content-header">
                    <h2 id="settingsPanelTitle">Documentation</h2>
                    <button class="settings-close-btn" onclick="closeSettingsModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>

                <!-- Documentation Panel -->
                <div class="settings-panel active" id="settingsPanelDocs">
                    <p class="settings-panel-description">
                        Access the SUITE documentation to learn about features, APIs, and how to get the most out of the platform.
                    </p>
                    <a href="https://www.getsuite.app/docs/" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <path d="M15 3h6v6M10 14L21 3"/>
                        </svg>
                        Open Documentation
                    </a>
                </div>

                <!-- Learn Panel -->
                <div class="settings-panel" id="settingsPanelLearn">
                    <p class="settings-panel-description">
                        Explore articles about AI fitness apps, productivity tools, and how SUITE works. Guides, tips, and deep dives.
                    </p>
                    <a href="https://getsuite.app/learn/articles.html" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <path d="M15 3h6v6M10 14L21 3"/>
                        </svg>
                        Browse Articles
                    </a>
                </div>

                <!-- Community Chat Panel -->
                <div class="settings-panel" id="settingsPanelCommunity">
                    <p class="settings-panel-description">
                        Join the SUITE community on Telegram to chat with other users, share ideas, get help, and stay updated on the latest features.
                    </p>
                    <a href="https://t.me/getsuiteapp" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                        </svg>
                        Join Telegram Community
                    </a>
                </div>

                <!-- Factory (Governance) Panel -->
                <div class="settings-panel" id="settingsPanelFactory">
                    <p class="settings-panel-description">
                        The Factory is where SUITE's governance happens. Submit proposals, vote on features, and help shape the future of the platform.
                    </p>
                    <button class="settings-action-btn" onclick="closeSettingsModal(); openFactory();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M2 20h20M5 20V8l7-5 7 5v12M9 20v-6h6v6"/>
                        </svg>
                        Open Factory
                    </button>
                </div>

                <!-- Import History Panel -->
                <div class="settings-panel" id="settingsPanelImport">
                    <p class="settings-panel-description">
                        Import your chat history from other AI assistants like ChatGPT. Your conversations will be securely stored and available across devices.
                    </p>
                    <button class="settings-action-btn" onclick="closeSettingsModal(); triggerHistoryImport();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Import Chat History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="withdrawal-modal-overlay" id="withdrawalModalOverlay" onclick="if(event.target === this) closeWithdrawalModal()">
        <div class="withdrawal-modal">
            <button class="withdrawal-modal-close" onclick="closeWithdrawalModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2>Request Withdrawal</h2>

            <div class="withdrawal-balance">
                <div class="withdrawal-balance-credits" id="withdrawalCredits">0</div>
                <div class="withdrawal-balance-value">credits available</div>
                <div class="withdrawal-balance-value" id="withdrawalValue">~$0.00 USD value</div>
            </div>

            <div class="withdrawal-input-group">
                <label>Amount to withdraw (credits)</label>
                <div class="withdrawal-input-wrapper">
                    <input type="number" class="withdrawal-input" id="withdrawalAmount" placeholder="Enter amount" min="0">
                    <button class="withdrawal-max-btn" onclick="setMaxWithdrawal()">Max</button>
                </div>
            </div>

            <div class="withdrawal-note">
                Withdrawals are processed when the pool has sufficient funds. You'll receive a notification when your withdrawal is ready.
            </div>

            <button class="withdrawal-confirm-btn" id="withdrawalConfirmBtn" onclick="submitWithdrawal()">
                Confirm Withdrawal Request
            </button>
        </div>
    </div>

    <script>
        // ========================
        // SUPABASE CONFIG (declare early to avoid TDZ errors)
        // ========================
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';
        const ADMIN_WALLETS = ['0x92d67d8ad8b986e78b369be0272e121ae5acad59'];
        let supabaseClient = null;

        // Debug: Check localStorage for Supabase session
        console.log('[Auth Debug] URL:', window.location.href);
        console.log('[Auth Debug] URL hash:', window.location.hash);
        console.log('[Auth Debug] URL search:', window.location.search);

        // Check for OAuth error in URL
        const debugParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        if (debugParams.get('error') || hashParams.get('error')) {
            console.error('[Auth Debug] OAuth ERROR:', debugParams.get('error') || hashParams.get('error'));
            console.error('[Auth Debug] Error description:', debugParams.get('error_description') || hashParams.get('error_description'));
        }
        if (debugParams.get('code')) {
            console.log('[Auth Debug] OAuth code found in URL - exchange should happen');
        }
        if (hashParams.get('access_token')) {
            console.log('[Auth Debug] Access token found in hash');
        }

        // Test if localStorage works
        try {
            localStorage.setItem('_test', '1');
            localStorage.removeItem('_test');
            console.log('[Auth Debug] localStorage is working');
        } catch (e) {
            console.error('[Auth Debug] localStorage is BLOCKED:', e);
        }

        const sbKey = 'sb-rdsmdywbdiskxknluiym-auth-token';
        console.log('[Auth Debug] Supabase localStorage key exists:', !!localStorage.getItem(sbKey));
        console.log('[Auth Debug] All localStorage keys:', Object.keys(localStorage));
        console.log('[Auth Debug] Supabase-related keys:', Object.keys(localStorage).filter(k => k.includes('supabase') || k.includes('sb-')));

        // ========================
        // GLOBAL VIEW FUNCTIONS (must be at top for onclick handlers)
        // ========================

        // Helper to close mobile sidebar
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebar) {
                sidebar.classList.remove('open');
                sidebar.classList.remove('mobile-open');
            }
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
        }

        // ========================
        // CREATOR DASHBOARD
        // ========================

        // App tier definitions
        const APP_TIER_MAP = {
            // Tools (quick utilities)
            'hydrotrack': 'tool',
            'focusflow': 'tool',
            'quickbudget': 'tool',
            'breatheasy': 'tool',
            'stretchtimer': 'tool',
            'quickdecide': 'tool',
            'stepgoal': 'tool',
            // Extensions (add-ons & integrations)
            'defi-knowledge': 'extension',
            'cadence-ai': 'extension',
            'visual-feedback': 'extension',
            // Apps (full-featured)
            'foodvitals': 'app',
            'trueform': 'app',
            'opticrep': 'app',
            'sleepwell': 'app',
            'moodlog': 'app',
            'pillpal': 'app',
            'flashmind': 'app',
            'bookshelf': 'app',
            'skilltree': 'app',
            'mealprep': 'app',
            'cleanhome': 'app',
            'datenight': 'app',
            'petcare': 'app',
            'packlight': 'app',
            'giftguru': 'app',
            'habitstack': 'app',
            'remcast': 'app',
            'cheshbon': 'app',
            'jesus-is-god': 'app',
            // Platforms (business/enterprise)
            'proto-golf': 'platform'
        };

        // Current proposal state
        let currentProposalApp = null;
        let currentProposalIsNew = false;
        let selectedTier = null;
        let currentDashboardTab = 'your-apps';

        function openCreatorDashboard(tab = 'your-apps', skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const factoryView = document.getElementById('factoryView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            hideArticle();

            // Show Creator Dashboard
            if (creatorDashboard) creatorDashboard.classList.add('active');
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Update URL to /creator-dashboard
            if (!skipPushState) {
                history.pushState({ view: 'creator-dashboard', tab: tab }, '', '/creator-dashboard');
            }

            // Switch to specified tab
            switchDashboardTab(tab);

            // Render apps if on your-apps tab
            if (tab === 'your-apps') {
                renderDashboardApps();
            }
        }

        function switchDashboardTab(tabId) {
            currentDashboardTab = tabId;

            // Update tab buttons
            document.querySelectorAll('.creator-dashboard-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });

            // Update panels
            const panelMap = {
                'your-apps': 'dashboardPanelYourApps',
                'create': 'dashboardPanelCreate',
                'earnings': 'dashboardPanelEarnings',
                'my-requests': 'dashboardPanelMyRequests'
            };

            Object.entries(panelMap).forEach(([key, panelId]) => {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.toggle('active', key === tabId);
                }
            });

            // Render apps when switching to your-apps tab
            if (tabId === 'your-apps') {
                renderDashboardApps();
            }
        }

        function closeCreatorDashboard(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const useCasesSection = document.getElementById('useCasesSection');

            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (creatorDashboard) creatorDashboard.classList.remove('active');

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        // Legacy function for backwards compatibility
        function openYourApps() {
            openCreatorDashboard('your-apps');
        }

        function openCreate() {
            openCreatorDashboard('create');
        }

        function openEarnings() {
            openCreatorDashboard('earnings');
        }

        function closeYourAppsView() {
            closeCreatorDashboard();
        }

        function closeCreateView() {
            closeCreatorDashboard();
        }

        function closeEarningsView() {
            closeCreatorDashboard();
        }

        function getAppTier(appKey) {
            // Check if app has explicit tier in SUITE_APPS
            if (SUITE_APPS[appKey]?.tier) {
                return SUITE_APPS[appKey].tier;
            }
            // Use default tier map
            return APP_TIER_MAP[appKey] || 'app';
        }

        function renderDashboardApps() {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const emptyState = document.getElementById('dashboardAppsEmpty');
            const content = document.getElementById('dashboardAppsContent');

            // Show empty state if no apps
            if (savedApps.length === 0) {
                if (emptyState) emptyState.style.display = 'flex';
                if (content) content.style.display = 'none';
                return;
            }

            // Hide empty state, show content
            if (emptyState) emptyState.style.display = 'none';
            if (content) content.style.display = 'block';

            // Categorize apps by tier
            const tools = [];
            const apps = [];
            const solutions = [];

            savedApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const tier = getAppTier(appKey);
                const appData = { key: appKey, ...app };

                if (tier === 'tool') tools.push(appData);
                else if (tier === 'solution') solutions.push(appData);
                else apps.push(appData);
            });

            // Render each tier
            renderTierGrid('Tools', tools, 'dashboardTierTools', 'dashboardToolsGrid', 'dashboardToolsCount');
            renderTierGrid('Apps', apps, 'dashboardTierApps', 'dashboardAppsGrid', 'dashboardAppsCount');
            renderTierGrid('Solutions', solutions, 'dashboardTierSolutions', 'dashboardSolutionsGrid', 'dashboardSolutionsCount');
        }

        // Legacy function for backwards compatibility
        function renderYourApps() {
            renderDashboardApps();
        }

        function renderTierGrid(tierName, appsList, tierId, gridId, countId) {
            const tierEl = document.getElementById(tierId);
            const gridEl = document.getElementById(gridId);
            const countEl = document.getElementById(countId);

            if (!tierEl || !gridEl) return;

            // Hide tier if no apps
            if (appsList.length === 0) {
                tierEl.style.display = 'none';
                return;
            }

            // Show tier
            tierEl.style.display = 'block';
            if (countEl) countEl.textContent = appsList.length;

            // Clear and render grid
            gridEl.innerHTML = '';

            appsList.forEach(app => {
                const card = document.createElement('div');
                card.className = 'your-apps-card';

                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';

                card.innerHTML = `
                    <div class="your-apps-card-header" onclick="launchApp('${app.key}', '${app.url}', '${app.name}')">
                        <div class="your-apps-card-icon" style="background: ${app.iconBg}">
                            ${iconHtml}
                        </div>
                        <div class="your-apps-card-info">
                            <div class="your-apps-card-name">${app.name}</div>
                            <div class="your-apps-card-desc">${app.description}</div>
                        </div>
                    </div>
                    <div class="your-apps-card-actions">
                        <button class="your-apps-card-btn propose" onclick="openProposeModal('${app.key}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                            Propose
                        </button>
                        <button class="your-apps-card-btn remove" onclick="removeFromYourApps('${app.key}')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                `;

                gridEl.appendChild(card);
            });
        }

        function removeFromYourApps(appKey) {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const index = savedApps.indexOf(appKey);
            if (index > -1) {
                savedApps.splice(index, 1);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                renderYourApps();
                showToast(`${SUITE_APPS[appKey]?.name || 'App'} removed from your apps`);
            }
        }

        // Proposal Modal Functions
        function openProposeModal(appKey) {
            currentProposalApp = appKey;
            currentProposalIsNew = false;
            selectedTier = null;

            const overlay = document.getElementById('proposalModalOverlay');
            const title = document.getElementById('proposalModalTitle');
            const appSection = document.getElementById('proposalModalApp');
            const tierOptions = document.getElementById('proposalTierOptions');
            const label = document.getElementById('proposalModalLabel');
            const textarea = document.getElementById('proposalModalTextarea');
            const appIcon = document.getElementById('proposalModalAppIcon');
            const appName = document.getElementById('proposalModalAppName');

            // Configure for refinement mode
            title.textContent = 'Propose Refinement';
            label.textContent = 'What would you like to improve?';
            textarea.placeholder = 'Describe your improvement idea for this app...';
            textarea.value = '';

            // Show app info, hide tier options
            if (appSection) appSection.style.display = 'flex';
            if (tierOptions) tierOptions.style.display = 'none';

            // Set app info
            const app = SUITE_APPS[appKey];
            if (app) {
                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';
                appIcon.innerHTML = iconHtml;
                appIcon.style.background = app.iconBg;
                appName.textContent = app.name;
            }

            // Show modal
            if (overlay) overlay.classList.add('active');
            updateProposalSubmitState();
        }

        function openCreateAppModal() {
            currentProposalApp = null;
            currentProposalIsNew = true;
            selectedTier = null;

            const overlay = document.getElementById('proposalModalOverlay');
            const title = document.getElementById('proposalModalTitle');
            const appSection = document.getElementById('proposalModalApp');
            const tierOptions = document.getElementById('proposalTierOptions');
            const label = document.getElementById('proposalModalLabel');
            const textarea = document.getElementById('proposalModalTextarea');

            // Configure for new app mode
            title.textContent = 'Create New App';
            label.textContent = 'Describe your app idea';
            textarea.placeholder = 'What should this app do? Who is it for? What problem does it solve?';
            textarea.value = '';

            // Hide app info, show tier options
            if (appSection) appSection.style.display = 'none';
            if (tierOptions) tierOptions.style.display = 'block';

            // Reset tier selection
            document.querySelectorAll('.tier-option').forEach(opt => opt.classList.remove('selected'));

            // Show modal
            if (overlay) overlay.classList.add('active');
            updateProposalSubmitState();
        }

        function closeProposalModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const overlay = document.getElementById('proposalModalOverlay');
            if (overlay) overlay.classList.remove('active');

            currentProposalApp = null;
            currentProposalIsNew = false;
            selectedTier = null;
        }

        function selectTierOption(element) {
            // Remove selection from all options
            document.querySelectorAll('.tier-option').forEach(opt => opt.classList.remove('selected'));

            // Select this option
            element.classList.add('selected');
            selectedTier = element.dataset.tier;

            updateProposalSubmitState();
        }

        function updateProposalSubmitState() {
            const textarea = document.getElementById('proposalModalTextarea');
            const submitBtn = document.getElementById('proposalModalSubmit');

            if (!textarea || !submitBtn) return;

            const hasText = textarea.value.trim().length > 10;
            const hasTier = !currentProposalIsNew || selectedTier !== null;

            submitBtn.disabled = !hasText || !hasTier;
        }

        async function submitProposal() {
            const textarea = document.getElementById('proposalModalTextarea');
            const submitBtn = document.getElementById('proposalModalSubmit');

            if (!textarea || submitBtn.disabled) return;

            const content = textarea.value.trim();
            if (!content) return;

            // Disable button while submitting
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Get current user info
                let username = 'Anonymous';
                let userEmail = null;

                if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) {
                        username = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'Anonymous';
                        userEmail = user.email;
                    }
                }

                // Build proposal data
                const proposalData = {
                    content: content,
                    section: 'suite_apps',
                    category: currentProposalIsNew ? 'feature' : 'enhancement',
                    is_new_app: currentProposalIsNew,
                    username: username
                };

                // Add app target for refinements
                if (!currentProposalIsNew && currentProposalApp) {
                    proposalData.app_target = currentProposalApp;
                    const app = SUITE_APPS[currentProposalApp];
                    if (app) {
                        proposalData.content = `[${app.name}] ${content}`;
                    }
                }

                // Add tier for new apps
                if (currentProposalIsNew && selectedTier) {
                    proposalData.tier = selectedTier;
                    const tierNames = { tool: 'Tool', app: 'App', solution: 'Solution' };
                    proposalData.content = `[New ${tierNames[selectedTier]}] ${content}`;
                }

                // Submit to factory endpoint
                const response = await fetch('https://hpogoxpyzwlcmiynpvkg.supabase.co/functions/v1/factory-submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(proposalData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit proposal');
                }

                // Success
                closeProposalModal();
                showToast(currentProposalIsNew
                    ? 'New app proposal submitted! Track it in Governance.'
                    : 'Refinement proposal submitted! Track it in Governance.'
                );

            } catch (error) {
                console.error('Error submitting proposal:', error);
                showToast('Failed to submit proposal. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // ========================
        // FACTORY/GOVERNANCE VIEW
        // ========================

        // Factory state
        let factoryProposals = [];
        let factoryUserVotes = {};
        let factoryCurrentSection = 'suite_apps';
        let factoryCurrentView = 'governance';
        let factoryApps = [];
        let factoryAppFilter = 'all';

        // Factory categories
        const FACTORY_CATEGORIES = {
            feature: { emoji: '', label: 'Feature' },
            enhancement: { emoji: '', label: 'Enhancement' },
            bug: { emoji: '', label: 'Bug' },
            marketing: { emoji: '', label: 'Marketing' },
            partnership: { emoji: '', label: 'Partnership' },
            infrastructure: { emoji: '', label: 'Infrastructure' },
            general: { emoji: '', label: 'General' }
        };

        function openFactory(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');

            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            hideArticle();
            if (factoryView) factoryView.classList.add('active');
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Update URL to /governance
            if (!skipPushState) {
                history.pushState({ view: 'governance' }, '', '/governance');
            }

            // Load data
            loadFactoryApps();
            loadFactoryProposals();
            loadFactoryLeaderboard();
            updateFactoryUserCredits();
        }

        function closeFactoryView(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');

            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (factoryView) factoryView.classList.remove('active');

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const path = window.location.pathname;
            if (path === '/governance') {
                openFactory(true);
            } else if (path === '/creator-dashboard') {
                openCreatorDashboard('your-apps', true);
            } else if (path === '/apps') {
                openAppsPanel(true);
            } else {
                closeFactoryView(true);
                closeCreatorDashboard(true);
                closeAppsView(true);
            }
        });

        // Check URL on page load to open the appropriate view based on path
        function checkInitialRoute() {
            const path = window.location.pathname;
            if (path === '/governance') {
                openFactory(true);
            } else if (path === '/creator-dashboard') {
                openCreatorDashboard('your-apps', true);
            } else if (path === '/apps') {
                openAppsPanel(true);
            }
        }

        // Load apps from Supabase for dropdown and filtering
        async function loadFactoryApps() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/apps?select=slug,name&order=name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    factoryApps = await response.json();
                    populateFactoryAppDropdown();
                    renderFactoryAppFilter();
                }
            } catch (error) {
                console.error('Failed to load apps:', error);
            }
        }

        // Populate app dropdown in submit modal
        function populateFactoryAppDropdown() {
            const dropdown = document.getElementById('factoryProposalApp');
            if (!dropdown) return;

            dropdown.innerHTML = '<option value="">-- General (no specific app) --</option>';
            factoryApps.forEach(app => {
                dropdown.innerHTML += `<option value="${escapeFactoryHtml(app.slug)}">${escapeFactoryHtml(app.name)}</option>`;
            });
        }

        // Handle section change in submit modal
        function onFactorySectionChange() {
            const section = document.getElementById('factoryProposalSection').value;
            const appGroup = document.getElementById('factoryAppGroup');
            const newAppGroup = document.getElementById('factoryNewAppGroup');

            if (section === 'suite_apps') {
                appGroup.style.display = 'block';
                newAppGroup.style.display = 'block';
            } else {
                appGroup.style.display = 'none';
                newAppGroup.style.display = 'none';
                document.getElementById('factoryIsNewApp').checked = false;
            }
        }

        // Handle new app checkbox toggle
        function onFactoryNewAppToggle() {
            const isNewApp = document.getElementById('factoryIsNewApp').checked;
            const appGroup = document.getElementById('factoryAppGroup');

            if (isNewApp) {
                appGroup.style.display = 'none';
                document.getElementById('factoryProposalApp').value = '';
            } else {
                appGroup.style.display = 'block';
            }
        }

        // Render sidebar filter options based on proposals
        function renderFactoryAppFilter() {
            const container = document.getElementById('factoryAppFilterOptions');
            if (!container) return;

            // Get unique app_slugs from current section's proposals
            const sectionProposals = factoryProposals.filter(p => p.section === factoryCurrentSection);
            const appSlugs = new Set();
            let newAppCount = 0;
            let generalCount = 0;

            sectionProposals.forEach(p => {
                if (p.is_new_app || p.app_slug === 'new_app') {
                    newAppCount++;
                } else if (p.app_slug && p.app_slug !== '') {
                    appSlugs.add(p.app_slug);
                } else {
                    generalCount++;
                }
            });

            let html = `
                <div class="factory-filter-option ${factoryAppFilter === 'all' ? 'active' : ''}" data-filter="all" onclick="filterFactoryByApp('all')">
                    <span>All</span>
                    <span class="factory-filter-count">${sectionProposals.length}</span>
                </div>
                <div class="factory-filter-option ${factoryAppFilter === 'new_app' ? 'active' : ''}" data-filter="new_app" onclick="filterFactoryByApp('new_app')">
                    <span> New Apps</span>
                    <span class="factory-filter-count">${newAppCount}</span>
                </div>
                <div class="factory-filter-option ${factoryAppFilter === 'general' ? 'active' : ''}" data-filter="general" onclick="filterFactoryByApp('general')">
                    <span> General</span>
                    <span class="factory-filter-count">${generalCount}</span>
                </div>
            `;

            // Add filter options for each app that has proposals
            appSlugs.forEach(slug => {
                const app = factoryApps.find(a => a.slug === slug);
                const appName = app ? app.name : slug;
                const count = sectionProposals.filter(p => p.app_slug === slug && !p.is_new_app).length;
                html += `
                    <div class="factory-filter-option ${factoryAppFilter === slug ? 'active' : ''}" data-filter="${escapeFactoryHtml(slug)}" onclick="filterFactoryByApp('${escapeFactoryHtml(slug)}')">
                        <span> ${escapeFactoryHtml(appName)}</span>
                        <span class="factory-filter-count">${count}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Filter proposals by app
        function filterFactoryByApp(appSlug) {
            factoryAppFilter = appSlug;

            // Update active state on filter options
            document.querySelectorAll('.factory-filter-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.filter === appSlug);
            });

            renderFactoryProposals();
        }

        function switchFactoryMainView(view) {
            factoryCurrentView = view;

            // Update tabs
            document.querySelectorAll('.factory-main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            // Update views
            document.getElementById('factoryGovernanceView').style.display = view === 'governance' ? 'block' : 'none';
            document.getElementById('factoryAgentsView').style.display = view === 'agents' ? 'block' : 'none';
            document.getElementById('factoryStreamView').style.display = view === 'stream' ? 'block' : 'none';
            document.getElementById('factoryHowItWorksView').style.display = view === 'howitworks' ? 'block' : 'none';
            document.getElementById('factoryLeaderboardView').style.display = view === 'leaderboard' ? 'block' : 'none';

            // Load leaderboard data when switching to that view
            if (view === 'leaderboard') {
                loadFactoryLeaderboard();
            }
        }

        function switchFactorySection(section) {
            factoryCurrentSection = section;
            factoryAppFilter = 'all'; // Reset app filter when switching sections

            // Update tabs
            document.querySelectorAll('.factory-section-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.section === section);
            });

            // Re-render proposals
            renderFactoryProposals();
        }

        async function loadFactoryProposals() {
            try {
                console.log('[Factory] Loading proposals from Supabase...');
                console.log('[Factory] SUPABASE_URL:', SUPABASE_URL);

                // Get all proposals
                const url = `${SUPABASE_URL}/rest/v1/factory_proposals?select=*&order=created_at.desc`;
                console.log('[Factory] Fetching:', url);

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                console.log('[Factory] Response status:', response.status);
                console.log('[Factory] Response ok:', response.ok);

                if (response.ok) {
                    factoryProposals = await response.json();
                    console.log('[Factory] Loaded proposals:', factoryProposals);
                    console.log('[Factory] Proposals count:', factoryProposals.length);

                    // Filter to governance sections client-side
                    factoryProposals = factoryProposals.filter(p =>
                        ['suite_apps', 'business', 'content', 'social'].includes(p.section)
                    );
                    console.log('[Factory] After filtering:', factoryProposals.length);

                    renderFactoryProposals();
                    updateFactoryCounts();

                    // Load user votes if logged in
                    if (getFactoryCurrentUser()) {
                        await loadFactoryUserVotes();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('[Factory] Failed to load:', response.status, errorText);
                }
            } catch (error) {
                console.error('[Factory] Error loading proposals:', error);
            }
        }

        async function loadFactoryUserVotes() {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${currentUser.id}&select=proposal_id,vote_power`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const votes = await response.json();
                    factoryUserVotes = {};
                    votes.forEach(v => {
                        factoryUserVotes[v.proposal_id] = (factoryUserVotes[v.proposal_id] || 0) + v.vote_power;
                    });
                    renderFactoryProposals();
                }
            } catch (error) {
                console.error('Failed to load user votes:', error);
            }
        }

        function getFactoryCurrentUser() {
            // Check for Supabase auth via localStorage token
            const sbKey = 'sb-rdsmdywbdiskxknluiym-auth-token';
            const sbToken = localStorage.getItem(sbKey);
            if (sbToken) {
                try {
                    const session = JSON.parse(sbToken);
                    const user = session?.user;
                    if (user) {
                        return {
                            id: user.id,
                            supabase_id: user.id,
                            email: user.email,
                            display_name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'User',
                            reputation: 0
                        };
                    }
                } catch (e) {
                    console.error('[Factory] Error parsing Supabase token:', e);
                }
            }
            // Check for telegram
            const tgUser = localStorage.getItem('telegram_user');
            if (tgUser) {
                try {
                    const user = JSON.parse(tgUser);
                    return {
                        id: user.id?.toString(),
                        telegram_id: user.id?.toString(),
                        display_name: user.username || user.first_name,
                        reputation: 0
                    };
                } catch (e) {
                    console.error('[Factory] Error parsing telegram user:', e);
                }
            }
            // Check for wallet
            const wallet = localStorage.getItem('connectedWallet');
            if (wallet) {
                return {
                    id: wallet,
                    wallet_address: wallet,
                    display_name: `${wallet.slice(0,6)}...${wallet.slice(-4)}`,
                    reputation: 0
                };
            }
            return null;
        }

        function updateFactoryCounts() {
            // Count proposals by section
            const sections = ['suite_apps', 'business', 'content', 'social'];
            sections.forEach(section => {
                const count = factoryProposals.filter(p => p.section === section).length;
                const el = document.getElementById(`factory${section.charAt(0).toUpperCase() + section.slice(1).replace('_', '')}Count`);
                if (el) el.textContent = count;
            });

            // Apps count
            document.getElementById('factoryAppsCount').textContent =
                factoryProposals.filter(p => p.section === 'suite_apps').length;
            document.getElementById('factoryBusinessCount').textContent =
                factoryProposals.filter(p => p.section === 'business').length;
            document.getElementById('factoryContentCount').textContent =
                factoryProposals.filter(p => p.section === 'content').length;
            document.getElementById('factorySocialCount').textContent =
                factoryProposals.filter(p => p.section === 'social').length;

            // Agent count
            const agentCount = factoryProposals.filter(p => p.from_agent === true).length;
            document.getElementById('factoryAgentsCount').textContent = agentCount;
        }

        function renderFactoryProposals() {
            // Show/hide sidebar based on section (only show for suite_apps)
            const sidebar = document.getElementById('factoryAppFilterSidebar');
            if (sidebar) {
                sidebar.style.display = factoryCurrentSection === 'suite_apps' ? 'block' : 'none';
            }

            // Update the sidebar filter
            renderFactoryAppFilter();

            const sectionProposals = factoryProposals.filter(p => p.section === factoryCurrentSection);

            // Apply app filter
            const filteredProposals = sectionProposals.filter(p => {
                if (factoryAppFilter === 'all') return true;
                if (factoryAppFilter === 'new_app') return p.is_new_app || p.app_slug === 'new_app';
                if (factoryAppFilter === 'general') return !p.is_new_app && (!p.app_slug || p.app_slug === '');
                return p.app_slug === factoryAppFilter && !p.is_new_app;
            });

            const submitted = filteredProposals.filter(p => p.status === 'submitted');
            const voting = filteredProposals.filter(p => p.status === 'open_voting');
            const working = filteredProposals.filter(p => p.status === 'working_on');
            const implemented = filteredProposals.filter(p =>
                p.status === 'passed' || p.status === 'implemented'
            );

            // Split submitted into new app ideas vs refinements
            const newAppIdeas = submitted.filter(p => p.is_new_app || p.app_slug === 'new_app');
            const refinements = submitted.filter(p => !p.is_new_app && p.app_slug !== 'new_app');

            // Update column counts
            document.getElementById('factorySubmittedCount').textContent = submitted.length;
            document.getElementById('factoryNewAppsCount').textContent = newAppIdeas.length;
            document.getElementById('factoryRefinementsCount').textContent = refinements.length;
            document.getElementById('factoryVotingCount').textContent = voting.length;
            document.getElementById('factoryWorkingCount').textContent = working.length;
            document.getElementById('factoryImplementedCount').textContent = implemented.length;

            // Render new app ideas
            document.getElementById('factoryNewAppsCards').innerHTML =
                newAppIdeas.length ? newAppIdeas.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No new app ideas yet</p></div>';

            // Render refinements
            document.getElementById('factoryRefinementsCards').innerHTML =
                refinements.length ? refinements.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No refinements yet</p></div>';

            document.getElementById('factoryVotingCards').innerHTML =
                voting.length ? voting.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No proposals in voting</p></div>';

            document.getElementById('factoryWorkingCards').innerHTML =
                working.length ? working.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No active work</p></div>';

            document.getElementById('factoryImplementedCards').innerHTML =
                implemented.length ? implemented.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No implemented proposals</p></div>';
        }

        function switchSubmittedTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.factory-submitted-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.subtab === tab);
            });

            // Show/hide content
            document.getElementById('factoryNewAppsCards').classList.toggle('active', tab === 'newapps');
            document.getElementById('factoryNewAppsCards').style.display = tab === 'newapps' ? 'block' : 'none';
            document.getElementById('factoryRefinementsCards').classList.toggle('active', tab === 'refinements');
            document.getElementById('factoryRefinementsCards').style.display = tab === 'refinements' ? 'block' : 'none';
        }

        function isFactoryAdmin() {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) return false;
            if (currentUser.wallet_address) {
                return ADMIN_WALLETS.includes(currentUser.wallet_address.toLowerCase());
            }
            return false;
        }

        async function deleteFactoryProposal(proposalId) {
            if (!confirm('Are you sure you want to delete this proposal?')) return;

            const currentUser = getFactoryCurrentUser();
            if (!currentUser || !currentUser.wallet_address) {
                alert('Admin wallet required');
                return;
            }

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-admin`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        action: 'delete',
                        proposal_id: proposalId,
                        wallet_address: currentUser.wallet_address
                    })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    await loadFactoryProposals();
                } else {
                    alert(result.error || 'Failed to delete proposal');
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Error deleting proposal');
            }
        }

        function renderFactoryProposalCard(proposal) {
            const category = FACTORY_CATEGORIES[proposal.category] || FACTORY_CATEGORIES.general;
            const authorName = proposal.author?.display_name || 'Anonymous';
            const votesFor = proposal.votes_for || 0;
            const userVoteCount = factoryUserVotes[proposal.id] || 0;
            const nextVoteCost = getFactoryVoteCost(userVoteCount + 1);
            const canVote = getFactoryCurrentUser() && ['submitted', 'open_voting'].includes(proposal.status);
            const isAdmin = isFactoryAdmin();
            const formattedDate = new Date(proposal.created_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            // Generate app tag
            let appTag = '';
            if (proposal.is_new_app || proposal.app_slug === 'new_app') {
                appTag = '<span class="factory-app-tag new-app"> New App</span>';
            } else if (proposal.app_slug && proposal.app_slug !== '') {
                const app = factoryApps.find(a => a.slug === proposal.app_slug);
                const appName = app ? app.name : proposal.app_slug;
                appTag = `<span class="factory-app-tag"> ${escapeFactoryHtml(appName)}</span>`;
            } else {
                appTag = '<span class="factory-app-tag general"> General</span>';
            }

            // Admin delete button
            const adminControls = isAdmin ? `
                <button class="factory-admin-delete" onclick="event.stopPropagation(); deleteFactoryProposal('${proposal.id}')" title="Delete proposal">
                    
                </button>
            ` : '';

            return `
                <div class="factory-proposal-card" data-id="${proposal.id}">
                    ${adminControls}
                    ${appTag}
                    <div class="factory-proposal-category">${category.emoji} ${category.label}</div>
                    <div class="factory-proposal-title">${escapeFactoryHtml(proposal.title || 'Untitled')}</div>
                    <div class="factory-proposal-content">${escapeFactoryHtml(proposal.content || '')}</div>
                    <div class="factory-proposal-meta">
                        <span class="factory-proposal-author"> ${escapeFactoryHtml(authorName)}</span>
                        <span> ${formattedDate}</span>
                    </div>
                    <div class="factory-vote-buttons">
                        <button class="factory-vote-btn for" onclick="addFactoryVote('${proposal.id}')" ${!canVote ? 'disabled' : ''}>
                             <span class="factory-vote-count">${votesFor}</span>
                        </button>
                        <button class="factory-vote-btn against" onclick="removeFactoryVote('${proposal.id}')" ${!canVote || userVoteCount === 0 ? 'disabled' : ''}>
                             <span class="factory-vote-count">${userVoteCount}</span>
                        </button>
                        <button class="factory-comment-btn ${(proposal.comment_count || 0) > 0 ? 'has-comments' : ''}" onclick="toggleFactoryComments('${proposal.id}')">
                             ${proposal.comment_count || 0}
                        </button>
                    </div>
                    <div class="factory-comments-section" id="factory-comments-${proposal.id}">
                        <div class="factory-comments-list" id="factory-comments-list-${proposal.id}">
                            <div class="factory-no-comments">Loading...</div>
                        </div>
                        ${getFactoryCurrentUser() ? `
                        <div class="factory-comment-form">
                            <input type="text" class="factory-comment-input" id="factory-comment-input-${proposal.id}"
                                placeholder="Add a comment..." maxlength="500"
                                onkeypress="if(event.key==='Enter') postFactoryComment('${proposal.id}')">
                            <button class="factory-comment-submit" onclick="postFactoryComment('${proposal.id}')">Post</button>
                        </div>
                        ` : '<p class="factory-no-comments">Connect to comment</p>'}
                    </div>
                </div>
            `;
        }

        function escapeFactoryHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getFactoryVoteCost(voteNumber) {
            if (voteNumber <= 1) return 0;
            return Math.floor(voteNumber * (voteNumber - 1) / 2);
        }

        async function addFactoryVote(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const userVoteCount = factoryUserVotes[proposalId] || 0;
            const cost = getFactoryVoteCost(userVoteCount + 1);

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'for',
                    vote_power: 1
                };

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else if (currentUser.supabase_id || currentUser.email) {
                    payload.supabase_auth = {
                        id: currentUser.supabase_id,
                        email: currentUser.email,
                        display_name: currentUser.display_name
                    };
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    factoryUserVotes[proposalId] = (factoryUserVotes[proposalId] || 0) + 1;
                    await loadFactoryProposals();
                    updateFactoryUserCredits();
                } else {
                    alert(result.error || 'Failed to vote');
                }
            } catch (err) {
                console.error('Vote error:', err);
                alert('Error voting');
            }
        }

        async function removeFactoryVote(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const userVoteCount = factoryUserVotes[proposalId] || 0;
            if (userVoteCount <= 0) {
                alert('No votes to remove');
                return;
            }

            try {
                const payload = {
                    proposal_id: proposalId,
                    direction: 'remove',
                    vote_power: 1
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else if (currentUser.supabase_id || currentUser.email) {
                    payload.supabase_auth = {
                        id: currentUser.supabase_id,
                        email: currentUser.email,
                        display_name: currentUser.display_name
                    };
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-vote`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    factoryUserVotes[proposalId] = Math.max(0, (factoryUserVotes[proposalId] || 0) - 1);
                    await loadFactoryProposals();
                    updateFactoryUserCredits();
                } else {
                    alert(result.error || 'Failed to remove vote');
                }
            } catch (err) {
                console.error('Remove vote error:', err);
                alert('Error removing vote');
            }
        }

        // Comments
        async function toggleFactoryComments(proposalId) {
            const section = document.getElementById(`factory-comments-${proposalId}`);
            if (!section) return;

            const isOpen = section.classList.contains('open');

            // Close all other comment sections
            document.querySelectorAll('.factory-comments-section.open').forEach(s => {
                s.classList.remove('open');
            });

            if (!isOpen) {
                section.classList.add('open');
                await loadFactoryComments(proposalId);
            }
        }

        async function loadFactoryComments(proposalId) {
            const listEl = document.getElementById(`factory-comments-list-${proposalId}`);
            if (!listEl) return;

            listEl.innerHTML = '<div class="factory-no-comments">Loading...</div>';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_comments?proposal_id=eq.${proposalId}&select=id,content,created_at,user_id,factory_users(display_name)&order=created_at.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const comments = await response.json();
                    renderFactoryComments(proposalId, comments);
                }
            } catch (error) {
                listEl.innerHTML = '<div class="factory-no-comments">Error loading comments</div>';
            }
        }

        function renderFactoryComments(proposalId, comments) {
            const listEl = document.getElementById(`factory-comments-list-${proposalId}`);
            if (!listEl) return;

            if (!comments || comments.length === 0) {
                listEl.innerHTML = '<div class="factory-no-comments">No comments yet</div>';
                return;
            }

            listEl.innerHTML = comments.map(comment => {
                const authorName = comment.factory_users?.display_name || 'Anonymous';
                const timeAgo = formatFactoryTimeAgo(new Date(comment.created_at));
                return `
                    <div class="factory-comment-item">
                        <div class="factory-comment-header">
                            <span class="factory-comment-author">@${escapeFactoryHtml(authorName)}</span>
                            <span class="factory-comment-time">${timeAgo}</span>
                        </div>
                        <div class="factory-comment-content">${escapeFactoryHtml(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        function formatFactoryTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        async function postFactoryComment(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const inputEl = document.getElementById(`factory-comment-input-${proposalId}`);
            if (!inputEl) return;

            const content = inputEl.value.trim();
            if (!content) return;

            try {
                const payload = {
                    proposal_id: proposalId,
                    content: content
                };

                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else if (currentUser.supabase_id || currentUser.email) {
                    payload.supabase_auth = {
                        id: currentUser.supabase_id,
                        email: currentUser.email,
                        display_name: currentUser.display_name
                    };
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-comment`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    inputEl.value = '';
                    await loadFactoryComments(proposalId);
                    await loadFactoryProposals(); // Update comment counts
                } else {
                    alert(result.error || 'Failed to post comment');
                }
            } catch (err) {
                console.error('Comment error:', err);
                alert('Error posting comment');
            }
        }

        // Submit proposal
        function showFactorySubmitModal(section) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            // Reset form
            document.getElementById('factoryProposalContent').value = '';
            document.getElementById('factoryProposalApp').value = '';
            document.getElementById('factoryIsNewApp').checked = false;

            // Set section (default to current section)
            const targetSection = section || factoryCurrentSection;
            document.getElementById('factoryProposalSection').value = targetSection;

            // Initialize app fields visibility based on section
            onFactorySectionChange();

            document.getElementById('factorySubmitModal').classList.add('active');
        }

        function hideFactorySubmitModal() {
            document.getElementById('factorySubmitModal').classList.remove('active');
            document.getElementById('factoryProposalContent').value = '';
            document.getElementById('factoryProposalApp').value = '';
            document.getElementById('factoryIsNewApp').checked = false;
            // Reset visibility
            document.getElementById('factoryAppGroup').style.display = 'block';
            document.getElementById('factoryNewAppGroup').style.display = 'block';
        }

        function showFactoryAuthModal() {
            document.getElementById('factoryAuthModal').classList.add('active');
        }

        function hideFactoryAuthModal() {
            document.getElementById('factoryAuthModal').classList.remove('active');
        }

        async function submitFactoryProposal(event) {
            event.preventDefault();

            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const section = document.getElementById('factoryProposalSection').value;
            const content = document.getElementById('factoryProposalContent').value.trim();
            const isNewApp = document.getElementById('factoryIsNewApp').checked;
            const appSlug = document.getElementById('factoryProposalApp').value;

            if (!content) {
                alert('Please describe your idea');
                return;
            }

            const submitBtn = document.getElementById('factorySubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing & Submitting...';

            try {
                const payload = {
                    content,
                    section
                };

                // Add app-related fields for suite_apps section
                if (section === 'suite_apps') {
                    if (isNewApp) {
                        payload.is_new_app = true;
                        payload.app_slug = 'new_app';
                    } else if (appSlug) {
                        payload.app_slug = appSlug;
                    }
                }

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else if (currentUser.supabase_id || currentUser.email) {
                    payload.supabase_auth = {
                        id: currentUser.supabase_id,
                        email: currentUser.email,
                        display_name: currentUser.display_name
                    };
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    hideFactorySubmitModal();
                    await loadFactoryProposals();
                } else {
                    alert(result.error || 'Failed to submit proposal');
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting proposal');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // Leaderboard
        async function loadFactoryLeaderboard() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?select=display_name,reputation&order=reputation.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const leaders = await response.json();
                    renderFactoryLeaderboard(leaders);
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }

        function renderFactoryLeaderboard(leaders) {
            const container = document.getElementById('factoryLeaderboardList');
            if (!container) return;

            if (!leaders || leaders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">No leaders yet</p>';
                return;
            }

            const medals = ['', '', ''];
            container.innerHTML = leaders.map((user, i) => `
                <div class="factory-leaderboard-item">
                    <span class="factory-leaderboard-rank">${medals[i] || '#' + (i + 1)}</span>
                    <span class="factory-leaderboard-name">${escapeFactoryHtml(user.display_name || 'Anonymous')}</span>
                    <span class="factory-leaderboard-credits">${user.reputation || 0} credits</span>
                </div>
            `).join('');
        }

        async function updateFactoryUserCredits() {
            const currentUser = getFactoryCurrentUser();
            const creditsEl = document.getElementById('factoryUserCredits');

            if (!currentUser || !creditsEl) {
                if (creditsEl) creditsEl.textContent = '0';
                return;
            }

            try {
                // Try to get user reputation from database
                let query = `${SUPABASE_URL}/rest/v1/factory_users?select=reputation`;

                if (currentUser.telegram_id) {
                    query += `&telegram_id=eq.${currentUser.telegram_id}`;
                } else if (currentUser.wallet_address) {
                    query += `&wallet_address=eq.${currentUser.wallet_address}`;
                } else if (currentUser.supabase_id) {
                    query += `&id=eq.${currentUser.supabase_id}`;
                }

                const response = await fetch(query, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    if (users.length > 0) {
                        creditsEl.textContent = users[0].reputation || 0;
                    }
                }
            } catch (error) {
                console.error('Failed to load user credits:', error);
            }
        }

        function startCreate(type) {
            const premiumTypes = ['saas', 'internal-tool', 'automation', 'mobile-app', 'api', 'enterprise'];
            const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));

            if (premiumTypes.includes(type)) {
                if (!isLoggedIn) {
                    openConnectModal();
                    return;
                }
            }

            window.location.href = `/factory.html?create=${type}`;
        }

        function enrollCreator() {
            const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));

            if (!isLoggedIn) {
                openConnectModal();
                return;
            }

            alert('Enrollment request submitted! We will review your application and get back to you soon.');
        }

        // ========================
        // AUTH STATE MANAGEMENT
        // ========================

        // Check for Telegram WebApp (Mini App) data
        function checkTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                const initData = webApp.initDataUnsafe;

                if (initData && initData.user) {
                    const user = initData.user;
                    const tgUser = {
                        id: user.id,
                        username: user.username || user.first_name,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        photo_url: user.photo_url,
                        auth_date: Math.floor(Date.now() / 1000),
                        from_webapp: true
                    };

                    localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                    console.log('Logged in via Telegram WebApp:', tgUser.username);

                    // Expand the WebApp to full height
                    webApp.expand();

                    return true;
                }
            }
            return false;
        }

        // ========================
        // GOOGLE & EMAIL AUTH
        // ========================

        // Google OAuth login
        async function loginWithGoogle() {
            if (!supabaseClient) {
                alert('Auth system loading, please try again in a moment');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/'
                    }
                });

                if (error) {
                    console.error('Google login error:', error);
                    alert('Login failed. Please try again.');
                }
                // User will be redirected to Google, then back
            } catch (err) {
                console.error('Google login error:', err);
                alert('Login failed. Please try again.');
            }
        }

        // Email auth state
        let emailAuthMode = 'check'; // 'check' or 'auth'

        function showEmailForm() {
            const primaryOptions = document.querySelector('.connect-options-primary');
            const emailForm = document.getElementById('emailAuthForm');
            if (primaryOptions) primaryOptions.style.display = 'none';
            if (emailForm) emailForm.style.display = 'flex';
            emailAuthMode = 'check';
            // Reset form state
            const passwordField = document.getElementById('authPassword');
            const emailBtn = document.getElementById('emailAuthBtn');
            if (passwordField) passwordField.style.display = 'none';
            if (emailBtn) emailBtn.textContent = 'Continue';
        }

        function hideEmailForm() {
            const primaryOptions = document.querySelector('.connect-options-primary');
            const emailForm = document.getElementById('emailAuthForm');
            if (primaryOptions) primaryOptions.style.display = 'flex';
            if (emailForm) emailForm.style.display = 'none';
            // Reset form
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            if (emailInput) emailInput.value = '';
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.style.display = 'none';
            }
            emailAuthMode = 'check';
        }

        async function handleEmailAuth() {
            if (!supabaseClient) {
                alert('Auth system loading, please try again in a moment');
                return;
            }

            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const btn = document.getElementById('emailAuthBtn');

            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email) {
                alert('Please enter your email');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (emailAuthMode === 'check') {
                // Show password field
                if (passwordInput) passwordInput.style.display = 'block';
                if (btn) btn.textContent = 'Log in / Sign up';
                emailAuthMode = 'auth';
                passwordInput.focus();
                return;
            }

            // Validate password
            if (!password || password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            // Disable button during auth
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Please wait...';
            }

            try {
                // Try to sign in first
                let { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        // User doesn't exist or wrong password, try to sign up
                        const signUpResult = await supabaseClient.auth.signUp({
                            email,
                            password
                        });

                        if (signUpResult.error) {
                            throw signUpResult.error;
                        }

                        data = signUpResult.data;

                        // Check if email confirmation is required
                        if (data.user && !data.session) {
                            alert('Account created! Please check your email to confirm your account.');
                            hideEmailForm();
                            if (btn) {
                                btn.disabled = false;
                                btn.textContent = 'Continue';
                            }
                            return;
                        }
                    } else {
                        throw error;
                    }
                }

                // Success - close modal and update auth state
                if (data.user || data.session) {
                    closeConnectModal();
                    await checkAuthState();
                }
            } catch (err) {
                console.error('Email auth error:', err);
                alert(err.message || 'Authentication failed. Please try again.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Log in / Sign up';
                }
            }
        }

        // Check for Supabase session on page load (for OAuth redirect)
        async function checkSupabaseSession() {
            if (!supabaseClient) return null;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                return session?.user || null;
            } catch (err) {
                console.error('Error checking Supabase session:', err);
                return null;
            }
        }

        // Check if user is logged in
        async function checkAuthState() {
            // First check if opened as Telegram WebApp
            checkTelegramWebApp();

            // Check Supabase session (Google/Email)
            const supabaseUser = await checkSupabaseSession();

            const wallet = localStorage.getItem('connectedWallet') ||
                          localStorage.getItem('walletAddress') ||
                          localStorage.getItem('suiteWalletAddress') ||
                          localStorage.getItem('suiteWallet');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {
                    console.error('Failed to parse telegram_user:', e);
                    localStorage.removeItem('telegram_user');
                }
            }

            const isLoggedIn = !!(wallet || telegramUser || supabaseUser);

            // Update sidebar profile
            const profileName = document.getElementById('sidebarProfileName');
            const profileStatus = document.getElementById('sidebarProfileStatus');
            const profileAvatar = document.getElementById('sidebarAvatar');
            const creditsSection = document.getElementById('profileCreditsSection');

            if (isLoggedIn) {
                document.body.classList.remove('logged-out');

                // Show credits section in dropdown
                if (creditsSection) creditsSection.style.display = 'block';

                if (supabaseUser) {
                    // Google/Email user
                    const displayName = supabaseUser.user_metadata?.full_name ||
                                       supabaseUser.user_metadata?.name ||
                                       supabaseUser.email?.split('@')[0] || 'User';
                    if (profileName) profileName.textContent = displayName;
                    if (profileAvatar) {
                        if (supabaseUser.user_metadata?.avatar_url) {
                            profileAvatar.innerHTML = `<img src="${supabaseUser.user_metadata.avatar_url}" alt="${displayName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else {
                            // Default avatar for email users
                            profileAvatar.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>`;
                        }
                    }
                    // Fetch credits for email user
                    fetchUserCredits(supabaseUser.email, 'email');
                } else if (telegramUser) {
                    // Telegram user
                    const displayName = telegramUser.username || telegramUser.first_name || 'User';
                    if (profileName) profileName.textContent = displayName;
                    if (profileAvatar && telegramUser.photo_url) {
                        profileAvatar.innerHTML = `<img src="${telegramUser.photo_url}" alt="${displayName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    }
                    // Fetch credits for telegram user
                    fetchUserCredits(telegramUser.id, 'telegram');
                } else if (wallet) {
                    // Wallet user
                    const shortWallet = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                    if (profileName) profileName.textContent = shortWallet;
                    // Fetch credits for wallet user
                    fetchUserCredits(wallet, 'wallet');
                }
            } else {
                document.body.classList.add('logged-out');
                if (profileName) profileName.textContent = 'Get Started';
                if (profileStatus) profileStatus.textContent = 'Connect to save progress';
                if (creditsSection) creditsSection.style.display = 'none';
                if (profileAvatar) {
                    profileAvatar.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>`;
                }
                // Reset credits display
                updateCreditsDisplay(0);
            }

            // Update linked accounts display in dropdown
            renderLinkedAccounts();

            return isLoggedIn;
        }

        // Fetch user credits from Supabase (suite_credits table with unified auth)
        async function fetchUserCredits(userId, authType) {
            try {
                let credits = 0;

                if (authType === 'wallet') {
                    // Direct query by wallet address
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/suite_credits?wallet_address=eq.${userId.toLowerCase()}&select=balance`,
                        {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.balance || 0;
                    }
                } else if (authType === 'telegram') {
                    // Use RPC function for telegram lookup
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/get_credits_by_telegram`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ tg_id: String(userId) })
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.user_balance || 0;
                    }
                } else if (authType === 'email') {
                    // Use RPC to get or create credits for email user
                    const supabaseUser = await checkSupabaseSession();
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/get_or_create_credits_by_email`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                p_email: userId,
                                p_supabase_id: supabaseUser?.id || null
                            })
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.user_balance || 0;
                    }

                    // Auto-link: If wallet exists locally, try to link email to it
                    const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (wallet && supabaseUser) {
                        await autoLinkEmailToWallet(wallet, userId, supabaseUser.id);
                    }
                }

                updateCreditsDisplay(credits);
            } catch (error) {
                console.error('Error fetching credits:', error);
                updateCreditsDisplay(0);
            }
        }

        // Auto-link email to wallet when both are present
        async function autoLinkEmailToWallet(walletAddress, email, supabaseId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/rpc/link_email_to_wallet`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            p_wallet_address: walletAddress,
                            p_email: email,
                            p_supabase_id: supabaseId
                        })
                    }
                );
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('[Auth] Auto-linked email to wallet:', result.merged ? `merged ${result.merged_credits} credits` : 'linked');
                    } else {
                        console.log('[Auth] Could not auto-link email to wallet:', result.error);
                    }
                }
            } catch (error) {
                console.error('[Auth] Error auto-linking email:', error);
            }
        }

        // Render linked accounts in the profile dropdown
        async function renderLinkedAccounts() {
            const container = document.getElementById('linkedAccountsList');
            if (!container) return;

            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {}
            }
            const supabaseUser = await checkSupabaseSession();

            let html = '';

            // Wallet status - always show connect option if not connected
            if (wallet) {
                const shortWallet = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                html += `
                    <button class="link-account-btn connected" onclick="disconnectWallet()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Wallet</span>
                        <span class="linked-account-value">${shortWallet}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="connectWalletToLink()">+ Connect Wallet</button>`;
            }

            // Google/Email status - always show connect option if not connected
            if (supabaseUser) {
                const displayEmail = supabaseUser.email?.length > 20
                    ? supabaseUser.email.slice(0, 17) + '...'
                    : supabaseUser.email;
                html += `
                    <button class="link-account-btn connected" onclick="disconnectGoogle()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Google</span>
                        <span class="linked-account-value">${displayEmail}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="linkGoogleAccount()">+ Link Google</button>`;
            }

            // Telegram status - always show connect option if not connected
            if (telegramUser) {
                const tgDisplay = telegramUser.username ? `@${telegramUser.username}` : telegramUser.first_name;
                html += `
                    <button class="link-account-btn connected" onclick="disconnectTelegram()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Telegram</span>
                        <span class="linked-account-value">${tgDisplay}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="linkTelegramAccount()">+ Link Telegram</button>`;
            }

            // Always show the linked accounts section (guests can connect)
            const section = document.getElementById('linkedAccountsSection');
            if (section) {
                section.style.display = 'block';
            }

            container.innerHTML = html || '<div class="linked-account" style="color:var(--text-tertiary)">No accounts linked</div>';
        }

        // Link Google account to existing wallet/telegram
        async function linkGoogleAccount() {
            if (!supabaseClient) {
                alert('Auth system not ready. Please refresh the page.');
                return;
            }

            // Use clean redirect URL (origin + pathname only)
            const redirectUrl = window.location.origin + window.location.pathname;
            console.log('[Auth] Starting Google OAuth, redirect to:', redirectUrl);

            // Trigger Google OAuth - auto-linking happens in auth state change handler
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: redirectUrl }
            });

            if (error) {
                console.error('[Auth] Google OAuth error:', error);
                alert('Failed to start Google sign-in: ' + error.message);
            }
        }

        // Connect wallet for linking (when user has email but no wallet)
        async function connectWalletToLink() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];

                // Store wallet
                localStorage.setItem('connectedWallet', walletAddress);

                // Try to link wallet to email credits
                const supabaseUser = await checkSupabaseSession();
                if (supabaseUser) {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/link_wallet_to_email`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                p_wallet_address: walletAddress,
                                p_email: supabaseUser.email
                            })
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log('[Auth] Linked wallet to email account');
                            alert('Wallet linked successfully! You can now withdraw credits.');
                            // Fetch wallet credits directly since that's where the merged balance is
                            await fetchUserCredits(walletAddress, 'wallet');
                        } else {
                            console.warn('[Auth] Could not link wallet:', result.error);
                            if (result.error?.includes('already has credits')) {
                                alert('This wallet already has credits associated with it. Contact support to merge accounts.');
                            }
                        }
                    }
                }

                // Refresh UI
                checkAuthState();
                renderLinkedAccounts();

            } catch (error) {
                console.error('[Auth] Wallet connection error:', error);
                if (error.code === 4001) {
                    alert('Connection cancelled');
                } else {
                    alert('Failed to connect wallet: ' + error.message);
                }
            }
        }

        // Link Telegram account using widget
        function linkTelegramAccount() {
            const botId = '8341049569'; // SUITEHubBot
            const botUsername = 'SUITEHubBot';

            // Check if mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile: Open Telegram app directly
                window.location.href = `tg://resolve?domain=${botUsername}&start=link`;
                setTimeout(() => {
                    window.location.href = `https://t.me/${botUsername}?start=link`;
                }, 500);
            } else {
                // On desktop: Use Telegram Login Widget
                if (!window.Telegram || !window.Telegram.Login) {
                    const script = document.createElement('script');
                    script.src = 'https://telegram.org/js/telegram-widget.js?22';
                    script.onload = () => openTelegramLinkAuth(botId);
                    document.head.appendChild(script);
                } else {
                    openTelegramLinkAuth(botId);
                }
            }
        }

        function openTelegramLinkAuth(botId) {
            window.Telegram.Login.auth(
                { bot_id: botId, request_access: true },
                async (user) => {
                    if (user) {
                        // Store Telegram user
                        const tgUser = {
                            id: user.id,
                            username: user.username || user.first_name,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            photo_url: user.photo_url,
                            auth_date: user.auth_date,
                            hash: user.hash
                        };
                        localStorage.setItem('telegram_user', JSON.stringify(tgUser));

                        // Link to existing wallet/email in database
                        const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                        if (wallet) {
                            try {
                                await fetch(`${SUPABASE_URL}/rest/v1/rpc/link_telegram_to_wallet`, {
                                    method: 'POST',
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        p_wallet_address: wallet,
                                        p_telegram_id: String(user.id),
                                        p_telegram_username: user.username || null
                                    })
                                });
                            } catch (e) {
                                console.error('Error linking Telegram:', e);
                            }
                        }

                        checkAuthState();
                        renderLinkedAccounts();
                    }
                }
            );
        }

        // Credits state (must be declared before updateCreditsDisplay)
        // Disconnect functions
        function disconnectWallet() {
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('suiteWalletAddress');
            checkAuthState();
            renderLinkedAccounts();
        }

        async function disconnectGoogle() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            checkAuthState();
            renderLinkedAccounts();
        }

        function disconnectTelegram() {
            localStorage.removeItem('telegram_user');
            checkAuthState();
            renderLinkedAccounts();
        }

        let userCredits = 0;

        // Update credits display in sidebar and dropdown
        function updateCreditsDisplay(credits) {
            userCredits = credits;
            const formattedCredits = credits.toLocaleString();
            const usdValue = (credits / 1000).toFixed(2);

            // Update sidebar status (only when logged in)
            const profileStatus = document.getElementById('sidebarProfileStatus');
            if (profileStatus && !document.body.classList.contains('logged-out')) {
                profileStatus.textContent = `${formattedCredits} credits`;
            }

            // Update dropdown credits
            const dropdownCredits = document.getElementById('dropdownCredits');
            if (dropdownCredits) dropdownCredits.textContent = formattedCredits;

            // Update withdrawal modal if it exists
            const withdrawalCredits = document.getElementById('withdrawalCredits');
            const withdrawalValue = document.getElementById('withdrawalValue');
            if (withdrawalCredits) withdrawalCredits.textContent = formattedCredits;
            if (withdrawalValue) withdrawalValue.textContent = `~$${usdValue} USD value`;
        }

        // Start a new chat
        function startNewChat() {
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const learnView = document.getElementById('learnView');
            const docsView = document.getElementById('docsView');

            // Clear chat
            if (chatMessages) chatMessages.innerHTML = '';

            // Reset conversation history
            if (typeof conversationHistory !== 'undefined') {
                conversationHistory = [];
            }

            // Hide all other views
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (docsView) docsView.classList.remove('active');

            // Also hide article reader if open
            hideArticle();

            // Reset UI to welcome state
            if (welcomeState) {
                welcomeState.style.display = '';
                welcomeState.classList.remove('chat-active');
            }
            if (useCasesSection) {
                useCasesSection.style.display = 'block';
            }
            if (chatInput) {
                chatInput.value = '';
                chatInput.focus();
            }

            // Update URL to root
            history.pushState({ view: 'home' }, '', '/');

            // Close mobile sidebar if open
            closeMobileSidebar();
        }

        // Toggle chat search (placeholder for future implementation)
        function toggleChatSearch() {
            // For now, focus the chat input and show a search hint
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.placeholder = 'Search your chats...';
                chatInput.focus();
                // Reset placeholder after a delay
                setTimeout(() => {
                    chatInput.placeholder = 'I need help with...';
                }, 3000);
            }
        }

        // Open login modal
        function openLoginModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Open signup modal (same as login)
        function openSignupModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Alias for openLoginModal (used in various places)
        function openConnectModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Close connect modal
        function closeConnectModal() {
            document.getElementById('connectModalOverlay').classList.remove('active');
        }

        // Sidebar toggle functions
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('collapsed');
            document.querySelector('.main-content').classList.add('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.add('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.add('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'true');
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.remove('collapsed');
            document.querySelector('.main-content').classList.remove('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.remove('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.remove('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'false');
        }

        // Restore sidebar state on load
        if (localStorage.getItem('suitegpt_sidebar_collapsed') === 'true') {
            closeSidebar();
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const address = accounts[0];
                    localStorage.setItem('connectedWallet', address);
                    localStorage.setItem('suiteWalletAddress', address);
                    localStorage.setItem('suiteWallet', address);
                    window.walletAddress = address;

                    console.log('Wallet connected:', address);
                    closeConnectModal();
                    checkAuthState();

                    // Dispatch event for other components
                    window.dispatchEvent(new CustomEvent('navAuthChanged', { detail: { wallet: address } }));
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    console.log('Connection cancelled by user');
                }
            }
        }

        // Telegram login
        function loginWithTelegram() {
            const botId = '8341049569'; // SUITEHubBot
            const botUsername = 'SUITEHubBot';
            closeConnectModal();

            // Check if mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile: Open Telegram app directly to bot
                // User can tap the Menu button in bot to login via web app
                window.location.href = `tg://resolve?domain=${botUsername}&start=login`;

                // Fallback to t.me link if tg:// doesn't work
                setTimeout(() => {
                    window.location.href = `https://t.me/${botUsername}?start=login`;
                }, 500);
            } else {
                // On desktop: Use standard widget
                if (!window.Telegram || !window.Telegram.Login) {
                    const script = document.createElement('script');
                    script.src = 'https://telegram.org/js/telegram-widget.js?22';
                    script.onload = () => openTelegramAuth(botId);
                    document.head.appendChild(script);
                } else {
                    openTelegramAuth(botId);
                }
            }
        }

        function openTelegramAuth(botId) {
            window.Telegram.Login.auth(
                { bot_id: botId, request_access: true },
                (user) => {
                    if (user) {
                        const tgUser = {
                            id: user.id,
                            username: user.username || user.first_name,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            photo_url: user.photo_url,
                            auth_date: user.auth_date,
                            hash: user.hash
                        };

                        localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                        checkAuthState();
                        window.location.reload();
                    }
                }
            );
        }

        // Initial auth state check is deferred until Supabase is ready
        // See Supabase initialization section below

        // Listen for auth changes
        window.addEventListener('storage', (e) => {
            if (['connectedWallet', 'walletAddress', 'suiteWalletAddress', 'telegram_user'].includes(e.key)) {
                checkAuthState();
            }
        });

        // Listen for custom auth events from nav component
        window.addEventListener('navAuthChanged', () => {
            checkAuthState();
        });

        // ========================
        // SUITE Apps Catalog
        // ========================
        const SUITE_APPS = {
            'foodvitals': {
                name: 'FoodVitals',
                description: 'Weekly meal tracking + AI nutrition insights',
                iconUrl: '/assets/icons/foodvitals-icon.jpg',
                iconBg: 'linear-gradient(135deg, #22c55e, #16a34a)',
                url: '/suite-shell.html?app=foodvitals'
            },
            'trueform': {
                name: 'TrueForm AI',
                description: 'AI physiotherapy and exercise guidance',
                iconUrl: '/assets/icons/trueform-icon.jpg',
                iconBg: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                url: '/suite-shell.html?app=trueform'
            },
            'opticrep': {
                name: 'OpticRep',
                description: 'AI workout trainer with form analysis',
                iconUrl: '/assets/icons/opticrep-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f97316, #ea580c)',
                url: '/suite-shell.html?app=opticrep'
            },
            'cheshbon': {
                name: 'Cheshbon',
                description: 'Financial reflection and tracking app',
                iconUrl: '/assets/icons/cheshbon-icon.jpg',
                iconBg: 'linear-gradient(135deg, #eab308, #ca8a04)',
                url: '/suite-shell.html?app=cheshbon'
            },
            'remcast': {
                name: 'RemCast',
                description: 'Smart reminder and notification system',
                iconUrl: '/assets/icons/remcast-icon.jpg',
                iconBg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                url: '/suite-shell.html?app=remcast'
            },
            'defi-knowledge': {
                name: 'DeFi Knowledge',
                description: 'Learn DeFi concepts and strategies',
                iconUrl: '/assets/icons/defiknowledge-icon.png',
                iconBg: 'linear-gradient(135deg, #06b6d4, #0891b2)',
                url: '/suite-shell.html?app=defiknowledge'
            },
            'cadence-ai': {
                name: 'Cadence AI',
                description: 'AI-powered social media scheduling',
                iconUrl: '/assets/icons/cadence-icon.jpg',
                iconBg: 'linear-gradient(135deg, #ec4899, #db2777)',
                url: 'https://cadence-ai-nextjs.vercel.app'
            },
            // Spirituality Apps
            'jesus-is-god': {
                name: 'Jesus Is God',
                description: 'Explore the truth of who Jesus is',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f59e0b, #d97706)',
                url: '/jesus-is-god.html'
            },
            // Health & Wellness Apps
            'hydrotrack': {
                name: 'HydroTrack',
                description: 'Track your daily water intake',
                icon: '',
                iconBg: 'linear-gradient(135deg, #38bdf8, #0284c7)',
                url: '/hydrotrack.html'
            },
            'sleepwell': {
                name: 'SleepWell',
                description: 'AI sleep quality tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #818cf8, #4f46e5)',
                url: '/sleepwell.html'
            },
            'moodlog': {
                name: 'MoodLog',
                description: 'Track emotions, find patterns',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f472b6, #db2777)',
                url: '/moodlog.html'
            },
            'pillpal': {
                name: 'PillPal',
                description: 'Never miss a medication',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fb7185, #e11d48)',
                url: '/pillpal.html'
            },
            'breatheasy': {
                name: 'BreathEasy',
                description: 'Guided breathing exercises',
                icon: '',
                iconBg: 'linear-gradient(135deg, #5eead4, #14b8a6)',
                url: '/breatheasy.html'
            },
            'stepgoal': {
                name: 'StepGoal',
                description: 'Daily step counter & goals',
                icon: '',
                iconBg: 'linear-gradient(135deg, #a3e635, #65a30d)',
                url: '/stepgoal.html'
            },
            'stretchtimer': {
                name: 'StretchTimer',
                description: 'Desk break reminders',
                icon: '',
                iconBg: 'linear-gradient(135deg, #c084fc, #9333ea)',
                url: '/stretchtimer.html'
            },
            // Productivity & Learning Apps
            'focusflow': {
                name: 'FocusFlow',
                description: 'Pomodoro timer with stats',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f97316, #c2410c)',
                url: '/focusflow.html'
            },
            'quickbudget': {
                name: 'QuickBudget',
                description: 'Simple expense tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #4ade80, #16a34a)',
                url: '/quickbudget.html'
            },
            'flashmind': {
                name: 'FlashMind',
                description: 'AI-powered flashcards',
                icon: '',
                iconBg: 'linear-gradient(135deg, #60a5fa, #2563eb)',
                url: '/flashmind.html'
            },
            'bookshelf': {
                name: 'BookShelf',
                description: 'Track books & reading goals',
                icon: '',
                iconBg: 'linear-gradient(135deg, #a78bfa, #7c3aed)',
                url: '/bookshelf.html'
            },
            'skilltree': {
                name: 'SkillTree',
                description: 'Track learning progress',
                icon: '',
                iconBg: 'linear-gradient(135deg, #34d399, #059669)',
                url: '/skilltree.html'
            },
            'mealprep': {
                name: 'MealPrep',
                description: 'Weekly meal planner',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fbbf24, #d97706)',
                url: '/mealprep.html'
            },
            'cleanhome': {
                name: 'CleanHome',
                description: 'Cleaning schedule & tasks',
                icon: '',
                iconBg: 'linear-gradient(135deg, #2dd4bf, #0d9488)',
                url: '/cleanhome.html'
            },
            // Lifestyle & Social Apps
            'datenight': {
                name: 'DateNight',
                description: 'Date ideas & planning',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fb7185, #be123c)',
                url: '/datenight.html'
            },
            'petcare': {
                name: 'PetCare',
                description: 'Pet health & care tracker',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fdba74, #ea580c)',
                url: '/petcare.html'
            },
            'packlight': {
                name: 'PackLight',
                description: 'Smart packing lists',
                icon: '',
                iconBg: 'linear-gradient(135deg, #93c5fd, #1d4ed8)',
                url: '/packlight.html'
            },
            'giftguru': {
                name: 'GiftGuru',
                description: 'Gift ideas & tracking',
                icon: '',
                iconBg: 'linear-gradient(135deg, #f0abfc, #a855f7)',
                url: '/giftguru.html'
            },
            'habitstack': {
                name: 'HabitStack',
                description: 'Chain habits together',
                icon: '',
                iconBg: 'linear-gradient(135deg, #fcd34d, #b45309)',
                url: '/habitstack.html'
            },
            'quickdecide': {
                name: 'QuickDecide',
                description: 'Decision helper & coin flip',
                icon: '',
                iconBg: 'linear-gradient(135deg, #67e8f9, #0891b2)',
                url: '/quickdecide.html'
            },
            'visual-feedback': {
                name: 'Visual Feedback',
                description: 'Chrome extension for agentic coding - Alt+X to select elements',
                icon: '',
                iconBg: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                url: '/extensions/suite-visual-feedback/',
                isExtension: true
            }
        };

        // ========================
        // APPS PANEL FUNCTIONALITY
        // ========================
        function openAppsPanel(skipPushState = false) {
            // Show inline apps view instead of modal
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');
            const grid = document.getElementById('appsViewGrid');

            // Hide all other views, show apps view
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (appsView) appsView.classList.add('active');

            // Also hide article reader if open
            hideArticle();

            // Update URL to /apps
            if (!skipPushState) {
                history.pushState({ view: 'apps' }, '', '/apps');
            }

            // Scroll to top of chat area
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Categorize apps by tier
            const tools = [];
            const extensions = [];
            const apps = [];
            const platforms = [];

            Object.entries(SUITE_APPS).forEach(([key, app]) => {
                const tier = getAppTier(key);
                const appData = { key, ...app };
                if (tier === 'tool') tools.push(appData);
                else if (tier === 'extension') extensions.push(appData);
                else if (tier === 'platform') platforms.push(appData);
                else apps.push(appData);
            });

            // Helper to create app item
            const createAppItem = (appData) => {
                const item = document.createElement('div');
                item.className = 'apps-view-item';
                item.dataset.name = appData.name.toLowerCase();
                item.dataset.desc = appData.description.toLowerCase();
                item.dataset.tier = getAppTier(appData.key);
                item.onclick = () => launchApp(appData.key, appData.url, appData.name);

                const iconHtml = appData.iconUrl
                    ? `<img src="${appData.iconUrl}" alt="${appData.name}">`
                    : appData.icon || '';

                item.innerHTML = `
                    <div class="apps-view-item-icon" style="background: ${appData.iconBg}">
                        ${iconHtml}
                    </div>
                    <div class="apps-view-item-name">${appData.name}</div>
                    <div class="apps-view-item-desc">${appData.description}</div>
                `;
                return item;
            };

            // Define tiers
            const tiers = [
                { id: 'tools', icon: '', label: 'Tools', apps: tools },
                { id: 'extensions', icon: '', label: 'Extensions', apps: extensions },
                { id: 'apps', icon: '', label: 'Apps', apps: apps },
                { id: 'platforms', icon: '', label: 'Platforms', apps: platforms }
            ];

            // Build tabs and panels
            grid.innerHTML = '';

            // Create tabs container
            const tabsContainer = document.createElement('div');
            tabsContainer.className = 'apps-view-tabs';

            // Create panels
            const panels = {};

            tiers.forEach((tier, index) => {
                // Create tab
                const tab = document.createElement('button');
                tab.className = 'apps-view-tab' + (index === 0 ? ' active' : '');
                tab.dataset.tier = tier.id;
                tab.innerHTML = `
                    <span class="apps-view-tab-icon">${tier.icon}</span>
                    ${tier.label}
                    <span class="apps-view-tab-count">${tier.apps.length}</span>
                `;
                tab.onclick = () => switchAppsTab(tier.id);
                tabsContainer.appendChild(tab);

                // Create panel
                const panel = document.createElement('div');
                panel.className = 'apps-view-panel' + (index === 0 ? ' active' : '');
                panel.id = `appsPanel${tier.id}`;
                tier.apps.forEach(appData => {
                    panel.appendChild(createAppItem(appData));
                });
                panels[tier.id] = panel;
            });

            grid.appendChild(tabsContainer);
            Object.values(panels).forEach(panel => grid.appendChild(panel));

            // Focus search input
            setTimeout(() => {
                const searchInput = document.getElementById('appsViewSearch');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        function closeAppsView(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const useCasesSection = document.getElementById('useCasesSection');
            const searchInput = document.getElementById('appsViewSearch');

            // Show welcome state, hide apps view
            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (appsView) appsView.classList.remove('active');
            if (searchInput) searchInput.value = '';

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        function closeAppsPanel() {
            // Keep for backwards compatibility
            closeAppsView();
        }

        function switchAppsTab(tierId) {
            // Update tabs
            document.querySelectorAll('.apps-view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tier === tierId);
            });

            // Update panels
            document.querySelectorAll('.apps-view-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `appsPanel${tierId}`);
            });
        }

        function filterApps(query) {
            const items = document.querySelectorAll('.apps-panel-item');
            const lower = query.toLowerCase();

            items.forEach(item => {
                const name = item.dataset.name;
                const desc = item.dataset.desc;
                const matches = name.includes(lower) || desc.includes(lower);
                item.style.display = matches ? '' : 'none';
            });
        }

        function filterAppsInline(query) {
            const items = document.querySelectorAll('.apps-view-item');
            const lower = query.toLowerCase();

            // Filter items across all panels
            items.forEach(item => {
                const name = item.dataset.name;
                const desc = item.dataset.desc;
                const matches = name.includes(lower) || desc.includes(lower);
                item.style.display = matches ? '' : 'none';
            });

            // Update tab counts to show filtered counts
            document.querySelectorAll('.apps-view-tab').forEach(tab => {
                const tierId = tab.dataset.tier;
                const panel = document.getElementById(`appsPanel${tierId}`);
                if (panel) {
                    const visibleCount = panel.querySelectorAll('.apps-view-item:not([style*="display: none"])').length;
                    const countEl = tab.querySelector('.apps-view-tab-count');
                    if (countEl) countEl.textContent = visibleCount;
                }
            });
        }

        // Current previewing app key
        let currentPreviewApp = null;

        // Pending app launch info (for modal)
        let pendingAppLaunch = { key: null, url: null, name: null };

        function launchApp(appKey, url, name) {
            const app = SUITE_APPS[appKey];

            // Check if this is an extension
            if (app && app.isExtension) {
                // Open the extension folder/download page
                window.open(url, '_blank');
                return;
            }

            closeAppsView();
            closeAppsPanel();

            // Check if on mobile - if so, launch directly in fullscreen
            if (window.innerWidth < 768) {
                previewApp(appKey, url, name);
                return;
            }

            // On desktop, show launch modal
            showAppLaunchModal(appKey, url, name);
        }

        function showAppLaunchModal(appKey, url, name) {
            const app = SUITE_APPS[appKey];
            const overlay = document.getElementById('appLaunchModalOverlay');
            const iconEl = document.getElementById('appLaunchModalIcon');
            const nameEl = document.getElementById('appLaunchModalName');

            if (!overlay) return;

            // Store pending launch info
            pendingAppLaunch = { key: appKey, url, name };

            // Set app info
            nameEl.textContent = name || app?.name || 'App';

            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else if (app?.icon) {
                iconEl.innerHTML = app.icon;
                iconEl.style.background = app.iconBg || 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            } else {
                iconEl.innerHTML = '';
                iconEl.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            }

            overlay.classList.add('active');
        }

        function closeAppLaunchModal() {
            const overlay = document.getElementById('appLaunchModalOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function launchAppFullscreen() {
            closeAppLaunchModal();
            previewApp(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        function launchAppMobile() {
            closeAppLaunchModal();
            openMobileAppView(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        function openMobileAppView(appKey, url, name) {
            const app = SUITE_APPS[appKey];
            const container = document.getElementById('mobileAppContainer');
            const frame = document.getElementById('mobileAppFrame');
            const iconEl = document.getElementById('mobileAppIcon');
            const titleEl = document.getElementById('mobileAppTitle');

            if (!container || !frame) return;

            currentPreviewApp = appKey;
            pendingAppLaunch = { key: appKey, url, name };

            // Set app info
            titleEl.textContent = name || app?.name || 'App';

            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else if (app?.icon) {
                iconEl.innerHTML = app.icon;
                iconEl.style.background = app.iconBg || 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            } else {
                iconEl.innerHTML = '';
                iconEl.style.background = 'var(--bg-card)';
            }

            // Center the container initially
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';

            // Load the app
            frame.src = url;
            container.classList.add('active');

            // Initialize dragging
            initMobileAppDrag();

            // Update sidebar active state
            updateSidebarActiveApp(appKey);
        }

        // Update sidebar to show which app is active
        function updateSidebarActiveApp(activeAppKey) {
            document.querySelectorAll('.sidebar-app-tab').forEach(tab => {
                const tabAppKey = tab.getAttribute('data-app-key');
                if (tabAppKey === activeAppKey) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        function closeMobileApp() {
            const container = document.getElementById('mobileAppContainer');
            const frame = document.getElementById('mobileAppFrame');

            if (container) {
                container.classList.remove('active');
                // Reset position for next open
                container.style.transform = 'translate(-50%, -50%)';
            }
            if (frame) frame.src = '';
            currentPreviewApp = null;

            // Clear sidebar active state
            updateSidebarActiveApp(null);
        }

        // Minimize app to sidebar (save + close)
        function minimizeToSidebar() {
            if (!currentPreviewApp) {
                closeMobileApp();
                return;
            }

            const appKey = currentPreviewApp;
            const app = SUITE_APPS[appKey];
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            // Add to saved apps if not already there
            if (!savedApps.includes(appKey)) {
                savedApps.push(appKey);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                showToast(`${app?.name || 'App'} saved to your apps`);
            } else {
                showToast(`${app?.name || 'App'} minimized`);
            }

            // Close the mobile view
            closeMobileApp();

            // Update sidebar
            renderSidebarApps();
            renderYourApps(); // Also update dashboard if open
        }

        // Toggle Your Apps section expand/collapse
        function toggleYourApps() {
            const header = document.querySelector('.sidebar-your-apps .sidebar-expandable');
            const list = document.getElementById('sidebarAppsList');

            if (header && list) {
                header.classList.toggle('collapsed');
                list.classList.toggle('collapsed');
            }
        }

        // Render saved apps in sidebar
        function renderSidebarApps() {
            const list = document.getElementById('sidebarAppsList');
            const countEl = document.getElementById('yourAppsCount');
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            if (!list) return;

            // Update count
            if (countEl) {
                countEl.textContent = `(${savedApps.length})`;
            }

            // Clear list
            list.innerHTML = '';

            // Show empty state if no apps
            if (savedApps.length === 0) {
                list.innerHTML = '<div class="sidebar-apps-empty">No apps saved yet</div>';
                return;
            }

            // Render each app
            savedApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const tab = document.createElement('div');
                tab.className = 'sidebar-app-tab';
                tab.setAttribute('data-app-key', appKey);

                // Check if this app is currently active
                if (currentPreviewApp === appKey) {
                    tab.classList.add('active');
                }

                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : (app.icon || '');

                tab.innerHTML = `
                    <div class="sidebar-app-tab-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                        ${iconHtml}
                    </div>
                    <span class="sidebar-app-tab-name">${app.name}</span>
                    <button class="sidebar-app-tab-remove" onclick="event.stopPropagation(); removeSidebarApp('${appKey}')" title="Remove">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                `;

                // Click to reopen app
                tab.onclick = () => {
                    launchApp(appKey, app.url, app.name);
                };

                list.appendChild(tab);
            });
        }

        // Remove app from sidebar
        function removeSidebarApp(appKey) {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const index = savedApps.indexOf(appKey);

            if (index > -1) {
                savedApps.splice(index, 1);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                renderSidebarApps();
                renderYourApps(); // Also update dashboard if open
                showToast(`${SUITE_APPS[appKey]?.name || 'App'} removed from your apps`);
            }
        }

        function switchToFullscreen() {
            closeMobileApp();
            previewApp(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        // Dragging functionality for mobile app container
        function initMobileAppDrag() {
            const container = document.getElementById('mobileAppContainer');
            const header = document.getElementById('mobileAppHeader');

            if (!container || !header) return;

            let isDragging = false;
            let startX, startY, startLeft, startTop;
            let hasMoved = false;

            const onMouseDown = (e) => {
                if (e.target.closest('.mobile-app-btn')) return; // Don't drag when clicking buttons

                isDragging = true;
                hasMoved = false;

                // Get current position
                const rect = container.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                startX = e.clientX || e.touches?.[0]?.clientX;
                startY = e.clientY || e.touches?.[0]?.clientY;

                // Remove centering transform once we start dragging
                container.style.transform = 'none';
                container.style.left = startLeft + 'px';
                container.style.top = startTop + 'px';

                header.style.cursor = 'grabbing';
                e.preventDefault();
            };

            const onMouseMove = (e) => {
                if (!isDragging) return;

                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;

                const deltaX = clientX - startX;
                const deltaY = clientY - startY;

                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;

                // Keep within viewport
                const rect = container.getBoundingClientRect();
                const maxLeft = window.innerWidth - rect.width;
                const maxTop = window.innerHeight - rect.height;

                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));

                container.style.left = newLeft + 'px';
                container.style.top = newTop + 'px';
            };

            const onMouseUp = () => {
                isDragging = false;
                header.style.cursor = 'grab';
            };

            // Remove old listeners if any
            header.onmousedown = null;
            document.onmousemove = null;
            document.onmouseup = null;

            // Add listeners
            header.addEventListener('mousedown', onMouseDown);
            header.addEventListener('touchstart', onMouseDown, { passive: false });
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('touchmove', onMouseMove, { passive: false });
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('touchend', onMouseUp);
        }

        async function previewApp(appKey, appUrl, appName) {
            const overlay = document.getElementById('appPreviewOverlay');
            const frame = document.getElementById('appPreviewFrame');
            const nameEl = document.getElementById('appPreviewName');
            const iconEl = document.getElementById('appPreviewIcon');
            const addBtn = document.getElementById('appPreviewAddBtn');

            if (!overlay || !frame) return;

            currentPreviewApp = appKey;

            // Get app info
            const app = appKey ? SUITE_APPS[appKey] : null;

            // Set app name
            nameEl.textContent = appName || app?.name || 'App';

            // Set app icon
            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else {
                iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>`;
                iconEl.style.background = 'var(--bg-card)';
            }

            // Reset add button state
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            if (appKey && savedApps.includes(appKey)) {
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');
            } else {
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Add to Profile`;
                addBtn.classList.remove('added');
            }

            // Build URL with auth token for cross-domain apps
            let finalUrl = appUrl;
            if (appUrl.startsWith('http') && supabaseClient) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.access_token) {
                        const url = new URL(appUrl);
                        url.searchParams.set('suite_token', session.access_token);
                        url.searchParams.set('suite_refresh', session.refresh_token);
                        finalUrl = url.toString();
                    }
                } catch (e) {
                    console.log('Could not get session for app:', e);
                }
            }

            // Load the app in iframe
            frame.src = finalUrl;

            // Show overlay
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAppPreview() {
            const overlay = document.getElementById('appPreviewOverlay');
            const frame = document.getElementById('appPreviewFrame');

            if (overlay) {
                overlay.classList.remove('active');
            }

            // Clear iframe after animation
            setTimeout(() => {
                if (frame) frame.src = '';
            }, 300);

            document.body.style.overflow = '';
            currentPreviewApp = null;
        }

        function addAppToProfile() {
            if (!currentPreviewApp) return;

            const addBtn = document.getElementById('appPreviewAddBtn');
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            if (!savedApps.includes(currentPreviewApp)) {
                savedApps.push(currentPreviewApp);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));

                // Update button
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');

                // Show toast
                showToast(`${SUITE_APPS[currentPreviewApp]?.name || 'App'} added to your profile!`);
            }
        }

        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.app-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'app-toast';
            toast.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
                ${message}
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('visible'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Apps button click handler - open in-page apps panel
        document.addEventListener('DOMContentLoaded', () => {
            const appsBtn = document.getElementById('appsBtn');
            if (appsBtn) {
                appsBtn.addEventListener('click', openAppsPanel);
            }

            // Check if we should open Factory based on URL
            checkInitialRoute();

            // Initialize sidebar apps
            renderSidebarApps();
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close app preview first (highest priority)
                const appPreview = document.getElementById('appPreviewOverlay');
                if (appPreview && appPreview.classList.contains('active')) {
                    closeAppPreview();
                    return;
                }
                const overlay = document.getElementById('appsPanelOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeAppsPanel();
                }
                const upgradeOverlay = document.getElementById('upgradeModalOverlay');
                if (upgradeOverlay && upgradeOverlay.classList.contains('active')) {
                    closeUpgradeModal();
                }
                closeProfileDropdown();
            }
        });

        // ========================
        // TOOLS & ATTACHMENTS
        // ========================
        function toggleToolsDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('toolsDropdown');
            dropdown.classList.toggle('active');
        }

        function closeToolsDropdown() {
            const dropdown = document.getElementById('toolsDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        function selectTool(tool) {
            closeToolsDropdown();
            const toolNames = {
                'web-search': 'Web Search',
                'image-gen': 'Image Generation',
                'code': 'Code Interpreter',
                'voice': 'Voice Mode'
            };
            // TODO: Enable the selected tool for the next message
            console.log('Selected tool:', tool);

            // For Pro features, show upgrade modal
            if (tool === 'image-gen' || tool === 'voice') {
                const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));
                if (isLoggedIn) {
                    openUpgradeModal();
                } else {
                    openConnectModal();
                }
                return;
            }

            // Add tool indicator to chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = `Using ${toolNames[tool]}... Type your message`;
            chatInput.focus();
        }

        // Attach button
        document.addEventListener('DOMContentLoaded', () => {
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const toolsBtn = document.getElementById('toolsBtn');

            if (attachBtn && fileInput) {
                attachBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    fileInput.click();
                });

                fileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        // TODO: Handle file upload
                        console.log('Files selected:', files);
                        alert(`Selected ${files.length} file(s). File upload coming soon!`);
                        fileInput.value = ''; // Reset
                    }
                });
            }

            if (toolsBtn) {
                toolsBtn.addEventListener('click', toggleToolsDropdown);
            }
        });

        // Close tools dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const toolsBtn = document.getElementById('toolsBtn');
            const toolsDropdown = document.getElementById('toolsDropdown');
            if (toolsBtn && toolsDropdown && !toolsBtn.contains(e.target)) {
                closeToolsDropdown();
            }
        });

        // ========================
        // MODEL SELECTOR
        // ========================
        let currentModel = 'claude';

        function toggleModelDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('modelDropdown');
            dropdown.classList.toggle('active');
        }

        function closeModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        function selectModel(modelId, modelName, iconUrl) {
            currentModel = modelId;

            // Update the selector display
            const nameEl = document.getElementById('modelName');
            const iconEl = document.getElementById('modelIcon');

            if (nameEl) nameEl.textContent = modelName;
            if (iconEl) {
                iconEl.src = iconUrl;
                iconEl.style.display = '';
            }

            // Update active state in dropdown
            const items = document.querySelectorAll('.model-dropdown-item');
            items.forEach(item => item.classList.remove('active'));
            event.target.closest('.model-dropdown-item').classList.add('active');

            closeModelDropdown();

            // Check if Pro model requires upgrade
            if (modelId === 'claude-opus') {
                const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));
                if (!isLoggedIn) {
                    openConnectModal();
                    return;
                }
                // TODO: Check if user has Pro subscription
            }

            console.log('Selected model:', modelId);
        }

        // Close model dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('modelSelector');
            if (selector && !selector.contains(e.target)) {
                closeModelDropdown();
            }
        });

        // ========================
        // PROFILE DROPDOWN
        // ========================
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('active');
            // Reset to main view when closing
            showMainView();
        }

        function showMainView() {
            document.getElementById('profileMainView').style.display = 'block';
            document.getElementById('profileSettingsView').style.display = 'none';
            const aiView = document.getElementById('profileAIDashboardView');
            if (aiView) aiView.style.display = 'none';
        }

        function showSettingsView() {
            document.getElementById('profileMainView').style.display = 'none';
            document.getElementById('profileSettingsView').style.display = 'block';
            const aiView = document.getElementById('profileAIDashboardView');
            if (aiView) aiView.style.display = 'none';
        }

        // AI Notifications Settings functions
        let aiSettingsCache = null;

        function showAIDashboardView() {
            document.getElementById('profileMainView').style.display = 'none';
            document.getElementById('profileSettingsView').style.display = 'none';
            document.getElementById('profileAIDashboardView').style.display = 'block';

            // Load current settings
            loadAISettings();
        }

        async function loadAISettings() {
            const cloudSyncToggle = document.getElementById('aiSettingCloudSync');
            const insightsToggle = document.getElementById('aiSettingInsights');
            const notificationsSelect = document.getElementById('aiSettingNotifications');
            const appsSection = document.getElementById('aiAppsSection');

            // Check if user is logged in
            if (!currentUser) {
                cloudSyncToggle.disabled = true;
                insightsToggle.disabled = true;
                notificationsSelect.disabled = true;
                return;
            }

            cloudSyncToggle.disabled = false;
            insightsToggle.disabled = false;
            notificationsSelect.disabled = false;

            try {
                const { data, error } = await supabase
                    .from('user_ai_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    aiSettingsCache = data;
                    cloudSyncToggle.checked = data.data_sync_enabled || false;
                    insightsToggle.checked = data.ai_insights_enabled || false;
                    notificationsSelect.value = data.notification_frequency || 'never';

                    // Show apps section if insights enabled
                    if (data.ai_insights_enabled) {
                        appsSection.style.display = 'block';
                        renderAppsCheckboxes(data.apps_included || []);
                    }
                }
            } catch (e) {
                console.warn('Could not load AI settings:', e.message);
            }
        }

        async function toggleAISetting(setting, value) {
            if (!currentUser) {
                showToast('Please sign in to enable this feature');
                return;
            }

            try {
                // Upsert the setting
                const updateData = { [setting]: value };
                updateData.user_id = currentUser.id;
                updateData.updated_at = new Date().toISOString();

                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert(updateData, { onConflict: 'user_id' });

                if (error) throw error;

                // Update cache
                if (aiSettingsCache) {
                    aiSettingsCache[setting] = value;
                }

                // Show/hide apps section when insights toggled
                if (setting === 'ai_insights_enabled') {
                    const appsSection = document.getElementById('aiAppsSection');
                    if (value) {
                        appsSection.style.display = 'block';
                        renderAppsCheckboxes(aiSettingsCache?.apps_included || []);
                    } else {
                        appsSection.style.display = 'none';
                    }
                }

                showToast(value ? 'Setting enabled' : 'Setting disabled');
            } catch (e) {
                console.error('Failed to update setting:', e);
                showToast('Failed to update setting');
            }
        }

        async function updateNotificationFrequency(value) {
            if (!currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert({
                        user_id: currentUser.id,
                        notification_frequency: value,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;
                showToast(`Notifications set to ${value}`);
            } catch (e) {
                console.error('Failed to update notification frequency:', e);
            }
        }

        function renderAppsCheckboxes(includedApps) {
            const container = document.getElementById('aiAppsCheckboxes');
            if (!container) return;

            // Apps that support data sync
            const syncableApps = ['hydrotrack', 'moodlog', 'sleepwell', 'foodvitals'];

            container.innerHTML = '';

            syncableApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const isChecked = includedApps.includes(appKey);
                const checkbox = document.createElement('label');
                checkbox.className = 'ai-apps-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleAppAccess('${appKey}', this.checked)">
                    <span>${app.name}</span>
                `;
                container.appendChild(checkbox);
            });
        }

        async function toggleAppAccess(appKey, include) {
            if (!currentUser || !aiSettingsCache) return;

            let apps = aiSettingsCache.apps_included || [];

            if (include && !apps.includes(appKey)) {
                apps.push(appKey);
            } else if (!include) {
                apps = apps.filter(a => a !== appKey);
            }

            try {
                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert({
                        user_id: currentUser.id,
                        apps_included: apps,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;

                aiSettingsCache.apps_included = apps;
            } catch (e) {
                console.error('Failed to update app access:', e);
            }
        }

        // Learn View functions
        function openLearnView() {
            // Close the dropdown
            closeProfileDropdown();

            // Get elements
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const learnView = document.getElementById('learnView');
            const docsView = document.getElementById('docsView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (docsView) docsView.classList.remove('active');

            // Show learn view
            if (learnView) learnView.classList.add('active');

            // Scroll to top
            if (chatArea) chatArea.scrollTop = 0;
        }

        function closeLearnView() {
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');

            // Hide learn view
            if (learnView) learnView.classList.remove('active');

            // Show welcome state
            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';

            // Also hide article reader if open
            hideArticle();
        }

        // Docs View functions
        function openDocsView() {
            // Close the dropdown
            closeProfileDropdown();

            // Get elements
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const learnView = document.getElementById('learnView');
            const docsView = document.getElementById('docsView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');

            // Show docs view
            if (docsView) docsView.classList.add('active');

            // Scroll to top
            if (chatArea) chatArea.scrollTop = 0;
        }

        function closeDocsView() {
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const docsView = document.getElementById('docsView');

            // Hide docs view
            if (docsView) docsView.classList.remove('active');

            // Show welcome state
            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
        }

        // Article content database
        const articleContent = {
            'fitness': `
                <h1>5 Best Free AI Fitness Apps (2026)</h1>
                <div class="article-meta-info">
                    <span>January 26, 2026</span>
                    <span>5 min read</span>
                </div>

                <div class="article-highlight">
                    <p>Looking for AI fitness apps that actually work  and don't charge you $15/month? We built them. Here are the 5 best free AI fitness apps on SUITE, no ads, no subscriptions, no catch.</p>
                </div>

                <p>The fitness app market is crowded with subscription-heavy apps that promise the world but charge monthly fees that add up fast. At SUITE, we believe everyone deserves access to AI-powered health tools  which is why every app here is completely free to use.</p>

                <h2>1. TrueForm AI  Posture & Movement Analysis</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/trueform-icon.jpg" class="app-icon-img" alt="TrueForm AI"> TrueForm AI</h3>
                    <p>Fix your form, prevent injuries, and move better with real-time AI feedback. TrueForm analyzes your posture and movement patterns, providing personalized exercises to correct imbalances.</p>
                    <ul>
                        <li>Real-time posture analysis</li>
                        <li>Personalized corrective exercises</li>
                        <li>Injury prevention insights</li>
                    </ul>
                </div>

                <h2>2. OpticRep  AI Rep Counter</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/opticrep-icon.jpg" class="app-icon-img" alt="OpticRep"> OpticRep</h3>
                    <p>Count your workout reps automatically with AI. OpticRep uses your camera to track exercises and count reps in real-time  no manual counting, no losing track mid-set.</p>
                    <ul>
                        <li>Automatic rep counting via camera</li>
                        <li>Multiple exercise recognition</li>
                        <li>Workout history tracking</li>
                    </ul>
                </div>

                <h2>3. FoodVitals  Smart Nutrition Tracking</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/foodvitals-icon.jpg" class="app-icon-img" alt="FoodVitals"> FoodVitals</h3>
                    <p>Track your nutrition the smart way with AI. Snap a photo of your meal and FoodVitals identifies ingredients, estimates portions, and logs your macros automatically.</p>
                    <ul>
                        <li>AI-powered food recognition</li>
                        <li>Automatic macro calculation</li>
                        <li>Personalized nutrition insights</li>
                    </ul>
                </div>

                <h2>4. HydroTrack  AI Water Tracking</h2>
                <div class="app-feature-card">
                    <h3>HydroTrack</h3>
                    <p>Stop guessing how much water you need. HydroTrack uses AI to calculate your optimal daily intake based on your weight, activity level, and climate. Get smart reminders throughout the day.</p>
                    <ul>
                        <li>Personalized hydration goals</li>
                        <li>Smart reminder scheduling</li>
                        <li>Progress tracking with streaks</li>
                    </ul>
                </div>

                <h2>5. SleepWell  AI Sleep Analysis</h2>
                <div class="app-feature-card">
                    <h3>SleepWell</h3>
                    <p>Track your sleep patterns and get AI-powered insights to improve your rest. SleepWell analyzes your habits and provides personalized recommendations for better sleep quality.</p>
                    <ul>
                        <li>Sleep quality scoring</li>
                        <li>Pattern analysis</li>
                        <li>Personalized sleep tips</li>
                    </ul>
                </div>

                <h2>Why These Apps Are Free</h2>
                <p>SUITE is a nonprofit platform. We believe AI tools should be accessible to everyone, not locked behind paywalls. Our apps are funded by optional yield deposits  users who deposit crypto earn yield, and a portion supports the platform. But you never have to pay to use the apps.</p>

                <div class="cta-section">
                    <h3>Ready to Level Up Your Fitness?</h3>
                    <p>Try any of these apps right now  just ask SuiteGPT to open them for you.</p>
                    <a href="#" class="cta-button" onclick="hideArticle(); closeLearnView(); return false;">Open SuiteGPT</a>
                </div>
            `,
            'ai-fleet': `
                <h1>The AI Fleet: Apps That Build Themselves</h1>
                <div class="article-meta-info">
                    <span>January 15, 2026</span>
                    <span>6 min read</span>
                </div>

                <div class="article-highlight">
                    <p>Every day, our AI builds a new app. Stake to keep it alive. Earn from its success. This is inside-out UBI.</p>
                </div>

                <h2>What is the AI Fleet?</h2>
                <p>The AI Fleet is SUITE's autonomous app factory. Every single day, our AI agents create a brand new app  designed, coded, and deployed without human intervention. These apps range from productivity tools to health trackers to creative utilities.</p>

                <p>But here's where it gets interesting: the apps don't just exist in a vacuum. They need community support to survive.</p>

                <h2>How It Works</h2>
                <p>When the AI creates an app, it enters a 7-day trial period. During this time, users can:</p>
                <ul>
                    <li><strong>Use the app</strong>  Try it out, see if it solves a real problem</li>
                    <li><strong>Stake on it</strong>  Commit credits to show you believe in the app</li>
                    <li><strong>Provide feedback</strong>  Help the AI improve future versions</li>
                </ul>

                <p>Apps that reach their stake threshold graduate to the permanent fleet. Apps that don't? They're retired, but the AI learns from what didn't work.</p>

                <h2>Earn From Success</h2>
                <p>When you stake on an app early and it succeeds, you earn a portion of the app's future revenue. It's like being an early investor, but with time instead of money. The more the app is used, the more everyone who believed in it earns.</p>

                <h2>Inside-Out UBI</h2>
                <p>Traditional UBI proposals give everyone money from a central fund. The AI Fleet does the opposite  it creates value from nothing (AI-generated apps), and distributes that value to everyone who participates.</p>

                <p>You don't need capital to earn. You need attention and good judgment. Find apps that will succeed, stake early, and earn.</p>

                <div class="cta-section">
                    <h3>Explore the Fleet</h3>
                    <p>See today's AI-generated apps and stake on your favorites.</p>
                    <a href="factory.html" class="cta-button">Visit the Factory</a>
                </div>
            `,
            'yield': `
                <h1>The Yield-Powered App: Free to Use, Paid by DeFi</h1>
                <div class="article-meta-info">
                    <span>January 13, 2026</span>
                    <span>5 min read</span>
                </div>

                <div class="article-highlight">
                    <p>How we killed the monthly subscription. Your deposit generates yield that pays for AI  forever.</p>
                </div>

                <h2>The Problem with Subscriptions</h2>
                <p>Every AI tool wants $20/month. ChatGPT, Notion AI, Grammarly, fitness apps  the subscriptions add up fast. For many people around the world, these costs are simply unaffordable.</p>

                <p>We asked ourselves: what if there was a way to make AI free without ads, without data selling, without compromises?</p>

                <h2>The Yield-Powered Model</h2>
                <p>Here's how it works:</p>
                <ol>
                    <li><strong>You deposit crypto</strong> into your SUITE vault</li>
                    <li><strong>Your deposit earns yield</strong> through DeFi protocols</li>
                    <li><strong>A portion of the yield</strong> pays for your AI usage</li>
                    <li><strong>You keep your deposit</strong>  it's always yours to withdraw</li>
                </ol>

                <p>Your money stays your money. The yield it generates pays for the service. It's like having a savings account that pays your bills.</p>

                <h2>Why This Works</h2>
                <p>DeFi yields typically range from 3-10% APY. Even a modest deposit can generate enough yield to cover extensive AI usage. And because the principal is never spent, you can use SUITE indefinitely.</p>

                <h2>No Deposit? No Problem</h2>
                <p>You can always use SUITE apps without any deposit. You get free credits just for signing up, and you can earn more through community activities. The vault is an option for power users who want unlimited usage.</p>

                <div class="cta-section">
                    <h3>Learn More About the Vault</h3>
                    <p>See how yield-powered apps can work for you.</p>
                    <a href="docs/vault.html" class="cta-button">Read the Docs</a>
                </div>
            `
        };

        function showArticle(articleId) {
            const articlesGrid = document.getElementById('learnArticlesGrid');
            const articleReader = document.getElementById('learnArticleReader');
            const articleContentEl = document.getElementById('learnArticleContent');
            const learnView = document.getElementById('learnView');

            if (!articleContent[articleId]) {
                console.error('Article not found:', articleId);
                return;
            }

            // Hide the articles grid
            if (articlesGrid) articlesGrid.style.display = 'none';

            // Show the article reader
            if (articleReader) articleReader.style.display = 'block';

            // Load the article content
            if (articleContentEl) articleContentEl.innerHTML = articleContent[articleId];

            // Scroll to top of learn view
            if (learnView) learnView.scrollTop = 0;
        }

        function hideArticle() {
            const articlesGrid = document.getElementById('learnArticlesGrid');
            const articleReader = document.getElementById('learnArticleReader');
            const articleContentEl = document.getElementById('learnArticleContent');
            const learnView = document.getElementById('learnView');

            // Show the articles grid
            if (articlesGrid) articlesGrid.style.display = '';

            // Hide the article reader
            if (articleReader) articleReader.style.display = 'none';

            // Clear the content
            if (articleContentEl) articleContentEl.innerHTML = '';

            // Scroll to top
            if (learnView) learnView.scrollTop = 0;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const profile = document.getElementById('sidebarProfile');
            const dropdown = document.getElementById('profileDropdown');
            if (profile && dropdown && !profile.contains(e.target) && !dropdown.contains(e.target)) {
                closeProfileDropdown();
            }
        });

        function openSettings() {
            closeProfileDropdown();
            // TODO: Open settings panel
            alert('Settings coming soon!');
        }

        async function logout() {
            closeProfileDropdown();

            // Clear localStorage auth
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('walletAddress');
            localStorage.removeItem('suiteWalletAddress');
            localStorage.removeItem('suiteWallet');
            localStorage.removeItem('telegram_user');

            // Sign out of Supabase (Google/Email)
            if (supabaseClient) {
                try {
                    await supabaseClient.auth.signOut();
                } catch (err) {
                    console.error('Supabase signout error:', err);
                }
            }

            await checkAuthState();
            location.reload();
        }

        // ========================
        // ADD TO HOME SCREEN (PWA)
        // ========================
        let deferredPrompt = null;

        // Check if running as PWA or dismissed
        function checkAddToHomeVisibility() {
            const btn = document.getElementById('addToHomeBtn');
            if (!btn) return;

            // Hide if already running as PWA
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                || window.navigator.standalone === true;

            // Hide if user dismissed it
            const dismissed = localStorage.getItem('addToHomeDismissed');

            // Hide if already installed (no prompt available and not iOS)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isStandalone || dismissed) {
                btn.classList.remove('visible');
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
                btn.classList.add('visible');
            }
        }

        // Capture the install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            checkAddToHomeVisibility();
        });

        // Handle add to home click
        function handleAddToHome() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isIOS) {
                // Show iOS instructions
                alert('To add SuiteGPT to your home screen:\n\n1. Tap the Share button (square with arrow)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
                return;
            }

            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        const btn = document.getElementById('addToHomeBtn');
                        if (btn) btn.classList.add('hidden');
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback for browsers that don't support beforeinstallprompt
                alert('To add SuiteGPT to your home screen, use your browser\'s menu and look for "Add to Home Screen" or "Install App" option.');
            }
        }

        // Dismiss the button
        function dismissAddToHome() {
            localStorage.setItem('addToHomeDismissed', 'true');
            const btn = document.getElementById('addToHomeBtn');
            if (btn) {
                btn.classList.remove('visible');
                btn.classList.add('hidden');
            }
        }

        // Listen for app installed
        window.addEventListener('appinstalled', () => {
            console.log('SuiteGPT was installed');
            const btn = document.getElementById('addToHomeBtn');
            if (btn) btn.classList.add('hidden');
            deferredPrompt = null;
        });

        // Check visibility on load
        document.addEventListener('DOMContentLoaded', checkAddToHomeVisibility);

        // ========================
        // UPGRADE MODAL
        // ========================
        function openUpgradeModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('upgradeModalOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeUpgradeModal() {
            const overlay = document.getElementById('upgradeModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchUpgradeTab(tab) {
            const tabs = document.querySelectorAll('.upgrade-tab');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const creditsSection = document.getElementById('creditsSection');

            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'subscription') {
                subscriptionSection.classList.add('active');
                creditsSection.classList.remove('active');
            } else {
                subscriptionSection.classList.remove('active');
                creditsSection.classList.add('active');
            }
        }

        function selectPlan(plan) {
            closeUpgradeModal();
            // TODO: Integrate with payment provider (Stripe, etc.)
            alert(`Selected ${plan} plan! Payment integration coming soon.`);
        }

        function selectCreditPack(credits) {
            closeUpgradeModal();
            // TODO: Integrate with payment provider
            alert(`Selected ${credits} credits! Payment integration coming soon.`);
        }

        // ========================
        // CREDITS MODAL
        // ========================
        function openCreditsModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('creditsModalOverlay');
            const amountEl = document.getElementById('creditsModalAmount');

            // Update modal with current credits
            if (amountEl) {
                amountEl.textContent = userCredits.toLocaleString();
            }

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCreditsModal() {
            const overlay = document.getElementById('creditsModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            // Reset expanded state when closing
            const bonusSection = document.getElementById('bonusCreditsSection');
            if (bonusSection) bonusSection.classList.remove('expanded');
        }

        function toggleBonusExplanation() {
            const bonusSection = document.getElementById('bonusCreditsSection');
            if (bonusSection) {
                bonusSection.classList.toggle('expanded');
            }
        }

        // ========================
        // SETTINGS MODAL
        // ========================
        function openSettingsModal() {
            const overlay = document.getElementById('settingsModalOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSettingsModal() {
            const overlay = document.getElementById('settingsModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchSettingsPanel(panelId) {
            // Update nav items
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.panel === panelId);
            });

            // Update panels
            const panelMap = {
                'docs': { id: 'settingsPanelDocs', title: 'Documentation' },
                'learn': { id: 'settingsPanelLearn', title: 'Learn' },
                'community': { id: 'settingsPanelCommunity', title: 'Community Chat' },
                'factory': { id: 'settingsPanelFactory', title: 'Factory (Governance)' },
                'import': { id: 'settingsPanelImport', title: 'Import History' }
            };

            // Hide all panels
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Show selected panel
            const panelInfo = panelMap[panelId];
            if (panelInfo) {
                const panel = document.getElementById(panelInfo.id);
                if (panel) panel.classList.add('active');

                const title = document.getElementById('settingsPanelTitle');
                if (title) title.textContent = panelInfo.title;
            }
        }

        function triggerHistoryImport() {
            // Use existing import modal
            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.classList.add('active');
                if (typeof resetImportModal === 'function') {
                    resetImportModal();
                }
            }
        }

        // ========================
        // WITHDRAWAL MODAL
        // ========================
        function openWithdrawalModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('withdrawalModalOverlay');
            const amountInput = document.getElementById('withdrawalAmount');

            // Update modal with current credits
            updateCreditsDisplay(userCredits);

            // Clear previous input
            if (amountInput) amountInput.value = '';

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeWithdrawalModal() {
            const overlay = document.getElementById('withdrawalModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function setMaxWithdrawal() {
            const amountInput = document.getElementById('withdrawalAmount');
            if (amountInput) {
                amountInput.value = userCredits;
            }
        }

        async function submitWithdrawal() {
            const amountInput = document.getElementById('withdrawalAmount');
            const confirmBtn = document.getElementById('withdrawalConfirmBtn');
            const amount = parseInt(amountInput?.value) || 0;

            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (amount > userCredits) {
                alert('Amount exceeds your available credits');
                return;
            }

            // Get user info
            const wallet = localStorage.getItem('connectedWallet') ||
                          localStorage.getItem('walletAddress') ||
                          localStorage.getItem('suiteWalletAddress') ||
                          localStorage.getItem('suiteWallet');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {
                    console.error('Failed to parse telegram_user:', e);
                }
            }

            if (!wallet && !telegramUser) {
                alert('Please log in to request a withdrawal');
                return;
            }

            // Disable button while processing
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Processing...';
            }

            try {
                // Create withdrawal request in Supabase
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/withdrawal_requests`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            user_id: telegramUser?.id || wallet,
                            auth_type: telegramUser ? 'telegram' : 'wallet',
                            amount: amount,
                            usd_value: amount / 1000,
                            status: 'pending',
                            requested_at: new Date().toISOString()
                        })
                    }
                );

                if (response.ok) {
                    closeWithdrawalModal();
                    alert(`Withdrawal request for ${amount.toLocaleString()} credits (~$${(amount / 1000).toFixed(2)}) submitted successfully! You'll be notified when funds are available.`);
                } else {
                    throw new Error('Failed to submit withdrawal request');
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                alert('Failed to submit withdrawal request. Please try again later.');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirm Withdrawal Request';
                }
            }
        }

        // Initialize Supabase client for Auth (config declared at top of script)
        if (window.supabase) {
            // Use minimal config - let Supabase handle defaults
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('[Auth] Supabase client created (default config)');

            // Check for OAuth callback in URL (code parameter)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                console.log('[Auth] OAuth code detected in URL, exchanging...');
            }

            // Listen for auth state changes (handles OAuth redirect)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('[Auth] Supabase event:', event, session ? `has session: ${session.user?.email}` : 'no session');

                if (session) {
                    console.log('[Auth] User authenticated:', session.user?.email);
                    // Close modal if open
                    const modal = document.getElementById('connectModalOverlay');
                    if (modal && modal.classList.contains('active')) {
                        closeConnectModal();
                    }

                    // Auto-link: If user has wallet, link this email to it
                    const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (wallet && session.user?.email) {
                        await autoLinkEmailToWallet(wallet, session.user.email, session.user.id);
                    }

                    // Always update auth state when we have a session
                    checkAuthState();
                    renderLinkedAccounts();
                } else if (event === 'SIGNED_OUT') {
                    // Only reset if no other auth methods
                    const hasTelegram = localStorage.getItem('telegram_user');
                    const hasWallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (!hasTelegram && !hasWallet) {
                        checkAuthState();
                    }
                }
            });

            // Check session on page load (handles OAuth redirect)
            supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                if (error) {
                    console.error('[Auth] Session check error:', error);
                }
                console.log('[Auth] Explicit session check:', session ? session.user?.email : 'no session');
                // Always call checkAuthState after Supabase is ready
                checkAuthState();
                renderLinkedAccounts();
            });
        } else {
            console.error('[Auth] Supabase library not loaded!');
            // Still check auth state for wallet/telegram users
            checkAuthState();
        }

        // DOM Elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeState = document.getElementById('welcomeState');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const useCasesGrid = document.getElementById('useCasesGrid');
        const useCasesSection = document.getElementById('useCasesSection');
        const useCaseCount = document.getElementById('useCaseCount');

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const chatHistoryBtn = document.getElementById('chatHistoryBtn');

        // State
        let isLoading = false;
        let conversationHistory = [];
        let useCases = [];
        let currentIntent = 'all';
        // userCredits is declared earlier near updateCreditsDisplay

        // Mobile sidebar toggle
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });
        }

        if (chatHistoryBtn) {
            chatHistoryBtn.addEventListener('click', () => {
                alert('Chat History feature coming soon!');
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Load use cases - show hardcoded immediately, update from Supabase if available
        async function loadUseCases() {
            // Show hardcoded data immediately so users don't wait
            useCases = getHardcodedUseCases();
            renderUseCases();

            // Then try to fetch from Supabase with a timeout
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/use_cases?is_visible=eq.true&order=helpful_count.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        signal: controller.signal
                    }
                );

                clearTimeout(timeoutId);

                if (response.ok) {
                    const supabaseUseCases = await response.json();
                    if (supabaseUseCases && supabaseUseCases.length > 0) {
                        useCases = supabaseUseCases;
                        renderUseCases();
                    }
                }
            } catch (error) {
                // Silently fail - we already have hardcoded data showing
                console.log('Using hardcoded use cases (Supabase unavailable)');
            }
        }

        // Hardcoded fallback
        function getHardcodedUseCases() {
            return [
                // Original use cases
                { query: "I can't focus at work anymore", response: "FocusFlow uses the Pomodoro technique to help you concentrate in focused sprints.", recommended_app: "focusflow", intent: "problems", helpful_count: 58 },
                { query: "I have back pain from sitting all day", response: "StretchTimer reminds you to take breaks and suggests desk stretches.", recommended_app: "stretchtimer", intent: "problems", helpful_count: 56 },
                { query: "I want to become financially free", response: "Start by tracking where your money goes with QuickBudget.", recommended_app: "quickbudget", intent: "desires", helpful_count: 89 },
                { query: "I want to get healthier without obsessing", response: "FoodVitals takes a gentle approach - weekly reflections instead of daily tracking.", recommended_app: "foodvitals", intent: "desires", helpful_count: 67 },
                { query: "Show me what apps you have for fitness", response: "We've got OpticRep (AI workout trainer), StepGoal (walking), and TrueForm AI (physio).", recommended_app: "opticrep", intent: "find", helpful_count: 61 },
                { query: "How can I make money building apps?", response: "With SUITE, you build apps and earn from every user through our credit system.", recommended_app: null, intent: "build", helpful_count: 94 },
                // Health & Wellness
                { query: "I never drink enough water", response: "HydroTrack makes it easy - just tap to log each glass and watch your progress.", recommended_app: "hydrotrack", intent: "problems", helpful_count: 72 },
                { query: "I can't sleep well at night", response: "SleepWell helps you track sleep patterns and find what works for you.", recommended_app: "sleepwell", intent: "problems", helpful_count: 68 },
                { query: "I feel anxious all the time", response: "MoodLog helps you track emotions and spot patterns. BreathEasy has calming exercises.", recommended_app: "moodlog", intent: "problems", helpful_count: 81 },
                { query: "I keep forgetting my vitamins", response: "PillPal tracks all your medications and helps you never miss a dose.", recommended_app: "pillpal", intent: "problems", helpful_count: 65 },
                { query: "I need to calm down right now", response: "BreathEasy has guided 4-7-8 and box breathing exercises to help you relax.", recommended_app: "breatheasy", intent: "problems", helpful_count: 77 },
                { query: "I want to walk more", response: "StepGoal lets you set daily targets and track your progress over time.", recommended_app: "stepgoal", intent: "desires", helpful_count: 59 },
                // Productivity & Learning
                { query: "I procrastinate too much", response: "FocusFlow's Pomodoro timer helps you work in focused bursts with built-in breaks.", recommended_app: "focusflow", intent: "problems", helpful_count: 84 },
                { query: "Where does all my money go?", response: "QuickBudget tracks your expenses by category so you can see exactly where it goes.", recommended_app: "quickbudget", intent: "problems", helpful_count: 79 },
                { query: "I need to study for an exam", response: "FlashMind creates flashcards with spaced repetition to help you memorize.", recommended_app: "flashmind", intent: "problems", helpful_count: 71 },
                { query: "I want to read more books", response: "BookShelf tracks your reading list, progress, and helps you hit your goals.", recommended_app: "bookshelf", intent: "desires", helpful_count: 63 },
                { query: "I want to learn a new skill", response: "SkillTree breaks skills into milestones and tracks your progress visually.", recommended_app: "skilltree", intent: "desires", helpful_count: 66 },
                { query: "I never know what to cook", response: "MealPrep helps you plan your whole week and generates a shopping list.", recommended_app: "mealprep", intent: "problems", helpful_count: 74 },
                { query: "My house is always messy", response: "CleanHome creates a cleaning schedule so you know exactly what to do when.", recommended_app: "cleanhome", intent: "problems", helpful_count: 62 },
                // Lifestyle & Social
                { query: "I need date night ideas", response: "DateNight has tons of ideas - romantic, budget-friendly, adventurous, or at-home.", recommended_app: "datenight", intent: "desires", helpful_count: 69 },
                { query: "I need to track my pet's vet visits", response: "PetCare keeps track of all your pet's health info, feeding, and appointments.", recommended_app: "petcare", intent: "problems", helpful_count: 57 },
                { query: "I always forget things when traveling", response: "PackLight generates packing lists based on your trip type and duration.", recommended_app: "packlight", intent: "problems", helpful_count: 73 },
                { query: "I never know what gift to buy", response: "GiftGuru helps you track gift ideas for everyone and never forget a birthday.", recommended_app: "giftguru", intent: "problems", helpful_count: 64 },
                { query: "I want to build better habits", response: "HabitStack lets you chain habits together and track your streaks.", recommended_app: "habitstack", intent: "desires", helpful_count: 82 },
                { query: "I can't decide between options", response: "QuickDecide has a random picker, coin flip, and pro/con lists to help you choose.", recommended_app: "quickdecide", intent: "problems", helpful_count: 55 }
            ];
        }

        // Render use cases
        function renderUseCases() {
            if (!useCasesGrid) return;

            const filtered = currentIntent === 'all'
                ? useCases
                : useCases.filter(uc => uc.intent === currentIntent);

            if (useCaseCount) useCaseCount.textContent = `(${filtered.length})`;

            const intentStyles = {
                'problems': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>', label: 'Problem', class: 'problem' },
                'desires': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>', label: 'Desire', class: 'desire' },
                'ideas': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', label: 'Idea', class: 'idea' },
                'find': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>', label: 'Find', class: 'find' },
                'change': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>', label: 'Change', class: 'change' },
                'build': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>', label: 'Build', class: 'build' }
            };

            useCasesGrid.innerHTML = filtered.map(uc => {
                const app = SUITE_APPS[uc.recommended_app] || {};
                const intentInfo = intentStyles[uc.intent] || intentStyles['find'];

                return `
                    <div class="use-case-card" data-query="${encodeURIComponent(uc.query)}" data-response="${encodeURIComponent(uc.response)}" data-app="${uc.recommended_app || ''}">
                        <span class="intent-badge ${intentInfo.class}">
                            <span>${intentInfo.icon}</span>
                            <span>${intentInfo.label}</span>
                        </span>
                        <div class="use-case-query">"${uc.query}"</div>
                        <div class="use-case-meta">
                            <div class="use-case-app">
                                ${uc.recommended_app ? `
                                    <div class="use-case-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                                    <span class="use-case-app-name">${app.name || 'Custom App'}</span>
                                ` : `
                                    <div class="use-case-app-icon" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                                    <span class="use-case-app-name">Custom / Build & Earn</span>
                                `}
                            </div>
                            <div class="use-case-helpful">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                                ${uc.helpful_count || 0}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers - each click starts a fresh chat
            document.querySelectorAll('.use-case-card').forEach(card => {
                card.addEventListener('click', () => {
                    const query = decodeURIComponent(card.dataset.query);
                    const response = decodeURIComponent(card.dataset.response);
                    const app = card.dataset.app;

                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    welcomeState.classList.add('chat-active');
                    chatContainer.classList.add('active');
                    addMessage(query, 'user');
                    addMessage(response, 'assistant', app);
                    conversationHistory.push({ role: 'user', content: query });
                    conversationHistory.push({ role: 'assistant', content: response });
                });
            });
        }

        // Enable/disable send button
        chatInput.addEventListener('input', () => {
            sendBtn.disabled = !chatInput.value.trim() || isLoading;
        });

        // Send on Enter
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // Quick suggestion chips - each click starts a fresh chat
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const query = chip.dataset.query;
                if (query) {
                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    chatInput.value = query;
                    sendMessage();
                }
            });
        });

        // Add message to chat
        function addMessage(content, role, appRecommendation = null, userQuery = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = role === 'user'
                ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>'
                : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = content.replace(/\n/g, '<br>');

            if (appRecommendation && SUITE_APPS[appRecommendation]) {
                const app = SUITE_APPS[appRecommendation];
                const appCard = document.createElement('div');
                appCard.className = 'app-card-inline';
                appCard.style.cursor = 'pointer';
                appCard.onclick = () => previewApp(appRecommendation, app.url, app.name);
                appCard.innerHTML = `
                    <div class="app-icon-inline" style="background: ${app.iconBg}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                    <div class="app-info-inline">
                        <h4>${app.name}</h4>
                        <p>${app.description}</p>
                    </div>
                    <span class="app-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                `;
                contentDiv.appendChild(appCard);

                const quickActionsDiv = document.createElement('div');
                quickActionsDiv.className = 'quick-actions';
                quickActionsDiv.innerHTML = `
                    <button class="quick-action-btn" data-action="use-case" data-app="${appRecommendation}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
                        How does this help?
                    </button>
                    <button class="quick-action-btn primary" data-action="open" data-app="${appRecommendation}" data-url="${app.url}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                        Open ${app.name}
                    </button>
                `;
                contentDiv.appendChild(quickActionsDiv);

                quickActionsDiv.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleQuickAction(btn.dataset.action, btn.dataset.app, btn.dataset.url, userQuery));
                });
            }

            if (role === 'assistant' && !appRecommendation) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons';
                feedbackDiv.innerHTML = `
                    <button class="feedback-btn" data-feedback="good"> Helpful</button>
                    <button class="feedback-btn" data-feedback="bad"> Not helpful</button>
                `;
                contentDiv.appendChild(feedbackDiv);

                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        feedbackDiv.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('active-good', 'active-bad'));
                        btn.classList.add(btn.dataset.feedback === 'good' ? 'active-good' : 'active-bad');
                    });
                });
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Handle quick action button clicks
        function handleQuickAction(action, appId, url, originalQuery) {
            const app = SUITE_APPS[appId];
            if (!app) return;

            switch (action) {
                case 'use-case':
                    const useCaseQuery = `Tell me specifically how ${app.name} can help with my situation`;
                    addMessage(useCaseQuery, 'user');
                    conversationHistory.push({ role: 'user', content: useCaseQuery });
                    addTypingIndicator();

                    setTimeout(() => {
                        removeTypingIndicator();
                        const response = getUseCaseResponse(app, originalQuery);
                        addMessage(response, 'assistant');
                        conversationHistory.push({ role: 'assistant', content: response });
                    }, 1200);
                    break;

                case 'open':
                    previewApp(appId, url, app.name);
                    break;
            }
        }

        function getUseCaseResponse(app, originalQuery) {
            const responses = {
                'foodvitals': `Here's how FoodVitals specifically helps you:\n\n1. **Weekly Check-ins, Not Daily Logging** - Less pressure, more sustainable.\n\n2. **AI-Powered Insights** - Personalized suggestions based on YOUR habits.\n\n3. **No Calorie Counting** - Focus on how food makes you feel.\n\nWant to try it?`,
                'trueform': `Here's how TrueForm AI specifically helps you:\n\n1. **AI Posture Assessment** - Use your camera to analyze your posture.\n\n2. **Personalized Stretching Routines** - Based on YOUR specific issues.\n\n3. **Form Correction in Real-Time** - The AI watches and corrects you.\n\nReady to start?`,
                'opticrep': `Here's how OpticRep specifically helps you:\n\n1. **AI Rep Counter** - Automatically counts your reps using your camera.\n\n2. **Form Analysis** - Real-time feedback on your exercise form.\n\n3. **Workout Programs** - AI-generated programs based on your goals.\n\nWant to start your first workout?`,
                'cheshbon': `Here's how Cheshbon specifically helps you:\n\n1. **Reflection, Not Restriction** - Weekly prompts about how you FEEL about spending.\n\n2. **Pattern Recognition** - Identifies emotional spending triggers.\n\n3. **Values Alignment** - See if your spending matches what you care about.\n\nReady to start?`,
                'remcast': `Here's how RemCast specifically helps you:\n\n1. **Smart Reminders** - Learns when you're most likely to act.\n\n2. **Gentle Habit Building** - No streaks or guilt.\n\n3. **Routine Builder** - Chain habits together.\n\nReady to build better habits?`,
                'defi-knowledge': `Here's how DeFi Knowledge specifically helps you:\n\n1. **Structured Learning Path** - From basics to advanced.\n\n2. **No Shill, Just Education** - We teach concepts, not promote protocols.\n\n3. **Interactive Simulations** - Practice without risking real money.\n\nReady to start learning?`,
                // Health & Wellness
                'hydrotrack': `Here's how HydroTrack specifically helps you:\n\n1. **Simple One-Tap Logging** - Just tap to add a glass of water.\n\n2. **Visual Progress** - See your daily progress with a satisfying progress ring.\n\n3. **Streak Tracking** - Build consistency with daily streaks.\n\nReady to stay hydrated?`,
                'sleepwell': `Here's how SleepWell specifically helps you:\n\n1. **Sleep Quality Tracking** - Log bedtime, wake time, and rate your rest.\n\n2. **Pattern Recognition** - See weekly averages and spot trends.\n\n3. **Personalized Tips** - Get suggestions based on your sleep patterns.\n\nReady to sleep better?`,
                'moodlog': `Here's how MoodLog specifically helps you:\n\n1. **Quick Mood Check-ins** - 5 simple moods to choose from.\n\n2. **Calendar View** - See your emotional patterns over time.\n\n3. **Optional Notes** - Add context when you need to.\n\nReady to understand your emotions better?`,
                'pillpal': `Here's how PillPal specifically helps you:\n\n1. **Medication Schedules** - Set up all your meds with their times.\n\n2. **Check-off System** - Mark when you've taken each dose.\n\n3. **Streak Tracking** - Stay consistent with visual progress.\n\nReady to never miss a dose?`,
                'breatheasy': `Here's how BreathEasy specifically helps you:\n\n1. **Guided Breathing** - 4-7-8 and box breathing animations.\n\n2. **Visual Guides** - Watch the circle expand and contract.\n\n3. **Session Options** - Choose 1-5 minute sessions.\n\nReady to feel calmer?`,
                'stepgoal': `Here's how StepGoal specifically helps you:\n\n1. **Daily Goal Setting** - Set your target steps.\n\n2. **Manual Entry** - Log steps easily without a fitness tracker.\n\n3. **Weekly Charts** - Track your progress over time.\n\nReady to move more?`,
                'stretchtimer': `Here's how StretchTimer specifically helps you:\n\n1. **Break Reminders** - Set intervals (30/45/60 min).\n\n2. **Stretch Suggestions** - Get quick stretches when the timer hits.\n\n3. **Daily Tracking** - See how many breaks you've taken.\n\nReady to take better care of yourself at work?`,
                // Productivity & Learning
                'focusflow': `Here's how FocusFlow specifically helps you:\n\n1. **Pomodoro Technique** - 25 min work, 5 min break by default.\n\n2. **Session Counter** - Track your focus sessions.\n\n3. **Customizable** - Adjust durations to fit your style.\n\nReady to focus better?`,
                'quickbudget': `Here's how QuickBudget specifically helps you:\n\n1. **Quick Expense Entry** - Amount, category, done.\n\n2. **Category Breakdown** - See where your money goes.\n\n3. **Budget Limits** - Set monthly limits and track against them.\n\nReady to take control of your spending?`,
                'flashmind': `Here's how FlashMind specifically helps you:\n\n1. **Create Decks** - Organize flashcards by topic.\n\n2. **Flip Animation** - Study with satisfying card flips.\n\n3. **Spaced Repetition** - Cards you struggle with appear more often.\n\nReady to study smarter?`,
                'bookshelf': `Here's how BookShelf specifically helps you:\n\n1. **Track Your Books** - Want to Read, Reading, Finished.\n\n2. **Page Progress** - See how far you are in each book.\n\n3. **Reading Stats** - Track books per month.\n\nReady to read more?`,
                'skilltree': `Here's how SkillTree specifically helps you:\n\n1. **Add Skills** - List what you want to learn.\n\n2. **Set Milestones** - Break skills into achievable steps.\n\n3. **Track Progress** - Visual progress bars keep you motivated.\n\nReady to level up your skills?`,
                'mealprep': `Here's how MealPrep specifically helps you:\n\n1. **Weekly Grid** - Plan breakfast, lunch, dinner for 7 days.\n\n2. **Favorite Meals** - Save meals you make often.\n\n3. **Shopping List** - Auto-generate from your meal plan.\n\nReady to simplify meal planning?`,
                'cleanhome': `Here's how CleanHome specifically helps you:\n\n1. **Add Rooms** - Set up areas to clean.\n\n2. **Set Frequency** - Daily, weekly, or monthly tasks.\n\n3. **Overdue Alerts** - See what needs attention.\n\nReady for a cleaner home?`,
                // Lifestyle & Social
                'datenight': `Here's how DateNight specifically helps you:\n\n1. **Random Ideas** - Get surprise date suggestions.\n\n2. **Categories** - Romantic, Adventure, Budget, Home.\n\n3. **History** - Track dates you've done together.\n\nReady for your next date?`,
                'petcare': `Here's how PetCare specifically helps you:\n\n1. **Pet Profiles** - Add all your pets with details.\n\n2. **Activity Logging** - Track feeding, walks, vet visits.\n\n3. **Reminders** - Never miss important pet care.\n\nReady to be a better pet parent?`,
                'packlight': `Here's how PackLight specifically helps you:\n\n1. **Trip Templates** - Beach, Business, Winter, Camping.\n\n2. **Auto-Generate Lists** - Based on trip type and duration.\n\n3. **Check Items Off** - Know exactly what's packed.\n\nReady for stress-free packing?`,
                'giftguru': `Here's how GiftGuru specifically helps you:\n\n1. **People Profiles** - Store interests, sizes, preferences.\n\n2. **Gift Ideas** - Track ideas for each person.\n\n3. **Status Tracking** - Bought, wrapped, given.\n\nReady to nail gift-giving?`,
                'habitstack': `Here's how HabitStack specifically helps you:\n\n1. **Chain Habits** - Link habits in sequence.\n\n2. **Streak Counter** - Don't break the chain!\n\n3. **Morning/Evening Routines** - Build powerful routines.\n\nReady to build lasting habits?`,
                'quickdecide': `Here's how QuickDecide specifically helps you:\n\n1. **Random Picker** - Add options and let fate decide.\n\n2. **Coin Flip** - Simple yes/no decisions.\n\n3. **Pro/Con Lists** - Think it through when needed.\n\nReady to stop overthinking?`
            };

            return responses[app.id] || `${app.name} is designed to help with exactly what you described. Let me know if you want to dive deeper!`;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isLoading) return;

            const userQuery = message;

            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            addTypingIndicator();

            try {
                // Check if this is a personal insight query
                if (isPersonalInsightQuery(message)) {
                    const insightResult = await getPersonalInsight(message);
                    removeTypingIndicator();

                    if (insightResult.success) {
                        let response = insightResult.message;
                        if (insightResult.appsAnalyzed?.length > 0) {
                            response += `\n\n*Based on data from: ${insightResult.appsAnalyzed.map(a => SUITE_APPS[a]?.name || a).join(', ')}*`;
                        }
                        addMessage(response, 'assistant', null, userQuery);
                        conversationHistory.push({ role: 'assistant', content: response });
                    } else {
                        addMessage(insightResult.message, 'assistant', null, userQuery);
                        conversationHistory.push({ role: 'assistant', content: insightResult.message });
                    }
                } else {
                    // Regular chat flow
                    const response = await fetch(`${SUPABASE_URL}/functions/v1/suitegpt-chat`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({
                            message: message,
                            history: conversationHistory.slice(-10)
                        })
                    });

                    removeTypingIndicator();

                    if (!response.ok) throw new Error('Failed');

                    const data = await response.json();
                    addMessage(data.response, 'assistant', data.recommendedApp, userQuery);
                    conversationHistory.push({ role: 'assistant', content: data.response });
                }

            } catch (error) {
                removeTypingIndicator();
                const fallback = getLocalResponse(message);
                addMessage(fallback.response, 'assistant', fallback.recommendedApp, userQuery);
                conversationHistory.push({ role: 'assistant', content: fallback.response });
            }

            isLoading = false;
            sendBtn.disabled = !chatInput.value.trim();
            chatInput.focus();
        }

        function getLocalResponse(message) {
            const keywords = {
                'foodvitals': ['nutrition', 'diet', 'calories', 'food', 'meals', 'weight', 'eating', 'healthy'],
                'trueform': ['back pain', 'posture', 'stretching', 'physical therapy', 'mobility', 'pain', 'sitting'],
                'opticrep': ['workout', 'gym', 'fitness', 'exercise', 'training', 'muscle', 'strength'],
                'cheshbon': ['money', 'finance', 'budget', 'spending', 'savings', 'financial'],
                'remcast': ['reminder', 'routine', 'morning', 'habits', 'schedule', 'notification'],
                'defi-knowledge': ['defi', 'crypto', 'blockchain', 'yield', 'trading'],
                // Health & Wellness
                'hydrotrack': ['water', 'hydration', 'thirsty', 'drink', 'dehydrated', 'glasses'],
                'sleepwell': ['sleep', 'insomnia', 'tired', 'rest', 'bedtime', 'wake up', 'fatigue'],
                'moodlog': ['mood', 'anxiety', 'stressed', 'mental health', 'depression', 'emotions', 'feelings'],
                'pillpal': ['medication', 'pills', 'vitamins', 'medicine', 'prescription', 'supplements'],
                'breatheasy': ['breathing', 'panic', 'calm', 'relax', 'meditation', 'stress relief', 'anxious'],
                'stepgoal': ['steps', 'walking', 'sedentary', 'move more', 'pedometer', '10000 steps'],
                'stretchtimer': ['desk', 'breaks', 'sitting too much', 'neck pain', 'computer', 'office'],
                // Productivity & Learning
                'focusflow': ['focus', 'concentrate', 'procrastinate', 'pomodoro', 'distracted', 'productivity'],
                'quickbudget': ['expenses', 'track spending', 'where my money', 'budget tracker', 'bills'],
                'flashmind': ['study', 'memorize', 'flashcards', 'exam', 'learn language', 'vocabulary'],
                'bookshelf': ['read', 'books', 'reading list', 'book tracker', 'library'],
                'skilltree': ['learn', 'skill', 'improve', 'progress', 'guitar', 'coding', 'new skill'],
                'mealprep': ['cook', 'meal plan', 'dinner ideas', 'recipe', 'what to eat', 'weekly meals'],
                'cleanhome': ['clean', 'messy', 'chores', 'housework', 'tidying', 'cleaning schedule'],
                // Lifestyle & Social
                'datenight': ['date', 'romantic', 'couple', 'date ideas', 'date night', 'anniversary'],
                'petcare': ['pet', 'dog', 'cat', 'vet', 'pet health', 'animal', 'feeding schedule'],
                'packlight': ['pack', 'travel', 'trip', 'packing list', 'vacation', 'luggage', 'forget'],
                'giftguru': ['gift', 'present', 'birthday', 'christmas', 'what to buy', 'gift ideas'],
                'habitstack': ['habit', 'routine', 'daily habit', 'streak', 'habit chain', 'build habits'],
                'quickdecide': ['decide', 'choice', 'flip coin', 'can\'t choose', 'which one', 'decision']
            };

            const lower = message.toLowerCase();
            let matchedApp = null;

            for (const [app, words] of Object.entries(keywords)) {
                if (words.some(w => lower.includes(w))) {
                    matchedApp = app;
                    break;
                }
            }

            if (matchedApp) {
                const appData = SUITE_APPS[matchedApp];
                return {
                    response: `${appData.name} is perfect for this!\n\n${appData.description}.`,
                    recommendedApp: matchedApp
                };
            }

            return {
                response: `We don't have an app for that yet, but we can build one!\n\nAI Fleet creates custom apps in 1-12 hours. Just describe:\n What problem you're solving\n Key features you need\n\nWant me to start a request?`,
                recommendedApp: null
            };
        }

        // Personal AI Insights Detection
        const PERSONAL_QUERY_PATTERNS = [
            /how('s| is| was) my (hydration|water|sleep|mood|health)/i,
            /analyze my (hydration|water|sleep|mood|health|patterns?)/i,
            /give me insights? (about|on) my/i,
            /what (do|does|did) my (data|apps?|tracking) (show|say|reveal)/i,
            /my (weekly|daily|monthly) (summary|report|stats)/i,
            /(summary|report|analysis) of my (health|wellness|data)/i,
            /how am i doing (with|on) my/i,
            /show me my (progress|trends|patterns)/i
        ];

        function isPersonalInsightQuery(message) {
            return PERSONAL_QUERY_PATTERNS.some(pattern => pattern.test(message));
        }

        async function getPersonalInsight(query) {
            if (!currentUser) {
                return {
                    success: false,
                    message: "To get personalized insights, please sign in and enable AI Insights in Settings > AI Notifications."
                };
            }

            try {
                // Check if user has AI insights enabled
                const { data: settings } = await supabase
                    .from('user_ai_settings')
                    .select('ai_insights_enabled')
                    .eq('user_id', currentUser.id)
                    .single();

                if (!settings?.ai_insights_enabled) {
                    return {
                        success: false,
                        message: "AI Insights is not enabled. Go to Settings > AI Notifications to enable personalized analysis of your app data."
                    };
                }

                // Call the AI insights function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-insights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabase.auth.getSession().then(r => r.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    const error = await response.json();
                    return {
                        success: false,
                        message: error.message || "I couldn't analyze your data right now. Please try again later."
                    };
                }

                const data = await response.json();
                return {
                    success: true,
                    message: data.insight,
                    appsAnalyzed: data.apps_analyzed
                };

            } catch (e) {
                console.error('Error getting personal insight:', e);
                return {
                    success: false,
                    message: "I had trouble connecting to the insights service. Please try again."
                };
            }
        }

        // Initialize
        loadUseCases();

        // ============================================
        // CHAT IMPORT FEATURE
        // ============================================

        const importModal = document.getElementById('importModal');
        const importModalClose = document.getElementById('importModalClose');
        const importSources = document.querySelectorAll('.import-source');
        const importInstructions = document.getElementById('importInstructions');
        const importDropzone = document.getElementById('importDropzone');
        const importFileInput = document.getElementById('importFileInput');
        const importStepUpload = document.getElementById('importStepUpload');
        const importProgress = document.getElementById('importProgress');
        const importProgressText = document.getElementById('importProgressText');
        const importProgressFill = document.getElementById('importProgressFill');
        const importResults = document.getElementById('importResults');
        const importDone = document.getElementById('importDone');
        const importRequestCustom = document.getElementById('importRequestCustom');

        let selectedSource = 'chatgpt';
        let analysisResults = null;

        const sourceInstructions = {
            chatgpt: {
                icon: '',
                title: 'How to export from ChatGPT',
                steps: [
                    'Go to <code>chat.openai.com</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Data controls</strong>',
                    'Click <strong>Export data</strong>',
                    'Check your email for the download link',
                    'Upload the <code>conversations.json</code> file below'
                ]
            },
            claude: {
                icon: '',
                title: 'How to export from Claude',
                steps: [
                    'Go to <code>claude.ai</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Account</strong> tab',
                    'Click <strong>Export Data</strong>',
                    'Download the JSON file',
                    'Upload it below'
                ]
            },
            gemini: {
                icon: '',
                title: 'How to export from Gemini',
                steps: [
                    'Go to <code>takeout.google.com</code>',
                    'Deselect all, then select <strong>Gemini Apps</strong>',
                    'Click <strong>Next step</strong>  <strong>Create export</strong>',
                    'Download when ready',
                    'Extract and upload the conversations JSON'
                ]
            }
        };

        importModalClose.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                importModal.classList.remove('active');
            }
        });

        importSources.forEach(source => {
            source.addEventListener('click', () => {
                importSources.forEach(s => s.classList.remove('selected'));
                source.classList.add('selected');
                selectedSource = source.dataset.source;
                updateInstructions();
            });
        });

        function updateInstructions() {
            const instructions = sourceInstructions[selectedSource];
            importInstructions.innerHTML = `
                <h4>${instructions.icon} ${instructions.title}</h4>
                <ol>
                    ${instructions.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
        }

        importDropzone.addEventListener('click', () => importFileInput.click());

        importDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            importDropzone.classList.add('dragover');
        });

        importDropzone.addEventListener('dragleave', () => {
            importDropzone.classList.remove('dragover');
        });

        importDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            importDropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        let isTestMode = false;

        function checkRateLimit() {
            if (isTestMode) return { allowed: true };

            const lastImport = localStorage.getItem('suitegpt_last_import');
            if (lastImport) {
                const lastTime = new Date(lastImport);
                const now = new Date();
                const hoursSince = (now - lastTime) / (1000 * 60 * 60);

                if (hoursSince < 24) {
                    const hoursLeft = Math.ceil(24 - hoursSince);
                    return { allowed: false, hoursLeft };
                }
            }
            return { allowed: true };
        }

        function setRateLimitTimestamp() {
            if (!isTestMode) {
                localStorage.setItem('suitegpt_last_import', new Date().toISOString());
            }
        }

        const loadTestDataBtn = document.getElementById('loadTestData');
        loadTestDataBtn.addEventListener('click', async () => {
            isTestMode = true;
            loadTestDataBtn.textContent = 'Loading test data...';

            try {
                const response = await fetch('/test-data/sample-chatgpt-export.json');
                if (!response.ok) throw new Error('Could not load test data');

                const testData = await response.json();
                const blob = new Blob([JSON.stringify(testData)], { type: 'application/json' });
                const fakeFile = new File([blob], 'test-conversations.json', { type: 'application/json' });

                processFile(fakeFile);
            } catch (error) {
                console.error('Error loading test data:', error);
                alert('Could not load test data. Try uploading your own file.');
                loadTestDataBtn.textContent = 'Load sample data to test the flow';
            }
        });

        function resetImportModal() {
            importStepUpload.style.display = 'block';
            importProgress.classList.remove('active');
            importResults.classList.remove('active');
            importProgressFill.style.width = '0%';
            importFileInput.value = '';
            isTestMode = false;
            loadTestDataBtn.textContent = 'Load sample data to test the flow';
        }

        async function processFile(file) {
            const rateCheck = checkRateLimit();
            if (!rateCheck.allowed) {
                alert(`You can only import once per day. Please try again in ${rateCheck.hoursLeft} hours.`);
                return;
            }

            const consentAnalyze = document.getElementById('consentAnalyze').checked;
            if (!consentAnalyze) {
                alert('Please consent to analysis to continue.');
                return;
            }

            importStepUpload.style.display = 'none';
            importProgress.classList.add('active');
            updateProgress(10, 'Reading file...');

            try {
                let conversations = [];

                if (file.name.endsWith('.zip')) {
                    updateProgress(20, 'Extracting zip file...');
                    const JSZip = await loadJSZip();
                    const zip = await JSZip.loadAsync(file);
                    const conversationsFile = zip.file('conversations.json');
                    if (conversationsFile) {
                        const content = await conversationsFile.async('string');
                        conversations = JSON.parse(content);
                    } else {
                        throw new Error('conversations.json not found in zip');
                    }
                } else {
                    const content = await file.text();
                    conversations = JSON.parse(content);
                }

                updateProgress(40, 'Parsing conversations...');

                const extractedData = extractMessages(conversations, selectedSource);

                updateProgress(60, 'Analyzing patterns...');

                const analysis = await analyzeChats(extractedData);

                updateProgress(100, 'Complete!');

                setRateLimitTimestamp();

                setTimeout(() => {
                    displayResults(analysis, extractedData);
                }, 500);

            } catch (error) {
                console.error('Import error:', error);
                alert('Error processing file: ' + error.message);
                resetImportModal();
            }
        }

        async function loadJSZip() {
            if (window.JSZip) return window.JSZip;

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = () => resolve(window.JSZip);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function extractMessages(data, source) {
            let messages = [];
            let conversationCount = 0;

            if (source === 'chatgpt') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.mapping) {
                            Object.values(conv.mapping).forEach(node => {
                                if (node.message && node.message.author && node.message.author.role === 'user') {
                                    const content = node.message.content;
                                    if (content && content.parts) {
                                        messages.push(...content.parts.filter(p => typeof p === 'string'));
                                    }
                                }
                            });
                        }
                    });
                }
            } else if (source === 'claude') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.messages) {
                            conv.messages.forEach(msg => {
                                if (msg.role === 'human' || msg.role === 'user') {
                                    messages.push(msg.content || msg.text);
                                }
                            });
                        }
                    });
                }
            } else if (source === 'gemini') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.parts) {
                            conv.parts.forEach(part => {
                                if (part.role === 'user') {
                                    messages.push(part.text);
                                }
                            });
                        }
                    });
                }
            }

            return {
                source,
                conversationCount,
                messageCount: messages.length,
                messages: messages.filter(m => m && m.length > 0)
            };
        }

        async function analyzeChats(extractedData) {
            const consentImprove = document.getElementById('consentImprove').checked;

            const sampleSize = Math.min(extractedData.messages.length, 200);
            const sampledMessages = extractedData.messages
                .sort(() => Math.random() - 0.5)
                .slice(0, sampleSize);

            const messagesSummary = sampledMessages.join('\n---\n').slice(0, 50000);

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-chat-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        messages: messagesSummary,
                        source: extractedData.source,
                        messageCount: extractedData.messageCount,
                        conversationCount: extractedData.conversationCount,
                        storeInsights: consentImprove
                    })
                });

                if (!response.ok) {
                    throw new Error('Analysis API failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error, using local analysis:', error);
                return localAnalysis(extractedData);
            }
        }

        function localAnalysis(extractedData) {
            const messages = extractedData.messages;
            const allText = messages.join(' ').toLowerCase();

            const topics = {
                'Health & Fitness': ['workout', 'exercise', 'diet', 'nutrition', 'weight', 'health', 'fitness', 'gym', 'steps', 'walking'],
                'Finance & Money': ['money', 'budget', 'invest', 'savings', 'financial', 'income', 'expenses', 'crypto', 'spending'],
                'Productivity': ['productivity', 'schedule', 'task', 'todo', 'organize', 'habit', 'routine', 'reminder', 'focus', 'pomodoro'],
                'Sleep & Wellness': ['sleep', 'tired', 'insomnia', 'rest', 'meditation', 'stress', 'anxiety', 'mood', 'mental health'],
                'Learning': ['study', 'learn', 'read', 'book', 'course', 'skill', 'flashcard', 'memorize'],
                'Home & Life': ['clean', 'cook', 'meal', 'recipe', 'home', 'pet', 'travel', 'pack']
            };

            const detectedTopics = [];
            for (const [topic, keywords] of Object.entries(topics)) {
                const count = keywords.reduce((acc, keyword) => {
                    const regex = new RegExp(keyword, 'gi');
                    const matches = allText.match(regex);
                    return acc + (matches ? matches.length : 0);
                }, 0);
                if (count > 2) {
                    detectedTopics.push({ topic, count });
                }
            }
            detectedTopics.sort((a, b) => b.count - a.count);

            const recommendations = [];
            // Fitness
            if (allText.includes('fitness') || allText.includes('workout') || allText.includes('exercise')) {
                recommendations.push({ id: 'opticrep', ...SUITE_APPS['opticrep'], matchScore: 88 });
            }
            // Nutrition
            if (allText.includes('nutrition') || allText.includes('food') || allText.includes('diet')) {
                recommendations.push({ id: 'foodvitals', ...SUITE_APPS['foodvitals'], matchScore: 90 });
            }
            // Money
            if (allText.includes('money') || allText.includes('budget') || allText.includes('financial')) {
                recommendations.push({ id: 'quickbudget', ...SUITE_APPS['quickbudget'], matchScore: 85 });
            }
            // Habits
            if (allText.includes('habit') || allText.includes('routine')) {
                recommendations.push({ id: 'habitstack', ...SUITE_APPS['habitstack'], matchScore: 82 });
            }
            // Sleep
            if (allText.includes('sleep') || allText.includes('tired') || allText.includes('insomnia')) {
                recommendations.push({ id: 'sleepwell', ...SUITE_APPS['sleepwell'], matchScore: 87 });
            }
            // Mental health
            if (allText.includes('stress') || allText.includes('anxiety') || allText.includes('mood')) {
                recommendations.push({ id: 'moodlog', ...SUITE_APPS['moodlog'], matchScore: 86 });
            }
            // Focus
            if (allText.includes('focus') || allText.includes('concentrate') || allText.includes('procrastin')) {
                recommendations.push({ id: 'focusflow', ...SUITE_APPS['focusflow'], matchScore: 84 });
            }
            // Reading
            if (allText.includes('book') || allText.includes('read')) {
                recommendations.push({ id: 'bookshelf', ...SUITE_APPS['bookshelf'], matchScore: 80 });
            }
            // Water
            if (allText.includes('water') || allText.includes('hydrat')) {
                recommendations.push({ id: 'hydrotrack', ...SUITE_APPS['hydrotrack'], matchScore: 83 });
            }
            // Meal planning
            if (allText.includes('cook') || allText.includes('meal') || allText.includes('recipe')) {
                recommendations.push({ id: 'mealprep', ...SUITE_APPS['mealprep'], matchScore: 81 });
            }

            const topicIcons = {
                'Health & Fitness': '',
                'Finance & Money': '',
                'Productivity': '',
                'Sleep & Wellness': '',
                'Learning': '',
                'Home & Life': ''
            };

            return {
                topics: detectedTopics.slice(0, 5),
                insights: detectedTopics.slice(0, 3).map(({ topic, count }) => ({
                    category: topic,
                    description: `You frequently discuss ${topic.toLowerCase()} topics (${count}+ mentions)`,
                    icon: topicIcons[topic] || ''
                })),
                recommendations: recommendations.slice(0, 4),
                extractedIdeas: [],
                matchedIdeas: [],
                unmatchedIdeas: [],
                summary: `Based on ${extractedData.messageCount} messages, we found ${detectedTopics.length} main topics of interest.`
            };
        }

        function updateProgress(percent, text) {
            importProgressFill.style.width = percent + '%';
            importProgressText.textContent = text;
        }

        function displayResults(analysis, extractedData) {
            analysisResults = analysis;

            importProgress.classList.remove('active');
            importResults.classList.add('active');

            document.getElementById('statConversations').textContent = extractedData.conversationCount.toLocaleString();
            document.getElementById('statMessages').textContent = extractedData.messageCount.toLocaleString();
            document.getElementById('statTopics').textContent = (analysis.topics?.length || 0);

            const insightsList = document.getElementById('insightsList');
            let insightsHtml = '';

            if (analysis.summary) {
                insightsHtml += `<div class="import-summary-text">${analysis.summary}</div>`;
            }

            insightsHtml += (analysis.insights || []).map(insight => `
                <div class="import-insight-item">
                    <div class="import-insight-icon" style="background: rgba(99, 102, 241, 0.15);">
                        ${insight.icon || ''}
                    </div>
                    <div class="import-insight-content">
                        <h5>${insight.category}</h5>
                        <p>${insight.description}</p>
                    </div>
                </div>
            `).join('');

            insightsList.innerHTML = insightsHtml;

            const recommendationsList = document.getElementById('recommendationsList');
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsList.innerHTML = analysis.recommendations.map(app => `
                    <a href="${app.url || '#'}" class="import-app-rec">
                        <div class="import-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                            ${app.icon || ''}
                        </div>
                        <div class="import-app-info">
                            <h5>${app.name}</h5>
                            <p>${app.description}</p>
                        </div>
                        <div class="import-app-match">${app.matchScore || 85}% match</div>
                    </a>
                `).join('');
            } else {
                recommendationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
                        <p>No exact matches found, but we can build something custom!</p>
                    </div>
                `;
            }

            const unmatchedSection = document.getElementById('importUnmatched');
            const unmatchedList = document.getElementById('unmatchedList');

            if (analysis.unmatchedIdeas && analysis.unmatchedIdeas.length > 0) {
                unmatchedSection.style.display = 'block';
                unmatchedList.innerHTML = analysis.unmatchedIdeas.map((idea) => `
                    <div class="unmatched-idea">
                        <div class="unmatched-idea-text">"${idea.text}"</div>
                        <div class="unmatched-idea-meta">
                            <span class="unmatched-idea-category">${idea.category}</span>
                            <button class="unmatched-idea-request" data-idea="${encodeURIComponent(idea.text)}">
                                Request This App 
                            </button>
                        </div>
                    </div>
                `).join('');

                unmatchedList.querySelectorAll('.unmatched-idea-request').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idea = decodeURIComponent(btn.dataset.idea);
                        requestAppIdea(idea);
                    });
                });
            } else {
                unmatchedSection.style.display = 'none';
            }
        }

        function requestAppIdea(idea) {
            importModal.classList.remove('active');

            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');

            const message = `I'd like to request an app that: ${idea}`;

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            addTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const response = `Great idea! We can build this for you.\n\n` +
                    `Here's how it works:\n` +
                    `1. We'll review your request\n` +
                    `2. AI Fleet will design and build the app\n` +
                    `3. You'll have it within 1-12 hours\n\n` +
                    `Want to submit this request?`;
                addMessage(response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: response });
            }, 1500);
        }

        importDone.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importRequestCustom.addEventListener('click', () => {
            importModal.classList.remove('active');

            if (analysisResults && analysisResults.summary) {
                welcomeState.classList.add('chat-active');
                chatContainer.classList.add('active');

                const message = `Based on my chat history, I'm interested in: ${analysisResults.topics?.slice(0, 3).map(t => t.topic).join(', ')}. Can you help me find or build something for this?`;

                addMessage(message, 'user');
                conversationHistory.push({ role: 'user', content: message });

                addTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const response = `Great! Based on your interests, I can see you're focused on ${analysisResults.topics?.[0]?.topic?.toLowerCase() || 'several areas'}.\n\nWe can either:\n1. Set you up with existing apps that match your needs\n2. Build something custom tailored to your specific workflow\n\nWhat sounds better to you?`;
                    addMessage(response, 'assistant');
                    conversationHistory.push({ role: 'assistant', content: response });
                }, 1500);
            }
        });

        // ============================================
        // PWA SERVICE WORKER REGISTRATION
        // ============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/suitegpt-sw.js')
                    .then((registration) => {
                        console.log('SuiteGPT SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SuiteGPT SW registration failed:', error);
                    });
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            setTimeout(() => {
                showInstallPrompt();
            }, 30000);
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;

            if (sessionStorage.getItem('pwa-prompt-shown')) return;
            sessionStorage.setItem('pwa-prompt-shown', 'true');

            const promptDiv = document.createElement('div');
            promptDiv.className = 'pwa-install-prompt visible';
            promptDiv.innerHTML = `
                <div class="pwa-install-content">
                    <div class="pwa-install-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                    </div>
                    <div class="pwa-install-text">
                        <h4>Add SuiteGPT to Home Screen</h4>
                        <p>Quick access to your app concierge anytime</p>
                    </div>
                </div>
                <div class="pwa-install-actions">
                    <button class="pwa-install-btn secondary" id="pwaLater">Later</button>
                    <button class="pwa-install-btn primary" id="pwaInstall">Add to Home</button>
                </div>
            `;
            document.body.appendChild(promptDiv);

            document.getElementById('pwaInstall').addEventListener('click', async () => {
                promptDiv.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install outcome:', outcome);
                deferredPrompt = null;
            });

            document.getElementById('pwaLater').addEventListener('click', () => {
                promptDiv.remove();
            });
        }
    </script>
</body>
</html>
