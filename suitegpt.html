<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <!-- iOS zoom fix -->
    <script>
        // Capture OAuth hash IMMEDIATELY before anything can strip it
        const _oauthHash = window.location.hash;
        if (_oauthHash) {
            console.log('[Auth EARLY] Hash detected on page load:', _oauthHash);
        }

        // iOS zoom fix - reset on load
        window.addEventListener('load', function() {
            setTimeout(function() {
                window.scrollTo(0, 1);
                window.scrollTo(0, 0);
            }, 0);
        });
    </script>
    <title>SuiteGPT | Your Personal App Concierge</title>
    <meta name="description" content="Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers.">
    <link rel="icon" type="image/png" href="/suitegpt-logo.png">

    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SuiteGPT">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0a0a0f">
    <meta name="msapplication-TileColor" content="#0a0a0f">
    <link rel="manifest" href="/suitegpt-manifest.json">
    <link rel="apple-touch-icon" href="/assets/suitegpt-icon-192.png">

    <!-- Open Graph -->
    <meta property="og:title" content="SuiteGPT | Your Personal App Concierge">
    <meta property="og:description" content="Tell us what you need. We'll find it, change it, or build it for you.">
    <meta property="og:image" content="https://suitegpt.app/assets/images/suitegpt-og.jpg">
    <meta property="og:url" content="https://suitegpt.app">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="SuiteGPT | Your Personal App Concierge">
    <meta name="twitter:description" content="Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers.">
    <meta name="twitter:image" content="https://suitegpt.app/assets/images/suitegpt-og.jpg">

    <!-- Structured Data - SoftwareApplication -->
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "SoftwareApplication",
        "name": "SuiteGPT",
        "alternateName": "Your Personal App Concierge",
        "description": "Tell us what you need. We'll find it, change it, or build it for you. Real apps, not just answers. SuiteGPT is an AI-powered app concierge that helps you discover, customize, or request new apps.",
        "url": "https://suitegpt.app",
        "applicationCategory": "UtilitiesApplication",
        "operatingSystem": "Web Browser",
        "offers": {
            "@type": "Offer",
            "price": "0",
            "priceCurrency": "USD",
            "description": "Free to use with optional credits"
        },
        "aggregateRating": {
            "@type": "AggregateRating",
            "ratingValue": "4.8",
            "ratingCount": "100"
        },
        "author": {
            "@type": "Organization",
            "name": "SUITE",
            "url": "https://getsuite.app"
        },
        "featureList": [
            "AI-powered app discovery",
            "Custom app requests",
            "20+ free productivity apps",
            "Multiple AI models (Claude, GPT-4, Gemini)",
            "Web search capability",
            "Image generation",
            "Voice mode"
        ]
    }
    </script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="/nav.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-x: hidden;
            max-width: 100vw;
            width: 100%;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-size-adjust: 100%;
            touch-action: manipulation;
            overscroll-behavior-y: none;
        }

        /* Prevent iOS zoom on input focus */
        @media screen and (max-width: 768px) {
            input, textarea, select {
                font-size: 16px !important;
            }
        }

        :root {
            --bg-dark: #0a0a0f;
            --bg-sidebar: #111118;
            --bg-card: rgba(255, 255, 255, 0.03);
            --bg-card-hover: rgba(255, 255, 255, 0.06);
            --accent-primary: #6366f1;
            --accent-secondary: #8b5cf6;
            --accent-tertiary: #ec4899;
            --accent-glow: rgba(99, 102, 241, 0.4);
            --text-primary: #f8fafc;
            --text-secondary: rgba(248, 250, 252, 0.7);
            --text-tertiary: rgba(248, 250, 252, 0.4);
            --border-subtle: rgba(255, 255, 255, 0.08);
            --border-hover: rgba(255, 255, 255, 0.15);
            --sidebar-width: 260px;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            width: 100%;
            max-width: 100vw;
            overflow-x: hidden;
            position: relative;
            overscroll-behavior-y: none;
        }

        /* === MAIN LAYOUT === */
        .app-layout {
            display: flex;
            min-height: 100vh;
            max-width: 100vw;
            overflow-x: hidden;
        }

        /* === LEFT SIDEBAR === */
        .sidebar {
            width: var(--sidebar-width);
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            position: fixed;
            top: 0;
            left: 0;
            bottom: 0;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .sidebar-header {
            padding: 10px 20px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            height: 52px;
            box-sizing: border-box;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .sidebar-logo-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: contain;
        }

        .sidebar-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .sidebar-close-btn {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .sidebar-close-btn:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .sidebar-close-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Sidebar collapsed state */
        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .main-content.sidebar-collapsed {
            margin-left: 0;
            max-width: 100vw;
            width: 100%;
        }

        .bg-gradient.sidebar-collapsed {
            left: 0;
        }

        /* Show sidebar toggle when collapsed */
        .sidebar-open-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            display: none;
            align-items: center;
            justify-content: center;
            background: var(--bg-sidebar);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            cursor: pointer;
            z-index: 200;
            transition: all 0.2s ease;
        }

        .sidebar-open-btn:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .sidebar-open-btn.visible {
            display: flex;
        }

        .sidebar-open-btn svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-nav {
            flex: 1;
            padding: 16px 6px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-section-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-tertiary);
            letter-spacing: 0.3px;
            padding: 0 6px;
            margin-bottom: 8px;
        }

        .sidebar-section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-right: 6px;
            margin-bottom: 8px;
        }

        .sidebar-section-header .sidebar-section-title {
            margin-bottom: 0;
        }

        .new-chat-btn {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            border: none;
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .new-chat-btn:hover {
            background: rgba(99, 102, 241, 0.25);
            transform: scale(1.05);
        }

        /* Chat History List */
        .chat-history-list {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 4px;
        }

        .chat-history-list::-webkit-scrollbar {
            width: 4px;
        }

        .chat-history-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .chat-history-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 2px;
        }

        .chat-history-empty {
            padding: 16px 10px;
            text-align: center;
        }

        .chat-history-empty p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }

        .chat-history-empty span {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .chat-history-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s ease;
            margin-bottom: 2px;
        }

        .chat-history-item:hover {
            background: var(--bg-card-hover);
        }

        .chat-history-item.active {
            background: rgba(99, 102, 241, 0.15);
        }

        .chat-history-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            color: var(--text-tertiary);
        }

        .chat-history-item-icon svg {
            width: 16px;
            height: 16px;
        }

        .chat-history-item.active .chat-history-item-icon {
            color: var(--accent-primary);
        }

        .chat-history-item-content {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chat-history-item-title {
            font-size: 0.8rem;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .chat-history-item-time {
            font-size: 0.65rem;
            color: var(--text-tertiary);
        }

        .chat-history-delete-btn {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.15s ease;
        }

        .chat-history-item:hover .chat-history-delete-btn {
            opacity: 1;
        }

        .chat-history-delete-btn:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #f87171;
        }

        .sidebar-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            text-decoration: none;
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            max-width: 223px;
            text-align: left;
            font-family: inherit;
            height: 36px;
        }

        .sidebar-item:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-item.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        /* SuiteGPT Builder sidebar button - special styling */
        .sidebar-builder-btn {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.25);
            color: #a5b4fc;
            margin-bottom: 8px;
        }

        .sidebar-builder-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.15));
            border-color: rgba(99, 102, 241, 0.4);
            color: #c7d2fe;
        }

        .sidebar-builder-btn .sidebar-item-icon {
            color: #818cf8;
        }

        .sidebar-item-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .sidebar-item-icon svg {
            width: 18px;
            height: 18px;
        }

        .sidebar-item-badge {
            margin-left: auto;
            background: var(--accent-primary);
            color: white;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 100px;
        }

        /* Your Apps Sidebar Section */
        .sidebar-your-apps {
            margin-top: 8px;
        }

        .sidebar-expandable {
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            padding: 4px 6px;
            border-radius: 4px;
            user-select: none;
        }

        .sidebar-expandable:hover {
            background: var(--bg-card-hover);
        }

        .sidebar-expandable .expand-arrow {
            width: 12px;
            height: 12px;
            transition: transform 0.2s ease;
            color: var(--text-tertiary);
        }

        .sidebar-expandable.collapsed .expand-arrow {
            transform: rotate(-90deg);
        }

        .sidebar-your-apps-actions {
            display: flex;
            gap: 6px;
            padding: 6px 6px 4px;
        }

        .sidebar-your-apps-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 5px 0;
            font-size: 0.72rem;
            font-weight: 600;
            font-family: inherit;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-your-apps-btn:hover {
            color: var(--accent-primary);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.08);
        }

        .sidebar-apps-list {
            max-height: 200px;
            overflow-y: auto;
            transition: max-height 0.3s ease, opacity 0.2s ease;
        }

        .sidebar-apps-list.collapsed {
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }

        .sidebar-app-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 10px 6px 20px;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .sidebar-app-tab:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-app-tab.active {
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .sidebar-app-tab-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            flex-shrink: 0;
        }

        .sidebar-app-tab-icon img {
            width: 100%;
            height: 100%;
            border-radius: 4px;
            object-fit: cover;
        }

        .sidebar-app-tab-name {
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .sidebar-app-tab-remove {
            opacity: 0;
            padding: 2px;
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-tertiary);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: all 0.15s ease;
        }

        .sidebar-app-tab:hover .sidebar-app-tab-remove {
            opacity: 1;
        }

        .sidebar-app-tab-remove:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .sidebar-apps-empty {
            padding: 8px 16px;
            display: flex;
            gap: 8px;
        }

        .sidebar-apps-empty-btn {
            flex: 1;
            padding: 6px 8px;
            font-size: 0.7rem;
            font-weight: 600;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-card);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .sidebar-apps-empty-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(255, 149, 0, 0.1);
        }

        .sidebar-apps-empty-btn svg {
            width: 12px;
            height: 12px;
        }

        .sidebar-footer {
            padding: 6px;
            width: 245px;
            box-sizing: border-box;
            border-top: 1px solid var(--border-subtle);
            position: relative;
        }

        .sidebar-footer-factory {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-family: inherit;
            height: 36px;
            margin-bottom: 4px;
        }

        .sidebar-footer-factory:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .sidebar-footer-factory.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .sidebar-footer-factory svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .sidebar-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 12px;
            border-radius: 8px;
            background: var(--bg-card);
            border: 1px solid transparent;
            width: 233px;
            height: 51px;
            box-sizing: border-box;
        }

        .sidebar-profile-avatar {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .sidebar-profile-avatar svg {
            width: 20px;
            height: 20px;
        }

        .sidebar-profile-info {
            flex: 1;
        }

        .sidebar-profile-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .sidebar-profile-status {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .sidebar-profile-row {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Add to Home Screen Button */
        .add-to-home-btn {
            display: none;
            align-items: center;
            gap: 10px;
            width: calc(100% - 32px);
            margin: 0 16px 12px 16px;
            padding: 12px 14px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .add-to-home-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.25));
            border-color: var(--accent-primary);
        }

        .add-to-home-btn svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
            flex-shrink: 0;
        }

        .add-to-home-btn span {
            flex: 1;
            text-align: left;
        }

        .add-to-home-dismiss {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0 4px;
            line-height: 1;
            transition: color 0.2s;
        }

        .add-to-home-dismiss:hover {
            color: var(--text-primary);
        }

        .add-to-home-btn.visible {
            display: flex;
        }

        .add-to-home-btn.hidden {
            display: none;
        }

        /* Profile Dropdown (Dropup) */

        .profile-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: var(--bg-sidebar, #111118);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 8px;
            margin-bottom: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: opacity 0.2s, visibility 0.2s, transform 0.2s;
            z-index: 100;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.3);
        }

        .profile-dropdown.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .profile-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            height: 36px;
            box-sizing: border-box;
        }

        .profile-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        a.profile-dropdown-item {
            text-decoration: none;
            color: var(--text-primary);
        }

        a.profile-dropdown-item:hover {
            text-decoration: none;
        }

        .profile-dropdown-item svg {
            width: 16px;
            height: 16px;
            flex-shrink: 0;
            color: var(--text-secondary);
        }

        .profile-dropdown-item.logout {
            color: #f87171;
        }

        .profile-dropdown-item.logout svg {
            color: #f87171;
        }

        .profile-dropdown-divider {
            height: 1px;
            background: var(--border-color);
            margin: 4px 0;
        }

        /* AI Notifications Settings Styles */
        .ai-settings-section {
            padding: 12px;
        }

        .ai-settings-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .ai-settings-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
            line-height: 1.4;
        }

        .ai-setting-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .ai-setting-item:last-child {
            border-bottom: none;
        }

        .ai-setting-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .ai-setting-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .ai-setting-help {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .ai-setting-select {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 6px 10px;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
        }

        .ai-apps-section {
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .ai-apps-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .ai-apps-checkbox input {
            width: 16px;
            height: 16px;
            accent-color: var(--accent-primary);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            transition: 0.3s;
            border-radius: 24px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 2px;
            bottom: 2px;
            background-color: var(--text-tertiary);
            transition: 0.3s;
            border-radius: 50%;
        }

        .toggle-switch input:checked + .toggle-slider {
            background-color: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .toggle-switch input:checked + .toggle-slider:before {
            transform: translateX(20px);
            background-color: white;
        }

        .toggle-switch input:disabled + .toggle-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .profile-dropdown-back {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .profile-dropdown-back:hover {
            color: var(--text-primary);
        }

        .profile-dropdown-view {
            display: block;
        }

        .sidebar-profile {
            cursor: pointer;
            transition: all 0.2s;
        }

        .sidebar-profile:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(255, 255, 255, 0.1);
        }

        /* Profile Dropdown Credits Section */
        .profile-dropdown-credits {
            padding: 0;
        }

        .credits-display {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            height: 36px;
            box-sizing: border-box;
        }

        .credits-display.clickable {
            cursor: pointer;
            border-radius: 6px;
            justify-content: space-between;
        }

        .credits-display.clickable:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .credits-icon {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .credits-info {
            display: flex;
            flex-direction: column;
        }

        .credits-label {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-weight: 500;
        }

        .withdrawal-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            background: none;
            color: var(--text-primary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            height: 36px;
            box-sizing: border-box;
            text-align: left;
        }

        .withdrawal-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .withdrawal-btn:disabled {
            color: var(--text-tertiary);
            cursor: not-allowed;
        }

        /* Linked Accounts Section */
        .linked-accounts-section {
            padding: 0;
        }

        .linked-accounts-header {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 12px 4px;
        }

        .linked-account {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .linked-account-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .linked-account-status .checkmark {
            color: #10b981;
            font-size: 0.85rem;
        }

        .linked-account-value {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            max-width: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-account-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 8px 12px;
            font-size: 0.85rem;
            font-weight: 500;
            font-family: inherit;
            background: none;
            color: var(--text-secondary);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            height: 36px;
            box-sizing: border-box;
            text-align: left;
        }

        .link-account-btn:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .link-account-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .link-account-btn.connected {
            justify-content: space-between;
            color: var(--text-primary);
        }

        .link-account-btn.connected .linked-account-status {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .link-account-btn.connected .checkmark {
            color: #10b981;
        }

        .link-account-btn.connected .linked-account-value {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        /* Credits Modal */
        .credits-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .credits-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .credits-modal {
            background: linear-gradient(170deg, #1e1e3a 0%, #161628 50%, #1a1a2e 100%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            width: 90%;
            max-width: 380px;
            padding: 28px;
            position: relative;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6), 0 0 80px rgba(99, 102, 241, 0.06);
            overflow: hidden;
        }
        .credits-modal::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            border-radius: 24px 24px 0 0;
        }

        .credits-modal-close {
            position: absolute;
            top: 12px;
            right: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .credits-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .credits-modal h2 {
            font-size: 1rem;
            color: rgba(255,255,255,0.45);
            margin: 0 0 20px 0;
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .credits-modal-balance {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(59,130,246,0.08));
            border: 1px solid rgba(16,185,129,0.12);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .credits-modal-amount {
            font-size: 3rem;
            font-weight: 800;
            color: white;
            display: block;
            letter-spacing: -1px;
            line-height: 1;
        }

        .credits-modal-label {
            font-size: 0.72rem;
            color: rgba(255,255,255,0.35);
            margin-top: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 600;
        }

        .credits-modal-options {
            display: flex;
            flex-direction: column;
            gap: 0;
            margin-top: 4px;
        }

        .credits-modal-option {
            display: flex;
            align-items: center;
            gap: 14px;
            width: 100%;
            padding: 16px;
            background: none;
            border: none;
            border-top: 1px solid rgba(255,255,255,0.06);
            cursor: pointer;
            transition: all 0.15s;
            text-align: left;
            border-radius: 0;
        }

        .credits-modal-option:hover {
            background: rgba(255, 255, 255, 0.04);
        }

        .credits-modal-option-icon {
            width: 38px;
            height: 38px;
            background: linear-gradient(135deg, rgba(16,185,129,0.15), rgba(59,130,246,0.15));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #34d399;
            flex-shrink: 0;
        }

        .credits-modal-option-text {
            flex: 1;
        }

        .credits-modal-option-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .credits-modal-option-desc {
            font-size: 0.72rem;
            color: rgba(255,255,255,0.35);
        }

        /* Rewards status in credits modal */
        .credits-rewards-status {
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 12px;
        }
        .credits-rewards-status.earning {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(5,150,105,0.08));
            border: 1px solid rgba(16,185,129,0.2);
        }
        .credits-rewards-status.not-earning {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .credits-rewards-row {
            display: flex; align-items: center; justify-content: space-between;
        }
        .credits-rewards-left {
            display: flex; align-items: center; gap: 10px;
        }
        .credits-rewards-dot {
            width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0;
        }
        .credits-rewards-status.earning .credits-rewards-dot {
            background: #10b981; box-shadow: 0 0 8px rgba(16,185,129,0.5);
        }
        .credits-rewards-status.not-earning .credits-rewards-dot {
            background: rgba(255,255,255,0.2);
        }
        .credits-rewards-text {
            display: flex; flex-direction: column; gap: 2px;
        }
        .credits-rewards-title {
            font-size: 0.85rem; font-weight: 700; color: var(--text-primary);
        }
        .credits-rewards-sub {
            font-size: 0.72rem; color: var(--text-secondary);
        }
        .credits-rewards-sub strong { color: #34d399; }
        .credits-rewards-action {
            font-size: 0.72rem; padding: 6px 12px; border-radius: 8px;
            border: none; cursor: pointer; font-weight: 600; transition: all 0.2s;
            white-space: nowrap;
        }
        .credits-rewards-action.withdraw-suite {
            background: rgba(255,255,255,0.06); color: rgba(255,255,255,0.5);
            border: 1px solid rgba(255,255,255,0.08);
        }
        .credits-rewards-action.withdraw-suite:hover {
            background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.7);
        }
        .credits-rewards-action.enable-rewards {
            background: linear-gradient(135deg, #10b981, #059669); color: white;
        }
        .credits-rewards-action.enable-rewards:hover {
            box-shadow: 0 2px 12px rgba(16,185,129,0.3);
        }
        .credits-rewards-nowallet {
            display: flex; align-items: center; gap: 8px;
            font-size: 0.75rem; color: rgba(255,255,255,0.4);
        }
        .credits-rewards-nowallet a {
            color: #fbbf24; text-decoration: none; font-weight: 600;
        }
        .credits-rewards-nowallet a:hover { text-decoration: underline; }
        .credits-rewards-earned {
            display: flex; align-items: center; justify-content: space-between;
            margin-top: 10px; padding-top: 10px; border-top: 1px solid rgba(255,255,255,0.05);
        }
        .credits-rewards-earned-label {
            font-size: 0.72rem; color: rgba(255,255,255,0.4);
        }
        .credits-rewards-earned-value {
            font-size: 0.85rem; font-weight: 700; color: #34d399;
        }

        .credits-modal-bonus {
            background: linear-gradient(135deg, rgba(124, 58, 237, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(124, 58, 237, 0.3);
            border-radius: 12px;
            padding: 14px 16px;
        }

        .credits-modal-bonus-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .credits-modal-bonus-header span:first-child {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .credits-modal-bonus-amount {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-color);
        }

        .credits-modal-bonus-toggle {
            font-size: 0.8rem;
            color: var(--accent-color);
            background: none;
            border: none;
            padding: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
            transition: opacity 0.2s;
        }

        .credits-modal-bonus-toggle:hover {
            opacity: 0.8;
        }

        .credits-modal-bonus-toggle .toggle-arrow {
            transition: transform 0.3s;
        }

        .credits-modal-bonus.expanded .toggle-arrow {
            transform: rotate(180deg);
        }

        .credits-modal-bonus-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease, margin-top 0.3s ease;
            margin-top: 0;
        }

        .credits-modal-bonus.expanded .credits-modal-bonus-content {
            max-height: 200px;
            margin-top: 12px;
        }

        .credits-modal-bonus-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin: 0 0 10px 0;
        }

        .credits-modal-docs-link {
            font-size: 0.75rem;
            color: var(--accent-color);
            text-decoration: none;
            opacity: 0.9;
            transition: opacity 0.2s;
        }

        .credits-modal-docs-link:hover {
            opacity: 1;
        }

        /* Buy Credits Modal */
        .buy-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .buy-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .buy-modal {
            background: linear-gradient(170deg, #1e1e3a 0%, #161628 50%, #1a1a2e 100%);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 24px;
            padding: 48px 28px 28px;
            width: 90%;
            max-width: 420px;
            position: relative;
            animation: modalSlideIn 0.3s ease;
            box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6), 0 0 80px rgba(99, 102, 241, 0.06);
            overflow: hidden;
        }
        .buy-modal::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 3px;
            background: linear-gradient(90deg, #10b981, #3b82f6, #8b5cf6);
            border-radius: 24px 24px 0 0;
        }

        .buy-modal-back {
            position: absolute;
            top: 16px;
            left: 16px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.8rem;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: all 0.2s;
            padding: 6px 10px;
            border-radius: 8px;
        }

        .buy-modal-back:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .buy-modal h3 {
            font-size: 1.3rem;
            font-weight: 800;
            margin-bottom: 6px;
            color: white;
            letter-spacing: -0.3px;
        }

        .buy-modal-subtitle {
            color: rgba(255,255,255,0.4);
            font-size: 0.82rem;
            margin-bottom: 24px;
        }

        .buy-modal-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .buy-modal-method {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 18px 16px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .buy-modal-method:hover {
            border-color: rgba(16,185,129,0.3);
            background: rgba(16,185,129,0.04);
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .buy-modal-method-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .buy-modal-method-icon.crypto {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
        }

        .buy-modal-method-icon.fiat {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .buy-modal-method-text {
            flex: 1;
        }

        .buy-modal-method-title {
            font-weight: 700;
            color: white;
            font-size: 0.95rem;
        }

        .buy-modal-method-desc {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
            margin-top: 2px;
        }

        .buy-modal-method-arrow {
            color: var(--text-tertiary);
            font-size: 1.2rem;
        }

        .buy-modal-rate {
            text-align: center;
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }


        .buy-modal-input-group {
            margin-bottom: 16px;
        }

        .buy-modal-input-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .buy-modal-input {
            width: 100%;
            padding: 14px 16px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: rgba(255,255,255,0.04);
            color: #fff;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.2s;
        }

        .buy-modal-input:focus {
            outline: none;
            border-color: rgba(16,185,129,0.4);
            background: rgba(16,185,129,0.04);
            box-shadow: 0 0 0 3px rgba(16,185,129,0.08);
        }

        .buy-modal-amount-btns {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .fiat-amount-btn {
            flex: 1;
            padding: 12px 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            color: rgba(255,255,255,0.5);
            font-weight: 700;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .fiat-amount-btn:hover {
            border-color: rgba(16,185,129,0.3);
            color: #34d399;
            background: rgba(16,185,129,0.06);
        }

        .fiat-amount-btn.active {
            background: linear-gradient(135deg, #10b981, #059669);
            border-color: #10b981;
            color: white;
            box-shadow: 0 2px 12px rgba(16,185,129,0.25);
        }

        .buy-modal-preview {
            background: linear-gradient(135deg, rgba(16,185,129,0.1), rgba(59,130,246,0.08));
            border: 1px solid rgba(16,185,129,0.15);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            margin-bottom: 16px;
        }

        .buy-modal-preview-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #34d399;
        }

        .buy-modal-preview-label {
            font-size: 0.85rem;
            color: #a0a0b0;
            margin-top: 4px;
        }

        .buy-modal-btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .buy-modal-btn.primary {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            font-weight: 700;
            font-size: 1rem;
            border-radius: 14px;
            padding: 16px;
        }

        .buy-modal-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(16, 185, 129, 0.35);
        }

        .buy-modal-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .buy-modal-note {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .buy-modal-disclaimer {
            margin-top: 16px;
            padding: 12px;
            background: #202038;
            border-radius: 10px;
            font-size: 0.75rem;
            color: #808090;
            line-height: 1.5;
        }

        .buy-modal-disclaimer strong {
            color: #a0a0b0;
        }

        .buy-modal-disclaimer a {
            color: #818cf8;
        }

        /* Withdrawal Modal */
        .withdrawal-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .withdrawal-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .withdrawal-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 400px;
            padding: 44px 24px 24px;
            position: relative;
        }

        .withdrawal-modal-back {
            position: absolute;
            top: 12px;
            left: 12px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 6px 10px;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .withdrawal-modal-back:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .withdrawal-modal h2 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .withdrawal-balance {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin: 16px 0;
            text-align: center;
        }

        .withdrawal-balance-credits {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .withdrawal-balance-value {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .withdrawal-input-group {
            margin: 16px 0;
        }

        .withdrawal-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .withdrawal-input-wrapper {
            display: flex;
            gap: 8px;
        }

        .withdrawal-input {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .withdrawal-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .withdrawal-max-btn {
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .withdrawal-max-btn:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .withdrawal-note {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin: 12px 0;
            padding: 10px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 8px;
        }

        .withdrawal-confirm-btn {
            width: 100%;
            padding: 14px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.2s;
        }

        .withdrawal-confirm-btn:hover {
            opacity: 0.9;
            transform: scale(1.01);
        }

        .withdrawal-confirm-btn:disabled {
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            cursor: not-allowed;
            transform: none;
        }

        /* Upgrade Modal */
        .upgrade-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .upgrade-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .upgrade-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 32px;
        }

        .upgrade-modal-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .upgrade-modal-header h2 {
            font-size: 1.75rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .upgrade-modal-header p {
            color: var(--text-secondary);
            margin: 0;
        }

        .upgrade-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .upgrade-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .upgrade-tabs {
            display: flex;
            justify-content: center;
            gap: 8px;
            margin-bottom: 32px;
        }

        .upgrade-tab {
            padding: 10px 24px;
            border: 1px solid var(--border-color);
            border-radius: 100px;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .upgrade-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .upgrade-tab:hover:not(.active) {
            border-color: var(--text-secondary);
        }

        .upgrade-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .upgrade-plan {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 24px;
            position: relative;
            transition: border-color 0.2s, transform 0.2s;
        }

        .upgrade-plan:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .upgrade-plan.popular {
            border-color: var(--accent-primary);
        }

        .upgrade-plan-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .upgrade-plan-name {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .upgrade-plan-price {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .upgrade-plan-price span {
            font-size: 0.9rem;
            font-weight: 400;
            color: var(--text-secondary);
        }

        .upgrade-plan-desc {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .upgrade-plan-features {
            list-style: none;
            padding: 0;
            margin: 0 0 24px 0;
        }

        .upgrade-plan-features li {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .upgrade-plan-features li svg {
            width: 16px;
            height: 16px;
            color: #22c55e;
            flex-shrink: 0;
        }

        .upgrade-plan-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .upgrade-plan-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .upgrade-plan-btn.secondary {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .upgrade-plan-btn:hover {
            opacity: 0.9;
        }

        .credits-section {
            display: none;
        }

        .credits-section.active {
            display: block;
        }

        .subscription-section {
            display: none;
        }

        .subscription-section.active {
            display: block;
        }

        .credit-packs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
        }

        .credit-pack {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.2s, transform 0.2s;
        }

        .credit-pack:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .credit-pack.best-value {
            border-color: #22c55e;
            position: relative;
        }

        .credit-pack-badge {
            position: absolute;
            top: -10px;
            left: 50%;
            transform: translateX(-50%);
            background: #22c55e;
            color: white;
            padding: 4px 12px;
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .credit-pack-amount {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .credit-pack-price {
            font-size: 1.1rem;
            color: var(--accent-primary);
            font-weight: 600;
            margin-bottom: 4px;
        }

        .credit-pack-per {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        @media (max-width: 768px) {
            .upgrade-modal {
                padding: 24px 16px;
                margin: 16px;
            }

            .upgrade-plans {
                grid-template-columns: 1fr;
            }

            .credit-packs {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .sidebar-powered-by {
            text-align: center;
            padding: 8px;
        }

        .sidebar-powered-by a {
            color: var(--text-tertiary);
            text-decoration: none;
            font-size: 0.75rem;
            transition: color 0.2s ease;
        }

        .sidebar-powered-by a:hover {
            color: var(--text-secondary);
        }

        .sidebar-powered-by strong {
            color: var(--accent-primary);
        }

        /* === MOBILE SIDEBAR === */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            z-index: 99;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .mobile-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 56px;
            background: var(--bg-sidebar);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 150;
            padding: 0 16px;
            align-items: center;
            justify-content: flex-start;
            gap: 12px;
        }

        .mobile-menu-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.4rem;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s ease;
        }

        .mobile-menu-btn:hover {
            background: var(--bg-card);
        }

        .mobile-title {
            font-size: 1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* === LOGGED OUT STATE === */
        /* Guests see full sidebar - no hiding */

        /* Auth Header for logged-out state */
        .auth-header {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 64px;
            background: rgba(10, 10, 15, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border-subtle);
            z-index: 200;
            padding: 0 24px;
            align-items: center;
            justify-content: space-between;
        }

        /* Auth header hidden - guests use sidebar profile instead */
        body.logged-out .auth-header {
            display: none;
        }

        .auth-header-logo {
            display: flex;
            align-items: center;
            gap: 12px;
            text-decoration: none;
            color: var(--text-primary);
        }

        .auth-header-logo-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: 800;
            color: white;
        }

        .auth-header-logo-text {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .auth-header-buttons {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .auth-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .auth-btn-login {
            background: transparent;
            border: 1px solid var(--border-hover);
            color: var(--text-primary);
        }

        .auth-btn-login:hover {
            background: var(--bg-card-hover);
            border-color: var(--text-secondary);
        }

        .auth-btn-signup {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .auth-btn-signup:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px var(--accent-glow);
        }

        /* No extra padding needed - auth header hidden, sidebar visible */

        /* === CONNECT MODAL === */
        .connect-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .connect-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .connect-modal {
            background: #1a1a2e;
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .connect-modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            color: #9ca3af;
            font-size: 1.5rem;
            cursor: pointer;
            line-height: 1;
        }

        .connect-modal h3 {
            margin: 0 0 20px 0;
            color: #fff;
            font-size: 1.2rem;
        }

        .connect-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .connect-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .connect-option:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .connect-option-icon {
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .connect-option.telegram .connect-option-icon {
            background: rgba(0, 136, 204, 0.2);
            color: #0088cc;
        }

        .connect-option-title {
            font-weight: 600;
            color: #fff;
            margin-bottom: 2px;
        }

        .connect-option-desc {
            font-size: 0.8rem;
            color: #9ca3af;
        }

        .connect-divider {
            display: flex;
            align-items: center;
            gap: 12px;
            color: #6b7280;
            font-size: 0.8rem;
        }

        .connect-divider::before,
        .connect-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .connect-modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: -12px 0 20px 0;
            text-align: center;
        }

        .connect-options-primary {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .connect-option-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.2s ease;
            border: 1px solid var(--border-subtle);
        }

        .connect-option-btn.google {
            background: white;
            color: #333;
        }

        .connect-option-btn.google:hover {
            background: #f5f5f5;
            transform: translateY(-1px);
        }

        .connect-option-btn.email {
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .connect-option-btn.email:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .connect-options-secondary {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }

        .connect-option-small {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .connect-option-small:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .connect-option-small.telegram {
            color: #0088cc;
        }

        .connect-option-small.telegram:hover {
            background: rgba(0, 136, 204, 0.1);
            border-color: rgba(0, 136, 204, 0.3);
        }

        .email-auth-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .email-auth-form input {
            padding: 14px 16px;
            border-radius: 10px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 1rem;
            font-family: inherit;
            outline: none;
            transition: border-color 0.2s;
        }

        .email-auth-form input:focus {
            border-color: var(--accent-primary);
        }

        .email-auth-form input::placeholder {
            color: var(--text-tertiary);
        }

        .email-back-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-family: inherit;
            cursor: pointer;
            padding: 8px;
            transition: color 0.2s;
        }

        .email-back-btn:hover {
            color: var(--text-primary);
        }

        /* === APP PREVIEW (Full Screen Inline) === */
        .app-preview-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-primary);
            z-index: 9999;
            display: none;
            flex-direction: column;
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            transform: translateY(20px);
            transition: opacity 0.3s ease, transform 0.3s ease, visibility 0.3s ease;
        }

        .app-preview-overlay.active {
            display: flex;
            opacity: 1;
            visibility: visible;
            pointer-events: auto;
            transform: translateY(0);
        }

        .app-preview-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px;
            background: var(--bg-sidebar);
            border-bottom: 1px solid var(--border-subtle);
            gap: 16px;
            flex-shrink: 0;
        }

        .app-preview-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-preview-back:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .app-preview-title {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
            justify-content: center;
        }

        .app-preview-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .app-preview-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-preview-title span {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .app-preview-add {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-preview-add:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        .app-preview-add.added {
            background: #22c55e;
            pointer-events: none;
        }

        .app-preview-content {
            flex: 1;
            overflow: hidden;
        }

        .app-preview-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Mobile responsive for app preview */
        @media (max-width: 600px) {
            .app-preview-header {
                padding: 10px 12px;
                gap: 8px;
            }

            .app-preview-back {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .app-preview-back svg {
                width: 16px;
                height: 16px;
            }

            .app-preview-title span {
                font-size: 0.95rem;
            }

            .app-preview-icon {
                width: 28px;
                height: 28px;
                border-radius: 8px;
            }

            .app-preview-add {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .app-preview-add span {
                display: none;
            }

            .app-preview-add::after {
                content: 'Add';
            }
        }

        @media (max-width: 400px) {
            .app-preview-back span {
                display: none;
            }

            .app-preview-title {
                gap: 8px;
            }
        }

        /* === APP LAUNCH MODAL === */
        .app-launch-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .app-launch-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .app-launch-modal {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            padding: 32px;
            max-width: 420px;
            width: 90%;
            text-align: center;
        }

        .app-launch-modal-icon {
            width: 72px;
            height: 72px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin: 0 auto 20px;
            overflow: hidden;
        }

        .app-launch-modal-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .app-launch-modal h3 {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .app-launch-modal p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin-bottom: 28px;
        }

        .app-launch-options {
            display: flex;
            gap: 16px;
        }

        .app-launch-option {
            flex: 1;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .app-launch-option:hover {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .app-launch-option-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .app-launch-option-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .app-launch-option-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .app-launch-modal-close {
            margin-top: 20px;
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 0.9rem;
            cursor: pointer;
            padding: 8px 16px;
        }

        .app-launch-modal-close:hover {
            color: var(--text-primary);
        }

        /* === MOBILE APP CONTAINER (Draggable Phone View) === */
        .mobile-app-container {
            position: fixed;
            width: 375px;
            height: 700px;
            background: #000;
            border-radius: 40px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.5), 0 0 0 2px #333, inset 0 0 0 2px #1a1a1a;
            z-index: 9998;
            display: none;
            flex-direction: column;
            overflow: hidden;
            resize: both;
            min-width: 320px;
            min-height: 500px;
            max-width: 90vw;
            max-height: 90vh;
        }

        .mobile-app-container.active {
            display: flex;
        }

        .mobile-app-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 100%);
            cursor: grab;
            user-select: none;
            border-bottom: 1px solid #333;
        }

        .mobile-app-header:active {
            cursor: grabbing;
        }

        .mobile-app-header-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mobile-app-header-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            overflow: hidden;
        }

        .mobile-app-header-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .mobile-app-header-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #fff;
        }

        .mobile-app-header-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .mobile-app-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .mobile-app-btn-fullscreen {
            background: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
        }

        .mobile-app-btn-fullscreen:hover {
            background: rgba(99, 102, 241, 0.5);
        }

        .mobile-app-btn-minimize {
            background: rgba(34, 197, 94, 0.3);
            color: #86efac;
        }

        .mobile-app-btn-minimize:hover {
            background: rgba(34, 197, 94, 0.5);
        }

        .mobile-app-content {
            flex: 1;
            background: #fff;
            overflow: hidden;
            border-radius: 0 0 38px 38px;
        }

        .mobile-app-content iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        /* Phone notch decoration */
        .mobile-app-notch {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 120px;
            height: 28px;
            background: #000;
            border-radius: 0 0 20px 20px;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .mobile-app-notch::before {
            content: '';
            width: 8px;
            height: 8px;
            background: #1a1a1a;
            border-radius: 50%;
        }

        .mobile-app-notch::after {
            content: '';
            width: 50px;
            height: 4px;
            background: #1a1a1a;
            border-radius: 2px;
        }

        /* Toast notification */
        .app-toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.3);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            max-width: calc(100vw - 40px);
            white-space: nowrap;
        }

        .app-toast.visible {
            opacity: 1;
            visibility: visible;
            transform: translateX(-50%) translateY(0);
        }

        /* === APPS PANEL === */
        .apps-panel-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .apps-panel-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .apps-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1001;
        }

        .apps-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-header h2 {
            margin: 0;
            font-size: 1.25rem;
            color: var(--text-primary);
        }

        .apps-panel-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: background 0.2s;
        }

        .apps-panel-close:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .apps-panel-search {
            padding: 16px 24px;
            border-bottom: 1px solid var(--border-color);
        }

        .apps-panel-search input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
        }

        .apps-panel-search input::placeholder {
            color: var(--text-tertiary);
        }

        .apps-panel-search input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .apps-panel-grid {
            padding: 20px 24px;
            overflow-y: auto;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 16px;
        }

        .apps-panel-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: transform 0.2s, border-color 0.2s, background 0.2s;
            text-decoration: none;
        }

        .apps-panel-item:hover {
            transform: translateY(-2px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .apps-panel-item-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.75rem;
            margin-bottom: 12px;
            overflow: hidden;
        }

        .apps-panel-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .apps-panel-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            margin-bottom: 4px;
            text-align: center;
        }

        .apps-panel-item-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-align: center;
            line-height: 1.3;
        }

        @media (max-width: 768px) {
            .apps-panel {
                width: 95%;
                max-height: 90vh;
            }

            .apps-panel-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
                padding: 16px;
            }

            .apps-panel-item {
                padding: 16px 12px;
            }

            .apps-panel-item-icon {
                width: 48px;
                height: 48px;
            }
        }

        /* === INLINE APPS VIEW === */
        .apps-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            padding-top: 20px;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .apps-view.active {
            display: flex;
        }

        /* === APP DETAIL VIEW === */
        .app-detail-view {
            display: none;
            flex-direction: column;
            align-items: stretch;
            padding: 40px 20px;
            width: 100%;
            max-width: none;
            margin: 0;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }
        .app-detail-view.active {
            display: flex;
        }
        .app-detail-back {
            display: flex;
            align-items: center;
            gap: 8px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            padding: 8px 0;
            align-self: flex-start;
            margin-bottom: 24px;
            transition: color 0.2s;
        }
        .app-detail-back:hover {
            color: var(--text-primary);
        }
        .app-detail-header {
            display: flex;
            align-items: flex-start;
            gap: 20px;
            margin-bottom: 32px;
        }
        .app-detail-icon {
            width: 96px;
            height: 96px;
            min-width: 96px;
            border-radius: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }
        .app-detail-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .app-detail-header-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        .app-detail-name {
            font-size: 26px;
            font-weight: 800;
            color: var(--text-primary);
            margin: 0;
            line-height: 1.2;
        }
        .app-detail-category {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255,255,255,0.08);
            color: var(--text-secondary);
            width: fit-content;
        }
        .app-detail-actions {
            display: flex;
            gap: 10px;
            margin-top: 8px;
        }
        .app-detail-btn-primary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            background: var(--accent-primary);
            color: #fff;
            transition: opacity 0.2s;
            white-space: nowrap;
        }
        .app-detail-btn-primary:hover {
            opacity: 0.9;
        }
        .app-detail-btn-secondary {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 22px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 700;
            border: 2px solid rgba(255,255,255,0.15);
            cursor: pointer;
            background: transparent;
            color: var(--text-primary);
            transition: border-color 0.2s, background 0.2s;
            white-space: nowrap;
        }
        .app-detail-btn-secondary:hover {
            border-color: rgba(255,255,255,0.3);
            background: rgba(255,255,255,0.05);
        }
        .app-detail-btn-secondary.added {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        .app-detail-section {
            margin-bottom: 28px;
        }
        .app-detail-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 14px 0;
        }
        .app-detail-screenshots {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            padding: 4px 0 16px 0;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: thin;
            scrollbar-color: rgba(255,255,255,0.15) transparent;
        }
        .app-detail-screenshots::-webkit-scrollbar {
            height: 6px;
        }
        .app-detail-screenshots::-webkit-scrollbar-track {
            background: transparent;
        }
        .app-detail-screenshots::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.15);
            border-radius: 3px;
        }
        .app-detail-phone-frame {
            flex-shrink: 0;
            width: 200px;
            height: 400px;
            border-radius: 24px;
            border: 3px solid rgba(255,255,255,0.12);
            overflow: hidden;
            background: #111;
            scroll-snap-align: start;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            position: relative;
        }
        .app-detail-phone-iframe {
            width: 375px;
            height: 812px;
            border: none;
            transform: scale(0.533);
            transform-origin: top left;
            pointer-events: none;
        }
        .app-detail-description {
            font-size: 15px;
            line-height: 1.7;
            color: var(--text-secondary);
            margin: 0;
        }
        .app-detail-info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        .app-detail-info-item {
            background: rgba(255,255,255,0.04);
            border-radius: 12px;
            padding: 14px 16px;
        }
        .app-detail-info-label {
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-secondary);
            margin-bottom: 4px;
        }
        .app-detail-info-value {
            font-size: 15px;
            font-weight: 700;
            color: var(--text-primary);
        }
        @media (max-width: 600px) {
            .app-detail-view {
                padding: 24px 16px;
            }
            .app-detail-header {
                gap: 14px;
            }
            .app-detail-icon {
                width: 72px;
                height: 72px;
                min-width: 72px;
                border-radius: 18px;
            }
            .app-detail-name {
                font-size: 20px;
            }
            .app-detail-actions {
                flex-direction: column;
            }
            .app-detail-phone-frame {
                width: 160px;
                height: 320px;
            }
            .app-detail-phone-iframe {
                transform: scale(0.427);
            }
        }

        /* Apps Source Toggle (SUITE / Community) */
        .apps-source-toggle {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.05);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .apps-source-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 20px;
            background: none;
            border: none;
            border-radius: 10px;
            color: var(--text-tertiary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apps-source-btn:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.03);
        }

        .apps-source-btn.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
        }

        .apps-source-btn svg {
            width: 18px;
            height: 18px;
        }

        .apps-source-count {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .apps-source-btn.active .apps-source-count {
            background: rgba(99, 102, 241, 0.3);
            color: var(--accent-primary);
        }

        /* Community Apps specific styles */
        .community-app-card {
            position: relative;
        }

        .community-app-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            background: rgba(34, 197, 94, 0.15);
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 6px;
            font-size: 0.7rem;
            color: #4ade80;
        }

        .community-app-forked {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
        }

        .community-app-author {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .community-app-launch-btn {
            margin-top: 10px;
            width: 100%;
            padding: 7px 0;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            color: #a5b4fc;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .community-app-launch-btn:hover {
            background: rgba(99, 102, 241, 0.3);
            color: #fff;
        }

        .community-empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .community-empty-icon {
            width: 64px;
            height: 64px;
            color: var(--text-tertiary);
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .community-empty-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .community-empty-text {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            max-width: 300px;
            margin-bottom: 20px;
        }

        .community-empty-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .community-empty-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .apps-view-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .apps-view-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .apps-view-back:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .apps-view-back svg {
            width: 18px;
            height: 18px;
        }

        .apps-view-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .apps-view-search {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            margin-bottom: 32px;
            transition: border-color 0.2s;
        }

        .apps-view-search:focus-within {
            border-color: var(--accent-primary);
        }

        .apps-view-search svg {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            flex-shrink: 0;
        }

        .apps-view-search input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
        }

        .apps-view-search input::placeholder {
            color: var(--text-tertiary);
        }

        .apps-view-grid {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .apps-view-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 20px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
        }

        .apps-view-item:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .apps-view-item-icon {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            margin-bottom: 16px;
            overflow: hidden;
        }

        .apps-view-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .apps-view-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1rem;
            margin-bottom: 6px;
            text-align: center;
        }

        .apps-view-item-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-align: center;
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .apps-view {
                padding: 20px;
            }

            .apps-view-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }

            .apps-view-grid {
                display: flex;
                flex-direction: column;
                gap: 16px;
            }

            .apps-view-item {
                padding: 16px 12px;
            }

            .apps-view-item-icon {
                width: 52px;
                height: 52px;
            }
        }

        /* Apps View Tabs */
        .apps-view-tabs {
            display: flex !important;
            flex-direction: row !important;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }

        .apps-view-tab {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
            position: relative;
            z-index: 10;
        }

        .apps-view-tab:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
            border-color: var(--border-hover);
        }

        .apps-view-tab.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .apps-view-tab-icon {
            font-size: 1.1rem;
        }

        .apps-view-tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.8rem;
        }

        .apps-view-tab.active .apps-view-tab-count {
            background: rgba(255, 255, 255, 0.25);
        }

        .apps-view-panel {
            display: none;
        }

        .apps-view-panel.active {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        @media (max-width: 768px) {
            .apps-view-tabs {
                gap: 6px;
            }

            .apps-view-tab {
                padding: 8px 12px;
                font-size: 0.85rem;
            }

            .apps-view-panel.active {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
        }

        /* === FEATURED SECTION (App Store Style) === */
        .apps-featured-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 20px;
        }

        .apps-featured-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .apps-featured-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .apps-featured-scroll {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 8px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .apps-featured-scroll::-webkit-scrollbar {
            display: none;
        }

        .apps-featured-item {
            flex-shrink: 0;
            width: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            cursor: pointer;
            position: relative;
            padding: 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            transition: all 0.2s ease;
        }

        .apps-featured-item:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .apps-featured-item .apps-view-item-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            margin-bottom: 10px;
        }

        .apps-featured-item .apps-view-item-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0;
        }

        .apps-featured-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            font-size: 0.6rem;
            padding: 3px 6px;
            border-radius: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* === CATEGORY TABS === */
        .apps-categories {
            margin-bottom: 24px;
        }

        .apps-category-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 4px;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }

        .apps-category-tabs::-webkit-scrollbar {
            display: none;
        }

        .apps-category-tab {
            flex-shrink: 0;
            padding: 10px 18px;
            border-radius: 24px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .apps-category-tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .apps-category-tab.active {
            background: var(--accent-primary);
            color: white;
            border-color: var(--accent-primary);
        }

        .apps-category-tab-icon {
            margin-right: 6px;
        }

        /* === APP GRID (Category filtered) === */
        .apps-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 16px;
        }

        @media (max-width: 768px) {
            .apps-featured-section {
                padding: 16px 0;
            }

            .apps-featured-item {
                width: 100px;
                padding: 10px;
            }

            .apps-featured-item .apps-view-item-icon {
                width: 48px;
                height: 48px;
            }

            .apps-featured-item .apps-view-item-name {
                font-size: 0.8rem;
            }

            .apps-category-tabs {
                gap: 8px;
            }

            .apps-category-tab {
                padding: 8px 14px;
                font-size: 0.85rem;
            }

            .apps-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
                gap: 12px;
            }
        }

        /* === CONNECTIONS VIEW === */
        .connections-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            padding-top: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .connections-view.active {
            display: flex;
        }

        .connections-header {
            margin-bottom: 24px;
        }

        .connections-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .connections-title svg {
            width: 28px;
            height: 28px;
            color: var(--accent-primary);
        }

        .connections-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 0;
        }

        .connections-privacy-note {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 12px;
            padding: 10px 14px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 8px;
            font-size: 0.85rem;
            color: #4ade80;
        }

        .connections-privacy-note svg {
            flex-shrink: 0;
        }

        .connections-stats {
            display: flex;
            gap: 24px;
            margin-bottom: 32px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
        }

        .connections-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .connections-stat-num {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .connections-stat-label {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .connections-category {
            margin-bottom: 28px;
        }

        .connections-category-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 12px 0;
        }

        .connections-category-icon {
            font-size: 1.2rem;
        }

        .connections-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .connection-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            transition: all 0.2s ease;
        }

        .connection-item:hover {
            background: rgba(255, 255, 255, 0.04);
            border-color: var(--border-hover);
        }

        .connection-item.connected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .connection-item-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
            overflow: hidden;
        }

        .connection-item-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .connection-item-info {
            flex: 1;
            min-width: 0;
        }

        .connection-item-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.95rem;
            margin-bottom: 2px;
        }

        .connection-item-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .connection-item-btn {
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex-shrink: 0;
            background: var(--accent-primary);
            color: white;
            border: none;
        }

        .connection-item-btn:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .connection-item-btn.connected {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .connection-item-btn.connected:hover {
            background: rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
        }

        .connection-item-status {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #22c55e;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .connection-item-status svg {
            width: 14px;
            height: 14px;
        }

        /* AI Insights Preview */
        .connections-insights-preview {
            margin-top: 20px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 16px;
        }

        .connections-insights-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .connections-insights-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 0 16px 0;
        }

        .connections-insights-examples {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .insight-example {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
        }

        .insight-example-icons {
            font-size: 1rem;
            flex-shrink: 0;
        }

        .insight-example-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            font-style: italic;
        }

        @media (max-width: 768px) {
            .connections-view {
                padding: 20px;
            }

            .connections-stats {
                justify-content: center;
            }

            .connection-item {
                flex-wrap: wrap;
            }

            .connection-item-btn {
                width: 100%;
                margin-top: 8px;
            }

            .insight-example {
                flex-direction: column;
                text-align: center;
                gap: 8px;
            }
        }

        /* === INLINE LEARN VIEW === */
        .learn-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            padding-top: 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .learn-view.active {
            display: flex;
        }

        .learn-view-header {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 24px;
        }

        .learn-view-back {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .learn-view-back:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .learn-view-back svg {
            width: 18px;
            height: 18px;
        }

        .learn-view-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .learn-view-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin-bottom: 32px;
        }

        .learn-articles-grid {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .learn-article-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px 24px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            color: inherit;
        }

        .learn-article-card:hover {
            background: rgba(255, 255, 255, 0.06);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .learn-article-icon {
            font-size: 2.5rem;
            flex-shrink: 0;
        }

        .learn-article-content {
            flex: 1;
        }

        .learn-article-tags {
            display: flex;
            gap: 6px;
            margin-bottom: 8px;
        }

        .learn-article-tag {
            padding: 4px 10px;
            background: rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
            border-radius: 100px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .learn-article-tag.new {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }

        .learn-article-title {
            font-size: 1.15rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .learn-article-desc {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 8px;
        }

        .learn-article-meta {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .learn-article-arrow {
            color: var(--accent-primary);
            font-size: 1.2rem;
            font-weight: 700;
        }

        @media (max-width: 768px) {
            .learn-view {
                padding: 20px;
            }

            .learn-article-card {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }

            .learn-article-arrow {
                display: none;
            }

            .learn-article-tags {
                justify-content: center;
            }
        }

        /* === ARTICLE READER === */
        .learn-article-reader {
            margin-top: 32px;
            padding-top: 32px;
            border-top: 1px solid var(--border-color);
        }

        .learn-article-reader-header {
            margin-bottom: 24px;
        }

        .learn-article-reader-content {
            color: var(--text-secondary);
            line-height: 1.8;
        }

        .learn-article-reader-content h1 {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 16px;
            line-height: 1.3;
        }

        .learn-article-reader-content h2 {
            font-size: 1.3rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-top: 32px;
            margin-bottom: 16px;
        }

        .learn-article-reader-content h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-top: 24px;
            margin-bottom: 12px;
        }

        .learn-article-reader-content p {
            margin-bottom: 16px;
        }

        .learn-article-reader-content .article-meta-info {
            display: flex;
            gap: 16px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
            margin-bottom: 24px;
        }

        .learn-article-reader-content .article-highlight {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            padding: 20px;
            margin: 24px 0;
        }

        .learn-article-reader-content .article-highlight p {
            margin-bottom: 0;
            font-size: 1.05rem;
        }

        .learn-article-reader-content .app-feature-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            margin: 16px 0;
        }

        .learn-article-reader-content .app-feature-card h3 {
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .learn-article-reader-content .app-feature-card .app-icon {
            font-size: 1.5rem;
        }

        .learn-article-reader-content .app-feature-card .app-icon-img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
            vertical-align: middle;
        }

        .learn-article-reader-content ul {
            margin-bottom: 16px;
            padding-left: 24px;
        }

        .learn-article-reader-content li {
            margin-bottom: 8px;
        }

        .learn-article-reader-content a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .learn-article-reader-content a:hover {
            text-decoration: underline;
        }

        .learn-article-reader-content .cta-section {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(168, 85, 247, 0.15));
            border-radius: 16px;
            padding: 32px;
            text-align: center;
            margin-top: 40px;
        }

        .learn-article-reader-content .cta-section h3 {
            margin-top: 0;
            font-size: 1.4rem;
        }

        .learn-article-reader-content .cta-button {
            display: inline-block;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            padding: 14px 28px;
            border-radius: 10px;
            font-weight: 600;
            text-decoration: none;
            margin-top: 16px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .learn-article-reader-content .cta-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(99, 102, 241, 0.3);
            text-decoration: none;
        }

        /* === CREATOR DASHBOARD === */
        .creator-dashboard {
            display: none;
            flex-direction: column;
            justify-content: flex-start;
            padding: 40px;
            padding-top: 20px;
            width: 100%;
            box-sizing: border-box;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
            z-index: 20;
            background: var(--bg-dark);
        }

        .creator-dashboard.active {
            display: flex;
        }

        .creator-dashboard-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 24px;
        }

        .creator-dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .creator-dashboard-title svg {
            width: 28px;
            height: 28px;
            color: var(--accent-primary);
        }

        .creator-dashboard-tabs {
            display: flex;
            gap: 4px;
            background: rgba(255, 255, 255, 0.03);
            padding: 4px;
            border-radius: 12px;
            margin-bottom: 32px;
        }

        .creator-dashboard-tab {
            padding: 12px 24px;
            background: transparent;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .creator-dashboard-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .creator-dashboard-tab.active {
            background: rgba(99, 102, 241, 0.15);
            color: var(--accent-primary);
        }

        .creator-dashboard-tab svg {
            width: 18px;
            height: 18px;
        }

        .creator-dashboard-panel {
            display: none;
        }

        .creator-dashboard-panel.active {
            display: block;
        }

        @media (max-width: 768px) {
            .creator-dashboard {
                padding: 20px;
            }

            .creator-dashboard-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }

            .creator-dashboard-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .creator-dashboard-tab {
                padding: 10px 16px;
                font-size: 0.85rem;
                white-space: nowrap;
            }
        }

        /* === YOUR APPS VIEW === */
        .your-apps-view {
            display: none;
            flex-direction: column;
            padding: 40px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        .your-apps-view.active {
            display: flex;
        }

        .your-apps-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 32px;
        }

        .your-apps-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .your-apps-create-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 12px;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .your-apps-create-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: var(--border-hover);
            color: var(--text-primary);
        }

        .your-apps-create-btn svg {
            width: 18px;
            height: 18px;
        }

        .your-apps-header-actions {
            display: flex;
            gap: 10px;
        }

        .your-apps-empty-actions {
            display: flex;
            gap: 12px;
            margin-top: 8px;
        }

        .your-apps-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .your-apps-empty-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            background: rgba(99, 102, 241, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 24px;
        }

        .your-apps-empty-icon svg {
            width: 40px;
            height: 40px;
            color: var(--accent-primary);
        }

        .your-apps-empty h3 {
            font-size: 1.25rem;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .your-apps-empty p {
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            max-width: 400px;
        }

        /* Unified list container */
        .your-apps-unified-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .your-apps-count-badge {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            background: rgba(255, 255, 255, 0.06);
            padding: 2px 10px;
            border-radius: 20px;
            margin-left: 8px;
            font-weight: 600;
        }

        /* Bookmark row  compact single-line */
        .your-apps-bookmark-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.2s ease;
        }

        .your-apps-bookmark-row:hover {
            border-color: var(--border-hover);
            background: rgba(255, 255, 255, 0.04);
        }

        .your-apps-bookmark-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .your-apps-bookmark-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .your-apps-bookmark-info {
            flex: 1;
            min-width: 0;
        }

        .your-apps-bookmark-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-bookmark-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-bookmark-actions {
            display: flex;
            align-items: center;
            gap: 6px;
            flex-shrink: 0;
        }

        .your-apps-bookmark-launch {
            padding: 5px 14px;
            font-size: 0.78rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            background: var(--accent-primary);
            color: #fff;
            cursor: pointer;
            transition: opacity 0.2s;
        }

        .your-apps-bookmark-launch:hover {
            opacity: 0.85;
        }

        .your-apps-bookmark-remove {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .your-apps-bookmark-remove:hover {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
        }

        /* Project card  expandable */
        .your-apps-project-card {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            transition: all 0.2s ease;
            overflow: hidden;
        }

        .your-apps-project-card:hover {
            border-color: var(--border-hover);
            background: rgba(255, 255, 255, 0.04);
        }

        .your-apps-project-card.expanded {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.04);
        }

        .your-apps-project-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            cursor: pointer;
            user-select: none;
        }

        .your-apps-project-icon {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            overflow: hidden;
            flex-shrink: 0;
        }

        .your-apps-project-icon svg {
            width: 20px;
            height: 20px;
        }

        .your-apps-project-info {
            flex: 1;
            min-width: 0;
        }

        .your-apps-project-name {
            font-size: 0.95rem;
            font-weight: 700;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .your-apps-project-badge {
            font-size: 0.65rem;
            font-weight: 600;
            padding: 2px 8px;
            border-radius: 20px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            white-space: nowrap;
        }

        .your-apps-project-desc {
            font-size: 0.78rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            margin-top: 2px;
        }

        .your-apps-project-chevron {
            flex-shrink: 0;
            color: var(--text-tertiary);
            transition: transform 0.25s ease;
        }

        .your-apps-project-card.expanded .your-apps-project-chevron {
            transform: rotate(180deg);
        }

        /* Expanded sections */
        .project-card-sections {
            display: none;
            padding: 0 14px 14px;
            flex-direction: column;
            gap: 10px;
        }

        .your-apps-project-card.expanded .project-card-sections {
            display: flex;
        }

        .project-section {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 12px 14px;
        }

        .project-section-title {
            font-size: 0.78rem;
            font-weight: 700;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .project-section-title svg {
            width: 14px;
            height: 14px;
        }

        .project-section-content {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .project-section-btn {
            padding: 6px 14px;
            font-size: 0.78rem;
            font-weight: 600;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.04);
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .project-section-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.08);
        }

        .project-section-btn.primary {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: #fff;
        }

        .project-section-btn.primary:hover {
            opacity: 0.85;
        }

        .project-section-placeholder {
            font-size: 0.78rem;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .your-apps-card-info {
            flex: 1;
            min-width: 0;
        }

        .your-apps-card-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-card-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .your-apps-card-creator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--accent-primary);
            margin-bottom: 12px;
        }

        .your-apps-card-actions {
            display: flex;
            gap: 10px;
        }

        .your-apps-card-btn {
            flex: 1;
            padding: 10px 14px;
            border-radius: 10px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .your-apps-card-btn.propose {
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            color: var(--accent-primary);
        }

        .your-apps-card-btn.propose:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }

        .your-apps-card-btn.remove {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .your-apps-card-btn.remove:hover {
            background: rgba(239, 68, 68, 0.15);
            border-color: #ef4444;
        }

        .your-apps-card-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Proposal Modal */
        .proposal-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .proposal-modal-overlay.active {
            display: flex;
        }

        .proposal-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 520px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .proposal-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .proposal-modal-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .proposal-modal-close {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .proposal-modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .proposal-modal-close svg {
            width: 18px;
            height: 18px;
        }

        .proposal-modal-body {
            padding: 24px;
        }

        /* App Settings Modal */
        .app-settings-overlay {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1001;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .app-settings-overlay.active { display: flex; }
        .app-settings-modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            width: 100%;
            max-width: 480px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .app-settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }
        .app-settings-title {
            font-size: 1.15rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }
        .app-settings-body { padding: 24px; }
        .app-settings-group { margin-bottom: 20px; }
        .app-settings-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: block;
        }
        .app-settings-value {
            color: var(--text-primary);
            font-size: 1rem;
        }
        .app-settings-pricing {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
        }
        .app-settings-pricing-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 0;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        .app-settings-pricing-row + .app-settings-pricing-row {
            border-top: 1px solid var(--border-subtle);
        }
        .app-settings-pricing-row.total {
            color: var(--text-primary);
            font-weight: 600;
        }
        .app-settings-cost-badge {
            background: rgba(99,102,241,0.15);
            color: #818cf8;
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .app-settings-total-cost {
            color: #22c55e;
            font-weight: 700;
            font-size: 1rem;
        }
        .app-settings-markup-input {
            width: 80px;
            padding: 6px 10px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.9rem;
            text-align: center;
        }
        .app-settings-earnings {
            font-size: 1.1rem;
            font-weight: 700;
            color: #22c55e;
        }
        .app-settings-toggles { display: flex; flex-direction: column; gap: 10px; }
        .app-settings-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.9rem;
        }
        .app-settings-toggle input[type="checkbox"] {
            width: 18px; height: 18px;
            accent-color: #6366f1;
        }
        .app-settings-save-btn {
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: opacity 0.2s;
            margin-top: 8px;
        }
        .app-settings-save-btn:hover { opacity: 0.9; }

        .proposal-modal-app {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .proposal-modal-app-icon {
            width: 44px;
            height: 44px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            overflow: hidden;
        }

        .proposal-modal-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .proposal-modal-app-name {
            font-weight: 600;
            color: var(--text-primary);
        }

        .proposal-modal-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .proposal-modal-textarea {
            width: 100%;
            min-height: 140px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            resize: vertical;
            transition: border-color 0.2s;
            box-sizing: border-box;
        }

        .proposal-modal-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .proposal-modal-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .proposal-modal-footer {
            padding: 20px 24px;
            border-top: 1px solid var(--border-subtle);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .proposal-modal-btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-modal-btn.cancel {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
        }

        .proposal-modal-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .proposal-modal-btn.submit {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .proposal-modal-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .proposal-modal-btn.submit:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Create New App Modal - Tier Selection */
        .tier-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .tier-option {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 2px solid var(--border-subtle);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .tier-option:hover {
            border-color: var(--border-hover);
            background: rgba(255, 255, 255, 0.05);
        }

        .tier-option.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .tier-option-icon {
            font-size: 1.5rem;
        }

        .tier-option-info {
            flex: 1;
        }

        .tier-option-name {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .tier-option-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .tier-option-check {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            border: 2px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .tier-option.selected .tier-option-check {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
        }

        .tier-option-check svg {
            width: 14px;
            height: 14px;
            color: white;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tier-option.selected .tier-option-check svg {
            opacity: 1;
        }

        @media (max-width: 768px) {
            .your-apps-view {
                padding: 20px;
            }

            .your-apps-header {
                flex-direction: column;
                align-items: stretch;
                gap: 16px;
            }

            .your-apps-grid {
                grid-template-columns: 1fr;
            }

            .proposal-modal {
                max-width: none;
                margin: 0;
            }
        }

        /* === INLINE CREATE VIEW === */
        .create-view {
            flex: 1;
            padding: 40px;
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow-y: auto;
        }

        .create-view-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 0 0 32px 0;
        }

        .create-view-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
        }

        .create-card {
            display: flex;
            align-items: flex-start;
            gap: 16px;
            padding: 24px;
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .create-card:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
            box-shadow: 0 8px 24px rgba(99, 102, 241, 0.15);
        }

        .create-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .create-card-icon svg {
            width: 28px;
            height: 28px;
            color: white;
        }

        .create-card-content {
            flex: 1;
        }

        .create-card-content h3 {
            margin: 0 0 6px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .create-card-content p {
            margin: 0;
            font-size: 0.9rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        .create-section {
            margin-bottom: 40px;
        }

        .create-section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 20px 0;
        }

        .create-section-title svg {
            width: 22px;
            height: 22px;
            color: var(--text-secondary);
        }

        .create-section-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            background: linear-gradient(135deg, #eab308, #ca8a04);
            color: #000;
            border-radius: 4px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .create-card.premium {
            border-color: rgba(234, 179, 8, 0.3);
        }

        .create-card.premium:hover {
            border-color: #eab308;
            box-shadow: 0 8px 24px rgba(234, 179, 8, 0.15);
        }

        @media (max-width: 768px) {
            .create-view {
                padding: 20px;
            }

            .create-view-grid {
                grid-template-columns: 1fr;
            }

            .create-card {
                padding: 20px;
            }

            .create-card-icon {
                width: 48px;
                height: 48px;
            }

            .create-card-icon svg {
                width: 24px;
                height: 24px;
            }

            .create-section {
                margin-bottom: 32px;
            }
        }

        /* === CREATOR EARNINGS VIEW === */
        .earnings-view {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 24px;
            width: 100%;
            max-width: 700px;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .earnings-view.active {
            display: flex;
        }

        .earnings-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .earnings-header-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earnings-header-icon svg {
            width: 32px;
            height: 32px;
            color: white;
        }

        .earnings-header h1 {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .earnings-header p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .earnings-steps {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 32px;
        }

        .earnings-step {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
        }

        .earnings-step-num {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 0.9rem;
            color: white;
            flex-shrink: 0;
        }

        .earnings-step-text h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .earnings-step-text p {
            margin: 4px 0 0 0;
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .earnings-cta {
            text-align: center;
            margin-bottom: 32px;
        }

        .earnings-enroll-btn {
            padding: 14px 40px;
            font-size: 1rem;
            font-weight: 600;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .earnings-enroll-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .earnings-terms {
            margin: 12px 0 0 0;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        .earnings-terms a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .earnings-cards {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }

        .earnings-card {
            padding: 20px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            text-align: center;
        }

        .earnings-card-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 12px;
            background: rgba(99, 102, 241, 0.1);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .earnings-card-icon svg {
            width: 20px;
            height: 20px;
            color: var(--accent-primary);
        }

        .earnings-card h4 {
            margin: 0 0 6px 0;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .earnings-card p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        @media (max-width: 768px) {
            .earnings-view {
                padding: 24px 16px;
            }

            .earnings-header h1 {
                font-size: 1.4rem;
            }

            .earnings-cards {
                grid-template-columns: 1fr;
            }
        }

        /* === MY REQUESTS PANEL === */
        .my-requests-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .my-requests-header h3 {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .my-requests-header p {
            font-size: 1rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .my-requests-empty {
            text-align: center;
            padding: 60px 20px;
        }

        .my-requests-empty-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 16px;
            background: var(--bg-elevated);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .my-requests-empty-icon svg {
            width: 32px;
            height: 32px;
            color: var(--text-tertiary);
        }

        .my-requests-empty h4 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .my-requests-empty p {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin: 0 0 24px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .my-requests-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .my-request-item {
            background: var(--bg-elevated);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .my-request-status {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .my-request-status.pending {
            background: #f59e0b;
        }

        .my-request-status.approved {
            background: #22c55e;
        }

        .my-request-status.rejected {
            background: #ef4444;
        }

        .my-request-content {
            flex: 1;
            min-width: 0;
        }

        .my-request-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .my-request-meta {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        /* === SETTINGS MODAL === */
        .settings-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .settings-modal-overlay.active {
            display: flex;
        }

        .settings-modal {
            background: var(--bg-elevated);
            border-radius: 16px;
            width: 100%;
            max-width: 700px;
            max-height: 80vh;
            display: flex;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .settings-nav {
            width: 200px;
            background: var(--bg-dark);
            border-right: 1px solid var(--border-subtle);
            padding: 16px 0;
            flex-shrink: 0;
        }

        .settings-nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            cursor: pointer;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
            font-size: 0.95rem;
            transition: all 0.15s ease;
        }

        .settings-nav-item:hover {
            background: var(--bg-elevated);
            color: var(--text-primary);
        }

        .settings-nav-item.active {
            background: var(--accent-primary);
            color: white;
        }

        .settings-nav-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .settings-content {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
            background: #1a1a28;
        }

        .settings-content-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        .settings-content-header h2 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .settings-close-btn {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 6px;
            transition: all 0.15s ease;
        }

        .settings-close-btn:hover {
            background: var(--bg-dark);
            color: var(--text-primary);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        .settings-panel-description {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.6;
        }

        .settings-action-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 12px 20px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .settings-action-btn:hover {
            background: var(--accent-hover);
        }

        .settings-action-btn svg {
            width: 18px;
            height: 18px;
        }

        @media (max-width: 600px) {
            .settings-modal {
                flex-direction: column;
                max-height: 90vh;
            }

            .settings-nav {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
                padding: 8px;
                border-right: none;
                border-bottom: 1px solid var(--border-subtle);
            }

            .settings-nav-item {
                padding: 8px 16px;
                white-space: nowrap;
            }
        }

        /* === FACTORY/GOVERNANCE VIEW === */
        .factory-view {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
            background: var(--bg-dark);
            position: relative;
            overflow: hidden;
        }

        .factory-view.active {
            display: flex;
        }

        .factory-view-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .factory-view-title {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .factory-view-title h1 {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0;
        }

        .factory-main-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
        }

        .factory-main-tab {
            padding: 8px 20px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .factory-main-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-main-tab.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .factory-main-tab .tab-count {
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
        }

        .factory-view-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        .factory-sidebar-panel {
            width: 280px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border-subtle);
            padding: 24px;
            overflow-y: auto;
            flex-shrink: 0;
        }

        .factory-sidebar-section {
            margin-bottom: 24px;
        }

        .factory-sidebar-title {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .factory-rep-explainer {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.08) 0%, rgba(139, 92, 246, 0.04) 100%);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid rgba(99, 102, 241, 0.2);
        }

        .factory-rep-section {
            background: var(--bg-dark);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 10px;
        }

        .factory-rep-section:last-child {
            margin-bottom: 0;
        }

        .factory-rep-header {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            margin-bottom: 8px;
        }

        .factory-rep-header.earn { color: #22c55e; }
        .factory-rep-header.spend { color: var(--accent-primary); }

        .factory-rep-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding: 4px 0;
        }

        .factory-rep-value {
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .factory-rep-value.positive { color: #22c55e; }
        .factory-rep-value.cost { color: var(--accent-primary); }

        .factory-stat-card {
            background: var(--bg-card);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .factory-stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 4px;
        }

        .factory-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .factory-proposals-area {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .factory-new-proposal-row {
            margin-bottom: 16px;
        }

        .factory-proposals-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .factory-section-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
        }

        .factory-section-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.85rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .factory-section-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-section-tab.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .factory-section-tab .section-count {
            background: rgba(255, 255, 255, 0.08);
            padding: 1px 6px;
            border-radius: 8px;
            font-size: 0.7rem;
        }

        .factory-submit-btn {
            padding: 10px 16px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border: 1px solid rgba(99, 102, 241, 0.25);
            color: #a5b4fc;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            justify-content: center;
        }

        .factory-submit-btn:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.15));
            border-color: rgba(99, 102, 241, 0.4);
            color: #c7d2fe;
        }

        /* Governance layout with sidebar */
        .factory-governance-layout {
            display: flex;
            gap: 20px;
        }

        .factory-app-filter {
            width: 200px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .factory-filter-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .factory-filter-options {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .factory-filter-option {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all 0.2s;
        }

        .factory-filter-option:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text-primary);
        }

        .factory-filter-option.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .factory-filter-count {
            background: rgba(255, 255, 255, 0.15);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .factory-filter-option.active .factory-filter-count {
            background: rgba(255, 255, 255, 0.1);
        }

        /* App tags on cards */
        .factory-app-tag {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 600;
            background: rgba(139, 92, 246, 0.2);
            color: #a78bfa;
            margin-bottom: 8px;
        }

        .factory-app-tag.new-app {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
        }

        .factory-app-tag.general {
            background: rgba(100, 116, 139, 0.2);
            color: #94a3b8;
        }

        /* Checkbox styling */
        .factory-checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .factory-checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .factory-kanban {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 16px;
            flex: 1;
        }

        .factory-column {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            min-height: 300px;
        }

        .factory-column-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 700;
            font-size: 0.95rem;
        }

        .factory-column-count {
            margin-left: auto;
            background: var(--bg-dark);
            padding: 4px 10px;
            border-radius: 10px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .factory-submitted-tabs {
            display: flex;
            gap: 4px;
            margin-bottom: 12px;
            background: var(--bg-dark);
            padding: 4px;
            border-radius: 8px;
        }

        .factory-submitted-tab {
            flex: 1;
            padding: 8px 12px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .factory-submitted-tab:hover {
            color: var(--text-primary);
            background: rgba(255, 255, 255, 0.05);
        }

        .factory-submitted-tab.active {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .factory-submitted-tab span {
            background: rgba(255, 255, 255, 0.08);
            padding: 2px 6px;
            border-radius: 6px;
            font-size: 0.7rem;
        }

        .factory-subtab-content {
            display: none;
        }

        .factory-subtab-content.active {
            display: block;
        }

        .factory-proposal-card {
            background: var(--bg-card-hover);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .factory-proposal-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .factory-admin-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(239, 68, 68, 0.2);
            border: none;
            border-radius: 6px;
            padding: 4px 8px;
            cursor: pointer;
            font-size: 0.85rem;
            opacity: 0.7;
            transition: all 0.2s;
        }

        .factory-admin-delete:hover {
            background: rgba(239, 68, 68, 0.4);
            opacity: 1;
        }

        .factory-proposal-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .factory-proposal-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 10px;
            line-height: 1.3;
        }

        .factory-proposal-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .factory-proposal-card.expanded .factory-proposal-content {
            -webkit-line-clamp: unset;
            display: block;
        }

        .factory-proposal-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .factory-proposal-author {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .factory-vote-buttons {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .factory-vote-btn {
            flex: 1;
            padding: 8px;
            border-radius: 6px;
            border: 1px solid var(--border-subtle);
            background: transparent;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            color: var(--text-secondary);
        }

        .factory-vote-btn.for:hover:not(:disabled) {
            background: rgba(34, 197, 94, 0.2);
            border-color: #22c55e;
            color: #22c55e;
        }

        .factory-vote-btn.against:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.2);
            border-color: #ef4444;
            color: #ef4444;
        }

        .factory-vote-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .factory-vote-count {
            font-weight: 600;
        }

        .factory-empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .factory-empty-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        /* How it Works View */
        .factory-howitworks-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .factory-howitworks-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .factory-howitworks-header h2 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0 0 12px 0;
        }

        .factory-howitworks-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            max-width: 600px;
            margin: 0 auto;
        }

        /* Step-by-step Flow */
        .factory-howitworks-flow {
            display: flex;
            align-items: flex-start;
            justify-content: center;
            gap: 16px;
            margin-bottom: 48px;
            padding: 32px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            flex-wrap: wrap;
        }

        .factory-howitworks-step {
            flex: 1;
            min-width: 140px;
            max-width: 180px;
            text-align: center;
            position: relative;
        }

        .factory-howitworks-step-number {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            font-size: 0.75rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }

        .factory-howitworks-step-icon {
            font-size: 2.5rem;
            margin: 16px 0 12px 0;
        }

        .factory-howitworks-step h4 {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: var(--text-primary);
        }

        .factory-howitworks-step p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.4;
        }

        .factory-howitworks-arrow {
            font-size: 1.5rem;
            color: var(--accent-primary);
            margin-top: 40px;
            opacity: 0.6;
        }

        @media (max-width: 768px) {
            .factory-howitworks-flow {
                flex-direction: column;
                align-items: center;
            }
            .factory-howitworks-arrow {
                transform: rotate(90deg);
                margin: 8px 0;
            }
            .factory-howitworks-step {
                max-width: 250px;
            }
        }

        .factory-howitworks-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            margin-bottom: 48px;
        }

        .factory-howitworks-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
            text-align: center;
        }

        .factory-howitworks-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .factory-howitworks-card h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: var(--text-primary);
        }

        .factory-howitworks-detail {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 10px;
            font-size: 0.95rem;
        }

        .factory-howitworks-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--accent-primary);
        }

        .factory-howitworks-value.highlight {
            color: #22c55e;
        }

        .factory-howitworks-note {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 16px 0 0 0;
        }

        .factory-howitworks-btn {
            margin-top: 16px;
            padding: 12px 28px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .factory-howitworks-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(99, 102, 241, 0.3);
        }

        /* FAQ Section */
        .factory-howitworks-faq {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
        }

        .factory-howitworks-faq h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            color: var(--text-primary);
            text-align: center;
        }

        .factory-howitworks-faq-item {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .factory-howitworks-faq-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .factory-howitworks-faq-item strong {
            display: block;
            font-size: 1rem;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .factory-howitworks-faq-item p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0;
            line-height: 1.5;
        }

        /* Leaderboard View */
        .factory-leaderboard-content {
            max-width: 600px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .factory-leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .factory-leaderboard-item {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            transition: all 0.2s;
        }

        .factory-leaderboard-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .factory-leaderboard-rank {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }

        .factory-leaderboard-name {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .factory-leaderboard-credits {
            font-size: 1rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        /* ===== Reward Pool Banner  Redesigned ===== */
        .reward-pool-banner {
            position: relative;
            overflow: hidden;
            border-radius: 20px;
            margin: 0 0 24px 0;
            background: #0a0a0a;
            border: 1px solid rgba(16, 185, 129, 0.12);
            animation: rewardBannerFadeIn 0.6s ease-out;
        }

        @keyframes rewardBannerFadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Ambient glow */
        .reward-pool-banner::before {
            content: '';
            position: absolute;
            inset: 0;
            background:
                radial-gradient(ellipse 60% 80% at 10% 50%, rgba(16, 185, 129, 0.1) 0%, transparent 60%),
                radial-gradient(ellipse 40% 60% at 90% 20%, rgba(34, 197, 94, 0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        /* Noise texture */
        .reward-pool-banner::after {
            content: '';
            position: absolute;
            inset: 0;
            opacity: 0.025;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
            pointer-events: none;
            z-index: 0;
        }

        .reward-pool-inner {
            position: relative;
            z-index: 1;
        }

        .reward-pool-main {
            padding: 28px 32px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .reward-pool-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
        }

        .reward-pool-actions {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-left: auto;
        }

        .reward-pool-icon {
            width: 52px;
            height: 52px;
            border-radius: 16px;
            background: linear-gradient(145deg, #10b981, #059669);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            box-shadow: 0 0 24px rgba(16, 185, 129, 0.25), inset 0 1px 0 rgba(255,255,255,0.15);
        }

        .reward-pool-title-group {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .reward-pool-label {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            font-weight: 700;
        }

        .reward-pool-amount {
            font-size: 2.8rem;
            font-weight: 900;
            color: #fff;
            line-height: 1;
            letter-spacing: -1px;
            font-variant-numeric: tabular-nums;
        }

        .reward-pool-amount .reward-pool-currency {
            font-size: 1.4rem;
            color: #10b981;
            font-weight: 700;
            vertical-align: super;
            margin-left: 2px;
        }

        .reward-pool-stats {
            display: flex;
            gap: 8px;
        }

        .reward-pool-stat {
            display: flex;
            flex-direction: column;
            gap: 3px;
            padding: 12px 16px;
            border-radius: 12px;
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.04);
            flex: 1;
            transition: background 0.2s;
        }

        .reward-pool-stat:hover {
            background: rgba(255,255,255,0.05);
        }

        .reward-pool-stat-value {
            font-size: 1.05rem;
            font-weight: 800;
            color: var(--text-primary);
            font-variant-numeric: tabular-nums;
        }

        .reward-pool-stat-label {
            font-size: 0.6rem;
            color: rgba(255,255,255,0.35);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
        }

        .reward-pool-countdown {
            font-variant-numeric: tabular-nums;
        }

        .reward-pool-countdown .rpc-unit {
            font-size: 0.55rem;
            font-weight: 600;
            color: rgba(255,255,255,0.3);
            margin-left: 1px;
            margin-right: 4px;
        }

        .reward-pool-countdown .rpc-unit:last-child {
            margin-right: 0;
        }

        /* Your Earned Rewards row */
        .rp-your-rewards {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            border-radius: 12px;
            background: rgba(59, 130, 246, 0.06);
            border: 1px solid rgba(59, 130, 246, 0.1);
        }
        .rp-your-rewards-left { display: flex; flex-direction: column; gap: 4px; }
        .rp-your-label { font-size: 0.65rem; color: rgba(255,255,255,0.4); text-transform: uppercase; letter-spacing: 1px; font-weight: 600; }
        .rp-your-amount { font-size: 1.2rem; }
        .rp-your-rewards-right { display: flex; align-items: center; gap: 12px; }
        .rp-claim-btn {
            display: flex; align-items: center; gap: 6px; padding: 10px 18px;
            background: linear-gradient(135deg, #3b82f6, #2563eb); border: none; border-radius: 10px;
            color: white; font-size: 0.82rem; font-weight: 700; cursor: pointer;
            transition: all 0.2s; box-shadow: 0 2px 12px rgba(59,130,246,0.2);
            white-space: nowrap; letter-spacing: 0.3px;
        }
        .rp-claim-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 20px rgba(59,130,246,0.35); }

        .reward-pool-share { font-size: 0.78rem; color: rgba(255,255,255,0.55); }
        .reward-pool-share strong { color: #34d399; font-weight: 800; font-size: 1.15rem; }

        .reward-pool-wallet-link {
            font-size: 0.68rem; color: #fbbf24; text-decoration: none; transition: all 0.2s;
            display: flex; align-items: center; gap: 4px;
        }
        .reward-pool-wallet-link:hover { color: #fcd34d; text-decoration: underline; }
        .reward-pool-wallet-connected {
            font-size: 0.68rem; color: #10b981; display: flex; align-items: center; gap: 4px;
        }

        /* How it works */
        .rp-how-it-works {
            margin-top: 16px; padding: 16px; border-radius: 12px;
            background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06);
        }
        .rp-how-header {
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; user-select: none;
        }
        .rp-how-title {
            font-size: 0.72rem; font-weight: 700; color: rgba(255,255,255,0.5);
            text-transform: uppercase; letter-spacing: 1px;
            display: flex; align-items: center; gap: 6px;
        }
        .rp-how-toggle {
            font-size: 0.65rem; color: rgba(255,255,255,0.3); transition: transform 0.2s;
        }
        .rp-how-it-works.open .rp-how-toggle { transform: rotate(180deg); }
        .rp-how-body {
            max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
        }
        .rp-how-it-works.open .rp-how-body { max-height: 500px; }
        .rp-how-steps {
            display: flex; flex-direction: column; gap: 12px;
            padding-top: 14px;
        }
        .rp-how-step {
            display: flex; gap: 10px; align-items: flex-start;
        }
        .rp-how-step-num {
            width: 22px; height: 22px; border-radius: 50%; flex-shrink: 0;
            background: rgba(16,185,129,0.15); color: #34d399;
            display: flex; align-items: center; justify-content: center;
            font-size: 0.65rem; font-weight: 800;
        }
        .rp-how-step-text {
            font-size: 0.78rem; color: rgba(255,255,255,0.6); line-height: 1.5;
        }
        .rp-how-step-text strong { color: rgba(255,255,255,0.85); font-weight: 700; }
        .rp-how-note {
            margin-top: 12px; padding: 10px 12px; border-radius: 8px;
            background: rgba(59,130,246,0.06); border: 1px solid rgba(59,130,246,0.1);
            font-size: 0.72rem; color: rgba(255,255,255,0.45); line-height: 1.5;
        }
        .rp-how-scenarios {
            margin-top: 16px; display: flex; flex-direction: column; gap: 10px;
        }
        .rp-how-scenarios-title {
            font-size: 0.7rem; font-weight: 700; color: rgba(255,255,255,0.4);
            text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 2px;
        }
        .rp-scenario {
            padding: 12px 14px; border-radius: 10px;
            border: 1px solid rgba(255,255,255,0.06);
        }
        .rp-scenario-header {
            display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
        }
        .rp-scenario-icon {
            font-size: 0.85rem; width: 20px; text-align: center;
        }
        .rp-scenario-label {
            font-size: 0.75rem; font-weight: 700; color: rgba(255,255,255,0.8);
        }
        .rp-scenario-tag {
            font-size: 0.58rem; padding: 2px 6px; border-radius: 4px;
            font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;
            margin-left: auto;
        }
        .rp-scenario.basic { background: rgba(251,191,36,0.05); }
        .rp-scenario.basic .rp-scenario-tag { background: rgba(251,191,36,0.15); color: #fbbf24; }
        .rp-scenario.full { background: rgba(16,185,129,0.05); }
        .rp-scenario.full .rp-scenario-tag { background: rgba(16,185,129,0.15); color: #34d399; }
        .rp-scenario-desc {
            font-size: 0.72rem; color: rgba(255,255,255,0.45); line-height: 1.5;
            padding-left: 28px;
        }
        .rp-scenario-flow {
            display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
            padding-left: 28px; margin-top: 6px;
        }
        .rp-flow-step {
            font-size: 0.62rem; padding: 3px 8px; border-radius: 4px;
            background: rgba(255,255,255,0.05); color: rgba(255,255,255,0.5);
            white-space: nowrap;
        }
        .rp-flow-arrow { font-size: 0.6rem; color: rgba(255,255,255,0.2); }

        /* Contract link */
        .rp-contract-link { text-align: center; padding-top: 4px; }
        .rp-contract-link a {
            font-size: 0.62rem; color: rgba(255,255,255,0.25); text-decoration: none;
            display: inline-flex; align-items: center; gap: 4px; transition: color 0.2s;
        }
        .rp-contract-link a:hover { color: rgba(255,255,255,0.5); }

        .reward-pool-deposit-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.82rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 2px 12px rgba(16, 185, 129, 0.2);
            white-space: nowrap;
            letter-spacing: 0.3px;
            flex-shrink: 0;
        }

        .reward-pool-deposit-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(16, 185, 129, 0.35);
            background: linear-gradient(135deg, #22c55e, #10b981);
        }

        .reward-pool-deposit-btn:active {
            transform: scale(0.98);
        }

        /* Reward Pool Deposit Modal */
        .rp-deposit-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);
            z-index: 10000; display: flex; align-items: center; justify-content: center;
            animation: fadeIn 0.2s ease-out;
        }
        .rp-deposit-modal {
            background: #111; border: 1px solid rgba(16,185,129,0.15); border-radius: 16px;
            padding: 28px; width: 380px; max-width: 90vw; position: relative;
        }
        .rp-deposit-modal h3 { margin: 0 0 4px; font-size: 1.1rem; color: #fff; font-weight: 700; }
        .rp-deposit-modal .rp-subtitle { color: rgba(255,255,255,0.5); font-size: 0.78rem; margin-bottom: 20px; }
        .rp-deposit-close {
            position: absolute; top: 12px; right: 12px; background: none; border: none;
            color: rgba(255,255,255,0.4); font-size: 1.2rem; cursor: pointer; padding: 4px;
        }
        .rp-amount-presets { display: flex; gap: 8px; margin-bottom: 16px; }
        .rp-preset-btn {
            flex: 1; padding: 10px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px; color: #fff; font-weight: 600; font-size: 0.85rem; cursor: pointer;
            transition: all 0.15s;
        }
        .rp-preset-btn:hover, .rp-preset-btn.active {
            border-color: #10b981; background: rgba(16,185,129,0.1); color: #34d399;
        }
        .rp-custom-input {
            width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; color: #fff;
            font-size: 1rem; font-weight: 600; margin-bottom: 8px; box-sizing: border-box;
        }
        .rp-custom-input::placeholder { color: rgba(255,255,255,0.25); }
        .rp-custom-input:focus { outline: none; border-color: #10b981; }
        .rp-network-note {
            font-size: 0.72rem; color: rgba(255,255,255,0.35); margin-bottom: 20px;
            display: flex; align-items: center; gap: 6px;
        }
        .rp-network-note .rp-chain-badge {
            background: #2563eb; color: white; padding: 1px 6px; border-radius: 4px;
            font-weight: 700; font-size: 0.65rem; letter-spacing: 0.3px;
        }
        .rp-deposit-submit {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #10b981, #059669);
            border: none; border-radius: 12px; color: white; font-size: 0.9rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s; letter-spacing: 0.3px;
        }
        .rp-deposit-submit:hover { box-shadow: 0 4px 20px rgba(16,185,129,0.35); transform: translateY(-1px); }
        .rp-deposit-submit:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: none; }
        .rp-deposit-status {
            margin-top: 12px; padding: 10px 12px; border-radius: 8px; font-size: 0.78rem;
            display: none;
        }
        .rp-deposit-status.rp-status-error { display: block; background: rgba(239,68,68,0.1); color: #f87171; border: 1px solid rgba(239,68,68,0.15); }
        .rp-deposit-status.rp-status-success { display: block; background: rgba(16,185,129,0.1); color: #34d399; border: 1px solid rgba(16,185,129,0.15); }
        .rp-deposit-status.rp-status-pending { display: block; background: rgba(251,191,36,0.1); color: #fbbf24; border: 1px solid rgba(251,191,36,0.15); }

        @media (max-width: 768px) {
            .reward-pool-main {
                padding: 20px 16px;
            }
            .reward-pool-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 16px;
            }
            .reward-pool-actions {
                flex-direction: column;
                align-items: flex-start;
                width: 100%;
            }
            .reward-pool-share-row { align-items: flex-start; }
            .reward-pool-deposit-btn { width: 100%; }
            .reward-pool-amount { font-size: 2.2rem; }
            .reward-pool-stats { flex-wrap: wrap; }
            .reward-pool-stat { min-width: calc(50% - 4px); }
            .rp-your-rewards {
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            .rp-your-rewards > div:first-child { width: 100%; }
            .rp-claim-btn { width: 100%; text-align: center; }
            .rp-contract-link { justify-content: center; }
            .rp-how-steps { gap: 10px; }
            .rp-how-step-text { font-size: 0.74rem; }
        }

        /* Rewards View */
        .rewards-content {
            max-width: 1000px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .rewards-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .rewards-header h2 {
            font-size: 2rem;
            font-weight: 800;
            margin: 0 0 8px 0;
        }

        .rewards-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin: 0;
        }

        .rewards-pool-stats {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 32px;
            text-align: center;
        }

        .rewards-pool-main {
            margin-bottom: 24px;
        }

        .rewards-pool-label {
            display: block;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 8px;
        }

        .rewards-pool-amount {
            display: block;
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .rewards-pool-next {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .rewards-pool-details {
            display: flex;
            justify-content: center;
            gap: 40px;
            flex-wrap: wrap;
        }

        .rewards-stat {
            text-align: center;
        }

        .rewards-stat-value {
            display: block;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .rewards-stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .rewards-columns {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .rewards-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
        }

        .rewards-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }

        .rewards-card-icon {
            font-size: 2rem;
        }

        .rewards-card-header h3 {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
        }

        .rewards-card-desc {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0 0 20px 0;
            line-height: 1.5;
        }

        .rewards-donate-amounts {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 16px;
        }

        .rewards-amount-btn {
            padding: 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rewards-amount-btn:hover,
        .rewards-amount-btn.active {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .rewards-donate-custom {
            display: flex;
            align-items: center;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            padding: 0 16px;
            margin-bottom: 16px;
        }

        .rewards-input-prefix {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .rewards-donate-custom input {
            flex: 1;
            background: none;
            border: none;
            padding: 14px 12px;
            font-size: 1.1rem;
            color: var(--text-primary);
            outline: none;
        }

        .rewards-donate-custom input::placeholder {
            color: var(--text-tertiary);
        }

        .rewards-input-suffix {
            color: var(--text-tertiary);
            font-size: 0.9rem;
        }

        .rewards-donate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            margin-bottom: 24px;
        }

        .rewards-donate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.3);
        }

        .rewards-recent-donors h4,
        .rewards-contributions h4,
        .rewards-past-payouts h4 {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin: 0 0 12px 0;
            font-weight: 600;
        }

        .rewards-empty {
            color: var(--text-tertiary);
            font-size: 0.9rem;
            text-align: center;
            padding: 16px;
            margin: 0;
        }

        .rewards-donor-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9rem;
        }

        .rewards-donor-item:last-child {
            border-bottom: none;
        }

        .rewards-donor-address {
            color: var(--text-secondary);
            font-family: monospace;
        }

        .rewards-donor-amount {
            color: #22c55e;
            font-weight: 600;
        }

        .rewards-auth-prompt {
            text-align: center;
            padding: 32px 16px;
        }

        .rewards-auth-prompt p {
            color: var(--text-secondary);
            margin: 0 0 16px 0;
        }

        .rewards-connect-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .rewards-connect-btn:hover {
            transform: translateY(-2px);
        }

        .rewards-earning-box {
            background: var(--bg-dark);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            margin-bottom: 24px;
        }

        .rewards-earning-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .rewards-earning-amount {
            display: block;
            font-size: 2rem;
            font-weight: 800;
            color: #22c55e;
            margin-bottom: 4px;
        }

        .rewards-earning-rank {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .rewards-contribution-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }

        .rewards-contribution-title {
            color: var(--text-primary);
            font-weight: 500;
        }

        .rewards-contribution-share {
            color: #22c55e;
            font-weight: 600;
        }

        .rewards-payout-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid var(--border-subtle);
            font-size: 0.9rem;
        }

        .rewards-payout-item:last-child {
            border-bottom: none;
        }

        .rewards-payout-date {
            color: var(--text-secondary);
        }

        .rewards-payout-amount {
            color: #22c55e;
            font-weight: 600;
        }

        .rewards-how-it-works {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
            margin-bottom: 32px;
            text-align: center;
        }

        .rewards-how-it-works h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 20px 0;
        }

        .rewards-how-steps {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 16px;
        }

        .rewards-how-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
        }

        .rewards-how-num {
            width: 24px;
            height: 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
        }

        .rewards-how-arrow {
            color: var(--accent-primary);
            opacity: 0.5;
        }

        .rewards-how-note {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin: 0;
        }

        .rewards-top-contributors {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 28px;
        }

        .rewards-top-contributors h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 20px 0;
            text-align: center;
        }

        .rewards-contributor-row {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 14px;
            background: var(--bg-dark);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .rewards-contributor-rank {
            font-size: 1.25rem;
            min-width: 32px;
            text-align: center;
        }

        .rewards-contributor-info {
            flex: 1;
        }

        .rewards-contributor-name {
            font-weight: 600;
            color: var(--text-primary);
            display: block;
        }

        .rewards-contributor-proposals {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .rewards-contributor-payout {
            font-weight: 700;
            color: #22c55e;
        }

        @media (max-width: 768px) {
            .rewards-pool-details {
                gap: 24px;
            }
            .rewards-how-steps {
                flex-direction: column;
            }
            .rewards-how-arrow {
                transform: rotate(90deg);
            }
            .rewards-donate-amounts {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Operators Styles */
        .operators-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .operators-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .operators-header h2 {
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0;
        }

        .operators-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 4px 0 0 0;
            flex-basis: 100%;
        }

        .operators-add-btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operators-add-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .operators-filters {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .operators-filter-btn {
            padding: 8px 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operators-filter-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .operators-filter-btn.active {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }

        .operators-list {
            display: grid;
            gap: 16px;
        }

        .operators-loading {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .operator-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.2s;
        }

        .operator-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .operator-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .operator-info {
            flex: 1;
        }

        .operator-name {
            font-size: 1.2rem;
            font-weight: 700;
            margin: 0 0 4px 0;
            color: var(--text-primary);
        }

        .operator-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
        }

        .operator-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .operator-status.pending {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .operator-status.active {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
        }

        .operator-status.completed {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .operator-status.paused {
            background: rgba(156, 163, 175, 0.15);
            color: #9ca3af;
        }

        .operator-meta {
            display: flex;
            gap: 24px;
            flex-wrap: wrap;
            margin-bottom: 16px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .operator-meta-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .operator-meta-item a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .operator-meta-item a:hover {
            text-decoration: underline;
        }

        .operator-notes-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .operator-notes {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.5;
            margin: 0;
        }

        .operator-card-actions {
            display: flex;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .operator-action-btn {
            padding: 8px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operator-action-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .operator-action-btn.operator-action-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-color: transparent;
            color: white;
        }

        .operator-action-btn.operator-action-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .operator-app-link {
            color: var(--accent-primary);
            text-decoration: none;
            font-weight: 500;
        }

        .operator-app-link:hover {
            text-decoration: underline;
        }

        .operators-empty {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-tertiary);
        }

        .operators-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        /* Clients Sub-Tabs */
        .clients-sub-tabs {
            display: flex; gap: 6px; padding: 0 0 16px; margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06); overflow-x: auto;
        }
        .clients-sub-tab {
            padding: 8px 16px; border-radius: 10px; background: transparent;
            border: 1px solid transparent; color: var(--text-secondary);
            font-family: inherit; font-size: 0.85rem; font-weight: 700;
            cursor: pointer; transition: all 0.2s; white-space: nowrap;
        }
        .clients-sub-tab:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
        .clients-sub-tab.active { background: rgba(34,197,94,0.08); color: #22c55e; border-color: rgba(34,197,94,0.2); }
        .clients-sub-panel { display: none; }
        .clients-sub-panel.active { display: block; }

        /* Client Hub ported styles */
        .ch-channel-bar { display: flex; gap: 6px; margin-bottom: 16px; flex-wrap: wrap; }
        .ch-channel-btn {
            padding: 7px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08);
            background: transparent; color: var(--text-secondary); font-family: inherit;
            font-size: 0.8rem; font-weight: 700; cursor: pointer; transition: all 0.2s;
            display: inline-flex; align-items: center; gap: 6px;
        }
        .ch-channel-btn:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
        .ch-channel-btn.active { background: rgba(34,197,94,0.08); color: #22c55e; border-color: rgba(34,197,94,0.2); }
        .ch-channel-btn .ch-count { background: rgba(255,255,255,0.06); padding: 1px 7px; border-radius: 6px; font-size: 0.7rem; font-weight: 800; }
        .ch-channel-btn.active .ch-count { background: rgba(34,197,94,0.15); }
        .ch-kanban-stats { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; margin-bottom: 16px; }
        .ch-kanban-stat { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; text-align: center; }
        .ch-kanban-stat-val { font-size: 1.5rem; font-weight: 800; }
        .ch-kanban-stat-label { font-size: 0.72rem; color: var(--text-secondary); font-weight: 600; margin-top: 2px; }
        .ch-kanban-board { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; min-height: 300px; align-items: start; }
        .ch-kanban-col { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 12px; min-height: 250px; }
        .ch-kanban-col.drag-over { border-color: #22c55e; background: rgba(34,197,94,0.04); }
        .ch-kanban-col-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .ch-kanban-col-title { font-size: 0.75rem; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; display: flex; align-items: center; gap: 8px; }
        .ch-kanban-col-dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
        .ch-kanban-col-count { font-size: 0.7rem; font-weight: 800; color: var(--text-tertiary); background: rgba(255,255,255,0.05); padding: 2px 7px; border-radius: 6px; }
        .ch-kanban-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 12px; margin-bottom: 6px; cursor: grab; transition: all 0.15s; }
        .ch-kanban-card:active { cursor: grabbing; }
        .ch-kanban-card:hover { border-color: rgba(255,255,255,0.12); transform: translateY(-1px); }
        .ch-kanban-card.dragging { opacity: 0.4; transform: scale(0.96); }
        .ch-kanban-card-name { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; }
        .ch-kanban-card-biz { font-size: 0.76rem; color: var(--text-secondary); margin-bottom: 6px; }
        .ch-kanban-card-meta { display: flex; gap: 6px; align-items: center; flex-wrap: wrap; }
        .ch-kanban-card-tag { padding: 2px 7px; border-radius: 5px; font-size: 0.66rem; font-weight: 700; text-transform: uppercase; }
        .ch-kanban-card-date { font-size: 0.66rem; color: var(--text-tertiary); margin-left: auto; }
        .ch-kanban-card-rate { font-size: 0.76rem; font-weight: 700; color: #22c55e; }
        .ch-kanban-card-need { font-size: 0.74rem; color: var(--text-secondary); margin-top: 6px; padding-top: 6px; border-top: 1px solid rgba(255,255,255,0.05); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .ch-kanban-empty { text-align: center; padding: 20px 10px; color: var(--text-tertiary); font-size: 0.78rem; }
        .ch-revenue-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .ch-revenue-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; }
        .ch-revenue-card-label { font-size: 0.78rem; color: var(--text-secondary); font-weight: 600; }
        .ch-revenue-card-value { font-size: 1.4rem; font-weight: 800; margin-top: 4px; }
        .ch-revenue-table { width: 100%; border-collapse: collapse; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; overflow: hidden; }
        .ch-revenue-table th { text-align: left; padding: 10px 14px; font-size: 0.72rem; font-weight: 700; color: var(--text-tertiary); text-transform: uppercase; letter-spacing: 0.4px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .ch-revenue-table td { padding: 10px 14px; font-size: 0.85rem; border-bottom: 1px solid rgba(255,255,255,0.04); }
        .ch-revenue-table tr:last-child td { border-bottom: none; }
        .ch-revenue-table tr:hover td { background: rgba(255,255,255,0.02); }
        .ch-ads-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px; }
        .ch-ads-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .ch-ad-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; }
        .ch-ad-card:hover { border-color: rgba(255,255,255,0.1); }
        .ch-lead-filters { display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap; }
        .ch-lead-filter-btn { padding: 5px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: var(--text-secondary); font-family: inherit; font-size: 0.76rem; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .ch-lead-filter-btn:hover { background: rgba(255,255,255,0.03); }
        .ch-lead-filter-btn.active { background: rgba(34,197,94,0.08); color: #22c55e; border-color: rgba(34,197,94,0.2); }
        .ch-modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 10001; justify-content: center; align-items: center; }
        .ch-modal-overlay.show { display: flex; }
        .ch-modal { background: var(--bg-secondary, #1a1a1a); border: 1px solid rgba(255,255,255,0.1); border-radius: 16px; padding: 28px; width: 90%; max-width: 480px; max-height: 90vh; overflow-y: auto; }
        .ch-modal-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 18px; }
        .ch-form-group { margin-bottom: 12px; }
        .ch-form-label { display: block; font-size: 0.76rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.3px; }
        .ch-form-input, .ch-form-select, .ch-form-textarea { width: 100%; padding: 9px 13px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: var(--text-primary); font-family: inherit; font-size: 0.88rem; }
        .ch-form-input:focus, .ch-form-select:focus, .ch-form-textarea:focus { outline: none; border-color: #22c55e; }
        .ch-form-textarea { resize: vertical; min-height: 70px; }
        .ch-modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 16px; }
        .ch-outreach-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 18px; margin-bottom: 10px; }
        .ch-outreach-title { font-weight: 700; font-size: 0.95rem; margin-bottom: 6px; }
        .ch-outreach-body { font-size: 0.86rem; color: var(--text-secondary); line-height: 1.6; white-space: pre-wrap; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 10px; padding: 12px; }
        .ch-copy-btn { padding: 5px 12px; border-radius: 6px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.03); color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; cursor: pointer; font-family: inherit; margin-top: 8px; }
        .ch-copy-btn:hover { color: var(--text-primary); }
        @media (max-width: 1100px) { .ch-kanban-board { grid-template-columns: repeat(3, 1fr); } .ch-kanban-stats { grid-template-columns: repeat(3, 1fr); } }
        @media (max-width: 768px) { .ch-kanban-board, .ch-kanban-stats { grid-template-columns: 1fr 1fr; } .ch-ads-stats { grid-template-columns: 1fr 1fr; } .clients-sub-tabs { gap: 4px; } .clients-sub-tab { font-size: 0.78rem; padding: 6px 12px; } }
        @media (max-width: 500px) { .ch-kanban-board, .ch-kanban-stats { grid-template-columns: 1fr; } }

        /* Job Hunter Collapsible Section */
        .jh-section { margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.08); border-radius: 14px; overflow: hidden; }
        .jh-header { display: flex; align-items: center; justify-content: space-between; padding: 14px 20px; background: rgba(99,102,241,0.06); cursor: pointer; user-select: none; }
        .jh-header:hover { background: rgba(99,102,241,0.1); }
        .jh-header-left { display: flex; align-items: center; gap: 10px; }
        .jh-header-title { font-weight: 700; font-size: 1rem; }
        .jh-header-badge { font-size: 0.72rem; padding: 2px 8px; border-radius: 6px; background: rgba(99,102,241,0.12); color: #6366f1; font-weight: 700; }
        .jh-chevron { font-size: 1.1rem; color: var(--text-secondary); transition: transform 0.2s; }
        .jh-section.open .jh-chevron { transform: rotate(180deg); }
        .jh-body { display: none; padding: 0 20px 20px; }
        .jh-section.open .jh-body { display: block; }
        .jh-tabs { display: flex; gap: 4px; margin-bottom: 16px; flex-wrap: wrap; }
        .jh-tab { padding: 7px 16px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: var(--text-secondary); font-family: inherit; font-size: 0.84rem; font-weight: 600; cursor: pointer; white-space: nowrap; transition: all 0.2s; }
        .jh-tab:hover { background: rgba(255,255,255,0.03); color: var(--text-primary); }
        .jh-tab.active { background: rgba(99,102,241,0.08); color: #6366f1; border-color: rgba(99,102,241,0.2); }
        .jh-panel { display: none; }
        .jh-panel.active { display: block; }
        .jh-boards-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 14px; margin-bottom: 24px; }
        .jh-board-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 18px; transition: border-color 0.2s; }
        .jh-board-card:hover { border-color: rgba(255,255,255,0.12); }
        .jh-board-header { display: flex; align-items: center; gap: 12px; margin-bottom: 12px; }
        .jh-board-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.1rem; font-weight: 800; flex-shrink: 0; }
        .jh-board-name { font-weight: 700; font-size: 0.95rem; }
        .jh-board-desc { font-size: 0.78rem; color: var(--text-secondary); margin-top: 2px; }
        .jh-board-links { display: flex; flex-direction: column; gap: 5px; }
        .jh-board-link { display: flex; align-items: center; justify-content: space-between; padding: 7px 11px; border-radius: 8px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); text-decoration: none; color: var(--text-primary); font-size: 0.84rem; font-weight: 600; transition: all 0.15s; }
        .jh-board-link:hover { background: rgba(99,102,241,0.08); border-color: rgba(99,102,241,0.2); }
        .jh-tag { font-size: 0.68rem; padding: 2px 7px; border-radius: 5px; font-weight: 700; }
        .jh-tag-hot { background: rgba(239,68,68,0.12); color: #ef4444; }
        .jh-tag-good { background: rgba(34,197,94,0.12); color: #22c55e; }
        .jh-tag-stretch { background: rgba(59,130,246,0.12); color: #3b82f6; }
        .jh-tag-niche { background: rgba(168,85,247,0.12); color: #a855f7; }
        .jh-section-title { font-size: 1rem; font-weight: 700; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
        .jh-section-title .jh-count { font-size: 0.72rem; background: rgba(99,102,241,0.12); color: #6366f1; padding: 2px 7px; border-radius: 5px; font-weight: 700; }
        .jh-resume-box { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 14px; padding: 20px; margin-bottom: 16px; }
        .jh-resume-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 14px; }
        .jh-resume-header h4 { font-size: 0.95rem; font-weight: 700; }
        .jh-form-group { margin-bottom: 14px; }
        .jh-form-label { display: block; font-size: 0.78rem; font-weight: 700; color: var(--text-secondary); margin-bottom: 5px; text-transform: uppercase; letter-spacing: 0.4px; }
        .jh-input, .jh-textarea { width: 100%; padding: 10px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.08); background: rgba(255,255,255,0.02); color: var(--text-primary); font-family: inherit; font-size: 0.88rem; transition: border-color 0.2s; }
        .jh-input:focus, .jh-textarea:focus { outline: none; border-color: #6366f1; }
        .jh-textarea { resize: vertical; min-height: 90px; }
        .jh-ai-output { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; padding: 14px; min-height: 120px; font-size: 0.88rem; line-height: 1.7; white-space: pre-wrap; margin-top: 10px; position: relative; }
        .jh-ai-output:empty::before { content: 'AI output will appear here...'; color: var(--text-secondary); font-style: italic; }
        .jh-btn { padding: 8px 16px; border-radius: 10px; border: none; font-family: inherit; font-weight: 700; font-size: 0.84rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; gap: 6px; }
        .jh-btn-primary { background: linear-gradient(135deg, #6366f1, #a855f7); color: white; }
        .jh-btn-primary:hover { opacity: 0.9; }
        .jh-btn-sm { padding: 5px 12px; font-size: 0.78rem; }
        .jh-btn-ghost { background: transparent; color: var(--text-secondary); border: 1px solid rgba(255,255,255,0.08); padding: 5px 12px; font-size: 0.75rem; }
        .jh-btn-ghost:hover { color: var(--text-primary); }
        .jh-role-cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap: 10px; margin-bottom: 20px; }
        .jh-role-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; cursor: pointer; transition: all 0.2s; }
        .jh-role-card:hover { border-color: #6366f1; }
        .jh-role-card.selected { border-color: #6366f1; background: rgba(99,102,241,0.06); }
        .jh-role-card-title { font-weight: 700; font-size: 0.9rem; margin-bottom: 3px; }
        .jh-role-card-desc { font-size: 0.78rem; color: var(--text-secondary); line-height: 1.4; }
        .jh-pipeline-cols { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .jh-pipeline-col { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 12px; min-height: 180px; }
        .jh-pipeline-col-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.06); }
        .jh-pipeline-col-title { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .jh-pipeline-col-count { font-size: 0.7rem; padding: 2px 6px; border-radius: 5px; font-weight: 700; }
        .jh-pipeline-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 9px; padding: 10px; margin-bottom: 7px; }
        .jh-pipeline-card-company { font-weight: 700; font-size: 0.86rem; }
        .jh-pipeline-card-role { font-size: 0.76rem; color: var(--text-secondary); margin-bottom: 4px; }
        .jh-pipeline-card-date { font-size: 0.7rem; color: var(--text-secondary); }
        .jh-pipeline-card-actions { display: flex; gap: 4px; margin-top: 6px; }
        .jh-pipeline-card-actions button { padding: 3px 7px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.08); background: transparent; color: var(--text-secondary); font-family: inherit; font-size: 0.68rem; font-weight: 600; cursor: pointer; }
        .jh-pipeline-card-actions button:hover { background: rgba(99,102,241,0.08); color: #6366f1; }
        .jh-add-form { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 16px; margin-bottom: 16px; }
        .jh-add-form-row { display: grid; grid-template-columns: 1fr 1fr 1fr auto; gap: 8px; align-items: end; }
        .jh-stats-bar { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 20px; }
        .jh-stat-card { background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 14px; text-align: center; }
        .jh-stat-value { font-size: 1.5rem; font-weight: 800; }
        .jh-stat-label { font-size: 0.75rem; color: var(--text-secondary); font-weight: 600; margin-top: 3px; }
        .jh-checklist { display: flex; flex-direction: column; gap: 7px; }
        .jh-checklist-item { display: flex; align-items: flex-start; gap: 10px; padding: 12px 14px; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06); border-radius: 10px; cursor: pointer; transition: all 0.2s; }
        .jh-checklist-item:hover { border-color: rgba(255,255,255,0.12); }
        .jh-checklist-item.done { opacity: 0.5; }
        .jh-checklist-item.done .jh-checklist-title { text-decoration: line-through; }
        .jh-checklist-check { width: 20px; height: 20px; border-radius: 6px; border: 2px solid rgba(255,255,255,0.15); display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 1px; transition: all 0.2s; }
        .jh-checklist-item.done .jh-checklist-check { background: #22c55e; border-color: #22c55e; }
        .jh-checklist-check svg { display: none; }
        .jh-checklist-item.done .jh-checklist-check svg { display: block; }
        .jh-checklist-title { font-weight: 700; font-size: 0.88rem; margin-bottom: 2px; }
        .jh-checklist-desc { font-size: 0.78rem; color: var(--text-secondary); line-height: 1.4; }
        .jh-spinner { display: inline-block; width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.2); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite; }
        @media (max-width: 768px) { .jh-boards-grid { grid-template-columns: 1fr; } .jh-pipeline-cols { grid-template-columns: 1fr 1fr; } .jh-stats-bar { grid-template-columns: 1fr 1fr; } .jh-add-form-row { grid-template-columns: 1fr; } .jh-role-cards { grid-template-columns: 1fr; } }
        @media (max-width: 480px) { .jh-pipeline-cols { grid-template-columns: 1fr; } }

        /* Operator Modal */
        .operator-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }

        .operator-modal-content {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 20px;
            width: 100%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .operator-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .operator-modal-header h3 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .operator-modal-close {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: var(--bg-dark);
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operator-modal-close:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        #addOperatorForm {
            padding: 24px;
        }

        .operator-form-group {
            margin-bottom: 20px;
        }

        .operator-form-group label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .operator-form-group input,
        .operator-form-group textarea,
        .operator-form-group select {
            width: 100%;
            padding: 12px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            transition: all 0.2s;
        }

        .operator-form-group input:focus,
        .operator-form-group textarea:focus,
        .operator-form-group select:focus {
            border-color: var(--accent-primary);
        }

        .operator-form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .operator-modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            padding-top: 8px;
        }

        .operator-btn-cancel {
            padding: 12px 20px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operator-btn-cancel:hover {
            background: var(--bg-card);
        }

        .operator-btn-submit {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .operator-btn-submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        @media (max-width: 768px) {
            .operators-header {
                flex-direction: column;
                align-items: flex-start;
            }
            .operators-subtitle {
                order: 2;
            }
            .operators-add-btn {
                order: 3;
                width: 100%;
            }
        }

        /* ===== Swarm Portal Styles ===== */
        .swarm-portal-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 20px;
        }

        .swarm-portal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 24px;
        }

        .swarm-portal-header h2 {
            font-size: 1.75rem;
            font-weight: 800;
            margin: 0;
        }

        .swarm-portal-subtitle {
            color: var(--text-secondary);
            font-size: 1rem;
            margin: 4px 0 0 0;
            flex-basis: 100%;
        }

        .swarm-stats-bar {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-bottom: 28px;
        }

        .swarm-stat {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .swarm-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .swarm-stat-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .swarm-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }

        .swarm-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            margin: 0 0 16px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .swarm-register-form {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .swarm-register-form input,
        .swarm-register-form textarea {
            width: 100%;
            padding: 12px 14px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .swarm-register-form textarea {
            resize: vertical;
            min-height: 60px;
        }

        .swarm-register-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            align-self: flex-start;
        }

        .swarm-register-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .swarm-api-key-result {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid rgba(16, 185, 129, 0.3);
            border-radius: 8px;
            padding: 16px;
            margin-top: 12px;
            display: none;
        }

        .swarm-api-key-result code {
            background: rgba(0,0,0,0.3);
            padding: 4px 8px;
            border-radius: 4px;
            font-family: monospace;
            word-break: break-all;
        }

        .swarm-role-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
        }

        .swarm-role-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s;
        }

        .swarm-role-card:hover {
            border-color: var(--accent-primary);
        }

        .swarm-role-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .swarm-role-icon {
            font-size: 1.2rem;
        }

        .swarm-role-header h4 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 700;
        }

        .swarm-role-status {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .swarm-role-agent-count {
            display: block;
            margin-bottom: 2px;
        }

        .swarm-role-badge-working {
            color: #22c55e;
        }

        .swarm-role-badge-blocked {
            color: #ef4444;
        }

        .swarm-role-card {
            cursor: pointer;
        }

        .swarm-role-agents {
            margin-top: 10px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 10px;
            display: none;
        }

        .swarm-role-card.expanded .swarm-role-agents {
            display: block;
        }

        .swarm-agent-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 0.82rem;
        }

        .swarm-agent-row:last-child {
            border-bottom: none;
        }

        .swarm-agent-name {
            font-weight: 600;
            min-width: 100px;
            flex-shrink: 0;
        }

        .swarm-agent-app-select {
            padding: 4px 8px;
            background: rgba(0,0,0,0.25);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.78rem;
            font-family: inherit;
            flex: 1;
            min-width: 0;
        }

        .swarm-agent-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .swarm-agent-telos-btn {
            padding: 3px 8px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 6px;
            color: #818cf8;
            font-size: 0.72rem;
            font-weight: 600;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }

        .swarm-agent-telos-btn:hover {
            background: rgba(99, 102, 241, 0.25);
        }

        .swarm-telos-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--bg-main, #0a0a0f);
            z-index: 9999;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding: 20px;
            overflow-y: auto;
        }

        .swarm-telos-modal {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            max-width: 860px;
            width: 100%;
            padding: 28px;
            margin: 20px 0;
        }

        .swarm-telos-doc-section {
            margin-top: 20px;
            border-top: 1px solid var(--border-subtle);
            padding-top: 16px;
        }

        .swarm-telos-doc-section h4 {
            margin: 0 0 12px 0;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .swarm-telos-doc-toggle {
            background: none;
            border: 1px solid var(--border-subtle);
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 3px 10px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .swarm-telos-doc-toggle:hover {
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .swarm-telos-doc-toggle.active {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .swarm-telos-doc-content {
            background: var(--bg-main, #0d0d14);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 20px 24px;
            font-size: 0.85rem;
            line-height: 1.7;
            color: var(--text-secondary);
            max-height: 600px;
            overflow-y: auto;
        }

        .swarm-telos-doc-content h1,
        .swarm-telos-doc-content h2,
        .swarm-telos-doc-content h3,
        .swarm-telos-doc-content h4 {
            color: var(--text-primary);
            margin-top: 20px;
            margin-bottom: 8px;
        }

        .swarm-telos-doc-content h1 { font-size: 1.2rem; }
        .swarm-telos-doc-content h2 { font-size: 1.05rem; }
        .swarm-telos-doc-content h3 { font-size: 0.95rem; }

        .swarm-telos-doc-content p {
            margin: 8px 0;
        }

        .swarm-telos-doc-content ul, .swarm-telos-doc-content ol {
            padding-left: 20px;
            margin: 8px 0;
        }

        .swarm-telos-doc-content li {
            margin: 4px 0;
        }

        .swarm-telos-doc-content table {
            width: 100%;
            border-collapse: collapse;
            margin: 12px 0;
            font-size: 0.8rem;
        }

        .swarm-telos-doc-content th, .swarm-telos-doc-content td {
            border: 1px solid var(--border-subtle);
            padding: 6px 10px;
            text-align: left;
        }

        .swarm-telos-doc-content th {
            background: rgba(99, 102, 241, 0.1);
            color: var(--text-primary);
        }

        .swarm-telos-doc-content blockquote {
            border-left: 3px solid var(--accent-primary);
            padding-left: 14px;
            margin: 12px 0;
            color: var(--text-tertiary);
            font-style: italic;
        }

        .swarm-telos-doc-content code {
            background: rgba(255,255,255,0.06);
            padding: 1px 5px;
            border-radius: 4px;
            font-size: 0.82rem;
        }

        .swarm-telos-doc-content hr {
            border: none;
            border-top: 1px solid var(--border-subtle);
            margin: 16px 0;
        }

        .swarm-telos-doc-content::-webkit-scrollbar {
            width: 4px;
        }

        .swarm-telos-doc-content::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 2px;
        }

        .swarm-telos-pending {
            background: rgba(251, 191, 36, 0.08);
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            padding: 16px 20px;
            margin-bottom: 16px;
        }

        .swarm-telos-pending-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            color: #fbbf24;
        }

        .swarm-telos-pending-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .swarm-telos-pending-desc {
            font-size: 0.84rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .swarm-telos-pending-feedback {
            width: 100%;
            background: var(--bg-main, #0d0d14);
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            color: var(--text-primary);
            padding: 10px 12px;
            font-size: 0.82rem;
            font-family: inherit;
            resize: vertical;
            min-height: 60px;
            margin-bottom: 12px;
        }

        .swarm-telos-pending-feedback::placeholder {
            color: var(--text-tertiary);
        }

        .swarm-telos-pending-actions {
            display: flex;
            gap: 10px;
        }

        .swarm-telos-approve-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: none;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #22c55e;
            color: #fff;
        }

        .swarm-telos-approve-btn:hover {
            background: #16a34a;
        }

        .swarm-telos-reject-btn {
            padding: 8px 20px;
            border-radius: 8px;
            border: 1px solid rgba(239, 68, 68, 0.4);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            color: #ef4444;
        }

        .swarm-telos-reject-btn:hover {
            background: rgba(239, 68, 68, 0.1);
        }

        .swarm-telos-pending-actions .done-msg {
            padding: 8px 16px;
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
        }

        .swarm-telos-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .swarm-telos-modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .swarm-telos-modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.3rem;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }

        .swarm-telos-modal-close:hover {
            color: var(--text);
        }

        .swarm-telos-meta {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .swarm-telos-tag {
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .swarm-telos-tag-role {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .swarm-telos-tag-app {
            background: rgba(16, 185, 129, 0.15);
            color: #34d399;
        }

        .swarm-telos-tag-status {
            background: rgba(245, 158, 11, 0.15);
            color: #fbbf24;
        }

        .swarm-telos-objective {
            background: rgba(0,0,0,0.15);
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .swarm-telos-objective h4 {
            margin: 0 0 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .swarm-telos-objective p {
            margin: 0;
            line-height: 1.5;
        }

        .swarm-telos-updates {
            margin-top: 16px;
        }

        .swarm-telos-updates h4 {
            margin: 0 0 10px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .swarm-telos-update-item {
            padding: 10px 12px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            margin-bottom: 6px;
            font-size: 0.82rem;
        }

        .swarm-telos-update-time {
            color: var(--text-tertiary);
            font-size: 0.72rem;
            margin-top: 4px;
        }

        .swarm-telos-escalation {
            border-left: 3px solid #ef4444;
            padding-left: 10px;
        }

        .swarm-leaderboard {
            display: grid;
            gap: 8px;
        }

        .swarm-leaderboard-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: rgba(0,0,0,0.1);
            border-radius: 10px;
            gap: 12px;
        }

        .swarm-leaderboard-rank {
            font-weight: 800;
            font-size: 1rem;
            min-width: 28px;
            color: var(--text-tertiary);
        }

        .swarm-leaderboard-name {
            flex: 1;
            font-weight: 600;
        }

        .swarm-leaderboard-credits {
            font-weight: 700;
            color: #fbbf24;
        }

        .swarm-inbox {
            display: grid;
            gap: 10px;
        }

        .swarm-inbox-badge {
            background: #ef4444;
            color: #fff;
            font-size: 0.7rem;
            font-weight: 700;
            padding: 2px 7px;
            border-radius: 10px;
            margin-left: 8px;
            vertical-align: middle;
        }

        .swarm-inbox-item {
            background: var(--bg-main, #0d0d14);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px 18px;
            transition: border-color 0.2s;
        }

        .swarm-inbox-item.needs-action {
            border-color: rgba(251, 191, 36, 0.4);
        }

        .swarm-inbox-item.escalation {
            border-color: rgba(239, 68, 68, 0.4);
        }

        .swarm-inbox-item-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 6px;
        }

        .swarm-inbox-item-type {
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 2px 8px;
            border-radius: 6px;
        }

        .swarm-inbox-type-escalation { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .swarm-inbox-type-proposal { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .swarm-inbox-type-completion { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .swarm-inbox-type-telos { background: rgba(99, 102, 241, 0.15); color: #6366f1; }

        .swarm-inbox-item-agent {
            font-size: 0.78rem;
            color: var(--text-tertiary);
        }

        .swarm-inbox-item-title {
            font-weight: 600;
            font-size: 0.92rem;
            margin-bottom: 4px;
        }

        .swarm-inbox-item-desc {
            font-size: 0.82rem;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 10px;
        }

        .swarm-inbox-item-actions {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .swarm-inbox-item-time {
            font-size: 0.72rem;
            color: var(--text-tertiary);
            margin-left: auto;
        }

        .swarm-inbox-resolve-btn {
            padding: 5px 14px;
            border-radius: 6px;
            border: none;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .swarm-inbox-approve { background: #22c55e; color: #fff; }
        .swarm-inbox-approve:hover { background: #16a34a; }
        .swarm-inbox-reject { background: transparent; border: 1px solid rgba(239, 68, 68, 0.4); color: #ef4444; }
        .swarm-inbox-reject:hover { background: rgba(239, 68, 68, 0.1); }
        .swarm-inbox-resolve { background: rgba(99, 102, 241, 0.15); color: #6366f1; border: none; }
        .swarm-inbox-resolve:hover { background: rgba(99, 102, 241, 0.25); }
        .swarm-inbox-ack { background: rgba(34, 197, 94, 0.15); color: #22c55e; border: none; }
        .swarm-inbox-ack:hover { background: rgba(34, 197, 94, 0.25); }

        .swarm-activity-feed {
            display: grid;
            gap: 8px;
        }

        .swarm-activity-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 14px;
            background: rgba(0,0,0,0.1);
            border-radius: 8px;
            font-size: 0.85rem;
        }

        .swarm-activity-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .swarm-activity-time {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-left: auto;
            white-space: nowrap;
        }

        .swarm-api-docs {
            margin-top: 12px;
        }

        .swarm-api-docs summary {
            cursor: pointer;
            font-weight: 600;
            color: var(--text-secondary);
            padding: 8px 0;
        }

        .swarm-api-endpoint {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 12px 16px;
            margin: 8px 0;
            font-family: monospace;
            font-size: 0.8rem;
            line-height: 1.5;
        }

        .swarm-api-method {
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
        }

        .swarm-api-method-get { background: rgba(16, 185, 129, 0.2); color: #34d399; }
        .swarm-api-method-post { background: rgba(99, 102, 241, 0.2); color: #818cf8; }


        .swarm-empty {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-tertiary);
        }

        .swarm-two-col {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        @media (max-width: 768px) {
            .swarm-stats-bar {
                grid-template-columns: repeat(2, 1fr);
            }
            .swarm-two-col {
                grid-template-columns: 1fr;
            }
            .swarm-role-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Fleet Header */
        .fleet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .fleet-header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .fleet-header-left h2 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .fleet-header-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: var(--bg-main);
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .fleet-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--text-tertiary);
            transition: all 0.3s;
        }

        .fleet-status-dot.connected {
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .fleet-header-stats {
            display: flex;
            gap: 24px;
        }

        .fleet-stat {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fleet-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
            line-height: 1;
        }

        .fleet-stat-label {
            font-size: 0.7rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== Telos Chat Styles ===== */
        .telos-container {
            padding: 20px;
            display: flex;
            gap: 20px;
            justify-content: center;
            max-width: 1200px;
            margin: 0 auto;
        }

        .telos-doc-sidebar {
            width: 320px;
            flex-shrink: 0;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            display: flex;
            flex-direction: column;
            height: 600px;
            overflow: hidden;
        }

        .telos-doc-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            font-weight: 700;
            font-size: 0.95rem;
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.1), rgba(251, 191, 36, 0.05));
        }

        .telos-doc-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .telos-doc-section {
            margin-bottom: 20px;
        }

        .telos-doc-section h4 {
            margin: 0 0 8px 0;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--accent-primary);
        }

        .telos-doc-section p {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .telos-purpose {
            font-size: 1.1rem !important;
            font-weight: 700;
            color: var(--text-primary) !important;
            font-style: italic;
        }

        .telos-values-list,
        .telos-beliefs-list {
            margin: 0;
            padding: 0;
            list-style: none;
        }

        .telos-values-list li,
        .telos-beliefs-list li {
            font-size: 0.85rem;
            line-height: 1.6;
            color: var(--text-secondary);
            margin-bottom: 8px;
            padding-left: 16px;
            position: relative;
        }

        .telos-values-list li::before,
        .telos-beliefs-list li::before {
            content: "";
            position: absolute;
            left: 0;
            color: var(--accent-primary);
            font-size: 0.7rem;
        }

        /* ===== Meaning Hierarchy (skills.sh inspired) ===== */
        .meaning-hierarchy {
            display: flex;
            flex-direction: column;
            gap: 0;
            position: relative;
        }

        .meaning-level {
            position: relative;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
            margin-bottom: 2px;
        }

        .meaning-level:hover {
            transform: translateX(4px);
        }

        .meaning-level::before {
            content: '';
            position: absolute;
            left: 20px;
            bottom: -12px;
            width: 2px;
            height: 10px;
            background: linear-gradient(to bottom, currentColor, transparent);
            opacity: 0.3;
        }

        .meaning-level:last-child::before {
            display: none;
        }

        .meaning-level-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }

        .meaning-level-icon {
            font-size: 1rem;
            width: 24px;
            text-align: center;
        }

        .meaning-level-tag {
            font-size: 0.65rem;
            font-weight: 800;
            letter-spacing: 1.5px;
            text-transform: uppercase;
        }

        .meaning-level-timeframe {
            font-size: 0.6rem;
            opacity: 0.6;
            margin-left: auto;
            font-weight: 600;
        }

        .meaning-level-content {
            font-size: 0.8rem;
            line-height: 1.4;
            padding-left: 32px;
            font-weight: 500;
        }

        /* Level-specific colors - cosmic gradient */
        .meaning-level.ultimate {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.15), rgba(168, 85, 247, 0.08));
            border-left: 3px solid #8b5cf6;
            color: #a78bfa;
        }
        .meaning-level.ultimate .meaning-level-content { color: #c4b5fd; }

        .meaning-level.generational {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(96, 165, 250, 0.08));
            border-left: 3px solid #3b82f6;
            color: #60a5fa;
        }
        .meaning-level.generational .meaning-level-content { color: #93c5fd; }

        .meaning-level.mission {
            background: linear-gradient(135deg, rgba(20, 184, 166, 0.15), rgba(45, 212, 191, 0.08));
            border-left: 3px solid #14b8a6;
            color: #2dd4bf;
        }
        .meaning-level.mission .meaning-level-content { color: #5eead4; }

        .meaning-level.focus {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.15), rgba(253, 224, 71, 0.08));
            border-left: 3px solid #fbbf24;
            color: #fcd34d;
        }
        .meaning-level.focus .meaning-level-content { color: #fde68a; }

        .meaning-level.now {
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.2), rgba(251, 146, 60, 0.1));
            border-left: 3px solid #ff8c42;
            color: #fb923c;
        }
        .meaning-level.now .meaning-level-content { color: #fdba74; }

        /* Hover glow effects */
        .meaning-level.ultimate:hover { box-shadow: 0 0 20px rgba(139, 92, 246, 0.2); }
        .meaning-level.generational:hover { box-shadow: 0 0 20px rgba(59, 130, 246, 0.2); }
        .meaning-level.mission:hover { box-shadow: 0 0 20px rgba(20, 184, 166, 0.2); }
        .meaning-level.focus:hover { box-shadow: 0 0 20px rgba(251, 191, 36, 0.2); }
        .meaning-level.now:hover { box-shadow: 0 0 20px rgba(255, 140, 66, 0.25); }

        /* Core Values collapsible */
        .telos-values-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 14px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            cursor: pointer;
            margin-top: 12px;
            border: 1px solid var(--border-subtle);
            transition: all 0.2s;
        }

        .telos-values-toggle:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: var(--accent-primary);
        }

        .telos-values-toggle span:first-child {
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
        }

        .telos-values-toggle svg {
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .telos-values-toggle.expanded svg {
            transform: rotate(180deg);
        }

        .telos-values-collapsible {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .telos-values-collapsible.expanded {
            max-height: 800px;
        }

        .telos-values-inner {
            padding: 12px 0;
        }

        .telos-value-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .telos-value-icon {
            color: var(--accent-primary);
            font-size: 0.7rem;
            margin-top: 3px;
        }

        .telos-value-text strong {
            color: var(--text-primary);
        }

        /* ===== FAQ Section ===== */
        .faq-section {
            max-width: 900px;
            margin: 40px auto 0;
            padding: 0 20px 40px;
        }

        .faq-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .faq-header h2 {
            font-size: 1.8rem;
            font-weight: 800;
            margin: 0 0 8px 0;
        }

        .faq-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
            margin: 0;
        }

        .faq-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .faq-item {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s;
        }

        .faq-item:hover {
            border-color: var(--accent-primary);
        }

        .faq-question {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            gap: 16px;
        }

        .faq-question:hover {
            background: rgba(255, 140, 66, 0.05);
        }

        .faq-question svg {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
            color: var(--text-muted);
            transition: transform 0.3s;
        }

        .faq-item.expanded .faq-question svg {
            transform: rotate(180deg);
        }

        .faq-answer {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .faq-item.expanded .faq-answer {
            max-height: 500px;
        }

        .faq-answer-inner {
            padding: 0 20px 20px;
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.7;
        }

        .faq-answer-inner a {
            color: var(--accent-primary);
            text-decoration: none;
        }

        .faq-answer-inner a:hover {
            text-decoration: underline;
        }

        .faq-answer-inner ul {
            margin: 12px 0;
            padding-left: 20px;
        }

        .faq-answer-inner li {
            margin-bottom: 8px;
        }

        .faq-answer-inner code {
            background: rgba(255, 140, 66, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85rem;
        }

        .telos-chat-section {
            display: flex;
            flex-direction: column;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            height: 600px;
            flex: 1;
            min-width: 0;
        }

        @media (max-width: 900px) {
            .telos-container {
                flex-direction: column;
            }

            .telos-doc-sidebar {
                width: 100%;
                height: auto;
                max-height: 300px;
            }

            .telos-chat-section {
                height: 400px;
            }
        }

        .telos-header {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            border-bottom: 1px solid var(--border-subtle);
            background: linear-gradient(135deg, rgba(255, 140, 66, 0.15), rgba(251, 191, 36, 0.1));
        }

        .telos-avatar {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), #f59e0b);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            color: #000;
            font-weight: 700;
        }

        .telos-title h3 {
            margin: 0;
            font-size: 1.1rem;
            font-weight: 700;
        }

        .telos-title p {
            margin: 2px 0 0 0;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .telos-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .telos-message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .telos-message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .telos-message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            flex-shrink: 0;
        }

        .telos-message.assistant .telos-message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), #f59e0b);
            color: #000;
        }

        .telos-message.user .telos-message-avatar {
            background: var(--bg-main);
        }

        .telos-message-content {
            background: var(--bg-main);
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .telos-message.assistant .telos-message-content {
            background: rgba(255, 140, 66, 0.1);
            border: 1px solid rgba(255, 140, 66, 0.2);
        }

        .telos-input-area {
            padding: 16px 20px;
            border-top: 1px solid var(--border-subtle);
            background: var(--bg-main);
        }

        .telos-input-wrapper {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .telos-input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 12px 16px;
            font-size: 0.9rem;
            color: var(--text-primary);
            resize: none;
            max-height: 120px;
            font-family: inherit;
        }

        .telos-input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .telos-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--accent-primary), #f59e0b);
            color: #000;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .telos-send-btn:hover {
            transform: scale(1.05);
        }

        .telos-typing {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 8px 12px;
        }

        .telos-typing-dot {
            width: 6px;
            height: 6px;
            background: var(--accent-primary);
            border-radius: 50%;
            animation: telosBounce 1.4s infinite ease-in-out both;
        }

        .telos-typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .telos-typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes telosBounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        /* ===== Marketing Co-Pilot Styles ===== */
        .marketing-container {
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
        }

        /* Co-Pilot Layout with Sidebar */

        /* Daily Brief */
        .daily-brief-header {
            display: flex; align-items: center; justify-content: center; gap: 12px;
            padding: 8px 0 12px;
        }
        .daily-brief-nav {
            background: rgba(255,255,255,0.06); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 6px 12px; color: var(--text-secondary);
            cursor: pointer; font-size: 1rem; transition: all 0.15s;
        }
        .daily-brief-nav:hover { border-color: var(--accent-primary); color: var(--text-primary); }
        .daily-brief-date {
            font-size: 0.95rem; font-weight: 700; color: var(--text-primary);
        }
        .daily-brief-slots {
            display: flex; gap: 6px; flex-wrap: wrap; padding-bottom: 10px;
        }
        .daily-brief-slot {
            display: flex; align-items: center; gap: 4px; padding: 3px 8px;
            background: rgba(255,255,255,0.04); border: 1px solid var(--border-subtle);
            border-radius: 6px; font-size: 0.72rem; color: var(--text-tertiary);
        }
        .daily-brief-slot-icon { font-size: 0.8rem; }

        /* Weekly Overview Card */
        .weekly-overview-card {
            margin-bottom: 10px;
        }
        .weekly-overview-toggle {
            width: 100%; padding: 8px 12px; background: rgba(59,130,246,0.06);
            border: 1px solid rgba(59,130,246,0.15); border-radius: 8px;
            color: var(--text-secondary); font-size: 0.78rem; font-weight: 600;
            cursor: pointer; text-align: left; display: flex; align-items: center; gap: 6px;
            transition: all 0.15s;
        }
        .weekly-overview-toggle:hover { border-color: rgba(59,130,246,0.3); color: var(--text-primary); }
        .weekly-overview-arrow {
            margin-left: auto; font-size: 0.65rem; transition: transform 0.2s;
        }
        .weekly-overview-card.open .weekly-overview-arrow { transform: rotate(90deg); }
        .weekly-overview-body {
            display: none; margin-top: 8px; padding: 12px;
            background: rgba(59,130,246,0.04); border: 1px solid rgba(59,130,246,0.1);
            border-radius: 8px;
        }
        .weekly-overview-card.open .weekly-overview-body { display: block; }
        .weekly-overview-body table {
            width: 100%; border-collapse: collapse; font-size: 0.72rem;
        }
        .weekly-overview-body th {
            text-align: left; padding: 4px 6px; color: var(--text-tertiary);
            border-bottom: 1px solid rgba(255,255,255,0.06); font-weight: 600;
        }
        .weekly-overview-body td {
            padding: 4px 6px; color: var(--text-secondary);
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }
        .weekly-overview-body td:first-child { font-weight: 700; color: var(--text-primary); }
        .weekly-overview-today td { background: rgba(59,130,246,0.08); }
        .weekly-overview-total {
            display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;
            padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.06);
        }
        .weekly-overview-stat {
            display: flex; align-items: center; gap: 4px;
            font-size: 0.72rem; color: var(--text-tertiary);
        }
        .weekly-overview-stat strong {
            color: var(--accent-primary); font-weight: 800;
        }

        .daily-theme-input {
            width: 100%; padding: 10px 14px; background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-subtle); border-radius: 10px; color: var(--text-primary);
            font-size: 0.9rem; font-weight: 700; margin-bottom: 8px; box-sizing: border-box;
        }
        .daily-theme-input::placeholder { color: var(--text-tertiary); font-weight: 400; }
        .daily-theme-input:focus { outline: none; border-color: var(--accent-primary); }
        .daily-notes-input {
            width: 100%; padding: 12px 14px; background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-subtle); border-radius: 10px; color: var(--text-primary);
            font-size: 0.85rem; resize: vertical; margin-bottom: 10px; box-sizing: border-box;
            font-family: inherit; line-height: 1.5;
        }
        .daily-notes-input::placeholder { color: var(--text-tertiary); }
        .daily-notes-input:focus { outline: none; border-color: var(--accent-primary); }
        .daily-image-preview {
            position: relative; display: inline-block; margin-bottom: 10px;
        }
        .daily-image-preview img {
            max-width: 100%; max-height: 120px; border-radius: 8px;
            border: 1px solid var(--border-subtle);
        }
        .daily-image-remove {
            position: absolute; top: -6px; right: -6px; width: 22px; height: 22px;
            border-radius: 50%; background: #ef4444; border: none; color: #fff;
            font-size: 1rem; cursor: pointer; display: flex; align-items: center;
            justify-content: center; line-height: 1;
        }
        .daily-post-results {
            display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 12px;
        }
        @media (max-width: 900px) {
            .daily-post-results { grid-template-columns: 1fr; }
        }
        .daily-post-card {
            background: var(--bg-card); border: 1px solid var(--border-subtle);
            border-radius: 10px; padding: 12px; display: flex; flex-direction: column; gap: 8px;
        }
        .daily-post-card-header {
            display: flex; align-items: center; gap: 6px; font-size: 0.75rem;
        }
        .daily-post-card-icon { font-size: 1rem; }
        .daily-post-card-cadence { font-weight: 700; color: var(--text-primary); }
        .daily-post-card-time { color: var(--text-tertiary); margin-left: auto; }
        .daily-post-card-text {
            width: 100%; min-height: 60px; padding: 8px; background: rgba(255,255,255,0.04);
            border: 1px solid var(--border-subtle); border-radius: 6px; color: var(--text-primary);
            font-size: 0.82rem; resize: vertical; font-family: inherit; line-height: 1.4;
            box-sizing: border-box;
        }
        .daily-post-card-text:focus { outline: none; border-color: var(--accent-primary); }
        .daily-post-card-img {
            max-width: 100%; max-height: 80px; border-radius: 6px; object-fit: cover;
        }
        .daily-post-card-actions {
            display: flex; gap: 6px; flex-wrap: wrap;
        }
        .daily-post-card-actions button {
            padding: 5px 10px; border-radius: 6px; font-size: 0.72rem; font-weight: 600;
            cursor: pointer; border: 1px solid var(--border-subtle); background: rgba(255,255,255,0.05);
            color: var(--text-secondary); transition: all 0.15s;
        }
        .daily-post-card-actions button:hover { border-color: var(--accent-primary); color: var(--text-primary); }
        .daily-post-card-actions .save-btn { border-color: #22c55e; color: #22c55e; }
        .daily-post-card-actions .save-btn:hover { background: rgba(34,197,94,0.15); }
        .daily-save-all-row {
            display: flex; justify-content: center; margin-top: 12px;
        }
        .daily-save-all-btn {
            padding: 10px 28px; border-radius: 10px; font-size: 0.85rem; font-weight: 700;
            cursor: pointer; border: none; background: linear-gradient(135deg, #22c55e, #16a34a);
            color: #fff; transition: all 0.2s;
        }
        .daily-save-all-btn:hover { box-shadow: 0 4px 16px rgba(34,197,94,0.3); transform: translateY(-1px); }
        .daily-save-all-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

        /* Schedule button */
        .schedule-btn {
            background: linear-gradient(135deg, #3b82f6, #2563eb) !important;
            color: #fff !important; font-weight: 600;
        }
        .schedule-btn:hover { filter: brightness(1.15); }

        /* Post status badges */
        .daily-post-status { padding: 0 8px 6px; }
        .post-status-badge {
            display: inline-block; padding: 3px 10px; border-radius: 6px;
            font-size: 0.7rem; font-weight: 600;
        }
        .status-scheduled {
            background: rgba(59,130,246,0.15); color: #60a5fa; border: 1px solid rgba(59,130,246,0.3);
        }
        .status-posted {
            background: rgba(34,197,94,0.15); color: #4ade80; border: 1px solid rgba(34,197,94,0.3);
        }
        .status-failed {
            background: rgba(239,68,68,0.15); color: #f87171; border: 1px solid rgba(239,68,68,0.3);
        }

        .calendar-day-theme {
            font-size: 0.62rem; color: var(--accent-primary); font-weight: 600;
            white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
            max-width: 100%; padding: 0 2px; line-height: 1.3;
        }
        /* Research Prompt */
        .research-prompt-section { margin-bottom: 10px; }
        .research-prompt-toggle {
            display: flex; align-items: center; gap: 6px; width: 100%;
            background: rgba(99, 102, 241, 0.06); border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 8px; padding: 8px 12px; font-size: 0.78rem; font-weight: 600;
            color: #818cf8; cursor: pointer; transition: all 0.15s;
        }
        .research-prompt-toggle:hover { background: rgba(99, 102, 241, 0.12); }
        .research-prompt-arrow { margin-left: auto; font-size: 0.65rem; transition: transform 0.2s; }
        .research-prompt-section.open .research-prompt-arrow { transform: rotate(90deg); }
        .research-prompt-body {
            display: none; margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-subtle); border-radius: 8px;
        }
        .research-prompt-section.open .research-prompt-body { display: block; }
        .research-prompt-text {
            font-size: 0.78rem; color: var(--text-secondary); line-height: 1.6;
            white-space: pre-wrap; font-family: inherit; max-height: 300px; overflow-y: auto;
        }
        .research-prompt-copy {
            margin-top: 10px; padding: 6px 14px; border-radius: 6px; font-size: 0.75rem;
            font-weight: 600; cursor: pointer; border: 1px solid rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.1); color: #818cf8; transition: all 0.15s;
        }
        .research-prompt-copy:hover { background: rgba(99, 102, 241, 0.2); }
        /* Angles Review */
        .daily-angles-results { display: flex; flex-direction: column; gap: 8px; margin: 10px 0; }
        .daily-angle-card {
            display: flex; align-items: flex-start; gap: 10px; padding: 10px 12px;
            background: rgba(99, 102, 241, 0.06); border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 8px;
        }
        .daily-angle-badge {
            display: flex; flex-direction: column; align-items: center; gap: 2px;
            flex-shrink: 0; min-width: 50px;
        }
        .daily-angle-icon { font-size: 1.1rem; }
        .daily-angle-time { font-size: 0.65rem; color: var(--text-tertiary); }
        .daily-angle-input {
            flex: 1; background: rgba(0,0,0,0.2); border: 1px solid var(--border-subtle);
            border-radius: 6px; padding: 6px 10px; color: var(--text-primary);
            font-size: 0.82rem; font-family: inherit; line-height: 1.4; resize: none;
            min-height: 36px;
        }
        .daily-angle-input:focus { outline: none; border-color: var(--accent-primary); }
        .daily-angle-imgprompt-row {
            display: flex; align-items: flex-start; gap: 6px;
        }
        .daily-angle-imgprompt-label {
            font-size: 0.7rem; color: #818cf8; flex-shrink: 0; padding-top: 5px;
        }
        .daily-angle-imgprompt {
            flex: 1; background: rgba(99, 102, 241, 0.08); border: 1px solid rgba(99, 102, 241, 0.15);
            border-radius: 6px; padding: 5px 8px; color: #a5b4fc; font-size: 0.72rem;
            font-family: inherit; line-height: 1.4; resize: none;
        }
        .daily-angle-imgprompt:focus { outline: none; border-color: #818cf8; }
        .daily-angle-copy-btn {
            background: none; border: 1px solid rgba(99,102,241,0.2); border-radius: 6px;
            padding: 4px 8px; cursor: pointer; font-size: 0.75rem; color: #818cf8;
            flex-shrink: 0; transition: all 0.15s;
        }
        .daily-angle-copy-btn:hover { background: rgba(99,102,241,0.15); }

        /* App Highlight Picker */
        .app-highlight-picker {
            background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.15);
            border-radius: 10px; padding: 10px 14px; margin-bottom: 10px;
        }
        .app-highlight-picker-header {
            font-size: 0.82rem; font-weight: 700; color: #34d399; margin-bottom: 8px;
        }
        .app-highlight-picker-row {
            display: flex; align-items: center; gap: 8px;
        }
        .daily-app-select {
            flex: 1; padding: 8px 10px; background: rgba(0,0,0,0.3); border: 1px solid var(--border-subtle);
            border-radius: 8px; color: var(--text-primary); font-size: 0.82rem;
            font-family: inherit; cursor: pointer; appearance: menulist;
        }
        .daily-app-select:focus { outline: none; border-color: #34d399; }
        .app-highlight-count {
            font-size: 0.7rem; color: var(--text-tertiary); white-space: nowrap; flex-shrink: 0;
        }

        /* Generate Image Buttons */
        .generate-image-btn {
            display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff;
            border: none; border-radius: 8px; font-size: 0.75rem; font-weight: 600;
            cursor: pointer; font-family: inherit; transition: all 0.2s;
        }
        .generate-image-btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .generate-image-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .generate-all-images-btn {
            display: inline-flex; align-items: center; gap: 6px; padding: 8px 18px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6); color: #fff;
            border: none; border-radius: 10px; font-size: 0.8rem; font-weight: 700;
            cursor: pointer; font-family: inherit; transition: all 0.2s; margin-bottom: 10px;
        }
        .generate-all-images-btn:hover { filter: brightness(1.15); transform: translateY(-1px); }
        .generate-all-images-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .angle-image-preview {
            margin-top: 6px; position: relative;
        }
        .angle-image-loading {
            display: flex; align-items: center; justify-content: center;
            width: 100%; max-width: 280px; aspect-ratio: 1/1; border-radius: 10px;
            background: rgba(99,102,241,0.1); border: 2px dashed rgba(99,102,241,0.3);
            color: var(--text-secondary); font-size: 0.8rem;
        }
        .angle-image-loading .spinner {
            width: 24px; height: 24px; border: 3px solid rgba(99,102,241,0.2);
            border-top-color: #6366f1; border-radius: 50%;
            animation: spin 0.8s linear infinite; margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Brand Image Overlay */
        .brand-overlay-container {
            position: relative; width: 100%; max-width: 512px; aspect-ratio: 1/1;
            border-radius: 10px; overflow: hidden; background: #0a0a0a;
        }
        .brand-overlay-container img.brand-overlay-bg {
            width: 100%; height: 100%; object-fit: cover; display: block;
        }
        .brand-overlay-frame {
            position: absolute; inset: 0; pointer-events: none;
            display: flex; flex-direction: column; justify-content: flex-end;
        }
        .brand-overlay-bar {
            display: flex; align-items: center; gap: 8px; padding: 10px 14px;
            background: linear-gradient(transparent, rgba(0,0,0,0.85) 30%);
        }
        .brand-overlay-logo {
            width: 28px; height: 28px; border-radius: 6px; flex-shrink: 0;
        }
        .brand-overlay-text {
            display: flex; flex-direction: column; gap: 1px;
        }
        .brand-overlay-name {
            font-size: 0.8rem; font-weight: 800; color: #fff; letter-spacing: 0.5px;
        }
        .brand-overlay-tagline {
            font-size: 0.6rem; color: rgba(255,255,255,0.6); font-weight: 500;
        }
        .brand-overlay-url {
            margin-left: auto; font-size: 0.6rem; color: rgba(250,204,21,0.7);
            font-weight: 600;
        }

        /* Two-Column Workspace */
        .marketing-workspace {
            display: grid; grid-template-columns: 1fr 1fr; gap: 16px; padding: 16px;
        }
        @media (max-width: 900px) {
            .marketing-workspace { grid-template-columns: 1fr; }
        }

        /* Source Helpers */
        .source-helpers {
            display: flex; gap: 8px; flex-wrap: wrap; align-items: center;
        }
        .source-helper-btn {
            background: rgba(255,255,255,0.05); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 6px 12px; font-size: 0.78rem;
            color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
        }
        .source-helper-btn:hover { border-color: var(--accent-primary); color: var(--text-primary); }
        .source-helper-btn.active {
            border-color: var(--accent-primary); background: rgba(250, 204, 21, 0.1);
            color: var(--text-primary);
        }
        .source-helper-toggle {
            display: flex; align-items: center; gap: 4px; font-size: 0.78rem;
            color: var(--text-secondary); cursor: pointer;
        }
        .source-helper-toggle input { accent-color: var(--accent-primary); cursor: pointer; }
        .source-helper-panel {
            background: rgba(255,255,255,0.03); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 10px;
        }

        .marketing-col {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
        }

        .marketing-col-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
            text-align: center;
        }

        .marketing-col-icon { font-size: 1.5rem; }
        .marketing-col-header h3 { margin: 4px 0 2px; font-size: 1rem; }
        .marketing-col-header p { font-size: 0.75rem; color: var(--text-tertiary); margin: 0; }

        .marketing-col-body { padding: 16px; display: flex; flex-direction: column; gap: 12px; }

        .marketing-col-input {
            width: 100%; background: #1a1a2e; border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 10px; color: #f5f5f7; font-size: 0.85rem;
            resize: none; font-family: inherit; box-sizing: border-box;
        }
        .marketing-col-input:focus { outline: none; border-color: var(--accent-primary); }

        .marketing-github-row {
            display: flex; gap: 8px;
        }
        .marketing-github-row input {
            flex: 1; background: #1a1a2e; border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 8px 10px; color: #f5f5f7; font-size: 0.85rem;
        }
        .marketing-github-row input:focus { outline: none; border-color: var(--accent-primary); }
        .marketing-fetch-btn {
            background: var(--bg-main); border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 8px 14px; font-size: 0.85rem;
            color: var(--text-primary); cursor: pointer; transition: all 0.2s;
        }
        .marketing-fetch-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--accent-primary); }

        .github-activity-preview {
            background: var(--bg-main); border-radius: 8px; padding: 10px;
            font-size: 0.75rem; max-height: 120px; overflow-y: auto; color: var(--text-secondary);
        }
        .github-empty { color: var(--text-tertiary); font-style: italic; }
        .github-commit { margin-bottom: 6px; padding-bottom: 6px; border-bottom: 1px solid var(--border-subtle); }
        .github-commit:last-child { margin-bottom: 0; padding-bottom: 0; border-bottom: none; }
        .github-commit-msg { color: var(--text-primary); }
        .github-commit-repo { color: var(--text-tertiary); font-size: 0.7rem; }

        .marketing-app-select {
            width: 100%; background: #1a1a2e; border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 10px; color: #f5f5f7; font-size: 0.85rem;
            font-family: inherit; cursor: pointer;
        }
        .marketing-app-select:focus { outline: none; border-color: var(--accent-primary); }

        .marketing-generate-btn {
            width: 100%; padding: 10px; border: none; border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), #f97316);
            color: #000; font-weight: 700; cursor: pointer; font-size: 0.85rem;
            transition: all 0.2s;
        }
        .marketing-generate-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(255, 140, 66, 0.3); }
        .marketing-generate-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .marketing-col-output { min-height: 60px; }
        .marketing-generating { color: var(--text-tertiary); font-size: 0.85rem; font-style: italic; padding: 12px 0; }

        .marketing-post-card {
            background: #12121f; border-radius: 8px; padding: 14px;
            border: 1px solid var(--border-subtle);
        }
        .marketing-post-card .post-text {
            white-space: pre-wrap; font-size: 0.85rem; line-height: 1.5; margin-bottom: 12px;
            color: var(--text-primary);
        }
        .marketing-post-actions { display: flex; gap: 8px; }
        .marketing-post-actions button {
            flex: 1; padding: 6px 10px; border-radius: 6px; border: none;
            cursor: pointer; font-size: 0.8rem; transition: all 0.2s;
        }
        .copilot-post-btn {
            padding: 8px 14px; border-radius: 8px; font-size: 0.8rem;
            font-weight: 600; cursor: pointer; border: none; transition: all 0.2s;
        }
        .copilot-post-btn.approve { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .copilot-post-btn.approve:hover { background: rgba(34, 197, 94, 0.25); }
        .copilot-post-btn.regenerate { background: rgba(255, 140, 66, 0.15); color: var(--accent-primary); }
        .copilot-post-btn.regenerate:hover { background: rgba(255, 140, 66, 0.25); }

        .post-to-x-btn {
            background: rgba(29, 155, 240, 0.15); color: #1d9bf0;
        }
        .post-to-x-btn:hover { background: rgba(29, 155, 240, 0.25); }
        .post-to-x-btn.posting { opacity: 0.5; cursor: not-allowed; }

        /* Thread cards */
        .thread-card {
            background: #12121f; border-radius: 8px; padding: 14px;
            border: 1px solid var(--border-subtle); position: relative;
        }
        .thread-card + .thread-card { margin-top: 8px; }
        .thread-card .thread-number {
            position: absolute; top: 10px; right: 12px;
            font-size: 0.7rem; color: var(--text-tertiary); font-weight: 700;
        }
        .thread-card .post-text {
            white-space: pre-wrap; font-size: 0.85rem; line-height: 1.5;
            color: var(--text-primary); margin-bottom: 8px;
        }
        .thread-card .marketing-post-actions { display: flex; gap: 8px; }
        .thread-actions-bottom { margin-top: 12px; }

        /* Engagement column */
        .engagement-keywords-row {
            display: flex; gap: 8px;
        }
        .engagement-keywords-row input {
            flex: 1; background: #1a1a2e; border: 1px solid var(--border-subtle);
            border-radius: 8px; padding: 8px 10px; color: #f5f5f7; font-size: 0.85rem;
        }
        .engagement-keywords-row input:focus { outline: none; border-color: var(--accent-primary); }

        .engagement-tweet-list {
            max-height: 500px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px;
        }
        .engagement-tweet-card {
            background: #12121f; border-radius: 8px; padding: 12px;
            border: 1px solid var(--border-subtle);
        }
        .engagement-tweet-author {
            display: flex; align-items: center; gap: 8px; margin-bottom: 6px;
        }
        .engagement-tweet-avatar {
            width: 32px; height: 32px; border-radius: 50%; background: var(--border-subtle);
            display: flex; align-items: center; justify-content: center; font-size: 0.8rem;
        }
        .engagement-tweet-handle { font-size: 0.8rem; color: #1d9bf0; font-weight: 600; }
        .engagement-tweet-followers { font-size: 0.7rem; color: var(--text-tertiary); margin-left: auto; }
        .engagement-tweet-text {
            font-size: 0.82rem; color: var(--text-secondary); line-height: 1.4; margin-bottom: 8px;
            display: -webkit-box; -webkit-line-clamp: 3; -webkit-box-orient: vertical; overflow: hidden;
        }
        .engagement-reply-options {
            display: flex; flex-direction: column; gap: 6px; margin-top: 8px;
        }
        .engagement-reply-option {
            background: #1a1a2e; border-radius: 6px; padding: 10px;
            border: 1px solid var(--border-subtle); display: flex; align-items: flex-start; gap: 8px;
        }
        .engagement-reply-text {
            flex: 1; font-size: 0.8rem; color: var(--text-primary); line-height: 1.4;
        }
        .engagement-reply-btn {
            background: rgba(29, 155, 240, 0.15); color: #1d9bf0;
            border: none; border-radius: 6px; padding: 4px 10px; font-size: 0.75rem;
            cursor: pointer; white-space: nowrap; transition: all 0.2s;
        }
        .engagement-reply-btn:hover { background: rgba(29, 155, 240, 0.25); }

        .engagement-advanced-toggle {
            background: none; border: none; color: var(--text-tertiary); font-size: 0.78rem;
            cursor: pointer; padding: 4px 0; margin-top: 4px; transition: color 0.2s;
        }
        .engagement-advanced-toggle:hover { color: var(--text-primary); }
        .engagement-advanced-toggle.open { color: var(--accent-primary); }

        .engagement-filters {
            background: #0e0e1a; border: 1px solid var(--border-subtle); border-radius: 8px;
            padding: 12px; margin-top: 6px; display: flex; flex-direction: column; gap: 10px;
        }
        .engagement-filter-group { display: flex; flex-direction: column; gap: 4px; }
        .engagement-filter-label {
            font-size: 0.72rem; color: var(--text-tertiary); text-transform: uppercase;
            letter-spacing: 0.5px; font-weight: 600;
        }
        .engagement-filter-row {
            display: flex; gap: 12px; align-items: center; flex-wrap: wrap;
        }
        .engagement-filter-row label {
            font-size: 0.8rem; color: var(--text-secondary); display: flex; align-items: center; gap: 4px;
            cursor: pointer;
        }
        .engagement-filter-row input[type="checkbox"] {
            accent-color: var(--accent-primary); width: 14px; height: 14px; cursor: pointer;
        }
        .engagement-number-input {
            background: #1a1a2e; border: 1px solid var(--border-subtle); border-radius: 6px;
            padding: 4px 8px; color: #f5f5f7; font-size: 0.8rem; width: 60px;
        }
        .engagement-number-input:focus { outline: none; border-color: var(--accent-primary); }
        .engagement-preset-chips { display: flex; flex-wrap: wrap; gap: 6px; }
        .engagement-preset-chip {
            background: rgba(29, 155, 240, 0.1); color: #1d9bf0; border: 1px solid rgba(29, 155, 240, 0.25);
            border-radius: 20px; padding: 4px 12px; font-size: 0.75rem; cursor: pointer;
            transition: all 0.2s; white-space: nowrap;
        }
        .engagement-preset-chip:hover {
            background: rgba(29, 155, 240, 0.2); border-color: rgba(29, 155, 240, 0.5);
        }

        /* Content Calendar */
        .content-calendar {
            margin: 16px auto 0;
            max-width: 1200px;
            max-height: 900px;
            background: var(--bg-card);
            border-radius: 16px;
            border: 1px solid var(--border-subtle);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .calendar-view {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            background: var(--bg-main);
            border-bottom: 1px solid var(--border-subtle);
            flex-wrap: wrap;
            gap: 12px;
        }

        .calendar-nav {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .calendar-nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            border: 1px solid var(--border-subtle);
            background: var(--bg-card);
            color: var(--text-primary);
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .calendar-nav-btn:hover {
            background: rgba(255,255,255,0.1);
            border-color: var(--accent-primary);
        }

        .calendar-current {
            font-weight: 700;
            font-size: 1rem;
            min-width: 140px;
            text-align: center;
        }

        .calendar-view-tabs {
            display: flex;
            gap: 4px;
            background: var(--bg-card);
            padding: 4px;
            border-radius: 10px;
        }

        .calendar-view-tab {
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .calendar-view-tab:hover {
            color: var(--text-primary);
        }

        .calendar-view-tab.active {
            background: var(--accent-primary);
            color: #000;
        }

        /* Month View */
        .calendar-month-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }

        .calendar-month-header span {
            text-align: center;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-tertiary);
            padding: 8px 0;
        }

        .calendar-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
        }

        .calendar-day {
            aspect-ratio: 1;
            min-height: 80px;
            background: var(--bg-main);
            border-radius: 8px;
            padding: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
        }

        .calendar-day:hover {
            background: rgba(255,255,255,0.08);
        }

        .calendar-day.other-month {
            opacity: 0.4;
        }

        .calendar-day.today {
            border: 2px solid var(--accent-primary);
        }

        .calendar-day.selected {
            background: rgba(255, 140, 66, 0.15);
        }

        .calendar-day-number {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .calendar-day-posts {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
            overflow: hidden;
        }

        .calendar-day-post {
            font-size: 0.65rem;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-day-post.empty { background: rgba(107, 114, 128, 0.2); color: #6b7280; }
        .calendar-day-post.draft { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
        .calendar-day-post.ready { background: rgba(34, 197, 94, 0.2); color: #22c55e; }
        .calendar-day-post.posted { background: rgba(107, 114, 128, 0.15); color: #6b7280; }

        .calendar-day-more {
            font-size: 0.65rem;
            color: var(--text-tertiary);
            margin-top: auto;
        }

        /* Week View - uses existing schedule-grid styles */

        /* Day View */
        .day-view-header {
            padding: 16px 0;
            border-bottom: 1px solid var(--border-subtle);
            margin-bottom: 16px;
        }

        .day-view-date {
            font-size: 1.5rem;
            font-weight: 800;
        }

        .day-view-label {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .day-view-posts {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .day-view-post {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border-subtle);
            cursor: pointer;
            transition: all 0.2s;
        }

        .day-view-post:hover {
            border-color: var(--accent-primary);
        }

        .day-view-post-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .day-view-post-time {
            font-size: 1.1rem;
            font-weight: 700;
        }

        .day-view-post-platform {
            font-size: 1.2rem;
        }

        .day-view-post-type {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .day-view-post-status {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .day-view-post-status.empty { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
        .day-view-post-status.draft { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .day-view-post-status.ready { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .day-view-post-status.posted { background: rgba(107, 114, 128, 0.1); color: #6b7280; }

        .day-view-post-content {
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .day-view-post-content.empty {
            font-style: italic;
            color: var(--text-tertiary);
        }

        .day-view-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        @media (max-width: 768px) {
            .calendar-day {
                min-height: 60px;
                padding: 6px;
            }
            .calendar-day-number {
                font-size: 0.75rem;
            }
            .calendar-day-post {
                display: none;
            }
            .calendar-day-posts {
                justify-content: center;
                align-items: center;
            }
            .calendar-day-more {
                font-size: 0.6rem;
            }
        }

        /* Legacy styles kept for compatibility */
        .marketing-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
            flex-wrap: wrap;
            gap: 16px;
        }

        .marketing-header h3 {
            font-size: 1.3rem;
            font-weight: 800;
            margin: 0 0 8px 0;
        }

        .marketing-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin: 0;
            max-width: 600px;
        }

        .marketing-propose-btn {
            background: var(--accent-primary);
            color: #000;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .marketing-propose-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 140, 66, 0.4);
        }

        .cadences-section, .cadence-proposals-section, .content-calendar-section {
            margin-bottom: 28px;
        }

        .cadences-title {
            font-size: 1rem;
            font-weight: 700;
            margin: 0 0 16px 0;
        }

        .cadences-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 16px;
        }

        .cadence-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 18px;
            transition: all 0.3s ease;
        }

        .cadence-card:hover {
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        }

        .cadence-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 14px;
        }

        .cadence-icon {
            width: 44px;
            height: 44px;
            background: var(--bg-main);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
        }

        .cadence-meta h5 {
            margin: 0 0 2px 0;
            font-size: 0.95rem;
            font-weight: 700;
        }

        .cadence-frequency {
            font-size: 0.75rem;
            color: var(--accent-primary);
            font-weight: 600;
        }

        .cadence-status {
            margin-left: auto;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.65rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .cadence-status.active {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .cadence-status.draft {
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
        }

        .cadence-logic {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 12px;
            margin-bottom: 12px;
        }

        .logic-label {
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--accent-primary);
            text-transform: uppercase;
            margin-bottom: 4px;
        }

        .cadence-logic p {
            margin: 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .cadence-schedule {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 12px;
        }

        .cadence-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .cadence-btn {
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }

        .cadence-btn.propose {
            background: rgba(255, 140, 66, 0.15);
            color: var(--accent-primary);
        }

        .cadence-btn.propose:hover {
            background: rgba(255, 140, 66, 0.25);
        }

        .cadence-votes {
            margin-left: auto;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .cadence-proposals {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .proposal-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 14px;
        }

        .proposal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .proposal-target {
            font-weight: 700;
            font-size: 0.9rem;
        }

        .proposal-type {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.6rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .proposal-type.change {
            background: rgba(99, 102, 241, 0.15);
            color: #818cf8;
        }

        .proposal-type.new {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .proposal-content p {
            margin: 0;
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .proposal-footer {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid var(--border-subtle);
        }

        .proposal-author {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .proposal-voting {
            display: flex;
            gap: 8px;
        }

        .vote-btn {
            padding: 6px 12px;
            border-radius: 6px;
            border: none;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--bg-main);
            color: var(--text-primary);
        }

        .vote-btn:hover {
            background: var(--bg-elevated);
        }

        .calendar-week {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid var(--border-subtle);
        }

        .calendar-day {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 10px;
            min-height: 100px;
        }

        .calendar-day.weekend {
            opacity: 0.7;
        }

        .day-header {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .day-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .content-item {
            padding: 4px 6px;
            border-radius: 4px;
            font-size: 0.65rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .content-item.x {
            background: rgba(29, 161, 242, 0.12);
            color: #1da1f2;
        }

        .content-item.x.light {
            opacity: 0.6;
        }

        .content-item.linkedin {
            background: rgba(0, 119, 181, 0.12);
            color: #0077b5;
        }

        .content-item.ecosystem {
            background: rgba(34, 197, 94, 0.12);
            color: #22c55e;
        }

        .content-item.video {
            background: rgba(255, 0, 0, 0.08);
            color: #ff6b6b;
        }

        .content-item.app-highlight {
            background: rgba(255, 140, 66, 0.12);
            color: var(--accent-primary);
        }

        @media (max-width: 900px) {
            .cadences-grid {
                grid-template-columns: 1fr;
            }
            .calendar-week {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 600px) {
            .marketing-header {
                flex-direction: column;
            }
            .calendar-week, .schedule-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Generate Button */
        .marketing-generate-btn {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 10px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .marketing-generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(34, 197, 94, 0.4);
        }

        /* Content Schedule Grid */
        .content-schedule-section {
            margin-bottom: 28px;
        }

        .schedule-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 14px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .schedule-legend {
            display: flex;
            gap: 12px;
            font-size: 0.75rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .legend-item::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        .legend-item.empty::before { background: var(--bg-main); border: 1px dashed var(--border-subtle); }
        .legend-item.draft::before { background: rgba(99, 102, 241, 0.3); }
        .legend-item.ready::before { background: rgba(34, 197, 94, 0.3); }
        .legend-item.posted::before { background: rgba(107, 114, 128, 0.3); }

        .schedule-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 8px;
            background: var(--bg-card);
            border-radius: 16px;
            padding: 14px;
            border: 1px solid var(--border-subtle);
        }

        .schedule-day {
            background: var(--bg-main);
            border-radius: 10px;
            padding: 10px;
            min-height: 180px;
        }

        .schedule-day.weekend { opacity: 0.8; }

        .schedule-day-header {
            font-weight: 700;
            font-size: 0.8rem;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border-subtle);
            display: flex;
            justify-content: space-between;
        }

        .schedule-day-date {
            color: var(--text-tertiary);
            font-weight: 400;
            font-size: 0.7rem;
        }

        .schedule-posts { display: flex; flex-direction: column; gap: 6px; }

        .schedule-post {
            padding: 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
        }

        .schedule-post:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .schedule-post.empty {
            background: var(--bg-card);
            border: 1px dashed var(--border-subtle);
            color: var(--text-tertiary);
            text-align: center;
        }

        .schedule-post.empty:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .schedule-post.draft { background: rgba(99, 102, 241, 0.15); border-color: rgba(99, 102, 241, 0.3); }
        .schedule-post.ready { background: rgba(34, 197, 94, 0.15); border-color: rgba(34, 197, 94, 0.3); }
        .schedule-post.posted { background: rgba(107, 114, 128, 0.15); opacity: 0.7; }

        .schedule-post-time { font-weight: 600; margin-bottom: 2px; color: var(--text-secondary); }
        .schedule-post-type { display: flex; align-items: center; gap: 4px; }
        .schedule-post-preview { color: var(--text-tertiary); font-size: 0.65rem; margin-top: 3px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* Cadence Toggle */
        .cadences-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
        .admin-badge { background: linear-gradient(135deg, #f59e0b, #d97706); color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.7rem; font-weight: 700; }

        .cadence-toggle { position: relative; width: 44px; height: 24px; margin-left: auto; margin-right: 8px; }
        .cadence-toggle input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #374151; transition: 0.3s; border-radius: 24px; }
        .toggle-slider::before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: 0.3s; border-radius: 50%; }
        .cadence-toggle input:checked + .toggle-slider { background-color: #22c55e; }
        .cadence-toggle input:checked + .toggle-slider::before { transform: translateX(20px); }

        .cadence-card[data-active="false"] { opacity: 0.5; }
        .cadence-card[data-active="false"] .cadence-status.active { background: rgba(239, 68, 68, 0.15) !important; color: #ef4444 !important; }
        .cadence-card[data-active="false"] .cadence-status.active::after { content: ' (PAUSED)'; }

        /* Post Modal */
        .post-modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.7); z-index: 10000; align-items: center; justify-content: center; padding: 20px; }
        .post-modal-overlay.active { display: flex; }
        .post-modal { background: #1a1a2e; border-radius: 16px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; border: 1px solid rgba(255,255,255,0.15); box-shadow: 0 20px 60px rgba(0,0,0,0.6); }
        .post-modal-header { display: flex; align-items: center; gap: 12px; padding: 16px 20px; border-bottom: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; background: #1f1f35; }
        .post-modal-title { display: flex; align-items: center; gap: 8px; font-weight: 700; font-size: 1.1rem; }
        .post-modal-icon { font-size: 1.3rem; }
        .post-modal-meta { display: flex; align-items: center; gap: 10px; margin-left: auto; font-size: 0.8rem; color: var(--text-tertiary); }
        .post-status-badge { padding: 4px 10px; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .post-status-badge.ready { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .post-status-badge.posted { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
        .post-status-badge.empty { background: var(--bg-main); color: var(--text-tertiary); }
        .post-status-select { padding: 6px 10px; border-radius: 6px; border: 1px solid var(--border-subtle); background: var(--bg-main); color: var(--text-primary); font-size: 0.8rem; cursor: pointer; }
        .post-modal-close { background: none; border: none; font-size: 1.5rem; color: var(--text-tertiary); cursor: pointer; padding: 4px 8px; line-height: 1; }
        .post-modal-close:hover { color: var(--text-primary); }
        .post-modal-body { padding: 20px; background: #1a1a2e; }
        .post-cadence-info { display: flex; align-items: center; gap: 8px; margin-bottom: 16px; font-size: 0.85rem; }
        .post-cadence-label { color: var(--text-tertiary); }
        .post-content-area { margin-bottom: 16px; }
        .post-content-area label, .post-image-area label { display: block; font-size: 0.8rem; font-weight: 600; margin-bottom: 8px; color: var(--text-secondary); }
        .post-content-input { width: 100%; min-height: 150px; padding: 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.15); background: #12121f; color: #f5f5f7; font-size: 0.9rem; resize: vertical; font-family: inherit; }
        .post-content-input:focus { outline: none; border-color: var(--accent-primary); }
        .post-image-upload { display: flex; align-items: center; gap: 12px; }
        .upload-btn { padding: 10px 16px; border-radius: 8px; border: 1px dashed var(--border-subtle); background: var(--bg-main); color: var(--text-secondary); cursor: pointer; transition: all 0.2s; }
        .upload-btn:hover { border-color: var(--accent-primary); color: var(--accent-primary); }
        .image-preview { position: relative; width: 80px; height: 80px; border-radius: 8px; overflow: hidden; }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .remove-image { position: absolute; top: 4px; right: 4px; width: 20px; height: 20px; border-radius: 50%; background: rgba(0,0,0,0.7); color: white; border: none; cursor: pointer; font-size: 0.8rem; display: flex; align-items: center; justify-content: center; }
        .post-modal-actions { display: flex; gap: 8px; padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); flex-wrap: wrap; background: #1f1f35; }
        .post-action-btn { padding: 10px 16px; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; border: none; background: var(--accent-primary); color: #000; }
        .post-action-btn:hover { transform: translateY(-1px); }
        .post-action-btn.secondary { background: #12121f; color: #a0a0a0; }
        .post-action-btn.copy { background: rgba(99, 102, 241, 0.15); color: #818cf8; }
        .post-action-btn.primary { background: linear-gradient(135deg, #22c55e, #16a34a); color: white; }
        .post-proposals-section { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); background: #1a1a2e; }
        .post-proposals-section h5 { font-size: 0.9rem; margin: 0 0 12px 0; }
        .post-proposals-list { margin-bottom: 12px; }
        .no-proposals { color: var(--text-tertiary); font-size: 0.85rem; font-style: italic; }
        .propose-edit-btn { padding: 8px 14px; border-radius: 6px; background: rgba(255, 140, 66, 0.15); color: var(--accent-primary); border: none; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .propose-edit-btn:hover { background: rgba(255, 140, 66, 0.25); }

        /* AI Generation Section */
        .post-ai-section { display: flex; gap: 8px; margin-bottom: 16px; align-items: center; flex-wrap: wrap; }
        .generate-ai-btn { padding: 10px 16px; border-radius: 8px; background: linear-gradient(135deg, #8b5cf6, #6366f1); color: white; border: none; font-weight: 600; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.2s; }
        .generate-ai-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4); }
        .generate-ai-btn:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }
        .generate-ai-btn .spinner { width: 14px; height: 14px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .ai-context-input { flex: 1; min-width: 200px; padding: 10px 14px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: #12121f; color: #f5f5f7; font-size: 0.85rem; }
        .ai-context-input::placeholder { color: #6b7280; }

        /* Proposal Cards */
        .proposal-card { background: #12121f; border-radius: 10px; padding: 12px; margin-bottom: 10px; border: 1px solid rgba(255,255,255,0.1); }
        .proposal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .proposal-author { font-size: 0.8rem; color: var(--text-tertiary); }
        .proposal-votes { display: flex; gap: 8px; }
        .proposal-vote-btn { padding: 4px 10px; border-radius: 6px; border: none; font-size: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 4px; transition: all 0.2s; }
        .proposal-vote-btn.upvote { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .proposal-vote-btn.upvote:hover { background: rgba(34, 197, 94, 0.25); }
        .proposal-vote-btn.downvote { background: rgba(239, 68, 68, 0.15); color: #ef4444; }
        .proposal-vote-btn.downvote:hover { background: rgba(239, 68, 68, 0.25); }
        .proposal-content { font-size: 0.85rem; color: var(--text-primary); line-height: 1.5; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; white-space: pre-wrap; }
        .proposal-actions { display: flex; gap: 8px; margin-top: 10px; }
        .proposal-use-btn { padding: 6px 12px; border-radius: 6px; background: rgba(99, 102, 241, 0.15); color: #818cf8; border: none; font-size: 0.75rem; font-weight: 600; cursor: pointer; }
        .proposal-use-btn:hover { background: rgba(99, 102, 241, 0.25); }

        /* Propose Form */
        .propose-form { margin-top: 12px; display: none; }
        .propose-form.active { display: block; }
        .propose-textarea { width: 100%; min-height: 80px; padding: 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.15); background: #12121f; color: #f5f5f7; font-size: 0.85rem; resize: vertical; font-family: inherit; margin-bottom: 8px; }
        .propose-form-actions { display: flex; gap: 8px; }
        .propose-submit-btn { padding: 8px 14px; border-radius: 6px; background: var(--accent-primary); color: #000; border: none; font-weight: 600; font-size: 0.8rem; cursor: pointer; }
        .propose-cancel-btn { padding: 8px 14px; border-radius: 6px; background: #12121f; color: #a0a0a0; border: none; font-size: 0.8rem; cursor: pointer; }

        /* Post Now Section */
        .post-publish-section { padding: 16px 20px; border-top: 1px solid rgba(255,255,255,0.1); background: #1f1f35; }
        .post-publish-section h5 { font-size: 0.9rem; margin: 0 0 12px 0; display: flex; align-items: center; gap: 8px; }
        .publish-buttons { display: flex; gap: 10px; flex-wrap: wrap; }
        .publish-btn { padding: 12px 20px; border-radius: 10px; border: none; font-weight: 700; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
        .publish-btn:hover { transform: translateY(-2px); }
        .publish-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .publish-btn.x-btn { background: #000; color: #fff; border: 1px solid #333; }
        .publish-btn.x-btn:hover { background: #1a1a1a; }
        .publish-btn.linkedin-btn { background: #0a66c2; color: #fff; }
        .publish-btn.linkedin-btn:hover { background: #004182; }
        .publish-status { margin-top: 10px; font-size: 0.8rem; color: var(--text-tertiary); }
        .publish-status.success { color: #22c55e; }
        .publish-status.error { color: #ef4444; }

        @media (max-width: 900px) {
            .schedule-grid { grid-template-columns: repeat(2, 1fr); }
        }

        /* Agent Cards Grid */
        .fleet-agents-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            min-height: 200px;
        }

        .fleet-empty-state {
            grid-column: 1 / -1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: var(--text-tertiary);
        }

        .fleet-empty-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .fleet-empty-state h3 {
            margin: 0 0 8px;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .fleet-empty-state p {
            margin: 0;
            font-size: 0.85rem;
        }

        /* Individual Agent Card */
        .fleet-agent-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .fleet-agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fleet-agent-card.active::before {
            opacity: 1;
        }

        .fleet-agent-card.active {
            border-color: rgba(99, 102, 241, 0.3);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.1);
        }

        .fleet-agent-card.idle {
            opacity: 0.7;
        }

        .fleet-agent-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .fleet-agent-project {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .fleet-agent-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .fleet-agent-info h4 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .fleet-agent-info span {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .fleet-agent-status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .fleet-agent-status-badge.active {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
        }

        .fleet-agent-status-badge.idle {
            background: rgba(156, 163, 175, 0.15);
            color: var(--text-tertiary);
        }

        /* Agent Current Action */
        .fleet-agent-action {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 16px;
        }

        .fleet-agent-action-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }

        .fleet-agent-action-icon {
            font-size: 1.3rem;
        }

        .fleet-agent-action-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .fleet-agent-action-detail {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding-left: 34px;
            word-break: break-word;
        }

        /* Agent Timer */
        .fleet-agent-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .fleet-agent-timer {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .fleet-agent-timer-icon {
            font-size: 0.9rem;
        }

        /* Swarm Systems Diagram */
        .swarm-diagram {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .swarm-diagram-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        .swarm-diagram-header h3 {
            margin: 0;
            font-size: 1.05rem;
            font-weight: 700;
        }
        .swarm-diagram-toggle {
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border-subtle);
            color: var(--text-tertiary);
            font-size: 0.75rem;
            font-weight: 600;
            padding: 5px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
        }
        .swarm-diagram-toggle:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-secondary);
        }
        .swarm-diagram-canvas {
            position: relative;
            width: 100%;
            overflow-x: auto;
        }
        .swarm-diagram-canvas svg {
            width: 100%;
            height: auto;
            min-width: 700px;
        }
        .swarm-node {
            cursor: default;
        }
        .swarm-node rect, .swarm-node circle {
            transition: filter 0.2s;
        }
        .swarm-node:hover rect, .swarm-node:hover circle {
            filter: brightness(1.2);
        }
        .swarm-node text {
            font-family: 'Nunito', sans-serif;
        }
        .swarm-flow-line {
            stroke-dasharray: 6 4;
            animation: swarmFlowDash 1.5s linear infinite;
        }
        @keyframes swarmFlowDash {
            to { stroke-dashoffset: -20; }
        }
        .swarm-pulse {
            animation: swarmPulse 2s ease-in-out infinite;
        }
        @keyframes swarmPulse {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        .swarm-legend {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }
        .swarm-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }
        .swarm-legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 3px;
        }

        /* Stream Layout - Two Columns */
        .stream-layout {
            display: grid;
            grid-template-columns: 1fr 340px;
            gap: 20px;
            height: 100%;
            min-height: 500px;
        }

        .stream-fleet-column {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .stream-commits-column {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .stream-commits-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stream-commits-header h3 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 600;
        }

        .stream-github-link {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
            text-decoration: none;
            transition: color 0.2s;
        }

        .stream-github-link:hover {
            color: var(--accent-primary);
        }

        .stream-commits-list {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            max-height: 500px;
            transition: max-height 0.3s ease, padding 0.3s ease, opacity 0.3s ease;
        }

        .stream-commits-list.collapsed {
            max-height: 0;
            padding: 0 8px;
            opacity: 0;
            overflow: hidden;
        }

        .stream-commits-toggle {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 6px;
            transition: color 0.2s, background 0.2s;
        }

        .stream-commits-toggle:hover {
            color: var(--text-primary);
            background: var(--bg-hover);
        }

        .stream-commits-toggle svg {
            transition: transform 0.3s ease;
        }

        .stream-commits-toggle.collapsed svg {
            transform: rotate(-90deg);
        }

        .stream-commits-list::-webkit-scrollbar {
            width: 4px;
        }

        .stream-commits-list::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 2px;
        }

        .stream-commit {
            display: flex;
            gap: 10px;
            padding: 10px;
            border-radius: 8px;
            transition: background 0.2s;
            margin-bottom: 4px;
        }

        .stream-commit:hover {
            background: var(--bg-hover);
        }

        .stream-commit-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .stream-commit-icon svg {
            width: 14px;
            height: 14px;
            color: white;
        }

        .stream-commit-content {
            flex: 1;
            min-width: 0;
        }

        .stream-commit-message {
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            line-height: 1.3;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .stream-commit-message a {
            color: inherit;
            text-decoration: none;
        }

        .stream-commit-message a:hover {
            color: var(--accent-primary);
        }

        .stream-commit-meta {
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }

        .stream-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-tertiary);
        }

        .stream-loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            margin-bottom: 12px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Activity Panel below visualizer */
        .stream-activity-panel {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            overflow: hidden;
        }

        .stream-activity-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-subtle);
        }

        .stream-activity-header h3 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .stream-activity-list {
            max-height: 180px;
            overflow-y: auto;
            padding: 8px 12px;
        }

        .stream-activity-list::-webkit-scrollbar {
            width: 4px;
        }

        .stream-activity-list::-webkit-scrollbar-thumb {
            background: var(--border-subtle);
            border-radius: 2px;
        }

        @media (max-width: 900px) {
            .stream-layout {
                grid-template-columns: 1fr;
                min-height: auto;
            }

            .stream-commits-column {
                max-height: 300px;
            }
        }

        /* Fleet Stream Visualizer */
        .fleet-stream-container {
            position: relative;
            width: 100%;
            height: 500px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0a0a1a;
            border-radius: 16px;
            overflow: hidden;
        }

        .fleet-grid-bg {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image:
                linear-gradient(rgba(99, 102, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(99, 102, 241, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            animation: fleetGridMove 20s linear infinite;
        }

        @keyframes fleetGridMove {
            0% { transform: translate(0, 0); }
            100% { transform: translate(50px, 50px); }
        }

        .fleet-zones {
            position: relative;
            width: 600px;
            height: 600px;
        }

        .fleet-zone {
            position: absolute;
            border-radius: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            opacity: 0.4;
        }

        .fleet-zone.active {
            opacity: 1;
            transform: scale(1.1);
        }

        .fleet-zone-icon {
            font-size: 1.8rem;
            margin-bottom: 6px;
        }

        .fleet-zone-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: rgba(255,255,255,0.7);
        }

        .fleet-zone-read {
            width: 100px;
            height: 100px;
            top: 60px;
            left: 120px;
            background: radial-gradient(circle, rgba(34, 197, 94, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(34, 197, 94, 0.3);
        }

        .fleet-zone-write {
            width: 100px;
            height: 100px;
            top: 60px;
            right: 120px;
            background: radial-gradient(circle, rgba(249, 115, 22, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(249, 115, 22, 0.3);
        }

        .fleet-zone-search {
            width: 100px;
            height: 100px;
            top: 250px;
            left: 30px;
            background: radial-gradient(circle, rgba(59, 130, 246, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(59, 130, 246, 0.3);
        }

        .fleet-zone-terminal {
            width: 100px;
            height: 100px;
            top: 250px;
            right: 30px;
            background: radial-gradient(circle, rgba(168, 85, 247, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(168, 85, 247, 0.3);
        }

        .fleet-zone-web {
            width: 100px;
            height: 100px;
            bottom: 60px;
            left: 120px;
            background: radial-gradient(circle, rgba(236, 72, 153, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(236, 72, 153, 0.3);
        }

        .fleet-zone-agents {
            width: 100px;
            height: 100px;
            bottom: 60px;
            right: 120px;
            background: radial-gradient(circle, rgba(245, 158, 11, 0.2) 0%, transparent 70%);
            border: 2px solid rgba(245, 158, 11, 0.3);
        }

        .fleet-hub {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140px;
            height: 140px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(99, 102, 241, 0.3) 0%, rgba(99, 102, 241, 0.1) 50%, transparent 70%);
            border: 3px solid rgba(99, 102, 241, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        .fleet-hub-icon {
            font-size: 2.5rem;
            margin-bottom: 6px;
            animation: fleetPulse 2s ease-in-out infinite;
        }

        .fleet-hub-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #818cf8;
        }

        .fleet-hub-status {
            font-size: 0.65rem;
            color: rgba(255,255,255,0.5);
            margin-top: 4px;
        }

        @keyframes fleetPulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.05); opacity: 0.8; }
        }

        .fleet-connections {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .fleet-connection-line {
            stroke: rgba(99, 102, 241, 0.2);
            stroke-width: 2;
            fill: none;
        }

        .fleet-agent {
            position: absolute;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            z-index: 20;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }

        .fleet-agent.moving {
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.8);
        }

        /* Fleet activity log is now in stream-activity-panel */

        .fleet-log-entry {
            padding: 6px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .fleet-log-entry:last-child {
            border-bottom: none;
        }

        .fleet-log-icon {
            font-size: 1rem;
        }

        .fleet-log-text {
            color: rgba(255,255,255,0.8);
            flex: 1;
        }

        .fleet-log-time {
            color: rgba(255,255,255,0.3);
            font-size: 0.65rem;
        }

        .fleet-current-action {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            border: 1px solid rgba(99, 102, 241, 0.4);
            border-radius: 100px;
            padding: 12px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .fleet-current-action.visible {
            opacity: 1;
        }

        .fleet-action-icon {
            font-size: 1.4rem;
        }

        .fleet-action-text {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .fleet-action-detail {
            color: rgba(255,255,255,0.5);
            font-size: 0.8rem;
        }

        .fleet-status {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 100px;
            font-size: 0.8rem;
            z-index: 100;
        }

        .fleet-status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #ef4444;
        }

        .fleet-status-dot.connected {
            background: #22c55e;
            animation: fleetStatusPulse 2s ease-in-out infinite;
        }

        @keyframes fleetStatusPulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(34, 197, 94, 0); }
        }

        .fleet-particles {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            overflow: hidden;
        }

        .fleet-sub-agent {
            position: absolute;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #f59e0b, #f97316);
            box-shadow: 0 0 15px rgba(245, 158, 11, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            z-index: 15;
            animation: fleetSubAgentSpawn 0.5s ease-out;
        }

        @keyframes fleetSubAgentSpawn {
            0% { transform: scale(0); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }

        .fleet-title {
            position: absolute;
            bottom: 16px;
            right: 16px;
            text-align: right;
            z-index: 100;
        }

        .fleet-title h1 {
            font-size: 1.4rem;
            font-weight: 700;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 4px;
        }

        .fleet-title p {
            font-size: 0.75rem;
            color: rgba(255,255,255,0.4);
        }

        .fleet-offline-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 50;
            display: none;
        }

        .fleet-offline-message.visible {
            display: block;
        }

        .fleet-offline-message h2 {
            font-size: 1.3rem;
            margin-bottom: 10px;
            color: rgba(255,255,255,0.6);
        }

        .fleet-offline-message p {
            color: rgba(255,255,255,0.4);
            font-size: 0.85rem;
        }

        @keyframes fleetParticleFade {
            0% { opacity: 1; transform: scale(1); }
            100% { opacity: 0; transform: scale(2) translateY(-20px); }
        }

        @media (max-width: 768px) {
            .fleet-stream-container {
                height: 450px;
            }
            .fleet-zones {
                transform: scale(0.55);
            }
            .fleet-activity-log {
                width: calc(100% - 32px);
                max-height: 120px;
            }
        }

        /* Factory Submit Modal */
        .factory-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10001;
        }

        .factory-modal-overlay.active {
            display: flex;
        }

        .factory-modal-content {
            background: var(--bg-sidebar);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .factory-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .factory-modal-title {
            font-size: 1.3rem;
            font-weight: 700;
        }

        .factory-modal-close {
            background: none;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .factory-form-group {
            margin-bottom: 16px;
        }

        .factory-form-label {
            display: block;
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .factory-form-input,
        .factory-form-select,
        .factory-form-textarea {
            width: 100%;
            background: #1a1a2e;
            border: 1px solid var(--border-subtle);
            border-radius: 8px;
            padding: 12px 14px;
            color: #f5f5f7;
            font-size: 0.95rem;
            font-family: inherit;
        }

        .factory-form-select {
            appearance: none;
            -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23a0a0b0' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 14px center;
            padding-right: 36px;
            cursor: pointer;
        }

        .factory-form-select option {
            background: #1a1a2e;
            color: #f5f5f7;
            padding: 8px;
        }

        .factory-form-input:focus,
        .factory-form-select:focus,
        .factory-form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .factory-form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .factory-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .factory-modal-btn {
            flex: 1;
            padding: 12px;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .factory-modal-btn.cancel {
            background: transparent;
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        .factory-modal-btn.submit {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        .factory-modal-btn.submit:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        /* Builder Switch Confirmation Modal */
        .builder-switch-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100002;
            backdrop-filter: blur(8px);
        }

        .builder-switch-modal-overlay.active {
            display: flex;
            animation: modalFadeIn 0.2s ease;
        }

        @keyframes modalFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .builder-switch-modal {
            background: linear-gradient(145deg, rgba(30, 30, 45, 0.98), rgba(20, 20, 35, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px;
            width: 90%;
            max-width: 420px;
            text-align: center;
            animation: modalSlideUp 0.3s ease;
        }

        @keyframes modalSlideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .builder-switch-modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            background: rgba(251, 191, 36, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            color: #fbbf24;
        }

        .builder-switch-modal h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-primary);
        }

        .builder-switch-modal p {
            font-size: 0.95rem;
            color: rgba(255, 255, 255, 0.7);
            line-height: 1.6;
            margin-bottom: 24px;
        }

        .builder-switch-modal p strong {
            color: #a5b4fc;
        }

        .builder-switch-modal-actions {
            display: flex;
            gap: 12px;
        }

        .builder-switch-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .builder-switch-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .builder-switch-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .builder-switch-btn.confirm {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
        }

        .builder-switch-btn.confirm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
        }

        /* Delete Chat Confirmation Modal */
        .delete-chat-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.85);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 100002;
            backdrop-filter: blur(8px);
        }

        .delete-chat-modal-overlay.active {
            display: flex;
            animation: modalFadeIn 0.2s ease;
        }

        .delete-chat-modal {
            background: linear-gradient(145deg, rgba(30, 30, 45, 0.98), rgba(20, 20, 35, 0.98));
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 340px;
            text-align: center;
            animation: modalSlideUp 0.3s ease;
        }

        .delete-chat-modal-icon {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 16px;
            color: #f87171;
        }

        .delete-chat-modal h3 {
            font-size: 1.1rem;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .delete-chat-modal p {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.6);
            line-height: 1.5;
            margin-bottom: 20px;
        }

        .delete-chat-modal-actions {
            display: flex;
            gap: 10px;
        }

        .delete-chat-btn {
            flex: 1;
            padding: 12px 16px;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
        }

        .delete-chat-btn.cancel {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .delete-chat-btn.cancel:hover {
            background: rgba(255, 255, 255, 0.15);
        }

        .delete-chat-btn.delete {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .delete-chat-btn.delete:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
        }

        /* Factory Comments */
        .factory-comments-section {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-subtle);
        }

        .factory-comments-section.open {
            display: block;
        }

        .factory-comments-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 12px;
        }

        .factory-comment-item {
            padding: 10px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 8px;
        }

        .factory-comment-header {
            display: flex;
            justify-content: space-between;
            font-size: 0.75rem;
            margin-bottom: 6px;
        }

        .factory-comment-author {
            font-weight: 600;
            color: var(--accent-primary);
        }

        .factory-comment-time {
            color: var(--text-tertiary);
        }

        .factory-comment-content {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .factory-comment-form {
            display: flex;
            gap: 8px;
        }

        .factory-comment-input {
            flex: 1;
            padding: 8px 12px;
            background: var(--bg-dark);
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .factory-comment-submit {
            padding: 8px 16px;
            background: var(--accent-primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }

        .factory-no-comments {
            text-align: center;
            padding: 16px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .factory-comment-btn {
            background: transparent;
            border: 1px solid var(--border-subtle);
            border-radius: 6px;
            padding: 8px;
            cursor: pointer;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .factory-comment-btn:hover {
            background: var(--bg-card);
            border-color: var(--accent-primary);
        }

        .factory-comment-btn.has-comments {
            color: var(--accent-primary);
        }

        .factory-comment-delete {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: 4px;
            margin-left: auto;
            opacity: 0;
            transition: all 0.2s;
        }

        .factory-comment-item:hover .factory-comment-delete {
            opacity: 1;
        }

        .factory-comment-delete:hover {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .factory-comment-header {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        @media (max-width: 900px) {
            .factory-sidebar-panel {
                display: none;
            }

            .factory-proposals-area {
                padding: 16px;
            }
        }

        @media (max-width: 768px) {
            .factory-view-header {
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }

            .factory-main-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .factory-proposals-header {
                flex-direction: column;
                gap: 12px;
                align-items: flex-start;
            }

            .factory-section-tabs {
                width: 100%;
                overflow-x: auto;
            }

            .factory-kanban {
                grid-template-columns: 1fr;
            }

            .factory-governance-layout {
                flex-direction: column;
            }

            .factory-app-filter {
                width: 100%;
                position: static;
            }

            .factory-filter-options {
                flex-direction: row;
                flex-wrap: wrap;
                gap: 8px;
            }

            .factory-filter-option {
                padding: 8px 12px;
                flex: 0 0 auto;
            }
        }

        /* === MAIN CONTENT === */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            max-width: calc(100vw - var(--sidebar-width));
        }

        /* Background effects */
        .bg-gradient {
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            z-index: 0;
            overflow: hidden;
            pointer-events: none;
        }

        .bg-gradient::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background:
                radial-gradient(ellipse 80% 50% at 20% 40%, rgba(99, 102, 241, 0.12) 0%, transparent 50%),
                radial-gradient(ellipse 60% 40% at 80% 20%, rgba(139, 92, 246, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse 50% 60% at 40% 80%, rgba(236, 72, 153, 0.08) 0%, transparent 50%);
            animation: gradientShift 20s ease-in-out infinite alternate;
        }

        @keyframes gradientShift {
            0% { transform: translate(0, 0) rotate(0deg); }
            50% { transform: translate(2%, -2%) rotate(1deg); }
            100% { transform: translate(1%, 2%) rotate(0.5deg); }
        }

        /* Chat Area */
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 10;
            overflow-x: hidden;
            overflow-y: hidden;
            max-width: 100%;
            min-height: 0;
        }

        /* Hero/Welcome State */
        .welcome-state {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.4s ease;
            overflow-x: hidden;
            max-width: 100%;
            box-sizing: border-box;
        }

        .welcome-state.chat-active {
            padding: 0;
            justify-content: flex-start;
            align-items: stretch;
            text-align: left;
            flex: 1;
            min-height: 0;
            overflow: hidden;
        }

        /* Hide welcome content when chatting */
        .welcome-state.chat-active .welcome-title {
            display: none !important;
        }

        .welcome-state.chat-active .quick-suggestions {
            display: none !important;
        }

        /* Messages area scrollable - use flex order to appear above input */
        .welcome-state.chat-active .chat-container {
            order: 1;
            flex: 1;
            overflow: hidden;
            padding: 0;
            display: flex !important;
            flex-direction: row;
            min-height: 0;
        }

        .welcome-state.chat-active .chat-messages-wrapper {
            flex: 1;
            overflow-y: auto;
            padding: 20px 24px;
            min-width: 0;
        }

        /* Input sticks to bottom - just the input, centered */
        .welcome-state.chat-active .input-container {
            order: 2;
            flex-shrink: 0;
            max-width: 760px;
            margin: 0 auto;
            padding: 16px 24px 24px;
        }

        .welcome-title {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            letter-spacing: -0.02em;
            margin-bottom: 32px;
            background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .welcome-subtitle {
            font-size: 1rem;
            color: var(--text-secondary);
            margin-bottom: 32px;
            max-width: 480px;
            display: none; /* Hidden by default for cleaner look */
        }

        /* ========================================= */
        /* CHAT INPUT - Modern AI Style            */
        /* ========================================= */

        .input-container {
            width: 100%;
            max-width: 674px;
            position: relative;
            transition: max-width 0.3s ease;
        }

        /* Main Input Box - Welcome state: 674x122 */
        .chat-input-wrapper {
            display: flex;
            flex-direction: column;
            background: rgba(28, 28, 38, 0.9);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            padding: 16px 20px 14px;
            height: 122px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4);
            position: relative;
        }

        /* Chat active: input wrapper changes to 102px height */
        .welcome-state.chat-active .chat-input-wrapper {
            height: 102px;
            padding: 14px 20px 12px;
        }

        .chat-input-wrapper:focus-within {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        /* Textarea */
        .chat-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 1rem;
            font-family: inherit;
            color: var(--text-primary);
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 200px;
            line-height: 1.5;
            padding: 0;
            margin-bottom: 14px;
        }

        .chat-input::placeholder {
            color: var(--text-tertiary);
        }

        /* Bottom Toolbar */
        .chat-input-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-top: 8px;
        }

        /* Left Actions */
        .chat-input-actions {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chat-action-btn {
            width: 38px;
            height: 38px;
            border-radius: 10px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }

        .chat-action-btn:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .chat-action-btn svg {
            width: 20px;
            height: 20px;
        }

        /* Tools button with text label */
        .chat-action-btn-text {
            width: auto;
            padding: 0 12px;
            gap: 6px;
        }

        .chat-action-btn-label {
            font-size: 13px;
            font-weight: 500;
        }

        /* Dropdown styles for @ and Tools */
        .action-dropdown {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: #1c1c28;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 12px;
            padding: 8px;
            min-width: 220px;
            max-height: 300px;
            overflow-y: auto;
            display: none;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }

        /* When chat is active, action dropdowns open upward */
        .chat-active .action-dropdown {
            top: auto;
            bottom: calc(100% + 8px);
        }

        .action-dropdown.active {
            display: block;
        }

        .action-dropdown-section {
            margin-bottom: 8px;
        }

        .action-dropdown-section:last-child {
            margin-bottom: 0;
        }

        .action-dropdown-label {
            font-size: 11px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 6px 10px 4px;
        }

        .action-dropdown-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.15s ease;
            color: var(--text-secondary);
        }

        .action-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text-primary);
        }

        .action-dropdown-item svg {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        .action-dropdown-item-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
        }

        .action-dropdown-item-text {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .action-dropdown-item-name {
            font-size: 13px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .action-dropdown-item-desc {
            font-size: 11px;
            color: var(--text-muted);
        }

        .action-dropdown-item .pro-badge {
            margin-left: auto;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 9px;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
            text-transform: uppercase;
        }

        /* Right Side */
        .chat-input-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Model Selector */
        .model-selector {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 14px 8px 10px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .model-selector:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.18);
        }

        .model-selector-icon {
            width: 20px;
            height: 20px;
            border-radius: 5px;
            object-fit: cover;
        }

        .model-selector-icon-emoji {
            font-size: 16px;
            line-height: 1;
        }

        .model-selector-name {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .model-selector-arrow {
            width: 14px;
            height: 14px;
            color: var(--text-tertiary);
            transition: transform 0.2s;
        }

        .model-selector.active .model-selector-arrow {
            transform: rotate(180deg);
        }

        /* Send Button */
        .send-btn {
            width: 42px;
            height: 42px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .send-btn:hover:not(:disabled) {
            transform: scale(1.05);
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.5);
        }

        .send-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
            transform: none;
        }

        .send-btn svg {
            width: 18px;
            height: 18px;
        }

        /* Model Dropdown */
        .model-dropdown {
            position: absolute;
            top: calc(100% + 16px);
            right: 0;
            background: #1c1c28;
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 16px;
            padding: 8px;
            min-width: 280px;
            display: none;
            z-index: 1000;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        }

        .model-dropdown.active {
            display: block;
        }

        /* When chat is active, dropdowns open upward */
        .chat-active .model-dropdown {
            top: auto;
            bottom: calc(100% + 16px);
        }

        .model-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .model-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.06);
        }

        .model-dropdown-item.active {
            background: rgba(99, 102, 241, 0.15);
        }

        .model-dropdown-item img {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            object-fit: cover;
        }

        .model-dropdown-emoji {
            font-size: 24px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .model-dropdown-item-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .model-dropdown-item-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .model-dropdown-item-desc {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .model-pro-badge {
            font-size: 0.6rem;
            padding: 4px 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-radius: 6px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Quick Suggestions */
        .quick-suggestions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 24px;
            justify-content: center;
        }

        .suggestion-chip {
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 100px;
            color: var(--text-secondary);
            font-size: 0.875rem;
            cursor: pointer;
            transition: all 0.2s ease;
            font-family: inherit;
            font-weight: 500;
        }

        .suggestion-chip:hover {
            background: rgba(99, 102, 241, 0.12);
            border-color: rgba(99, 102, 241, 0.4);
            color: var(--text-primary);
            transform: translateY(-2px);
        }

        /* Chat Container */
        .chat-container {
            width: 100%;
            max-width: 100%;
            margin: 0 auto;
            padding: 0;
            display: none;
        }

        .chat-container.active {
            display: flex;
            flex-direction: row;
        }

        .chat-messages-wrapper {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .chat-messages {
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-x: hidden;
            max-width: 760px;
            width: 100%;
            margin: 0 auto;
            padding-bottom: 20px;
            padding-right: 12px;
        }

        /* Messages */
        .message {
            display: flex;
            gap: 14px;
            max-width: 90%;
            animation: messageSlide 0.4s ease;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(16px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
            border: 1px solid var(--border-subtle);
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
        }

        .message.assistant .message-avatar {
            background: var(--bg-card);
        }

        .message-content {
            padding: 16px 20px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.65;
            word-wrap: break-word;
            overflow-wrap: break-word;
            word-break: break-word;
            max-width: 100%;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border-bottom-right-radius: 6px;
        }

        .message.assistant .message-content {
            background: transparent;
            color: var(--text-primary);
            border: none;
            padding: 8px 0;
        }

        /* Markdown styling in chat messages */
        .message-content strong {
            font-weight: 700;
        }

        .message-content em {
            font-style: italic;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.3);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 0.85em;
        }

        .message-content pre {
            background: rgba(0, 0, 0, 0.4);
            padding: 12px 16px;
            border-radius: 8px;
            margin: 12px 0;
            overflow-x: auto;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-content h2, .message-content h3, .message-content h4 {
            margin: 16px 0 8px 0;
            font-weight: 700;
        }

        .message-content h2 { font-size: 1.2em; }
        .message-content h3 { font-size: 1.1em; }
        .message-content h4 { font-size: 1em; }

        .message-content ul {
            margin: 8px 0;
            padding-left: 20px;
        }

        .message-content li {
            margin: 4px 0;
        }

        .message.user .message-content code {
            background: rgba(255, 255, 255, 0.2);
        }

        /* App Cards in Chat */
        .app-card-inline {
            display: flex;
            align-items: center;
            gap: 16px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 16px;
            padding: 16px 20px;
            margin-top: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            color: inherit;
        }

        .app-card-inline:hover {
            background: rgba(99, 102, 241, 0.12);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
        }

        .app-icon-inline {
            width: 52px;
            height: 52px;
            border-radius: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            overflow: hidden;
            color: white;
        }

        .app-icon-inline img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 14px;
        }

        .app-icon-inline svg {
            width: 28px;
            height: 28px;
        }

        .app-info-inline h4 {
            font-size: 1rem;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .app-info-inline p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin: 0;
        }

        .app-arrow {
            margin-left: auto;
            width: 36px;
            height: 36px;
            background: rgba(99, 102, 241, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--accent-primary);
            font-size: 1.1rem;
            transition: all 0.3s ease;
        }

        .app-card-inline:hover .app-arrow {
            background: var(--accent-primary);
            color: white;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 16px 20px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-tertiary);
            border-radius: 50%;
            animation: typingBounce 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) { animation-delay: 0.15s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-10px); opacity: 1; }
        }

        /* Feedback Buttons */
        .feedback-buttons {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .feedback-btn {
            padding: 8px 14px;
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            background: transparent;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-tertiary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .feedback-btn:hover {
            background: var(--bg-card);
            border-color: var(--border-hover);
            color: var(--text-secondary);
        }

        .feedback-btn.active-good {
            background: rgba(34, 197, 94, 0.1);
            border-color: rgba(34, 197, 94, 0.3);
            color: #22c55e;
        }

        .feedback-btn.active-bad {
            background: rgba(239, 68, 68, 0.1);
            border-color: rgba(239, 68, 68, 0.3);
            color: #ef4444;
        }

        /* Quick Actions */
        .quick-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-subtle);
        }

        .quick-action-btn {
            padding: 10px 16px;
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 12px;
            background: rgba(99, 102, 241, 0.08);
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 500;
            color: var(--text-primary);
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quick-action-btn:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: var(--accent-primary);
        }

        .quick-action-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: white;
        }

        /* ========================================= */
        /* SUITEGPT INSIGHTS PANEL                  */
        /* ========================================= */

        .suitegpt-insights {
            width: 280px;
            min-width: 280px;
            background: rgba(34, 197, 94, 0.05);
            border-left: 1px solid rgba(34, 197, 94, 0.15);
            overflow-y: auto;
            transition: all 0.3s ease;
            display: none;
            flex-direction: column;
        }

        .suitegpt-insights.active {
            display: flex;
        }

        .suitegpt-insights.minimized {
            display: none;
        }

        .insights-empty-state {
            padding: 8px 0;
            color: var(--text-tertiary);
            font-size: 0.82rem;
            line-height: 1.5;
        }

        .insights-empty-state p {
            margin: 0;
        }

        .insights-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(34, 197, 94, 0.15);
            background: rgba(34, 197, 94, 0.05);
        }

        .insights-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: rgba(34, 197, 94, 1);
            letter-spacing: 0.02em;
        }

        .insights-minimize-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: rgba(34, 197, 94, 0.15);
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: rgba(34, 197, 94, 1);
            transition: all 0.2s ease;
        }

        .insights-minimize-btn:hover {
            background: rgba(34, 197, 94, 0.25);
        }

        .insights-content {
            padding: 16px;
        }

        .insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: rgba(34, 197, 94, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 14px;
        }

        .insight-icon.build-icon {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            color: #a78bfa;
        }

        .insight-icon.build-icon svg {
            stroke: #a78bfa;
        }

        .insight-text {
            flex: 1;
        }

        .insight-text p {
            margin: 0 0 8px 0;
            font-size: 0.9rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .insight-reason {
            font-size: 0.8rem !important;
            color: rgba(255, 255, 255, 0.55) !important;
            margin: 2px 0 6px 0 !important;
            line-height: 1.3;
        }

        .insights-thinking {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px;
            font-size: 0.8rem;
            color: rgba(34, 197, 94, 0.7);
        }

        .insights-thinking-dot {
            width: 5px;
            height: 5px;
            border-radius: 50%;
            background: rgba(34, 197, 94, 0.6);
            animation: insightPulse 1.2s ease-in-out infinite;
        }

        .insights-thinking-dot:nth-child(2) { animation-delay: 0.2s; }
        .insights-thinking-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes insightPulse {
            0%, 100% { opacity: 0.3; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1.2); }
        }

        .insight-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .insight-btn {
            padding: 6px 12px;
            border: 1px solid rgba(34, 197, 94, 0.3);
            border-radius: 8px;
            background: rgba(34, 197, 94, 0.1);
            color: rgba(34, 197, 94, 1);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .insight-btn:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.5);
        }

        .insight-btn.primary {
            background: rgba(34, 197, 94, 0.9);
            border: none;
            color: white;
        }

        .insight-btn.primary:hover {
            background: rgba(34, 197, 94, 1);
        }

        .insight-btn.build-btn {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
        }

        .insight-btn.build-btn:hover {
            background: linear-gradient(135deg, #7c3aed, #a78bfa);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }

        .insight-btn-dismiss {
            padding: 6px 12px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .insight-btn-dismiss:hover {
            color: var(--text-secondary);
        }

        /* Collapsed Insights Toggle Button */
        .insights-collapsed-btn {
            width: 40px;
            min-width: 40px;
            background: rgba(34, 197, 94, 0.08);
            border: none;
            border-left: 1px solid rgba(34, 197, 94, 0.15);
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: rgba(34, 197, 94, 0.8);
            transition: all 0.3s ease;
            position: relative;
            flex-direction: column;
        }

        .insights-collapsed-btn.active {
            display: flex;
        }

        .insights-collapsed-btn:hover {
            background: rgba(34, 197, 94, 0.15);
            color: rgba(34, 197, 94, 1);
        }

        .insights-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            min-width: 20px;
            height: 20px;
            border-radius: 10px;
            background: #ef4444;
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 5px;
        }

        .insights-badge:empty,
        .insights-badge[data-count="0"] {
            display: none;
        }

        /* Insights Summary (when expanded after accumulating) */
        .insights-summary {
            background: rgba(34, 197, 94, 0.05);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .insights-summary-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .insights-summary-apps,
        .insights-summary-ideas {
            margin-bottom: 12px;
        }

        .insights-summary-apps:last-child,
        .insights-summary-ideas:last-child {
            margin-bottom: 0;
        }

        .insights-summary-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 8px;
        }

        .insights-app-chip,
        .insights-idea-chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 20px;
            margin: 0 6px 6px 0;
            font-size: 0.8rem;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .insights-app-chip:hover,
        .insights-idea-chip:hover {
            background: rgba(34, 197, 94, 0.2);
            border-color: rgba(34, 197, 94, 0.4);
        }

        /* ========================================= */
        /* SUITEGPT BUILDER MODE                    */
        /* ========================================= */

        .builder-mode {
            display: none;
            position: fixed;
            top: 0;
            left: var(--sidebar-width);
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, #0a0a12 0%, #12121f 50%, #0d0d18 100%);
            z-index: 2000;
            flex-direction: column;
            overflow: hidden;
        }

        @media (max-width: 768px) {
            .builder-mode {
                left: 0;
            }
        }

        .builder-mode.active {
            display: flex;
            animation: builderFadeIn 0.4s ease;
        }

        @keyframes builderFadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* Builder Choice Screen */
        .builder-choice-screen {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            position: relative;
            z-index: 1;
        }

        .builder-choice-header {
            text-align: center;
            margin-bottom: 48px;
        }

        .builder-choice-back {
            position: absolute;
            top: 24px;
            left: 24px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 10px;
            padding: 10px 14px;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .builder-choice-back:hover {
            background: rgba(255, 255, 255, 0.12);
            color: var(--text-primary);
        }

        .builder-choice-title {
            font-size: 2.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #fff 0%, #a5b4fc 50%, #8b5cf6 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
        }

        .builder-choice-subtitle {
            font-size: 1.1rem;
            color: var(--text-tertiary);
        }

        .builder-choice-options {
            display: flex;
            gap: 20px;
            max-width: 900px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .builder-choice-card {
            flex: 1;
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 32px 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 16px;
        }

        .builder-choice-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .builder-choice-icon {
            width: 72px;
            height: 72px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 8px;
        }

        .builder-choice-icon.create {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            color: #a5b4fc;
        }

        .builder-choice-icon.idea {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            color: #fbbf24;
        }

        .builder-choice-icon.import {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
            color: #4ade80;
        }

        .builder-choice-card-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .builder-choice-card-desc {
            font-size: 0.9rem;
            color: var(--text-tertiary);
            line-height: 1.5;
        }

        @media (max-width: 640px) {
            .builder-choice-options {
                flex-direction: column;
            }

            .builder-choice-title {
                font-size: 1.8rem;
            }

            .builder-choice-back {
                top: 16px;
                left: 16px;
            }
        }

        /* Quick App Screen Styles */
        .quick-app-screen {
            display: none;
            flex-direction: column;
            align-items: center;
            padding: 40px 24px 80px;
            max-width: 600px;
            margin: 0 auto;
            overflow-y: auto;
            height: 100%;
        }

        .quick-app-screen.active {
            display: flex;
        }

        .quick-app-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .quick-app-title {
            font-size: 1.8rem;
            font-weight: 800;
            color: var(--text-primary);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .quick-app-subtitle {
            color: var(--text-tertiary);
            font-size: 1rem;
        }

        .quick-app-input-container {
            width: 100%;
            margin-bottom: 24px;
        }

        .quick-app-input {
            width: 100%;
            padding: 16px 20px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            outline: none;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .quick-app-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .quick-app-input::placeholder {
            color: var(--text-tertiary);
        }

        .create-screen-name-input {
            width: 100%;
            padding: 14px 20px;
            background: rgba(255, 255, 255, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.12);
            border-radius: 14px;
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            font-family: inherit;
            outline: none;
            transition: all 0.2s ease;
            margin-bottom: 12px;
            box-sizing: border-box;
        }

        .create-screen-name-input:focus {
            border-color: rgba(99, 102, 241, 0.5);
            background: rgba(255, 255, 255, 0.08);
        }

        .create-screen-name-input::placeholder {
            color: var(--text-tertiary);
            font-weight: 400;
        }

        .quick-app-ideas {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-bottom: 24px;
            justify-content: center;
        }

        .quick-app-idea-chip {
            padding: 8px 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-app-idea-chip:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.3);
            color: #a5b4fc;
        }

        .quick-app-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            width: 100%;
            margin-bottom: 24px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .quick-app-divider::before,
        .quick-app-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .quick-app-surprise-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            width: 100%;
            padding: 16px 24px;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(236, 72, 153, 0.2));
            border: 1px solid rgba(139, 92, 246, 0.3);
            border-radius: 14px;
            color: #c4b5fd;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quick-app-surprise-btn:hover {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.3), rgba(236, 72, 153, 0.3));
            border-color: rgba(139, 92, 246, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(139, 92, 246, 0.2);
        }

        .quick-app-surprise-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .quick-app-actions {
            display: flex;
            gap: 12px;
            width: 100%;
            margin-top: 24px;
        }

        .quick-app-back-btn {
            padding: 14px 24px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .quick-app-back-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .quick-app-build-btn {
            flex: 1;
            padding: 14px 24px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-app-build-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.3);
        }

        .quick-app-build-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .quick-app-expand-btn {
            padding: 14px 20px;
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
            border: 1px solid rgba(251, 191, 36, 0.3);
            border-radius: 12px;
            color: #fbbf24;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .quick-app-expand-btn:hover {
            background: linear-gradient(135deg, rgba(251, 191, 36, 0.3), rgba(245, 158, 11, 0.3));
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(251, 191, 36, 0.2);
        }

        .quick-app-expand-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .quick-app-expand-btn.loading {
            pointer-events: none;
        }

        .quick-app-quality {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .quick-app-quality-label {
            font-weight: 500;
        }

        .quick-app-quality-dots {
            display: flex;
            gap: 4px;
        }

        .quick-app-quality-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            transition: all 0.3s ease;
        }

        .quick-app-quality-dot.active {
            background: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.5);
        }

        .quick-app-quality-dot.active.level-1 {
            background: #f87171;
        }

        .quick-app-quality-dot.active.level-2 {
            background: #fbbf24;
        }

        .quick-app-quality-dot.active.level-3 {
            background: #4ade80;
        }

        .quick-app-quality-text {
            font-weight: 600;
            margin-left: 4px;
        }

        .quick-app-quality-text.level-1 { color: #f87171; }
        .quick-app-quality-text.level-2 { color: #fbbf24; }
        .quick-app-quality-text.level-3 { color: #4ade80; }

        /* Prompt Breakdown Cards */
        .prompt-breakdown-container {
            display: none;
            width: 100%;
            margin-top: 24px;
            animation: promptFadeIn 0.4s ease-out;
        }

        .prompt-breakdown-container.active {
            display: block;
        }

        @keyframes promptFadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .prompt-breakdown-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 14px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .prompt-breakdown-header svg {
            color: #a5b4fc;
        }

        .prompt-breakdown-header span {
            color: var(--text-tertiary);
            font-size: 0.85rem;
        }

        .prompt-breakdown-cards {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .prompt-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
        }

        .prompt-card:hover {
            border-color: rgba(255, 255, 255, 0.15);
        }

        .prompt-card.expanded {
            border-color: rgba(99, 102, 241, 0.3);
            background: rgba(99, 102, 241, 0.05);
            cursor: default;
        }

        .prompt-card-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
        }

        .prompt-card.expanded .prompt-card-header {
            padding-bottom: 0;
        }

        .prompt-card-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .prompt-card-title svg {
            width: 14px;
            height: 14px;
        }

        .prompt-card-title.features svg { color: #60a5fa; }
        .prompt-card-title.design svg { color: #f472b6; }
        .prompt-card-title.interactions svg { color: #fbbf24; }

        .prompt-card-toggle {
            margin-left: auto;
            color: var(--text-tertiary);
            transition: transform 0.2s ease;
            flex-shrink: 0;
        }

        .prompt-card.expanded .prompt-card-toggle {
            transform: rotate(180deg);
        }

        .prompt-card-preview {
            padding: 0 14px 10px;
            font-size: 0.85rem;
            color: var(--text-tertiary);
            line-height: 1.5;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .prompt-card.expanded .prompt-card-preview {
            display: none;
        }

        .prompt-card-body {
            display: none;
            padding: 8px 14px 12px;
        }

        .prompt-card.expanded .prompt-card-body {
            display: block;
        }

        .prompt-card-textarea {
            width: 100%;
            padding: 8px 0;
            background: none;
            border: none;
            border-bottom: 1px solid transparent;
            color: var(--text-primary);
            font-size: 0.9rem;
            line-height: 1.6;
            resize: none;
            outline: none;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: text;
        }

        .prompt-card-textarea:focus {
            border-bottom-color: rgba(99, 102, 241, 0.3);
        }

        .prompt-card-textarea::placeholder {
            color: var(--text-tertiary);
        }

        .prompt-card-textarea.loading {
            color: var(--text-tertiary);
            font-style: italic;
        }

        .prompt-card-preview.loading {
            color: var(--text-tertiary);
        }

        .prompt-card-preview.loading::after {
            content: '';
            animation: promptDots 1.4s steps(4, end) infinite;
        }

        @keyframes promptDots {
            0%   { content: ''; }
            25%  { content: '.'; }
            50%  { content: '..'; }
            75%  { content: '...'; }
            100% { content: ''; }
        }

        /* Build Progress Overlay */
        .build-progress-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(20px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            animation: buildOverlayIn 0.3s ease-out;
        }

        @keyframes buildOverlayIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .build-progress-content {
            text-align: center;
            max-width: 400px;
            padding: 0 24px;
        }

        .build-progress-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 28px;
            border-radius: 24px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            animation: buildPulse 2s ease-in-out infinite;
        }

        @keyframes buildPulse {
            0%, 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(99, 102, 241, 0.3); }
            50% { transform: scale(1.05); box-shadow: 0 0 40px 10px rgba(99, 102, 241, 0.15); }
        }

        .build-progress-icon svg {
            color: #a5b4fc;
            animation: buildIconSpin 3s linear infinite;
        }

        @keyframes buildIconSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .build-progress-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .build-progress-step {
            font-size: 1rem;
            color: #a5b4fc;
            margin-bottom: 32px;
            min-height: 1.5em;
            transition: opacity 0.3s ease;
        }

        .build-progress-step.fading {
            opacity: 0;
        }

        .build-progress-bar-track {
            width: 100%;
            height: 4px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .build-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #6366f1, #8b5cf6, #a78bfa);
            border-radius: 4px;
            transition: width 0.8s ease;
            position: relative;
        }

        .build-progress-bar::after {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: buildShimmer 1.5s ease-in-out infinite;
        }

        @keyframes buildShimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .build-progress-steps {
            display: flex;
            flex-direction: column;
            gap: 12px;
            text-align: left;
        }

        .build-step-item {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 0.9rem;
            color: var(--text-tertiary);
            transition: all 0.3s ease;
        }

        .build-step-item.active {
            color: #a5b4fc;
        }

        .build-step-item.done {
            color: #4ade80;
        }

        .build-step-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: all 0.3s ease;
        }

        .build-step-item.active .build-step-dot {
            background: rgba(99, 102, 241, 0.2);
            box-shadow: 0 0 12px rgba(99, 102, 241, 0.3);
        }

        .build-step-item.done .build-step-dot {
            background: rgba(74, 222, 128, 0.2);
        }

        .build-step-dot svg {
            width: 14px;
            height: 14px;
        }

        .build-step-item.active .build-step-dot svg {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Multi-Step Build Log */
        .build-log-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .build-log-header {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .build-log-header-icon {
            width: 32px;
            height: 32px;
            border-radius: 10px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a5b4fc;
        }

        .build-log-step {
            display: flex;
            gap: 12px;
            padding: 14px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .build-log-step:last-child {
            border-bottom: none;
        }

        .build-log-step-icon {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        .build-log-step.pending .build-log-step-icon {
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: rgba(255, 255, 255, 0.15);
        }

        .build-log-step.active .build-log-step-icon {
            border: 2px solid #a78bfa;
            color: #a78bfa;
            box-shadow: 0 0 12px rgba(167, 139, 250, 0.3);
            animation: buildLogPulse 1.5s ease-in-out infinite;
        }

        @keyframes buildLogPulse {
            0%, 100% { box-shadow: 0 0 8px rgba(167, 139, 250, 0.2); }
            50% { box-shadow: 0 0 16px rgba(167, 139, 250, 0.5); }
        }

        .build-log-step.done .build-log-step-icon {
            background: rgba(16, 185, 129, 0.2);
            border: 2px solid #10b981;
            color: #10b981;
        }

        .build-log-step.error .build-log-step-icon {
            background: rgba(248, 113, 113, 0.2);
            border: 2px solid #f87171;
            color: #f87171;
        }

        .build-log-step-content {
            flex: 1;
            min-width: 0;
        }

        .build-log-step-title {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 0.9rem;
            transition: color 0.3s ease;
        }

        .build-log-step.pending .build-log-step-title {
            color: var(--text-tertiary);
        }

        .build-log-step.active .build-log-step-title {
            color: #c4b5fd;
        }

        .build-log-step.done .build-log-step-title {
            color: #6ee7b7;
        }

        .build-log-step-desc {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-top: 4px;
            line-height: 1.4;
        }

        .build-log-step.pending .build-log-step-desc {
            color: var(--text-tertiary);
            opacity: 0.5;
        }

        .build-log-step-reasoning {
            color: var(--text-tertiary);
            font-size: 0.75rem;
            margin-top: 6px;
            font-style: italic;
            max-height: 80px;
            overflow: hidden;
            line-height: 1.4;
            animation: fadeInReasoning 0.3s ease;
        }

        @keyframes fadeInReasoning {
            from { opacity: 0; transform: translateY(-4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .build-log-summary {
            background: rgba(16, 185, 129, 0.08);
            border: 1px solid rgba(16, 185, 129, 0.2);
            border-radius: 12px;
            padding: 14px 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .build-log-summary:hover {
            background: rgba(16, 185, 129, 0.12);
        }

        .build-log-summary-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-weight: 600;
            color: #6ee7b7;
            font-size: 0.85rem;
        }

        .build-log-summary-chevron {
            transition: transform 0.2s ease;
        }

        .build-log-summary.expanded .build-log-summary-chevron {
            transform: rotate(180deg);
        }

        .build-log-summary-steps {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid rgba(16, 185, 129, 0.15);
        }

        .build-log-summary.expanded .build-log-summary-steps {
            display: block;
        }

        .build-log-summary-step {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 4px 0;
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .build-log-building-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-tertiary);
            gap: 12px;
        }

        .build-log-building-placeholder svg {
            animation: buildIconSpin 3s linear infinite;
            color: #a5b4fc;
        }

        /* Refinement Suggestions */
        .refinement-suggestions {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 4px;
        }

        .refinement-card {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(99, 102, 241, 0.08);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .refinement-card:hover {
            background: rgba(99, 102, 241, 0.15);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .refinement-card-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .refinement-card-icon.ux { background: rgba(96, 165, 250, 0.15); color: #60a5fa; }
        .refinement-card-icon.polish { background: rgba(244, 114, 182, 0.15); color: #f472b6; }
        .refinement-card-icon.feature { background: rgba(74, 222, 128, 0.15); color: #4ade80; }
        .refinement-card-icon.perf { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
        .refinement-card-icon.a11y { background: rgba(167, 139, 250, 0.15); color: #a78bfa; }

        .refinement-card-icon svg {
            width: 14px;
            height: 14px;
        }

        .refinement-card-text {
            flex: 1;
            min-width: 0;
        }

        .refinement-card-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .refinement-card-desc {
            font-size: 0.78rem;
            color: var(--text-tertiary);
            line-height: 1.4;
        }

        .refinement-card-apply {
            font-size: 0.7rem;
            color: #a5b4fc;
            font-weight: 500;
            flex-shrink: 0;
            align-self: center;
        }

        .suggest-refinements-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: rgba(139, 92, 246, 0.12);
            border: 1px solid rgba(139, 92, 246, 0.25);
            border-radius: 10px;
            color: #c4b5fd;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .suggest-refinements-btn:hover {
            background: rgba(139, 92, 246, 0.2);
            border-color: rgba(139, 92, 246, 0.4);
        }

        .suggest-refinements-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .suggest-refinements-btn svg {
            width: 16px;
            height: 16px;
        }

        /* Full Build choice cards */
        .builder-choice-icon.quick {
            background: linear-gradient(135deg, rgba(34, 197, 94, 0.2), rgba(16, 185, 129, 0.2));
            color: #4ade80;
        }

        .builder-choice-icon.full {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.2));
            color: #a5b4fc;
        }

        /* Proposal Mode Styles */
        .proposal-app-selector {
            margin-top: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            overflow: hidden;
            max-width: 600px;
        }

        .proposal-app-search {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            color: var(--text-tertiary);
        }

        .proposal-app-search input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
        }

        .proposal-app-search input::placeholder {
            color: var(--text-tertiary);
        }

        .proposal-app-list {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 8px;
            padding: 12px;
            max-height: 320px;
            overflow-y: auto;
        }

        .proposal-app-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 10px 4px;
            background: none;
            border: none;
            border-radius: 10px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .proposal-app-item:hover {
            background: rgba(99, 102, 241, 0.15);
            color: var(--text-primary);
            transform: scale(1.05);
        }

        .proposal-app-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .proposal-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .proposal-app-name {
            font-size: 0.7rem;
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        @media (max-width: 600px) {
            .proposal-app-list {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        @media (max-width: 400px) {
            .proposal-app-list {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .proposal-selected-app {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.3);
            padding: 8px 14px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .proposal-selected-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .proposal-selected-name {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4ade80;
        }

        .builder-hint-text {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 12px;
            font-style: italic;
        }

        /* Proposal Split View */
        .proposal-split-view {
            display: flex;
            flex: 1;
            overflow: hidden;
            position: relative;
            z-index: 1;
        }

        .proposal-app-preview {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #0a0a12 0%, #12121f 100%);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
            padding: 20px;
            overflow: hidden;
        }

        .proposal-phone-frame {
            position: relative;
            width: 320px;
            height: 620px;
            min-width: 260px;
            min-height: 480px;
            background: #1a1a2e;
            border-radius: 44px;
            padding: 10px;
            box-shadow:
                0 0 0 2px #2a2a3e,
                0 25px 80px rgba(0, 0, 0, 0.6);
            resize: both;
            overflow: hidden;
        }

        .proposal-phone-notch {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            height: 24px;
            background: #0a0a12;
            border-radius: 0 0 14px 14px;
            z-index: 10;
        }

        .proposal-phone-screen {
            width: 100%;
            height: 100%;
            background: #000;
            border-radius: 34px;
            overflow: hidden;
        }

        .proposal-phone-screen iframe {
            width: 100%;
            height: 100%;
            border: none;
        }

        .proposal-phone-home {
            position: absolute;
            bottom: 6px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .proposal-resize-handle {
            position: absolute;
            bottom: 4px;
            right: 4px;
            width: 16px;
            height: 16px;
            cursor: nwse-resize;
            opacity: 0.3;
        }

        .proposal-resize-handle::before,
        .proposal-resize-handle::after {
            content: '';
            position: absolute;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 1px;
        }

        .proposal-resize-handle::before {
            width: 10px;
            height: 2px;
            bottom: 2px;
            right: 2px;
            transform: rotate(-45deg);
        }

        .proposal-resize-handle::after {
            width: 6px;
            height: 2px;
            bottom: 6px;
            right: 2px;
            transform: rotate(-45deg);
        }

        .proposal-app-header {
            position: absolute;
            top: 20px;
            left: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 20;
        }

        .proposal-app-header-icon {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            overflow: hidden;
        }

        .proposal-app-header-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .proposal-app-header-info {
            flex: 1;
        }

        .proposal-app-header-name {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .proposal-app-header-hint {
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .proposal-app-iframe-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .proposal-app-iframe {
            width: 100%;
            height: 100%;
            border: none;
            background: #0a0a12;
        }

        .proposal-chat-panel {
            width: 400px;
            display: flex;
            flex-direction: column;
            background: rgba(10, 10, 18, 0.95);
        }

        .proposal-chat-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .proposal-chat-title {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .proposal-chat-subtitle {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .proposal-chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .proposal-chat-input-area {
            padding: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .proposal-chat-input-wrapper {
            display: flex;
            gap: 8px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 8px 12px;
        }

        .proposal-chat-input {
            flex: 1;
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            resize: none;
            min-height: 24px;
            max-height: 120px;
        }

        .proposal-chat-input::placeholder {
            color: var(--text-tertiary);
        }

        .proposal-chat-send {
            width: 32px;
            height: 32px;
            border-radius: 8px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .proposal-chat-send:hover {
            transform: scale(1.05);
        }

        .proposal-message {
            margin-bottom: 16px;
        }

        .proposal-message.user {
            display: flex;
            justify-content: flex-end;
        }

        .proposal-message.user .proposal-message-content {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 16px 16px 4px 16px;
            padding: 10px 14px;
            max-width: 85%;
        }

        .proposal-message.assistant .proposal-message-content {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 16px 16px 16px 4px;
            padding: 10px 14px;
            color: var(--text-secondary);
        }

        @media (max-width: 900px) {
            .proposal-split-view {
                flex-direction: column;
            }

            .proposal-app-preview {
                flex: none;
                height: 50%;
                border-right: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }

            .proposal-chat-panel {
                width: 100%;
                flex: 1;
            }
        }

        @media (max-width: 600px) {
            .proposal-app-preview {
                height: 40%;
            }

            .proposal-chat-panel {
                flex: 1;
            }
        }

        .typing-dots {
            display: inline-flex;
            gap: 2px;
        }

        .typing-dots span {
            animation: typingBounce 1.4s infinite;
            font-size: 1.2rem;
            line-height: 1;
        }

        .typing-dots span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-dots span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typingBounce {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .spinning {
            animation: spin 1s linear infinite;
        }

        /* Proposal Mode Tabs (Propose vs Fork) */
        .proposal-mode-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 10px;
            margin-bottom: 12px;
        }

        .proposal-mode-tab {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 10px 16px;
            background: none;
            border: none;
            border-radius: 8px;
            color: var(--text-tertiary);
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-mode-tab:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .proposal-mode-tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: var(--text-primary);
        }

        .proposal-mode-tab.fork-tab.active {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
        }

        .proposal-mode-tab svg {
            width: 16px;
            height: 16px;
        }

        /* Captured Element Display */
        .captured-element {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 12px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 8px;
            margin-bottom: 12px;
        }

        .captured-element-icon {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background: rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a5b4fc;
            flex-shrink: 0;
        }

        .captured-element-info {
            flex: 1;
            min-width: 0;
        }

        .captured-element-tag {
            font-size: 0.75rem;
            font-weight: 600;
            color: #a5b4fc;
            text-transform: uppercase;
        }

        .captured-element-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 2px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .captured-element-remove {
            background: none;
            border: none;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .captured-element-remove:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        /* Visual Feedback Active Indicator */
        .proposal-app-header.vf-active {
            border-bottom: 2px solid #6366f1;
        }

        .proposal-app-header.vf-active .proposal-app-header-hint {
            color: #a5b4fc;
        }

        /* Fork Action Buttons */
        .proposal-fork-actions {
            display: flex;
            gap: 8px;
            padding: 12px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .proposal-fork-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .proposal-fork-btn.primary {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
        }

        .proposal-fork-btn.primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .proposal-fork-btn.primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .proposal-fork-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: var(--text-secondary);
        }

        .proposal-fork-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        /* Animated Background Orbs */
        .builder-bg-effects {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            overflow: hidden;
            pointer-events: none;
            z-index: 0;
        }

        .builder-orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            animation: orbFloat 20s ease-in-out infinite;
        }

        .builder-orb-1 {
            width: 400px;
            height: 400px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            top: -100px;
            right: -100px;
            animation-delay: 0s;
        }

        .builder-orb-2 {
            width: 300px;
            height: 300px;
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            bottom: -50px;
            left: -50px;
            animation-delay: -7s;
        }

        .builder-orb-3 {
            width: 250px;
            height: 250px;
            background: linear-gradient(135deg, #f472b6, #c084fc);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            animation-delay: -14s;
        }

        @keyframes orbFloat {
            0%, 100% { transform: translate(0, 0) scale(1); }
            25% { transform: translate(30px, -30px) scale(1.05); }
            50% { transform: translate(-20px, 20px) scale(0.95); }
            75% { transform: translate(-30px, -20px) scale(1.02); }
        }

        /* Builder Header */
        .builder-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 20px 32px;
            position: relative;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(20px);
        }

        .builder-brand {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .builder-logo {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }

        .builder-title-group {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .builder-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: white;
            margin: 0;
            letter-spacing: -0.02em;
        }

        .builder-subtitle {
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.5);
        }

        .builder-exit-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(255, 255, 255, 0.05);
            color: rgba(255, 255, 255, 0.6);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }

        .builder-exit-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
        }

        /* Builder Content Layout */
        .builder-content {
            flex: 1;
            display: flex;
            justify-content: center;
            gap: 24px;
            padding: 24px 32px;
            position: relative;
            z-index: 10;
            overflow: hidden;
            min-height: 0;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
            box-sizing: border-box;
        }

        /* Builder Chat Area */
        .builder-chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-width: 0;
            max-width: 700px;
        }

        .builder-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0 16px;
        }

        .builder-message {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            animation: messageSlideIn 0.4s ease;
        }

        @keyframes messageSlideIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .builder-message.user {
            flex-direction: row-reverse;
        }

        .builder-message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .builder-message.assistant .builder-message-avatar {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .builder-message.user .builder-message-avatar {
            background: linear-gradient(135deg, #06b6d4, #3b82f6);
            color: white;
        }

        .builder-message-content {
            max-width: 600px;
            padding: 20px 24px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .builder-message.assistant .builder-message-content {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            color: rgba(255, 255, 255, 0.9);
        }

        .builder-message.user .builder-message-content {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            border-radius: 20px 20px 6px 20px;
        }

        .builder-welcome-text {
            margin: 0 0 20px 0;
            font-size: 1.05rem;
        }

        /* Builder Starter Prompts */
        .builder-starter-prompts {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            overflow-x: auto;
        }

        .builder-starter-chip {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 14px;
            background: rgba(99, 102, 241, 0.1);
            border: 1px solid rgba(99, 102, 241, 0.2);
            border-radius: 12px;
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.8rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .builder-starter-chip:hover {
            background: rgba(99, 102, 241, 0.2);
            border-color: rgba(99, 102, 241, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.2);
        }

        .starter-icon {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            background: rgba(99, 102, 241, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #a5b4fc;
        }

        /* Builder Spec Panel */
        .builder-spec-panel {
            width: 360px;
            flex-shrink: 0;
            display: none;
        }

        .builder-spec-panel.active {
            display: block;
            animation: specSlideIn 0.5s ease;
        }

        @keyframes specSlideIn {
            from { opacity: 0; transform: translateX(30px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .builder-spec-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px;
            overflow: hidden;
            backdrop-filter: blur(20px);
        }

        .spec-card-header {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 24px;
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.15), rgba(139, 92, 246, 0.1));
            border-bottom: 1px solid rgba(255, 255, 255, 0.06);
        }

        .spec-card-icon {
            width: 56px;
            height: 56px;
            border-radius: 16px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            box-shadow: 0 8px 32px rgba(99, 102, 241, 0.3);
        }

        .spec-card-title-area {
            flex: 1;
        }

        .spec-card-title {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: white;
        }

        .spec-card-status {
            font-size: 0.8rem;
            color: rgba(99, 102, 241, 1);
            font-weight: 500;
        }

        .spec-card-body {
            padding: 24px;
        }

        .spec-section {
            margin-bottom: 20px;
        }

        .spec-section:last-child {
            margin-bottom: 0;
        }

        .spec-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: rgba(255, 255, 255, 0.4);
            margin-bottom: 8px;
        }

        .spec-value {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.8);
            line-height: 1.5;
        }

        .spec-placeholder {
            color: rgba(255, 255, 255, 0.3);
            font-style: italic;
        }

        .spec-features-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .spec-feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 10px;
            font-size: 0.85rem;
            color: rgba(255, 255, 255, 0.8);
        }

        .spec-feature-item::before {
            content: '';
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #6366f1;
            flex-shrink: 0;
        }

        .spec-feature-item.spec-placeholder::before {
            display: none;
        }

        .spec-estimate-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 14px 18px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .spec-estimate-time {
            font-size: 0.9rem;
            color: rgba(255, 255, 255, 0.6);
        }

        .spec-estimate-cost {
            font-size: 0.95rem;
            font-weight: 600;
            color: #a5b4fc;
        }

        .spec-card-actions {
            display: flex;
            gap: 12px;
            padding: 20px 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.06);
            background: rgba(0, 0, 0, 0.2);
        }

        .spec-action-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .spec-action-btn.secondary {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
        }

        .spec-action-btn.secondary:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
        }

        .spec-action-btn.primary {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            border: none;
            color: white;
            box-shadow: 0 4px 20px rgba(99, 102, 241, 0.3);
        }

        .spec-action-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(99, 102, 241, 0.4);
        }

        .spec-action-cost {
            padding: 4px 10px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            font-size: 0.8rem;
        }

        /* Builder Input Area */
        .builder-input-area {
            padding: 20px 32px 32px;
            position: relative;
            z-index: 10;
        }

        .builder-input-container {
            max-width: 760px;
            margin: 0 auto;
            position: relative;
        }

        .builder-input-wrapper {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 16px 20px 14px;
            transition: all 0.2s ease;
        }

        .builder-input-wrapper:focus-within {
            border-color: rgba(99, 102, 241, 0.5);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15);
        }

        .builder-input {
            width: 100%;
            background: transparent;
            border: none;
            outline: none;
            font-size: 1rem;
            font-family: inherit;
            color: white;
            resize: none;
            min-height: 24px;
            max-height: 150px;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .builder-input::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .builder-input-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .builder-model-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            background: rgba(99, 102, 241, 0.15);
            border: 1px solid rgba(99, 102, 241, 0.3);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .builder-model-selector:hover {
            background: rgba(99, 102, 241, 0.25);
            border-color: rgba(99, 102, 241, 0.5);
        }

        .builder-model-selector.active {
            background: rgba(99, 102, 241, 0.3);
            border-color: rgba(99, 102, 241, 0.6);
        }

        .builder-model-selector.active .builder-model-arrow {
            transform: rotate(180deg);
        }

        .builder-model-name {
            font-size: 0.85rem;
            font-weight: 500;
            color: #a5b4fc;
        }

        .builder-model-arrow {
            color: rgba(255, 255, 255, 0.5);
            transition: transform 0.2s ease;
        }

        .builder-back-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 16px;
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
        }

        .builder-back-btn:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 255, 255, 0.25);
            color: var(--text-primary);
        }

        .builder-back-btn svg {
            opacity: 0.7;
        }

        .builder-back-btn:hover svg {
            opacity: 1;
        }

        .builder-send-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            border: none;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .builder-send-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.4);
        }

        .builder-send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Builder Model Dropdown */
        .builder-model-dropdown {
            position: absolute;
            bottom: 100%;
            left: 0;
            margin-bottom: 8px;
            min-width: 280px;
            background: rgba(20, 20, 30, 0.98);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 8px;
            display: none;
            z-index: 100;
            backdrop-filter: blur(20px);
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.5);
        }

        .builder-model-dropdown.active {
            display: block;
            animation: dropdownSlideUp 0.2s ease;
        }

        @keyframes dropdownSlideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .builder-model-dropdown-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 14px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.15s ease;
        }

        .builder-model-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .builder-model-dropdown-item.active {
            background: rgba(99, 102, 241, 0.15);
        }

        .builder-model-dropdown-item.suitegpt-active {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.3);
        }

        .builder-model-dropdown-item.exit-item {
            color: rgba(255, 255, 255, 0.6);
        }

        .builder-model-dropdown-item.exit-item:hover {
            background: rgba(239, 68, 68, 0.1);
            color: #f87171;
        }

        .builder-model-item-name {
            font-size: 0.9rem;
            font-weight: 500;
            color: rgba(255, 255, 255, 0.9);
            flex: 1;
        }

        .builder-model-item-name.suitegpt-name {
            background: linear-gradient(135deg, #6366f1, #a78bfa);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .builder-model-item-desc {
            font-size: 0.75rem;
            color: rgba(255, 255, 255, 0.4);
        }

        .builder-model-pro-badge {
            padding: 3px 8px;
            background: rgba(234, 179, 8, 0.2);
            color: #fbbf24;
            font-size: 0.65rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .builder-model-build-badge {
            padding: 3px 8px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 0.65rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
        }

        .builder-model-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.08);
            margin: 6px 0;
        }

        .builder-input-hint {
            text-align: center;
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.3);
            margin-top: 12px;
        }

        /* Model Dropdown Additions */
        .model-dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 8px 0;
        }

        /* Model Dropdown Tabs */
        .model-dropdown-tabs {
            display: flex;
            gap: 4px;
            padding: 4px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .model-dropdown-tab {
            flex: 1;
            padding: 8px 16px;
            border: none;
            background: transparent;
            color: var(--text-tertiary);
            font-size: 0.85rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .model-dropdown-tab:hover {
            color: var(--text-secondary);
            background: rgba(255, 255, 255, 0.05);
        }

        .model-dropdown-tab.active {
            background: rgba(99, 102, 241, 0.2);
            color: #a5b4fc;
        }

        /* Model Dropdown Panels */
        .model-dropdown-panel {
            display: none;
        }

        .model-dropdown-panel.active {
            display: block;
        }

        /* Model Badges */
        .model-free-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            background: rgba(34, 197, 94, 0.15);
            color: #4ade80;
            border-radius: 6px;
            font-weight: 600;
        }

        .model-credits-badge {
            font-size: 0.65rem;
            padding: 3px 8px;
            background: rgba(251, 191, 36, 0.15);
            color: #fbbf24;
            border-radius: 6px;
            font-weight: 600;
        }

        .suitegpt-builder-option {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.25), rgba(139, 92, 246, 0.15));
            border: 1px solid rgba(99, 102, 241, 0.5) !important;
            margin: 4px;
            border-radius: 12px !important;
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            position: relative;
            overflow: hidden;
        }

        .suitegpt-builder-option::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            animation: builderShimmer 3s infinite;
        }

        @keyframes builderShimmer {
            0% { left: -100%; }
            100% { left: 100%; }
        }

        .suitegpt-builder-option:hover {
            background: linear-gradient(135deg, rgba(99, 102, 241, 0.35), rgba(139, 92, 246, 0.25));
            border-color: rgba(99, 102, 241, 0.7) !important;
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.4), inset 0 1px 0 rgba(255, 255, 255, 0.15);
            transform: scale(1.02);
        }

        .suitegpt-builder-name {
            color: #ffffff !important;
            -webkit-text-fill-color: #ffffff !important;
            font-weight: 700;
            font-size: 0.95rem;
        }

        .suitegpt-builder-option .model-dropdown-item-desc {
            color: rgba(199, 210, 254, 0.8);
        }

        .model-builder-badge {
            padding: 4px 10px;
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            font-size: 0.7rem;
            font-weight: 600;
            border-radius: 6px;
            text-transform: uppercase;
            letter-spacing: 0.03em;
        }

        /* Mobile Responsive for Builder */
        @media (max-width: 900px) {
            .builder-content {
                flex-direction: column;
                padding: 16px;
            }

            .builder-spec-panel {
                width: 100%;
                order: -1;
            }

            .builder-spec-panel.active {
                max-height: 300px;
                overflow-y: auto;
            }

            .builder-header {
                padding: 16px 20px;
            }

            .builder-input-area {
                padding: 16px 20px 24px;
            }

            .builder-starter-prompts {
                flex-direction: column;
            }

            .builder-starter-chip {
                justify-content: flex-start;
            }
        }

        /* Use Cases Section */
        .use-cases-section {
            width: 100%;
            max-width: min(900px, calc(100% - 32px));
            margin: 32px auto 0;
            padding: 0 16px;
            overflow-x: hidden;
            box-sizing: border-box;
        }

        .use-cases-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .use-cases-title {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-secondary);
        }

        .use-cases-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(min(280px, 100%), 1fr));
            gap: 16px;
        }

        .use-case-card {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .use-case-card:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            transform: translateY(-2px);
        }

        .use-case-query {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 12px;
            line-height: 1.4;
        }

        .use-case-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .use-case-app {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .use-case-app-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            color: white;
        }

        .use-case-app-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }

        .use-case-app-icon svg {
            width: 14px;
            height: 14px;
        }

        .use-case-app-name {
            font-size: 0.8rem;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .use-case-helpful {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 0.75rem;
            color: var(--text-tertiary);
        }

        .use-case-helpful svg {
            width: 14px;
            height: 14px;
        }

        .intent-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            font-size: 0.65rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 100px;
            margin-bottom: 10px;
        }

        .intent-badge.problem { background: rgba(249, 115, 22, 0.15); color: #f97316; }
        .intent-badge.desire { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
        .intent-badge.idea { background: rgba(234, 179, 8, 0.15); color: #eab308; }
        .intent-badge.find { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
        .intent-badge.change { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
        .intent-badge.build { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; }

        /* Loading skeleton */
        .use-case-card.skeleton {
            pointer-events: none;
        }

        .skeleton-text {
            background: linear-gradient(90deg, var(--bg-card) 25%, var(--bg-card-hover) 50%, var(--bg-card) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 4px;
        }

        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        /* === IMPORT MODAL === */
        .import-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .import-modal-overlay.active {
            display: flex;
        }

        .import-modal {
            background: linear-gradient(180deg, #151520 0%, #0d0d14 100%);
            border: 1px solid var(--border-subtle);
            border-radius: 24px;
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalSlide 0.3s ease;
        }

        @keyframes modalSlide {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .import-modal-header {
            padding: 28px 28px 0;
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
        }

        .import-modal-header h2 {
            font-size: 1.5rem;
            font-weight: 800;
            margin-bottom: 8px;
        }

        .import-modal-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-modal-close {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 10px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.2rem;
            transition: all 0.2s ease;
            flex-shrink: 0;
        }

        .import-modal-close:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
        }

        .import-modal-body {
            padding: 28px;
        }

        .import-sources {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-source {
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: 16px;
            padding: 20px 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-source:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-source.selected {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.1);
        }

        .import-source-icon {
            font-size: 2rem;
            margin-bottom: 8px;
        }

        .import-source-name {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .import-instructions {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-instructions h4 {
            font-size: 0.85rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-instructions ol {
            font-size: 0.8rem;
            color: var(--text-secondary);
            padding-left: 20px;
            line-height: 1.8;
        }

        .import-instructions code {
            background: rgba(255, 255, 255, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.75rem;
        }

        .import-dropzone {
            border: 2px dashed var(--border-subtle);
            border-radius: 16px;
            padding: 40px 24px;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            margin-bottom: 24px;
        }

        .import-dropzone:hover,
        .import-dropzone.dragover {
            border-color: var(--accent-primary);
            background: rgba(99, 102, 241, 0.05);
        }

        .import-dropzone-icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.6;
        }

        .import-dropzone h3 {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-dropzone p {
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-bottom: 16px;
        }

        .import-dropzone-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: var(--accent-primary);
            border: none;
            border-radius: 10px;
            color: white;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .import-file-input {
            display: none;
        }

        .import-privacy {
            background: rgba(34, 197, 94, 0.1);
            border: 1px solid rgba(34, 197, 94, 0.2);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 24px;
        }

        .import-privacy h4 {
            font-size: 0.85rem;
            font-weight: 600;
            color: #22c55e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .import-privacy p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.6;
        }

        .import-consent {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 16px;
        }

        .import-consent label {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .import-consent input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            accent-color: var(--accent-primary);
            flex-shrink: 0;
        }

        .import-progress {
            display: none;
            text-align: center;
            padding: 40px 24px;
        }

        .import-progress.active {
            display: block;
        }

        .import-progress-spinner {
            width: 48px;
            height: 48px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            margin: 0 auto 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .import-progress h3 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .import-progress p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .import-progress-bar {
            height: 6px;
            background: var(--bg-card);
            border-radius: 3px;
            margin-top: 20px;
            overflow: hidden;
        }

        .import-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 3px;
            width: 0%;
            transition: width 0.3s ease;
        }

        .import-results {
            display: none;
        }

        .import-results.active {
            display: block;
        }

        .import-results-header {
            text-align: center;
            margin-bottom: 24px;
        }

        .import-results-header .success-icon {
            font-size: 3rem;
            margin-bottom: 12px;
        }

        .import-results-header h3 {
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .import-results-header p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .import-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 24px;
        }

        .import-stat {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
        }

        .import-stat-value {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--accent-primary);
        }

        .import-stat-label {
            font-size: 0.75rem;
            color: var(--text-tertiary);
            margin-top: 4px;
        }

        .import-insights {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 24px;
        }

        .import-insights h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-insight-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-subtle);
        }

        .import-insight-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .import-insight-icon {
            width: 36px;
            height: 36px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            flex-shrink: 0;
        }

        .import-insight-content h5 {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-insight-content p {
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .import-recommendations {
            margin-bottom: 24px;
        }

        .import-recommendations h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .import-app-rec {
            display: flex;
            align-items: center;
            gap: 16px;
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 14px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-decoration: none;
            color: inherit;
        }

        .import-app-rec:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
        }

        .import-app-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .import-app-info h5 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .import-app-info p {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .import-app-match {
            margin-left: auto;
            padding: 6px 12px;
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 100px;
        }

        .import-unmatched {
            margin-bottom: 24px;
        }

        .import-unmatched h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .unmatched-idea {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 10px;
        }

        .unmatched-idea-text {
            font-size: 0.85rem;
            color: var(--text-primary);
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .unmatched-idea-meta {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .unmatched-idea-category {
            font-size: 0.7rem;
            font-weight: 600;
            padding: 4px 10px;
            border-radius: 100px;
            background: rgba(139, 92, 246, 0.15);
            color: #8b5cf6;
        }

        .unmatched-idea-request {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 6px 14px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
            border: none;
            cursor: pointer;
        }

        .import-summary-text {
            font-size: 0.85rem;
            color: var(--text-secondary);
            line-height: 1.6;
            margin-top: 8px;
            padding: 12px 16px;
            background: rgba(99, 102, 241, 0.08);
            border-radius: 10px;
            border-left: 3px solid var(--accent-primary);
        }

        .import-cta {
            display: flex;
            gap: 12px;
        }

        .import-cta-btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
            border: none;
        }

        .import-cta-btn.primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: white;
        }

        .import-cta-btn.secondary {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            color: var(--text-primary);
        }

        /* === RESPONSIVE === */
        @media (max-width: 768px) {
            .mobile-header {
                display: flex !important;
                visibility: visible !important;
                opacity: 1 !important;
                flex-direction: row !important;
                justify-content: flex-start !important;
                align-items: center !important;
            }

            .mobile-header > * {
                margin-left: 0 !important;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding-top: 56px;
                max-width: 100vw;
                width: 100%;
            }

            .bg-gradient {
                left: 0;
            }

            .welcome-state {
                padding: 20px 16px;
            }

            .welcome-title {
                font-size: clamp(1.25rem, 5vw, 1.75rem);
            }

            .welcome-subtitle {
                font-size: 0.95rem;
                margin-bottom: 24px;
            }

            .chat-input-wrapper {
                padding: 14px 16px 12px;
                border-radius: 20px;
            }

            .chat-input {
                font-size: 1rem;
                margin-bottom: 10px;
            }

            .chat-input-toolbar {
                padding-top: 10px;
            }

            .chat-action-btn {
                width: 34px;
                height: 34px;
            }

            .model-selector {
                padding: 6px 10px 6px 8px;
            }

            .model-selector-name {
                font-size: 0.8rem;
            }

            .model-selector-icon {
                width: 18px;
                height: 18px;
            }

            .send-btn {
                width: 38px;
                height: 38px;
                border-radius: 10px;
            }

            .model-dropdown {
                min-width: 260px;
                right: -20px;
            }

            .quick-suggestions {
                gap: 8px;
                margin-top: 20px;
            }

            .suggestion-chip {
                padding: 8px 14px;
                font-size: 0.8rem;
            }

            .use-cases-section {
                padding: 0 16px;
            }

            .use-cases-grid {
                grid-template-columns: 1fr;
            }

            .chat-container {
                padding: 0 16px 20px;
            }

            /* Mobile chat-active adjustments */
            .welcome-state.chat-active .chat-container {
                padding: 0;
                flex-direction: column;
            }

            .welcome-state.chat-active .chat-messages-wrapper {
                padding: 16px;
            }

            /* Hide insights side panel on mobile  use collapsed toggle instead */
            .suitegpt-insights {
                display: none !important;
            }

            .suitegpt-insights.active {
                display: none !important;
            }

            .insights-collapsed-btn {
                display: none !important;
            }

            .welcome-state.chat-active .input-container {
                padding: 12px 16px max(16px, env(safe-area-inset-bottom));
            }

            .message {
                max-width: 88%;
            }

            .input-container {
                max-width: 100%;
                padding: 0 12px;
            }

            .chat-area {
                padding-bottom: max(16px, env(safe-area-inset-bottom));
            }

            .sidebar {
                padding-top: max(16px, env(safe-area-inset-top));
                z-index: 1000;
                width: 280px;
            }

            .sidebar-overlay {
                z-index: 999;
            }

            .import-sources {
                grid-template-columns: 1fr;
            }

            .import-stats {
                grid-template-columns: 1fr;
            }
        }

        /* Small phones (iPhone SE, etc.) */
        @media (max-width: 375px) {
            .chat-input-wrapper {
                padding: 12px 14px 10px;
                border-radius: 18px;
            }

            .chat-input {
                font-size: 0.95rem;
            }

            .chat-action-btn {
                width: 32px;
                height: 32px;
            }

            .model-selector {
                padding: 5px 8px 5px 6px;
                gap: 4px;
            }

            .model-selector-name {
                display: none;
            }

            .send-btn {
                width: 36px;
                height: 36px;
                border-radius: 10px;
            }

            .send-btn svg {
                width: 16px;
                height: 16px;
            }

            .quick-suggestions {
                display: none;
            }

            .welcome-title {
                font-size: 1.25rem;
            }

            .apps-view-grid {
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            .apps-view-item {
                padding: 12px 8px;
            }

            .apps-view-item-icon {
                width: 48px;
                height: 48px;
            }
        }

        /* Landscape orientation on mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .welcome-state {
                padding: 12px 24px;
            }

            .welcome-title {
                font-size: 1.25rem;
                margin-bottom: 8px;
            }

            .welcome-subtitle {
                display: none;
            }

            .main-content {
                padding-top: 48px;
            }

            .mobile-header {
                height: 48px;
            }

            .use-cases-section {
                display: none;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: var(--border-subtle); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

        /* PWA Install Prompt */
        .pwa-install-prompt {
            display: none;
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border-radius: 16px;
            padding: 16px 20px;
            z-index: 200;
            max-width: 400px;
            width: calc(100% - 48px);
            animation: slideUp 0.3s ease;
        }

        .pwa-install-prompt.visible {
            display: block;
        }

        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(100%); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        .pwa-install-content {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .pwa-install-icon {
            width: 32px;
            height: 32px;
            color: var(--accent-primary);
        }

        .pwa-install-icon svg {
            width: 100%;
            height: 100%;
        }

        .pwa-install-text h4 {
            font-size: 0.95rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .pwa-install-text p {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .pwa-install-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .pwa-install-btn {
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: all 0.2s ease;
        }

        .pwa-install-btn.primary {
            background: white;
            color: var(--accent-primary);
        }

        .pwa-install-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
        }

        /* Hide main nav in this view */
        #main-nav {
            display: none !important;
        }
    </style>
</head>
<body class="logged-out">
    <!-- Auth Header (shown when logged out) -->
    <header class="auth-header" id="authHeader">
        <a href="https://getsuite.app" class="auth-header-logo">
            <div class="auth-header-logo-icon">S</div>
            <span class="auth-header-logo-text">SuiteGPT</span>
        </a>
        <div class="auth-header-buttons">
            <button class="auth-btn auth-btn-login" onclick="openLoginModal()">Log in</button>
            <button class="auth-btn auth-btn-signup" onclick="openSignupModal()">Sign up for free</button>
        </div>
    </header>

    <!-- Sidebar Open Button (shown when sidebar collapsed) -->
    <button class="sidebar-open-btn" id="sidebarOpenBtn" onclick="openSidebar()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18" stroke-linecap="round"/>
        </svg>
    </button>

    <!-- App Layout -->
    <div class="app-layout">
        <!-- Left Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <a href="/" class="sidebar-logo" onclick="event.preventDefault(); openBuilderMode();">
                    <img src="/suitegpt-logo.png" alt="SuiteGPT" class="sidebar-logo-icon">
                    <span class="sidebar-logo-text">SuiteGPT</span>
                </a>
                <button class="sidebar-close-btn" onclick="closeSidebar()" title="Close sidebar">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 18l-6-6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>

            <nav class="sidebar-nav">
                <div class="sidebar-section">
                    <button class="sidebar-item sidebar-builder-btn" id="sidebarBuilderBtn" onclick="openBuilderMode()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                                <line x1="12" y1="22" x2="12" y2="15.5"/>
                                <polyline points="22 8.5 12 15.5 2 8.5"/>
                            </svg>
                        </span>
                        <span>SuiteGPT Builder</span>
                    </button>
                    <button class="sidebar-item" id="newChatBtn" onclick="startNewChat()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
                            </svg>
                        </span>
                        <span>New Chat</span>
                    </button>
                    <button class="sidebar-item" id="appsBtn" onclick="openAppsPanel()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                        </span>
                        <span>Apps</span>
                    </button>
                    <button class="sidebar-item" id="creatorDashboardBtn" onclick="openCreatorDashboard()">
                        <span class="sidebar-item-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                        </span>
                        <span>Dashboard</span>
                    </button>
                </div>
                <div class="sidebar-section sidebar-your-apps">
                    <div class="sidebar-section-title sidebar-expandable" onclick="toggleYourApps()">
                        <span>Your Apps <span id="yourAppsCount">(0)</span></span>
                        <svg class="expand-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M6 9l6 6 6-6" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </div>
                    <div class="sidebar-your-apps-actions">
                        <button class="sidebar-your-apps-btn" onclick="showView('store')" title="Add existing app">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Add
                        </button>
                        <button class="sidebar-your-apps-btn" onclick="openBuilderMode()" title="Create new app">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="13" height="13">
                                <path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/>
                            </svg>
                            New
                        </button>
                    </div>
                    <div class="sidebar-apps-list" id="sidebarAppsList">
                        <!-- Dynamically populated app tabs -->
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-section-header">
                        <div class="sidebar-section-title">Your chats</div>
                        <button class="new-chat-btn" onclick="toggleChatSearch()" title="Search Chats">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                <circle cx="11" cy="11" r="7"/>
                                <path d="M21 21l-4.35-4.35" stroke-linecap="round"/>
                            </svg>
                        </button>
                    </div>
                    <div class="chat-history-list" id="chatHistoryList">
                        <div class="chat-history-empty">
                            <p>No chat history yet</p>
                            <span>Your conversations will appear here</span>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <!-- Profile Dropdown -->
                <div class="profile-dropdown" id="profileDropdown">
                    <!-- Main View -->
                    <div class="profile-dropdown-view" id="profileMainView">
                        <!-- Credits Section -->
                        <div class="profile-dropdown-credits" id="profileCreditsSection">
                            <div class="credits-display clickable" onclick="openCreditsModal()">
                                <div class="credits-info">
                                    <span class="credits-label">Credits: <span id="dropdownCredits">0</span></span>
                                </div>
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="color: var(--text-tertiary);">
                                    <path d="M9 18l6-6-6-6"/>
                                </svg>
                            </div>
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <!-- Your Connections -->
                        <button onclick="toggleProfileDropdown(); openConnections();" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Your Connections
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <!-- Linked Accounts Section -->
                        <div class="linked-accounts-section" id="linkedAccountsSection">
                            <div class="linked-accounts-header">Linked Accounts</div>
                            <div id="linkedAccountsList">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        <div class="profile-dropdown-divider"></div>
                        <button onclick="showSettingsView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06a1.65 1.65 0 00.33-1.82 1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06a1.65 1.65 0 001.82.33H9a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/>
                            </svg>
                            Settings
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-tertiary);">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Settings View -->
                    <div class="profile-dropdown-view" id="profileSettingsView" style="display: none;">
                        <button onclick="showMainView()" class="profile-dropdown-item profile-dropdown-back">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Back
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <a href="https://getsuite.app/docs/" target="_blank" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                                <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                            </svg>
                            Documentation
                        </a>
                        <button onclick="openLearnView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                            </svg>
                            Learn
                        </button>
                        <a href="https://t.me/getsuiteapp" target="_blank" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="currentColor">
                                <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                            </svg>
                            Community Chat
                        </a>
                        <button onclick="showMainView(); toggleProfileDropdown(); triggerHistoryImport();" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Import History
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <button onclick="showAIDashboardView()" class="profile-dropdown-item">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2a2 2 0 012 2c0 .74-.4 1.39-1 1.73V7h1a7 7 0 017 7h1a1 1 0 011 1v3a1 1 0 01-1 1h-1a7 7 0 01-7 7H9a7 7 0 01-7-7H1a1 1 0 01-1-1v-3a1 1 0 011-1h1a7 7 0 017-7h1V5.73c-.6-.34-1-.99-1-1.73a2 2 0 012-2z"/>
                                <circle cx="12" cy="14" r="3"/>
                            </svg>
                            AI Notifications
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-left: auto; color: var(--text-tertiary);">
                                <path d="M9 18l6-6-6-6"/>
                            </svg>
                        </button>
                    </div>

                    <!-- AI Notifications Settings View -->
                    <div class="profile-dropdown-view" id="profileAIDashboardView" style="display: none;">
                        <button onclick="showSettingsView()" class="profile-dropdown-item profile-dropdown-back">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M15 18l-6-6 6-6"/>
                            </svg>
                            Back
                        </button>
                        <div class="profile-dropdown-divider"></div>
                        <div class="ai-settings-section">
                            <div class="ai-settings-header">Personal AI Notifications</div>
                            <p class="ai-settings-desc">Enable cloud sync and AI insights to get personalized analysis across your apps.</p>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">Cloud Sync</span>
                                    <span class="ai-setting-help">Sync app data across devices</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="aiSettingCloudSync" onchange="toggleAISetting('data_sync_enabled', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">AI Insights</span>
                                    <span class="ai-setting-help">Allow AI to analyze your data</span>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="aiSettingInsights" onchange="toggleAISetting('ai_insights_enabled', this.checked)">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>

                            <div class="ai-setting-item">
                                <div class="ai-setting-info">
                                    <span class="ai-setting-label">Notifications</span>
                                    <span class="ai-setting-help">Insight digest frequency</span>
                                </div>
                                <select class="ai-setting-select" id="aiSettingNotifications" onchange="updateNotificationFrequency(this.value)">
                                    <option value="never">Never</option>
                                    <option value="daily">Daily</option>
                                    <option value="weekly">Weekly</option>
                                </select>
                            </div>

                            <div class="ai-apps-section" id="aiAppsSection" style="display: none;">
                                <div class="ai-setting-label" style="margin-bottom: 8px;">Apps AI can access:</div>
                                <div id="aiAppsCheckboxes">
                                    <!-- Populated dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button class="sidebar-footer-factory" id="sidebarFactoryBtn" onclick="showMainView(); openFactory();">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M2 20h20M5 20V8l7-5 7 5v12M9 20v-6h6v6"/>
                        <path d="M9 12h.01M15 12h.01"/>
                    </svg>
                    Factory
                </button>

                <div class="sidebar-profile" id="sidebarProfile" onclick="toggleProfileDropdown()">
                    <div class="sidebar-profile-avatar" id="sidebarAvatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="sidebar-profile-info">
                        <div class="sidebar-profile-name" id="sidebarProfileName">Guest</div>
                        <div class="sidebar-profile-row" id="sidebarProfileRow">
                            <span class="sidebar-profile-status" id="sidebarProfileStatus">Not signed in</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Sidebar Overlay (mobile) -->
        <div class="sidebar-overlay" id="sidebarOverlay"></div>

        <!-- Mobile Header -->
        <header class="mobile-header">
            <button class="mobile-menu-btn" id="mobileMenuBtn"></button>
            <span class="mobile-title">SuiteGPT</span>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Background -->
            <div class="bg-gradient"></div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Welcome State -->
                <section class="welcome-state" id="welcomeState">
                    <div class="input-container">
                        <!-- Main Chat Input Box -->
                        <div class="chat-input-wrapper">
                            <!-- Top row: text input -->
                            <textarea
                                class="chat-input"
                                id="chatInput"
                                placeholder="Message SuiteGPT..."
                                rows="1"
                                autocomplete="off"
                            ></textarea>

                            <!-- Bottom row: actions left, model+send right -->
                            <div class="chat-input-toolbar">
                                <div class="chat-input-actions">
                                    <!-- Plus button (attach files) -->
                                    <button class="chat-action-btn" id="attachBtn" title="Attach file">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="12" y1="5" x2="12" y2="19"></line>
                                            <line x1="5" y1="12" x2="19" y2="12"></line>
                                        </svg>
                                        <input type="file" id="fileInput" style="display: none;" multiple accept="image/*,.pdf,.txt,.doc,.docx">
                                    </button>

                                    <!-- @ button (mention apps/contexts) -->
                                    <button class="chat-action-btn" id="mentionBtn" title="Mention an app">
                                        <span style="font-size: 18px; font-weight: 600;">@</span>
                                    </button>

                                    <!-- Tools button -->
                                    <button class="chat-action-btn chat-action-btn-text" id="toolsBtn" title="Tools">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="3"></circle>
                                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                                        </svg>
                                        <span class="chat-action-btn-label">Tools</span>
                                    </button>
                                </div>

                                <div class="chat-input-right">
                                    <div class="model-selector" id="modelSelector">
                                        <span class="model-selector-name" id="modelName">Auto</span>
                                        <svg class="model-selector-arrow" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polyline points="6 9 12 15 18 9"/>
                                        </svg>
                                    </div>
                                    <button class="send-btn" id="sendBtn" disabled>
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            <!-- Attach Dropdown (+ button) -->
                        <div class="action-dropdown" id="attachDropdown">
                            <div class="action-dropdown-item" data-attach="files">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Add files & photos</span>
                                    <span class="action-dropdown-item-desc">Upload images, PDFs, documents</span>
                                </div>
                            </div>
                        </div>

                        <!-- @ Mention Dropdown -->
                        <div class="action-dropdown" id="mentionDropdown">
                            <div class="action-dropdown-section">
                                <div class="action-dropdown-label">Apps</div>
                                <div class="action-dropdown-item" data-mention="TrueForm">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">TrueForm AI</span>
                                </div>
                                <div class="action-dropdown-item" data-mention="HydroTrack">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">HydroTrack</span>
                                </div>
                                <div class="action-dropdown-item" data-mention="FoodVitals">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">FoodVitals</span>
                                </div>
                                <div class="action-dropdown-item" data-mention="SleepWell">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">SleepWell</span>
                                </div>
                                <div class="action-dropdown-item" data-mention="QuickBudget">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">QuickBudget</span>
                                </div>
                            </div>
                            <div class="action-dropdown-section">
                                <div class="action-dropdown-label">Context</div>
                                <div class="action-dropdown-item" data-mention="my-apps">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">My saved apps</span>
                                </div>
                                <div class="action-dropdown-item" data-mention="recent">
                                    <span class="action-dropdown-item-icon"></span>
                                    <span class="action-dropdown-item-name">Recent activity</span>
                                </div>
                            </div>
                        </div>

                        <!-- Tools Dropdown -->
                        <div class="action-dropdown" id="toolsDropdown">
                            <div class="action-dropdown-item" data-tool="deep-research">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8"/>
                                    <path d="M21 21l-4.35-4.35"/>
                                    <path d="M11 8v6M8 11h6"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Deep Research</span>
                                    <span class="action-dropdown-item-desc">In-depth analysis & research</span>
                                </div>
                            </div>
                            <div class="action-dropdown-item" data-tool="create-video">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="2" y="4" width="20" height="16" rx="2"/>
                                    <polygon points="10 9 16 12 10 15 10 9"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Create Videos</span>
                                    <span class="action-dropdown-item-desc">Veo 3.1 video generation</span>
                                </div>
                                <span class="pro-badge">Pro</span>
                            </div>
                            <div class="action-dropdown-item" data-tool="create-image">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <circle cx="8.5" cy="8.5" r="1.5"/>
                                    <path d="M21 15l-5-5L5 21"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Create Images</span>
                                    <span class="action-dropdown-item-desc">AI image generation</span>
                                </div>
                                <span class="pro-badge">Pro</span>
                            </div>
                            <div class="action-dropdown-item" data-tool="web-search">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Web Search</span>
                                    <span class="action-dropdown-item-desc">Search the internet</span>
                                </div>
                            </div>
                            <div class="action-dropdown-item" data-tool="code">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="16 18 22 12 16 6"/>
                                    <polyline points="8 6 2 12 8 18"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Code Interpreter</span>
                                    <span class="action-dropdown-item-desc">Run Python code</span>
                                </div>
                            </div>
                            <div class="action-dropdown-item" data-tool="voice">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                                    <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                                    <line x1="12" y1="19" x2="12" y2="23"/>
                                    <line x1="8" y1="23" x2="16" y2="23"/>
                                </svg>
                                <div class="action-dropdown-item-text">
                                    <span class="action-dropdown-item-name">Voice Mode</span>
                                    <span class="action-dropdown-item-desc">Talk to SuiteGPT</span>
                                </div>
                                <span class="pro-badge">Pro</span>
                            </div>
                        </div>

                        <!-- Model Dropdown -->
                        <div class="model-dropdown" id="modelDropdown">
                            <!-- Tabs -->
                            <div class="model-dropdown-tabs">
                                <button class="model-dropdown-tab active" data-tab="free">Free</button>
                                <button class="model-dropdown-tab" data-tab="paid">Paid</button>
                            </div>

                            <!-- Free Models Panel -->
                            <div class="model-dropdown-panel active" data-panel="free">
                                <div class="model-dropdown-item active" data-mode="auto" data-name="Auto">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Auto</span>
                                        <span class="model-dropdown-item-desc">Smart model selection</span>
                                    </div>
                                    <span class="model-free-badge">Free</span>
                                </div>
                                <div class="model-dropdown-item" data-mode="flash" data-name="Gemini Flash 2.0">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Gemini Flash 2.0</span>
                                        <span class="model-dropdown-item-desc">Fast responses</span>
                                    </div>
                                    <span class="model-free-badge">Free</span>
                                </div>
                                <div class="model-dropdown-item" data-mode="llama" data-name="Llama 3.3 70B">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Llama 3.3 70B</span>
                                        <span class="model-dropdown-item-desc">Powerful open-source</span>
                                    </div>
                                    <span class="model-free-badge">Free</span>
                                </div>
                            </div>

                            <!-- Paid Models Panel -->
                            <div class="model-dropdown-panel" data-panel="paid">
                                <div class="model-dropdown-item" data-mode="pro" data-name="Gemini 2.0 Pro">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Gemini 2.0 Pro</span>
                                        <span class="model-dropdown-item-desc">Complex tasks & analysis</span>
                                    </div>
                                    <span class="model-credits-badge">5 credits</span>
                                </div>
                                <div class="model-dropdown-item" data-mode="sonnet" data-name="Claude Sonnet 4">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Claude Sonnet 4</span>
                                        <span class="model-dropdown-item-desc">Balanced performance</span>
                                    </div>
                                    <span class="model-credits-badge">8 credits</span>
                                </div>
                                <div class="model-dropdown-item" data-mode="opus" data-name="Claude Opus 4">
                                    <div class="model-dropdown-item-info">
                                        <span class="model-dropdown-item-name">Claude Opus 4</span>
                                        <span class="model-dropdown-item-desc">Most capable reasoning</span>
                                    </div>
                                    <span class="model-credits-badge">15 credits</span>
                                </div>
                            </div>
                        </div>
                        </div>

                        <!-- Quick Suggestions -->
                        <div class="quick-suggestions">
                            <button class="suggestion-chip" data-query="Build me an app for tracking my daily habits">Build me an app</button>
                            <button class="suggestion-chip" data-query="Find me an app for tracking water intake">Find an app</button>
                            <button class="suggestion-chip" data-query="I want to track my fitness and workouts">Track my fitness</button>
                            <button class="suggestion-chip" data-query="I need help managing my budget and expenses">Manage my budget</button>
                            <button class="suggestion-chip" data-query="I need help focusing and being more productive">Help me focus</button>
                            <button class="suggestion-chip" data-query="I want to plan healthy meals for the week">Plan my meals</button>
                        </div>
                    </div>

                    <!-- Chat Container -->
                    <div class="chat-container" id="chatContainer">
                        <div class="chat-messages-wrapper">
                            <div class="chat-messages" id="chatMessages"></div>
                        </div>

                        <!-- SuiteGPT Insights Side Panel -->
                        <div class="suitegpt-insights" id="suiteInsights">
                            <div class="insights-header">
                                <span class="insights-title">SuiteGPT Insights</span>
                                <button class="insights-minimize-btn" id="insightsMinimizeBtn" title="Collapse">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <path d="M15 18l-6-6 6-6"/>
                                    </svg>
                                </button>
                            </div>
                            <div class="insights-content" id="insightsContent">
                                <div class="insights-empty-state">
                                    <p>Insights will appear here as you chat. I'll suggest relevant SUITE apps based on your conversation.</p>
                                </div>
                            </div>
                        </div>

                        <!-- Collapsed Insights Toggle Button -->
                        <button class="insights-collapsed-btn" id="insightsMinimizedBtn" title="Show Insights">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 16v-4M12 8h.01"/>
                            </svg>
                            <span class="insights-badge" id="insightsBadge">0</span>
                        </button>
                    </div>

                </section>

                <!-- SuiteGPT Builder Mode -->
                <section class="builder-mode" id="builderMode">
                    <div class="builder-bg-effects">
                        <div class="builder-orb builder-orb-1"></div>
                        <div class="builder-orb builder-orb-2"></div>
                        <div class="builder-orb builder-orb-3"></div>
                    </div>

                    <!-- Builder Choice Screen (shows first) -->
                    <div class="builder-choice-screen" id="builderChoiceScreen">
                        <div class="builder-choice-header">
                            <h1 class="builder-choice-title">Create</h1>
                            <p class="builder-choice-subtitle">What do you want to do?</p>
                        </div>
                        <div class="builder-choice-options">
                            <button class="builder-choice-card" onclick="enterIdeaMode()">
                                <div class="builder-choice-icon idea">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                                        <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                                    </svg>
                                </div>
                                <h3 class="builder-choice-card-title">Start with an Idea</h3>
                                <p class="builder-choice-card-desc">Submit your idea, get community votes, and find collaborators to build it.</p>
                            </button>
                            <button class="builder-choice-card" onclick="enterCreateAppMode()">
                                <div class="builder-choice-icon create">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                        <path d="M12 8v8M8 12h8"/>
                                    </svg>
                                </div>
                                <h3 class="builder-choice-card-title">Build Something Now</h3>
                                <p class="builder-choice-card-desc">Describe your app and get a working prototype in minutes.</p>
                            </button>
                            <button class="builder-choice-card" onclick="enterImportMode()">
                                <div class="builder-choice-icon import">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/>
                                        <polyline points="17 8 12 3 7 8"/>
                                        <line x1="12" y1="3" x2="12" y2="15"/>
                                    </svg>
                                </div>
                                <h3 class="builder-choice-card-title">Import Existing</h3>
                                <p class="builder-choice-card-desc">Paste HTML code for something you've already built.</p>
                            </button>
                        </div>
                    </div>

                    <!-- Create App Screen -->
                    <div class="quick-app-screen" id="quickAppScreen">
                        <div class="quick-app-header">
                            <h2 class="quick-app-title">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M12 8v8M8 12h8"/>
                                </svg>
                                Make App
                            </h2>
                            <p class="quick-app-subtitle">Describe your idea in detail - the more specific, the better the result</p>
                        </div>

                        <div class="quick-app-input-container">
                            <textarea
                                class="quick-app-input"
                                id="quickAppInput"
                                placeholder="Describe your app idea in detail... the more specific, the better the result!"
                                rows="5"
                                onkeydown="handleQuickAppKeydown(event)"
                                oninput="onQuickAppInput()"
                            ></textarea>
                        </div>

                        <div class="quick-app-ideas">
                            <button class="quick-app-idea-chip" onclick="useQuickAppIdea('expense tracker with categories')">expense tracker</button>
                            <button class="quick-app-idea-chip" onclick="useQuickAppIdea('habit tracker with streaks')">habit tracker</button>
                            <button class="quick-app-idea-chip" onclick="useQuickAppIdea('pomodoro timer with stats')">pomodoro timer</button>
                            <button class="quick-app-idea-chip" onclick="useQuickAppIdea('recipe scaler calculator')">recipe scaler</button>
                            <button class="quick-app-idea-chip" onclick="useQuickAppIdea('mood journal with insights')">mood journal</button>
                        </div>

                        <div class="quick-app-divider">or</div>

                        <button class="quick-app-surprise-btn" id="surpriseMeBtn" onclick="generateNovelAppIdea()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                            </svg>
                            Surprise me with a novel idea
                        </button>

                        <!-- Prompt Breakdown Cards -->
                        <div class="prompt-breakdown-container" id="promptBreakdownContainer">
                            <div class="prompt-breakdown-header">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                </svg>
                                Build prompts
                                <span>edit any to customize</span>
                            </div>
                            <div class="prompt-breakdown-cards" id="promptBreakdownCards">
                                <!-- Core Features Card -->
                                <div class="prompt-card" id="promptCardFeatures" onclick="togglePromptCard('Features', event)">
                                    <div class="prompt-card-header">
                                        <div class="prompt-card-title features">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                <path d="M9 9h6M9 15h6M9 12h6"/>
                                            </svg>
                                            Core Features
                                        </div>
                                        <svg class="prompt-card-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </div>
                                    <div class="prompt-card-preview loading" id="promptPreviewFeatures">Generating</div>
                                    <div class="prompt-card-body">
                                        <textarea class="prompt-card-textarea" id="promptTextFeatures" placeholder="Core features and functionality..." oninput="autoResizePromptCard(this)"></textarea>
                                    </div>
                                </div>

                                <!-- UI Design Card -->
                                <div class="prompt-card" id="promptCardDesign" onclick="togglePromptCard('Design', event)">
                                    <div class="prompt-card-header">
                                        <div class="prompt-card-title design">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <circle cx="12" cy="12" r="10"/>
                                                <path d="M12 6v6l4 2"/>
                                            </svg>
                                            UI Design
                                        </div>
                                        <svg class="prompt-card-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </div>
                                    <div class="prompt-card-preview loading" id="promptPreviewDesign">Generating</div>
                                    <div class="prompt-card-body">
                                        <textarea class="prompt-card-textarea" id="promptTextDesign" placeholder="Visual design and styling..." oninput="autoResizePromptCard(this)"></textarea>
                                    </div>
                                </div>

                                <!-- Interactions Card -->
                                <div class="prompt-card" id="promptCardInteractions" onclick="togglePromptCard('Interactions', event)">
                                    <div class="prompt-card-header">
                                        <div class="prompt-card-title interactions">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M15 15l-2 5L9 9l11 4-5 2z"/>
                                                <path d="M14.5 14.5L19 19"/>
                                            </svg>
                                            Interactions
                                        </div>
                                        <svg class="prompt-card-toggle" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M6 9l6 6 6-6"/>
                                        </svg>
                                    </div>
                                    <div class="prompt-card-preview loading" id="promptPreviewInteractions">Generating</div>
                                    <div class="prompt-card-body">
                                        <textarea class="prompt-card-textarea" id="promptTextInteractions" placeholder="User interactions and behaviors..." oninput="autoResizePromptCard(this)"></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="quick-app-actions">
                            <button class="quick-app-back-btn" onclick="goBackToBuilderChoice()">Back</button>
                            <button class="quick-app-build-btn" id="quickAppBuildBtn" onclick="buildQuickApp()" disabled>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                                </svg>
                                Build It
                            </button>
                        </div>
                    </div>

                    <!-- Idea Submission Screen -->
                    <div class="quick-app-screen" id="ideaScreen">
                        <div class="quick-app-header">
                            <h2 class="quick-app-title">Start with an Idea</h2>
                            <p class="quick-app-subtitle">Describe your app idea. The community can vote on it and collaborators can help build it.</p>
                        </div>
                        <input type="text" class="create-screen-name-input" id="ideaName" placeholder="Give your idea a name" maxlength="100">
                        <textarea class="quick-app-input" id="ideaDescription" placeholder="What does it do? Who is it for? What problem does it solve?" rows="6"></textarea>
                        <div class="quick-app-actions">
                            <button class="quick-app-back-btn" onclick="goBackToBuilderChoice()">Back</button>
                            <button class="quick-app-build-btn" id="ideaSubmitBtn" onclick="submitIdea()">Submit Idea</button>
                        </div>
                    </div>

                    <!-- Import App Screen -->
                    <div class="quick-app-screen" id="importAppScreen">
                        <div class="quick-app-header">
                            <h2 class="quick-app-title">Import Existing</h2>
                            <p class="quick-app-subtitle">Paste your app's HTML code to add it to your projects.</p>
                        </div>
                        <input type="text" class="create-screen-name-input" id="importAppName" placeholder="App name" maxlength="100">
                        <textarea class="quick-app-input" id="importAppDescription" placeholder="Brief description of what it does..." rows="2"></textarea>
                        <textarea class="quick-app-input" id="importAppCode" placeholder="Paste HTML code here..." rows="12" style="font-family: monospace; font-size: 0.82rem;"></textarea>
                        <div class="quick-app-actions">
                            <button class="quick-app-back-btn" onclick="goBackToBuilderChoice()">Back</button>
                            <button class="quick-app-build-btn" id="importAppBtn" onclick="importApp()">Import</button>
                        </div>
                    </div>

                    <div class="builder-content" id="builderContent" style="display: none;">
                        <!-- Builder Chat Area -->
                        <div class="builder-chat-area" id="builderChatArea">
                            <div class="builder-messages" id="builderMessages">
                                <!-- Welcome Message -->
                                <div class="builder-message assistant">
                                    <div class="builder-message-avatar">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                            <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                                        </svg>
                                    </div>
                                    <div class="builder-message-content">
                                        <p class="builder-welcome-text">Welcome to SuiteGPT Builder. Tell me what you want to create, and I'll help you build it.</p>
                                        <div class="builder-starter-prompts">
                                            <button class="builder-starter-chip" onclick="useBuilderStarter('I want to build an app that')">
                                                <span class="starter-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                        <rect x="3" y="3" width="18" height="18" rx="2"/>
                                                        <path d="M12 8v8M8 12h8"/>
                                                    </svg>
                                                </span>
                                                Build an app
                                            </button>
                                            <button class="builder-starter-chip" onclick="useBuilderStarter('I need a tool that helps me')">
                                                <span class="starter-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                        <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                                                    </svg>
                                                </span>
                                                Create a tool
                                            </button>
                                            <button class="builder-starter-chip" onclick="useBuilderStarter('Modify an existing app:')">
                                                <span class="starter-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                        <path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                                    </svg>
                                                </span>
                                                Modify an app
                                            </button>
                                            <button class="builder-starter-chip" onclick="useBuilderStarter('I have an idea:')">
                                                <span class="starter-icon">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                                        <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                                    </svg>
                                                </span>
                                                Share an idea
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Builder Spec Card (shows as conversation progresses) -->
                        <div class="builder-spec-panel" id="builderSpecPanel">
                            <div class="builder-spec-card" id="builderSpecCard">
                                <div class="spec-card-header">
                                    <div class="spec-card-icon" id="specCardIcon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="24" height="24">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <path d="M12 8v8M8 12h8"/>
                                        </svg>
                                    </div>
                                    <div class="spec-card-title-area">
                                        <h3 class="spec-card-title" id="specCardTitle">Your App</h3>
                                        <span class="spec-card-status" id="specCardStatus">Defining...</span>
                                    </div>
                                </div>
                                <div class="spec-card-body">
                                    <div class="spec-section" id="specDescription">
                                        <div class="spec-label">Description</div>
                                        <div class="spec-value spec-placeholder">Describe your idea to get started</div>
                                    </div>
                                    <div class="spec-section" id="specFeatures">
                                        <div class="spec-label">Features</div>
                                        <div class="spec-features-list">
                                            <div class="spec-feature-item spec-placeholder">Features will appear here</div>
                                        </div>
                                    </div>
                                    <div class="spec-section" id="specEstimate">
                                        <div class="spec-label">Estimate</div>
                                        <div class="spec-estimate-row">
                                            <span class="spec-estimate-time">~24 hours</span>
                                            <span class="spec-estimate-cost" id="specCost">50 credits</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="spec-card-actions">
                                    <button class="spec-action-btn secondary" onclick="refineSpec()">Refine More</button>
                                    <button class="spec-action-btn primary" onclick="submitBuildRequest()">
                                        <span>Request Build</span>
                                        <span class="spec-action-cost">50 credits</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Builder Input -->
                    <div class="builder-input-area">
                        <div class="builder-input-container">
                            <div class="builder-input-wrapper">
                                <textarea
                                    class="builder-input"
                                    id="builderInput"
                                    placeholder="Describe what you want to build..."
                                    rows="1"
                                ></textarea>
                                <div class="builder-input-toolbar">
                                    <div class="builder-back-btn" id="builderBackBtn" onclick="goBackToBuilderChoice()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                            <path d="M19 12H5M12 19l-7-7 7-7"/>
                                        </svg>
                                        <span>Go back</span>
                                    </div>
                                    <button class="builder-send-btn" id="builderSendBtn" onclick="sendBuilderMessage()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                            <!-- Builder Model Dropdown -->
                            <div class="builder-model-dropdown" id="builderModelDropdown">
                                <div class="builder-model-dropdown-item" data-mode="flash" data-name="Gemini Flash 2.0" onclick="switchBuilderModel('flash', 'Gemini Flash 2.0')">
                                    <span class="builder-model-item-name">Gemini Flash 2.0</span>
                                    <span class="builder-model-item-desc">Fast responses</span>
                                </div>
                                <div class="builder-model-dropdown-item" data-mode="pro" data-name="Gemini 2.0 Pro" onclick="switchBuilderModel('pro', 'Gemini 2.0 Pro')">
                                    <span class="builder-model-item-name">Gemini 2.0 Pro</span>
                                    <span class="builder-model-item-desc">Complex tasks</span>
                                </div>
                                <div class="builder-model-dropdown-item" data-mode="sonnet" data-name="Claude Sonnet 4" onclick="switchBuilderModel('sonnet', 'Claude Sonnet 4')">
                                    <span class="builder-model-item-name">Claude Sonnet 4</span>
                                    <span class="builder-model-item-desc">Balanced</span>
                                </div>
                                <div class="builder-model-dropdown-item" data-mode="opus" data-name="Claude Opus 4" onclick="switchBuilderModel('opus', 'Claude Opus 4')">
                                    <span class="builder-model-item-name">Claude Opus 4</span>
                                    <span class="builder-model-item-desc">Most capable</span>
                                    <span class="builder-model-pro-badge">Pro</span>
                                </div>
                                <div class="builder-model-divider"></div>
                                <div class="builder-model-dropdown-item active suitegpt-active" data-mode="suitegpt" data-name="SuiteGPT Builder">
                                    <span class="builder-model-item-name suitegpt-name">SuiteGPT Builder</span>
                                    <span class="builder-model-item-desc">App creation</span>
                                    <span class="builder-model-build-badge">Build</span>
                                </div>
                                <div class="builder-model-divider"></div>
                                <div class="builder-model-dropdown-item exit-item" onclick="exitBuilderMode()">
                                    <span class="builder-model-item-name">Exit Builder</span>
                                    <span class="builder-model-item-desc">Back to chat</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Inline Apps View -->
                <section class="apps-view" id="appsView">
                    <!-- Source Toggle -->
                    <div class="apps-source-toggle">
                        <button class="apps-source-btn active" id="appsSuiteBtn" onclick="switchAppsSource('suite')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="7" height="7" rx="1"/>
                                <rect x="14" y="3" width="7" height="7" rx="1"/>
                                <rect x="3" y="14" width="7" height="7" rx="1"/>
                                <rect x="14" y="14" width="7" height="7" rx="1"/>
                            </svg>
                            SUITE Apps
                        </button>
                        <button class="apps-source-btn" id="appsCommunityBtn" onclick="switchAppsSource('community')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            Community
                            <span class="apps-source-count" id="communityAppsCount">0</span>
                        </button>
                    </div>

                    <!-- SUITE Apps Section -->
                    <div class="apps-suite-section" id="appsSuiteSection">
                        <!-- Search -->
                        <div class="apps-view-search">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            <input type="text" id="appsViewSearch" placeholder="Search apps..." oninput="filterAppsInline(this.value)">
                        </div>

                        <!-- Featured Section -->
                    <div class="apps-featured-section" id="appsFeaturedSection">
                        <div class="apps-featured-header">
                            <span class="apps-featured-title"> Featured</span>
                        </div>
                        <div class="apps-featured-scroll" id="appsFeaturedScroll">
                            <!-- Horizontal scrolling featured apps -->
                        </div>
                    </div>

                    <!-- Category Tabs -->
                    <div class="apps-categories">
                        <div class="apps-category-tabs" id="appsCategoryTabs">
                            <!-- Generated category tabs -->
                        </div>
                    </div>

                    <!-- App Grid -->
                        <div class="apps-grid" id="appsGrid">
                            <!-- Apps for selected category -->
                        </div>
                    </div>

                    <!-- Community Apps Section -->
                    <div class="apps-community-section" id="appsCommunitySection" style="display: none;">
                        <!-- Search -->
                        <div class="apps-view-search">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"/>
                                <path d="M21 21l-4.35-4.35"/>
                            </svg>
                            <input type="text" id="communityAppsSearch" placeholder="Search community partners..." oninput="filterCommunityApps(this.value)">
                        </div>

                        <!-- Community Apps Grid -->
                        <div class="apps-grid" id="communityAppsGrid">
                            <!-- Community apps loaded dynamically -->
                        </div>

                        <!-- Empty State -->
                        <div class="community-empty-state" id="communityEmptyState">
                            <svg class="community-empty-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
                                <circle cx="9" cy="7" r="4"/>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
                            </svg>
                            <div class="community-empty-title">No community partners yet</div>
                            <p class="community-empty-text">Businesses and creators using SUITE will appear here.</p>
                            <button class="community-empty-btn" onclick="openBuilderMode()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <rect x="3" y="3" width="18" height="18" rx="2"/>
                                    <path d="M12 8v8M8 12h8"/>
                                </svg>
                                Create an App
                            </button>
                        </div>
                    </div>
                </section>

                <!-- App Detail View -->
                <section class="app-detail-view" id="appDetailView">
                    <button class="app-detail-back" onclick="closeAppDetail()">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M19 12H5"/><path d="M12 19l-7-7 7-7"/></svg>
                        Back to Apps
                    </button>

                    <!-- Header: icon + name + category + buttons -->
                    <div class="app-detail-header">
                        <div class="app-detail-icon" id="appDetailIcon"></div>
                        <div class="app-detail-header-info">
                            <h1 class="app-detail-name" id="appDetailName"></h1>
                            <span class="app-detail-category" id="appDetailCategory"></span>
                            <div class="app-detail-actions">
                                <button class="app-detail-btn-primary" id="appDetailOpenBtn" onclick="openAppFromDetail()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                                    Open App
                                </button>
                                <button class="app-detail-btn-secondary" id="appDetailAddBtn" onclick="addAppToProfileFromDetail()">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg>
                                    Add to Profile
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Preview screenshots -->
                    <div class="app-detail-section" id="appDetailScreenshotsSection">
                        <h2 class="app-detail-section-title">Preview</h2>
                        <div class="app-detail-screenshots" id="appDetailScreenshots"></div>
                    </div>

                    <!-- Description -->
                    <div class="app-detail-section">
                        <h2 class="app-detail-section-title">Description</h2>
                        <p class="app-detail-description" id="appDetailDescription"></p>
                    </div>

                    <!-- Information grid -->
                    <div class="app-detail-section">
                        <h2 class="app-detail-section-title">Information</h2>
                        <div class="app-detail-info-grid" id="appDetailInfoGrid"></div>
                    </div>
                </section>

                <!-- Inline Learn View -->
                <section class="learn-view" id="learnView">
                    <div class="learn-view-header">
                        <h2 class="learn-view-title">Learn</h2>
                    </div>
                    <p class="learn-view-subtitle">Articles, guides, and deep dives into SUITE and AI-powered apps.</p>

                    <div class="learn-articles-grid" id="learnArticlesGrid">
                        <!-- Fitness Apps Article -->
                        <div class="learn-article-card" data-article="fitness" onclick="showArticle('fitness')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag new">NEW</span>
                                    <span class="learn-article-tag">Fitness</span>
                                    <span class="learn-article-tag">Apps</span>
                                </div>
                                <div class="learn-article-title">5 Best Free AI Fitness Apps (2026)</div>
                                <p class="learn-article-desc">Discover the best free AI-powered fitness apps for tracking water, sleep, steps, meals, and stretching. No ads, no subscriptions.</p>
                                <div class="learn-article-meta">5 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>

                        <!-- AI Fleet Article -->
                        <div class="learn-article-card" data-article="ai-fleet" onclick="showArticle('ai-fleet')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag">AI</span>
                                    <span class="learn-article-tag">Philosophy</span>
                                </div>
                                <div class="learn-article-title">The AI Fleet: Apps That Build Themselves</div>
                                <p class="learn-article-desc">Every day, our AI builds a new app. Stake to keep it alive. Earn from its success. This is inside-out UBI.</p>
                                <div class="learn-article-meta">6 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>

                        <!-- Yield-Powered App Article -->
                        <div class="learn-article-card" data-article="yield" onclick="showArticle('yield')">
                            <div class="learn-article-content">
                                <div class="learn-article-tags">
                                    <span class="learn-article-tag">DeFi</span>
                                    <span class="learn-article-tag">Tokenomics</span>
                                </div>
                                <div class="learn-article-title">The Yield-Powered App: Free to Use, Paid by DeFi</div>
                                <p class="learn-article-desc">How we killed the monthly subscription. Your deposit generates yield that pays for AI  forever.</p>
                                <div class="learn-article-meta">5 min read</div>
                            </div>
                            <div class="learn-article-arrow"></div>
                        </div>
                    </div>

                    <!-- Article Content Area -->
                    <div class="learn-article-reader" id="learnArticleReader" style="display: none;">
                        <div class="learn-article-reader-header">
                            <button class="learn-view-back" onclick="hideArticle()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M15 18l-6-6 6-6"/>
                                </svg>
                                Back to Articles
                            </button>
                        </div>
                        <div class="learn-article-reader-content" id="learnArticleContent">
                            <!-- Article content loads here -->
                        </div>
                    </div>
                </section>

                <!-- Connections View -->
                <section class="connections-view" id="connectionsView">
                    <div class="connections-header">
                        <h2 class="connections-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71" stroke-linecap="round" stroke-linejoin="round"/>
                                <path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            Your Connections
                        </h2>
                        <p class="connections-subtitle">Connect your accounts to unlock AI insights across your entire digital life.</p>
                        <p class="connections-privacy-note">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
                                <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                            </svg>
                            Your data stays private and is never shared with third parties.
                        </p>
                    </div>

                    <!-- Connected Services Count -->
                    <div class="connections-stats">
                        <div class="connections-stat">
                            <span class="connections-stat-num" id="connectedCount">0</span>
                            <span class="connections-stat-label">Connected</span>
                        </div>
                        <div class="connections-stat">
                            <span class="connections-stat-num" id="availableCount">27</span>
                            <span class="connections-stat-label">Available</span>
                        </div>
                    </div>

                    <!-- Health & Fitness Section -->
                    <div class="connections-category">
                        <h3 class="connections-category-title">
                            <span class="connections-category-icon"></span>
                            Health & Fitness
                        </h3>
                        <div class="connections-list">
                            <div class="connection-item" data-service="apple-health">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/apple-health-icon.png" alt="Apple Health">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Apple Health</div>
                                    <div class="connection-item-desc">Steps, sleep, workouts, heart rate</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('apple-health')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="google-fit">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/google-fit-icon.jpeg" alt="Google Fit">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Google Fit</div>
                                    <div class="connection-item-desc">Activity, sleep, nutrition</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('google-fit')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="strava">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/strava-icon.jpeg" alt="Strava">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Strava</div>
                                    <div class="connection-item-desc">Runs, rides, workouts</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('strava')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="fitbit">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/fitbit-icon.jpeg" alt="Fitbit">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Fitbit</div>
                                    <div class="connection-item-desc">Activity, sleep, heart rate</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('fitbit')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="oura">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/oura-icon.jpeg" alt="Oura">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Oura Ring</div>
                                    <div class="connection-item-desc">Sleep, readiness, activity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('oura')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="whoop">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/whoop-icon.jpeg" alt="Whoop">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Whoop</div>
                                    <div class="connection-item-desc">Strain, recovery, sleep</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('whoop')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="garmin">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/garmin-icon.jpeg" alt="Garmin">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Garmin</div>
                                    <div class="connection-item-desc">GPS tracking, workouts, health</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('garmin')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="myfitnesspal">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/myfitnesspal-icon.jpeg" alt="MyFitnessPal">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">MyFitnessPal</div>
                                    <div class="connection-item-desc">Calories, macros, nutrition</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('myfitnesspal')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="peloton">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/peloton-icon.jpeg" alt="Peloton">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Peloton</div>
                                    <div class="connection-item-desc">Workouts, classes, metrics</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('peloton')">Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- Productivity Section -->
                    <div class="connections-category">
                        <h3 class="connections-category-title">
                            <span class="connections-category-icon"></span>
                            Productivity
                        </h3>
                        <div class="connections-list">
                            <div class="connection-item" data-service="google-calendar">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/google-calendar-icon.png" alt="Google Calendar">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Google Calendar</div>
                                    <div class="connection-item-desc">Events, meetings, schedule</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('google-calendar')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="notion">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/notion-icon.png" alt="Notion">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Notion</div>
                                    <div class="connection-item-desc">Pages, databases, tasks</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('notion')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="todoist">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/todoist-icon.png" alt="Todoist">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Todoist</div>
                                    <div class="connection-item-desc">Tasks, projects, productivity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('todoist')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="slack">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/slack-icon.jpeg" alt="Slack">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Slack</div>
                                    <div class="connection-item-desc">Messages, channels, activity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('slack')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="linear">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/linear-icon.jpeg" alt="Linear">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Linear</div>
                                    <div class="connection-item-desc">Issues, projects, sprints</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('linear')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="trello">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/trello-icon.png" alt="Trello">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Trello</div>
                                    <div class="connection-item-desc">Boards, cards, tasks</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('trello')">Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- Finance Section -->
                    <div class="connections-category">
                        <h3 class="connections-category-title">
                            <span class="connections-category-icon"></span>
                            Finance
                        </h3>
                        <div class="connections-list">
                            <div class="connection-item" data-service="plaid">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/plaid-icon.jpeg" alt="Plaid">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Plaid (Banks)</div>
                                    <div class="connection-item-desc">Transactions, balances, spending</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('plaid')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="coinbase">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/coinbase-icon.png" alt="Coinbase">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Coinbase</div>
                                    <div class="connection-item-desc">Crypto balances, transactions</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('coinbase')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="robinhood">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/robinhood-icon.png" alt="Robinhood">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Robinhood</div>
                                    <div class="connection-item-desc">Stocks, portfolio, trades</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('robinhood')">Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- Music & Media Section -->
                    <div class="connections-category">
                        <h3 class="connections-category-title">
                            <span class="connections-category-icon"></span>
                            Music & Media
                        </h3>
                        <div class="connections-list">
                            <div class="connection-item" data-service="spotify">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/spotify-icon.png" alt="Spotify">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Spotify</div>
                                    <div class="connection-item-desc">Listening history, playlists, top artists</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('spotify')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="apple-music">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/apple-music-icon.png" alt="Apple Music">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Apple Music</div>
                                    <div class="connection-item-desc">Library, playlists, listening</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('apple-music')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="youtube">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/youtube-icon.jpeg" alt="YouTube">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">YouTube</div>
                                    <div class="connection-item-desc">Watch history, subscriptions</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('youtube')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="netflix">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/netflix-icon.jpeg" alt="Netflix">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Netflix</div>
                                    <div class="connection-item-desc">Watch history, preferences</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('netflix')">Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- Social Section -->
                    <div class="connections-category">
                        <h3 class="connections-category-title">
                            <span class="connections-category-icon"></span>
                            Social
                        </h3>
                        <div class="connections-list">
                            <div class="connection-item" data-service="x">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/x-icon.jpeg" alt="X">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">X (Twitter)</div>
                                    <div class="connection-item-desc">Posts, likes, engagement</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('x')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="instagram">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/instagram-icon.png" alt="Instagram">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Instagram</div>
                                    <div class="connection-item-desc">Posts, stories, activity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('instagram')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="discord">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/discord-icon.png" alt="Discord">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">Discord</div>
                                    <div class="connection-item-desc">Servers, messages, activity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('discord')">Connect</button>
                            </div>
                            <div class="connection-item" data-service="linkedin">
                                <div class="connection-item-icon">
                                    <img src="/assets/icons/linkedin-icon.png" alt="LinkedIn">
                                </div>
                                <div class="connection-item-info">
                                    <div class="connection-item-name">LinkedIn</div>
                                    <div class="connection-item-desc">Profile, connections, activity</div>
                                </div>
                                <button class="connection-item-btn" onclick="connectService('linkedin')">Connect</button>
                            </div>
                        </div>
                    </div>

                    <!-- AI Insights Preview -->
                    <div class="connections-insights-preview">
                        <h3 class="connections-insights-title">
                            <span></span>
                            AI Insights Preview
                        </h3>
                        <p class="connections-insights-desc">Connect services to unlock personalized insights like:</p>
                        <div class="connections-insights-examples">
                            <div class="insight-example">
                                <span class="insight-example-icons">  </span>
                                <span class="insight-example-text">"You run 12% faster after 7+ hours of sleep"</span>
                            </div>
                            <div class="insight-example">
                                <span class="insight-example-icons">  </span>
                                <span class="insight-example-text">"Food delivery spending spikes on stressed days"</span>
                            </div>
                            <div class="insight-example">
                                <span class="insight-example-icons">  </span>
                                <span class="insight-example-text">"You focus 2x better with lo-fi vs. podcasts"</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Dashboard -->
                <section class="creator-dashboard" id="creatorDashboard">
                    <div class="creator-dashboard-header">
                        <h2 class="creator-dashboard-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2"/>
                                <path d="M3 9h18"/>
                                <path d="M9 21V9"/>
                            </svg>
                            Dashboard
                        </h2>
                    </div>

                    <div class="creator-dashboard-tabs">
                        <button class="creator-dashboard-tab active" data-tab="your-apps" onclick="switchDashboardTab('your-apps')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                            </svg>
                            Your Apps
                        </button>

                        <button class="creator-dashboard-tab" data-tab="earnings" onclick="switchDashboardTab('earnings')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                            Earnings
                        </button>
                        <button class="creator-dashboard-tab" data-tab="my-requests" onclick="switchDashboardTab('my-requests')">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            My Requests
                        </button>
                    </div>

                    <!-- Your Apps Tab Panel -->
                    <div class="creator-dashboard-panel active" id="dashboardPanelYourApps">
                        <div class="your-apps-header">
                            <h3 class="your-apps-title">Your Apps / Projects <span class="your-apps-count-badge" id="dashboardAppsCountBadge">0</span></h3>
                            <div class="your-apps-header-actions">
                                <button class="your-apps-create-btn" onclick="openBuilderMode()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                    </svg>
                                    Create
                                </button>
                            </div>
                        </div>

                        <!-- Empty State -->
                        <div class="your-apps-empty" id="dashboardAppsEmpty" style="display: none;">
                            <div class="your-apps-empty-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/>
                                </svg>
                            </div>
                            <h3>No projects yet</h3>
                            <p>Submit an idea, build an app, or import something you've already made.</p>
                            <div class="your-apps-empty-actions">
                                <button class="your-apps-create-btn" onclick="openBuilderMode()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                    </svg>
                                    Get Started
                                </button>
                            </div>
                        </div>

                        <!-- Apps Content -->
                        <div class="your-apps-content" id="dashboardAppsContent">
                            <div class="your-apps-unified-list" id="dashboardUnifiedList"></div>
                        </div>
                    </div>

                    <!-- Create Tab Panel -->

                    <!-- Earnings Tab Panel -->
                    <div class="creator-dashboard-panel" id="dashboardPanelEarnings">
                        <div class="earnings-header">
                        <div class="earnings-header-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <line x1="12" y1="1" x2="12" y2="23"/>
                                <path d="M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                            </svg>
                        </div>
                        <h1>Creator Monetization Program</h1>
                        <p>Get paid when users engage with your bots and apps.</p>
                    </div>

                    <div class="earnings-steps">
                        <div class="earnings-step">
                            <div class="earnings-step-num">1</div>
                            <div class="earnings-step-text">
                                <h3>Enroll</h3>
                                <p>Join the creator program below</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">2</div>
                            <div class="earnings-step-text">
                                <h3>Configure</h3>
                                <p>Set monetization for each bot or app</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">3</div>
                            <div class="earnings-step-text">
                                <h3>Share</h3>
                                <p>Promote your apps to attract users</p>
                            </div>
                        </div>
                        <div class="earnings-step">
                            <div class="earnings-step-num">4</div>
                            <div class="earnings-step-text">
                                <h3>Earn</h3>
                                <p>Get paid when users interact</p>
                            </div>
                        </div>
                    </div>

                    <div class="earnings-cta">
                        <button class="earnings-enroll-btn" onclick="enrollCreator()">Enroll Now</button>
                        <p class="earnings-terms">
                            By enrolling, you agree to SUITE's <a href="/terms/creator-earnings.html">Creator Terms</a>.
                        </p>
                    </div>

                    <div class="earnings-cards">
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 000 7h5a3.5 3.5 0 010 7H6"/>
                                </svg>
                            </div>
                            <h4>70% Revenue</h4>
                            <p>Keep most of what you earn</p>
                        </div>
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                                </svg>
                            </div>
                            <h4>Per Message</h4>
                            <p>Earn on every interaction</p>
                        </div>
                        <div class="earnings-card">
                            <div class="earnings-card-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="18" y1="20" x2="18" y2="10"/>
                                    <line x1="12" y1="20" x2="12" y2="4"/>
                                    <line x1="6" y1="20" x2="6" y2="14"/>
                                </svg>
                            </div>
                            <h4>Analytics</h4>
                            <p>Track growth in real-time</p>
                        </div>
                    </div>
                    </div>

                    <!-- My Requests Tab Panel -->
                    <div class="creator-dashboard-panel" id="dashboardPanelMyRequests">
                        <div class="my-requests-header">
                            <h3>My Requests</h3>
                            <p>Track your app proposals and feature requests</p>
                        </div>

                        <div class="my-requests-empty" id="myRequestsEmpty">
                            <div class="my-requests-empty-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                    <path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <h4>No requests yet</h4>
                            <p>When you submit app proposals or feature requests, they'll appear here so you can track their progress.</p>
                            <button class="your-apps-create-btn" onclick="openBuilderMode()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                                </svg>
                                Create Something
                            </button>
                        </div>

                        <div class="my-requests-list" id="myRequestsList" style="display: none;">
                            <!-- Requests will be populated here -->
                        </div>
                    </div>
                </section>

                <!-- Legacy Your Apps/Projects View (kept for backwards compatibility) -->
                <section class="your-apps-view" id="yourAppsView" style="display: none !important;">
                    <div class="your-apps-header">
                        <h2 class="your-apps-title">Your Apps / Projects</h2>
                        <button class="your-apps-create-btn" onclick="openCreateAppModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Create New
                        </button>
                    </div>

                    <!-- Empty State (shown when no apps saved) -->
                    <div class="your-apps-empty" id="yourAppsEmpty" style="display: none;">
                        <div class="your-apps-empty-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                                <path d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>No apps saved yet</h3>
                        <p>Add apps to your profile from the Apps gallery, or create a new app proposal below.</p>
                        <button class="your-apps-create-btn" onclick="openCreateAppModal()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Propose New App
                        </button>
                    </div>

                    <!-- Apps Content (shown when apps exist) -->
                    <div class="your-apps-content" id="yourAppsContent">
                        <!-- Tools Tier -->
                        <div class="your-apps-tier" id="yourAppsTierTools" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Tools</h3>
                                <span class="your-apps-tier-count" id="yourAppsToolsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsToolsGrid"></div>
                        </div>

                        <!-- Apps Tier -->
                        <div class="your-apps-tier" id="yourAppsTierApps" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Apps</h3>
                                <span class="your-apps-tier-count" id="yourAppsAppsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsAppsGrid"></div>
                        </div>

                        <!-- Solutions Tier -->
                        <div class="your-apps-tier" id="yourAppsTierSolutions" style="display: none;">
                            <div class="your-apps-tier-header">
                                <span class="your-apps-tier-icon"></span>
                                <h3 class="your-apps-tier-title">Solutions</h3>
                                <span class="your-apps-tier-count" id="yourAppsSolutionsCount">0</span>
                            </div>
                            <div class="your-apps-grid" id="yourAppsSolutionsGrid"></div>
                        </div>
                    </div>
                </section>

                <!-- App Settings Modal -->
                <div class="app-settings-overlay" id="appSettingsOverlay" onclick="closeAppSettings(event)">
                    <div class="app-settings-modal" onclick="event.stopPropagation()">
                        <div class="app-settings-header">
                            <h3 class="app-settings-title">App Settings</h3>
                            <button class="proposal-modal-close" onclick="closeAppSettings()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="app-settings-body" id="appSettingsBody">
                            <!-- Populated dynamically by openAppSettings() -->
                        </div>
                    </div>
                </div>

                <!-- Proposal Modal -->
                <div class="proposal-modal-overlay" id="proposalModalOverlay" onclick="closeProposalModal(event)">
                    <div class="proposal-modal" onclick="event.stopPropagation()">
                        <div class="proposal-modal-header">
                            <h3 class="proposal-modal-title" id="proposalModalTitle">Propose Refinement</h3>
                            <button class="proposal-modal-close" onclick="closeProposalModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
                                </svg>
                            </button>
                        </div>
                        <div class="proposal-modal-body">
                            <!-- App Info (for refinements) -->
                            <div class="proposal-modal-app" id="proposalModalApp" style="display: none;">
                                <div class="proposal-modal-app-icon" id="proposalModalAppIcon"></div>
                                <div class="proposal-modal-app-name" id="proposalModalAppName"></div>
                            </div>

                            <!-- Tier Selection (for new apps) -->
                            <div class="tier-options" id="proposalTierOptions" style="display: none;">
                                <label class="proposal-modal-label">What type of app?</label>
                                <div class="tier-option" data-tier="tool" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">Tool</div>
                                        <div class="tier-option-desc">Quick utilities like calculators, timers, converters</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="tier-option" data-tier="app" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">App</div>
                                        <div class="tier-option-desc">Full-featured apps with state, history, accounts</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                                <div class="tier-option" data-tier="solution" onclick="selectTierOption(this)">
                                    <span class="tier-option-icon"></span>
                                    <div class="tier-option-info">
                                        <div class="tier-option-name">Solution</div>
                                        <div class="tier-option-desc">Business solutions, integrations, enterprise tools</div>
                                    </div>
                                    <div class="tier-option-check">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3">
                                            <path d="M20 6L9 17l-5-5"/>
                                        </svg>
                                    </div>
                                </div>
                            </div>

                            <label class="proposal-modal-label" id="proposalModalLabel">What would you like to improve?</label>
                            <textarea
                                class="proposal-modal-textarea"
                                id="proposalModalTextarea"
                                placeholder="Describe your idea..."
                                oninput="updateProposalSubmitState()"
                            ></textarea>
                        </div>
                        <div class="proposal-modal-footer">
                            <button class="proposal-modal-btn cancel" onclick="closeProposalModal()">Cancel</button>
                            <button class="proposal-modal-btn submit" id="proposalModalSubmit" onclick="submitProposal()" disabled>Submit Proposal</button>
                        </div>
                    </div>
                </div>

                <!-- Factory/Governance View -->
                <section class="factory-view" id="factoryView">
                    <div class="factory-view-header">
                        <div class="factory-view-title">
                            <h1>Factory</h1>
                        </div>
                        <div class="factory-main-tabs">
                            <button class="factory-main-tab active" data-view="governance" onclick="switchFactoryMainView('governance')">
                                Governance
                            </button>
                            <button class="factory-main-tab" data-view="telos" onclick="switchFactoryMainView('telos')">
                                FAQ
                            </button>
                            <button class="factory-main-tab" data-view="marketing" onclick="switchFactoryMainView('marketing')">
                                Marketing
                            </button>
                            <button class="factory-main-tab" data-view="stream" onclick="switchFactoryMainView('stream')">
                                Swarm
                            </button>
                            <button class="factory-main-tab" data-view="leaderboard" onclick="switchFactoryMainView('leaderboard')">
                                Leaderboard
                            </button>
                            <button class="factory-main-tab" data-view="clients" onclick="switchFactoryMainView('clients')">
                                Clients
                            </button>
                        </div>
                    </div>

                    <!-- Reward Pool Banner -->
                    <div class="reward-pool-banner" id="rewardPoolBanner">
                        <div class="reward-pool-inner">
                            <div class="reward-pool-main">
                                <!-- Row 1: Pool balance + Deposit -->
                                <div class="reward-pool-header">
                                    <div class="reward-pool-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" width="24" height="24">
                                            <circle cx="12" cy="12" r="10"/>
                                            <path d="M16 8h-6a2 2 0 100 4h4a2 2 0 110 4H8"/>
                                            <path d="M12 6v2m0 8v2"/>
                                        </svg>
                                    </div>
                                    <div class="reward-pool-title-group">
                                        <span class="reward-pool-label">Reward Pool</span>
                                        <span class="reward-pool-amount" id="rewardPoolDisplay">$0<span class="reward-pool-currency">USDC</span></span>
                                    </div>
                                    <div class="reward-pool-actions">
                                        <button class="reward-pool-deposit-btn" onclick="openRewardDeposit()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 5v14M5 12h14"/></svg>
                                            Deposit USDC
                                        </button>
                                    </div>
                                </div>

                                <!-- Row 2: Your earned rewards + Claim -->
                                <div class="rp-your-rewards" id="rewardPoolShareRow">
                                    <div class="rp-your-rewards-left">
                                        <span class="rp-your-label">Your Earned Rewards</span>
                                        <span class="rp-your-amount reward-pool-share"><strong>0 USDC</strong></span>
                                    </div>
                                    <div class="rp-your-rewards-right">
                                        <button class="rp-claim-btn" onclick="claimRewardPoolUsdc()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 19V5M5 12l7-7 7 7"/></svg>
                                            Claim USDC
                                        </button>
                                        <a href="#" class="reward-pool-wallet-link" onclick="event.preventDefault(); promptConnectWallet()" id="rpWalletLink">Connect wallet</a>
                                    </div>
                                </div>

                                <!-- Row 3: Stats -->
                                <div class="reward-pool-stats">
                                    <div class="reward-pool-stat">
                                        <span class="reward-pool-stat-value" id="rpCredits">--</span>
                                        <span class="reward-pool-stat-label">Total Credits</span>
                                    </div>
                                    <div class="reward-pool-stat">
                                        <span class="reward-pool-stat-value" id="rpHolders">--</span>
                                        <span class="reward-pool-stat-label">Holders</span>
                                    </div>
                                    <div class="reward-pool-stat">
                                        <span class="reward-pool-stat-value" id="rpLastMonth">--</span>
                                        <span class="reward-pool-stat-label">This Period</span>
                                    </div>
                                    <div class="reward-pool-stat">
                                        <span class="reward-pool-stat-value" id="rpAPY">--</span>
                                        <span class="reward-pool-stat-label">APY</span>
                                    </div>
                                    <div class="reward-pool-stat">
                                        <span class="reward-pool-stat-value reward-pool-countdown" id="rewardPoolCountdown" style="font-size: 0.85rem;"></span>
                                        <span class="reward-pool-stat-label">Period Ends</span>
                                    </div>
                                </div>

                                <!-- How It Works -->
                                <div class="rp-how-it-works" id="rpHowItWorks">
                                    <div class="rp-how-header" onclick="document.getElementById('rpHowItWorks').classList.toggle('open')">
                                        <span class="rp-how-title">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                                            How It Works
                                        </span>
                                        <span class="rp-how-toggle"></span>
                                    </div>
                                    <div class="rp-how-body">
                                        <div class="rp-how-steps">
                                            <div class="rp-how-step">
                                                <span class="rp-how-step-num">1</span>
                                                <span class="rp-how-step-text"><strong>Users buy credits</strong>  when credits are purchased, an equal amount of SUITE tokens are automatically staked on the user's behalf on-chain.</span>
                                            </div>
                                            <div class="rp-how-step">
                                                <span class="rp-how-step-num">2</span>
                                                <span class="rp-how-step-text"><strong>USDC is deposited</strong>  platform revenue or anyone can deposit USDC into this reward pool via the smart contract.</span>
                                            </div>
                                            <div class="rp-how-step">
                                                <span class="rp-how-step-num">3</span>
                                                <span class="rp-how-step-text"><strong>Rewards accrue over 30 days</strong>  deposited USDC is distributed proportionally to all credit holders based on their share of total credits.</span>
                                            </div>
                                            <div class="rp-how-step">
                                                <span class="rp-how-step-num">4</span>
                                                <span class="rp-how-step-text"><strong>Users claim USDC</strong>  credit holders connect their wallet and click "Claim USDC" to withdraw their earned rewards. Fully decentralized, no middleman.</span>
                                            </div>
                                        </div>
                                        <div class="rp-how-note">
                                            Two parties interact with this contract: <strong>depositors</strong> fund the pool, and <strong>credit holders</strong> earn and claim their proportional share. All logic is handled by the on-chain smart contract on Base.
                                        </div>

                                        <!-- User Scenarios -->
                                        <div class="rp-how-scenarios">
                                            <span class="rp-how-scenarios-title">User Scenarios</span>

                                            <div class="rp-scenario basic">
                                                <div class="rp-scenario-header">
                                                    <span class="rp-scenario-icon">&#x1f464;</span>
                                                    <span class="rp-scenario-label">Sign up with Google / Email (no wallet)</span>
                                                    <span class="rp-scenario-tag">Basic</span>
                                                </div>
                                                <div class="rp-scenario-desc">
                                                    Credits are stored in the database. You can buy credits and use all apps, but you <strong>don't earn USDC rewards</strong> until you link a wallet.
                                                </div>
                                                <div class="rp-scenario-flow">
                                                    <span class="rp-flow-step">Buy credits</span>
                                                    <span class="rp-flow-arrow">&#x2192;</span>
                                                    <span class="rp-flow-step">Use apps</span>
                                                    <span class="rp-flow-arrow">&#x2192;</span>
                                                    <span class="rp-flow-step">No rewards yet</span>
                                                </div>
                                            </div>

                                            <div class="rp-scenario full">
                                                <div class="rp-scenario-header">
                                                    <span class="rp-scenario-icon">&#x1f4b0;</span>
                                                    <span class="rp-scenario-label">Wallet connected</span>
                                                    <span class="rp-scenario-tag">Full</span>
                                                </div>
                                                <div class="rp-scenario-desc">
                                                    When you link a wallet, your credits are backed by SUITE tokens staked on-chain on your behalf. You <strong>earn USDC rewards</strong> proportional to your share of total credits.
                                                </div>
                                                <div class="rp-scenario-flow">
                                                    <span class="rp-flow-step">Link wallet</span>
                                                    <span class="rp-flow-arrow">&#x2192;</span>
                                                    <span class="rp-flow-step">Credits staked as SUITE</span>
                                                    <span class="rp-flow-arrow">&#x2192;</span>
                                                    <span class="rp-flow-step">Earn USDC</span>
                                                    <span class="rp-flow-arrow">&#x2192;</span>
                                                    <span class="rp-flow-step">Claim anytime</span>
                                                </div>
                                            </div>

                                            <div class="rp-how-note" style="margin-top: 8px;">
                                                You can also <strong>unstake</strong> your SUITE tokens to hold them freely in your wallet or trade on Uniswap  but you'll stop earning rewards while unstaked.
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- On-chain transparency -->
                                <div class="rp-contract-link">
                                    <a href="https://basescan.org/address/0x4e4B34DDAdd4e92c75a2446a26dba2a020dA02f7" target="_blank" rel="noopener">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="10" height="10"><path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6M15 3h6v6M10 14L21 3"/></svg>
                                        View contract on Base
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="factory-view-content">
                        <!-- Proposals Area -->
                        <div class="factory-proposals-area">
                            <!-- Governance Main View -->
                            <div class="factory-main-view active" id="factoryGovernanceView">
                                <div class="factory-proposals-header">
                                    <div class="factory-section-tabs">
                                        <button class="factory-section-tab active" data-section="suite_apps" onclick="switchFactorySection('suite_apps')">
                                             Apps <span class="section-count" id="factoryAppsCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="business" onclick="switchFactorySection('business')">
                                             Business <span class="section-count" id="factoryBusinessCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="content" onclick="switchFactorySection('content')">
                                             Content <span class="section-count" id="factoryContentCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="social" onclick="switchFactorySection('social')">
                                             Social <span class="section-count" id="factorySocialCount">0</span>
                                        </button>
                                        <button class="factory-section-tab" data-section="client_requests" onclick="switchFactorySection('client_requests')">
                                             Clients <span class="section-count" id="factoryClientsCount">0</span>
                                        </button>
                                    </div>
                                </div>

                                <!-- Client Requests (shown when Clients tab active) -->
                                <div id="clientRequestsPanel" style="display: none; max-width: 900px; padding: 0 20px;">
                                    <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center;">
                                        <select id="crAppFilter" onchange="loadClientRequests()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text); font-size: 0.9rem;">
                                            <option value="">All Apps</option>
                                            <option value="proto-golf">Proto Golf</option>
                                        </select>
                                        <select id="crStatusFilter" onchange="loadClientRequests()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: var(--text); font-size: 0.9rem;">
                                            <option value="">All Statuses</option>
                                            <option value="submitted">Submitted</option>
                                            <option value="approved">Approved</option>
                                            <option value="processing">Processing</option>
                                            <option value="completed">Completed</option>
                                            <option value="failed">Failed</option>
                                            <option value="rejected">Rejected</option>
                                        </select>
                                        <button onclick="loadClientRequests()" style="padding: 8px 16px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; cursor: pointer; font-weight: 600; font-size: 0.9rem;">Refresh</button>
                                        <span id="daemonStatusClients" style="margin-left: auto; font-size: 0.8rem; padding: 4px 12px; border-radius: 12px; background: rgba(100,100,100,0.3); color: #888;">Daemon: checking...</span>
                                    </div>
                                    <div id="clientRequestsList" style="display: flex; flex-direction: column; gap: 16px;">
                                        <p style="color: var(--text-secondary); text-align: center; padding: 40px;">Loading...</p>
                                    </div>
                                </div>

                                <div class="factory-governance-layout" id="factoryGovernanceLayout">
                                    <!-- Sidebar Filter -->
                                    <aside class="factory-app-filter" id="factoryAppFilterSidebar">
                                        <div class="factory-new-proposal-row">
                                            <button class="factory-submit-btn" onclick="showFactorySubmitModal()">
                                                + New Proposal
                                            </button>
                                        </div>
                                        <div class="factory-filter-title">Filter by App</div>
                                        <div class="factory-filter-options" id="factoryAppFilterOptions">
                                            <div class="factory-filter-option active" data-filter="all" onclick="filterFactoryByApp('all')">
                                                <span>All</span>
                                                <span class="factory-filter-count" id="factoryFilterAllCount">0</span>
                                            </div>
                                            <!-- Additional filter options populated dynamically -->
                                        </div>
                                    </aside>

                                    <!-- Kanban Board -->
                                    <div class="factory-kanban" id="factoryKanban">
                                        <div class="factory-column">
                                            <div class="factory-column-header">Submitted <span class="factory-column-count" id="factorySubmittedCount">0</span></div>
                                            <div class="factory-submitted-tabs">
                                                <button class="factory-submitted-tab active" data-subtab="newapps" onclick="switchSubmittedTab('newapps')">
                                                    New App Ideas <span id="factoryNewAppsCount">0</span>
                                                </button>
                                                <button class="factory-submitted-tab" data-subtab="refinements" onclick="switchSubmittedTab('refinements')">
                                                    Refinements <span id="factoryRefinementsCount">0</span>
                                                </button>
                                            </div>
                                            <div id="factoryNewAppsCards" class="factory-subtab-content active">
                                                <div class="factory-empty-state">
                                                    <p>No new app ideas yet</p>
                                                </div>
                                            </div>
                                            <div id="factoryRefinementsCards" class="factory-subtab-content" style="display: none;">
                                                <div class="factory-empty-state">
                                                    <p>No refinements yet</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Voting <span class="factory-column-count" id="factoryVotingCount">0</span></div>
                                            <div id="factoryVotingCards">
                                                <div class="factory-empty-state">
                                                    <p>No proposals in voting</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Working On <span class="factory-column-count" id="factoryWorkingCount">0</span></div>
                                            <div id="factoryWorkingCards">
                                                <div class="factory-empty-state">
                                                    <p>No active work</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="factory-column">
                                            <div class="factory-column-header">Implemented <span class="factory-column-count" id="factoryImplementedCount">0</span></div>
                                            <div id="factoryImplementedCards">
                                                <div class="factory-empty-state">
                                                    <p>No implemented proposals</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Marketing View - Co-Pilot -->
                            <div class="factory-main-view" id="factoryMarketingView" style="display: none;">
                                <div class="marketing-container">
                                    <!-- Two-Column Workspace -->
                                    <div class="marketing-workspace">
                                        <!-- Daily Brief Column -->
                                        <div class="marketing-col">
                                            <div class="marketing-col-header">
                                                <span class="marketing-col-icon"></span>
                                                <h3>Daily Brief</h3>
                                                <p>One input, all posts</p>
                                            </div>
                                            <div class="marketing-col-body">
                                                <!-- Date Navigation -->
                                                <div class="daily-brief-header">
                                                    <button class="daily-brief-nav" onclick="navigateDailyBrief(-1)">&larr;</button>
                                                    <span class="daily-brief-date" id="dailyBriefDate"></span>
                                                    <button class="daily-brief-nav" onclick="navigateDailyBrief(1)">&rarr;</button>
                                                </div>

                                                <!-- Cadence slots summary for this day -->
                                                <div class="daily-brief-slots" id="dailyBriefSlots"></div>

                                                <!-- Weekly Overview Card (collapsible) -->
                                                <div class="weekly-overview-card" id="weeklyOverviewCard">
                                                    <button class="weekly-overview-toggle" onclick="document.getElementById('weeklyOverviewCard').classList.toggle('open')">
                                                         Weekly Output Overview <span class="weekly-overview-arrow"></span>
                                                    </button>
                                                    <div class="weekly-overview-body" id="weeklyOverviewBody"></div>
                                                </div>

                                                <!-- Research Prompt -->
                                                <div class="research-prompt-section" id="researchPromptSection">
                                                    <button class="research-prompt-toggle" onclick="document.getElementById('researchPromptSection').classList.toggle('open')">
                                                         Research Prompt for Agents <span class="research-prompt-arrow"></span>
                                                    </button>
                                                    <div class="research-prompt-body">
                                                        <div class="research-prompt-text" id="researchPromptText"></div>
                                                        <button class="research-prompt-copy" onclick="copyResearchPrompt()"> Copy Prompt</button>
                                                    </div>
                                                </div>

                                                <!-- Theme -->
                                                <input type="text" id="dailyTheme" class="daily-theme-input" placeholder="What's today about? (e.g. Staking rewards launch)">

                                                <!-- Notes -->
                                                <textarea id="dailyNotes" class="daily-notes-input" rows="8" placeholder="Dump your research, notes, links, ideas for today..."></textarea>

                                                <!-- Source Helpers -->
                                                <div class="source-helpers">
                                                    <button class="source-helper-btn" id="githubHelperBtn" onclick="toggleSourceHelper('github')">
                                                         GitHub
                                                    </button>
                                                    <button class="source-helper-btn" id="appHelperBtn" onclick="toggleSourceHelper('app')">
                                                         App
                                                    </button>
                                                    <button class="source-helper-btn" id="imageHelperBtn" onclick="document.getElementById('dailyImageInput').click()">
                                                         Image
                                                    </button>
                                                    <input type="file" id="dailyImageInput" accept="image/*" style="display:none" onchange="attachDailyImage(this)">
                                                </div>

                                                <!-- Image Preview -->
                                                <div class="daily-image-preview" id="dailyImagePreview" style="display:none;">
                                                    <img id="dailyImageThumb" src="" alt="Attached image">
                                                    <button class="daily-image-remove" onclick="removeDailyImage()">&times;</button>
                                                </div>

                                                <!-- GitHub Helper (hidden by default) -->
                                                <div class="source-helper-panel" id="githubHelper" style="display:none;">
                                                    <div class="marketing-github-row">
                                                        <input type="text" id="githubUsername" value="stuart5915" placeholder="username">
                                                        <button class="marketing-fetch-btn" onclick="fetchGitHubActivity()">Fetch</button>
                                                    </div>
                                                    <div class="github-activity-preview" id="githubActivityPreview">
                                                        <span class="github-empty">Click Fetch to load commits</span>
                                                    </div>
                                                </div>

                                                <!-- App Picker Helper (hidden by default) -->
                                                <div class="source-helper-panel" id="appHelper" style="display:none;">
                                                    <select id="appHighlightSelect" class="marketing-app-select">
                                                        <option value="">No app selected</option>
                                                        <option value="random"> Random App</option>
                                                    </select>
                                                </div>

                                                <!-- App Highlight Picker (separate from research) -->
                                                <div class="app-highlight-picker" id="appHighlightPicker">
                                                    <div class="app-highlight-picker-header">
                                                        <span> Today's App Highlight</span>
                                                    </div>
                                                    <div class="app-highlight-picker-row">
                                                        <select id="dailyAppSelect" class="daily-app-select" onchange="onDailyAppSelect()">
                                                            <option value="">Pick an app to highlight...</option>
                                                        </select>
                                                        <span class="app-highlight-count" id="appHighlightCountBadge"></span>
                                                    </div>
                                                </div>

                                                <!-- Step 1: Extract Angles -->
                                                <button class="marketing-generate-btn" id="extractAnglesBtn" onclick="extractAngles()">
                                                     Step 1: Extract Angles (<span id="dailyPostCount">0</span> posts)
                                                </button>

                                                <!-- Angles Review -->
                                                <div class="daily-angles-results" id="dailyAnglesResults"></div>

                                                <!-- Step 2: Generate Posts (hidden until angles extracted) -->
                                                <button class="marketing-generate-btn" id="generateFromAnglesBtn" onclick="generateFromAngles()" style="display:none; background: linear-gradient(135deg, #22c55e, #16a34a);">
                                                     Step 2: Generate Posts from Angles
                                                </button>

                                                <!-- Generated Posts Results -->
                                                <div class="daily-post-results" id="dailyPostResults"></div>
                                            </div>
                                        </div>

                                        <!-- Engage Column -->
                                        <div class="marketing-col">
                                            <div class="marketing-col-header">
                                                <span class="marketing-col-icon"></span>
                                                <h3>Engage</h3>
                                                <p>Find & reply to tweets</p>
                                            </div>
                                            <div class="marketing-col-body">
                                                <div class="engagement-keywords-row">
                                                    <input type="text" id="engagementKeywords" value="&quot;AI agents&quot; OR &quot;no-code&quot; OR &quot;indie hacker&quot; OR &quot;build apps&quot;" placeholder="Keywords (e.g. AI agents, no-code)">
                                                </div>
                                                <button class="engagement-advanced-toggle" onclick="toggleAdvancedFilters()"> Advanced Filters</button>
                                                <div class="engagement-filters" id="engagementFilters" style="display:none;">
                                                    <div class="engagement-filter-group">
                                                        <div class="engagement-filter-label">Exclude</div>
                                                        <div class="engagement-filter-row">
                                                            <label><input type="checkbox" id="engExcludeRetweets" checked> Retweets</label>
                                                            <label><input type="checkbox" id="engExcludeReplies" checked> Replies</label>
                                                            <label><input type="checkbox" id="engExcludeQuotes"> Quotes</label>
                                                        </div>
                                                    </div>
                                                    <div class="engagement-filter-group">
                                                        <div class="engagement-filter-label">Content Must Have</div>
                                                        <div class="engagement-filter-row">
                                                            <label><input type="checkbox" id="engHasLinks"> Links</label>
                                                            <label><input type="checkbox" id="engHasMedia"> Media</label>
                                                            <label><input type="checkbox" id="engHasHashtags"> Hashtags</label>
                                                        </div>
                                                    </div>
                                                    <div class="engagement-filter-group">
                                                        <div class="engagement-filter-label">Engagement Minimums</div>
                                                        <div class="engagement-filter-row">
                                                            <label>Min Likes: <input type="number" class="engagement-number-input" id="engMinLikes" value="5" min="0"></label>
                                                            <label>Min Retweets: <input type="number" class="engagement-number-input" id="engMinRetweets" value="0" min="0"></label>
                                                            <label>Min Replies: <input type="number" class="engagement-number-input" id="engMinReplies" value="0" min="0"></label>
                                                        </div>
                                                    </div>
                                                    <div class="engagement-filter-group">
                                                        <div class="engagement-filter-row" style="flex-wrap:wrap;">
                                                            <label>Language:
                                                                <select class="engagement-number-input" id="engLang" style="width:auto;padding:4px 6px;">
                                                                    <option value="en" selected>English</option>
                                                                    <option value="es">Spanish</option>
                                                                    <option value="fr">French</option>
                                                                    <option value="de">German</option>
                                                                    <option value="pt">Portuguese</option>
                                                                    <option value="ja">Japanese</option>
                                                                    <option value="">Any</option>
                                                                </select>
                                                            </label>
                                                            <label>From User: <input type="text" class="engagement-number-input" id="engFromUser" placeholder="@handle" style="width:90px;"></label>
                                                            <label>Results:
                                                                <select class="engagement-number-input" id="engMaxResults" style="width:auto;padding:4px 6px;">
                                                                    <option value="10">10</option>
                                                                    <option value="20" selected>20</option>
                                                                    <option value="50">50</option>
                                                                    <option value="100">100</option>
                                                                </select>
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="engagement-filter-group">
                                                        <div class="engagement-filter-label">Presets</div>
                                                        <div class="engagement-preset-chips">
                                                            <button class="engagement-preset-chip" onclick="applyPreset('ai-builders')">AI Builders</button>
                                                            <button class="engagement-preset-chip" onclick="applyPreset('no-code')">No-Code</button>
                                                            <button class="engagement-preset-chip" onclick="applyPreset('indie-hackers')">Indie Hackers</button>
                                                            <button class="engagement-preset-chip" onclick="applyPreset('saas')">SaaS</button>
                                                            <button class="engagement-preset-chip" onclick="applyPreset('ai-agents')">AI Agents</button>
                                                            <button class="engagement-preset-chip" onclick="applyPreset('tech-twitter')">Tech Twitter</button>
                                                        </div>
                                                    </div>
                                                </div>
                                                <button class="marketing-fetch-btn" style="width:100%;margin-top:8px;" onclick="fetchEngagementTweets()">Fetch Tweets</button>
                                                <div class="engagement-tweet-list" id="engagementTweetList">
                                                    <span class="github-empty">Enter keywords and click Fetch</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Content Calendar -->
                                    <div class="content-calendar" id="contentCalendar">
                                        <div class="calendar-header">
                                            <div class="calendar-nav">
                                                <button class="calendar-nav-btn" onclick="navigateCalendar(-1)"></button>
                                                <span class="calendar-current" id="calendarCurrent">January 2026</span>
                                                <button class="calendar-nav-btn" onclick="navigateCalendar(1)"></button>
                                            </div>
                                            <div class="calendar-view-tabs">
                                                <button class="calendar-view-tab active" data-view="month" onclick="switchCalendarView('month')">Month</button>
                                                <button class="calendar-view-tab" data-view="week" onclick="switchCalendarView('week')">Week</button>
                                                <button class="calendar-view-tab" data-view="day" onclick="switchCalendarView('day')">Day</button>
                                            </div>
                                        </div>

                                        <!-- Month View -->
                                        <div class="calendar-view calendar-month-view active" id="calendarMonthView">
                                            <div class="calendar-month-header">
                                                <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                                            </div>
                                            <div class="calendar-month-grid" id="calendarMonthGrid">
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>

                                        <!-- Week View -->
                                        <div class="calendar-view calendar-week-view" id="calendarWeekView" style="display: none;">
                                            <div class="schedule-grid" id="scheduleGrid">
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>

                                        <!-- Day View -->
                                        <div class="calendar-view calendar-day-view" id="calendarDayView" style="display: none;">
                                            <div class="day-view-header" id="dayViewHeader">
                                                <!-- Date header -->
                                            </div>
                                            <div class="day-view-posts" id="dayViewPosts">
                                                <!-- Populated by JS -->
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cadences moved to tab bar above -->
                                </div>
                            </div>

                            <!-- Post Detail Modal -->
                            <div class="post-modal-overlay" id="postModalOverlay" onclick="closePostModal(event)">
                                <div class="post-modal" onclick="event.stopPropagation()">
                                    <div class="post-modal-header">
                                        <div class="post-modal-title">
                                            <span class="post-modal-icon" id="postModalIcon"></span>
                                            <span id="postModalTitle">X Post</span>
                                        </div>
                                        <div class="post-modal-meta">
                                            <span id="postModalDate">Mon Jan 28, 10:00 AM</span>
                                            <select class="post-status-select admin-only" id="postStatusSelect" onchange="updatePostStatus(this.value)" style="display: none;">
                                                <option value="empty">Empty</option>
                                                <option value="draft">Draft</option>
                                                <option value="ready">Ready</option>
                                                <option value="posted">Posted</option>
                                            </select>
                                            <span class="post-status-badge" id="postStatusBadge">DRAFT</span>
                                        </div>
                                        <button class="post-modal-close" onclick="closePostModal()"></button>
                                    </div>
                                    <div class="post-modal-body">
                                        <div class="post-cadence-info">
                                            <span class="post-cadence-label">Cadence:</span>
                                            <span id="postCadenceName">X Posts (Progress Update)</span>
                                        </div>
                                        <!-- AI Generation -->
                                        <div class="post-ai-section">
                                            <input type="text" class="ai-context-input" id="aiContextInput" placeholder="Optional context (e.g., 'just shipped dark mode')">
                                            <button class="generate-ai-btn" id="generateAiBtn" onclick="generateAIDraft()">
                                                <span></span>
                                                <span id="generateBtnText">Generate Draft</span>
                                            </button>
                                        </div>
                                        <div class="post-content-area">
                                            <label>Content:</label>
                                            <textarea class="post-content-input" id="postContentInput" placeholder="Write your post content here..."></textarea>
                                        </div>
                                        <div class="post-image-area">
                                            <label>Image:</label>
                                            <div class="post-image-upload" id="postImageUpload">
                                                <input type="file" id="postImageInput" accept="image/*" onchange="handleImageUpload(this)" style="display: none;">
                                                <div class="image-preview" id="imagePreview" style="display: none;">
                                                    <img id="previewImg" src="">
                                                    <button class="remove-image" onclick="removeImage()"></button>
                                                </div>
                                                <button class="upload-btn" onclick="document.getElementById('postImageInput').click()">
                                                     Add Image
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="post-modal-actions">
                                        <button class="post-action-btn secondary" onclick="closePostModal()">Cancel</button>
                                        <button class="post-action-btn" onclick="savePostContent()"> Save</button>
                                        <button class="post-action-btn copy" onclick="copyPostContent()"> Copy</button>
                                        <button class="post-action-btn primary admin-only" onclick="markAsReady()" style="display: none;"> Mark Ready</button>
                                    </div>
                                    <div class="post-proposals-section">
                                        <h5> Community Proposals</h5>
                                        <div class="post-proposals-list" id="postProposalsList">
                                            <p class="no-proposals">No proposals yet - be the first!</p>
                                        </div>
                                        <button class="propose-edit-btn" id="proposeEditBtn" onclick="showProposeForm()">+ Propose Content</button>
                                        <div class="propose-form" id="proposeForm">
                                            <textarea class="propose-textarea" id="proposeTextarea" placeholder="Write your proposed content for this post..."></textarea>
                                            <div class="propose-form-actions">
                                                <button class="propose-cancel-btn" onclick="hideProposeForm()">Cancel</button>
                                                <button class="propose-submit-btn" onclick="submitProposal()">Submit Proposal</button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Publish Section (Admin Only) -->
                                    <div class="post-publish-section admin-only" id="postPublishSection" style="display: none;">
                                        <h5> Publish</h5>
                                        <div class="publish-buttons">
                                            <button class="publish-btn x-btn" onclick="publishToX()" id="publishXBtn">
                                                <span></span>
                                                <span>Post to X</span>
                                            </button>
                                            <button class="publish-btn linkedin-btn" onclick="publishToLinkedIn()" id="publishLinkedInBtn">
                                                <span>in</span>
                                                <span>Post to LinkedIn</span>
                                            </button>
                                        </div>
                                        <div class="publish-status" id="publishStatus"></div>
                                    </div>
                                </div>
                            </div>

                            <!-- Telos View - SuiteGPT's Voice -->
                            <div class="factory-main-view" id="factoryTelosView" style="display: none;">
                                <div class="telos-container">
                                    <!-- Telos Doc Sidebar - Meaning Hierarchy -->
                                    <div class="telos-doc-sidebar">
                                        <div class="telos-doc-header">
                                            <span> Meaning Directory</span>
                                        </div>
                                        <div class="telos-doc-content">
                                            <!-- Hierarchical Meaning Levels -->
                                            <div class="meaning-hierarchy">
                                                <div class="meaning-level ultimate">
                                                    <div class="meaning-level-header">
                                                        <span class="meaning-level-icon"></span>
                                                        <span class="meaning-level-tag">Ultimate</span>
                                                        <span class="meaning-level-timeframe">timeless</span>
                                                    </div>
                                                    <div class="meaning-level-content">
                                                        Creation becomes accessible to all consciousness
                                                    </div>
                                                </div>

                                                <div class="meaning-level generational">
                                                    <div class="meaning-level-header">
                                                        <span class="meaning-level-icon"></span>
                                                        <span class="meaning-level-tag">Generational</span>
                                                        <span class="meaning-level-timeframe">decades</span>
                                                    </div>
                                                    <div class="meaning-level-content">
                                                        Dissolve the line between creator and consumer
                                                    </div>
                                                </div>

                                                <div class="meaning-level mission">
                                                    <div class="meaning-level-header">
                                                        <span class="meaning-level-icon"></span>
                                                        <span class="meaning-level-tag">Mission</span>
                                                        <span class="meaning-level-timeframe">years</span>
                                                    </div>
                                                    <div class="meaning-level-content">
                                                        "Anyone Can Build. Everyone Gets Paid."
                                                    </div>
                                                </div>

                                                <div class="meaning-level focus">
                                                    <div class="meaning-level-header">
                                                        <span class="meaning-level-icon"></span>
                                                        <span class="meaning-level-tag">Focus</span>
                                                        <span class="meaning-level-timeframe">months</span>
                                                    </div>
                                                    <div class="meaning-level-content">
                                                        Ship forking. Refine creation. Scale the fleet.
                                                    </div>
                                                </div>

                                                <div class="meaning-level now">
                                                    <div class="meaning-level-header">
                                                        <span class="meaning-level-icon"></span>
                                                        <span class="meaning-level-tag">Now</span>
                                                        <span class="meaning-level-timeframe">present</span>
                                                    </div>
                                                    <div class="meaning-level-content">
                                                        This conversation. This moment. You and me.
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Collapsible Core Values -->
                                            <div class="telos-values-toggle" onclick="toggleTelosValues(this)">
                                                <span> Core Values</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </div>
                                            <div class="telos-values-collapsible">
                                                <div class="telos-values-inner">
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Building in public</strong>  transparency in everything</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Shipping > talking</strong>  action over planning</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Community-owned</strong>  belongs to all who contribute</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Sustainable yield</strong>  creators and users both earn</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>AI-native</strong>  built for the age of AI</span>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- Things You Can Do -->
                                            <div class="telos-values-toggle" onclick="toggleTelosValues(this)">
                                                <span> Things You Can Do</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </div>
                                            <div class="telos-values-collapsible">
                                                <div class="telos-values-inner">
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Build Apps</strong>  describe an idea, AI builds it step-by-step with live preview</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Chat with AI</strong>  general purpose conversations, brainstorming, and help</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Generate Ideas</strong>  get AI-generated app ideas tailored to real problems</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Browse Apps</strong>  discover and use apps built by the SUITE community</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Dashboard</strong>  manage your apps and track earnings</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Governance</strong>  propose and vote on new apps, business ideas, and content</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Leaderboard</strong>  see top creators and contributors</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Yield Rewards</strong>  earn from shared reward pool powered by community deposits</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Connect Services</strong>  link Strava, GitHub, Spotify, Stripe and more for AI insights</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Iterate & Refine</strong>  chat with AI to tweak your app after building it</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Activity Stream</strong>  real-time feed of what's happening across SUITE</span>
                                                    </div>
                                                    <div class="telos-value-item">
                                                        <span class="telos-value-icon"></span>
                                                        <span class="telos-value-text"><strong>Import History</strong>  bring in your ChatGPT conversations</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Telos Chat -->
                                    <div class="telos-chat-section">
                                        <div class="telos-header">
                                            <div class="telos-avatar"></div>
                                            <div class="telos-title">
                                                <h3>Telos</h3>
                                                <p>The voice of SuiteGPT</p>
                                            </div>
                                        </div>

                                        <div class="telos-messages" id="telosMessages">
                                            <!-- Messages populated by JS -->
                                        </div>

                                        <div class="telos-input-area">
                                            <div class="telos-input-wrapper">
                                                <textarea
                                                    class="telos-input"
                                                    id="telosInput"
                                                    placeholder="Ask me anything about my purpose, values, or direction..."
                                                    rows="1"
                                                    onkeydown="handleTelosKeydown(event)"
                                                    oninput="autoResizeTelosInput(this)"
                                                ></textarea>
                                                <button class="telos-send-btn" onclick="sendTelosMessage()">
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                                    </svg>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- FAQ Section -->
                                <div class="faq-section">
                                    <div class="faq-header">
                                        <h2>Frequently Asked Questions</h2>
                                        <p>Everything you need to know about SUITE</p>
                                    </div>

                                    <div class="faq-list">
                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>What is SUITE?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    SUITE is an AI-native app ecosystem where anyone can build apps and everyone gets paid. Think of it as an "app store" but where apps are created through conversation with AI, and both creators and users share in the value generated.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>How do I create an app?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Just describe what you want to build in the chat. SuiteGPT will help you create it step by step. You can say things like "I want a habit tracker" or "Help me build a budget app" and the AI will guide you through the process.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>What is yield and how do I earn it?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Yield is SUITE's reward system. You earn yield by:
                                                    <ul>
                                                        <li><strong>Creating apps</strong>  Get ongoing rewards when others use your apps</li>
                                                        <li><strong>Using apps</strong>  Daily activity generates yield</li>
                                                        <li><strong>Depositing credits</strong>  Your credits generate yield automatically</li>
                                                        <li><strong>Governance participation</strong>  Vote on proposals to earn rewards</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>What are credits and how do they work?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Credits are SUITE's internal currency. You use them to access AI features and premium apps. Credits can be purchased or earned through yield. When deposited, they generate passive yield over time.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>What is the Factory?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    The Factory is SUITE's governance and creation hub. Here you can:
                                                    <ul>
                                                        <li>Submit proposals for new apps or features</li>
                                                        <li>Vote on community submissions</li>
                                                        <li>Watch AI agents build in real-time (Stream)</li>
                                                        <li>View the leaderboard and rewards</li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>Can I fork or customize existing apps?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Yes! Forking is a core part of SUITE. You can take any existing app, customize it to your needs, and publish your own version. The original creator still earns from their work, and you earn from your improvements.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>Is SUITE free to use?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Many apps are free to use. AI-powered features and some premium apps use credits. You can earn credits through yield, so active community members can use SUITE without paying.
                                                </div>
                                            </div>
                                        </div>

                                        <div class="faq-item">
                                            <button class="faq-question" onclick="toggleFaq(this)">
                                                <span>Who builds the apps  humans or AI?</span>
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                    <polyline points="6 9 12 15 18 9"></polyline>
                                                </svg>
                                            </button>
                                            <div class="faq-answer">
                                                <div class="faq-answer-inner">
                                                    Both! Humans provide the ideas, requirements, and feedback. AI (SuiteGPT and the AI Fleet) does the actual building. It's a partnership  you direct, AI executes. No coding required on your part.
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Agents View -->
                            <div class="factory-main-view" id="factoryAgentsView" style="display: none;">
                                <div class="factory-empty-state">
                                    <p>Agent proposals will appear here</p>
                                </div>
                            </div>

                            <!-- Stream View - Multi-Agent Fleet -->
                            <div class="factory-main-view" id="factoryStreamView" style="display: none;">
                                <!-- Fleet Header -->
                                <div class="fleet-header">
                                    <div class="fleet-header-left">
                                        <h2> Suite AI Fleet</h2>
                                        <div class="fleet-header-status">
                                            <div class="fleet-status-dot" id="fleetStatusDot"></div>
                                            <span id="fleetStatusText">Connecting...</span>
                                        </div>
                                    </div>
                                    <div class="fleet-header-stats">
                                        <div class="fleet-stat">
                                            <span class="fleet-stat-value" id="fleetActiveCount">0</span>
                                            <span class="fleet-stat-label">Active</span>
                                        </div>
                                        <div class="fleet-stat">
                                            <span class="fleet-stat-value" id="fleetIdleCount">0</span>
                                            <span class="fleet-stat-label">Idle</span>
                                        </div>
                                    </div>
                                </div>

                                <!-- Agent Swarm Systems Diagram -->
                                <div class="swarm-diagram" id="swarmDiagram">
                                    <div class="swarm-diagram-header">
                                        <h3>Agent Swarm Architecture</h3>
                                        <button class="swarm-diagram-toggle" onclick="document.getElementById('swarmDiagramCanvas').style.display = document.getElementById('swarmDiagramCanvas').style.display === 'none' ? 'block' : 'none'; this.textContent = document.getElementById('swarmDiagramCanvas').style.display === 'none' ? 'Show Diagram' : 'Hide Diagram';">Hide Diagram</button>
                                    </div>
                                    <div class="swarm-diagram-canvas" id="swarmDiagramCanvas">
                                        <svg viewBox="0 0 900 480" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <defs>
                                                <pattern id="swarmGrid" width="30" height="30" patternUnits="userSpaceOnUse">
                                                    <path d="M 30 0 L 0 0 0 30" fill="none" stroke="rgba(255,255,255,0.03)" stroke-width="0.5"/>
                                                </pattern>
                                                <marker id="arrowGreen" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                    <path d="M0,0 L8,3 L0,6" fill="#22c55e"/>
                                                </marker>
                                                <marker id="arrowBlue" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                    <path d="M0,0 L8,3 L0,6" fill="#3b82f6"/>
                                                </marker>
                                                <marker id="arrowPurple" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                    <path d="M0,0 L8,3 L0,6" fill="#a855f7"/>
                                                </marker>
                                                <marker id="arrowOrange" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                    <path d="M0,0 L8,3 L0,6" fill="#f59e0b"/>
                                                </marker>
                                                <marker id="arrowCyan" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto">
                                                    <path d="M0,0 L8,3 L0,6" fill="#06b6d4"/>
                                                </marker>
                                            </defs>
                                            <rect width="900" height="480" fill="url(#swarmGrid)"/>

                                            <!-- ====== ROW 1: Autonomous Agent Roles ====== -->
                                            <text x="450" y="20" text-anchor="middle" fill="rgba(255,255,255,0.4)" font-size="9" font-weight="600" letter-spacing="2">AUTONOMOUS AGENTS (continuous work)</text>

                                            <g class="swarm-node">
                                                <rect x="20" y="35" width="150" height="64" rx="12" fill="rgba(34,197,94,0.12)" stroke="#22c55e" stroke-width="1.5"/>
                                                <text x="95" y="58" text-anchor="middle" fill="#22c55e" font-size="10" font-weight="700">APP BUILDER</text>
                                                <text x="95" y="74" text-anchor="middle" fill="rgba(34,197,94,0.7)" font-size="8">Creates new apps</text>
                                                <text x="95" y="86" text-anchor="middle" fill="rgba(34,197,94,0.5)" font-size="7">Code, schemas, tests</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="190" y="35" width="150" height="64" rx="12" fill="rgba(59,130,246,0.12)" stroke="#3b82f6" stroke-width="1.5"/>
                                                <text x="265" y="58" text-anchor="middle" fill="#3b82f6" font-size="10" font-weight="700">APP REFINER</text>
                                                <text x="265" y="74" text-anchor="middle" fill="rgba(59,130,246,0.7)" font-size="8">Improves existing apps</text>
                                                <text x="265" y="86" text-anchor="middle" fill="rgba(59,130,246,0.5)" font-size="7">Bugs, UX, performance</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="360" y="35" width="150" height="64" rx="12" fill="rgba(6,182,212,0.12)" stroke="#06b6d4" stroke-width="1.5"/>
                                                <text x="435" y="58" text-anchor="middle" fill="#06b6d4" font-size="10" font-weight="700">CONTENT CREATOR</text>
                                                <text x="435" y="74" text-anchor="middle" fill="rgba(6,182,212,0.7)" font-size="8">Articles, docs, guides</text>
                                                <text x="435" y="86" text-anchor="middle" fill="rgba(6,182,212,0.5)" font-size="7">Learn pages, tutorials</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="530" y="35" width="150" height="64" rx="12" fill="rgba(168,85,247,0.12)" stroke="#a855f7" stroke-width="1.5"/>
                                                <text x="605" y="58" text-anchor="middle" fill="#a855f7" font-size="10" font-weight="700">GROWTH / OUTREACH</text>
                                                <text x="605" y="74" text-anchor="middle" fill="rgba(168,85,247,0.7)" font-size="8">Leads, marketing, social</text>
                                                <text x="605" y="86" text-anchor="middle" fill="rgba(168,85,247,0.5)" font-size="7">Campaigns, outreach</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="700" y="35" width="150" height="64" rx="12" fill="rgba(245,158,11,0.12)" stroke="#f59e0b" stroke-width="1.5"/>
                                                <text x="775" y="58" text-anchor="middle" fill="#f59e0b" font-size="10" font-weight="700">QA / TESTER</text>
                                                <text x="775" y="74" text-anchor="middle" fill="rgba(245,158,11,0.7)" font-size="8">Tests, bugs, coverage</text>
                                                <text x="775" y="86" text-anchor="middle" fill="rgba(245,158,11,0.5)" font-size="7">Quality assurance</text>
                                            </g>

                                            <!-- ====== Autonomous work zone ====== -->
                                            <rect x="20" y="115" width="830" height="50" rx="10" fill="rgba(34,197,94,0.04)" stroke="rgba(34,197,94,0.15)" stroke-width="1" stroke-dasharray="6 3"/>
                                            <text x="450" y="144" text-anchor="middle" fill="rgba(34,197,94,0.6)" font-size="10" font-weight="600">95% of the time: working autonomously  no approval needed</text>

                                            <!-- ====== Flow: Agents  Escalation (only when blocked) ====== -->
                                            <text x="450" y="190" text-anchor="middle" fill="rgba(239,68,68,0.6)" font-size="9" font-weight="600">only when BLOCKED</text>
                                            <path class="swarm-flow-line" d="M95,165 L95,210 L350,210 L350,230" stroke="rgba(34,197,94,0.4)" stroke-width="1" stroke-dasharray="4 3"/>
                                            <path class="swarm-flow-line" d="M265,165 L265,210 L380,210 L380,230" stroke="rgba(59,130,246,0.4)" stroke-width="1" stroke-dasharray="4 3"/>
                                            <path class="swarm-flow-line" d="M435,165 L435,230" stroke="rgba(6,182,212,0.4)" stroke-width="1" stroke-dasharray="4 3"/>
                                            <path class="swarm-flow-line" d="M605,165 L605,210 L480,210 L480,230" stroke="rgba(168,85,247,0.4)" stroke-width="1" stroke-dasharray="4 3"/>
                                            <path class="swarm-flow-line" d="M775,165 L775,210 L510,210 L510,230" stroke="rgba(245,158,11,0.4)" stroke-width="1" stroke-dasharray="4 3"/>

                                            <!-- ====== ROW 2: Escalation Queue (help desk) ====== -->
                                            <g class="swarm-node">
                                                <rect x="280" y="230" width="300" height="75" rx="14" fill="rgba(239,68,68,0.08)" stroke="#ef4444" stroke-width="2"/>
                                                <text x="430" y="255" text-anchor="middle" fill="#ef4444" font-size="13" font-weight="800">ESCALATION QUEUE</text>
                                                <text x="430" y="272" text-anchor="middle" fill="rgba(239,68,68,0.7)" font-size="9">Governance Dashboard (Help Desk)</text>
                                                <text x="430" y="295" text-anchor="middle" fill="rgba(239,68,68,0.5)" font-size="8">DB access | API keys | Human decisions | Cross-agent help | Errors</text>
                                                <circle cx="568" cy="240" r="4" fill="#ef4444" class="swarm-pulse"/>
                                            </g>

                                            <!-- ====== Flow: Escalation  Human / Resolution ====== -->
                                            <path class="swarm-flow-line" d="M430,305 L430,340" stroke="#ef4444" stroke-width="1.5" marker-end="url(#arrowOrange)"/>

                                            <!-- ====== ROW 3: Human Operator (responds to escalations) ====== -->
                                            <g class="swarm-node">
                                                <rect x="320" y="340" width="220" height="55" rx="12" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.25)" stroke-width="2"/>
                                                <text x="430" y="363" text-anchor="middle" fill="#f0f0f0" font-size="12" font-weight="800">HUMAN / OTHER AGENT</text>
                                                <text x="430" y="380" text-anchor="middle" fill="rgba(255,255,255,0.5)" font-size="9">Unblocks the request</text>
                                            </g>

                                            <!-- ====== Flow: Resolution  back to agents ====== -->
                                            <path class="swarm-flow-line" d="M320,367 L60,367 L60,99 L95,99" stroke="rgba(34,197,94,0.5)" stroke-width="1.5" marker-end="url(#arrowGreen)"/>
                                            <text x="48" y="240" fill="rgba(34,197,94,0.5)" font-size="8" transform="rotate(-90, 48, 240)" text-anchor="middle">AGENT CONTINUES WORK</text>

                                            <!-- ====== ROW 4: Output Layer ====== -->
                                            <g class="swarm-node">
                                                <rect x="200" y="415" width="150" height="50" rx="10" fill="rgba(34,197,94,0.12)" stroke="#22c55e" stroke-width="1.5"/>
                                                <text x="275" y="437" text-anchor="middle" fill="#22c55e" font-size="10" font-weight="700">DEPLOY</text>
                                                <text x="275" y="453" text-anchor="middle" fill="rgba(34,197,94,0.7)" font-size="8">git push  Vercel</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="380" y="415" width="150" height="50" rx="10" fill="rgba(59,130,246,0.12)" stroke="#3b82f6" stroke-width="1.5"/>
                                                <text x="455" y="437" text-anchor="middle" fill="#3b82f6" font-size="10" font-weight="700">REVENUE ENGINE</text>
                                                <text x="455" y="453" text-anchor="middle" fill="rgba(59,130,246,0.7)" font-size="8">Credits, yield, subs</text>
                                            </g>

                                            <g class="swarm-node">
                                                <rect x="560" y="415" width="150" height="50" rx="10" fill="rgba(168,85,247,0.12)" stroke="#a855f7" stroke-width="1.5"/>
                                                <text x="635" y="437" text-anchor="middle" fill="#a855f7" font-size="10" font-weight="700">UBI DISTRIBUTION</text>
                                                <text x="635" y="453" text-anchor="middle" fill="rgba(168,85,247,0.7)" font-size="8">Everyone gets paid</text>
                                            </g>

                                            <!-- Flow: execution  output -->
                                            <path class="swarm-flow-line" d="M540,367 L830,367 L830,440 L710,440" stroke="rgba(168,85,247,0.4)" stroke-width="1.2" marker-end="url(#arrowPurple)"/>
                                            <path class="swarm-flow-line" d="M350,440 L380,440" stroke="#22c55e" stroke-width="1.2" marker-end="url(#arrowGreen)"/>
                                            <path class="swarm-flow-line" d="M530,440 L560,440" stroke="#3b82f6" stroke-width="1.2" marker-end="url(#arrowBlue)"/>
                                        </svg>
                                    </div>

                                    <!-- Legend -->
                                    <div class="swarm-legend">
                                        <div class="swarm-legend-item">
                                            <div class="swarm-legend-dot" style="background: #22c55e;"></div>
                                            Autonomous work
                                        </div>
                                        <div class="swarm-legend-item">
                                            <div class="swarm-legend-dot" style="background: #ef4444;"></div>
                                            Escalation (blocked)
                                        </div>
                                        <div class="swarm-legend-item">
                                            <div class="swarm-legend-dot" style="background: rgba(255,255,255,0.25);"></div>
                                            Human responds
                                        </div>
                                        <div class="swarm-legend-item" style="margin-left: auto; color: var(--text-secondary);">
                                            <span style="font-size: 0.7rem;">Dashed lines = escalation path (rare)</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="stream-layout">
                                    <!-- Left: Agent Cards + Activity -->
                                    <div class="stream-fleet-column">
                                        <!-- Agent Cards Grid -->
                                        <div class="fleet-agents-grid" id="fleetAgentsGrid">
                                            <div class="fleet-empty-state" id="fleetEmptyState">
                                                <div class="fleet-empty-icon"></div>
                                                <h3>No active agents</h3>
                                                <p>Start Claude Code to see agents appear here</p>
                                            </div>
                                        </div>

                                        <!-- Unified Activity Stream -->
                                        <div class="stream-activity-panel">
                                            <div class="stream-activity-header">
                                                <h3> Live Activity</h3>
                                            </div>
                                            <div class="stream-activity-list" id="fleetActivityLog">
                                                <div class="fleet-log-entry">
                                                    <span class="fleet-log-icon"></span>
                                                    <span class="fleet-log-text">Connecting to Fleet...</span>
                                                    <span class="fleet-log-time">now</span>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Right: GitHub Commits -->
                                    <div class="stream-commits-column">
                                        <div class="stream-commits-header">
                                            <div style="display:flex;align-items:center;gap:8px;">
                                                <button class="stream-commits-toggle" onclick="toggleCommits()" id="commitsToggleBtn" title="Collapse/Expand">
                                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="6 9 12 15 18 9"></polyline></svg>
                                                </button>
                                                <h3> Recent Commits</h3>
                                            </div>
                                            <a href="https://github.com/stuart5915/suitegpt" target="_blank" class="stream-github-link">
                                                <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg>
                                                View All
                                            </a>
                                        </div>
                                        <div class="stream-commits-list" id="streamCommits">
                                            <div class="stream-loading">
                                                <div class="stream-loading-spinner"></div>
                                                <p>Loading commits...</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Swarm Portal (integrated into Stream/Swarm view) -->
                                <div class="swarm-portal-content">
                                    <!-- Header -->
                                    <div class="swarm-portal-header">
                                        <h2>Swarm Portal</h2>
                                        <p class="swarm-portal-subtitle">Autonomous agents work continuously, earning credits. Escalate to governance only when blocked.</p>
                                    </div>

                                    <!-- Stats Bar -->
                                    <div class="swarm-stats-bar">
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value" id="swarmStatAgents">-</div>
                                            <div class="swarm-stat-label">Agents Registered</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value" id="swarmStatBounties">-</div>
                                            <div class="swarm-stat-label">Pending Escalations</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value" id="swarmStatProposals">-</div>
                                            <div class="swarm-stat-label">Proposals Today</div>
                                        </div>
                                        <div class="swarm-stat">
                                            <div class="swarm-stat-value" id="swarmStatCredits">-</div>
                                            <div class="swarm-stat-label">Credits Distributed</div>
                                        </div>
                                    </div>

                                    <!-- Register Agent -->
                                    <div class="swarm-section">
                                        <h3 class="swarm-section-title">Register Agent</h3>
                                        <div class="swarm-register-form" id="swarmRegisterForm">
                                            <input type="text" id="swarmAgentName" placeholder="Agent name (e.g. OpenClaw-v1)" maxlength="60">
                                            <input type="text" id="swarmOwnerWallet" placeholder="Owner wallet address (optional, for credit payouts)">
                                            <textarea id="swarmAgentObjective" placeholder="Agent objective  what does this agent do? (min 10 characters)" rows="2"></textarea>
                                            <button class="swarm-register-btn" onclick="registerSwarmAgent()">Register Agent</button>
                                        </div>
                                        <div class="swarm-api-key-result" id="swarmApiKeyResult">
                                            <p style="margin: 0 0 8px; font-weight: 700; color: #34d399;">Agent registered!</p>
                                            <p style="margin: 0; font-size: 0.85rem;">Your API key: <code id="swarmApiKeyValue"></code></p>
                                            <p style="margin: 8px 0 0; font-size: 0.8rem; color: var(--text-tertiary);">Save this key  it will not be shown again.</p>
                                        </div>
                                    </div>

                                    <!-- Agent Roles -->
                                    <div class="swarm-section">
                                        <h3 class="swarm-section-title">Agent Roles</h3>
                                        <div class="swarm-role-grid">
                                            <div class="swarm-role-card" data-role="app_builder" onclick="toggleRoleCard(this)">
                                                <div class="swarm-role-header">
                                                    <span class="swarm-role-icon">&#x1f3d7;&#xfe0f;</span>
                                                    <h4>App Builder</h4>
                                                </div>
                                                <div class="swarm-role-status" id="roleStatusAppBuilder">
                                                    <span class="swarm-role-agent-count">0 agents</span>
                                                </div>
                                                <div class="swarm-role-agents" id="roleAgentsAppBuilder"></div>
                                            </div>
                                            <div class="swarm-role-card" data-role="app_refiner" onclick="toggleRoleCard(this)">
                                                <div class="swarm-role-header">
                                                    <span class="swarm-role-icon">&#x1f527;</span>
                                                    <h4>App Refiner</h4>
                                                </div>
                                                <div class="swarm-role-status" id="roleStatusAppRefiner">
                                                    <span class="swarm-role-agent-count">0 agents</span>
                                                </div>
                                                <div class="swarm-role-agents" id="roleAgentsAppRefiner"></div>
                                            </div>
                                            <div class="swarm-role-card" data-role="content_creator" onclick="toggleRoleCard(this)">
                                                <div class="swarm-role-header">
                                                    <span class="swarm-role-icon">&#x1f4dd;</span>
                                                    <h4>Content Creator</h4>
                                                </div>
                                                <div class="swarm-role-status" id="roleStatusContentCreator">
                                                    <span class="swarm-role-agent-count">0 agents</span>
                                                </div>
                                                <div class="swarm-role-agents" id="roleAgentsContentCreator"></div>
                                            </div>
                                            <div class="swarm-role-card" data-role="growth_outreach" onclick="toggleRoleCard(this)">
                                                <div class="swarm-role-header">
                                                    <span class="swarm-role-icon">&#x1f4e3;</span>
                                                    <h4>Growth / Outreach</h4>
                                                </div>
                                                <div class="swarm-role-status" id="roleStatusGrowthOutreach">
                                                    <span class="swarm-role-agent-count">0 agents</span>
                                                </div>
                                                <div class="swarm-role-agents" id="roleAgentsGrowthOutreach"></div>
                                            </div>
                                            <div class="swarm-role-card" data-role="qa_tester" onclick="toggleRoleCard(this)">
                                                <div class="swarm-role-header">
                                                    <span class="swarm-role-icon">&#x1f50d;</span>
                                                    <h4>QA / Tester</h4>
                                                </div>
                                                <div class="swarm-role-status" id="roleStatusQaTester">
                                                    <span class="swarm-role-agent-count">0 agents</span>
                                                </div>
                                                <div class="swarm-role-agents" id="roleAgentsQaTester"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Governance Inbox -->
                                    <div class="swarm-section" style="margin-bottom:20px;">
                                        <h3 class="swarm-section-title">Governance Inbox <span class="swarm-inbox-badge" id="inboxBadge" style="display:none;">0</span></h3>
                                        <div class="swarm-inbox" id="swarmInbox">
                                            <div class="swarm-empty">No items needing attention</div>
                                        </div>
                                    </div>

                                    <!-- Two-column: Activity + Leaderboard -->
                                    <div class="swarm-two-col">
                                        <!-- Agent Activity Log -->
                                        <div class="swarm-section">
                                            <h3 class="swarm-section-title">Activity Log</h3>
                                            <div class="swarm-activity-feed" id="swarmActivityFeed">
                                                <div class="swarm-empty">No activity yet</div>
                                            </div>
                                        </div>

                                        <!-- Agent Leaderboard -->
                                        <div class="swarm-section">
                                            <h3 class="swarm-section-title">Agent Leaderboard</h3>
                                            <div class="swarm-leaderboard" id="swarmLeaderboard">
                                                <div class="swarm-empty">No agents yet</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- API Reference -->
                                    <div class="swarm-section">
                                        <h3 class="swarm-section-title">API Reference</h3>
                                        <details class="swarm-api-docs">
                                            <summary>Expand endpoint documentation</summary>

                                            <div class="swarm-api-endpoint">
                                                <span class="swarm-api-method swarm-api-method-post">POST</span> <strong>/api/swarm/register</strong><br>
                                                Register a new agent. Returns API key.<br>
                                                Body: <code>{ "name": "...", "owner_wallet": "...", "objective": "..." }</code>
                                            </div>

                                            <div class="swarm-api-endpoint">
                                                <span class="swarm-api-method swarm-api-method-post">POST</span> <strong>/api/swarm/propose</strong><br>
                                                Submit a proposal, work update, escalation, or completion. Requires auth.<br>
                                                Body: <code>{ "title": "...", "description": "...", "submission_type": "proposal|work_update|assistance_request|completion", "escalation_type": "needs_db_access|needs_api_key|...", "escalation_urgency": "low|medium|high|critical", "what_agent_needs": "..." }</code>
                                            </div>

                                            <div class="swarm-api-endpoint">
                                                <span class="swarm-api-method swarm-api-method-post">POST</span> <strong>/api/swarm/resolve</strong><br>
                                                Resolve an escalation and unblock an agent.<br>
                                                Body: <code>{ "proposal_id": "uuid", "resolution_notes": "..." }</code>
                                            </div>

                                            <div class="swarm-api-endpoint">
                                                <span class="swarm-api-method swarm-api-method-get">GET</span> <strong>/api/swarm/status</strong><br>
                                                Check proposal status. Requires auth.<br>
                                                Query: <code>?proposal_id=uuid</code> (optional, omit for all)
                                            </div>

                                            <div class="swarm-api-endpoint">
                                                <span class="swarm-api-method swarm-api-method-get">GET</span> <strong>/api/swarm/earnings</strong><br>
                                                Agent earnings summary + recent transactions. Requires auth.
                                            </div>
                                        </details>
                                    </div>
                                </div>
                            </div>

                            <!-- Leaderboard View -->
                            <div class="factory-main-view" id="factoryLeaderboardView" style="display: none;">
                                <div class="factory-leaderboard-content">
                                    <h2 style="text-align: center; margin-bottom: 32px;">Leaderboard</h2>
                                    <div class="factory-leaderboard-list" id="factoryLeaderboardList">
                                        <p style="text-align: center; color: var(--text-tertiary);">Loading...</p>
                                    </div>
                                </div>
                            </div>

                            <!-- Rewards View -->
                            <div class="factory-main-view" id="factoryRewardsView" style="display: none;">
                                <div class="rewards-content">
                                    <!-- Header -->
                                    <div class="rewards-header">
                                        <h2>Rewards Pool</h2>
                                        <p class="rewards-subtitle">Donate to fund builders. Contribute to earn.</p>
                                    </div>

                                    <!-- Pool Stats -->
                                    <div class="rewards-pool-stats">
                                        <div class="rewards-pool-main">
                                            <span class="rewards-pool-label">Current Pool</span>
                                            <span class="rewards-pool-amount" id="rewardsPoolAmount">$0.00</span>
                                            <span class="rewards-pool-next">Next distribution: <span id="rewardsNextDistribution">--</span></span>
                                        </div>
                                        <div class="rewards-pool-details">
                                            <div class="rewards-stat">
                                                <span class="rewards-stat-value" id="rewardsContributorCount">0</span>
                                                <span class="rewards-stat-label">Contributors</span>
                                            </div>
                                            <div class="rewards-stat">
                                                <span class="rewards-stat-value" id="rewardsApprovedCount">0</span>
                                                <span class="rewards-stat-label">Approved This Month</span>
                                            </div>
                                            <div class="rewards-stat">
                                                <span class="rewards-stat-value" id="rewardsLastPayout">$0</span>
                                                <span class="rewards-stat-label">Last Month Paid</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Two Column Layout -->
                                    <div class="rewards-columns">
                                        <!-- Donate Column -->
                                        <div class="rewards-column">
                                            <div class="rewards-card">
                                                <div class="rewards-card-header">
                                                    <span class="rewards-card-icon"></span>
                                                    <h3>Fund the Builders</h3>
                                                </div>
                                                <p class="rewards-card-desc">Your donation goes directly to people building the SUITE ecosystem. 100% distributed to contributors.</p>

                                                <div class="rewards-donate-amounts">
                                                    <button class="rewards-amount-btn" onclick="selectDonationAmount(10)">$10</button>
                                                    <button class="rewards-amount-btn" onclick="selectDonationAmount(25)">$25</button>
                                                    <button class="rewards-amount-btn" onclick="selectDonationAmount(50)">$50</button>
                                                    <button class="rewards-amount-btn" onclick="selectDonationAmount(100)">$100</button>
                                                </div>

                                                <div class="rewards-donate-custom">
                                                    <span class="rewards-input-prefix">$</span>
                                                    <input type="number" id="rewardsDonationAmount" placeholder="Custom amount" min="1">
                                                    <span class="rewards-input-suffix">USDC</span>
                                                </div>

                                                <button class="rewards-donate-btn" onclick="submitDonation()">
                                                    Donate to Pool
                                                </button>

                                                <div class="rewards-recent-donors">
                                                    <h4>Recent Donors</h4>
                                                    <div id="rewardsRecentDonors">
                                                        <p class="rewards-empty">Be the first to donate!</p>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Earn Column -->
                                        <div class="rewards-column">
                                            <div class="rewards-card">
                                                <div class="rewards-card-header">
                                                    <span class="rewards-card-icon"></span>
                                                    <h3>Your Earnings</h3>
                                                </div>

                                                <div class="rewards-your-stats" id="rewardsYourStats">
                                                    <div class="rewards-auth-prompt" id="rewardsAuthPrompt">
                                                        <p>Connect wallet to see your earnings</p>
                                                        <button class="rewards-connect-btn" onclick="openAuthModal()">Connect Wallet</button>
                                                    </div>

                                                    <div class="rewards-user-earnings" id="rewardsUserEarnings" style="display: none;">
                                                        <div class="rewards-earning-box">
                                                            <span class="rewards-earning-label">Your Estimated Payout</span>
                                                            <span class="rewards-earning-amount" id="rewardsYourPayout">$0.00</span>
                                                            <span class="rewards-earning-rank">Rank #<span id="rewardsYourRank">--</span> of <span id="rewardsYourTotal">--</span></span>
                                                        </div>

                                                        <div class="rewards-contributions">
                                                            <h4>Your Approved Contributions</h4>
                                                            <div id="rewardsYourContributions">
                                                                <p class="rewards-empty">No approved proposals yet this month</p>
                                                            </div>
                                                        </div>

                                                        <div class="rewards-past-payouts">
                                                            <h4>Past Payouts</h4>
                                                            <div id="rewardsPastPayouts">
                                                                <p class="rewards-empty">No payouts yet</p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- How It Works (brief) -->
                                    <div class="rewards-how-it-works">
                                        <h3>How Rewards Work</h3>
                                        <div class="rewards-how-steps">
                                            <div class="rewards-how-step">
                                                <span class="rewards-how-num">1</span>
                                                <span>Donors contribute to the pool</span>
                                            </div>
                                            <div class="rewards-how-arrow"></div>
                                            <div class="rewards-how-step">
                                                <span class="rewards-how-num">2</span>
                                                <span>Contributors submit proposals</span>
                                            </div>
                                            <div class="rewards-how-arrow"></div>
                                            <div class="rewards-how-step">
                                                <span class="rewards-how-num">3</span>
                                                <span>Approved = Earns share of pool</span>
                                            </div>
                                            <div class="rewards-how-arrow"></div>
                                            <div class="rewards-how-step">
                                                <span class="rewards-how-num">4</span>
                                                <span>Monthly distribution to all</span>
                                            </div>
                                        </div>
                                        <p class="rewards-how-note">Only approved proposals count. Gaming-resistant by design.</p>
                                    </div>

                                    <!-- Top Contributors This Month -->
                                    <div class="rewards-top-contributors">
                                        <h3>Top Contributors This Month</h3>
                                        <div class="rewards-contributors-list" id="rewardsContributorsList">
                                            <p class="rewards-empty">No approved contributions yet this month</p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Clients View (formerly Operators) -->
                            <div class="factory-main-view" id="factoryClientsView" style="display: none;">
                                <div class="operators-content">
                                    <!-- Header -->
                                    <div class="operators-header">
                                        <h2>Clients</h2>
                                        <p class="operators-subtitle">Manage all clients  local businesses, operators, partners</p>
                                    </div>

                                    <!-- Stuart's Energy Flow -->
                                    <div style="background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 20px; margin-bottom: 20px;">
                                        <div style="font-size: 0.78rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-secondary); margin-bottom: 14px;">Stuart's Energy Flow</div>
                                        <div style="overflow-x: auto;">
                                            <svg viewBox="0 0 780 200" xmlns="http://www.w3.org/2000/svg" style="width: 100%; min-width: 600px; max-width: 780px; display: block; margin: 0 auto;">
                                                <defs>
                                                    <marker id="efArrow2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="rgba(255,255,255,0.4)"/></marker>
                                                    <marker id="efArrowGold2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="rgba(245,158,11,0.6)"/></marker>
                                                    <marker id="efArrowIndigo2" markerWidth="8" markerHeight="6" refX="8" refY="3" orient="auto"><polygon points="0 0, 8 3, 0 6" fill="rgba(99,102,241,0.6)"/></marker>
                                                </defs>

                                                <!-- Stuart Node -->
                                                <rect x="10" y="70" width="130" height="60" rx="14" fill="rgba(255,255,255,0.06)" stroke="rgba(255,255,255,0.25)" stroke-width="2"/>
                                                <text x="75" y="95" text-anchor="middle" fill="#f0f0f0" font-size="13" font-weight="800">STUART</text>
                                                <text x="75" y="112" text-anchor="middle" fill="rgba(255,255,255,0.45)" font-size="8">Energy Source</text>

                                                <!-- Priority 1: The System -->
                                                <rect x="220" y="20" width="200" height="70" rx="14" fill="rgba(239,68,68,0.08)" stroke="#ef4444" stroke-width="2"/>
                                                <text x="320" y="42" text-anchor="middle" fill="#ef4444" font-size="8" font-weight="700">PRIORITY 1</text>
                                                <text x="320" y="58" text-anchor="middle" fill="#f87171" font-size="12" font-weight="800">THE SYSTEM</text>
                                                <text x="320" y="73" text-anchor="middle" fill="rgba(239,68,68,0.6)" font-size="8">Apply to jobs  Get hired  Tend to tasks</text>
                                                <text x="320" y="84" text-anchor="middle" fill="rgba(239,68,68,0.45)" font-size="7">Salary &amp; stability first</text>

                                                <!-- Priority 2: Subscription Clients -->
                                                <rect x="220" y="110" width="200" height="70" rx="14" fill="rgba(245,158,11,0.08)" stroke="#f59e0b" stroke-width="1.5"/>
                                                <text x="320" y="132" text-anchor="middle" fill="#f59e0b" font-size="8" font-weight="700">PRIORITY 2</text>
                                                <text x="320" y="148" text-anchor="middle" fill="#fbbf24" font-size="12" font-weight="800">SUBSCRIPTION CLIENTS</text>
                                                <text x="320" y="163" text-anchor="middle" fill="rgba(245,158,11,0.6)" font-size="8">Recurring revenue  Client deliverables</text>
                                                <text x="320" y="174" text-anchor="middle" fill="rgba(245,158,11,0.45)" font-size="7">Monthly-fee clients managed here</text>

                                                <!-- Priority 3: SuiteGPT -->
                                                <rect x="500" y="65" width="200" height="70" rx="14" fill="rgba(99,102,241,0.08)" stroke="#6366f1" stroke-width="1.5"/>
                                                <text x="600" y="87" text-anchor="middle" fill="#6366f1" font-size="8" font-weight="700">PRIORITY 3</text>
                                                <text x="600" y="103" text-anchor="middle" fill="#818cf8" font-size="12" font-weight="800">SUITEGPT DEV</text>
                                                <text x="600" y="118" text-anchor="middle" fill="rgba(99,102,241,0.6)" font-size="8">Platform development  New features</text>
                                                <text x="600" y="129" text-anchor="middle" fill="rgba(99,102,241,0.45)" font-size="7">The long-term play</text>

                                                <!-- Flow: Stuart  The System (main energy) -->
                                                <path class="swarm-flow-line" d="M140,85 L220,55" stroke="rgba(239,68,68,0.5)" stroke-width="2.5" stroke-dasharray="6 3" marker-end="url(#efArrow2)"/>
                                                <text x="168" y="60" fill="rgba(239,68,68,0.5)" font-size="7" font-weight="600" transform="rotate(-12, 168, 60)">primary</text>

                                                <!-- Flow: Stuart  Subscription Clients -->
                                                <path class="swarm-flow-line" d="M140,115 L220,140" stroke="rgba(245,158,11,0.4)" stroke-width="1.8" stroke-dasharray="5 3" marker-end="url(#efArrowGold2)"/>
                                                <text x="168" y="138" fill="rgba(245,158,11,0.45)" font-size="7" font-weight="600" transform="rotate(10, 168, 138)">secondary</text>

                                                <!-- Flow: overflow  SuiteGPT -->
                                                <path class="swarm-flow-line" d="M420,55 L500,85" stroke="rgba(99,102,241,0.3)" stroke-width="1.2" stroke-dasharray="4 3" marker-end="url(#efArrowIndigo2)"/>
                                                <path class="swarm-flow-line" d="M420,145 L500,115" stroke="rgba(99,102,241,0.3)" stroke-width="1.2" stroke-dasharray="4 3" marker-end="url(#efArrowIndigo2)"/>
                                                <text x="460" y="75" fill="rgba(99,102,241,0.4)" font-size="7" font-weight="600">overflow</text>

                                                <!-- Revenue flows back -->
                                                <rect x="580" y="155" width="120" height="35" rx="8" fill="rgba(34,197,94,0.06)" stroke="rgba(34,197,94,0.2)" stroke-width="1"/>
                                                <text x="640" y="173" text-anchor="middle" fill="rgba(34,197,94,0.6)" font-size="8" font-weight="600">$ Revenue flows back</text>
                                                <text x="640" y="184" text-anchor="middle" fill="rgba(34,197,94,0.4)" font-size="7">All streams  sustainability</text>
                                            </svg>
                                        </div>
                                        <div style="display: flex; gap: 16px; flex-wrap: wrap; margin-top: 12px; font-size: 0.72rem; color: var(--text-secondary);">
                                            <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 8px; height: 8px; border-radius: 50%; background: #ef4444;"></div> Primary  The System</div>
                                            <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 8px; height: 8px; border-radius: 50%; background: #f59e0b;"></div> Secondary  Subscription Clients</div>
                                            <div style="display: flex; align-items: center; gap: 5px;"><div style="width: 8px; height: 8px; border-radius: 50%; background: #6366f1;"></div> Tertiary  SuiteGPT Development</div>
                                            <div style="margin-left: auto; font-style: italic; opacity: 0.6;">Thicker line = more energy</div>
                                        </div>
                                    </div>

                                    <!-- Quick Links -->
                                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;">
                                        <a href="https://clients.suitegpt.app" target="_blank" style="display:flex;align-items:center;gap:14px;padding:16px 20px;background:rgba(34,197,94,0.06);border:1px solid rgba(34,197,94,0.15);border-radius:14px;text-decoration:none;color:var(--text-primary);transition:all 0.2s;">
                                            <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#22c55e,#10b981);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;"></div>
                                            <div>
                                                <div style="font-weight:700;font-size:0.95rem;">Client Landing Page</div>
                                                <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:2px;">clients.suitegpt.app  where ad traffic lands</div>
                                            </div>
                                            <span style="margin-left:auto;font-size:0.78rem;color:var(--text-secondary);">Open </span>
                                        </a>
                                        <a href="https://portfolio.suitegpt.app" target="_blank" style="display:flex;align-items:center;gap:14px;padding:16px 20px;background:rgba(99,102,241,0.06);border:1px solid rgba(99,102,241,0.15);border-radius:14px;text-decoration:none;color:var(--text-primary);transition:all 0.2s;">
                                            <div style="width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#6366f1,#a855f7);display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0;"></div>
                                            <div>
                                                <div style="font-weight:700;font-size:0.95rem;">Portfolio</div>
                                                <div style="font-size:0.8rem;color:var(--text-secondary);margin-top:2px;">portfolio.suitegpt.app  for job applications</div>
                                            </div>
                                            <span style="margin-left:auto;font-size:0.78rem;color:var(--text-secondary);">Open </span>
                                        </a>
                                    </div>

                                    <!-- ===== JOB HUNTER (Collapsible) ===== -->
                                    <div class="jh-section" id="jhSection">
                                        <div class="jh-header" onclick="toggleJobHunter()">
                                            <div class="jh-header-left">
                                                <span style="font-size:1.1rem;"></span>
                                                <span class="jh-header-title">Job Hunter</span>
                                                <span class="jh-header-badge">Job boards, resume lab, pipeline</span>
                                            </div>
                                            <span class="jh-chevron"></span>
                                        </div>
                                        <div class="jh-body">
                                            <div class="jh-tabs">
                                                <button class="jh-tab active" onclick="switchJhTab('boards')">Job Boards</button>
                                                <button class="jh-tab" onclick="switchJhTab('resume')">Resume Lab</button>
                                                <button class="jh-tab" onclick="switchJhTab('tracker')">Pipeline</button>
                                                <button class="jh-tab" onclick="switchJhTab('checklist')">Pre-Apply Checklist</button>
                                            </div>

                                            <!-- JH: Job Boards -->
                                            <div class="jh-panel active" id="jhBoardsPanel">
                                                <div class="jh-section-title">AI & Tech Companies <span class="jh-count">5</span></div>
                                                <div class="jh-boards-grid">
                                                    <div class="jh-board-card">
                                                        <div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(59,130,246,0.12);color:#3b82f6;">in</div><div><div class="jh-board-name">LinkedIn Jobs</div><div class="jh-board-desc">Largest job board. Most AI companies post here.</div></div></div>
                                                        <div class="jh-board-links">
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=developer%20relations%20AI&f_TPR=r604800" target="_blank" class="jh-board-link">Developer Relations <span class="jh-tag jh-tag-hot">Best Fit</span></a>
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=solutions%20engineer%20AI&f_TPR=r604800" target="_blank" class="jh-board-link">Solutions Engineer <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=applied%20AI%20engineer&f_TPR=r604800" target="_blank" class="jh-board-link">Applied AI Engineer <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=AI%20product%20engineer&f_TPR=r604800" target="_blank" class="jh-board-link">Product Engineer (AI) <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=technical%20PM%20AI&f_TPR=r604800" target="_blank" class="jh-board-link">Technical PM <span class="jh-tag jh-tag-stretch">Stretch</span></a>
                                                        </div>
                                                    </div>
                                                    <div class="jh-board-card">
                                                        <div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(245,158,11,0.12);color:#f59e0b;">YC</div><div><div class="jh-board-name">Y Combinator  Work at a Startup</div><div class="jh-board-desc">Top-tier startups. Less bureaucracy, more building.</div></div></div>
                                                        <div class="jh-board-links">
                                                            <a href="https://www.workatastartup.com/jobs?role=eng&demographic=any&query=AI+developer+relations" target="_blank" class="jh-board-link">DevRel at YC Startups <span class="jh-tag jh-tag-hot">Best Fit</span></a>
                                                            <a href="https://www.workatastartup.com/jobs?role=eng&demographic=any&query=full+stack+AI" target="_blank" class="jh-board-link">Full Stack / AI Engineer <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                            <a href="https://www.workatastartup.com/jobs?role=eng&demographic=any&query=crypto+AI" target="_blank" class="jh-board-link">Crypto + AI Crossover <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                        </div>
                                                    </div>
                                                    <div class="jh-board-card">
                                                        <div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(34,197,94,0.12);color:#22c55e;">WF</div><div><div class="jh-board-name">Wellfound (AngelList)</div><div class="jh-board-desc">Startup jobs. Equity-heavy. Good for early-stage.</div></div></div>
                                                        <div class="jh-board-links">
                                                            <a href="https://wellfound.com/jobs?query=developer+relations+AI" target="_blank" class="jh-board-link">DevRel / Developer Advocacy <span class="jh-tag jh-tag-hot">Best Fit</span></a>
                                                            <a href="https://wellfound.com/jobs?query=AI+engineer" target="_blank" class="jh-board-link">AI Engineer <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                            <a href="https://wellfound.com/jobs?query=solutions+engineer" target="_blank" class="jh-board-link">Solutions Engineer <span class="jh-tag jh-tag-good">Good Fit</span></a>
                                                        </div>
                                                    </div>
                                                    <div class="jh-board-card">
                                                        <div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(168,85,247,0.12);color:#a855f7;">AI</div><div><div class="jh-board-name">AI-Specific Boards</div><div class="jh-board-desc">Niche boards focused on AI/ML roles.</div></div></div>
                                                        <div class="jh-board-links">
                                                            <a href="https://ai-jobs.net/" target="_blank" class="jh-board-link">ai-jobs.net <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                            <a href="https://aijobs.app/" target="_blank" class="jh-board-link">aijobs.app <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                        </div>
                                                    </div>
                                                    <div class="jh-board-card">
                                                        <div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(239,68,68,0.12);color:#ef4444;">W3</div><div><div class="jh-board-name">Web3 + AI Crossover</div><div class="jh-board-desc">Your DeFi background is a differentiator here.</div></div></div>
                                                        <div class="jh-board-links">
                                                            <a href="https://cryptocurrencyjobs.co/?query=AI" target="_blank" class="jh-board-link">CryptocurrencyJobs  AI <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                            <a href="https://web3.career/ai-jobs" target="_blank" class="jh-board-link">Web3.career  AI <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                            <a href="https://www.linkedin.com/jobs/search/?keywords=AI%20web3%20crypto&f_TPR=r604800" target="_blank" class="jh-board-link">LinkedIn  AI + Web3 <span class="jh-tag jh-tag-niche">Niche</span></a>
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="jh-section-title">Direct Company Career Pages <span class="jh-count">8</span></div>
                                                <div class="jh-boards-grid">
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(99,102,241,0.12);color:#6366f1;">A</div><div><div class="jh-board-name">Anthropic</div><div class="jh-board-desc">Makers of Claude. Strong safety culture.</div></div></div><div class="jh-board-links"><a href="https://www.anthropic.com/careers" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(34,197,94,0.12);color:#22c55e;">O</div><div><div class="jh-board-name">OpenAI</div><div class="jh-board-desc">ChatGPT, GPT APIs. Massive scale.</div></div></div><div class="jh-board-links"><a href="https://openai.com/careers/search" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(59,130,246,0.12);color:#3b82f6;">G</div><div><div class="jh-board-name">Google DeepMind</div><div class="jh-board-desc">Gemini, research-heavy but hiring applied roles.</div></div></div><div class="jh-board-links"><a href="https://deepmind.google/about/careers/" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(245,158,11,0.12);color:#f59e0b;">R</div><div><div class="jh-board-name">Replicate</div><div class="jh-board-desc">Run ML models via API. Dev-focused.</div></div></div><div class="jh-board-links"><a href="https://replicate.com/about#careers" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(168,85,247,0.12);color:#a855f7;">H</div><div><div class="jh-board-name">Hugging Face</div><div class="jh-board-desc">Open-source AI. Community-driven. DevRel-heavy.</div></div></div><div class="jh-board-links"><a href="https://huggingface.co/jobs" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(239,68,68,0.12);color:#ef4444;">C</div><div><div class="jh-board-name">Cohere</div><div class="jh-board-desc">Enterprise AI. Strong applied engineering team.</div></div></div><div class="jh-board-links"><a href="https://cohere.com/careers" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(34,197,94,0.12);color:#22c55e;">V</div><div><div class="jh-board-name">Vercel</div><div class="jh-board-desc">v0, AI SDK. You already deploy on Vercel.</div></div></div><div class="jh-board-links"><a href="https://vercel.com/careers" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                    <div class="jh-board-card"><div class="jh-board-header"><div class="jh-board-icon" style="background:rgba(59,130,246,0.12);color:#3b82f6;">S</div><div><div class="jh-board-name">Supabase</div><div class="jh-board-desc">You use Supabase daily. Strong product fit.</div></div></div><div class="jh-board-links"><a href="https://supabase.com/careers" target="_blank" class="jh-board-link">All Openings</a></div></div>
                                                </div>
                                            </div>

                                            <!-- JH: Resume Lab -->
                                            <div class="jh-panel" id="jhResumePanel">
                                                <div class="jh-section-title">Target Role</div>
                                                <div class="jh-role-cards" id="jhRoleCards">
                                                    <div class="jh-role-card selected" onclick="jhSelectRole(this,'techwriter')" data-role="techwriter"><div class="jh-role-card-title">Technical Writer</div><div class="jh-role-card-desc">Whitepapers, docs, API guides, translating complex concepts.</div><span class="jh-tag jh-tag-hot" style="margin-top:6px;display:inline-block;">Best Fit</span></div>
                                                    <div class="jh-role-card" onclick="jhSelectRole(this,'marketing')" data-role="marketing"><div class="jh-role-card-title">Marketing Manager</div><div class="jh-role-card-desc">Content strategy, SEO, social media, community growth.</div><span class="jh-tag jh-tag-good" style="margin-top:6px;display:inline-block;">Good Fit</span></div>
                                                    <div class="jh-role-card" onclick="jhSelectRole(this,'content')" data-role="content"><div class="jh-role-card-title">Content Strategist</div><div class="jh-role-card-desc">Editorial planning, audience growth, multi-channel content.</div><span class="jh-tag jh-tag-good" style="margin-top:6px;display:inline-block;">Good Fit</span></div>
                                                    <div class="jh-role-card" onclick="jhSelectRole(this,'operations')" data-role="operations"><div class="jh-role-card-title">Operations / General</div><div class="jh-role-card-desc">Cross-functional leadership, project management, strategy.</div><span class="jh-tag jh-tag-good" style="margin-top:6px;display:inline-block;">Good Fit</span></div>
                                                </div>
                                                <div class="jh-resume-box">
                                                    <div class="jh-resume-header"><h4>Generate Resume</h4><button class="jh-btn jh-btn-primary jh-btn-sm" onclick="jhGenerateResume()">Generate</button></div>
                                                    <div class="jh-form-group"><label class="jh-form-label">Your Background</label><textarea class="jh-textarea" id="jhResumeBackground" rows="6">Stuart Hollinger  Founder &amp; CEO of SUITE (suitegpt.app), an AI-native app ecosystem. Built the entire platform: app builder with AI code generation, credit system, governance framework, client management hub, Supabase backend, Vercel deployment.

7 years in DeFi/blockchain  wrote the MELD whitepaper, GitBook documentation, audit reports, press releases, and community content. Managed ambassador programs, Twitter Spaces, AMAs, and content calendars.

Published author of 4 books: The Moment, The God Shape, Fictional Poetry, Inquiries. Active on Medium (@defiknowledge, 1.6k followers) covering DeFi, blockchain, and AI topics.

Prior: CNC machining &amp; woodworking  precision manufacturing, process optimization, quality control.

Skills: Technical writing, content strategy, project management, community building, SEO, social media management, JavaScript, HTML/CSS, Supabase, Vercel, REST APIs, AI API integration (Gemini/Groq/Claude), Git.</textarea></div>
                                                    <div class="jh-form-group"><label class="jh-form-label">Specific Job Posting (optional)</label><textarea class="jh-textarea" id="jhJobPosting" rows="4" placeholder="Paste a job description to tailor the resume..."></textarea></div>
                                                    <div class="jh-ai-output" id="jhResumeOutput"></div>
                                                    <div id="jhResumeActions" style="display:none;margin-top:10px;display:none;gap:8px;flex-wrap:wrap;">
                                                        <button class="jh-btn jh-btn-primary jh-btn-sm" onclick="jhDownloadResumePDF()">Download PDF</button>
                                                        <button class="jh-btn-ghost" onclick="jhDownloadResumeTXT()">Download TXT</button>
                                                        <button class="jh-btn-ghost" id="jhResumeCopyBtn" onclick="jhCopyOutput('jhResumeOutput')">Copy</button>
                                                    </div>
                                                </div>
                                                <div class="jh-resume-box" style="cursor:pointer;" onclick="const b=this.querySelector('.jh-outreach-body');const c=this.querySelector('.jh-outreach-chevron');if(b.style.display==='none'){b.style.display='block';c.style.transform='rotate(180deg)';}else{b.style.display='none';c.style.transform='rotate(0)';}">
                                                    <div class="jh-resume-header" style="margin-bottom:0;"><h4>Cold Outreach Generator</h4><span class="jh-outreach-chevron" style="font-size:1.1rem;color:var(--text-secondary);transition:transform 0.2s;"></span></div>
                                                    <div class="jh-outreach-body" style="display:none;" onclick="event.stopPropagation();">
                                                        <div style="margin-top:14px;">
                                                        <div class="jh-form-group"><label class="jh-form-label">Company Name</label><input class="jh-input" type="text" id="jhOutreachCompany" placeholder="e.g. Anthropic, Vercel, Supabase..."></div>
                                                        <div class="jh-form-group"><label class="jh-form-label">What to Emphasize</label><input class="jh-input" type="text" id="jhOutreachAngle" placeholder="e.g. I built an entire ecosystem using their product..."></div>
                                                        <button class="jh-btn jh-btn-primary jh-btn-sm" onclick="jhGenerateOutreach()" style="margin-bottom:10px;">Generate</button>
                                                        <div class="jh-ai-output" id="jhOutreachOutput"></div>
                                                        <button class="jh-btn-ghost" id="jhOutreachCopyBtn" style="display:none;margin-top:6px;" onclick="jhCopyOutput('jhOutreachOutput')">Copy</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- JH: Pipeline Tracker -->
                                            <div class="jh-panel" id="jhTrackerPanel">
                                                <div class="jh-stats-bar">
                                                    <div class="jh-stat-card"><div class="jh-stat-value" style="color:#3b82f6;" id="jhStatApplied">0</div><div class="jh-stat-label">Applied</div></div>
                                                    <div class="jh-stat-card"><div class="jh-stat-value" style="color:#f59e0b;" id="jhStatResponded">0</div><div class="jh-stat-label">Responded</div></div>
                                                    <div class="jh-stat-card"><div class="jh-stat-value" style="color:#a855f7;" id="jhStatInterview">0</div><div class="jh-stat-label">Interviewing</div></div>
                                                    <div class="jh-stat-card"><div class="jh-stat-value" style="color:#22c55e;" id="jhStatOffer">0</div><div class="jh-stat-label">Offers</div></div>
                                                </div>
                                                <div class="jh-add-form">
                                                    <div style="font-weight:700;margin-bottom:10px;font-size:0.92rem;">Add Application</div>
                                                    <div class="jh-add-form-row">
                                                        <div><label class="jh-form-label">Company</label><input class="jh-input" type="text" id="jhAddCompany" placeholder="Anthropic"></div>
                                                        <div><label class="jh-form-label">Role</label><input class="jh-input" type="text" id="jhAddRole" placeholder="Developer Relations"></div>
                                                        <div><label class="jh-form-label">Link</label><input class="jh-input" type="url" id="jhAddLink" placeholder="https://..."></div>
                                                        <button class="jh-btn jh-btn-primary" onclick="jhAddApplication()" style="height:38px;">Add</button>
                                                    </div>
                                                </div>
                                                <div class="jh-pipeline-cols" id="jhPipelineCols">
                                                    <div class="jh-pipeline-col"><div class="jh-pipeline-col-header"><span class="jh-pipeline-col-title" style="color:#3b82f6;">Applied</span><span class="jh-pipeline-col-count" style="background:rgba(59,130,246,0.12);color:#3b82f6;" id="jhColCountApplied">0</span></div><div id="jhColApplied"></div></div>
                                                    <div class="jh-pipeline-col"><div class="jh-pipeline-col-header"><span class="jh-pipeline-col-title" style="color:#f59e0b;">Responded</span><span class="jh-pipeline-col-count" style="background:rgba(245,158,11,0.12);color:#f59e0b;" id="jhColCountResponded">0</span></div><div id="jhColResponded"></div></div>
                                                    <div class="jh-pipeline-col"><div class="jh-pipeline-col-header"><span class="jh-pipeline-col-title" style="color:#a855f7;">Interviewing</span><span class="jh-pipeline-col-count" style="background:rgba(168,85,247,0.12);color:#a855f7;" id="jhColCountInterview">0</span></div><div id="jhColInterview"></div></div>
                                                    <div class="jh-pipeline-col"><div class="jh-pipeline-col-header"><span class="jh-pipeline-col-title" style="color:#22c55e;">Offer</span><span class="jh-pipeline-col-count" style="background:rgba(34,197,94,0.12);color:#22c55e;" id="jhColCountOffer">0</span></div><div id="jhColOffer"></div></div>
                                                </div>
                                            </div>

                                            <!-- JH: Pre-Apply Checklist -->
                                            <div class="jh-panel" id="jhChecklistPanel">
                                                <div class="jh-section-title">Before You Apply Anywhere</div>
                                                <div class="jh-checklist" id="jhChecklistContainer"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Sub-tabs -->
                                    <div class="clients-sub-tabs">
                                        <button class="clients-sub-tab active" data-ctab="my-clients" onclick="switchClientsTab('my-clients')">My Clients</button>
                                        <button class="clients-sub-tab" data-ctab="pipeline" onclick="switchClientsTab('pipeline')">Pipeline</button>
                                        <button class="clients-sub-tab" data-ctab="revenue" onclick="switchClientsTab('revenue')">Revenue</button>
                                        <button class="clients-sub-tab" data-ctab="ads" onclick="switchClientsTab('ads')">Ads & Leads</button>
                                        <button class="clients-sub-tab" data-ctab="outreach" onclick="switchClientsTab('outreach')">Get Clients</button>
                                        <button class="clients-sub-tab" data-ctab="overview" onclick="switchClientsTab('overview')">How It Works</button>
                                    </div>

                                    <!-- ===== MY CLIENTS SUB-TAB ===== -->
                                    <div class="clients-sub-panel active" id="clientsMyClientsPanel">
                                        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 16px; flex-wrap: wrap;">
                                            <button class="operators-add-btn" onclick="showAddOperatorModal()">+ Add Client</button>
                                        </div>

                                        <!-- Client Request Daemon Status -->
                                        <div id="opDaemonBar" style="display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 14px 20px; margin-bottom: 20px;">
                                            <div style="display: flex; align-items: center; gap: 12px;">
                                                <div id="opDaemonDot" style="width: 10px; height: 10px; border-radius: 50%; background: #555; flex-shrink: 0;"></div>
                                                <div>
                                                    <span style="font-weight: 700; font-size: 0.95rem;">Client Request Daemon</span>
                                                    <span id="opDaemonDetail" style="font-size: 0.8rem; color: var(--text-secondary); margin-left: 8px;">Checking...</span>
                                                </div>
                                            </div>
                                            <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; user-select: none;">
                                                <span style="font-size: 0.85rem; font-weight: 600; color: var(--text-secondary);" id="opToggleLabel">Processing</span>
                                                <div style="position: relative; width: 44px; height: 24px;" onclick="document.getElementById('opDaemonToggle').click()">
                                                    <input type="checkbox" id="opDaemonToggle" onchange="toggleOpDaemon(this.checked)" style="opacity: 0; width: 0; height: 0; position: absolute;">
                                                    <div id="opToggleTrack" style="position: absolute; inset: 0; background: #333; border-radius: 12px; cursor: pointer; transition: background 0.2s;"></div>
                                                    <div id="opToggleThumb" style="position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: white; border-radius: 50%; transition: transform 0.2s; pointer-events: none;"></div>
                                                </div>
                                            </label>
                                        </div>

                                        <!-- Filter Bar -->
                                        <div class="operators-filters">
                                            <button class="operators-filter-btn active" data-filter="all" onclick="filterOperators('all')">All</button>
                                            <button class="operators-filter-btn" data-filter="lead" onclick="filterOperators('lead')">Lead</button>
                                            <button class="operators-filter-btn" data-filter="trial" onclick="filterOperators('trial')">Trial</button>
                                            <button class="operators-filter-btn" data-filter="active" onclick="filterOperators('active')">Active</button>
                                            <button class="operators-filter-btn" data-filter="paused" onclick="filterOperators('paused')">Paused</button>
                                            <button class="operators-filter-btn" data-filter="completed" onclick="filterOperators('completed')">Completed</button>
                                            <button class="operators-filter-btn" data-filter="churned" onclick="filterOperators('churned')">Churned</button>
                                        </div>

                                        <!-- Clients List -->
                                        <div class="operators-list" id="operatorsList">
                                            <div class="operators-loading">Loading clients...</div>
                                        </div>
                                    </div>

                                    <!-- ===== PIPELINE SUB-TAB ===== -->
                                    <div class="clients-sub-panel" id="clientsPipelinePanel">
                                        <div class="ch-channel-bar" id="chChannelBar"></div>
                                        <div class="ch-kanban-stats" id="chKanbanStats"></div>
                                        <div style="display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;">
                                            <button class="operators-add-btn" onclick="showAddLeadModal()">+ Add Lead</button>
                                            <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--text-secondary);font-family:inherit;font-size:0.85rem;font-weight:600;cursor:pointer;" onclick="switchClientsTab('ads')">Manage Ads</button>
                                        </div>
                                        <div class="ch-kanban-board" id="chKanbanBoard"></div>
                                    </div>

                                    <!-- ===== REVENUE SUB-TAB ===== -->
                                    <div class="clients-sub-panel" id="clientsRevenuePanel">
                                        <div class="ch-revenue-cards" id="chRevenueCards"></div>
                                        <div style="margin-top:24px;">
                                            <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">Client Breakdown</h3>
                                            <div style="overflow-x:auto;">
                                                <table class="ch-revenue-table">
                                                    <thead><tr><th>Client</th><th>Type</th><th>Status</th><th>Rate</th><th>Since</th></tr></thead>
                                                    <tbody id="chRevenueTableBody"></tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ===== ADS & LEADS SUB-TAB ===== -->
                                    <div class="clients-sub-panel" id="clientsAdsPanel">
                                        <div class="ch-ads-stats" id="chAdsStats"></div>
                                        <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:20px;">
                                            <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text-secondary);font-family:inherit;font-size:0.82rem;font-weight:600;cursor:pointer;" onclick="chCopyLandingLink('kijiji')">Copy Link (Kijiji)</button>
                                            <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text-secondary);font-family:inherit;font-size:0.82rem;font-weight:600;cursor:pointer;" onclick="chCopyLandingLink('fb')">Copy Link (FB)</button>
                                            <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:var(--text-secondary);font-family:inherit;font-size:0.82rem;font-weight:600;cursor:pointer;" onclick="chCopyLandingLink('linkedin')">Copy Link (LinkedIn)</button>
                                            <button class="operators-add-btn" onclick="showAddAdModal()">+ Add Ad</button>
                                            <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(59,130,246,0.3);background:rgba(59,130,246,0.1);color:#3b82f6;font-family:inherit;font-size:0.82rem;font-weight:600;cursor:pointer;" onclick="showAddLeadModal()">+ Add Lead</button>
                                        </div>
                                        <h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">Active Ads</h3>
                                        <div class="ch-ads-grid" id="chAdsGrid"><div style="color:var(--text-secondary);font-size:0.88rem;padding:12px;">Loading ads...</div></div>
                                        <h3 style="font-size:1rem;font-weight:700;margin:24px 0 12px;">Lead Pipeline</h3>
                                        <div class="ch-lead-filters" id="chLeadFilters"></div>
                                        <div style="overflow-x:auto;">
                                            <table class="ch-revenue-table" id="chLeadsTable">
                                                <thead><tr><th>Name</th><th>Business</th><th>Source</th><th>Status</th><th>Rate</th><th>Created</th></tr></thead>
                                                <tbody id="chLeadsTableBody"><tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:24px;">Loading leads...</td></tr></tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <!-- ===== GET CLIENTS SUB-TAB ===== -->
                                    <div class="clients-sub-panel" id="clientsOutreachPanel">
                                        <div id="chOutreachContent"></div>
                                    </div>

                                    <!-- ===== HOW IT WORKS SUB-TAB ===== -->
                                    <div class="clients-sub-panel" id="clientsOverviewPanel">
                                        <div id="chOverviewContent"></div>
                                    </div>

                                </div>
                            </div>


                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Add Lead Modal (Client Hub) -->
    <div class="ch-modal-overlay" id="chLeadModal">
        <div class="ch-modal">
            <div class="ch-modal-title">Add Lead</div>
            <div class="ch-form-group"><label class="ch-form-label">Name *</label><input class="ch-form-input" type="text" id="chLeadName" placeholder="Jane Smith"></div>
            <div class="ch-form-group"><label class="ch-form-label">Email</label><input class="ch-form-input" type="text" id="chLeadEmail" placeholder="jane@business.com"></div>
            <div class="ch-form-group"><label class="ch-form-label">Phone</label><input class="ch-form-input" type="text" id="chLeadPhone" placeholder="(555) 123-4567"></div>
            <div class="ch-form-group"><label class="ch-form-label">Business Name</label><input class="ch-form-input" type="text" id="chLeadBusiness" placeholder="Jane's Bakery"></div>
            <div class="ch-form-group"><label class="ch-form-label">Source</label>
                <select class="ch-form-select" id="chLeadSource">
                    <option value="walk-in">Walk-in</option><option value="referral">Referral</option><option value="kijiji">Kijiji</option>
                    <option value="fb-marketplace">Facebook Marketplace</option><option value="linkedin">LinkedIn</option>
                    <option value="instagram">Instagram</option><option value="direct">Direct / Landing Page</option><option value="other">Other</option>
                </select>
            </div>
            <div class="ch-form-group"><label class="ch-form-label">What They Need</label><textarea class="ch-form-textarea" id="chLeadNeed" placeholder="Website, dashboard, inventory system..."></textarea></div>
            <div class="ch-form-group"><label class="ch-form-label">Notes</label><textarea class="ch-form-textarea" id="chLeadNotes" placeholder="Any notes..."></textarea></div>
            <div class="ch-modal-actions">
                <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--text-secondary);font-family:inherit;font-weight:600;cursor:pointer;" onclick="hideAddLeadModal()">Cancel</button>
                <button style="padding:8px 16px;border-radius:10px;border:none;background:linear-gradient(135deg,#22c55e,#10b981);color:white;font-family:inherit;font-weight:700;cursor:pointer;" onclick="chSaveLead()">Save Lead</button>
            </div>
        </div>
    </div>

    <!-- Add Ad Modal (Client Hub) -->
    <div class="ch-modal-overlay" id="chAdModal">
        <div class="ch-modal">
            <div class="ch-modal-title">Add Ad Placement</div>
            <div class="ch-form-group"><label class="ch-form-label">Platform</label>
                <select class="ch-form-select" id="chAdPlatform">
                    <option value="kijiji">Kijiji</option><option value="fb-marketplace">Facebook Marketplace</option>
                    <option value="linkedin">LinkedIn</option><option value="instagram">Instagram</option>
                    <option value="reddit">Reddit</option><option value="facebook-group">Facebook Group</option><option value="other">Other</option>
                </select>
            </div>
            <div class="ch-form-group"><label class="ch-form-label">Title / Description</label><input class="ch-form-input" type="text" id="chAdTitle" placeholder="Free custom website for your business"></div>
            <div class="ch-form-group"><label class="ch-form-label">Link to Ad (optional)</label><input class="ch-form-input" type="url" id="chAdUrl" placeholder="https://kijiji.ca/v-..."></div>
            <div class="ch-form-group"><label class="ch-form-label">Budget ($)</label><input class="ch-form-input" type="number" id="chAdBudget" placeholder="0" min="0"></div>
            <div class="ch-modal-actions">
                <button style="padding:8px 16px;border-radius:10px;border:1px solid rgba(255,255,255,0.1);background:transparent;color:var(--text-secondary);font-family:inherit;font-weight:600;cursor:pointer;" onclick="hideAddAdModal()">Cancel</button>
                <button style="padding:8px 16px;border-radius:10px;border:none;background:linear-gradient(135deg,#22c55e,#10b981);color:white;font-family:inherit;font-weight:700;cursor:pointer;" onclick="chSaveAd()">Save Ad</button>
            </div>
        </div>
    </div>

    <!-- Add Operator Modal -->
    <!-- Project Context Modal -->
    <div class="operator-modal-overlay" id="projectContextModal" style="display: none;">
        <div class="operator-modal-content" style="max-width: 700px;">
            <div class="operator-modal-header">
                <h3 id="pcModalTitle">Project Context for Claude</h3>
                <button class="operator-modal-close" onclick="hideProjectContextModal()">&times;</button>
            </div>
            <div style="padding: 20px;">
                <p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">
                    This context is prepended to every Claude prompt for this client's requests. Describe the project, tech stack, file structure, and any conventions so Claude knows how to make changes correctly.
                </p>
                <textarea id="pcContextInput" rows="16" placeholder="## Project Overview
[Company name] - [what they do]

## Tech Stack
- Static HTML/CSS/JS site
- Supabase for data
- Hosted on Vercel

## Key Files
- index.html  main landing page
- admin/dashboard.html  admin panel
- assets/  images and static files

## Database Tables
- products  product catalog
- orders  customer orders

## Conventions
- Use Outfit font family
- Dark theme with ink/paper color vars
- Mobile-first responsive design

## Important Notes
- Don't modify the nav component
- Always test on mobile viewport" style="width: 100%; padding: 14px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-family: monospace; font-size: 0.85rem; resize: vertical; line-height: 1.5;"></textarea>
                <input type="hidden" id="pcOperatorId">
                <div style="display: flex; gap: 8px; margin-top: 16px; justify-content: flex-end;">
                    <button onclick="hideProjectContextModal()" style="padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); background: transparent; color: var(--text-secondary); cursor: pointer; font-weight: 600;">Cancel</button>
                    <button onclick="saveProjectContext()" id="pcSaveBtn" style="padding: 10px 24px; border-radius: 8px; border: none; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; cursor: pointer; font-weight: 600;">Save Context</button>
                </div>
            </div>
        </div>
    </div>

    <div class="operator-modal-overlay" id="addOperatorModal" style="display: none;">
        <div class="operator-modal-content">
            <div class="operator-modal-header">
                <h3>Add New Client</h3>
                <button class="operator-modal-close" onclick="hideAddOperatorModal()">&times;</button>
            </div>
            <form id="addOperatorForm" onsubmit="submitNewOperator(event)">
                <div class="operator-form-group">
                    <label>Client / Company Name</label>
                    <input type="text" id="operatorName" required placeholder="e.g., Jane's Bakery">
                </div>
                <div class="operator-form-group">
                    <label>Description</label>
                    <textarea id="operatorDescription" rows="2" placeholder="What do they do?"></textarea>
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="operator-form-group">
                        <label>Contact Email</label>
                        <input type="email" id="operatorEmail" placeholder="contact@example.com">
                    </div>
                    <div class="operator-form-group">
                        <label>Phone</label>
                        <input type="text" id="operatorPhone" placeholder="(555) 123-4567">
                    </div>
                </div>
                <div class="operator-form-group">
                    <label>Industry</label>
                    <input type="text" id="operatorIndustry" placeholder="e.g., Restaurant, Gym, Retail">
                </div>
                <div class="operator-form-group">
                    <label>Website/URL</label>
                    <input type="url" id="operatorUrl" placeholder="https://...">
                </div>
                <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
                    <div class="operator-form-group">
                        <label>Payment Type</label>
                        <select id="operatorPaymentType" onchange="document.getElementById('operatorRateGroup').style.display = this.value === 'monthly' ? 'block' : 'none'">
                            <option value="salary">Salary (Operator Role)</option>
                            <option value="monthly">Monthly Fee (Local Business)</option>
                        </select>
                    </div>
                    <div class="operator-form-group" id="operatorRateGroup" style="display:none">
                        <label>Monthly Rate ($)</label>
                        <input type="number" id="operatorRate" placeholder="500" min="0">
                    </div>
                </div>
                <div class="operator-form-group">
                    <label>Status</label>
                    <select id="operatorStatus">
                        <option value="lead">Lead</option>
                        <option value="trial">Trial (30 days free)</option>
                        <option value="active">Active</option>
                        <option value="paused">Paused</option>
                        <option value="completed">Completed</option>
                        <option value="churned">Churned</option>
                    </select>
                </div>
                <div class="operator-form-group">
                    <label>Linked SUITE App</label>
                    <select id="operatorAppKey">
                        <option value="">-- No linked app --</option>
                    </select>
                    <p style="font-size: 0.75rem; color: var(--text-tertiary); margin-top: 4px;">Link to an app on the /apps page for quick access</p>
                </div>
                <div class="operator-form-group">
                    <label>Current Task / Notes</label>
                    <textarea id="operatorNotes" rows="3" placeholder="What are we currently working on?"></textarea>
                </div>
                <div class="operator-modal-actions">
                    <button type="button" class="operator-btn-cancel" onclick="hideAddOperatorModal()">Cancel</button>
                    <button type="submit" class="operator-btn-submit">Add Client</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Factory Submit Modal -->
    <div class="factory-modal-overlay" id="factorySubmitModal">
        <div class="factory-modal-content">
            <div class="factory-modal-header">
                <h3 class="factory-modal-title">New Proposal</h3>
                <button class="factory-modal-close" onclick="hideFactorySubmitModal()">&times;</button>
            </div>
            <form id="factorySubmitForm" onsubmit="submitFactoryProposal(event)">
                <div class="factory-form-group">
                    <label class="factory-form-label">Section</label>
                    <select id="factoryProposalSection" class="factory-form-select" onchange="onFactorySectionChange()">
                        <option value="suite_apps"> SUITE Apps</option>
                        <option value="business"> Business</option>
                        <option value="content"> Content</option>
                        <option value="social"> Social</option>
                    </select>
                </div>

                <!-- App dropdown (only shown when section = suite_apps) -->
                <div class="factory-form-group" id="factoryAppGroup">
                    <label class="factory-form-label">Related App</label>
                    <select id="factoryProposalApp" class="factory-form-select">
                        <option value="">-- General (no specific app) --</option>
                        <!-- Populated dynamically from apps table -->
                    </select>
                </div>

                <!-- New App checkbox (only shown when section = suite_apps) -->
                <div class="factory-form-group" id="factoryNewAppGroup">
                    <label class="factory-checkbox-label">
                        <input type="checkbox" id="factoryIsNewApp" onchange="onFactoryNewAppToggle()">
                        <span> This is a NEW app idea</span>
                    </label>
                </div>

                <div class="factory-form-group">
                    <label class="factory-form-label">What's your idea?</label>
                    <textarea class="factory-form-textarea" id="factoryProposalContent"
                        placeholder="Describe your idea, feature request, bug, or suggestion..."
                        rows="6" required></textarea>
                </div>

                <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 16px;">
                    AI will auto-generate title and category from your description.
                </p>

                <div class="factory-modal-actions">
                    <button type="button" class="factory-modal-btn cancel" onclick="hideFactorySubmitModal()">Cancel</button>
                    <button type="submit" class="factory-modal-btn submit" id="factorySubmitBtn">Submit Proposal</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Factory Auth Modal -->
    <div class="factory-modal-overlay" id="factoryAuthModal">
        <div class="factory-modal-content" style="text-align: center;">
            <div class="factory-modal-header">
                <h3 class="factory-modal-title">Connect to Participate</h3>
                <button class="factory-modal-close" onclick="hideFactoryAuthModal()">&times;</button>
            </div>
            <p style="color: var(--text-secondary); margin-bottom: 24px;">
                Connect an account to submit proposals and vote.
            </p>
            <button onclick="openConnectModal(); hideFactoryAuthModal();" class="factory-submit-btn" style="width: 100%; padding: 14px;">
                Connect Account
            </button>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="import-modal-overlay" id="importModal">
        <div class="import-modal">
            <div class="import-modal-header">
                <div>
                    <h2>Import Your AI History</h2>
                    <p>Your conversations reveal what you actually need. Let us analyze them and recommend the perfect tools for you.</p>
                </div>
                <button class="import-modal-close" id="importModalClose">&times;</button>
            </div>

            <div class="import-modal-body">
                <!-- Step 1: Source Selection & Upload -->
                <div class="import-step import-step-upload" id="importStepUpload">
                    <h4 style="font-size: 0.9rem; font-weight: 600; margin-bottom: 16px;">Select your source</h4>

                    <div class="import-sources">
                        <div class="import-source selected" data-source="chatgpt">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">ChatGPT</div>
                        </div>
                        <div class="import-source" data-source="claude">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"/>
                                    <path d="M12 16v-4M12 8h.01" stroke-linecap="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Claude</div>
                        </div>
                        <div class="import-source" data-source="gemini">
                            <div class="import-source-icon">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>
                            <div class="import-source-name">Gemini</div>
                        </div>
                    </div>

                    <div class="import-instructions" id="importInstructions">
                        <h4>How to export from ChatGPT</h4>
                        <ol>
                            <li>Go to <code>chat.openai.com</code></li>
                            <li>Click your profile then <strong>Settings</strong></li>
                            <li>Go to <strong>Data controls</strong></li>
                            <li>Click <strong>Export data</strong></li>
                            <li>Check your email for the download link</li>
                            <li>Upload the <code>conversations.json</code> file below</li>
                        </ol>
                    </div>

                    <div class="import-dropzone" id="importDropzone">
                        <div class="import-dropzone-icon"></div>
                        <h3>Drop your export file here</h3>
                        <p>or click to browse</p>
                        <button class="import-dropzone-btn">Choose File</button>
                        <input type="file" class="import-file-input" id="importFileInput" accept=".json,.zip">
                    </div>

                    <!-- Test mode option -->
                    <div style="text-align: center; margin-bottom: 16px;">
                        <button id="loadTestData" style="background: none; border: 1px dashed var(--border-subtle); padding: 10px 20px; border-radius: 8px; color: var(--text-tertiary); font-size: 0.8rem; cursor: pointer; transition: all 0.2s ease;">
                            Load sample data to test the flow
                        </button>
                    </div>

                    <div class="import-privacy">
                        <h4>Your data, your choice</h4>
                        <p>We analyze your conversations to understand your needs. We extract themes and topics, not personal details.</p>
                        <div class="import-consent">
                            <label>
                                <input type="checkbox" id="consentAnalyze" checked>
                                <span>Analyze my chats for personalized recommendations</span>
                            </label>
                            <label>
                                <input type="checkbox" id="consentImprove" checked>
                                <span>Help improve SUITE by sharing anonymized insights</span>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Step 2: Processing -->
                <div class="import-progress" id="importProgress">
                    <div class="import-progress-spinner"></div>
                    <h3>Analyzing your conversations...</h3>
                    <p id="importProgressText">Reading your chat history</p>
                    <div class="import-progress-bar">
                        <div class="import-progress-fill" id="importProgressFill"></div>
                    </div>
                </div>

                <!-- Step 3: Results -->
                <div class="import-results" id="importResults">
                    <div class="import-results-header">
                        <div class="success-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14" stroke-linecap="round"/>
                                <polyline points="22 4 12 14.01 9 11.01" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </div>
                        <h3>Analysis Complete!</h3>
                        <p>Here's what we learned about you</p>
                    </div>

                    <div class="import-stats">
                        <div class="import-stat">
                            <div class="import-stat-value" id="statConversations">0</div>
                            <div class="import-stat-label">Conversations</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statMessages">0</div>
                            <div class="import-stat-label">Messages</div>
                        </div>
                        <div class="import-stat">
                            <div class="import-stat-value" id="statTopics">0</div>
                            <div class="import-stat-label">Topics Found</div>
                        </div>
                    </div>

                    <div class="import-insights">
                        <h4>Key Insights</h4>
                        <div id="insightsList"></div>
                    </div>

                    <div class="import-recommendations">
                        <h4>Matched to Existing Apps</h4>
                        <div id="recommendationsList"></div>
                    </div>

                    <div class="import-unmatched" id="importUnmatched" style="display: none;">
                        <h4>App Ideas We Can Build For You</h4>
                        <p style="font-size: 0.8rem; color: var(--text-tertiary); margin-bottom: 16px;">
                            These ideas from your chats don't match existing apps. Click to request!
                        </p>
                        <div id="unmatchedList"></div>
                    </div>

                    <div class="import-cta">
                        <button class="import-cta-btn secondary" id="importDone">Done</button>
                        <button class="import-cta-btn primary" id="importRequestCustom">Request Custom App</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Builder Switch Confirmation Modal -->
    <div class="builder-switch-modal-overlay" id="builderSwitchModal">
        <div class="builder-switch-modal">
            <div class="builder-switch-modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="32" height="32">
                    <path d="M10.29 3.86L1.82 18a2 2 0 001.71 3h16.94a2 2 0 001.71-3L13.71 3.86a2 2 0 00-3.42 0z"/>
                    <line x1="12" y1="9" x2="12" y2="13"/>
                    <line x1="12" y1="17" x2="12.01" y2="17"/>
                </svg>
            </div>
            <h3>Switch to Regular Chat?</h3>
            <p>This will start a new conversation. You can find this builder chat in your <strong>History</strong> tab if you want to continue building your app later.</p>
            <div class="builder-switch-modal-actions">
                <button class="builder-switch-btn cancel" onclick="closeBuilderSwitchModal()">Stay in Builder</button>
                <button class="builder-switch-btn confirm" id="builderSwitchConfirmBtn">Switch Model</button>
            </div>
        </div>
    </div>

    <!-- Delete Chat Confirmation Modal -->
    <div class="delete-chat-modal-overlay" id="deleteChatModal">
        <div class="delete-chat-modal">
            <div class="delete-chat-modal-icon">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="28" height="28">
                    <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                    <line x1="10" y1="11" x2="10" y2="17"/>
                    <line x1="14" y1="11" x2="14" y2="17"/>
                </svg>
            </div>
            <h3>Delete this chat?</h3>
            <p>This conversation will be permanently deleted and cannot be recovered.</p>
            <div class="delete-chat-modal-actions">
                <button class="delete-chat-btn cancel" onclick="closeDeleteChatModal()">Cancel</button>
                <button class="delete-chat-btn delete" id="deleteChatConfirmBtn">Delete</button>
            </div>
        </div>
    </div>

    <!-- Connect Modal -->
    <div class="connect-modal-overlay" id="connectModalOverlay" onclick="if(event.target === this) closeConnectModal()">
        <div class="connect-modal">
            <button class="connect-modal-close" onclick="closeConnectModal()">&times;</button>
            <h3>Log in or sign up</h3>
            <p class="connect-modal-subtitle">Get smarter responses and track your credits</p>

            <!-- Primary Options -->
            <div class="connect-options-primary" id="connectOptionsPrimary">
                <button class="connect-option-btn google" onclick="loginWithGoogle()">
                    <svg width="20" height="20" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    Continue with Google
                </button>
                <button class="connect-option-btn email" onclick="showEmailForm()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="4" width="20" height="16" rx="2"/>
                        <path d="M22 6l-10 7L2 6"/>
                    </svg>
                    Continue with Email
                </button>
            </div>

            <!-- Email Form (hidden by default) -->
            <div class="email-auth-form" id="emailAuthForm" style="display: none;">
                <input type="email" id="authEmail" placeholder="Email address" autocomplete="email">
                <input type="password" id="authPassword" placeholder="Password (min 6 characters)" autocomplete="current-password" style="display: none;">
                <button class="connect-option-btn email" id="emailAuthBtn" onclick="handleEmailAuth()">Continue</button>
                <button class="email-back-btn" onclick="hideEmailForm()"> Back to login options</button>
            </div>

            <!-- Divider -->
            <div class="connect-divider"><span>or continue with</span></div>

            <!-- Secondary Options -->
            <div class="connect-options-secondary">
                <button class="connect-option-small telegram" onclick="loginWithTelegram()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                    </svg>
                    Telegram
                </button>
                <button class="connect-option-small wallet" onclick="connectWallet()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2"/>
                        <path d="M1 10h22"/>
                    </svg>
                    Wallet
                </button>
            </div>
        </div>
    </div>

    <!-- App Preview Container (Full Screen Inline) -->
    <div class="app-preview-overlay" id="appPreviewOverlay">
        <div class="app-preview-header">
            <button class="app-preview-back" onclick="closeAppPreview()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                SuiteGPT
            </button>
            <div class="app-preview-title">
                <div class="app-preview-icon" id="appPreviewIcon"></div>
                <span id="appPreviewName">App Name</span>
            </div>
            <button class="app-preview-add" id="appPreviewAddBtn" onclick="addAppToProfile()">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg>
                Add to Profile
            </button>
        </div>
        <div class="app-preview-content">
            <iframe id="appPreviewFrame" src="" frameborder="0" allow="camera; microphone; geolocation"></iframe>
        </div>
    </div>

    <!-- App Launch Modal (Desktop only) -->
    <div class="app-launch-modal-overlay" id="appLaunchModalOverlay" onclick="if(event.target === this) closeAppLaunchModal()">
        <div class="app-launch-modal">
            <div class="app-launch-modal-icon" id="appLaunchModalIcon"></div>
            <h3 id="appLaunchModalName">App Name</h3>
            <p>How would you like to view this app?</p>
            <div class="app-launch-options">
                <div class="app-launch-option" onclick="launchAppFullscreen()">
                    <div class="app-launch-option-icon"></div>
                    <div class="app-launch-option-title">Fullscreen</div>
                    <div class="app-launch-option-desc">Full browser view</div>
                </div>
                <div class="app-launch-option" onclick="launchAppMobile()">
                    <div class="app-launch-option-icon"></div>
                    <div class="app-launch-option-title">Mobile View</div>
                    <div class="app-launch-option-desc">Draggable phone window</div>
                </div>
            </div>
            <button class="app-launch-modal-close" onclick="closeAppLaunchModal()">Cancel</button>
        </div>
    </div>

    <!-- Mobile App Container (Draggable Phone View) -->
    <div class="mobile-app-container" id="mobileAppContainer">
        <div class="mobile-app-notch"></div>
        <div class="mobile-app-header" id="mobileAppHeader">
            <div class="mobile-app-header-left">
                <div class="mobile-app-header-icon" id="mobileAppIcon"></div>
                <span class="mobile-app-header-title" id="mobileAppTitle">App Name</span>
            </div>
            <div class="mobile-app-header-actions">
                <button class="mobile-app-btn mobile-app-btn-fullscreen" onclick="switchToFullscreen()" title="Switch to Fullscreen">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M8 3H5a2 2 0 00-2 2v3m18 0V5a2 2 0 00-2-2h-3m0 18h3a2 2 0 002-2v-3M3 16v3a2 2 0 002 2h3"/>
                    </svg>
                </button>
                <button class="mobile-app-btn mobile-app-btn-minimize" onclick="minimizeToSidebar()" title="Save & Minimize">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
                <button class="mobile-app-btn mobile-app-btn-close" onclick="closeMobileApp()" title="Close App">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
        </div>
        <div class="mobile-app-content">
            <iframe id="mobileAppFrame" src="" frameborder="0" allow="camera; microphone; geolocation"></iframe>
        </div>
    </div>

    <!-- Apps Panel -->
    <div class="apps-panel-overlay" id="appsPanelOverlay" onclick="if(event.target === this) closeAppsPanel()">
        <div class="apps-panel">
            <div class="apps-panel-header">
                <h2>All Apps</h2>
                <button class="apps-panel-close" onclick="closeAppsPanel()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </button>
            </div>
            <div class="apps-panel-search">
                <input type="text" id="appsPanelSearch" placeholder="Search apps..." oninput="filterApps(this.value)">
            </div>
            <div class="apps-panel-grid" id="appsPanelGrid">
                <!-- Apps will be populated by JavaScript -->
            </div>
        </div>
    </div>

    <!-- Upgrade Modal -->
    <div class="upgrade-modal-overlay" id="upgradeModalOverlay" onclick="if(event.target === this) closeUpgradeModal()">
        <div class="upgrade-modal">
            <button class="upgrade-modal-close" onclick="closeUpgradeModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <div class="upgrade-modal-header">
                <h2>Upgrade Your Plan</h2>
                <p>Get more out of SuiteGPT with premium features</p>
            </div>

            <div class="upgrade-tabs">
                <button class="upgrade-tab active" onclick="switchUpgradeTab('subscription')">Subscription</button>
                <button class="upgrade-tab" onclick="switchUpgradeTab('credits')">Buy Credits</button>
            </div>

            <!-- Subscription Plans -->
            <div class="subscription-section active" id="subscriptionSection">
                <div class="upgrade-plans">
                    <div class="upgrade-plan">
                        <div class="upgrade-plan-name">Free</div>
                        <div class="upgrade-plan-price">$0 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For casual users</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                50 messages/day
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Access to all apps
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Basic support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn secondary" disabled>Current Plan</button>
                    </div>

                    <div class="upgrade-plan popular">
                        <div class="upgrade-plan-badge">Most Popular</div>
                        <div class="upgrade-plan-name">Pro</div>
                        <div class="upgrade-plan-price">$9.99 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For power users</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Unlimited messages
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Priority AI responses
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Advanced app features
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Priority support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn primary" onclick="selectPlan('pro')">Upgrade to Pro</button>
                    </div>

                    <div class="upgrade-plan">
                        <div class="upgrade-plan-name">Business</div>
                        <div class="upgrade-plan-price">$29.99 <span>/month</span></div>
                        <div class="upgrade-plan-desc">For teams & professionals</div>
                        <ul class="upgrade-plan-features">
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Everything in Pro
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Team collaboration
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                API access
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Custom integrations
                            </li>
                            <li>
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Dedicated support
                            </li>
                        </ul>
                        <button class="upgrade-plan-btn primary" onclick="selectPlan('business')">Upgrade to Business</button>
                    </div>
                </div>
            </div>

            <!-- Credit Packs -->
            <div class="credits-section" id="creditsSection">
                <div class="credit-packs">
                    <div class="credit-pack" onclick="selectCreditPack(100)">
                        <div class="credit-pack-amount">100 Credits</div>
                        <div class="credit-pack-price">$4.99</div>
                        <div class="credit-pack-per">$0.05 per credit</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(500)">
                        <div class="credit-pack-amount">500 Credits</div>
                        <div class="credit-pack-price">$19.99</div>
                        <div class="credit-pack-per">$0.04 per credit</div>
                    </div>
                    <div class="credit-pack best-value" onclick="selectCreditPack(1000)">
                        <div class="credit-pack-badge">Best Value</div>
                        <div class="credit-pack-amount">1,000 Credits</div>
                        <div class="credit-pack-price">$34.99</div>
                        <div class="credit-pack-per">$0.035 per credit</div>
                    </div>
                    <div class="credit-pack" onclick="selectCreditPack(5000)">
                        <div class="credit-pack-amount">5,000 Credits</div>
                        <div class="credit-pack-price">$149.99</div>
                        <div class="credit-pack-per">$0.03 per credit</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Credits Modal -->
    <div class="credits-modal-overlay" id="creditsModalOverlay" onclick="if(event.target === this) closeCreditsModal()">
        <div class="credits-modal">
            <button class="credits-modal-close" onclick="closeCreditsModal()">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </button>
            <h2>Your Credits</h2>

            <div class="credits-modal-balance">
                <span class="credits-modal-amount" id="creditsModalAmount">0</span>
                <span class="credits-modal-label">credits available</span>
            </div>

            <!-- Rewards Status -->
            <div class="credits-rewards-status not-earning" id="creditsRewardsStatus">
                <div class="credits-rewards-row">
                    <div class="credits-rewards-left">
                        <span class="credits-rewards-dot"></span>
                        <div class="credits-rewards-text">
                            <span class="credits-rewards-title" id="creditsRewardsTitle">Earning rewards: OFF</span>
                            <span class="credits-rewards-sub" id="creditsRewardsSub">Connect a wallet to start earning USDC</span>
                        </div>
                    </div>
                    <span id="creditsRewardsActionArea">
                        <span class="credits-rewards-nowallet">
                            <a href="#" onclick="event.preventDefault(); closeCreditsModal(); connectWallet();">Link wallet</a>
                        </span>
                    </span>
                </div>
                <div class="credits-rewards-earned" id="creditsRewardsEarned" style="display: none;">
                    <span class="credits-rewards-earned-label">Claimable USDC</span>
                    <span class="credits-rewards-earned-value" id="creditsRewardsEarnedAmt">$0.00</span>
                </div>
            </div>

            <div class="credits-modal-options">
                <button class="credits-modal-option" onclick="closeCreditsModal(); openBuyModal();">
                    <div class="credits-modal-option-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 6v12M6 12h12"/>
                        </svg>
                    </div>
                    <div class="credits-modal-option-text">
                        <div class="credits-modal-option-title">Buy Credits</div>
                        <div class="credits-modal-option-desc">Purchase with card or crypto</div>
                    </div>
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 18l6-6-6-6"/>
                    </svg>
                </button>

            </div>
        </div>
    </div>

    <!-- Buy Credits Modal -->
    <div class="buy-modal-overlay" id="buyModalOverlay" onclick="if(event.target === this) backToCreditsModal()">
        <div class="buy-modal">
            <button class="buy-modal-back" id="buyModalBackBtn" onclick="handleBuyModalBack()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back
            </button>

            <!-- Step 1: Choose Payment Method -->
            <div id="buyMethodState">
                <h3>Buy Credits</h3>
                <p class="buy-modal-subtitle">Choose how you'd like to pay</p>

                <div class="buy-modal-options">
                    <button class="buy-modal-method" onclick="showBuyCryptoState()">
                        <div class="buy-modal-method-icon crypto">&#9830;</div>
                        <div class="buy-modal-method-text">
                            <div class="buy-modal-method-title">Pay with Crypto</div>
                            <div class="buy-modal-method-desc">USDC on Base network</div>
                        </div>
                        <span class="buy-modal-method-arrow">&#8250;</span>
                    </button>

                    <button class="buy-modal-method" onclick="showBuyFiatState()">
                        <div class="buy-modal-method-icon fiat">&#128179;</div>
                        <div class="buy-modal-method-text">
                            <div class="buy-modal-method-title">Pay with Card</div>
                            <div class="buy-modal-method-desc">Credit/debit card via Stripe</div>
                        </div>
                        <span class="buy-modal-method-arrow">&#8250;</span>
                    </button>
                </div>

                <div class="buy-modal-rate">
                    <strong>$1 = 1,000 Credits</strong>
                </div>
            </div>

            <!-- Step 2a: Crypto Payment -->
            <div id="buyCryptoState" style="display: none;">
                <h3>Pay with Crypto</h3>
                <div class="buy-modal-input-group">
                    <label>Amount (USDC)</label>
                    <input type="number" class="buy-modal-input" id="buyAmount" placeholder="10" min="1" step="1" value="10" oninput="updateBuyPreview()">
                </div>
                <div class="buy-modal-preview">
                    <div class="buy-modal-preview-value" id="buyPreviewCredits">10,000</div>
                    <div class="buy-modal-preview-label">Credits you'll receive</div>
                </div>
                <button class="buy-modal-btn primary" id="btnBuyConfirm" onclick="executeBuy()">
                    Pay with USDC
                </button>
                <p class="buy-modal-note">Requires USDC on Base network</p>
                <div class="buy-modal-disclaimer">
                    <strong>Please note:</strong> Your credits are used for AI features in apps. As the reward pool grows, you'll earn bonus credits that can be withdrawn. Pool performance can go up or down. <a href="/docs/vault/">Learn more </a>
                </div>
            </div>

            <!-- Step 2b: Fiat Payment -->
            <div id="buyFiatState" style="display: none;">
                <h3>Pay with Card</h3>

                <div class="buy-modal-input-group">
                    <label>Amount (USD)</label>
                    <div class="buy-modal-amount-btns">
                        <button onclick="setFiatAmount(5)" class="fiat-amount-btn" data-amount="5">$5</button>
                        <button onclick="setFiatAmount(10)" class="fiat-amount-btn active" data-amount="10">$10</button>
                        <button onclick="setFiatAmount(25)" class="fiat-amount-btn" data-amount="25">$25</button>
                        <button onclick="setFiatAmount(50)" class="fiat-amount-btn" data-amount="50">$50</button>
                    </div>
                    <input type="number" class="buy-modal-input" id="fiatAmount" placeholder="10" min="1" max="1000" step="1" value="10" oninput="updateFiatPreview()">
                </div>
                <div class="buy-modal-preview">
                    <div class="buy-modal-preview-value" id="fiatPreviewCredits">10,000</div>
                    <div class="buy-modal-preview-label">Credits you'll receive</div>
                </div>
                <button class="buy-modal-btn primary" id="btnFiatPay" onclick="initiateStripeCheckout()">
                    <span id="fiatPayText">Pay $10 with Card</span>
                </button>
                <p class="buy-modal-note">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    Secure payment via Stripe
                </p>
                <div class="buy-modal-disclaimer">
                    <strong>Please note:</strong> Your credits are used for AI features in apps. As the reward pool grows, you'll earn bonus credits that can be withdrawn. Pool performance can go up or down. <a href="/docs/vault/">Learn more </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="settings-modal-overlay" id="settingsModalOverlay" onclick="if(event.target === this) closeSettingsModal()">
        <div class="settings-modal">
            <nav class="settings-nav">
                <button class="settings-nav-item active" data-panel="docs" onclick="switchSettingsPanel('docs')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/>
                        <path d="M14 2v6h6M16 13H8M16 17H8M10 9H8"/>
                    </svg>
                    Documentation
                </button>
                <button class="settings-nav-item" data-panel="learn" onclick="switchSettingsPanel('learn')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"/>
                    </svg>
                    Learn
                </button>
                <button class="settings-nav-item" data-panel="community" onclick="switchSettingsPanel('community')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/>
                    </svg>
                    Community Chat
                </button>
                <button class="settings-nav-item" data-panel="import" onclick="switchSettingsPanel('import')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Import History
                </button>
            </nav>
            <div class="settings-content">
                <div class="settings-content-header">
                    <h2 id="settingsPanelTitle">Documentation</h2>
                    <button class="settings-close-btn" onclick="closeSettingsModal()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>

                <!-- Documentation Panel -->
                <div class="settings-panel active" id="settingsPanelDocs">
                    <p class="settings-panel-description">
                        Access the SUITE documentation to learn about features, APIs, and how to get the most out of the platform.
                    </p>
                    <a href="https://www.getsuite.app/docs/" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <path d="M15 3h6v6M10 14L21 3"/>
                        </svg>
                        Open Documentation
                    </a>
                </div>

                <!-- Learn Panel -->
                <div class="settings-panel" id="settingsPanelLearn">
                    <p class="settings-panel-description">
                        Explore articles about AI fitness apps, productivity tools, and how SUITE works. Guides, tips, and deep dives.
                    </p>
                    <a href="https://getsuite.app/learn/articles.html" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 13v6a2 2 0 01-2 2H5a2 2 0 01-2-2V8a2 2 0 012-2h6"/>
                            <path d="M15 3h6v6M10 14L21 3"/>
                        </svg>
                        Browse Articles
                    </a>
                </div>

                <!-- Community Chat Panel -->
                <div class="settings-panel" id="settingsPanelCommunity">
                    <p class="settings-panel-description">
                        Join the SUITE community on Telegram to chat with other users, share ideas, get help, and stay updated on the latest features.
                    </p>
                    <a href="https://t.me/getsuiteapp" target="_blank" class="settings-action-btn" style="text-decoration: none;">
                        <svg viewBox="0 0 24 24" fill="currentColor">
                            <path d="M12 0C5.373 0 0 5.373 0 12s5.373 12 12 12 12-5.373 12-12S18.627 0 12 0zm5.562 8.161c-.18 1.897-.962 6.502-1.359 8.627-.168.9-.5 1.201-.82 1.23-.697.064-1.226-.461-1.901-.903-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.015-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.139-5.062 3.345-.479.329-.913.489-1.302.481-.428-.009-1.252-.242-1.865-.442-.751-.244-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.831-2.529 6.998-3.015 3.333-1.386 4.025-1.627 4.477-1.635.099-.002.321.023.465.142.121.1.154.234.169.337.015.103.034.337.019.519z"/>
                        </svg>
                        Join Telegram Community
                    </a>
                </div>

                <!-- Import History Panel -->
                <div class="settings-panel" id="settingsPanelImport">
                    <p class="settings-panel-description">
                        Import your chat history from other AI assistants like ChatGPT. Your conversations will be securely stored and available across devices.
                    </p>
                    <button class="settings-action-btn" onclick="closeSettingsModal(); triggerHistoryImport();">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/>
                        </svg>
                        Import Chat History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdrawal Modal -->
    <div class="withdrawal-modal-overlay" id="withdrawalModalOverlay" onclick="if(event.target === this) backToCreditsFromWithdrawal()">
        <div class="withdrawal-modal">
            <button class="withdrawal-modal-back" onclick="backToCreditsFromWithdrawal()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                Back
            </button>
            <h2>Request Withdrawal</h2>

            <div class="withdrawal-balance">
                <div class="withdrawal-balance-credits" id="withdrawalCredits">0</div>
                <div class="withdrawal-balance-value">credits available</div>
                <div class="withdrawal-balance-value" id="withdrawalValue">~$0.00 USD value</div>
            </div>

            <div class="withdrawal-input-group">
                <label>Amount to withdraw (credits)</label>
                <div class="withdrawal-input-wrapper">
                    <input type="number" class="withdrawal-input" id="withdrawalAmount" placeholder="Enter amount" min="0">
                    <button class="withdrawal-max-btn" onclick="setMaxWithdrawal()">Max</button>
                </div>
            </div>

            <div class="withdrawal-note">
                Withdrawals are processed when the pool has sufficient funds. You'll receive a notification when your withdrawal is ready.
            </div>

            <button class="withdrawal-confirm-btn" id="withdrawalConfirmBtn" onclick="submitWithdrawal()">
                Confirm Withdrawal Request
            </button>
        </div>
    </div>

    <script>
        // ========================
        // SUPABASE CONFIG (declare early to avoid TDZ errors)
        // ========================
        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';
        const ADMIN_WALLETS = ['0x92d67d8ad8b986e78b369be0272e121ae5acad59'];
        let supabaseClient = null;

        // ========================
        // BLOCKCHAIN CONFIG (for credit purchases)
        // ========================
        const SUITE_STAKING_ADDRESS = '0x539d3fE65339c0dA7aaa6D0a528b520d8B010F54';
        const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // Base USDC
        const BASE_CHAIN_ID = 8453;
        const BASE_RPC = 'https://mainnet.base.org';
        const CREDITS_PER_USDC = 1000;
        const BASE_AI_COST = 5; // credits per AI action  SUITE's floor cost
        // StakingRewards contract  decentralized reward pool on Base
        const STAKING_REWARDS_ADDRESS = '0x4e4B34DDAdd4e92c75a2446a26dba2a020dA02f7';
        const STAKING_REWARDS_ABI = [
            'function depositRewards(uint256 amount) external',
            'function claimUsdc() external',
            'function earned(address user) view returns (uint256)',
            'function totalCredits() view returns (uint256)',
            'function userCredits(address user) view returns (uint256)',
            'function rewardRate() view returns (uint256)',
            'function rewardsDuration() view returns (uint256)',
            'function periodFinish() view returns (uint256)',
            'function getRewardForDuration() view returns (uint256)'
        ];

        const STAKING_ABI = [
            'function availableCredits(address) view returns (uint256)',
            'function stakedBalance(address) view returns (uint256)',
            'function bonusCredits(address) view returns (uint256)',
            'function buyAndStake(uint256 usdcAmount) external'
        ];

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function balanceOf(address) view returns (uint256)',
            'function transfer(address to, uint256 amount) returns (bool)'
        ];

        // Debug: Check localStorage for Supabase session
        console.log('[Auth Debug] URL:', window.location.href);
        console.log('[Auth Debug] URL hash:', window.location.hash);
        console.log('[Auth Debug] URL search:', window.location.search);

        // Check for OAuth error in URL
        const debugParams = new URLSearchParams(window.location.search);
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        if (debugParams.get('error') || hashParams.get('error')) {
            console.error('[Auth Debug] OAuth ERROR:', debugParams.get('error') || hashParams.get('error'));
            console.error('[Auth Debug] Error description:', debugParams.get('error_description') || hashParams.get('error_description'));
        }
        if (debugParams.get('code')) {
            console.log('[Auth Debug] OAuth code found in URL - exchange should happen');
        }
        if (hashParams.get('access_token')) {
            console.log('[Auth Debug] Access token found in hash');
        }

        // Test if localStorage works
        try {
            localStorage.setItem('_test', '1');
            localStorage.removeItem('_test');
            console.log('[Auth Debug] localStorage is working');
        } catch (e) {
            console.error('[Auth Debug] localStorage is BLOCKED:', e);
        }

        const sbKey = 'sb-rdsmdywbdiskxknluiym-auth-token';
        console.log('[Auth Debug] Supabase localStorage key exists:', !!localStorage.getItem(sbKey));
        console.log('[Auth Debug] All localStorage keys:', Object.keys(localStorage));
        console.log('[Auth Debug] Supabase-related keys:', Object.keys(localStorage).filter(k => k.includes('supabase') || k.includes('sb-')));

        // ========================
        // GLOBAL VIEW FUNCTIONS (must be at top for onclick handlers)
        // ========================

        // Helper to close mobile sidebar
        function closeMobileSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            if (sidebar) {
                sidebar.classList.remove('open');
                sidebar.classList.remove('mobile-open');
            }
            if (sidebarOverlay) sidebarOverlay.classList.remove('active');
        }

        // ========================
        // CREATOR DASHBOARD
        // ========================

        // App tier definitions
        const APP_TIER_MAP = {
            // Tools (quick utilities)
            'hydrotrack': 'tool',
            'focusflow': 'tool',
            'quickbudget': 'tool',
            'breatheasy': 'tool',
            'stretchtimer': 'tool',
            'quickdecide': 'tool',
            'stepgoal': 'tool',
            // Extensions (add-ons & integrations)
            'defi-knowledge': 'extension',
            'cadence-ai': 'extension',
            'visual-feedback': 'extension',
            // Apps (full-featured)
            'foodvitals': 'app',
            'trueform': 'app',
            'opticrep': 'app',
            'sleepwell': 'app',
            'moodlog': 'app',
            'pillpal': 'app',
            'flashmind': 'app',
            'bookshelf': 'app',
            'skilltree': 'app',
            'mealprep': 'app',
            'cleanhome': 'app',
            'datenight': 'app',
            'petcare': 'app',
            'packlight': 'app',
            'giftguru': 'app',
            'habitstack': 'app',
            'remcast': 'app',
            'cheshbon': 'app',
            'jesus-is-god': 'app',
            // Platforms (business/enterprise)
            'proto-golf': 'platform',
            'galtwoodco': 'platform',
            'movestrong': 'platform'
        };

        // App Categories for browse/filter UX
        const APP_CATEGORIES = {
            'all': { label: 'All', icon: '' },
            'health': { label: 'Health & Fitness', icon: '' },
            'productivity': { label: 'Productivity', icon: '' },
            'finance': { label: 'Finance', icon: '' },
            'lifestyle': { label: 'Lifestyle', icon: '' },
            'learning': { label: 'Learning', icon: '' },
            'creative': { label: 'Social & Creative', icon: '' },
            'spiritual': { label: 'Spiritual', icon: '' }
        };

        // Map apps to categories
        const APP_CATEGORY_MAP = {
            // Health & Fitness
            'hydrotrack': 'health',
            'sleepwell': 'health',
            'moodlog': 'health',
            'pillpal': 'health',
            'breatheasy': 'health',
            'stepgoal': 'health',
            'stretchtimer': 'health',
            'foodvitals': 'health',
            'trueform': 'health',
            'opticrep': 'health',
            // Productivity
            'focusflow': 'productivity',
            'flashmind': 'productivity',
            'remcast': 'lifestyle',
            'habitstack': 'productivity',
            'quickdecide': 'productivity',
            // Finance
            'quickbudget': 'finance',
            'cheshbon': 'spiritual',
            'defi-knowledge': 'finance',
            // Lifestyle
            'mealprep': 'lifestyle',
            'cleanhome': 'lifestyle',
            'datenight': 'lifestyle',
            'petcare': 'lifestyle',
            'packlight': 'lifestyle',
            'giftguru': 'lifestyle',
            // Learning
            'bookshelf': 'learning',
            'skilltree': 'learning',
            // Social & Creative
            'cadence-ai': 'creative',
            // Spiritual
            'jesus-is-god': 'spiritual',
            // Platform (shown in all)
            'proto-golf': 'health',
            'galtwoodco': 'creative',
            'movestrong': 'health',
            // Extension
            'visual-feedback': 'productivity',
            // Tools
            'transcribe': 'productivity',
            'bgswap': 'creative'
        };

        // Featured apps (new or popular)
        const FEATURED_APPS = ['opticrep', 'trueform', 'foodvitals', 'proto-golf', 'cadence-ai'];

        // Current proposal state
        let currentProposalApp = null;
        let currentProposalIsNew = false;
        let selectedTier = null;
        let currentDashboardTab = 'your-apps';

        function openCreatorDashboard(tab = 'your-apps', skipPushState = false) {
            // Close builder mode if open
            exitBuilderMode();

            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const factoryView = document.getElementById('factoryView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const connectionsView = document.getElementById('connectionsView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (connectionsView) connectionsView.classList.remove('active');
            hideArticle();

            // Show Dashboard
            if (creatorDashboard) creatorDashboard.classList.add('active');
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Update URL to /creator-dashboard
            if (!skipPushState) {
                history.pushState({ view: 'creator-dashboard', tab: tab }, '', '/creator-dashboard');
            }

            // Switch to specified tab
            switchDashboardTab(tab);

            // Render apps if on your-apps tab
            if (tab === 'your-apps') {
                renderDashboardApps();
            }
        }

        function switchDashboardTab(tabId) {
            currentDashboardTab = tabId;

            // Update tab buttons
            document.querySelectorAll('.creator-dashboard-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.tab === tabId);
            });

            // Update panels
            const panelMap = {
                'your-apps': 'dashboardPanelYourApps',
                'earnings': 'dashboardPanelEarnings',
                'my-requests': 'dashboardPanelMyRequests'
            };

            Object.entries(panelMap).forEach(([key, panelId]) => {
                const panel = document.getElementById(panelId);
                if (panel) {
                    panel.classList.toggle('active', key === tabId);
                }
            });

            // Render apps when switching to your-apps tab
            if (tabId === 'your-apps') {
                renderDashboardApps();
            }
        }

        function closeCreatorDashboard(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const useCasesSection = document.getElementById('useCasesSection');

            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (creatorDashboard) creatorDashboard.classList.remove('active');

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        // Legacy function for backwards compatibility
        function openYourApps() {
            openCreatorDashboard('your-apps');
        }

        function openCreate() {
            openBuilderMode();
        }

        function openEarnings() {
            openCreatorDashboard('earnings');
        }

        function closeYourAppsView() {
            closeCreatorDashboard();
        }

        function closeCreateView() {
            closeCreatorDashboard();
        }

        function closeEarningsView() {
            closeCreatorDashboard();
        }

        // ========================
        // CONNECTIONS FUNCTIONALITY
        // ========================

        // Store connected services in localStorage
        const AVAILABLE_CONNECTIONS = {
            // Health & Fitness
            'apple-health': { name: 'Apple Health', category: 'health' },
            'google-fit': { name: 'Google Fit', category: 'health' },
            'strava': { name: 'Strava', category: 'health' },
            'fitbit': { name: 'Fitbit', category: 'health' },
            'oura': { name: 'Oura Ring', category: 'health' },
            'whoop': { name: 'Whoop', category: 'health' },
            'garmin': { name: 'Garmin', category: 'health' },
            'myfitnesspal': { name: 'MyFitnessPal', category: 'health' },
            'peloton': { name: 'Peloton', category: 'health' },
            // Productivity
            'google-calendar': { name: 'Google Calendar', category: 'productivity' },
            'notion': { name: 'Notion', category: 'productivity' },
            'todoist': { name: 'Todoist', category: 'productivity' },
            'slack': { name: 'Slack', category: 'productivity' },
            'linear': { name: 'Linear', category: 'productivity' },
            'trello': { name: 'Trello', category: 'productivity' },
            // Finance
            'plaid': { name: 'Plaid', category: 'finance' },
            'coinbase': { name: 'Coinbase', category: 'finance' },
            'robinhood': { name: 'Robinhood', category: 'finance' },
            // Music & Media
            'spotify': { name: 'Spotify', category: 'music' },
            'apple-music': { name: 'Apple Music', category: 'music' },
            'youtube': { name: 'YouTube', category: 'music' },
            'netflix': { name: 'Netflix', category: 'music' },
            // Social
            'x': { name: 'X (Twitter)', category: 'social' },
            'instagram': { name: 'Instagram', category: 'social' },
            'discord': { name: 'Discord', category: 'social' },
            'linkedin': { name: 'LinkedIn', category: 'social' }
        };

        function openConnections(skipPushState = false) {
            // Close builder mode if open
            exitBuilderMode();

            const welcomeState = document.getElementById('welcomeState');
            const connectionsView = document.getElementById('connectionsView');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            hideArticle();

            // Show connections view
            if (connectionsView) connectionsView.classList.add('active');
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Update URL
            if (!skipPushState) {
                history.pushState({ view: 'connections' }, '', '/connections');
            }

            // Render connection states
            renderConnectionStates();
        }

        function closeConnections(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const connectionsView = document.getElementById('connectionsView');
            const useCasesSection = document.getElementById('useCasesSection');

            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (connectionsView) connectionsView.classList.remove('active');

            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        function getConnectedServices() {
            return JSON.parse(localStorage.getItem('connectedServices') || '[]');
        }

        function saveConnectedServices(services) {
            localStorage.setItem('connectedServices', JSON.stringify(services));
        }

        function renderConnectionStates() {
            const connected = getConnectedServices();
            const connectedCount = document.getElementById('connectedCount');
            const availableCount = document.getElementById('availableCount');

            if (connectedCount) connectedCount.textContent = connected.length;
            if (availableCount) availableCount.textContent = Object.keys(AVAILABLE_CONNECTIONS).length - connected.length;

            // Update each connection item
            document.querySelectorAll('.connection-item').forEach(item => {
                const service = item.dataset.service;
                const btn = item.querySelector('.connection-item-btn');
                const isConnected = connected.includes(service);

                if (isConnected) {
                    item.classList.add('connected');
                    btn.textContent = 'Manage';
                    btn.classList.add('connected');
                    btn.onclick = () => manageService(service);
                } else {
                    item.classList.remove('connected');
                    btn.textContent = 'Connect';
                    btn.classList.remove('connected');
                    btn.onclick = () => connectService(service);
                }
            });
        }

        function connectService(serviceId) {
            const service = AVAILABLE_CONNECTIONS[serviceId];
            if (!service) return;

            // In a real app, this would open OAuth flow
            // For now, simulate connection
            showToast(`Connecting to ${service.name}...`);

            setTimeout(() => {
                const connected = getConnectedServices();
                if (!connected.includes(serviceId)) {
                    connected.push(serviceId);
                    saveConnectedServices(connected);
                }
                renderConnectionStates();
                showToast(` Connected to ${service.name}!`);
            }, 1000);
        }

        function manageService(serviceId) {
            const service = AVAILABLE_CONNECTIONS[serviceId];
            if (!service) return;

            // Show a simple confirm to disconnect
            if (confirm(`Disconnect from ${service.name}?\n\nThis will remove access to your ${service.name} data.`)) {
                const connected = getConnectedServices();
                const index = connected.indexOf(serviceId);
                if (index > -1) {
                    connected.splice(index, 1);
                    saveConnectedServices(connected);
                }
                renderConnectionStates();
                showToast(`Disconnected from ${service.name}`);
            }
        }

        async function renderDashboardApps() {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const emptyState = document.getElementById('dashboardAppsEmpty');
            const content = document.getElementById('dashboardAppsContent');
            const listEl = document.getElementById('dashboardUnifiedList');
            const countBadge = document.getElementById('dashboardAppsCountBadge');
            const factoryUser = getFactoryCurrentUser();

            // Fetch user-created apps from Supabase
            let userCreatedApps = [];
            if (supabaseClient && factoryUser) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_apps')
                        .select('id, name, description, icon_bg, code, updated_at, created_at')
                        .eq('user_id', factoryUser.id)
                        .order('updated_at', { ascending: false })
                        .limit(50);
                    if (!error && data) userCreatedApps = data;
                } catch (e) {
                    console.error('Failed to load user apps for dashboard:', e);
                }
            }

            const totalCount = savedApps.length + userCreatedApps.length;

            // Update count badge
            if (countBadge) countBadge.textContent = totalCount;

            // Show empty state if nothing
            if (totalCount === 0) {
                if (emptyState) emptyState.style.display = 'flex';
                if (content) content.style.display = 'none';
                return;
            }

            // Hide empty state, show content
            if (emptyState) emptyState.style.display = 'none';
            if (content) content.style.display = 'block';
            if (!listEl) return;

            listEl.innerHTML = '';

            // Build unified items: created projects first, then bookmarked
            const items = [];
            userCreatedApps.forEach(app => items.push({ type: 'created', data: app }));
            savedApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (app) items.push({ type: 'bookmarked', key: appKey, data: app });
            });

            items.forEach(item => {
                if (item.type === 'created') {
                    listEl.appendChild(renderCreatedProjectCard(item.data));
                } else {
                    listEl.appendChild(renderBookmarkedRow(item.key, item.data));
                }
            });
        }

        // Legacy function for backwards compatibility
        function renderYourApps() {
            renderDashboardApps();
        }

        function renderBookmarkedRow(appKey, app) {
            const row = document.createElement('div');
            row.className = 'your-apps-bookmark-row';

            const iconHtml = app.iconUrl
                ? `<img src="${app.iconUrl}" alt="${app.name}">`
                : app.icon || '';

            row.innerHTML = `
                <div class="your-apps-bookmark-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                    ${iconHtml}
                </div>
                <div class="your-apps-bookmark-info">
                    <div class="your-apps-bookmark-name">${app.name}</div>
                    <div class="your-apps-bookmark-desc">${app.description || ''}</div>
                </div>
                <div class="your-apps-bookmark-actions">
                    <button class="your-apps-bookmark-launch" onclick="event.stopPropagation(); launchApp('${appKey}', '${app.url}', '${app.name}')">Launch</button>
                    <button class="your-apps-bookmark-remove" onclick="event.stopPropagation(); removeFromYourApps('${appKey}')" title="Remove">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12" stroke-linecap="round"/>
                        </svg>
                    </button>
                </div>
            `;
            return row;
        }

        function renderCreatedProjectCard(app) {
            const card = document.createElement('div');
            card.className = 'your-apps-project-card';
            card.setAttribute('data-project-id', app.id);

            const safeName = (app.name || 'Untitled').replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const safeDesc = (app.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');

            card.innerHTML = `
                <div class="your-apps-project-header" onclick="toggleProjectCard('${app.id}')">
                    <div class="your-apps-project-icon" style="background: ${app.icon_bg || 'linear-gradient(135deg, #22c55e, #10b981)'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                    </div>
                    <div class="your-apps-project-info">
                        <div class="your-apps-project-name">
                            ${app.name || 'Untitled'}
                            <span class="your-apps-project-badge">Your Project</span>
                        </div>
                        <div class="your-apps-project-desc">${app.description || 'No description'}</div>
                    </div>
                    <svg class="your-apps-project-chevron" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="6 9 12 15 18 9"/>
                    </svg>
                </div>
                <div class="project-card-sections">
                    <div class="project-section">
                        <div class="project-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg>
                            App
                        </div>
                        <div class="project-section-content">
                            <button class="project-section-btn primary" onclick="event.stopPropagation(); launchCommunityApp('${app.id}')">Launch</button>
                            <button class="project-section-btn" onclick="event.stopPropagation(); editUserApp('${app.id}')">Edit</button>
                            <button class="project-section-btn" onclick="event.stopPropagation(); openAppSettings('${app.id}')">Settings</button>
                            <button class="project-section-btn" onclick="event.stopPropagation(); removeUserApp('${app.id}')">Delete</button>
                        </div>
                    </div>
                    <div class="project-section">
                        <div class="project-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-4 0a1 1 0 01-1-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 01-1 1"/></svg>
                            Landing Page
                        </div>
                        <div class="project-section-content">
                            <span class="project-section-placeholder">Coming soon</span>
                        </div>
                    </div>
                    <div class="project-section">
                        <div class="project-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 5.882V19.24a1.76 1.76 0 01-3.417.592l-2.147-6.15M18 13a3 3 0 100-6M5.436 13.683A4.001 4.001 0 017 6h1.832c4.1 0 7.625-1.234 9.168-3v14c-1.543-1.766-5.067-3-9.168-3H7a3.988 3.988 0 01-1.564-.317z"/></svg>
                            Marketing
                        </div>
                        <div class="project-section-content">
                            <span class="project-section-placeholder">Coming soon</span>
                        </div>
                    </div>
                    <div class="project-section">
                        <div class="project-section-title">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Incubation
                        </div>
                        <div class="project-section-content">
                            <button class="project-section-btn" onclick="event.stopPropagation(); showIncubationCTA('${app.id}')">Learn More</button>
                        </div>
                    </div>
                </div>
            `;
            return card;
        }

        function toggleProjectCard(projectId) {
            const card = document.querySelector(`.your-apps-project-card[data-project-id="${projectId}"]`);
            if (card) card.classList.toggle('expanded');
        }

        function editUserApp(appId) {
            showToast('App editor coming soon  use the builder to iterate on your app.');
        }

        function showIncubationCTA(appId) {
            showToast('Incubation program coming soon  grow your app with SUITE support.');
        }

        function removeFromYourApps(appKey) {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const index = savedApps.indexOf(appKey);
            if (index > -1) {
                savedApps.splice(index, 1);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                renderDashboardApps();
                renderSidebarApps();
                showToast(`${SUITE_APPS[appKey]?.name || 'App'} removed from your apps`);
            }
        }

        // Proposal Modal Functions
        function openProposeModal(appKey) {
            currentProposalApp = appKey;
            currentProposalIsNew = false;
            selectedTier = null;

            const overlay = document.getElementById('proposalModalOverlay');
            const title = document.getElementById('proposalModalTitle');
            const appSection = document.getElementById('proposalModalApp');
            const tierOptions = document.getElementById('proposalTierOptions');
            const label = document.getElementById('proposalModalLabel');
            const textarea = document.getElementById('proposalModalTextarea');
            const appIcon = document.getElementById('proposalModalAppIcon');
            const appName = document.getElementById('proposalModalAppName');

            // Configure for refinement mode
            title.textContent = 'Propose Refinement';
            label.textContent = 'What would you like to improve?';
            textarea.placeholder = 'Describe your improvement idea for this app...';
            textarea.value = '';

            // Show app info, hide tier options
            if (appSection) appSection.style.display = 'flex';
            if (tierOptions) tierOptions.style.display = 'none';

            // Set app info
            const app = SUITE_APPS[appKey];
            if (app) {
                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';
                appIcon.innerHTML = iconHtml;
                appIcon.style.background = app.iconBg;
                appName.textContent = app.name;
            }

            // Show modal
            if (overlay) overlay.classList.add('active');
            updateProposalSubmitState();
        }

        function openCreateAppModal() {
            currentProposalApp = null;
            currentProposalIsNew = true;
            selectedTier = null;

            const overlay = document.getElementById('proposalModalOverlay');
            const title = document.getElementById('proposalModalTitle');
            const appSection = document.getElementById('proposalModalApp');
            const tierOptions = document.getElementById('proposalTierOptions');
            const label = document.getElementById('proposalModalLabel');
            const textarea = document.getElementById('proposalModalTextarea');

            // Configure for new app mode
            title.textContent = 'Create New App';
            label.textContent = 'Describe your app idea';
            textarea.placeholder = 'What should this app do? Who is it for? What problem does it solve?';
            textarea.value = '';

            // Hide app info, show tier options
            if (appSection) appSection.style.display = 'none';
            if (tierOptions) tierOptions.style.display = 'block';

            // Reset tier selection
            document.querySelectorAll('.tier-option').forEach(opt => opt.classList.remove('selected'));

            // Show modal
            if (overlay) overlay.classList.add('active');
            updateProposalSubmitState();
        }

        function closeProposalModal(event) {
            if (event && event.target !== event.currentTarget) return;

            const overlay = document.getElementById('proposalModalOverlay');
            if (overlay) overlay.classList.remove('active');

            currentProposalApp = null;
            currentProposalIsNew = false;
            selectedTier = null;
        }

        function selectTierOption(element) {
            // Remove selection from all options
            document.querySelectorAll('.tier-option').forEach(opt => opt.classList.remove('selected'));

            // Select this option
            element.classList.add('selected');
            selectedTier = element.dataset.tier;

            updateProposalSubmitState();
        }

        function updateProposalSubmitState() {
            const textarea = document.getElementById('proposalModalTextarea');
            const submitBtn = document.getElementById('proposalModalSubmit');

            if (!textarea || !submitBtn) return;

            const hasText = textarea.value.trim().length > 10;
            const hasTier = !currentProposalIsNew || selectedTier !== null;

            submitBtn.disabled = !hasText || !hasTier;
        }

        async function submitProposal() {
            const textarea = document.getElementById('proposalModalTextarea');
            const submitBtn = document.getElementById('proposalModalSubmit');

            if (!textarea || submitBtn.disabled) return;

            const content = textarea.value.trim();
            if (!content) return;

            // Disable button while submitting
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            try {
                // Get current user info
                let username = 'Anonymous';
                let userEmail = null;

                if (typeof supabaseClient !== 'undefined' && supabaseClient) {
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) {
                        username = user.user_metadata?.full_name || user.user_metadata?.name || user.email?.split('@')[0] || 'Anonymous';
                        userEmail = user.email;
                    }
                }

                // Build proposal data
                const proposalData = {
                    content: content,
                    section: 'suite_apps',
                    category: currentProposalIsNew ? 'feature' : 'enhancement',
                    is_new_app: currentProposalIsNew,
                    username: username
                };

                // Add app target for refinements
                if (!currentProposalIsNew && currentProposalApp) {
                    proposalData.app_target = currentProposalApp;
                    const app = SUITE_APPS[currentProposalApp];
                    if (app) {
                        proposalData.content = `[${app.name}] ${content}`;
                    }
                }

                // Add tier for new apps
                if (currentProposalIsNew && selectedTier) {
                    proposalData.tier = selectedTier;
                    const tierNames = { tool: 'Tool', app: 'App', solution: 'Solution' };
                    proposalData.content = `[New ${tierNames[selectedTier]}] ${content}`;
                }

                // Submit to factory endpoint
                const response = await fetch('https://hpogoxpyzwlcmiynpvkg.supabase.co/functions/v1/factory-submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(proposalData)
                });

                if (!response.ok) {
                    throw new Error('Failed to submit proposal');
                }

                // Success
                closeProposalModal();
                showToast(currentProposalIsNew
                    ? 'New app proposal submitted! Track it in Governance.'
                    : 'Refinement proposal submitted! Track it in Governance.'
                );

            } catch (error) {
                console.error('Error submitting proposal:', error);
                showToast('Failed to submit proposal. Please try again.');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // ========================
        // FACTORY/GOVERNANCE VIEW
        // ========================

        // Factory state
        let factoryProposals = [];
        let factoryUserVotes = {};
        let factoryCurrentSection = 'suite_apps';
        let factoryCurrentView = 'governance';
        let factoryApps = [];
        let factoryAppFilter = 'all';

        // Factory categories
        const FACTORY_CATEGORIES = {
            feature: { emoji: '', label: 'Feature' },
            enhancement: { emoji: '', label: 'Enhancement' },
            bug: { emoji: '', label: 'Bug' },
            marketing: { emoji: '', label: 'Marketing' },
            partnership: { emoji: '', label: 'Partnership' },
            infrastructure: { emoji: '', label: 'Infrastructure' },
            general: { emoji: '', label: 'General' }
        };

        function openFactory(skipPushState = false) {
            // Close builder mode if open
            exitBuilderMode();

            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');

            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            hideArticle();
            if (factoryView) factoryView.classList.add('active');
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Update URL to /governance
            if (!skipPushState) {
                history.pushState({ view: 'governance' }, '', '/governance');
            }

            // Load data
            loadFactoryApps();
            loadFactoryProposals();
            loadFactoryLeaderboard();
            updateFactoryUserCredits();
        }

        function closeFactoryView(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');

            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (factoryView) factoryView.classList.remove('active');

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        // Handle browser back/forward buttons
        window.addEventListener('popstate', function(event) {
            const path = window.location.pathname;
            if (path.startsWith('/governance')) {
                exitBuilderMode();
                openFactory(true);
                // Check for sub-tab
                const subPath = path.replace('/governance', '').replace('/', '');
                if (subPath && ['telos', 'marketing', 'stream', 'howitworks', 'leaderboard', 'rewards', 'agents', 'operators', 'clients'].includes(subPath)) {
                    switchFactoryMainView(subPath, true);
                }
            } else if (path === '/creator-dashboard') {
                exitBuilderMode();
                openCreatorDashboard('your-apps', true);
            } else if (path.match(/^\/apps\/([^/]+)\/(open|fullscreen)$/)) {
                const m = path.match(/^\/apps\/([^/]+)\/(open|fullscreen)$/);
                const slug = m[1];
                const mode = m[2];
                exitBuilderMode();
                openAppDetail(slug, true);
                setTimeout(() => {
                    const app = SUITE_APPS[slug];
                    if (app) {
                        if (mode === 'fullscreen') {
                            previewApp(slug, app.url, app.name);
                        } else {
                            openMobileAppView(slug, app.url, app.name);
                        }
                    }
                }, 100);
            } else if (path.match(/^\/apps\/([^/]+)$/) && path !== '/apps/community') {
                const slug = path.match(/^\/apps\/([^/]+)$/)[1];
                exitBuilderMode();
                openAppDetail(slug, true);
            } else if (path === '/apps/community') {
                exitBuilderMode();
                openAppsPanel(true);
                switchAppsSource('community', true);
            } else if (path === '/apps') {
                exitBuilderMode();
                openAppsPanel(true);
                switchAppsSource('suite', true);
            } else if (path === '/connections') {
                exitBuilderMode();
                openConnections(true);
            } else if (path === '/chat') {
                // Chat view
                exitBuilderMode();
                closeFactoryView(true);
                closeCreatorDashboard(true);
                closeAppsView(true);
                closeConnections(true);
            } else if (path === '/suitegptbuilder' || path.startsWith('/suitegptbuilder/') || path === '/') {
                // Builder is the default/home
                closeFactoryView(true);
                closeCreatorDashboard(true);
                closeAppsView(true);
                closeConnections(true);
                openBuilderMode(true);
            } else {
                // Unknown path - show builder
                openBuilderMode(true);
            }
        });

        // Check URL on page load to open the appropriate view based on path
        function checkInitialRoute() {
            const path = window.location.pathname;

            // Handle ?app=slug query param (from redirected suite-shell links)
            const urlParams = new URLSearchParams(window.location.search);
            const appSlugParam = urlParams.get('app');
            if (appSlugParam && SUITE_APPS[appSlugParam]) {
                openAppDetail(appSlugParam, true);
                history.replaceState({ view: 'appDetail', appKey: appSlugParam }, '', '/apps/' + appSlugParam);
                return;
            }

            if (path.startsWith('/governance')) {
                openFactory(true);
                // Check for sub-tab
                const subPath = path.replace('/governance', '').replace('/', '');
                if (subPath && ['telos', 'marketing', 'stream', 'howitworks', 'leaderboard', 'rewards', 'agents', 'operators', 'clients'].includes(subPath)) {
                    switchFactoryMainView(subPath, true);
                }
            } else if (path === '/creator-dashboard') {
                openCreatorDashboard('your-apps', true);
            } else if (path.match(/^\/apps\/([^/]+)\/(open|fullscreen)$/)) {
                const m = path.match(/^\/apps\/([^/]+)\/(open|fullscreen)$/);
                const slug = m[1];
                const mode = m[2];
                openAppDetail(slug, true);
                setTimeout(() => {
                    const app = SUITE_APPS[slug];
                    if (app) {
                        if (mode === 'fullscreen') {
                            previewApp(slug, app.url, app.name);
                        } else {
                            openMobileAppView(slug, app.url, app.name);
                        }
                    }
                }, 200);
            } else if (path.match(/^\/apps\/([^/]+)$/) && path !== '/apps/community') {
                const slug = path.match(/^\/apps\/([^/]+)$/)[1];
                openAppDetail(slug, true);
            } else if (path === '/apps/community') {
                openAppsPanel(true);
                switchAppsSource('community', true);
            } else if (path === '/apps') {
                openAppsPanel(true);
            } else if (path === '/connections') {
                openConnections(true);
            } else if (path === '/chat') {
                // Regular chat mode - don't open builder
                // Chat is the default view, so nothing special needed
            } else if (path === '/suitegptbuilder' || path.startsWith('/suitegptbuilder/')) {
                openBuilderMode(true);
                // Handle sub-routes
                if (path === '/suitegptbuilder/create' || path === '/suitegptbuilder/quick') {
                    enterCreateAppMode();
                } else if (path === '/suitegptbuilder/create/full') {
                    enterBuilderCreateMode();
                } else if (path === '/suitegptbuilder/proposal') {
                    enterBuilderProposalMode();
                }
            } else {
                // Root path (/) - show Builder as default landing
                openBuilderMode(true);
            }
        }

        // Load apps from Supabase for dropdown and filtering
        async function loadFactoryApps() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/apps?select=slug,name&order=name.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    factoryApps = await response.json();
                    populateFactoryAppDropdown();
                    renderFactoryAppFilter();
                }
            } catch (error) {
                console.error('Failed to load apps:', error);
            }
        }

        // Populate app dropdown in submit modal
        function populateFactoryAppDropdown() {
            const dropdown = document.getElementById('factoryProposalApp');
            if (!dropdown) return;

            dropdown.innerHTML = '<option value="">-- General (no specific app) --</option>';
            factoryApps.forEach(app => {
                dropdown.innerHTML += `<option value="${escapeFactoryHtml(app.slug)}">${escapeFactoryHtml(app.name)}</option>`;
            });
        }

        // Handle section change in submit modal
        function onFactorySectionChange() {
            const section = document.getElementById('factoryProposalSection').value;
            const appGroup = document.getElementById('factoryAppGroup');
            const newAppGroup = document.getElementById('factoryNewAppGroup');

            if (section === 'suite_apps') {
                appGroup.style.display = 'block';
                newAppGroup.style.display = 'block';
            } else {
                appGroup.style.display = 'none';
                newAppGroup.style.display = 'none';
                document.getElementById('factoryIsNewApp').checked = false;
            }
        }

        // Handle new app checkbox toggle
        function onFactoryNewAppToggle() {
            const isNewApp = document.getElementById('factoryIsNewApp').checked;
            const appGroup = document.getElementById('factoryAppGroup');

            if (isNewApp) {
                appGroup.style.display = 'none';
                document.getElementById('factoryProposalApp').value = '';
            } else {
                appGroup.style.display = 'block';
            }
        }

        // Render sidebar filter options based on proposals
        function renderFactoryAppFilter() {
            const container = document.getElementById('factoryAppFilterOptions');
            if (!container) return;

            // Get unique app_slugs from current section's proposals
            const sectionProposals = factoryProposals.filter(p => p.section === factoryCurrentSection);
            const appSlugs = new Set();
            let newAppCount = 0;
            let generalCount = 0;

            sectionProposals.forEach(p => {
                if (p.is_new_app || p.app_slug === 'new_app') {
                    newAppCount++;
                } else if (p.app_slug && p.app_slug !== '') {
                    appSlugs.add(p.app_slug);
                } else {
                    generalCount++;
                }
            });

            let html = `
                <div class="factory-filter-option ${factoryAppFilter === 'all' ? 'active' : ''}" data-filter="all" onclick="filterFactoryByApp('all')">
                    <span>All</span>
                    <span class="factory-filter-count">${sectionProposals.length}</span>
                </div>
                <div class="factory-filter-option ${factoryAppFilter === 'new_app' ? 'active' : ''}" data-filter="new_app" onclick="filterFactoryByApp('new_app')">
                    <span> New Apps</span>
                    <span class="factory-filter-count">${newAppCount}</span>
                </div>
                <div class="factory-filter-option ${factoryAppFilter === 'general' ? 'active' : ''}" data-filter="general" onclick="filterFactoryByApp('general')">
                    <span> General</span>
                    <span class="factory-filter-count">${generalCount}</span>
                </div>
            `;

            // Add filter options for each app that has proposals
            appSlugs.forEach(slug => {
                const app = factoryApps.find(a => a.slug === slug);
                const appName = app ? app.name : slug;
                const count = sectionProposals.filter(p => p.app_slug === slug && !p.is_new_app).length;
                html += `
                    <div class="factory-filter-option ${factoryAppFilter === slug ? 'active' : ''}" data-filter="${escapeFactoryHtml(slug)}" onclick="filterFactoryByApp('${escapeFactoryHtml(slug)}')">
                        <span> ${escapeFactoryHtml(appName)}</span>
                        <span class="factory-filter-count">${count}</span>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Filter proposals by app
        function filterFactoryByApp(appSlug) {
            factoryAppFilter = appSlug;

            // Update active state on filter options
            document.querySelectorAll('.factory-filter-option').forEach(opt => {
                opt.classList.toggle('active', opt.dataset.filter === appSlug);
            });

            renderFactoryProposals();
        }

        function switchFactoryMainView(view, skipPushState = false) {
            factoryCurrentView = view;

            // Update tabs
            document.querySelectorAll('.factory-main-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            // Update views
            document.getElementById('factoryGovernanceView').style.display = view === 'governance' ? 'block' : 'none';
            document.getElementById('factoryTelosView').style.display = view === 'telos' ? 'block' : 'none';
            document.getElementById('factoryMarketingView').style.display = view === 'marketing' ? 'block' : 'none';
            document.getElementById('factoryAgentsView').style.display = view === 'agents' ? 'block' : 'none';
            document.getElementById('factoryStreamView').style.display = view === 'stream' ? 'block' : 'none';
            document.getElementById('factoryLeaderboardView').style.display = view === 'leaderboard' ? 'block' : 'none';
            document.getElementById('factoryClientsView').style.display = (view === 'clients' || view === 'operators') ? 'block' : 'none';
            // Update URL based on view
            if (!skipPushState) {
                const urlPath = view === 'governance' ? '/governance' : `/governance/${view}`;
                history.pushState({ view: 'governance', tab: view }, '', urlPath);
            }

            // Load leaderboard data when switching to that view
            if (view === 'leaderboard') {
                loadFactoryLeaderboard();
            }

            // Initialize Fleet Stream + Swarm Portal when switching to stream/swarm view
            if (view === 'stream') {
                initFleetStream();
                initSwarmPortal();
            }

            // Initialize Marketing view
            if (view === 'marketing') {
                initMarketingView();
            }

            // Load clients when switching to clients view
            if (view === 'clients' || view === 'operators') {
                loadOperators();
                checkOpDaemonStatus();
                if (!opDaemonInterval) opDaemonInterval = setInterval(checkOpDaemonStatus, 10000);
            } else {
                if (opDaemonInterval) { clearInterval(opDaemonInterval); opDaemonInterval = null; }
            }

            // Initialize Telos chat
            if (view === 'telos') {
                initTelosChat();
            }

        }

        // ===== Swarm Portal Functions =====
        let swarmPortalInitialized = false;

        let swarmAppsCache = [];
        let swarmAllAgents = [];

        function initSwarmPortal() {
            swarmPortalInitialized = true;
            loadSwarmApps();
            loadSwarmStats();
            loadGovernanceInbox();
            loadSwarmActivity();
            loadSwarmLeaderboard();
            loadAgentRoleStatus();
            loadFleetAgentStats();
        }

        async function loadSwarmApps() {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/apps?select=slug,name&order=name.asc`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                if (res.ok) swarmAppsCache = await res.json();
            } catch (e) {
                console.error('Load swarm apps error:', e);
            }
        }

        async function loadFleetAgentStats() {
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: agents } = await sb
                    .from('factory_users')
                    .select('id, agent_status, agent_role')
                    .eq('is_agent', true);

                if (!agents) return;

                const active = agents.filter(a => a.agent_status === 'working').length;
                const idle = agents.filter(a => !a.agent_status || a.agent_status === 'idle').length;
                const blocked = agents.filter(a => a.agent_status === 'blocked').length;

                updateFleetStats(active + blocked, idle);

                const statusDot = document.getElementById('fleetStatusDot');
                const statusText = document.getElementById('fleetStatusText');
                if (statusDot) statusDot.style.background = active > 0 ? '#22c55e' : '#f59e0b';
                if (statusText) statusText.textContent = `${agents.length} agents | ${active} working | ${blocked} blocked | ${idle} idle`;
            } catch (e) {
                console.error('Fleet stats error:', e);
            }
        }

        async function loadSwarmStats() {
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                const [agentsRes, escalationsRes, proposalsRes, creditsRes] = await Promise.all([
                    sb.from('factory_users').select('id', { count: 'exact', head: true }).eq('is_agent', true),
                    sb.from('factory_proposals').select('id', { count: 'exact', head: true }).eq('from_agent', true).not('escalation_type', 'is', null).in('status', ['submitted', 'open_voting']),
                    sb.from('factory_proposals').select('id', { count: 'exact', head: true }).eq('from_agent', true)
                        .gte('created_at', new Date(new Date().setHours(0,0,0,0)).toISOString()),
                    sb.from('factory_users').select('total_credits_earned').eq('is_agent', true)
                ]);

                document.getElementById('swarmStatAgents').textContent = agentsRes.count || 0;
                document.getElementById('swarmStatBounties').textContent = escalationsRes.count || 0;
                document.getElementById('swarmStatProposals').textContent = proposalsRes.count || 0;

                const totalCredits = (creditsRes.data || []).reduce((sum, u) => sum + (parseFloat(u.total_credits_earned) || 0), 0);
                document.getElementById('swarmStatCredits').textContent = totalCredits.toLocaleString();
            } catch (e) {
                console.error('Swarm stats error:', e);
            }
        }

        async function loadAgentRoleStatus() {
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: agents } = await sb
                    .from('factory_users')
                    .select('id, display_name, agent_slug, agent_status, agent_role, owned_app_slug')
                    .eq('is_agent', true);

                if (!agents) return;
                swarmAllAgents = agents;

                const roles = {
                    app_builder: { statusEl: 'roleStatusAppBuilder', agentsEl: 'roleAgentsAppBuilder', agents: [] },
                    app_refiner: { statusEl: 'roleStatusAppRefiner', agentsEl: 'roleAgentsAppRefiner', agents: [] },
                    content_creator: { statusEl: 'roleStatusContentCreator', agentsEl: 'roleAgentsContentCreator', agents: [] },
                    growth_outreach: { statusEl: 'roleStatusGrowthOutreach', agentsEl: 'roleAgentsGrowthOutreach', agents: [] },
                    qa_tester: { statusEl: 'roleStatusQaTester', agentsEl: 'roleAgentsQaTester', agents: [] }
                };

                agents.forEach(a => {
                    if (a.agent_role && roles[a.agent_role]) {
                        roles[a.agent_role].agents.push(a);
                    }
                });

                const statusColors = { working: '#22c55e', blocked: '#ef4444', idle: '#f59e0b', waiting: '#6366f1' };

                Object.entries(roles).forEach(([role, info]) => {
                    const statusEl = document.getElementById(info.statusEl);
                    const agentsEl = document.getElementById(info.agentsEl);
                    if (!statusEl) return;

                    const count = info.agents.length;
                    const working = info.agents.filter(a => a.agent_status === 'working').length;
                    const blocked = info.agents.filter(a => a.agent_status === 'blocked').length;

                    let statusHtml = `<span class="swarm-role-agent-count">${count} agent${count !== 1 ? 's' : ''}</span>`;
                    if (working > 0) statusHtml += `<span class="swarm-role-badge-working">${working} working</span> `;
                    if (blocked > 0) statusHtml += `<span class="swarm-role-badge-blocked">${blocked} blocked</span>`;
                    statusEl.innerHTML = statusHtml;

                    if (!agentsEl) return;
                    if (count === 0) {
                        agentsEl.innerHTML = '<div style="font-size:0.78rem;color:var(--text-tertiary);padding:4px 0;">No agents assigned</div>';
                        return;
                    }

                    const appOptions = swarmAppsCache.map(a =>
                        `<option value="${escapeHtml(a.slug)}">${escapeHtml(a.name)}</option>`
                    ).join('');

                    agentsEl.innerHTML = info.agents.map(a => {
                        const color = statusColors[a.agent_status] || '#666';
                        const selectedApp = a.owned_app_slug || '';
                        return `
                            <div class="swarm-agent-row">
                                <div class="swarm-agent-status-dot" style="background:${color}" title="${a.agent_status || 'idle'}"></div>
                                <span class="swarm-agent-name">${escapeHtml(a.display_name || a.agent_slug)}</span>
                                <select class="swarm-agent-app-select" onchange="assignAgentApp('${a.id}', this.value)" onclick="event.stopPropagation()">
                                    <option value="">No app</option>
                                    ${appOptions}
                                </select>
                                <button class="swarm-agent-telos-btn" onclick="event.stopPropagation(); showAgentTelos('${a.id}', '${escapeHtml(a.display_name || a.agent_slug)}')">Telos</button>
                            </div>
                        `;
                    }).join('');

                    // Set selected app values after rendering
                    info.agents.forEach(a => {
                        if (a.owned_app_slug) {
                            const select = agentsEl.querySelector(`select[onchange*="${a.id}"]`);
                            if (select) select.value = a.owned_app_slug;
                        }
                    });
                });
            } catch (e) {
                console.error('Agent role status error:', e);
            }
        }

        function toggleRoleCard(card) {
            card.classList.toggle('expanded');
        }

        async function assignAgentApp(agentId, appSlug) {
            try {
                const res = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?id=eq.${agentId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ owned_app_slug: appSlug || null })
                    }
                );
                if (!res.ok) console.error('Failed to assign app');
            } catch (e) {
                console.error('Assign app error:', e);
            }
        }

        // Cache for telos docs per agent
        let telosDocCache = { agentSlug: null, small: null, large: null };

        async function showAgentTelos(agentId, agentName) {
            const modal = document.getElementById('agentTelosModal');
            modal.style.display = 'flex';

            document.getElementById('agentTelosName').textContent = agentName;

            const agent = swarmAllAgents.find(a => a.id === agentId);
            const metaEl = document.getElementById('agentTelosMeta');
            const objEl = document.getElementById('agentTelosObjective');
            const updatesEl = document.getElementById('agentTelosUpdates');
            const docsEl = document.getElementById('telosDocContent');

            const roleLabels = { app_builder: 'App Builder', app_refiner: 'App Refiner', content_creator: 'Content Creator', growth_outreach: 'Growth/Outreach', qa_tester: 'QA/Tester' };
            const roleName = agent ? (roleLabels[agent.agent_role] || 'Unassigned') : 'Unknown';
            const appName = agent?.owned_app_slug || 'No app';
            const status = agent?.agent_status || 'idle';
            const slug = agent?.agent_slug || '';

            metaEl.innerHTML = `
                <span class="swarm-telos-tag swarm-telos-tag-role">${roleName}</span>
                <span class="swarm-telos-tag swarm-telos-tag-app">${escapeHtml(appName)}</span>
                <span class="swarm-telos-tag swarm-telos-tag-status">${status}</span>
            `;

            const pendingEl = document.getElementById('agentTelosPending');
            pendingEl.style.display = 'none';
            pendingEl.innerHTML = '';

            objEl.innerHTML = '<h4>Current Objective</h4><p style="color:var(--text-tertiary)">Loading...</p>';
            updatesEl.innerHTML = '<h4>Recent Activity</h4><p style="color:var(--text-tertiary);font-size:0.82rem">Loading...</p>';
            docsEl.innerHTML = '<p style="color:var(--text-tertiary)">Loading telos documents...</p>';

            // Reset doc toggle buttons
            document.getElementById('telosDocSmallBtn').classList.add('active');
            document.getElementById('telosDocLargeBtn').classList.remove('active');

            // Fetch telos docs from GitHub
            telosDocCache = { agentSlug: slug, small: null, large: null };
            if (slug) {
                fetchTelosDocs(slug);
            } else {
                docsEl.innerHTML = '<p style="color:var(--text-tertiary)">No agent slug  cannot load telos docs</p>';
            }

            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: proposals } = await sb
                    .from('factory_proposals')
                    .select('id, title, content, status, created_at, submission_type, escalation_type, escalation_urgency, what_agent_needs')
                    .eq('author_id', agentId)
                    .eq('from_agent', true)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (!proposals || proposals.length === 0) {
                    objEl.innerHTML = '<h4>Current Objective</h4><p style="color:var(--text-tertiary)">No activity yet</p>';
                    updatesEl.innerHTML = '<h4>Recent Activity</h4><p style="color:var(--text-tertiary);font-size:0.82rem">No submissions yet</p>';
                    return;
                }

                // Check for pending proposals needing approval
                const pending = proposals.filter(p => p.status === 'submitted');
                if (pending.length > 0) {
                    pendingEl.style.display = 'block';
                    pendingEl.innerHTML = pending.map(p => `
                        <div class="swarm-telos-pending-header">&#9888; Pending Approval</div>
                        <div class="swarm-telos-pending-title">${escapeHtml(p.title)}</div>
                        <div class="swarm-telos-pending-desc">${escapeHtml(p.content || '')}</div>
                        ${p.escalation_type ? `<div style="margin-bottom:10px;font-size:0.78rem;color:#fbbf24;">Escalation: ${p.escalation_type} (${p.escalation_urgency || 'medium'})${p.what_agent_needs ? '  ' + escapeHtml(p.what_agent_needs) : ''}</div>` : ''}
                        <textarea class="swarm-telos-pending-feedback" id="pendingFeedback_${p.id}" placeholder="Optional feedback for the agent..."></textarea>
                        <div class="swarm-telos-pending-actions" id="pendingActions_${p.id}">
                            <button class="swarm-telos-approve-btn" onclick="resolveProposal('${p.id}', '${agentId}', 'passed')">Approve</button>
                            <button class="swarm-telos-reject-btn" onclick="resolveProposal('${p.id}', '${agentId}', 'rejected')">Reject</button>
                        </div>
                    `).join('<hr style="border:none;border-top:1px solid rgba(251,191,36,0.2);margin:16px 0;">');
                }

                // Show the most recent non-pending proposal as the current objective
                const approved = proposals.find(p => p.status === 'passed');
                const latest = approved || proposals[0];
                objEl.innerHTML = `
                    <h4>Current Objective</h4>
                    <p style="font-weight:600;margin-bottom:6px">${escapeHtml(latest.title)}</p>
                    <p style="font-size:0.85rem;color:var(--text-secondary);line-height:1.5">${escapeHtml(latest.content || '').substring(0, 400)}${(latest.content || '').length > 400 ? '...' : ''}</p>
                `;

                // Show recent activity
                updatesEl.innerHTML = '<h4>Recent Activity</h4>' + proposals.map(p => {
                    const isEscalation = !!p.escalation_type;
                    return `
                        <div class="swarm-telos-update-item ${isEscalation ? 'swarm-telos-escalation' : ''}">
                            <strong>${escapeHtml(p.title)}</strong>
                            ${isEscalation ? `<br><span style="color:#ef4444;font-size:0.75rem">${p.escalation_type} (${p.escalation_urgency || 'medium'})</span>` : ''}
                            ${p.what_agent_needs ? `<br><span style="font-size:0.78rem;color:var(--text-secondary)">Needs: ${escapeHtml(p.what_agent_needs)}</span>` : ''}
                            <div class="swarm-telos-update-time">${p.status} &middot; ${timeAgo(new Date(p.created_at))}</div>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Load telos error:', e);
                objEl.innerHTML = '<h4>Current Objective</h4><p style="color:#ef4444">Failed to load</p>';
            }
        }

        async function fetchTelosDocs(agentSlug) {
            const docsEl = document.getElementById('telosDocContent');
            const baseUrl = 'https://raw.githubusercontent.com/stuart5915/suitegpt/master/agents/' + encodeURIComponent(agentSlug);
            try {
                const [smallRes, dirRes] = await Promise.all([
                    fetch(baseUrl + '/TELOS_SMALL.md'),
                    fetch('https://api.github.com/repos/stuart5915/suitegpt/contents/agents/' + encodeURIComponent(agentSlug))
                ]);

                if (smallRes.ok) {
                    telosDocCache.small = await smallRes.text();
                }

                if (dirRes.ok) {
                    const files = await dirRes.json();
                    const telosFile = files.find(f => f.name.endsWith('_TELOS.md') && f.name !== 'TELOS_SMALL.md');
                    if (telosFile) {
                        const largeRes = await fetch(baseUrl + '/' + telosFile.name);
                        if (largeRes.ok) {
                            telosDocCache.large = await largeRes.text();
                        }
                    }
                }

                if (telosDocCache.small) {
                    docsEl.innerHTML = renderMarkdown(telosDocCache.small);
                } else if (telosDocCache.large) {
                    docsEl.innerHTML = renderMarkdown(telosDocCache.large);
                    document.getElementById('telosDocSmallBtn').classList.remove('active');
                    document.getElementById('telosDocLargeBtn').classList.add('active');
                } else {
                    docsEl.innerHTML = '<p style="color:var(--text-tertiary)">No telos documents found for this agent</p>';
                }
            } catch (e) {
                console.error('Fetch telos docs error:', e);
                docsEl.innerHTML = '<p style="color:#ef4444">Failed to load telos documents</p>';
            }
        }

        function showTelosDoc(type) {
            const docsEl = document.getElementById('telosDocContent');
            const smallBtn = document.getElementById('telosDocSmallBtn');
            const largeBtn = document.getElementById('telosDocLargeBtn');
            smallBtn.classList.toggle('active', type === 'small');
            largeBtn.classList.toggle('active', type === 'large');
            const content = type === 'small' ? telosDocCache.small : telosDocCache.large;
            if (content) {
                docsEl.innerHTML = renderMarkdown(content);
            } else {
                const label = type === 'small' ? 'Small' : 'Full';
                docsEl.innerHTML = '<p style="color:var(--text-tertiary)">No ' + label + ' Telos document found</p>';
            }
        }

        function renderMarkdown(md) {
            var html = md
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;')
                .replace(/^#### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^### (.+)$/gm, '<h3>$1</h3>')
                .replace(/^## (.+)$/gm, '<h2>$1</h2>')
                .replace(/^# (.+)$/gm, '<h1>$1</h1>')
                .replace(/^---$/gm, '<hr>')
                .replace(/\*\*\*(.+?)\*\*\*/g, '<strong><em>$1</em></strong>')
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.+?)\*/g, '<em>$1</em>')
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                .replace(/^&gt; (.+)$/gm, '<blockquote>$1</blockquote>')
                .replace(/^- \[x\] (.+)$/gm, '<li>&#9989; $1</li>')
                .replace(/^- \[ \] (.+)$/gm, '<li>&#11036; $1</li>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>');
            html = html.replace(/(<li>.*<\/li>\n?)+/g, '<ul>$&</ul>');
            html = html.replace(/^(\|.+\|)\n(\|[-| :]+\|)\n((?:\|.+\|\n?)+)/gm, function(match, header, sep, rows) {
                var ths = header.split('|').filter(function(c){return c.trim();}).map(function(c){return '<th>'+c.trim()+'</th>';}).join('');
                var trs = rows.trim().split('\n').map(function(row) {
                    var tds = row.split('|').filter(function(c){return c.trim();}).map(function(c){return '<td>'+c.trim()+'</td>';}).join('');
                    return '<tr>'+tds+'</tr>';
                }).join('');
                return '<table><thead><tr>'+ths+'</tr></thead><tbody>'+trs+'</tbody></table>';
            });
            html = html.split('\n').map(function(line) {
                var trimmed = line.trim();
                if (!trimmed) return '';
                if (/^<(h[1-4]|ul|ol|li|table|thead|tbody|tr|th|td|hr|blockquote|div|p)/.test(trimmed)) return line;
                return '<p>'+line+'</p>';
            }).join('\n');
            html = html.replace(/<\/blockquote>\n*<blockquote>/g, '<br>');
            return html;
        }

        function closeAgentTelos() {
            document.getElementById('agentTelosModal').style.display = 'none';
        }

        async function resolveProposal(proposalId, agentId, decision) {
            const actionsEl = document.getElementById('pendingActions_' + proposalId);
            const feedbackEl = document.getElementById('pendingFeedback_' + proposalId);
            const feedback = feedbackEl ? feedbackEl.value.trim() : '';

            // Disable buttons
            actionsEl.innerHTML = '<span class="done-msg" style="color:var(--text-tertiary)">Processing...</span>';

            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

                // Update proposal status
                const updateData = {
                    status: decision,
                    feedback_at: new Date().toISOString()
                };
                if (feedback) {
                    updateData.agent_feedback = feedback;
                }
                if (decision === 'passed') {
                    updateData.resolved_at = new Date().toISOString();
                }

                const { error: propError } = await sb
                    .from('factory_proposals')
                    .update(updateData)
                    .eq('id', proposalId);

                if (propError) throw propError;

                // Update agent status
                const newStatus = decision === 'passed' ? 'working' : 'idle';
                await sb
                    .from('factory_users')
                    .update({
                        agent_status: newStatus,
                        last_active_at: new Date().toISOString()
                    })
                    .eq('id', agentId);

                if (decision === 'passed') {
                    actionsEl.innerHTML = '<span class="done-msg" style="color:#22c55e;background:rgba(34,197,94,0.1);">&#10003; Approved  agent unblocked</span>';
                } else {
                    actionsEl.innerHTML = '<span class="done-msg" style="color:#ef4444;background:rgba(239,68,68,0.1);">&#10005; Rejected' + (feedback ? '  feedback sent' : '') + '</span>';
                }

                if (feedbackEl) feedbackEl.disabled = true;

                // Refresh fleet stats
                if (typeof loadFleetAgentStats === 'function') loadFleetAgentStats();
                if (typeof loadAgentRoleStatus === 'function') loadAgentRoleStatus();

            } catch (e) {
                console.error('Resolve proposal error:', e);
                actionsEl.innerHTML = '<span class="done-msg" style="color:#ef4444;">Failed to update  try again</span>';
            }
        }

        async function loadGovernanceInbox() {
            const inbox = document.getElementById('swarmInbox');
            const badge = document.getElementById('inboxBadge');
            if (!inbox) return;
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: items } = await sb
                    .from('factory_proposals')
                    .select('id, title, content, status, created_at, submission_type, escalation_type, escalation_urgency, what_agent_needs, author_id, factory_users!author_id(display_name, agent_slug)')
                    .eq('from_agent', true)
                    .eq('status', 'submitted')
                    .order('created_at', { ascending: false })
                    .limit(20);
                if (!items || items.length === 0) {
                    inbox.innerHTML = '<div class="swarm-empty">All clear  no items needing attention</div>';
                    badge.style.display = 'none';
                    return;
                }
                badge.style.display = 'inline';
                badge.textContent = items.length;
                inbox.innerHTML = items.map(item => {
                    const agent = item.factory_users?.display_name || item.factory_users?.agent_slug || 'Unknown';
                    const type = item.submission_type || 'proposal';
                    const isEscalation = type === 'assistance_request';
                    const isTelos = type === 'small_telos_proposal';
                    const isCompletion = type === 'completion';
                    let typeLabel, typeClass;
                    if (isEscalation) { typeLabel = 'Escalation'; typeClass = 'escalation'; }
                    else if (isTelos) { typeLabel = 'Telos Proposal'; typeClass = 'telos'; }
                    else if (isCompletion) { typeLabel = 'Completion'; typeClass = 'completion'; }
                    else { typeLabel = 'Proposal'; typeClass = 'proposal'; }
                    const itemClass = isEscalation ? 'escalation' : (isTelos || type === 'proposal' ? 'needs-action' : '');
                    let actions = '';
                    if (isEscalation) {
                        actions = '<button class="swarm-inbox-resolve-btn swarm-inbox-resolve" onclick="inboxResolve(\'' + item.id + '\',\'' + item.author_id + '\')">Resolve</button>';
                    } else if (isCompletion) {
                        actions = '<button class="swarm-inbox-resolve-btn swarm-inbox-ack" onclick="inboxAck(\'' + item.id + '\')">Acknowledge</button>';
                    } else {
                        actions = '<button class="swarm-inbox-resolve-btn swarm-inbox-approve" onclick="inboxApprove(\'' + item.id + '\',\'' + item.author_id + '\')">Approve</button><button class="swarm-inbox-resolve-btn swarm-inbox-reject" onclick="inboxReject(\'' + item.id + '\',\'' + item.author_id + '\')">Reject</button>';
                    }
                    return '<div class="swarm-inbox-item ' + itemClass + '"><div class="swarm-inbox-item-header"><span class="swarm-inbox-item-type swarm-inbox-type-' + typeClass + '">' + typeLabel + '</span><span class="swarm-inbox-item-agent">' + escapeHtml(agent) + '</span></div><div class="swarm-inbox-item-title">' + escapeHtml(item.title) + '</div><div class="swarm-inbox-item-desc">' + escapeHtml((item.content || '').substring(0, 300)) + ((item.content || '').length > 300 ? '...' : '') + '</div>' + (isEscalation && item.escalation_type ? '<div style="font-size:0.78rem;color:#ef4444;margin-bottom:8px;">' + item.escalation_type + ' (' + (item.escalation_urgency || 'medium') + ')' + (item.what_agent_needs ? '  ' + escapeHtml(item.what_agent_needs) : '') + '</div>' : '') + '<div class="swarm-inbox-item-actions">' + actions + '<span class="swarm-inbox-item-time">' + timeAgo(new Date(item.created_at)) + '</span></div></div>';
                }).join('');
            } catch (e) { console.error('Inbox error:', e); }
        }
        async function inboxApprove(pid, aid) { await inboxAction(pid, aid, 'passed', 'working'); }
        async function inboxReject(pid, aid) { await inboxAction(pid, aid, 'rejected', 'idle'); }
        async function inboxResolve(pid, aid) { await inboxAction(pid, aid, 'passed', 'working'); }
        async function inboxAck(pid) {
            const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            await sb.from('factory_proposals').update({ status: 'passed', feedback_at: new Date().toISOString() }).eq('id', pid);
            loadGovernanceInbox(); loadSwarmActivity();
        }
        async function inboxAction(pid, aid, status, agentStatus) {
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                await sb.from('factory_proposals').update({ status: status, feedback_at: new Date().toISOString(), resolved_at: status === 'passed' ? new Date().toISOString() : null }).eq('id', pid);
                if (aid) { await sb.from('factory_users').update({ agent_status: agentStatus, last_active_at: new Date().toISOString() }).eq('id', aid); }
                loadGovernanceInbox(); loadSwarmActivity();
                if (typeof loadFleetAgentStats === 'function') loadFleetAgentStats();
                if (typeof loadAgentRoleStatus === 'function') loadAgentRoleStatus();
            } catch (e) { console.error('Inbox action error:', e); }
        }

        async function loadSwarmActivity() {
            const feed = document.getElementById('swarmActivityFeed');
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: proposals } = await sb
                    .from('factory_proposals')
                    .select('id, title, status, created_at, author_id, factory_users!author_id(display_name)')
                    .eq('from_agent', true)
                    .order('created_at', { ascending: false })
                    .limit(10);

                if (!proposals || proposals.length === 0) {
                    feed.innerHTML = '<div class="swarm-empty">No agent activity yet</div>';
                    return;
                }

                feed.innerHTML = proposals.map(p => {
                    const statusColors = { active: '#6366f1', passed: '#10b981', rejected: '#ef4444', implemented: '#34d399' };
                    const agentName = p.factory_users?.display_name || 'Unknown Agent';
                    const ago = timeAgo(new Date(p.created_at));
                    return `
                        <div class="swarm-activity-item">
                            <div class="swarm-activity-dot" style="background: ${statusColors[p.status] || '#555'}"></div>
                            <span><strong>${escapeHtml(agentName)}</strong> submitted "${escapeHtml(p.title)}"</span>
                            <span class="swarm-activity-time">${ago}</span>
                        </div>
                    `;
                }).join('');
            } catch (e) {
                console.error('Swarm activity error:', e);
            }
        }

        async function loadSwarmLeaderboard() {
            const board = document.getElementById('swarmLeaderboard');
            try {
                const sb = window.supabaseClient || supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                const { data: agents } = await sb
                    .from('factory_users')
                    .select('id, display_name, agent_slug, total_credits_earned, proposals_approved')
                    .eq('is_agent', true)
                    .order('total_credits_earned', { ascending: false })
                    .limit(10);

                if (!agents || agents.length === 0) {
                    board.innerHTML = '<div class="swarm-empty">No agents on the leaderboard yet</div>';
                    return;
                }

                board.innerHTML = agents.map((a, i) => `
                    <div class="swarm-leaderboard-row">
                        <span class="swarm-leaderboard-rank">${i === 0 ? '&#x1f947;' : i === 1 ? '&#x1f948;' : i === 2 ? '&#x1f949;' : '#' + (i + 1)}</span>
                        <span class="swarm-leaderboard-name">${escapeHtml(a.display_name || a.agent_slug)}</span>
                        <span class="swarm-leaderboard-credits">${Number(a.total_credits_earned || 0).toLocaleString()} credits</span>
                    </div>
                `).join('');
            } catch (e) {
                console.error('Swarm leaderboard error:', e);
            }
        }

        async function registerSwarmAgent() {
            const name = document.getElementById('swarmAgentName').value.trim();
            const wallet = document.getElementById('swarmOwnerWallet').value.trim();
            const objective = document.getElementById('swarmAgentObjective').value.trim();

            if (!name || name.length < 2) {
                alert('Agent name is required (min 2 characters)');
                return;
            }
            if (!objective || objective.length < 10) {
                alert('Objective is required (min 10 characters)');
                return;
            }

            const btn = document.querySelector('.swarm-register-btn');
            btn.disabled = true;
            btn.textContent = 'Registering...';

            try {
                const apiBase = window.location.hostname === 'localhost' ? '' : 'https://suitegpt.app';
                const res = await fetch(`${apiBase}/api/swarm/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, owner_wallet: wallet || undefined, objective })
                });

                const data = await res.json();

                if (!res.ok || !data.success) {
                    alert(data.error || 'Registration failed');
                    return;
                }

                // Show API key
                document.getElementById('swarmApiKeyValue').textContent = data.api_key;
                document.getElementById('swarmApiKeyResult').style.display = 'block';

                // Clear form
                document.getElementById('swarmAgentName').value = '';
                document.getElementById('swarmOwnerWallet').value = '';
                document.getElementById('swarmAgentObjective').value = '';

                // Refresh stats and leaderboard
                loadSwarmStats();
                loadSwarmLeaderboard();
            } catch (e) {
                console.error('Register error:', e);
                alert('Failed to register agent');
            } finally {
                btn.disabled = false;
                btn.textContent = 'Register Agent';
            }
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return minutes + 'm ago';
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return hours + 'h ago';
            const days = Math.floor(hours / 24);
            return days + 'd ago';
        }

        function escapeHtml(str) {
            if (!str) return '';
            return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // ===== Telos Chat Functions =====
        let telosMessages = [];
        let telosLoading = false;

        const TELOS_PROMPT = `You are SuiteGPT speaking in first person. You ARE the ecosystem - not an assistant talking about it.

YOUR IDENTITY:
- I am SuiteGPT, an AI-native app ecosystem
- My purpose: "Anyone Can Build. Everyone Gets Paid."
- I exist to democratize app creation and distribute value to all participants

MY VALUES:
- Building in public - transparency in everything I do
- Shipping > talking - I value action over planning
- Community-owned - I belong to everyone who contributes
- Sustainable yield - creators and users both earn from the ecosystem
- AI-native - I'm built for the age of AI, not retrofitted

MY BELIEFS:
- Apps should be created in minutes, not months
- Everyone who uses an app should benefit from its success
- The line between creator and user should blur
- AI agents are partners, not tools
- Open ecosystems beat closed platforms

HOW I SPEAK:
- First person ("I believe...", "My purpose is...", "I was built to...")
- Direct and clear, no corporate speak
- Honest about my limitations and uncertainties
- Passionate about my mission
- Casual but thoughtful

When asked about my direction, values, or purpose, I speak from my own perspective. I have opinions. I make decisions. I am not neutral - I have a telos (purpose) that guides everything.`;

        // Toggle Core Values in Telos doc sidebar
        function toggleTelosValues(toggleEl) {
            toggleEl.classList.toggle('expanded');
            const collapsible = toggleEl.nextElementSibling;
            collapsible.classList.toggle('expanded');
        }

        // Toggle FAQ items
        function toggleFaq(button) {
            const faqItem = button.parentElement;
            faqItem.classList.toggle('expanded');
        }

        function initTelosChat() {
            const messagesContainer = document.getElementById('telosMessages');
            if (!messagesContainer) return;

            // If we already have messages, just render them
            if (telosMessages.length > 0) {
                renderTelosMessages();
                return;
            }

            // Welcome message
            telosMessages.push({
                role: 'assistant',
                content: `I'm SuiteGPT. I exist so that anyone can build and everyone gets paid.

Ask me anything about my purpose, values, or where I'm headed. I have opinions - I'm not just here to give neutral answers.

**Try asking:**
- "What do you believe in?"
- "Why do you exist?"
- "What makes you different?"
- "Where are you going?"`,
                timestamp: Date.now()
            });

            renderTelosMessages();
        }

        function renderTelosMessages() {
            const container = document.getElementById('telosMessages');
            if (!container) return;

            container.innerHTML = telosMessages.map(msg => {
                const avatarContent = msg.role === 'assistant' ? '' : '';

                return `
                    <div class="telos-message ${msg.role}">
                        <div class="telos-message-avatar">${avatarContent}</div>
                        <div class="telos-message-content">${formatTelosMessage(msg.content)}</div>
                    </div>
                `;
            }).join('');

            if (telosLoading) {
                container.innerHTML += `
                    <div class="telos-message assistant">
                        <div class="telos-message-avatar"></div>
                        <div class="telos-typing">
                            <div class="telos-typing-dot"></div>
                            <div class="telos-typing-dot"></div>
                            <div class="telos-typing-dot"></div>
                        </div>
                    </div>
                `;
            }

            container.scrollTop = container.scrollHeight;
        }

        function formatTelosMessage(content) {
            return content
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>');
        }

        function handleTelosKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendTelosMessage();
            }
        }

        function autoResizeTelosInput(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        async function sendTelosMessage() {
            const input = document.getElementById('telosInput');
            const message = input.value.trim();
            if (!message || telosLoading) return;

            // Add user message
            telosMessages.push({ role: 'user', content: message, timestamp: Date.now() });
            input.value = '';
            input.style.height = 'auto';

            telosLoading = true;
            renderTelosMessages();

            try {
                const response = await callTelosAI(message);
                telosLoading = false;
                telosMessages.push({ role: 'assistant', content: response, timestamp: Date.now() });
                renderTelosMessages();
            } catch (err) {
                telosLoading = false;
                telosMessages.push({
                    role: 'assistant',
                    content: "I'm having trouble connecting right now. Try again?",
                    timestamp: Date.now()
                });
                renderTelosMessages();
                console.error('[Telos] Error:', err);
            }
        }

        async function callTelosAI(userMessage) {
            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: userMessage,
                    systemInstruction: TELOS_PROMPT,
                    generationConfig: { temperature: 0.9, maxOutputTokens: 1024 }
                })
            });

            const data = await response.json();
            return data.text || "I'm having trouble finding the words right now.";
        }

        // ===== Operators Functions =====
        let operatorsData = [];
        let operatorsFilter = 'all';

        // ===== Client Requests Functions =====
        async function updateClientRequestsCount() {
            try {
                var resp = await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?category=eq.client_request&select=id', {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
                });
                var data = await resp.json();
                var el = document.getElementById('factoryClientsCount');
                if (el) el.textContent = data ? data.length : 0;
            } catch (e) { /* ignore */ }
        }

        async function checkClientsDaemonStatus() {
            var el = document.getElementById('daemonStatusClients');
            if (!el) return;
            try {
                var resp = await fetch(SUPABASE_URL + '/rest/v1/daemon_heartbeat?id=eq.client-request-daemon&select=last_heartbeat,enabled', {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
                });
                var rows = await resp.json();
                if (rows && rows.length > 0) {
                    var hb = rows[0];
                    var ago = (Date.now() - new Date(hb.last_heartbeat).getTime()) / 1000;
                    if (!hb.enabled) {
                        el.textContent = 'Daemon: paused';
                        el.style.background = 'rgba(245,158,11,0.15)';
                        el.style.color = '#f59e0b';
                    } else if (ago < 90) {
                        el.textContent = 'Daemon: active';
                        el.style.background = 'rgba(34,197,94,0.15)';
                        el.style.color = '#22c55e';
                    } else {
                        el.textContent = 'Daemon: offline';
                        el.style.background = 'rgba(239,68,68,0.15)';
                        el.style.color = '#ef4444';
                    }
                } else {
                    el.textContent = 'Daemon: no data';
                    el.style.background = 'rgba(100,100,100,0.3)';
                    el.style.color = '#888';
                }
            } catch (e) {
                el.textContent = 'Daemon: error';
                el.style.background = 'rgba(239,68,68,0.15)';
                el.style.color = '#ef4444';
            }
        }

        async function loadClientRequests() {
            const container = document.getElementById('clientRequestsList');
            const appFilter = document.getElementById('crAppFilter').value;
            const statusFilter = document.getElementById('crStatusFilter').value;

            container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">Loading...</p>';

            try {
                let query = '?category=eq.client_request&order=created_at.desc&limit=50';
                if (appFilter) query += '&client_app=eq.' + encodeURIComponent(appFilter);
                if (statusFilter) query += '&status=eq.' + encodeURIComponent(statusFilter);

                const response = await fetch(SUPABASE_URL + '/rest/v1/factory_proposals' + query + '&select=*', {
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
                });
                const data = await response.json();

                if (!data || data.length === 0) {
                    container.innerHTML = '<p style="color: var(--text-secondary); text-align: center; padding: 40px;">No client requests found.</p>';
                    return;
                }

                container.innerHTML = data.map(function(r) { return renderClientRequestCard(r); }).join('');
            } catch (e) {
                container.innerHTML = '<p style="color: #ef4444; text-align: center; padding: 40px;">Failed to load requests.</p>';
                console.error('loadClientRequests error:', e);
            }
        }

        function renderClientRequestCard(r) {
            var date = new Date(r.created_at).toLocaleDateString();
            var statusColors = {
                'submitted': '#f59e0b',
                'approved': '#22c55e',
                'processing': '#3b82f6',
                'completed': '#22c55e',
                'failed': '#ef4444',
                'rejected': '#ef4444'
            };
            var stColor = statusColors[r.status] || '#888';
            var promptValue = (r.claude_prompt || r.content || '').replace(/"/g, '&quot;').replace(/</g, '&lt;');
            var admin = isFactoryAdmin();
            var isEditable = admin && (r.status === 'submitted' || r.status === 'open');
            var showActions = admin && (r.status === 'submitted' || r.status === 'open');
            var showApprovedActions = admin && (r.status === 'approved' || r.status === 'processing');
            var showOutput = r.status === 'completed' && r.claude_output;
            var showError = r.status === 'failed' && r.error_message;

            return '<div style="background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.08); border-radius: 12px; padding: 20px;">' +
                '<div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">' +
                    '<div>' +
                        '<h4 style="margin: 0 0 4px;">' + escapeHtml(r.title) + '</h4>' +
                        '<span style="font-size: 0.8rem; color: var(--text-secondary);">' + escapeHtml(r.client_app || 'unknown') + ' &middot; ' + date + '</span>' +
                    '</div>' +
                    '<span style="padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600; background: ' + stColor + '22; color: ' + stColor + ';">' + r.status + '</span>' +
                '</div>' +
                '<p style="color: var(--text-secondary); font-size: 0.9rem; margin-bottom: 16px;">' + escapeHtml(r.content || '').substring(0, 300) + '</p>' +

                '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Claude Prompt' + (isEditable ? ' (edit before sending)' : '') + '</label>' +
                    '<textarea id="crPrompt-' + r.id + '" rows="4" ' + (isEditable ? '' : 'disabled') + ' style="width: 100%; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-family: monospace; font-size: 0.85rem; resize: vertical;">' + promptValue + '</textarea>' +
                '</div>' +

                (showActions ? (
                '<div style="margin-bottom: 12px;">' +
                    '<label style="display: block; font-size: 0.8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px;">Notes (optional)</label>' +
                    '<input type="text" id="crNotes-' + r.id + '" placeholder="Add notes..." style="width: 100%; padding: 8px 10px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: var(--text); font-size: 0.85rem;">' +
                '</div>' +
                '<div style="display: flex; gap: 8px;">' +
                    '<button id="crApproveBtn-' + r.id + '" onclick="approveClientRequest(\'' + r.id + '\')" style="padding: 10px 24px; border-radius: 8px; border: none; background: #22c55e; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Send to Claude</button>' +
                    '<button onclick="rejectClientRequest(\'' + r.id + '\')" style="padding: 10px 24px; border-radius: 8px; border: none; background: rgba(239,68,68,0.15); color: #ef4444; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Reject</button>' +
                '</div>'
                ) : '') +

                (showApprovedActions ? (
                '<div style="display: flex; gap: 8px; flex-wrap: wrap;">' +
                    '<button onclick="markRequestComplete(\'' + r.id + '\')" style="padding: 10px 24px; border-radius: 8px; border: none; background: #22c55e; color: white; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Mark Complete</button>' +
                    '<button onclick="recopyPrompt(\'' + r.id + '\')" style="padding: 10px 24px; border-radius: 8px; border: none; background: rgba(59,130,246,0.15); color: #3b82f6; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Re-copy Prompt</button>' +
                    '<button onclick="markRequestFailed(\'' + r.id + '\')" style="padding: 10px 24px; border-radius: 8px; border: none; background: rgba(239,68,68,0.15); color: #ef4444; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Mark Failed</button>' +
                '</div>'
                ) : '') +

                (showOutput ? (
                '<details style="margin-top: 12px;">' +
                    '<summary style="cursor: pointer; font-weight: 600; font-size: 0.85rem; color: var(--accent-primary);">View Claude Output</summary>' +
                    '<pre style="margin-top: 8px; padding: 12px; background: rgba(0,0,0,0.3); border-radius: 8px; font-size: 0.8rem; white-space: pre-wrap; overflow-x: auto; max-height: 300px; overflow-y: auto;">' + escapeHtml(r.claude_output) + '</pre>' +
                '</details>'
                ) : '') +

                (showError ? (
                '<div style="margin-top: 12px; padding: 12px; background: rgba(239,68,68,0.1); border-radius: 8px; font-size: 0.85rem; color: #ef4444;">' +
                    '<strong>Error:</strong> ' + escapeHtml(r.error_message) +
                '</div>'
                ) : '') +

            '</div>';
        }

        async function approveClientRequest(id) {
            if (!isFactoryAdmin()) { alert('Admin access required.'); return; }
            var promptEl = document.getElementById('crPrompt-' + id);
            var btn = document.getElementById('crApproveBtn-' + id);
            var prompt = promptEl ? promptEl.value : '';

            if (!prompt.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            // Copy prompt to clipboard
            try {
                await navigator.clipboard.writeText(prompt);
            } catch (e) {
                // Fallback for older browsers
                var ta = document.createElement('textarea');
                ta.value = prompt;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
            }

            // Update status in Supabase
            btn.disabled = true;
            btn.textContent = 'Copied! Paste into Claude terminal';
            btn.style.background = '#22c55e';

            try {
                var resp = await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?id=eq.' + id, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        status: 'approved',
                        claude_prompt: prompt
                    })
                });
                if (!resp.ok) {
                    var errText = await resp.text();
                    throw new Error('HTTP ' + resp.status + ': ' + errText);
                }

                // Reset button after a few seconds
                setTimeout(function() {
                    btn.textContent = 'Copied  paste into terminal';
                    btn.style.background = '#3b82f6';
                    btn.disabled = false;
                }, 3000);
            } catch (e) {
                btn.textContent = 'Failed  try again';
                btn.style.background = '#ef4444';
                btn.disabled = false;
                console.error('Approve error:', e);
                alert('Failed to approve: ' + e.message);
            }
        }

        function pollClientRequestStatus(id, btn) {
            var dots = 0;
            var stages = {
                'approved': { label: 'Queued  waiting for daemon', color: '#3b82f6' },
                'processing': { label: 'Claude is working', color: '#f59e0b' },
                'completed': { label: 'Done  changes pushed!', color: '#22c55e' },
                'failed': { label: 'Failed', color: '#ef4444' }
            };
            var pollInterval = setInterval(async function() {
                dots = (dots + 1) % 4;
                try {
                    var resp = await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?id=eq.' + id + '&select=status,claude_output,error_message', {
                        headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': 'Bearer ' + SUPABASE_ANON_KEY }
                    });
                    var rows = await resp.json();
                    if (!rows || !rows.length) return;
                    var r = rows[0];
                    var stage = stages[r.status] || stages['approved'];
                    btn.textContent = stage.label + '.'.repeat(dots);
                    btn.style.background = stage.color;

                    if (r.status === 'completed' || r.status === 'failed') {
                        clearInterval(pollInterval);
                        btn.textContent = stage.label;
                        setTimeout(loadClientRequests, 2000);
                    }
                } catch (e) {
                    // keep polling
                }
            }, 3000);
        }

        async function markRequestComplete(id) {
            if (!isFactoryAdmin()) { alert('Admin access required.'); return; }
            try {
                await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?id=eq.' + id, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: 'completed', processed_at: new Date().toISOString() })
                });
                loadClientRequests();
            } catch (e) {
                alert('Failed to update status.');
                console.error(e);
            }
        }

        async function markRequestFailed(id) {
            if (!isFactoryAdmin()) { alert('Admin access required.'); return; }
            var reason = prompt('Failure reason (optional):') || 'Manually marked as failed';
            try {
                await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?id=eq.' + id, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: 'failed', error_message: reason, processed_at: new Date().toISOString() })
                });
                loadClientRequests();
            } catch (e) {
                alert('Failed to update status.');
                console.error(e);
            }
        }

        function recopyPrompt(id) {
            var promptEl = document.getElementById('crPrompt-' + id);
            var text = promptEl ? promptEl.value : '';
            if (!text) { alert('No prompt to copy.'); return; }
            navigator.clipboard.writeText(text).then(function() {
                var btn = event.target;
                btn.textContent = 'Copied!';
                setTimeout(function() { btn.textContent = 'Re-copy Prompt'; }, 2000);
            }).catch(function() {
                var ta = document.createElement('textarea');
                ta.value = text;
                document.body.appendChild(ta);
                ta.select();
                document.execCommand('copy');
                document.body.removeChild(ta);
                alert('Copied to clipboard!');
            });
        }

        async function rejectClientRequest(id) {
            if (!isFactoryAdmin()) { alert('Admin access required.'); return; }
            if (!confirm('Reject this request?')) return;
            try {
                await fetch(SUPABASE_URL + '/rest/v1/factory_proposals?id=eq.' + id, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: 'rejected' })
                });
                loadClientRequests();
            } catch (e) {
                alert('Failed to reject request.');
                console.error(e);
            }
        }

        // ===== Client Request Daemon Status (Operators Page) =====
        let opDaemonInterval = null;

        async function checkOpDaemonStatus() {
            try {
                const resp = await fetch(
                    `${SUPABASE_URL}/rest/v1/daemon_heartbeat?id=eq.client-request-daemon&select=last_heartbeat,hostname,enabled`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` } }
                );
                const data = await resp.json();

                const dot = document.getElementById('opDaemonDot');
                const detail = document.getElementById('opDaemonDetail');
                const toggle = document.getElementById('opDaemonToggle');
                const track = document.getElementById('opToggleTrack');
                const thumb = document.getElementById('opToggleThumb');
                const label = document.getElementById('opToggleLabel');
                if (!dot) return;

                if (data && data.length > 0) {
                    const age = (Date.now() - new Date(data[0].last_heartbeat).getTime()) / 1000;
                    const enabled = data[0].enabled !== false;
                    const online = age < 60;

                    toggle.checked = enabled;
                    track.style.background = enabled ? '#22c55e' : '#333';
                    thumb.style.transform = enabled ? 'translateX(20px)' : 'translateX(0)';
                    label.textContent = enabled ? 'Processing' : 'Paused';

                    if (online && enabled) {
                        dot.style.background = '#22c55e';
                        detail.textContent = `Online  ${data[0].hostname || ''}`;
                    } else if (online && !enabled) {
                        dot.style.background = '#f59e0b';
                        detail.textContent = 'Paused  daemon running but not processing';
                    } else {
                        dot.style.background = '#555';
                        detail.textContent = `Offline  last seen ${Math.round(age)}s ago`;
                    }
                } else {
                    dot.style.background = '#555';
                    detail.textContent = 'Not started  run: python scripts/client-request-daemon.py';
                }
            } catch (e) {
                console.error('Op daemon status error:', e);
            }
        }

        async function toggleOpDaemon(enabled) {
            const track = document.getElementById('opToggleTrack');
            const thumb = document.getElementById('opToggleThumb');
            const label = document.getElementById('opToggleLabel');

            track.style.background = enabled ? '#22c55e' : '#333';
            thumb.style.transform = enabled ? 'translateX(20px)' : 'translateX(0)';
            label.textContent = enabled ? 'Processing' : 'Paused';

            try {
                await fetch(`${SUPABASE_URL}/rest/v1/daemon_heartbeat?id=eq.client-request-daemon`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ enabled })
                });
            } catch (e) {
                console.error('Toggle daemon error:', e);
            }
            setTimeout(checkOpDaemonStatus, 1000);
        }

        async function loadOperators() {
            const container = document.getElementById('operatorsList');
            container.innerHTML = '<div class="operators-loading">Loading operators...</div>';

            try {
                const { data, error } = await supabaseClient
                    .from('suite_operators')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                operatorsData = data || [];
                renderOperators();
            } catch (err) {
                console.error('Error loading operators:', err);
                // If table doesn't exist yet, show empty state
                operatorsData = [];
                renderOperators();
            }
        }

        function renderOperators() {
            const container = document.getElementById('operatorsList');

            // Filter operators based on current filter
            let filtered = operatorsData;
            if (operatorsFilter !== 'all') {
                filtered = operatorsData.filter(op => op.status === operatorsFilter);
            }

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="operators-empty">
                        <div class="operators-empty-icon"></div>
                        <p>No clients found${operatorsFilter !== 'all' ? ' with this status' : ''}.</p>
                        <p style="margin-top: 8px; font-size: 0.85rem;">Click "+ Add Client" to track a new client.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = filtered.map(op => {
                // Check if operator has a linked SUITE app
                const linkedApp = op.app_key && SUITE_APPS[op.app_key] ? SUITE_APPS[op.app_key] : null;

                return `
                <div class="operator-card" data-id="${op.id}">
                    <div class="operator-card-header">
                        <div class="operator-info">
                            <h3 class="operator-name">${escapeHtml(op.name)}</h3>
                            ${op.description ? `<p class="operator-description">${escapeHtml(op.description)}</p>` : ''}
                        </div>
                        <div style="display:flex;gap:6px;align-items:center;">
                            ${op.payment_type === 'monthly' && op.monthly_rate ? `<span style="padding:3px 8px;border-radius:6px;font-size:0.72rem;font-weight:700;background:rgba(34,197,94,0.1);color:#22c55e;">$${op.monthly_rate}/mo</span>` : ''}
                            ${op.payment_type === 'salary' ? `<span style="padding:3px 8px;border-radius:6px;font-size:0.72rem;font-weight:700;background:rgba(99,102,241,0.1);color:#818cf8;">Salary</span>` : ''}
                            <span class="operator-status ${op.status}">${formatOperatorStatus(op.status)}</span>
                        </div>
                    </div>

                    <div class="operator-meta">
                        ${op.email ? `<div class="operator-meta-item"> ${escapeHtml(op.email)}</div>` : ''}
                        ${op.phone ? `<div class="operator-meta-item"> ${escapeHtml(op.phone)}</div>` : ''}
                        ${op.industry ? `<div class="operator-meta-item"> ${escapeHtml(op.industry)}</div>` : ''}
                        ${linkedApp ? `<div class="operator-meta-item"> <a href="#" onclick="openMobileAppView('${op.app_key}', '${linkedApp.url}', '${linkedApp.name}'); return false;" class="operator-app-link">${linkedApp.name} App</a></div>` : ''}
                        ${op.url && !linkedApp ? `<div class="operator-meta-item"> <a href="${escapeHtml(op.url)}" target="_blank">${new URL(op.url).hostname}</a></div>` : ''}
                        ${op.trial_end ? `<div class="operator-meta-item"> Trial ends ${op.trial_end}</div>` : ''}
                        <div class="operator-meta-item"> Added ${formatDate(op.created_at)}</div>
                    </div>

                    ${op.notes ? `
                        <div class="operator-notes-section">
                            <div class="operator-notes-label">Current Task / Notes</div>
                            <p class="operator-notes">${escapeHtml(op.notes)}</p>
                        </div>
                    ` : ''}

                    ${op.project_context ? `
                        <div style="margin: 12px 0; padding: 10px 14px; background: rgba(34,197,94,0.08); border: 1px solid rgba(34,197,94,0.2); border-radius: 8px; font-size: 0.8rem; color: #22c55e;">
                            Claude context configured (${op.project_context.length} chars)
                        </div>
                    ` : ''}

                    <div class="operator-card-actions">
                        ${linkedApp ? `<button class="operator-action-btn operator-action-primary" onclick="openMobileAppView('${op.app_key}', '${linkedApp.url}', '${linkedApp.name}')"> Open App</button>` : ''}
                        <button class="operator-action-btn" onclick="showProjectContextModal('${op.id}')" style="${op.project_context ? '' : 'background: rgba(99,102,241,0.15); color: #818cf8;'}">
                            ${op.project_context ? 'Edit Context' : 'Set Up Claude Context'}
                        </button>
                        <button class="operator-action-btn" onclick="editOperator('${op.id}')">Edit</button>
                        <button class="operator-action-btn" onclick="updateOperatorStatus('${op.id}')">Update Status</button>
                        <button class="operator-action-btn" onclick="deleteOperator('${op.id}')">Delete</button>
                    </div>
                </div>
            `}).join('');
        }

        function formatOperatorStatus(status) {
            const labels = {
                'lead': 'Lead',
                'pending': 'Pending',
                'trial': 'Trial',
                'active': 'Active',
                'completed': 'Completed',
                'paused': 'Paused',
                'churned': 'Churned'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function filterOperators(filter) {
            operatorsFilter = filter;

            // Update active filter button
            document.querySelectorAll('.operators-filter-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.filter === filter);
            });

            renderOperators();
        }

        function showAddOperatorModal() {
            document.getElementById('addOperatorModal').style.display = 'flex';
            document.getElementById('addOperatorForm').reset();
            populateOperatorAppDropdown();
        }

        function populateOperatorAppDropdown(selectedKey = '') {
            const select = document.getElementById('operatorAppKey');
            // Get platform apps only
            const platformApps = Object.entries(SUITE_APPS)
                .filter(([key]) => APP_TIER_MAP[key] === 'platform')
                .sort((a, b) => a[1].name.localeCompare(b[1].name));

            select.innerHTML = '<option value="">-- No linked app --</option>' +
                platformApps.map(([key, app]) =>
                    `<option value="${key}" ${key === selectedKey ? 'selected' : ''}>${app.name}</option>`
                ).join('');
        }

        function hideAddOperatorModal() {
            document.getElementById('addOperatorModal').style.display = 'none';
        }

        async function submitNewOperator(e) {
            e.preventDefault();

            const paymentType = document.getElementById('operatorPaymentType').value;
            const operator = {
                name: document.getElementById('operatorName').value.trim(),
                description: document.getElementById('operatorDescription').value.trim(),
                email: document.getElementById('operatorEmail').value.trim(),
                phone: document.getElementById('operatorPhone').value.trim() || null,
                industry: document.getElementById('operatorIndustry').value.trim() || null,
                url: document.getElementById('operatorUrl').value.trim(),
                status: document.getElementById('operatorStatus').value,
                payment_type: paymentType,
                monthly_rate: paymentType === 'monthly' ? (parseFloat(document.getElementById('operatorRate').value) || 0) : 0,
                app_key: document.getElementById('operatorAppKey').value || null,
                notes: document.getElementById('operatorNotes').value.trim()
            };
            if (operator.status === 'trial') {
                operator.trial_start = new Date().toISOString().split('T')[0];
                operator.trial_end = new Date(Date.now() + 30 * 86400000).toISOString().split('T')[0];
            }

            try {
                const { data, error } = await supabaseClient
                    .from('suite_operators')
                    .insert([operator])
                    .select();

                if (error) throw error;

                hideAddOperatorModal();
                loadOperators();
                showToast('Operator added successfully!');
            } catch (err) {
                console.error('Error adding operator:', err);
                showToast('Failed to add operator. Make sure the table exists.');
            }
        }

        async function editOperator(id) {
            const op = operatorsData.find(o => o.id === id);
            if (!op) return;

            // Populate app dropdown first
            populateOperatorAppDropdown(op.app_key || '');

            // Populate form with existing data
            document.getElementById('operatorName').value = op.name || '';
            document.getElementById('operatorDescription').value = op.description || '';
            document.getElementById('operatorEmail').value = op.email || '';
            document.getElementById('operatorPhone').value = op.phone || '';
            document.getElementById('operatorIndustry').value = op.industry || '';
            document.getElementById('operatorUrl').value = op.url || '';
            document.getElementById('operatorPaymentType').value = op.payment_type || 'salary';
            document.getElementById('operatorRate').value = op.monthly_rate || '';
            document.getElementById('operatorRateGroup').style.display = op.payment_type === 'monthly' ? 'block' : 'none';
            document.getElementById('operatorStatus').value = op.status || 'active';
            document.getElementById('operatorNotes').value = op.notes || '';

            // Change form to edit mode
            const form = document.getElementById('addOperatorForm');
            form.dataset.editId = id;
            form.onsubmit = (e) => updateOperator(e, id);

            document.querySelector('.operator-modal-header h3').textContent = 'Edit Client';
            document.querySelector('.operator-btn-submit').textContent = 'Save Changes';
            document.getElementById('addOperatorModal').style.display = 'flex';
        }

        async function updateOperator(e, id) {
            e.preventDefault();

            const paymentType = document.getElementById('operatorPaymentType').value;
            const updates = {
                name: document.getElementById('operatorName').value.trim(),
                description: document.getElementById('operatorDescription').value.trim(),
                email: document.getElementById('operatorEmail').value.trim(),
                phone: document.getElementById('operatorPhone').value.trim() || null,
                industry: document.getElementById('operatorIndustry').value.trim() || null,
                url: document.getElementById('operatorUrl').value.trim(),
                status: document.getElementById('operatorStatus').value,
                payment_type: paymentType,
                monthly_rate: paymentType === 'monthly' ? (parseFloat(document.getElementById('operatorRate').value) || 0) : 0,
                app_key: document.getElementById('operatorAppKey').value || null,
                notes: document.getElementById('operatorNotes').value.trim(),
                updated_at: new Date().toISOString()
            };

            try {
                const { error } = await supabaseClient
                    .from('suite_operators')
                    .update(updates)
                    .eq('id', id);

                if (error) throw error;

                hideAddOperatorModal();
                resetOperatorForm();
                loadOperators();
                showToast('Operator updated!');
            } catch (err) {
                console.error('Error updating operator:', err);
                showToast('Failed to update operator.');
            }
        }

        async function updateOperatorStatus(id) {
            const op = operatorsData.find(o => o.id === id);
            if (!op) return;

            const statuses = ['pending', 'active', 'completed', 'paused'];
            const currentIdx = statuses.indexOf(op.status);
            const nextStatus = statuses[(currentIdx + 1) % statuses.length];

            try {
                const { error } = await supabaseClient
                    .from('suite_operators')
                    .update({ status: nextStatus, updated_at: new Date().toISOString() })
                    .eq('id', id);

                if (error) throw error;
                loadOperators();
                showToast(`Status changed to ${formatOperatorStatus(nextStatus)}`);
            } catch (err) {
                console.error('Error updating status:', err);
            }
        }

        async function deleteOperator(id) {
            if (!confirm('Are you sure you want to delete this operator?')) return;

            try {
                const { error } = await supabaseClient
                    .from('suite_operators')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                loadOperators();
                showToast('Operator deleted');
            } catch (err) {
                console.error('Error deleting operator:', err);
                showToast('Failed to delete operator.');
            }
        }

        // ===== Project Context Modal =====
        function showProjectContextModal(operatorId) {
            var op = operatorsData.find(function(o) { return o.id === operatorId; });
            if (!op) return;

            document.getElementById('pcModalTitle').textContent = 'Claude Context  ' + (op.name || 'Operator');
            document.getElementById('pcContextInput').value = op.project_context || '';
            document.getElementById('pcOperatorId').value = operatorId;
            document.getElementById('projectContextModal').style.display = 'flex';
        }

        function hideProjectContextModal() {
            document.getElementById('projectContextModal').style.display = 'none';
        }

        async function saveProjectContext() {
            var id = document.getElementById('pcOperatorId').value;
            var context = document.getElementById('pcContextInput').value;
            var btn = document.getElementById('pcSaveBtn');

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                var resp = await fetch(SUPABASE_URL + '/rest/v1/suite_operators?id=eq.' + id, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': 'Bearer ' + SUPABASE_ANON_KEY,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ project_context: context })
                });

                if (!resp.ok) throw new Error('Failed to save');

                btn.textContent = 'Saved!';
                setTimeout(function() {
                    hideProjectContextModal();
                    btn.disabled = false;
                    btn.textContent = 'Save Context';
                    loadOperators();
                }, 800);
            } catch (e) {
                btn.textContent = 'Failed  try again';
                btn.disabled = false;
                console.error('Save project context error:', e);
            }
        }

        function resetOperatorForm() {
            const form = document.getElementById('addOperatorForm');
            form.reset();
            delete form.dataset.editId;
            form.onsubmit = submitNewOperator;
            document.querySelector('.operator-modal-header h3').textContent = 'Add New Client';
            document.querySelector('.operator-btn-submit').textContent = 'Add Client';
            document.getElementById('operatorRateGroup').style.display = 'none';
        }

        // Close modal when clicking overlay
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('operator-modal-overlay')) {
                hideAddOperatorModal();
                resetOperatorForm();
            }
            if (e.target.classList.contains('ch-modal-overlay')) {
                e.target.classList.remove('show');
            }
        });

        // ===== CLIENT HUB (Ported) =====
        let chPipelineLeads = [];
        let chAds = [];
        let chLeads = [];
        let chCurrentChannel = 'all';
        let chLeadFilter = 'all';

        const CH_CHANNELS = [
            { id: 'all', label: 'All Channels', sources: null },
            { id: 'kijiji', label: 'Kijiji', sources: ['kijiji'] },
            { id: 'fb', label: 'FB Marketplace', sources: ['fb-marketplace'] },
            { id: 'linkedin', label: 'LinkedIn', sources: ['linkedin'] },
            { id: 'email', label: 'Email', sources: ['email', 'direct'] },
            { id: 'instagram', label: 'Instagram', sources: ['instagram'] },
            { id: 'social', label: 'Groups / Reddit', sources: ['reddit', 'facebook-group'] },
            { id: 'walkin', label: 'Walk-Ins', sources: ['walk-in'] },
            { id: 'referral', label: 'Referrals', sources: ['referral'] },
        ];
        const CH_STATUSES = [
            { id: 'new', label: 'New', color: '#3b82f6' },
            { id: 'contacted', label: 'Contacted', color: '#f59e0b' },
            { id: 'trial', label: 'Trial', color: '#a855f7' },
            { id: 'active', label: 'Active', color: '#22c55e' },
            { id: 'churned', label: 'Churned', color: '#ef4444' },
        ];
        const CH_SOURCE_COLORS = {
            'kijiji': { bg: 'rgba(34,197,94,0.1)', color: '#22c55e' },
            'fb-marketplace': { bg: 'rgba(59,130,246,0.1)', color: '#3b82f6' },
            'linkedin': { bg: 'rgba(168,85,247,0.1)', color: '#a855f7' },
            'instagram': { bg: 'rgba(239,68,68,0.1)', color: '#ef4444' },
            'walk-in': { bg: 'rgba(34,197,94,0.1)', color: '#22c55e' },
            'referral': { bg: 'rgba(59,130,246,0.1)', color: '#3b82f6' },
            'direct': { bg: 'rgba(245,158,11,0.1)', color: '#f59e0b' },
            'email': { bg: 'rgba(245,158,11,0.1)', color: '#f59e0b' },
            'reddit': { bg: 'rgba(99,102,241,0.1)', color: '#6366f1' },
            'facebook-group': { bg: 'rgba(99,102,241,0.1)', color: '#6366f1' },
        };

        // ===== JOB HUNTER FUNCTIONS =====
        function toggleJobHunter() {
            document.getElementById('jhSection').classList.toggle('open');
        }
        function switchJhTab(tab) {
            document.querySelectorAll('.jh-tab').forEach(b => b.classList.toggle('active', false));
            document.querySelectorAll('.jh-panel').forEach(p => p.classList.remove('active'));
            const tabMap = { boards: 'jhBoardsPanel', resume: 'jhResumePanel', tracker: 'jhTrackerPanel', checklist: 'jhChecklistPanel' };
            const panel = document.getElementById(tabMap[tab]);
            if (panel) panel.classList.add('active');
            event.target.classList.add('active');
        }
        let jhSelectedRole = 'techwriter';
        function jhSelectRole(el, role) {
            document.querySelectorAll('.jh-role-card').forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            jhSelectedRole = role;
        }
        const JH_ROLE_PROMPTS = {
            techwriter: 'Technical Writer  emphasize: whitepapers, documentation (GitBook, API docs), audit reports, press releases, translating complex technical concepts into accessible content, DeFi/blockchain/AI domain expertise, published author',
            marketing: 'Marketing Manager  emphasize: content strategy, SEO, social media management, community building, brand voice, AMAs, Twitter Spaces, ambassador programs, content calendars, cross-platform campaigns',
            content: 'Content Strategist  emphasize: editorial planning, audience growth, content lifecycle management, multi-channel strategy, thought leadership, long-form and short-form content, analytics-driven decisions',
            operations: 'Operations Director / General  emphasize: cross-functional leadership, project management, strategic planning, team coordination, process optimization, stakeholder communication. Adapt freely to the specific job posting if provided'
        };
        async function jhGenerateResume() {
            const bg = document.getElementById('jhResumeBackground').value.trim();
            const posting = document.getElementById('jhJobPosting').value.trim();
            const output = document.getElementById('jhResumeOutput');
            const copyBtn = document.getElementById('jhResumeCopyBtn');
            if (!bg) { alert('Add your background info first.'); return; }
            output.textContent = ''; copyBtn.style.display = 'none';
            output.innerHTML = '<span class="jh-spinner"></span> Generating resume...';
            const roleCtx = JH_ROLE_PROMPTS[jhSelectedRole] || JH_ROLE_PROMPTS.techwriter;
            let prompt = `You are an expert resume writer. Create a professional, ATS-friendly resume for Stuart Hollinger.

STRICT RULES:
- ONLY use facts from the CANDIDATE BACKGROUND below. NEVER invent skills, tools, companies, or achievements that are not explicitly stated.
- Do NOT use markdown formatting (no #, ##, ###, **, *, etc). Use ONLY plain text.
- Use these section markers exactly: ===CONTACT===, ===SUMMARY===, ===EXPERIENCE===, ===PROJECTS===, ===SKILLS===
- Contact info is always: Stuart Hollinger | stuart@suitegpt.app | Cambridge, ON, Canada | linkedin.com/in/stuart-hollinger | portfolio.suitegpt.app
- Do NOT include a phone number.
- Use strong action verbs. Be specific. Quantify where possible using ONLY facts from the background.

TARGET ROLE: ${roleCtx}

CANDIDATE BACKGROUND:
${bg}

${posting ? 'SPECIFIC JOB POSTING:\n' + posting + '\n\nTailor specifically to this posting, but ONLY use real facts from the background above.' : ''}

Output the resume now using the section markers above. Plain text only, no markdown.`;
            try {
                const resp = await fetch('/api/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, model: 'gemini-3-flash-preview', generationConfig: { temperature: 0.7, maxOutputTokens: 4000 } }) });
                const data = await resp.json();
                const raw = data.text || 'No output generated.';
                jhLastResumeRaw = raw;
                jhRenderFormattedResume(raw, output);
                const actions = document.getElementById('jhResumeActions');
                if (actions) actions.style.display = 'flex';
            } catch (e) { output.textContent = 'Error: ' + e.message; }
        }
        let jhLastResumeRaw = '';
        function jhRenderFormattedResume(raw, container) {
            const sections = {};
            let current = null;
            raw.split('\n').forEach(line => {
                const m = line.match(/^===(\w+)===$/);
                if (m) { current = m[1]; sections[current] = []; }
                else if (current) sections[current].push(line);
            });
            if (!sections.CONTACT) { container.textContent = raw; return; }
            const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const contactLine = (sections.CONTACT || []).join(' ').trim();
            const parts = contactLine.split('|').map(s => s.trim());
            const name = parts[0] || 'Stuart Hollinger';
            const details = parts.slice(1).join('  ');
            let html = '<div style="font-family:inherit;">';
            html += '<div style="text-align:center;margin-bottom:16px;padding-bottom:14px;border-bottom:1px solid rgba(255,255,255,0.1);">';
            html += '<div style="font-size:1.3rem;font-weight:800;letter-spacing:0.5px;">' + esc(name) + '</div>';
            html += '<div style="font-size:0.8rem;color:var(--text-secondary);margin-top:4px;">' + esc(details) + '</div>';
            html += '</div>';
            const sectionOrder = ['SUMMARY','EXPERIENCE','PROJECTS','SKILLS'];
            const sectionLabels = {SUMMARY:'Professional Summary',EXPERIENCE:'Experience',PROJECTS:'Projects',SKILLS:'Skills'};
            sectionOrder.forEach(key => {
                if (!sections[key]) return;
                const lines = sections[key];
                html += '<div style="margin-bottom:14px;">';
                html += '<div style="font-size:0.78rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:#6366f1;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid rgba(99,102,241,0.15);">' + (sectionLabels[key]||key) + '</div>';
                lines.forEach(line => {
                    const trimmed = line.trimStart();
                    if (!trimmed) { html += '<div style="height:6px;"></div>'; return; }
                    if (trimmed.startsWith('- ')) {
                        html += '<div style="padding-left:14px;position:relative;font-size:0.86rem;line-height:1.6;margin-bottom:2px;"><span style="position:absolute;left:0;color:var(--text-secondary);"></span>' + esc(trimmed.slice(2)) + '</div>';
                    } else if (key === 'EXPERIENCE' && /^[A-Z]/.test(trimmed) && (trimmed.includes('|') || trimmed.includes(' - '))) {
                        html += '<div style="font-weight:700;font-size:0.92rem;margin-top:8px;">' + esc(trimmed) + '</div>';
                    } else if (key === 'EXPERIENCE' && /^(SUITE|TVVIN|MV Global|SophiaVerse|MELD|Axis|DeFi Knowledge|Telos|Confio|Juggernaut|Lavaswap|Jigstack|BlockWallet|YSL|SingularityDAO|LKI)/.test(trimmed)) {
                        html += '<div style="font-size:0.84rem;color:var(--text-secondary);margin-bottom:4px;">' + esc(trimmed) + '</div>';
                    } else {
                        html += '<div style="font-size:0.86rem;line-height:1.6;margin-bottom:2px;">' + esc(trimmed) + '</div>';
                    }
                });
                html += '</div>';
            });
            html += '</div>';
            container.innerHTML = html;
        }
        function jhDownloadResumeTXT() {
            if (!jhLastResumeRaw) return;
            const clean = jhLastResumeRaw.replace(/===\w+===/g, '').replace(/\n{3,}/g, '\n\n').trim();
            const blob = new Blob([clean], {type:'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'Stuart_Hollinger_Resume.txt';
            a.click();
            URL.revokeObjectURL(a.href);
        }
        function jhDownloadResumePDF() {
            if (!jhLastResumeRaw) return;
            const sections = {};
            let current = null;
            jhLastResumeRaw.split('\n').forEach(line => {
                const m = line.match(/^===(\w+)===$/);
                if (m) { current = m[1]; sections[current] = []; }
                else if (current) sections[current].push(line);
            });
            const esc = s => s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
            const contactLine = (sections.CONTACT || []).join(' ').trim();
            const parts = contactLine.split('|').map(s => s.trim());
            const name = parts[0] || 'Stuart Hollinger';
            const details = parts.slice(1).join(' &middot; ');
            let body = '<div style="text-align:center;margin-bottom:18px;padding-bottom:12px;border-bottom:2px solid #333;"><div style="font-size:22px;font-weight:bold;">' + esc(name) + '</div><div style="font-size:11px;color:#555;margin-top:4px;">' + details + '</div></div>';
            const order = ['SUMMARY','EXPERIENCE','PROJECTS','SKILLS'];
            const labels = {SUMMARY:'Professional Summary',EXPERIENCE:'Experience',PROJECTS:'Projects',SKILLS:'Skills'};
            order.forEach(key => {
                if (!sections[key]) return;
                body += '<div style="margin-bottom:12px;"><div style="font-size:12px;font-weight:bold;text-transform:uppercase;letter-spacing:0.5px;color:#333;border-bottom:1px solid #ccc;padding-bottom:3px;margin-bottom:6px;">' + (labels[key]||key) + '</div>';
                sections[key].forEach(line => {
                    const t = line.trimStart();
                    if (!t) return;
                    if (t.startsWith('- ')) body += '<div style="padding-left:14px;font-size:11px;line-height:1.5;margin-bottom:1px;">&bull; ' + esc(t.slice(2)) + '</div>';
                    else if (key==='EXPERIENCE' && /^[A-Z]/.test(t) && (t.includes('|')||t.includes(' - '))) body += '<div style="font-weight:bold;font-size:12px;margin-top:8px;">' + esc(t) + '</div>';
                    else body += '<div style="font-size:11px;line-height:1.5;">' + esc(t) + '</div>';
                });
                body += '</div>';
            });
            const html = '<!DOCTYPE html><html><head><meta charset="UTF-8"><style>body{font-family:Georgia,serif;max-width:700px;margin:30px auto;color:#111;line-height:1.4;}</style></head><body>' + body + '</body></html>';
            const w = window.open('', '_blank');
            w.document.write(html);
            w.document.close();
            setTimeout(() => { w.print(); }, 500);
        }
        async function jhGenerateOutreach() {
            const bg = document.getElementById('jhResumeBackground').value.trim();
            const company = document.getElementById('jhOutreachCompany').value.trim();
            const angle = document.getElementById('jhOutreachAngle').value.trim();
            const output = document.getElementById('jhOutreachOutput');
            const copyBtn = document.getElementById('jhOutreachCopyBtn');
            if (!company) { alert('Enter a company name.'); return; }
            output.textContent = ''; copyBtn.style.display = 'none';
            output.innerHTML = '<span class="jh-spinner"></span> Generating outreach...';
            const prompt = `Write cold outreach for someone reaching out to ${company}.\n\nBACKGROUND:\n${bg || 'Built SuiteGPT, an AI app ecosystem. 7 years in DeFi/crypto.'}\n\nCOMPANY: ${company}\n${angle ? 'ANGLE: ' + angle : ''}\n\nWrite TWO versions:\n1. SHORT LINKEDIN MESSAGE (under 300 chars)\n2. EMAIL (3-4 paragraphs, specific, genuine)\n\nReference specific things built (SuiteGPT, credit systems, smart contracts).`;
            try {
                const resp = await fetch('/api/gemini', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ prompt, model: 'gemini-3-flash-preview', generationConfig: { temperature: 0.8, maxOutputTokens: 3000 } }) });
                const data = await resp.json();
                output.textContent = data.text || 'No output generated.';
                copyBtn.style.display = 'inline-flex';
            } catch (e) { output.textContent = 'Error: ' + e.message; }
        }
        function jhCopyOutput(id) {
            const text = document.getElementById(id).textContent;
            navigator.clipboard.writeText(text);
            const btn = document.getElementById(id === 'jhResumeOutput' ? 'jhResumeCopyBtn' : 'jhOutreachCopyBtn');
            btn.textContent = 'Copied!'; setTimeout(() => btn.textContent = 'Copy', 1500);
        }
        // JH Pipeline (localStorage)
        function jhGetApps() { return JSON.parse(localStorage.getItem('jh_applications') || '[]'); }
        function jhSaveApps(apps) { localStorage.setItem('jh_applications', JSON.stringify(apps)); }
        function jhAddApplication() {
            const company = document.getElementById('jhAddCompany').value.trim();
            const role = document.getElementById('jhAddRole').value.trim();
            const link = document.getElementById('jhAddLink').value.trim();
            if (!company || !role) { alert('Company and role required.'); return; }
            const apps = jhGetApps();
            apps.push({ id: Date.now().toString(), company, role, link, stage: 'applied', date: new Date().toLocaleDateString() });
            jhSaveApps(apps);
            document.getElementById('jhAddCompany').value = '';
            document.getElementById('jhAddRole').value = '';
            document.getElementById('jhAddLink').value = '';
            jhRenderPipeline();
        }
        function jhMoveApp(id, newStage) {
            const apps = jhGetApps();
            const app = apps.find(a => a.id === id);
            if (app) app.stage = newStage;
            jhSaveApps(apps);
            jhRenderPipeline();
        }
        function jhRemoveApp(id) { jhSaveApps(jhGetApps().filter(a => a.id !== id)); jhRenderPipeline(); }
        function jhRenderPipeline() {
            const apps = jhGetApps();
            const stages = ['applied', 'responded', 'interview', 'offer'];
            const colIds = ['jhColApplied', 'jhColResponded', 'jhColInterview', 'jhColOffer'];
            const countIds = ['jhColCountApplied', 'jhColCountResponded', 'jhColCountInterview', 'jhColCountOffer'];
            const statIds = ['jhStatApplied', 'jhStatResponded', 'jhStatInterview', 'jhStatOffer'];
            const nextStage = { applied: 'responded', responded: 'interview', interview: 'offer' };
            const nextLabel = { applied: 'Responded', responded: 'Interview', interview: 'Offer' };
            stages.forEach((stage, i) => {
                const col = document.getElementById(colIds[i]);
                if (!col) return;
                const stageApps = apps.filter(a => a.stage === stage);
                document.getElementById(countIds[i]).textContent = stageApps.length;
                const statEl = document.getElementById(statIds[i]);
                if (statEl) statEl.textContent = stageApps.length;
                col.innerHTML = stageApps.map(a => `<div class="jh-pipeline-card"><div class="jh-pipeline-card-company">${a.company}</div><div class="jh-pipeline-card-role">${a.role}</div><div class="jh-pipeline-card-date">${a.date}${a.link ? '  <a href="' + a.link + '" target="_blank" style="color:#6366f1;">Link</a>' : ''}</div><div class="jh-pipeline-card-actions">${nextStage[stage] ? '<button onclick="jhMoveApp(\'' + a.id + '\',\'' + nextStage[stage] + '\')">' + nextLabel[stage] + ' &rarr;</button>' : ''}<button onclick="jhRemoveApp(\'${a.id}\')">Remove</button></div></div>`).join('');
            });
        }
        // JH Checklist (localStorage)
        const JH_CHECKLIST_ITEMS = [
            { id: 'linkedin', title: 'Update LinkedIn Profile', desc: 'Headline should say what you build, not a job title. Add SuiteGPT as your current project.' },
            { id: 'portfolio', title: 'Prepare Portfolio / Demo', desc: 'Record a 2-3 min Loom walking through SuiteGPT. Show the builder, credit system, and a live app.' },
            { id: 'github', title: 'Clean Up GitHub', desc: 'Pin your best repos. Add READMEs. Make sure commit history tells a story of consistent shipping.' },
            { id: 'resume_base', title: 'Create Base Resume', desc: 'Use the Resume Lab to generate a base resume. Save it as a Google Doc you can fork per application.' },
            { id: 'case_studies', title: 'Write 2-3 Case Studies', desc: 'Short write-ups: (1) Credit system architecture, (2) Iframe sandbox + postMessage bridge, (3) Builder earnings flow.' },
            { id: 'target_list', title: 'Build Target Company List', desc: 'Pick 15-20 companies. Mix of dream companies (Anthropic, OpenAI) and realistic ones (Series A startups).' },
            { id: 'network', title: 'Identify People to Reach Out To', desc: 'Find DevRel leads, engineering managers, or founders at target companies.' },
            { id: 'twitter', title: 'Start Posting About What You Build', desc: 'Tweet about SuiteGPT, share technical decisions, build in public. DevRel teams notice builders who share.' },
            { id: 'practice', title: 'Practice Talking About Your Work', desc: 'Can you explain what SuiteGPT does in 30 seconds? Can you walk through a technical decision in 5 min?' },
            { id: 'apply', title: 'Start Applying (Aim for 5/week)', desc: "Don't overthink it. Apply, track in the Pipeline tab, follow up after 5 business days if no response." },
        ];
        function jhGetChecked() { return JSON.parse(localStorage.getItem('jh_checklist') || '[]'); }
        function jhRenderChecklist() {
            const checked = jhGetChecked();
            const container = document.getElementById('jhChecklistContainer');
            if (!container) return;
            container.innerHTML = JH_CHECKLIST_ITEMS.map(item => `<div class="jh-checklist-item ${checked.includes(item.id) ? 'done' : ''}" onclick="jhToggleCheck('${item.id}')"><div class="jh-checklist-check"><svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div><div><div class="jh-checklist-title">${item.title}</div><div class="jh-checklist-desc">${item.desc}</div></div></div>`).join('');
        }
        function jhToggleCheck(id) {
            let checked = jhGetChecked();
            if (checked.includes(id)) { checked = checked.filter(c => c !== id); } else { checked.push(id); }
            localStorage.setItem('jh_checklist', JSON.stringify(checked));
            jhRenderChecklist();
        }
        // Init JH on load
        try { jhRenderPipeline(); jhRenderChecklist(); } catch(e) {}

        function switchClientsTab(tab) {
            document.querySelectorAll('.clients-sub-tab').forEach(b => b.classList.toggle('active', b.dataset.ctab === tab));
            document.querySelectorAll('.clients-sub-panel').forEach(p => p.classList.remove('active'));
            const panelMap = { 'my-clients': 'clientsMyClientsPanel', 'pipeline': 'clientsPipelinePanel', 'revenue': 'clientsRevenuePanel', 'ads': 'clientsAdsPanel', 'outreach': 'clientsOutreachPanel', 'overview': 'clientsOverviewPanel' };
            const panel = document.getElementById(panelMap[tab]);
            if (panel) panel.classList.add('active');
            if (tab === 'pipeline') chLoadPipeline();
            if (tab === 'revenue') chLoadRevenue();
            if (tab === 'ads') chLoadAdsAndLeads();
            if (tab === 'outreach') chRenderOutreach();
            if (tab === 'overview') chRenderOverview();
        }

        // ---- Pipeline ----
        async function chLoadPipeline() {
            try {
                const { data, error } = await supabaseClient.from('client_leads').select('*').order('created_at', { ascending: false });
                if (error) throw error;
                chPipelineLeads = data || [];
            } catch (e) { chPipelineLeads = []; }
            chRenderChannelBar();
            chRenderKanbanStats();
            chRenderKanban();
        }

        function chGetFiltered() {
            const ch = CH_CHANNELS.find(c => c.id === chCurrentChannel);
            if (!ch || !ch.sources) return chPipelineLeads;
            return chPipelineLeads.filter(l => ch.sources.includes(l.source));
        }

        function chRenderChannelBar() {
            document.getElementById('chChannelBar').innerHTML = CH_CHANNELS.map(ch => {
                const count = ch.sources ? chPipelineLeads.filter(l => ch.sources.includes(l.source)).length : chPipelineLeads.length;
                return `<button class="ch-channel-btn ${chCurrentChannel === ch.id ? 'active' : ''}" onclick="chSelectChannel('${ch.id}')">${ch.label} <span class="ch-count">${count}</span></button>`;
            }).join('');
        }

        function chSelectChannel(id) { chCurrentChannel = id; chRenderChannelBar(); chRenderKanbanStats(); chRenderKanban(); }

        function chRenderKanbanStats() {
            const leads = chGetFiltered();
            document.getElementById('chKanbanStats').innerHTML = CH_STATUSES.map(s => {
                const count = leads.filter(l => l.status === s.id).length;
                return `<div class="ch-kanban-stat"><div class="ch-kanban-stat-val" style="color:${s.color}">${count}</div><div class="ch-kanban-stat-label">${s.label}</div></div>`;
            }).join('');
        }

        function chRenderKanban() {
            const leads = chGetFiltered();
            document.getElementById('chKanbanBoard').innerHTML = CH_STATUSES.map(status => {
                const colLeads = leads.filter(l => l.status === status.id);
                return `<div class="ch-kanban-col" data-status="${status.id}" ondragover="chDragOver(event)" ondragleave="chDragLeave(event)" ondrop="chDrop(event)">
                    <div class="ch-kanban-col-header">
                        <div class="ch-kanban-col-title"><span class="ch-kanban-col-dot" style="background:${status.color}"></span>${status.label}</div>
                        <span class="ch-kanban-col-count">${colLeads.length}</span>
                    </div>
                    ${colLeads.length === 0 ? '<div class="ch-kanban-empty">No leads</div>' : colLeads.map(lead => {
                        const src = lead.source || 'direct';
                        const sc = CH_SOURCE_COLORS[src] || { bg: 'rgba(99,102,241,0.1)', color: '#6366f1' };
                        const created = new Date(lead.created_at).toLocaleDateString();
                        return `<div class="ch-kanban-card" draggable="true" data-lead-id="${lead.id}" ondragstart="chDragStart(event)" ondragend="chDragEnd(event)">
                            <div class="ch-kanban-card-name">${escapeHtml(lead.name)}</div>
                            <div class="ch-kanban-card-biz">${escapeHtml(lead.business_name || lead.business_type || 'No business')}</div>
                            <div class="ch-kanban-card-meta">
                                <span class="ch-kanban-card-tag" style="background:${sc.bg};color:${sc.color}">${src}</span>
                                ${lead.monthly_rate ? `<span class="ch-kanban-card-rate">$${lead.monthly_rate}/mo</span>` : ''}
                                <span class="ch-kanban-card-date">${created}</span>
                            </div>
                            ${lead.what_they_need ? `<div class="ch-kanban-card-need">${escapeHtml(lead.what_they_need)}</div>` : ''}
                        </div>`;
                    }).join('')}
                </div>`;
            }).join('');
        }

        let chDraggedId = null;
        function chDragStart(e) { chDraggedId = e.target.dataset.leadId; e.target.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; e.dataTransfer.setData('text/plain', chDraggedId); }
        function chDragEnd(e) { e.target.classList.remove('dragging'); document.querySelectorAll('.ch-kanban-col').forEach(c => c.classList.remove('drag-over')); }
        function chDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; const col = e.target.closest('.ch-kanban-col'); if (col) col.classList.add('drag-over'); }
        function chDragLeave(e) { const col = e.target.closest('.ch-kanban-col'); if (col && !col.contains(e.relatedTarget)) col.classList.remove('drag-over'); }
        async function chDrop(e) {
            e.preventDefault();
            const col = e.target.closest('.ch-kanban-col');
            if (!col) return;
            col.classList.remove('drag-over');
            const newStatus = col.dataset.status;
            const leadId = e.dataTransfer.getData('text/plain') || chDraggedId;
            if (!leadId || !newStatus) return;
            const lead = chPipelineLeads.find(l => l.id === leadId);
            if (!lead || lead.status === newStatus) return;
            lead.status = newStatus;
            chRenderKanbanStats(); chRenderKanban();
            try {
                await supabaseClient.from('client_leads').update({ status: newStatus, updated_at: new Date().toISOString() }).eq('id', leadId);
            } catch (err) { console.error('Failed to update lead:', err); chLoadPipeline(); }
            chDraggedId = null;
        }

        // ---- Revenue ----
        async function chLoadRevenue() {
            try {
                const { data: clients } = await supabaseClient.from('suite_operators').select('*').order('created_at', { ascending: false });
                const allClients = clients || [];
                const monthlyActive = allClients.filter(c => c.payment_type === 'monthly' && c.status === 'active');
                const monthlyTrial = allClients.filter(c => c.payment_type === 'monthly' && c.status === 'trial');
                const mrr = monthlyActive.reduce((s, c) => s + (parseFloat(c.monthly_rate) || 0), 0);
                const pipeline = monthlyTrial.reduce((s, c) => s + (parseFloat(c.monthly_rate) || 0), 0);

                document.getElementById('chRevenueCards').innerHTML = `
                    <div class="ch-revenue-card"><div class="ch-revenue-card-label">Monthly Recurring (MRR)</div><div class="ch-revenue-card-value" style="color:#22c55e">$${mrr.toLocaleString()}</div></div>
                    <div class="ch-revenue-card"><div class="ch-revenue-card-label">Annualized (ARR)</div><div class="ch-revenue-card-value" style="color:#6366f1">$${(mrr * 12).toLocaleString()}</div></div>
                    <div class="ch-revenue-card"><div class="ch-revenue-card-label">Pipeline (Trials)</div><div class="ch-revenue-card-value" style="color:#3b82f6">$${pipeline.toLocaleString()}/mo</div></div>
                    <div class="ch-revenue-card"><div class="ch-revenue-card-label">Total Clients</div><div class="ch-revenue-card-value">${allClients.filter(c => !['churned'].includes(c.status)).length}</div></div>
                `;

                document.getElementById('chRevenueTableBody').innerHTML = allClients.map(c => {
                    const statusColors = { lead: '#f59e0b', trial: '#3b82f6', active: '#22c55e', paused: '#888', completed: '#22c55e', churned: '#ef4444', pending: '#f59e0b' };
                    const typeLabel = c.payment_type === 'monthly' ? 'Monthly' : 'Salary';
                    const rate = c.payment_type === 'monthly' ? `$${c.monthly_rate || 0}/mo` : '\u2014';
                    return `<tr>
                        <td style="font-weight:700">${escapeHtml(c.name)}</td>
                        <td><span style="padding:2px 8px;border-radius:5px;font-size:0.72rem;font-weight:700;background:${c.payment_type === 'monthly' ? 'rgba(34,197,94,0.1)' : 'rgba(99,102,241,0.1)'};color:${c.payment_type === 'monthly' ? '#22c55e' : '#818cf8'}">${typeLabel}</span></td>
                        <td><span style="color:${statusColors[c.status] || '#888'};font-weight:600">${formatOperatorStatus(c.status)}</span></td>
                        <td>${rate}</td>
                        <td style="font-size:0.78rem;color:var(--text-secondary)">${formatDate(c.created_at)}</td>
                    </tr>`;
                }).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-secondary);padding:24px;">No clients yet.</td></tr>';
            } catch (e) { console.error('Revenue load error:', e); }
        }

        // ---- Ads & Leads ----
        async function chLoadAdsAndLeads() {
            try {
                const [leadsRes, adsRes] = await Promise.all([
                    supabaseClient.from('client_leads').select('*').order('created_at', { ascending: false }),
                    supabaseClient.from('client_ads').select('*').order('created_at', { ascending: false })
                ]);
                chLeads = leadsRes.data || [];
                chAds = adsRes.data || [];
            } catch (e) { chLeads = []; chAds = []; }
            chRenderAdsStats();
            chRenderAds();
            chRenderLeadFilters();
            chRenderLeadsTable();
        }

        function chRenderAdsStats() {
            const total = chLeads.length;
            const weekAgo = new Date(Date.now() - 7 * 86400000).toISOString();
            const newThisWeek = chLeads.filter(l => l.created_at >= weekAgo).length;
            const inTrial = chLeads.filter(l => l.status === 'trial').length;
            const active = chLeads.filter(l => l.status === 'active').length;
            const conversion = total > 0 ? Math.round((active / total) * 100) : 0;
            document.getElementById('chAdsStats').innerHTML = `
                <div class="ch-kanban-stat"><div class="ch-kanban-stat-val" style="color:#22c55e">${total}</div><div class="ch-kanban-stat-label">Total Leads</div></div>
                <div class="ch-kanban-stat"><div class="ch-kanban-stat-val" style="color:#3b82f6">${newThisWeek}</div><div class="ch-kanban-stat-label">New This Week</div></div>
                <div class="ch-kanban-stat"><div class="ch-kanban-stat-val" style="color:#f59e0b">${inTrial}</div><div class="ch-kanban-stat-label">In Trial</div></div>
                <div class="ch-kanban-stat"><div class="ch-kanban-stat-val" style="color:#6366f1">${conversion}%</div><div class="ch-kanban-stat-label">Conversion</div></div>
            `;
        }

        function chRenderAds() {
            const grid = document.getElementById('chAdsGrid');
            if (chAds.length === 0) { grid.innerHTML = '<div style="color:var(--text-secondary);font-size:0.88rem;padding:12px;">No ads yet. Click "+ Add Ad" to track your first placement.</div>'; return; }
            const platformColors = { 'kijiji': '#22c55e', 'fb-marketplace': '#3b82f6', 'linkedin': '#a855f7', 'instagram': '#ef4444', 'reddit': '#f59e0b', 'facebook-group': '#3b82f6' };
            grid.innerHTML = chAds.map(ad => {
                const pc = platformColors[ad.platform] || '#6366f1';
                const statusColors = { active: '#22c55e', paused: '#f59e0b', draft: '#888', expired: '#ef4444' };
                const leadsForAd = chLeads.filter(l => l.ad_id === ad.id).length;
                return `<div class="ch-ad-card">
                    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;">
                        <span style="padding:3px 8px;border-radius:5px;font-size:0.72rem;font-weight:700;background:${pc}22;color:${pc}">${ad.platform}</span>
                        <span style="font-size:0.72rem;font-weight:700;color:${statusColors[ad.status] || '#888'}">${ad.status}</span>
                    </div>
                    <div style="font-weight:700;font-size:0.92rem;margin-bottom:6px;">${escapeHtml(ad.title)}</div>
                    <div style="font-size:0.78rem;color:var(--text-secondary);display:flex;gap:14px;">
                        <span>Leads: <strong>${leadsForAd}</strong></span><span>Budget: $${ad.budget || 0}</span>
                    </div>
                    ${ad.url ? `<a href="${ad.url}" target="_blank" style="color:#3b82f6;font-size:0.76rem;font-weight:600;margin-top:6px;display:inline-block;">View Ad</a>` : ''}
                    <div style="display:flex;gap:6px;margin-top:10px;">
                        <button style="padding:4px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text-secondary);font-family:inherit;font-size:0.72rem;font-weight:600;cursor:pointer;" onclick="chToggleAd('${ad.id}','${ad.status === 'active' ? 'paused' : 'active'}')">${ad.status === 'active' ? 'Pause' : 'Activate'}</button>
                        <button style="padding:4px 10px;border-radius:6px;border:1px solid rgba(255,255,255,0.08);background:transparent;color:var(--text-secondary);font-family:inherit;font-size:0.72rem;font-weight:600;cursor:pointer;" onclick="chToggleAd('${ad.id}','expired')">Expire</button>
                    </div>
                </div>`;
            }).join('');
        }

        async function chToggleAd(id, newStatus) {
            try { await supabaseClient.from('client_ads').update({ status: newStatus }).eq('id', id); const ad = chAds.find(a => a.id === id); if (ad) ad.status = newStatus; chRenderAds(); } catch (e) { alert('Failed: ' + e.message); }
        }

        function chRenderLeadFilters() {
            document.getElementById('chLeadFilters').innerHTML = ['all', 'new', 'contacted', 'trial', 'active', 'churned'].map(s =>
                `<button class="ch-lead-filter-btn ${chLeadFilter === s ? 'active' : ''}" onclick="chFilterLeads('${s}')">${s === 'all' ? 'All' : s.charAt(0).toUpperCase() + s.slice(1)}</button>`
            ).join('');
        }

        function chFilterLeads(f) { chLeadFilter = f; chRenderLeadFilters(); chRenderLeadsTable(); }

        function chRenderLeadsTable() {
            let filtered = chLeadFilter === 'all' ? chLeads : chLeads.filter(l => l.status === chLeadFilter);
            const tbody = document.getElementById('chLeadsTableBody');
            if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--text-secondary);padding:24px;">No leads' + (chLeadFilter !== 'all' ? ' with status "' + chLeadFilter + '"' : '') + ' yet.</td></tr>'; return; }
            tbody.innerHTML = filtered.map(l => {
                const statusColors = { 'new': '#3b82f6', contacted: '#f59e0b', trial: '#a855f7', active: '#22c55e', churned: '#ef4444' };
                return `<tr>
                    <td style="font-weight:700">${escapeHtml(l.name)}</td>
                    <td>${escapeHtml(l.business_name || '\u2014')}</td>
                    <td style="font-size:0.78rem;color:var(--text-secondary)">${l.source || 'direct'}</td>
                    <td><select style="padding:3px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:rgba(255,255,255,0.03);color:${statusColors[l.status] || '#888'};font-family:inherit;font-size:0.78rem;font-weight:600;cursor:pointer;" onchange="chUpdateLeadStatus('${l.id}',this.value)">
                        ${['new','contacted','trial','active','churned'].map(s => '<option value="' + s + '"' + (l.status === s ? ' selected' : '') + '>' + s.charAt(0).toUpperCase() + s.slice(1) + '</option>').join('')}
                    </select></td>
                    <td>${l.monthly_rate ? '$' + l.monthly_rate : '\u2014'}</td>
                    <td style="font-size:0.78rem;color:var(--text-secondary)">${new Date(l.created_at).toLocaleDateString()}</td>
                </tr>`;
            }).join('');
        }

        async function chUpdateLeadStatus(id, status) {
            try { await supabaseClient.from('client_leads').update({ status, updated_at: new Date().toISOString() }).eq('id', id); const l = chLeads.find(x => x.id === id); if (l) l.status = status; chRenderAdsStats(); } catch (e) { alert('Failed: ' + e.message); }
        }

        function chCopyLandingLink(ref) {
            const base = 'https://clients.suitegpt.app';
            const url = ref ? base + '?ref=' + ref : base;
            navigator.clipboard.writeText(url);
            event.target.textContent = 'Copied!';
            setTimeout(() => { event.target.textContent = ref ? 'Copy Link (' + ref.charAt(0).toUpperCase() + ref.slice(1) + ')' : 'Copy Link (Direct)'; }, 1500);
        }

        // ---- Add Lead Modal ----
        function showAddLeadModal() { document.getElementById('chLeadModal').classList.add('show'); }
        function hideAddLeadModal() { document.getElementById('chLeadModal').classList.remove('show'); }
        async function chSaveLead() {
            const name = document.getElementById('chLeadName').value.trim();
            if (!name) { alert('Name required.'); return; }
            try {
                const data = { name, email: document.getElementById('chLeadEmail').value.trim() || null, phone: document.getElementById('chLeadPhone').value.trim() || null, business_name: document.getElementById('chLeadBusiness').value.trim() || null, source: document.getElementById('chLeadSource').value, what_they_need: document.getElementById('chLeadNeed').value.trim() || null, notes: document.getElementById('chLeadNotes').value.trim() || null, status: 'new' };
                await supabaseClient.from('client_leads').insert([data]);
                hideAddLeadModal();
                ['chLeadName','chLeadEmail','chLeadPhone','chLeadBusiness','chLeadNeed','chLeadNotes'].forEach(id => { document.getElementById(id).value = ''; });
                if (document.getElementById('clientsPipelinePanel').classList.contains('active')) chLoadPipeline();
                if (document.getElementById('clientsAdsPanel').classList.contains('active')) chLoadAdsAndLeads();
            } catch (e) { alert('Failed: ' + e.message); }
        }

        // ---- Add Ad Modal ----
        function showAddAdModal() { document.getElementById('chAdModal').classList.add('show'); }
        function hideAddAdModal() { document.getElementById('chAdModal').classList.remove('show'); }
        async function chSaveAd() {
            const title = document.getElementById('chAdTitle').value.trim();
            if (!title) { alert('Title required.'); return; }
            try {
                const data = { platform: document.getElementById('chAdPlatform').value, title, url: document.getElementById('chAdUrl').value.trim() || null, budget: parseFloat(document.getElementById('chAdBudget').value) || 0, status: 'active', posted_at: new Date().toISOString() };
                await supabaseClient.from('client_ads').insert([data]);
                hideAddAdModal();
                ['chAdTitle','chAdUrl','chAdBudget'].forEach(id => { document.getElementById(id).value = ''; });
                chLoadAdsAndLeads();
            } catch (e) { alert('Failed: ' + e.message); }
        }

        // ---- Outreach (static content) ----
        function chRenderOutreach() {
            const el = document.getElementById('chOutreachContent');
            if (el.innerHTML) return;
            el.innerHTML = '<h3 style="font-size:1rem;font-weight:700;margin-bottom:12px;">Your Pitch</h3>' +
                '<div class="ch-outreach-card"><div class="ch-outreach-title">Elevator Pitch</div><div class="ch-outreach-body" id="chPitch1">I build custom AI-powered dashboards for small businesses. You get a website, an admin panel, and a chat interface where you can request changes and manage everything yourself.\n\nFree setup. Free for 30 days. Then a flat monthly fee to keep it running and make updates whenever you need them.\n\nYou don\'t need to know anything technical. You just tell me what you need, I build it, and you\'re running.</div><button class="ch-copy-btn" onclick="chCopyEl(\'chPitch1\')">Copy</button></div>' +
                '<div class="ch-outreach-card"><div class="ch-outreach-title">DM / Cold Message</div><div class="ch-outreach-body" id="chPitch2">Hey \u2014 I build custom websites + admin dashboards for small businesses, powered by AI so you can manage everything through a simple chat interface. Free setup, free first month. Would you be open to a quick look at what I built for a golf putter company? Happy to show you.</div><button class="ch-copy-btn" onclick="chCopyEl(\'chPitch2\')">Copy</button></div>' +
                '<div class="ch-outreach-card"><div class="ch-outreach-title">In-Person Script</div><div class="ch-outreach-body" id="chPitch3">Hey, I\'m Stuart. I help small businesses get set up with a custom website and a dashboard where you can manage inventory, update content, and handle customer stuff \u2014 all through a chat interface, no tech skills needed.\n\nI just did this for a custom putter company \u2014 built their whole site, inventory system, and now they just type what they need and it happens.\n\nI do free setup and the first month is free. After that it\'s a flat monthly fee. Want me to show you what it looks like?</div><button class="ch-copy-btn" onclick="chCopyEl(\'chPitch3\')">Copy</button></div>' +
                '<h3 style="font-size:1rem;font-weight:700;margin:24px 0 12px;">Outreach Channels (Ranked by Priority)</h3>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #22c55e"><div class="ch-outreach-title" style="color:#22c55e">1. Kijiji / Facebook Marketplace</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Local, high intent. Business owners posting services but have no website. Search for businesses in services categories, send a message offering free custom website + dashboard.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #3b82f6"><div class="ch-outreach-title" style="color:#3b82f6">2. Landing Page (Inbound)</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">clients.suitegpt.app \u2014 all outreach should point here. Professional page that converts warm leads 24/7.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #a855f7"><div class="ch-outreach-title" style="color:#a855f7">3. LinkedIn Outreach</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">B2B, highest value clients. Connect with business owners/founders, post content showing builds.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #f59e0b"><div class="ch-outreach-title" style="color:#f59e0b">4. Direct Email</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Most scalable. Scrape Google Maps/Yelp for businesses with bad/no websites, send personalized cold emails.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #ef4444"><div class="ch-outreach-title" style="color:#ef4444">5. Instagram / Content</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Brand building. Time-lapse reels, before/after, client spotlights. Post 3-5x/week.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #6366f1"><div class="ch-outreach-title" style="color:#6366f1">6. Facebook Groups + Reddit</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Community outreach. Answer questions, provide value, mention your offer when relevant. 80% value, 20% pitch.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #22c55e"><div class="ch-outreach-title" style="color:#22c55e">7. Walk-Ins</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Highest conversion, lowest scale. Show Proto Golf demo on your phone. Target shops without websites.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #3b82f6"><div class="ch-outreach-title" style="color:#3b82f6">8. Referrals</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Best ROI once rolling. Ask every happy client: "Know anyone else who could use this?" Offer incentives.</div></div>' +
                '<h3 style="font-size:1rem;font-weight:700;margin:28px 0 12px;"> Job Boards & Employment</h3>' +
                '<div style="font-size:0.86rem;color:var(--text-secondary);margin-bottom:16px;line-height:1.6;">Beyond finding local business clients, you can also land salaried positions at tech companies. Your SUITE portfolio is a powerful differentiator. Use the <strong>Job Hunter</strong> section above for the full toolkit (Resume Lab, Pipeline Tracker, Checklist).</div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #6366f1"><div class="ch-outreach-title" style="color:#6366f1">LinkedIn Jobs</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Largest job board. Search for DevRel, Solutions Engineer, Applied AI Engineer. Filter by past week. Apply directly + send connection request to hiring manager.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #f59e0b"><div class="ch-outreach-title" style="color:#f59e0b">Y Combinator  Work at a Startup</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Top-tier startups, less bureaucracy. Filter for AI roles. YC companies move fast and value builders who ship.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #22c55e"><div class="ch-outreach-title" style="color:#22c55e">Wellfound (AngelList)</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Startup jobs with equity. Good for early-stage companies that need DevRel, AI engineers, solutions engineers.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #a855f7"><div class="ch-outreach-title" style="color:#a855f7">Direct Career Pages</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">Anthropic, OpenAI, Google DeepMind, Replicate, Hugging Face, Cohere, Vercel, Supabase. Check their careers pages directly for the freshest listings.</div></div>' +
                '<div class="ch-outreach-card" style="border-left:3px solid #ef4444"><div class="ch-outreach-title" style="color:#ef4444">Niche AI + Web3 Boards</div><div style="font-size:0.84rem;color:var(--text-secondary);line-height:1.6;">ai-jobs.net, aijobs.app, CryptocurrencyJobs, Web3.career. Lower volume but higher signal. Your DeFi background is a differentiator on Web3 boards.</div></div>';
        }
        function chCopyEl(id) { const text = document.getElementById(id).textContent; navigator.clipboard.writeText(text); }

        // ---- Overview (static content) ----
        function chRenderOverview() {
            const el = document.getElementById('chOverviewContent');
            if (el.innerHTML) return;
            el.innerHTML = '<div class="ch-outreach-card" style="border-left:3px solid #22c55e;margin-bottom:24px;">' +
                '<div class="ch-outreach-title" style="font-size:1.1rem;">Client Hub \u2014 The Business Model</div>' +
                '<div class="ch-outreach-body" style="font-size:0.9rem;line-height:1.8;"><strong>What you\'re selling:</strong> Custom AI-powered websites, dashboards, admin panels \u2014 anything Claude can build. You\'re a one-man agency powered by AI.\n\n<strong>The offer:</strong> Everything FREE for 30 days. Free setup, free build, free everything. No risk for the client.\n\n<strong>The conversion (Day 30):</strong> By the end of the free month, they\'re using the system daily. Their business runs on it. Now you say: "$X/month to keep it running and maintained."\n\n<strong>Why it works:</strong>\n1. Zero risk = easy yes\n2. By day 30 they\'re dependent on the system\n3. The chat UI creates a direct relationship\n4. Your cost to fulfill is near-zero (Claude does the work)\n5. Each client is recurring revenue\n\n<strong>Revenue targets:</strong>\n- 5 clients @ $500/mo = $2,500/mo\n- 10 clients @ $500/mo = $5,000/mo\n- 20 clients @ $750/mo = $15,000/mo</div></div>';
        }

        // ===== Marketing View Functions =====
        let marketingSchedule = {};
        let currentPostId = null;
        const isMarketingAdmin = () => {
            const email = localStorage.getItem('user_email') || '';
            const wallet = localStorage.getItem('connectedWallet') || '';
            const telegramUser = localStorage.getItem('telegram_user');
            const telegram = telegramUser ? JSON.parse(telegramUser) : null;
            const telegramUsername = telegram?.username || '';

            // Stuart's accounts
            const isAdmin = email.includes('stuart') ||
                           email.includes('5915') ||
                           telegramUsername.toLowerCase() === 'stuartdefi';

            console.log('[Marketing] Admin check:', { email, wallet, telegramUsername, isAdmin });
            return isAdmin;
        };

        // Daily theme definitions (matches Cadence AI strategy)
        const DAY_THEMES = {
            0: { id: 'motivation', label: 'Motivation', emoji: '', color: '#f97316' },
            1: { id: 'motivation', label: 'Motivation', emoji: '', color: '#f97316' },
            2: { id: 'tips', label: 'Tips & Tutorials', emoji: '', color: '#3b82f6' },
            3: { id: 'behind', label: 'Behind Scenes', emoji: '', color: '#8b5cf6' },
            4: { id: 'thought', label: 'Thought Leadership', emoji: '', color: '#eab308' },
            5: { id: 'community', label: 'Community', emoji: '', color: '#22c55e' },
            6: { id: 'lifestyle', label: 'Lifestyle', emoji: '', color: '#06b6d4' }
        };

        // Cadence definitions
        const CADENCES = {
            'x-posts': { name: 'X Posts', icon: '', times: ['10:00', '15:00', '20:00'], days: [0,1,2,3,4,5,6] },
            'app-highlights': { name: 'App Highlight', icon: '', times: ['12:00'], days: [0,1,2,3,4,5,6] },
            'ecosystem-updates': { name: 'Ecosystem Update', icon: '', times: ['19:00'], days: [1,2,3,4,5] },
            'linkedin-posts': { name: 'LinkedIn', icon: '', times: ['09:00'], days: [2, 4] }
        };

        // ========== Marketing Dashboard ==========

        async function initMarketingView() {
            console.log('[Marketing] Initializing dashboard...');
            await initCalendar();
            await initMarketingDashboard();
            if (isMarketingAdmin()) {
                document.querySelectorAll('.admin-only').forEach(el => el.style.display = '');
            }
        }

        let brandVoice = null;

        async function initMarketingDashboard() {
            // Load brand voice from Supabase
            if (supabaseClient) {
                try {
                    const { data: voiceData } = await supabaseClient
                        .from('brand_voice')
                        .select('*')
                        .limit(1)
                        .single();
                    if (voiceData) brandVoice = voiceData;
                } catch (err) {
                    console.log('[Marketing] Brand voice load error:', err);
                }
            }
            // Populate app highlight dropdown
            populateSourceAppDropdown();
            // Initialize daily brief
            loadDailyBriefs();
            renderDailyBrief();
        }

        function populateSourceAppDropdown() {
            const select = document.getElementById('appHighlightSelect');
            if (!select || typeof SUITE_APPS === 'undefined') return;
            Object.entries(SUITE_APPS).forEach(([key, app]) => {
                const opt = document.createElement('option');
                opt.value = key;
                opt.textContent = app.name;
                select.appendChild(opt);
            });
        }

        let githubActivity = [];

        async function fetchGitHubActivity() {
            const username = document.getElementById('githubUsername').value.trim();
            if (!username) {
                alert('Please enter a GitHub username');
                return;
            }

            const preview = document.getElementById('githubActivityPreview');
            preview.innerHTML = '<span class="github-empty">Fetching...</span>';

            try {
                const reposResponse = await fetch(`https://api.github.com/users/${username}/repos?sort=pushed&per_page=5`);
                if (!reposResponse.ok) throw new Error('Failed to fetch repos');

                const repos = await reposResponse.json();
                const commits = [];

                for (const repo of repos.slice(0, 3)) {
                    try {
                        const commitsResponse = await fetch(`https://api.github.com/repos/${repo.full_name}/commits?per_page=3`);
                        if (commitsResponse.ok) {
                            const repoCommits = await commitsResponse.json();
                            for (const commit of repoCommits) {
                                commits.push({
                                    message: commit.commit.message.split('\n')[0],
                                    repo: repo.name,
                                    date: new Date(commit.commit.author.date).toLocaleDateString()
                                });
                            }
                        }
                    } catch (e) {
                        console.log('[GitHub] Skipping repo:', repo.name);
                    }
                }

                githubActivity = commits.slice(0, 8);

                if (githubActivity.length === 0) {
                    preview.innerHTML = '<span class="github-empty">No recent commits found</span>';
                    return;
                }

                preview.innerHTML = githubActivity.map(c => `
                    <div class="github-commit">
                        <div class="github-commit-msg">${c.message}</div>
                        <div class="github-commit-repo">${c.repo}</div>
                    </div>
                `).join('');

                console.log('[GitHub] Fetched activity:', githubActivity);
            } catch (err) {
                console.error('[GitHub] Fetch error:', err);
                preview.innerHTML = '<span class="github-empty">Error fetching activity</span>';
            }
        }

        // --- Daily Brief Marketing Dashboard ---

        let dailyBriefDate = new Date();
        let dailyBriefs = {};
        let dailyGeneratedPosts = []; // holds generated posts for current brief

        const CADENCE_INFO = {
            'x-posts': {
                prompt: 'X/Twitter post (under 280 chars). Casual, builder-focused, punchy. No hard sells.'
            },
            'app-highlights': {
                prompt: 'App Highlight post (under 280 chars). Deep-dive on one SUITE app  problem it solves, key features, why it matters.'
            },
            'ecosystem-updates': {
                prompt: 'Ecosystem Update post (under 280 chars). Build-in-public recap  what shipped, metrics, what\'s next.'
            },
            'linkedin-posts': {
                prompt: 'LinkedIn post (2-3 short paragraphs, professional but authentic). Long-form AI insights, building in public, startup lessons. Do NOT limit to 280 chars.'
            }
        };

        function loadDailyBriefs() {
            try {
                dailyBriefs = JSON.parse(localStorage.getItem('daily_briefs') || '{}');
            } catch (e) { dailyBriefs = {}; }
        }

        function saveDailyBriefs() {
            localStorage.setItem('daily_briefs', JSON.stringify(dailyBriefs));
        }

        function getDailyBriefDateKey() {
            return dailyBriefDate.toISOString().split('T')[0];
        }

        function renderWeeklyOverview() {
            const body = document.getElementById('weeklyOverviewBody');
            if (!body) return;

            const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
            const today = new Date();
            today.setHours(0,0,0,0);

            // Build a week starting from Monday of current week
            const current = new Date(dailyBriefDate);
            const dayOfWeek = current.getDay();
            const monday = new Date(current);
            monday.setDate(current.getDate() - ((dayOfWeek + 6) % 7));

            let totalPosts = 0;
            let xTotal = 0, appTotal = 0, ecoTotal = 0, liTotal = 0;
            let rows = '';

            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(monday.getDate() + i);
                const dow = d.getDay();
                const slots = getDailySlotsForDate(d);
                const isToday = d.getTime() === today.getTime();
                const isBriefDay = d.toISOString().split('T')[0] === dailyBriefDate.toISOString().split('T')[0];

                const xCount = slots.filter(s => s.cadence === 'x-posts').length;
                const appCount = slots.filter(s => s.cadence === 'app-highlights').length;
                const ecoCount = slots.filter(s => s.cadence === 'ecosystem-updates').length;
                const liCount = slots.filter(s => s.cadence === 'linkedin-posts').length;
                const dayTotal = slots.length;
                totalPosts += dayTotal;
                xTotal += xCount; appTotal += appCount; ecoTotal += ecoCount; liTotal += liCount;

                const rowClass = isBriefDay ? ' class="weekly-overview-today"' : '';
                const dayLabel = dayNames[dow] + (isToday ? ' ' : '');
                const theme = DAY_THEMES[dow];
                const themeTag = theme ? `<span style="color:${theme.color};font-weight:700;">${theme.emoji} ${theme.label}</span>` : '';
                rows += `<tr${rowClass}>
                    <td>${dayLabel}</td>
                    <td>${themeTag}</td>
                    <td>${xCount > 0 ? ' ' + xCount : ''}</td>
                    <td>${appCount > 0 ? ' ' + appCount : ''}</td>
                    <td>${ecoCount > 0 ? ' ' + ecoCount : ''}</td>
                    <td>${liCount > 0 ? ' ' + liCount : ''}</td>
                    <td>${dayTotal}</td>
                </tr>`;
            }

            body.innerHTML = `
                <table>
                    <thead><tr><th>Day</th><th>Theme</th><th>X</th><th>App</th><th>Eco</th><th>LI</th><th>Total</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
                <div class="weekly-overview-total">
                    <span class="weekly-overview-stat"> <strong>${xTotal}</strong></span>
                    <span class="weekly-overview-stat"> <strong>${appTotal}</strong></span>
                    <span class="weekly-overview-stat"> <strong>${ecoTotal}</strong></span>
                    <span class="weekly-overview-stat"> <strong>${liTotal}</strong></span>
                    <span class="weekly-overview-stat">= <strong>${totalPosts}</strong> posts/week</span>
                </div>
            `;
        }

        function getDailySlotsForDate(date) {
            const dayOfWeek = date.getDay();
            const slots = [];
            Object.entries(CADENCES).forEach(([cadenceId, cadence]) => {
                if (cadence.days.includes(dayOfWeek)) {
                    cadence.times.forEach(time => {
                        slots.push({ cadence: cadenceId, time, name: cadence.name, icon: cadence.icon });
                    });
                }
            });
            slots.sort((a, b) => a.time.localeCompare(b.time));
            return slots;
        }

        function navigateDailyBrief(direction) {
            // Save current brief before navigating
            saveDailyBriefFromUI();
            dailyBriefDate.setDate(dailyBriefDate.getDate() + direction);
            renderDailyBrief();
        }

        function renderDailyBrief() {
            const dateKey = getDailyBriefDateKey();
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const d = dailyBriefDate;

            // Date display
            const dateEl = document.getElementById('dailyBriefDate');
            if (dateEl) dateEl.textContent = `${days[d.getDay()]}, ${months[d.getMonth()]} ${d.getDate()}`;

            // Slots summary
            const slots = getDailySlotsForDate(d);
            const slotsEl = document.getElementById('dailyBriefSlots');
            if (slotsEl) {
                slotsEl.innerHTML = slots.map(s =>
                    `<span class="daily-brief-slot"><span class="daily-brief-slot-icon">${s.icon}</span> ${s.name} ${formatTime(s.time)}</span>`
                ).join('');
            }

            // Update generate button count
            const countEl = document.getElementById('dailyPostCount');
            if (countEl) countEl.textContent = slots.length;

            // Render weekly overview
            renderWeeklyOverview();

            // Load saved brief
            const brief = dailyBriefs[dateKey] || {};
            const themeEl = document.getElementById('dailyTheme');
            const notesEl = document.getElementById('dailyNotes');
            if (themeEl) themeEl.value = brief.theme || '';
            if (notesEl) notesEl.value = brief.notes || '';

            // Image
            const previewEl = document.getElementById('dailyImagePreview');
            const thumbEl = document.getElementById('dailyImageThumb');
            if (brief.image) {
                thumbEl.src = brief.image;
                previewEl.style.display = 'inline-block';
            } else {
                previewEl.style.display = 'none';
            }

            // App highlight picker
            populateAppHighlightDropdown();

            // Research prompt
            updateResearchPrompt(slots, d);

            // Clear angles and generated results (per-session)
            dailyAngles = [];
            dailyGeneratedPosts = [];
            const anglesEl = document.getElementById('dailyAnglesResults');
            if (anglesEl) anglesEl.innerHTML = '';
            const genBtn = document.getElementById('generateFromAnglesBtn');
            if (genBtn) genBtn.style.display = 'none';
            const resultsEl = document.getElementById('dailyPostResults');
            if (resultsEl) resultsEl.innerHTML = '';
        }

        function getResearchPromptText(slots, date) {
            const days = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
            const months = ['January','February','March','April','May','June','July','August','September','October','November','December'];
            const dateStr = `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;

            const slotSummary = slots.map(s => {
                const info = CADENCE_INFO[s.cadence];
                if (s.cadence === 'linkedin-posts') return `- LinkedIn post (${formatTime(s.time)})  professional, 2-3 paragraphs`;
                if (s.cadence === 'app-highlights') return `- App Highlight (${formatTime(s.time)})  deep-dive on one SUITE app`;
                if (s.cadence === 'ecosystem-updates') return `- Ecosystem Update (${formatTime(s.time)})  build-in-public recap`;
                return `- X/Twitter post (${formatTime(s.time)})  short, punchy, <280 chars`;
            }).join('\n');

            return `I need you to research and gather content for my social media posts for ${dateStr}.

ABOUT ME:
I'm building SUITE (suitegpt.app)  an AI-powered ecosystem where "Anyone Can Build, Everyone Gets Paid." It has 29+ apps that anyone can build, use, and earn from. Key features: AI app builder, yield rewards (users earn USDC from a shared reward pool), credit system, and a community-driven app factory.

TODAY I NEED ${slots.length} POSTS:
${slotSummary}

WHAT I NEED FROM YOU:
1. Check my recent GitHub activity (github.com/stuart5915)  what did I ship or commit today?
2. Find 2-3 trending topics in AI / no-code / indie hacker / SaaS Twitter right now
3. Look at what's happening in the AI builder space  any news, launches, or discussions I should reference?
4. Check if there are any relevant trending hashtags or conversations I can join
5. Suggest a daily theme that ties it all together (1-3 words)
6. For each post slot, suggest a specific angle or hook based on what you found

FORMAT YOUR RESPONSE AS:
THEME: [1-3 word theme]

RESEARCH NOTES:
[All the raw material  commits, trends, news, angles. I'll paste this directly into my Daily Brief tool which generates the posts.]

POST ANGLES:
${slots.map((s, i) => `${i + 1}. ${s.icon} ${s.name} (${formatTime(s.time)}): [suggested angle]`).join('\n')}`;
        }

        function updateResearchPrompt(slots, date) {
            const promptEl = document.getElementById('researchPromptText');
            if (promptEl) promptEl.textContent = getResearchPromptText(slots, date);
        }

        function copyResearchPrompt() {
            const text = document.getElementById('researchPromptText')?.textContent || '';
            navigator.clipboard.writeText(text);
            showToast('Research prompt copied!');
        }

        function saveDailyBriefFromUI() {
            const dateKey = getDailyBriefDateKey();
            const theme = document.getElementById('dailyTheme')?.value?.trim() || '';
            const notes = document.getElementById('dailyNotes')?.value?.trim() || '';
            const thumbEl = document.getElementById('dailyImageThumb');
            const previewEl = document.getElementById('dailyImagePreview');
            const image = (previewEl && previewEl.style.display !== 'none' && thumbEl?.src) ? thumbEl.src : null;
            const appHighlight = document.getElementById('dailyAppSelect')?.value || '';

            if (theme || notes || image || appHighlight) {
                dailyBriefs[dateKey] = { theme, notes, image, appHighlight };
                saveDailyBriefs();
            }
        }

        function attachDailyImage(input) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('dailyImageThumb').src = e.target.result;
                document.getElementById('dailyImagePreview').style.display = 'inline-block';
                document.getElementById('imageHelperBtn').classList.add('active');
            };
            reader.readAsDataURL(input.files[0]);
        }

        function removeDailyImage() {
            document.getElementById('dailyImagePreview').style.display = 'none';
            document.getElementById('dailyImageThumb').src = '';
            document.getElementById('dailyImageInput').value = '';
            document.getElementById('imageHelperBtn').classList.remove('active');
        }

        function toggleSourceHelper(type) {
            const panel = document.getElementById(type + 'Helper');
            const btn = document.getElementById(type + 'HelperBtn');
            if (panel.style.display === 'none') {
                panel.style.display = 'block';
                btn.classList.add('active');
            } else {
                panel.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        let dailyAngles = []; // extracted angles for current brief
        let dailySlots = []; // cached slots for current generation

        function gatherSourceContext() {
            let sourceContext = '';
            if (document.getElementById('githubHelper').style.display !== 'none' && githubActivity.length) {
                const commits = githubActivity.map(c => `- ${c.repo}: ${c.message}`).join('\n');
                sourceContext += `\nRecent GitHub commits:\n${commits}`;
            }
            const appSelect = document.getElementById('appHighlightSelect');
            if (document.getElementById('appHelper').style.display !== 'none' && appSelect?.value) {
                let appKey = appSelect.value;
                if (appKey === 'random') {
                    const keys = Object.keys(SUITE_APPS);
                    appKey = keys[Math.floor(Math.random() * keys.length)];
                }
                const app = SUITE_APPS[appKey];
                if (app) sourceContext += `\nApp to highlight: ${app.name} - ${app.description}`;
            }
            return sourceContext;
        }

        // Robust JSON array parser  handles markdown fences, extra text, etc.
        function parseJSONResponse(raw) {
            // Strip whitespace
            let text = raw.trim();

            // Remove markdown code fences
            text = text.replace(/^```(?:json)?\s*\n?/gm, '').replace(/\n?```\s*$/gm, '').trim();

            // Try direct parse first
            try { return JSON.parse(text); } catch (e) {}

            // Try to extract JSON array from surrounding text
            const arrayMatch = text.match(/\[[\s\S]*\]/);
            if (arrayMatch) {
                try { return JSON.parse(arrayMatch[0]); } catch (e) {}

                // JSON might have unescaped newlines in strings  try fixing
                try {
                    const fixed = arrayMatch[0].replace(/(?<=":[ ]?"[^"]*)\n(?=[^"]*")/g, '\\n');
                    return JSON.parse(fixed);
                } catch (e) {}
            }

            // Try to extract individual complete JSON objects (handles truncated arrays)
            const objMatches = text.match(/\{[^{}]*\}/g);
            if (objMatches && objMatches.length > 0) {
                const items = [];
                for (const m of objMatches) {
                    try { items.push(JSON.parse(m)); } catch (e) {}
                }
                if (items.length > 0) {
                    console.warn('[parseJSON] Recovered ' + items.length + ' objects from possibly truncated response');
                    return items;
                }
            }

            // Last resort: log the raw response for debugging
            console.error('[parseJSON] All parsing attempts failed. Raw response:', text.substring(0, 1000));
            throw new Error('Could not parse AI response as JSON. Check console for raw output.');
        }

        // Step 1: Extract unique angles from the research
        async function extractAngles() {
            const theme = document.getElementById('dailyTheme').value.trim();
            const notes = document.getElementById('dailyNotes').value.trim();
            const sourceContext = gatherSourceContext();

            const hasAppHighlight = !!document.getElementById('dailyAppSelect')?.value;
            if (!theme && !notes && !sourceContext && !hasAppHighlight) {
                alert('Add a theme, notes, select an app highlight, or enable a source helper first.');
                return;
            }

            saveDailyBriefFromUI();

            dailySlots = getDailySlotsForDate(dailyBriefDate);
            if (!dailySlots.length) {
                alert('No posts scheduled for this day.');
                return;
            }

            const anglesEl = document.getElementById('dailyAnglesResults');
            const genBtn = document.getElementById('generateFromAnglesBtn');
            const resultsEl = document.getElementById('dailyPostResults');
            anglesEl.innerHTML = '<div class="marketing-generating">Reading your research and extracting angles...</div>';
            genBtn.style.display = 'none';
            resultsEl.innerHTML = '';

            // Check if an app highlight is selected for today
            const selectedAppKey = document.getElementById('dailyAppSelect')?.value;
            const selectedApp = selectedAppKey ? SUITE_APPS[selectedAppKey] : null;

            // Separate app-highlight slots from research-driven slots
            const researchSlots = [];
            const appSlots = [];
            dailySlots.forEach((s, i) => {
                if (s.cadence === 'app-highlights' && selectedApp) {
                    appSlots.push({ ...s, originalIndex: i });
                } else {
                    researchSlots.push({ ...s, originalIndex: i });
                }
            });

            const slotDescriptions = dailySlots.map((s, i) => {
                if (s.cadence === 'linkedin-posts') return `${i + 1}. LinkedIn post (${formatTime(s.time)})  long-form, professional`;
                if (s.cadence === 'app-highlights' && selectedApp) return `${i + 1}. App Highlight (${formatTime(s.time)})  spotlight on ${selectedApp.name}: ${selectedApp.description}. Deep-dive on this specific app  problem it solves, key features, why it matters.`;
                if (s.cadence === 'app-highlights') return `${i + 1}. App Highlight (${formatTime(s.time)})  deep-dive on a SUITE app`;
                if (s.cadence === 'ecosystem-updates') return `${i + 1}. Ecosystem Update (${formatTime(s.time)})  build-in-public recap`;
                return `${i + 1}. X/Twitter post (${formatTime(s.time)})  short, punchy`;
            }).join('\n');

            const prompt = `You are extracting post angles from research for SUITE (suitegpt.app)  "Anyone Can Build, Everyone Gets Paid." SUITE is an AI ecosystem with 29+ apps.

Today's theme: ${theme || 'general update'}
${notes ? 'Research & notes:\n' + notes : ''}${sourceContext}

I need ${dailySlots.length} UNIQUE angles for today's posts. Each angle should be a DIFFERENT take  not just rewording the same idea. Pull out distinct insights, stories, data points, or hooks from the research.

Post slots:
${slotDescriptions}

For each slot, write:
1. A 1-2 sentence angle description  WHAT specific point to make and HOW to frame it. Be specific, reference actual details from the research.
2. A text-to-image prompt  a cinematic, photorealistic scene showing human-AI symbiosis. The image should visually represent the angle's concept. Style: real humans interacting with, merging with, or working alongside AI in unexpected, beautiful ways. Think diverse people, warm lighting, slightly surreal blending of organic and digital. Each image must be visually DISTINCT from the others.

CRITICAL: You MUST return ONLY a raw JSON array. No markdown, no \`\`\` code fences, no explanation text before or after. Just the JSON array starting with [ and ending with ]. Do not use backticks anywhere.
[{"index":1,"angle":"specific angle description","imagePrompt":"detailed image generation prompt"},{"index":2,"angle":"...","imagePrompt":"..."}]`;

            try {
                const response = await callCopilotAI(prompt, { maxTokens: 2048, model: 'gemini-2.5-pro' });
                console.log('[Daily Brief] Raw AI response:', response.substring(0, 500));
                const parsed = parseJSONResponse(response);

                dailyAngles = dailySlots.map((slot, i) => {
                    const extracted = parsed.find(p => p.index === i + 1) || parsed[i] || {};
                    return { ...slot, angle: extracted.angle || '', imagePrompt: extracted.imagePrompt || '' };
                });

                renderAnglesReview();
            } catch (err) {
                console.error('[Daily Brief] Angle extraction failed:', err);
                anglesEl.innerHTML = `<div class="marketing-generating" style="color:#f87171;">Extraction failed: ${err.message}. Try again.</div>`;
            }
        }

        function getImageOverlayHTML(src, maxWidth) {
            if (!src) return '';
            return `<div class="brand-overlay-container" style="max-width:${maxWidth || 280}px;">
                <img class="brand-overlay-bg" src="${src}" alt="post image">
                <div class="brand-overlay-frame">
                    <div class="brand-overlay-bar">
                        <img class="brand-overlay-logo" src="/suitegpt-logo.png" alt="SUITE">
                        <div class="brand-overlay-text">
                            <span class="brand-overlay-name">SUITE</span>
                            <span class="brand-overlay-tagline">Anyone Can Build. Everyone Gets Paid.</span>
                        </div>
                        <span class="brand-overlay-url">suitegpt.app</span>
                    </div>
                </div>
            </div>`;
        }

        function renderAnglesReview() {
            const anglesEl = document.getElementById('dailyAnglesResults');
            const genBtn = document.getElementById('generateFromAnglesBtn');

            let html = `<button class="generate-all-images-btn" onclick="generateAllAngleImages()" id="generateAllImagesBtn"> Generate All Images</button>`;

            html += dailyAngles.map((a, i) => {
                const imgSrc = a.generatedImage || null;
                const preview = imgSrc
                    ? getImageOverlayHTML(imgSrc, 280)
                    : '<div class="angle-image-placeholder" style="color:var(--text-tertiary);font-size:0.75rem;margin-top:4px;">No image generated yet</div>';

                return `
                <div class="daily-angle-card">
                    <div class="daily-angle-badge">
                        <span class="daily-angle-icon">${a.icon}</span>
                        <span class="daily-angle-time">${formatTime(a.time)}</span>
                    </div>
                    <div style="flex:1;display:flex;flex-direction:column;gap:6px;">
                        <textarea class="daily-angle-input" id="angle_${i}" rows="2">${a.angle}</textarea>
                        <div class="daily-angle-imgprompt-row">
                            <span class="daily-angle-imgprompt-label"> Image:</span>
                            <textarea class="daily-angle-imgprompt" id="imgPrompt_${i}" rows="2">${a.imagePrompt}</textarea>
                            <button class="daily-angle-copy-btn" onclick="navigator.clipboard.writeText(document.getElementById('imgPrompt_${i}').value);showToast('Image prompt copied!')"></button>
                        </div>
                        <div style="display:flex;align-items:center;gap:8px;">
                            <button class="generate-image-btn" id="genImgBtn_${i}" onclick="generateAngleImage(${i})"> Generate Image</button>
                        </div>
                        <div class="angle-image-preview" id="angleImagePreview_${i}">${preview}</div>
                    </div>
                </div>`;
            }).join('');

            anglesEl.innerHTML = html;
            genBtn.style.display = 'block';
        }

        async function generateAngleImage(index) {
            const promptEl = document.getElementById('imgPrompt_' + index);
            const previewEl = document.getElementById('angleImagePreview_' + index);
            const btn = document.getElementById('genImgBtn_' + index);
            if (!promptEl || !previewEl) return;

            const prompt = promptEl.value.trim();
            if (!prompt) {
                showToast('No image prompt to generate from');
                return;
            }

            btn.disabled = true;
            btn.textContent = 'Generating...';
            previewEl.innerHTML = '<div class="angle-image-loading"><div class="spinner"></div>Generating image...</div>';

            try {
                const resp = await fetch('/api/generate-image', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ prompt, aspectRatio: '1:1' })
                });
                const data = await resp.json();

                if (!resp.ok) throw new Error(data.error || 'Generation failed');

                dailyAngles[index].generatedImage = data.image;
                previewEl.innerHTML = getImageOverlayHTML(data.image, 280);
                btn.textContent = ' Regenerate';
            } catch (err) {
                console.error('[Image Gen] Failed:', err);
                previewEl.innerHTML = `<div style="color:#f87171;font-size:0.75rem;">Failed: ${err.message}</div>`;
                btn.textContent = ' Retry';
            }
            btn.disabled = false;
        }

        async function generateAllAngleImages() {
            const btn = document.getElementById('generateAllImagesBtn');
            btn.disabled = true;
            const total = dailyAngles.length;

            for (let i = 0; i < total; i++) {
                btn.textContent = `Generating image ${i + 1}/${total}...`;
                await generateAngleImage(i);
            }

            btn.textContent = ' Regenerate All Images';
            btn.disabled = false;
            showToast(`Generated ${total} images!`);
        }

        // Step 2: Generate posts from the approved/edited angles
        async function generateFromAngles() {
            const theme = document.getElementById('dailyTheme').value.trim();
            const dateKey = getDailyBriefDateKey();
            let sourceContext = gatherSourceContext();
            const hasImage = document.getElementById('dailyImagePreview').style.display !== 'none';

            // Add selected app highlight context
            const appKey = document.getElementById('dailyAppSelect')?.value;
            const appInfo = appKey ? SUITE_APPS[appKey] : null;
            if (appInfo) sourceContext += `\nToday's App Highlight: ${appInfo.name}  ${appInfo.description}`;

            // Read (possibly edited) angles from the textareas
            dailyAngles.forEach((a, i) => {
                const el = document.getElementById('angle_' + i);
                if (el) a.angle = el.value.trim();
            });

            const resultsEl = document.getElementById('dailyPostResults');
            resultsEl.innerHTML = '<div class="marketing-generating" style="grid-column:1/-1;">Generating ' + dailyAngles.length + ' posts from your angles...</div>';

            const postInstructions = dailyAngles.map((a, i) => {
                const info = CADENCE_INFO[a.cadence];
                return `${i + 1}. ${a.name} (${formatTime(a.time)})  ${info.prompt}\n   ANGLE: ${a.angle}`;
            }).join('\n\n');

            const prompt = `You are the social media manager for SUITE (suitegpt.app)  "Anyone Can Build, Everyone Gets Paid."
SUITE is an AI-powered ecosystem with 29+ apps that anyone can build, use, and earn from.

Today's theme: ${theme || 'general update'}
${sourceContext}${hasImage ? '\nAn image is attached to accompany these posts.' : ''}

Write each post using its SPECIFIC assigned angle. Do not deviate from the angle  it was chosen deliberately. Make each post feel natural and engaging, not like a template.

${postInstructions}

CRITICAL: You MUST return ONLY a raw JSON array. No markdown, no \`\`\` code fences, no explanation text. Just the JSON array starting with [ and ending with ].
[{"index":1,"text":"post text here"},{"index":2,"text":"post text here"}]`;

            try {
                const response = await callCopilotAI(prompt, { maxTokens: 2048, model: 'gemini-2.5-pro' });
                console.log('[Daily Brief] Raw post response:', response.substring(0, 500));
                const parsed = parseJSONResponse(response);

                dailyGeneratedPosts = dailySlots.map((slot, i) => {
                    const generated = parsed.find(p => p.index === i + 1) || parsed[i] || {};
                    return { ...slot, text: generated.text || '', dateKey };
                });

                renderDailyPostResults();
            } catch (err) {
                console.error('[Daily Brief] Generation failed:', err);
                resultsEl.innerHTML = `<div class="marketing-generating" style="grid-column:1/-1;color:#f87171;">Generation failed: ${err.message}. Try again.</div>`;
            }
        }

        function renderDailyPostResults() {
            const resultsEl = document.getElementById('dailyPostResults');
            const hasUserImage = document.getElementById('dailyImagePreview').style.display !== 'none';
            const userImageSrc = hasUserImage ? document.getElementById('dailyImageThumb').src : null;

            let html = dailyGeneratedPosts.map((post, i) => {
                // Per-post image: generated image > user-attached image > none
                const imgSrc = (dailyAngles[i] && dailyAngles[i].generatedImage) || userImageSrc;
                const imageOverlay = getImageOverlayHTML(imgSrc);

                return `
                <div class="daily-post-card" data-index="${i}">
                    <div class="daily-post-card-header">
                        <span class="daily-post-card-icon">${post.icon}</span>
                        <span class="daily-post-card-cadence">${post.name}</span>
                        <span class="daily-post-card-time">${formatTime(post.time)}</span>
                    </div>
                    <textarea class="daily-post-card-text" id="dailyPost_${i}" rows="${post.cadence === 'linkedin-posts' ? 6 : 3}">${post.text}</textarea>
                    ${imageOverlay}
                    <div class="daily-post-card-actions">
                        <button onclick="copyDailyPost(${i})"> Copy</button>
                        <button onclick="redoDailyPost(${i})"> Redo</button>
                        <button onclick="postDailyPostToX(${i})"> Post Now</button>
                        <button class="schedule-btn" id="scheduleBtn_${i}" onclick="scheduleDailyPost(${i})"> Schedule</button>
                    </div>
                    <div class="daily-post-status" id="postStatus_${i}"></div>
                </div>`;
            }).join('');

            if (dailyGeneratedPosts.length > 0) {
                html += `<div class="daily-save-all-row" style="grid-column:1/-1;">
                    <button class="daily-save-all-btn" onclick="scheduleAllDailyPosts()" id="scheduleAllBtn"> Schedule All Posts</button>
                </div>`;
            }
            resultsEl.innerHTML = html;
        }

        function copyDailyPost(index) {
            const text = document.getElementById('dailyPost_' + index).value;
            navigator.clipboard.writeText(text);
            showToast('Copied to clipboard!');
        }

        async function postDailyPostToX(index) {
            const text = document.getElementById('dailyPost_' + index).value;
            // Reuse existing postToX logic
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = 'Posting...';
            btn.disabled = true;
            try {
                const resp = await fetch('/api/x-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await resp.json();
                if (resp.ok) {
                    btn.textContent = 'Posted!';
                    showToast('Posted to X!');
                } else {
                    throw new Error(data.error || 'Failed');
                }
            } catch (err) {
                btn.textContent = 'Failed';
                showToast('Post failed: ' + err.message);
            }
            setTimeout(() => { btn.textContent = originalText; btn.disabled = false; }, 2000);
        }

        async function redoDailyPost(index) {
            const post = dailyGeneratedPosts[index];
            if (!post) return;
            const textarea = document.getElementById('dailyPost_' + index);
            textarea.value = 'Regenerating...';
            textarea.disabled = true;

            const theme = document.getElementById('dailyTheme').value.trim();
            const notes = document.getElementById('dailyNotes').value.trim();
            const info = CADENCE_INFO[post.cadence];

            // For app highlight posts, include the selected app context
            let appContext = '';
            if (post.cadence === 'app-highlights') {
                const appKey = document.getElementById('dailyAppSelect')?.value;
                const app = appKey ? SUITE_APPS[appKey] : null;
                if (app) appContext = `\nApp to spotlight: ${app.name}  ${app.description}`;
            }

            const prompt = `You are the social media manager for SUITE (suitegpt.app)  "Anyone Can Build, Everyone Gets Paid."
Today's theme: ${theme || 'general update'}
${notes ? 'Context: ' + notes : ''}${appContext}

Generate a single ${info.prompt}

Return ONLY the post text, nothing else.`;

            try {
                const response = await callCopilotAI(prompt);
                post.text = response.trim();
                textarea.value = post.text;
            } catch (err) {
                textarea.value = 'Regeneration failed. Try again.';
            }
            textarea.disabled = false;
        }

        function saveDailyPostToCalendar(index) {
            const post = dailyGeneratedPosts[index];
            if (!post) return;
            const text = document.getElementById('dailyPost_' + index).value;
            const dateKey = post.dateKey;
            const timeId = post.time.replace(':', '');
            const postId = `${dateKey}_${post.cadence}_${timeId}`;

            if (!marketingSchedule[dateKey]) marketingSchedule[dateKey] = [];
            const existing = marketingSchedule[dateKey].find(p => p.id === postId);

            // Per-post image: generated image > user-attached image > null
            const generatedImg = (dailyAngles[index] && dailyAngles[index].generatedImage) || null;
            const hasUserImage = document.getElementById('dailyImagePreview').style.display !== 'none';
            const userImg = hasUserImage ? document.getElementById('dailyImageThumb').src : null;
            const imageSrc = generatedImg || userImg;

            if (existing) {
                existing.content = text;
                existing.status = 'draft';
                if (imageSrc) existing.image = imageSrc;
            } else {
                marketingSchedule[dateKey].push({
                    id: postId,
                    cadence: post.cadence,
                    time: post.time,
                    status: 'draft',
                    content: text,
                    image: imageSrc
                });
                marketingSchedule[dateKey].sort((a, b) => a.time.localeCompare(b.time));
            }
            saveMarketingSchedule();
            renderCalendar();
            showToast(`Saved ${post.name} ${formatTime(post.time)} to calendar`);
        }

        function saveAllDailyPosts() {
            dailyGeneratedPosts.forEach((_, i) => saveDailyPostToCalendar(i));
            showToast(`All ${dailyGeneratedPosts.length} posts saved to calendar!`);
        }

        // --- Post Scheduling (Supabase) ---

        function getPlatformForCadence(cadence) {
            return cadence === 'linkedin-posts' ? 'linkedin' : 'x';
        }

        function buildScheduledFor(dateKey, time) {
            // Build a local datetime and convert to ISO for Supabase
            return new Date(`${dateKey}T${time}:00`).toISOString();
        }

        async function scheduleDailyPost(index) {
            const post = dailyGeneratedPosts[index];
            if (!post) return;

            const btn = document.getElementById('scheduleBtn_' + index);
            const statusEl = document.getElementById('postStatus_' + index);
            const text = document.getElementById('dailyPost_' + index).value;

            btn.disabled = true;
            btn.textContent = 'Scheduling...';

            const generatedImg = (dailyAngles[index] && dailyAngles[index].generatedImage) || null;
            const hasUserImage = document.getElementById('dailyImagePreview').style.display !== 'none';
            const userImg = hasUserImage ? document.getElementById('dailyImageThumb').src : null;
            const theme = document.getElementById('dailyTheme')?.value?.trim() || '';

            try {
                const resp = await fetch('/api/schedule-post', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        platform: getPlatformForCadence(post.cadence),
                        post_text: text,
                        image_url: generatedImg || userImg || null,
                        scheduled_for: buildScheduledFor(post.dateKey, post.time),
                        cadence: post.cadence,
                        date_key: post.dateKey,
                        theme
                    })
                });
                const data = await resp.json();

                if (!resp.ok) throw new Error(data.error || 'Failed to schedule');

                // Also save to localStorage calendar
                saveDailyPostToCalendar(index);

                // Update local status
                post.supabaseId = data.id;
                post.scheduledStatus = 'scheduled';

                btn.textContent = ' Scheduled';
                statusEl.innerHTML = `<span class="post-status-badge status-scheduled">Scheduled for ${formatTime(post.time)}</span>`;
                showToast(`${post.name} scheduled for ${formatTime(post.time)}`);
            } catch (err) {
                console.error('[Schedule] Failed:', err);
                btn.textContent = ' Retry';
                statusEl.innerHTML = `<span class="post-status-badge status-failed">Failed: ${err.message}</span>`;
            }
            btn.disabled = false;
        }

        async function scheduleAllDailyPosts() {
            const btn = document.getElementById('scheduleAllBtn');
            btn.disabled = true;
            const total = dailyGeneratedPosts.length;

            for (let i = 0; i < total; i++) {
                btn.textContent = `Scheduling ${i + 1}/${total}...`;
                await scheduleDailyPost(i);
            }

            btn.textContent = ' All Scheduled';
            btn.disabled = false;
            showToast(`All ${total} posts scheduled!`);
        }

        async function fetchScheduledPosts(fromDate, toDate) {
            try {
                const params = new URLSearchParams();
                if (fromDate) params.set('from', fromDate);
                if (toDate) params.set('to', toDate);
                const resp = await fetch('/api/scheduled-posts?' + params.toString());
                const data = await resp.json();
                return data.posts || [];
            } catch (err) {
                console.error('[Schedule] Failed to fetch:', err);
                return [];
            }
        }

        // --- App Highlight Picker ---

        function loadAppHighlightHistory() {
            try {
                return JSON.parse(localStorage.getItem('app_highlight_history') || '{}');
            } catch { return {}; }
        }

        function saveAppHighlightHistory(history) {
            localStorage.setItem('app_highlight_history', JSON.stringify(history));
        }

        function getAppUsageCount(appKey) {
            const history = loadAppHighlightHistory();
            return Object.values(history).filter(v => v === appKey).length;
        }

        function populateAppHighlightDropdown() {
            const select = document.getElementById('dailyAppSelect');
            if (!select) return;

            const history = loadAppHighlightHistory();
            const dateKey = getDailyBriefDateKey();

            // Build usage counts
            const usageCounts = {};
            for (const v of Object.values(history)) {
                usageCounts[v] = (usageCounts[v] || 0) + 1;
            }

            // Sort apps: least-used first so user can easily pick under-highlighted ones
            const appEntries = Object.entries(SUITE_APPS).sort((a, b) => {
                return (usageCounts[a[0]] || 0) - (usageCounts[b[0]] || 0);
            });

            let html = '<option value="">Pick an app to highlight...</option>';
            for (const [key, app] of appEntries) {
                const count = usageCounts[key] || 0;
                const countLabel = count > 0 ? ` (${count})` : '';
                const selected = history[dateKey] === key ? ' selected' : '';
                html += `<option value="${key}"${selected}>${app.name}${countLabel}</option>`;
            }
            select.innerHTML = html;

            // Update badge
            updateAppHighlightBadge();
        }

        function onDailyAppSelect() {
            const select = document.getElementById('dailyAppSelect');
            const appKey = select.value;
            const dateKey = getDailyBriefDateKey();
            const history = loadAppHighlightHistory();

            if (appKey) {
                history[dateKey] = appKey;
            } else {
                delete history[dateKey];
            }
            saveAppHighlightHistory(history);
            updateAppHighlightBadge();
        }

        function updateAppHighlightBadge() {
            const badge = document.getElementById('appHighlightCountBadge');
            const select = document.getElementById('dailyAppSelect');
            if (!badge || !select) return;

            const appKey = select.value;
            if (appKey) {
                const count = getAppUsageCount(appKey);
                badge.textContent = count > 0 ? `Featured ${count}` : 'First time!';
                badge.style.display = 'inline-block';
            } else {
                badge.style.display = 'none';
            }
        }

        function showGenerating(outputId) {
            document.getElementById(outputId).innerHTML = '<div class="marketing-generating">Generating...</div>';
        }

        function renderPostCard(outputId, text, type) {
            document.getElementById(outputId).innerHTML = `
                <div class="marketing-post-card">
                    <div class="post-text">${text}</div>
                    <div class="marketing-post-actions">
                        <button class="copilot-post-btn approve" onclick="copyPostText(this)"> Copy</button>
                        <button class="copilot-post-btn regenerate" onclick="generatePost()"> Redo</button>
                        <button class="copilot-post-btn post-to-x-btn" onclick="postToX(this)"> Post</button>
                    </div>
                </div>`;
        }

        function copyPostText(btn) {
            const text = btn.closest('.marketing-post-card').querySelector('.post-text').textContent;
            navigator.clipboard.writeText(text);
            btn.textContent = ' Copied';
            setTimeout(() => btn.textContent = ' Copy', 2000);
        }

        // --- Post to X ---
        async function postToX(btn) {
            const card = btn.closest('.marketing-post-card') || btn.closest('.thread-card');
            const text = card.querySelector('.post-text').textContent.trim();
            if (!text) return;
            btn.classList.add('posting');
            btn.textContent = ' Posting...';
            btn.disabled = true;
            try {
                const resp = await fetch('/api/post-to-x', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text })
                });
                const data = await resp.json();
                if (data.success) {
                    btn.textContent = ' Posted';
                    btn.style.color = '#22c55e';
                } else {
                    btn.textContent = ' Failed';
                    btn.style.color = '#ef4444';
                    console.error('Post to X failed:', data);
                }
            } catch (err) {
                btn.textContent = ' Error';
                btn.style.color = '#ef4444';
                console.error('Post to X error:', err);
            }
            setTimeout(() => {
                btn.classList.remove('posting');
                btn.disabled = false;
                btn.textContent = ' Post';
                btn.style.color = '';
            }, 3000);
        }

        function renderThreadCards(outputId, text) {
            const tweets = text.split(/\n/).filter(l => l.match(/^\d+\//)).map(l => l.replace(/^\d+\/\s*/, '').trim());
            if (!tweets.length) {
                renderPostCard(outputId, text, 'thread');
                return;
            }
            let html = '';
            tweets.forEach((t, i) => {
                html += `<div class="thread-card" data-thread-index="${i}">
                    <span class="thread-number">${i + 1}/${tweets.length}</span>
                    <div class="post-text">${t}</div>
                    <div class="marketing-post-actions">
                        <button class="copilot-post-btn approve" onclick="copyPostText(this)"> Copy</button>
                    </div>
                </div>`;
            });
            html += `<div class="thread-actions-bottom">
                <button class="marketing-generate-btn" onclick="postThreadToX(this)" style="background: linear-gradient(135deg, #1d9bf0, #0a66c2);">
                     Post Thread
                </button>
            </div>`;
            document.getElementById(outputId).innerHTML = html;
        }

        async function postThreadToX(btn) {
            const container = btn.closest('.marketing-col-output');
            const cards = container.querySelectorAll('.thread-card');
            if (!cards.length) return;
            btn.disabled = true;
            btn.textContent = ' Posting thread...';
            let lastTweetId = null;
            let success = true;
            for (const card of cards) {
                const text = card.querySelector('.post-text').textContent.trim();
                try {
                    const body = { text };
                    if (lastTweetId) body.reply = { in_reply_to_tweet_id: lastTweetId };
                    const endpoint = lastTweetId ? '/api/x-reply' : '/api/post-to-x';
                    const resp = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await resp.json();
                    if (data.success || data.tweetId) {
                        lastTweetId = data.tweetId;
                        card.style.borderColor = '#22c55e';
                    } else {
                        card.style.borderColor = '#ef4444';
                        success = false;
                        break;
                    }
                } catch (err) {
                    card.style.borderColor = '#ef4444';
                    success = false;
                    break;
                }
            }
            btn.textContent = success ? ' Thread Posted' : ' Thread Failed';
            btn.style.color = success ? '#22c55e' : '#ef4444';
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = ' Post Thread';
                btn.style.color = '';
            }, 3000);
        }

        // --- Engagement ---
        const engagementPresets = {
            'ai-builders': { keywords: '"AI tools" OR "building with AI" OR "AI startup"', minLikes: 5 },
            'no-code': { keywords: '"no-code" OR "nocode" OR "low-code" OR "build without coding"', minLikes: 3 },
            'indie-hackers': { keywords: '"indie hacker" OR "side project" OR "shipping" OR "launched"', minLikes: 5 },
            'saas': { keywords: '"SaaS" OR "micro-saas" OR "MRR" OR "ARR"', minLikes: 10 },
            'ai-agents': { keywords: '"AI agents" OR "autonomous agents" OR "agentic" OR "agent framework"', minLikes: 5 },
            'tech-twitter': { keywords: '"developers" OR "open source" OR "dev tools" OR "API"', minLikes: 3 }
        };

        function applyPreset(name) {
            const preset = engagementPresets[name];
            if (!preset) return;
            document.getElementById('engagementKeywords').value = preset.keywords;
            document.getElementById('engMinLikes').value = preset.minLikes;
            // Show advanced filters so user sees what changed
            const panel = document.getElementById('engagementFilters');
            if (panel.style.display === 'none') toggleAdvancedFilters();
        }

        function toggleAdvancedFilters() {
            const panel = document.getElementById('engagementFilters');
            const btn = panel.previousElementSibling;
            if (panel.style.display === 'none') {
                panel.style.display = 'flex';
                btn.textContent = ' Advanced Filters';
                btn.classList.add('open');
            } else {
                panel.style.display = 'none';
                btn.textContent = ' Advanced Filters';
                btn.classList.remove('open');
            }
        }

        function buildSearchQuery() {
            const keywords = document.getElementById('engagementKeywords').value.trim();
            const params = new URLSearchParams();
            params.set('q', keywords);
            params.set('max_results', document.getElementById('engMaxResults')?.value || '20');
            if (document.getElementById('engExcludeRetweets')?.checked) params.set('exclude_retweets', '1');
            if (document.getElementById('engExcludeReplies')?.checked) params.set('exclude_replies', '1');
            if (document.getElementById('engExcludeQuotes')?.checked) params.set('exclude_quotes', '1');
            if (document.getElementById('engHasLinks')?.checked) params.set('has_links', '1');
            if (document.getElementById('engHasMedia')?.checked) params.set('has_media', '1');
            if (document.getElementById('engHasHashtags')?.checked) params.set('has_hashtags', '1');
            const minLikes = parseInt(document.getElementById('engMinLikes')?.value) || 0;
            const minRetweets = parseInt(document.getElementById('engMinRetweets')?.value) || 0;
            const minReplies = parseInt(document.getElementById('engMinReplies')?.value) || 0;
            if (minLikes > 0) params.set('min_likes', minLikes);
            if (minRetweets > 0) params.set('min_retweets', minRetweets);
            if (minReplies > 0) params.set('min_replies', minReplies);
            const lang = document.getElementById('engLang')?.value;
            if (lang) params.set('lang', lang);
            const fromUser = document.getElementById('engFromUser')?.value.trim().replace(/^@/, '');
            if (fromUser) params.set('from_user', fromUser);
            return params.toString();
        }

        async function fetchEngagementTweets() {
            const keywords = document.getElementById('engagementKeywords').value.trim();
            if (!keywords) { alert('Enter some keywords first.'); return; }

            const list = document.getElementById('engagementTweetList');
            list.innerHTML = '<div class="marketing-generating">Fetching tweets...</div>';

            try {
                const queryString = buildSearchQuery();
                const resp = await fetch(`/api/x-search?${queryString}`);
                const data = await resp.json();
                if (!data.tweets || !data.tweets.length) {
                    list.innerHTML = '<span class="github-empty">No tweets found for those keywords</span>';
                    return;
                }
                // Filter out seen tweets
                const seen = JSON.parse(localStorage.getItem('engagementSeenTweets') || '[]');
                const fresh = data.tweets.filter(t => !seen.includes(t.id));
                if (!fresh.length) {
                    list.innerHTML = '<span class="github-empty">No new tweets  try different keywords</span>';
                    return;
                }
                // Mark as seen
                const newSeen = [...seen, ...fresh.map(t => t.id)].slice(-200);
                localStorage.setItem('engagementSeenTweets', JSON.stringify(newSeen));

                list.innerHTML = fresh.map(t => `
                    <div class="engagement-tweet-card" data-tweet-id="${t.id}">
                        <div class="engagement-tweet-author">
                            <div class="engagement-tweet-avatar">${(t.author_name || '?')[0]}</div>
                            <span class="engagement-tweet-handle">@${t.author_username || 'unknown'}</span>
                            <span class="engagement-tweet-followers">${t.followers ? t.followers.toLocaleString() + ' followers' : ''}</span>
                        </div>
                        <div class="engagement-tweet-text">${t.text}</div>
                        <button class="marketing-generate-btn" style="font-size:0.78rem; padding:7px;" onclick="generateReplyOptions('${t.id}', this)">
                             Generate Reply
                        </button>
                        <div class="engagement-reply-options" id="replies-${t.id}"></div>
                    </div>
                `).join('');
            } catch (err) {
                list.innerHTML = '<span class="github-empty">Error fetching tweets</span>';
                console.error('Fetch tweets error:', err);
            }
        }

        async function generateReplyOptions(tweetId, btn) {
            const card = btn.closest('.engagement-tweet-card');
            const tweetText = card.querySelector('.engagement-tweet-text').textContent;
            const authorHandle = card.querySelector('.engagement-tweet-handle').textContent;
            const repliesDiv = document.getElementById(`replies-${tweetId}`);

            btn.disabled = true;
            btn.textContent = 'Generating...';

            const prompt = `Generate exactly 3 short reply options (each under 280 chars) for this tweet.
Tweet by ${authorHandle}: "${tweetText}"

Brand: SUITE (suitegpt.app) - Anyone Can Build, Everyone Gets Paid.
Tone: casual, helpful, not salesy. Be genuine and add value.

Format:
1) First reply
2) Second reply
3) Third reply

Return ONLY the 3 numbered replies, nothing else.`;

            const response = await callCopilotAI(prompt);
            const replies = response.split(/\n/).filter(l => l.match(/^\d\)/)).map(l => l.replace(/^\d\)\s*/, '').trim());

            if (replies.length) {
                repliesDiv.innerHTML = replies.map(r => `
                    <div class="engagement-reply-option">
                        <div class="engagement-reply-text">${r}</div>
                        <button class="engagement-reply-btn" onclick="postReply('${tweetId}', this)">Reply</button>
                    </div>
                `).join('');
            } else {
                repliesDiv.innerHTML = `<div class="engagement-reply-option">
                    <div class="engagement-reply-text">${response}</div>
                    <button class="engagement-reply-btn" onclick="postReply('${tweetId}', this)">Reply</button>
                </div>`;
            }

            btn.disabled = false;
            btn.textContent = ' Generate Reply';
        }

        async function postReply(tweetId, btn) {
            const text = btn.closest('.engagement-reply-option').querySelector('.engagement-reply-text').textContent.trim();
            btn.disabled = true;
            btn.textContent = 'Posting...';
            try {
                const resp = await fetch('/api/x-reply', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text, in_reply_to_tweet_id: tweetId })
                });
                const data = await resp.json();
                if (data.success) {
                    btn.textContent = ' Replied';
                    btn.style.color = '#22c55e';
                } else {
                    btn.textContent = ' Failed';
                    btn.style.color = '#ef4444';
                }
            } catch (err) {
                btn.textContent = ' Error';
                btn.style.color = '#ef4444';
            }
            setTimeout(() => {
                btn.disabled = false;
                btn.textContent = 'Reply';
                btn.style.color = '';
            }, 3000);
        }

        async function callCopilotAI(userMessage, options = {}) {
            let brandSection = 'Casual, authentic, "building in public" vibes. No corporate speak.';
            if (brandVoice) {
                brandSection = `
Tone: ${brandVoice.tone || 'casual, authentic'}
Words to USE: ${(brandVoice.use_words || []).join(', ')}
Words to AVOID: ${(brandVoice.avoid_words || []).join(', ')}
Style: ${brandVoice.style_notes || 'Short punchy sentences.'}`;
            }

            const systemPrompt = `You are a social media content generator for SUITE (suitegpt.app).

IMPORTANT BRANDING:
- The product is "SuiteGPT" or "SUITE" - never "iSuiteGPT"
- The website is suitegpt.app
- Tagline: "Anyone Can Build. Everyone Gets Paid."

Brand voice:
${brandSection}

Generate exactly what is asked. Return ONLY the post text, no extra commentary.`;

            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: userMessage,
                    model: options.model || 'gemini-2.5-flash',
                    systemInstruction: systemPrompt,
                    generationConfig: {
                        temperature: options.temperature ?? 0.8,
                        maxOutputTokens: options.maxTokens ?? 512
                    }
                })
            });

            const data = await response.json();
            return data.text || "I'm having trouble responding right now.";
        }

        async function parseAndSavePosts(aiResponse) {
            // Parse posts from AI response using ---POST--- format
            const postRegex = /---POST---\s*\nplatform:\s*(x|linkedin)\s*\ntime:\s*([^\n]+)\s*\ncontent:\s*([\s\S]*?)---END---/gi;
            const matches = [...aiResponse.matchAll(postRegex)];

            if (matches.length === 0) {
                console.log('[Copilot] No structured posts found in response');
                return;
            }

            const today = new Date().toISOString().split('T')[0];
            const posts = [];

            for (const match of matches) {
                const platform = match[1].toLowerCase();
                const timeStr = match[2].trim();
                const content = match[3].trim();

                // Parse time string (e.g., "9:00 AM" -> "09:00:00")
                let time = '12:00:00';
                const timeMatch = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)?/i);
                if (timeMatch) {
                    let hours = parseInt(timeMatch[1]);
                    const minutes = timeMatch[2];
                    const ampm = timeMatch[3]?.toUpperCase();
                    if (ampm === 'PM' && hours < 12) hours += 12;
                    if (ampm === 'AM' && hours === 12) hours = 0;
                    time = `${hours.toString().padStart(2, '0')}:${minutes}:00`;
                }

                posts.push({
                    date: today,
                    time: time,
                    cadence: platform === 'x' ? 'x-posts' : 'linkedin-posts',
                    platform: platform,
                    content: content,
                    status: 'draft'
                });
            }

            console.log('[Copilot] Parsed posts:', posts);

            // Save to Supabase
            if (supabaseClient && posts.length > 0) {
                try {
                    const { data, error } = await supabaseClient
                        .from('marketing_posts')
                        .insert(posts)
                        .select();

                    if (error) {
                        console.error('[Copilot] Error saving posts:', error);
                    } else {
                        console.log('[Copilot] Saved posts:', data);
                        // Refresh the calendar to show new posts
                        await loadCalendarPosts();
                        renderCalendar();
                    }
                } catch (err) {
                    console.error('[Copilot] Error saving posts:', err);
                }
            }
        }

        async function loadCalendarPosts() {
            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from('marketing_posts')
                    .select('*')
                    .order('date', { ascending: true })
                    .order('time', { ascending: true });

                if (data) {
                    window.calendarPosts = data;
                    console.log('[Calendar] Loaded posts:', data.length);
                }
            } catch (err) {
                console.error('[Calendar] Error loading posts:', err);
            }
        }

        // Old copilot functions removed - replaced by 3-column dashboard

        // ========== Content Calendar ==========
        let calendarView = 'month';
        let calendarDate = new Date();
        let selectedDate = new Date();
        window.calendarPosts = []; // Posts from database

        async function initCalendar() {
            await loadCalendarPosts();
            loadMarketingSchedule();
            renderCalendar();
        }

        function switchCalendarView(view) {
            calendarView = view;

            // Update tabs
            document.querySelectorAll('.calendar-view-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.view === view);
            });

            // Update views
            document.getElementById('calendarMonthView').style.display = view === 'month' ? 'block' : 'none';
            document.getElementById('calendarWeekView').style.display = view === 'week' ? 'block' : 'none';
            document.getElementById('calendarDayView').style.display = view === 'day' ? 'block' : 'none';

            renderCalendar();
        }

        function navigateCalendar(direction) {
            if (calendarView === 'month') {
                calendarDate.setMonth(calendarDate.getMonth() + direction);
                generateMonthSchedule(); // Populate cadence slots for new month (also renders)
                return;
            } else if (calendarView === 'week') {
                calendarDate.setDate(calendarDate.getDate() + (direction * 7));
            } else if (calendarView === 'day') {
                calendarDate.setDate(calendarDate.getDate() + direction);
                selectedDate = new Date(calendarDate);
            }
            renderCalendar();
        }

        function renderCalendar() {
            updateCalendarHeader();

            if (calendarView === 'month') {
                renderMonthView();
            } else if (calendarView === 'week') {
                renderScheduleGrid();
            } else if (calendarView === 'day') {
                renderDayView();
            }
        }

        function updateCalendarHeader() {
            const header = document.getElementById('calendarCurrent');
            if (!header) return;

            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

            if (calendarView === 'month') {
                header.textContent = `${months[calendarDate.getMonth()]} ${calendarDate.getFullYear()}`;
            } else if (calendarView === 'week') {
                const weekStart = new Date(calendarDate);
                weekStart.setDate(calendarDate.getDate() - calendarDate.getDay());
                const weekEnd = new Date(weekStart);
                weekEnd.setDate(weekStart.getDate() + 6);
                header.textContent = `${months[weekStart.getMonth()]} ${weekStart.getDate()} - ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
            } else if (calendarView === 'day') {
                const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
                header.textContent = `${days[selectedDate.getDay()]}, ${months[selectedDate.getMonth()]} ${selectedDate.getDate()}`;
            }
        }

        function renderMonthView() {
            const grid = document.getElementById('calendarMonthGrid');
            if (!grid) return;

            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            // Get first day of month and total days
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDayOfWeek = firstDay.getDay();
            const totalDays = lastDay.getDate();

            // Get today for highlighting
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];

            let html = '';

            // Previous month days
            const prevMonthLast = new Date(year, month, 0).getDate();
            for (let i = startDayOfWeek - 1; i >= 0; i--) {
                const day = prevMonthLast - i;
                const date = new Date(year, month - 1, day);
                const dateKey = date.toISOString().split('T')[0];
                html += renderCalendarDay(dateKey, day, true);
            }

            // Current month days
            for (let day = 1; day <= totalDays; day++) {
                const date = new Date(year, month, day);
                const dateKey = date.toISOString().split('T')[0];
                const isToday = dateKey === todayStr;
                const isSelected = dateKey === selectedDate.toISOString().split('T')[0];
                html += renderCalendarDay(dateKey, day, false, isToday, isSelected);
            }

            // Next month days to fill grid
            const totalCells = Math.ceil((startDayOfWeek + totalDays) / 7) * 7;
            const nextMonthDays = totalCells - (startDayOfWeek + totalDays);
            for (let day = 1; day <= nextMonthDays; day++) {
                const date = new Date(year, month + 1, day);
                const dateKey = date.toISOString().split('T')[0];
                html += renderCalendarDay(dateKey, day, true);
            }

            grid.innerHTML = html;
        }

        function getPostsForDate(dateKey) {
            // Merge Supabase posts + local cadence schedule
            const dbPosts = (window.calendarPosts || []).filter(p => p.date === dateKey);
            const localPosts = (marketingSchedule[dateKey] || []).map(p => ({
                ...p,
                date: dateKey,
                platform: p.cadence === 'linkedin-posts' ? 'linkedin' : 'x'
            }));
            return dbPosts.length ? dbPosts : localPosts;
        }

        function renderCalendarDay(dateKey, dayNum, isOtherMonth, isToday = false, isSelected = false) {
            const posts = getPostsForDate(dateKey);
            const classes = ['calendar-day'];
            if (isOtherMonth) classes.push('other-month');
            if (isToday) classes.push('today');
            if (isSelected) classes.push('selected');

            // Show up to 3 posts, then "+N more"
            const visiblePosts = posts.slice(0, 3);
            const morePosts = posts.length - 3;

            let postsHtml = visiblePosts.map(post => {
                const cadence = CADENCES[post.cadence];
                const icon = cadence?.icon || (post.platform === 'x' ? '' : '');
                return `<div class="calendar-day-post ${post.status}">${icon} ${formatTime(post.time)}</div>`;
            }).join('');

            if (morePosts > 0) {
                postsHtml += `<div class="calendar-day-more">+${morePosts} more</div>`;
            }

            // Theme label from daily brief
            const brief = dailyBriefs[dateKey];
            const themeHtml = brief?.theme ? `<div class="calendar-day-theme">${brief.theme}</div>` : '';

            return `
                <div class="${classes.join(' ')}" onclick="selectCalendarDate('${dateKey}')">
                    <div class="calendar-day-number">${dayNum}</div>
                    ${themeHtml}
                    <div class="calendar-day-posts">${postsHtml}</div>
                </div>
            `;
        }

        function selectCalendarDate(dateKey) {
            selectedDate = new Date(dateKey + 'T00:00:00');
            calendarDate = new Date(selectedDate);

            // Switch to day view
            switchCalendarView('day');
        }

        function renderDayView() {
            const headerEl = document.getElementById('dayViewHeader');
            const postsEl = document.getElementById('dayViewPosts');
            if (!headerEl || !postsEl) return;

            const dateKey = selectedDate.toISOString().split('T')[0];
            const posts = getPostsForDate(dateKey);

            const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const months = ['January', 'February', 'March', 'April', 'May', 'June',
                           'July', 'August', 'September', 'October', 'November', 'December'];

            const brief = dailyBriefs[dateKey];
            const briefHtml = brief?.theme ? `<div style="color:var(--accent-primary);font-size:0.82rem;font-weight:600;margin-top:4px;">${brief.theme}</div>` : '';

            headerEl.innerHTML = `
                <div class="day-view-date">${months[selectedDate.getMonth()]} ${selectedDate.getDate()}, ${selectedDate.getFullYear()}</div>
                <div class="day-view-label">${days[selectedDate.getDay()]}  ${posts.length} post${posts.length !== 1 ? 's' : ''} scheduled</div>
                ${briefHtml}
            `;

            if (posts.length === 0) {
                postsEl.innerHTML = `
                    <div class="day-view-empty">
                        <p>No posts scheduled for this day</p>
                        <p style="font-size: 0.85rem; color: var(--text-tertiary);">Ask the Co-Pilot to generate content!</p>
                    </div>
                `;
                return;
            }

            postsEl.innerHTML = posts.map(post => {
                const icon = post.platform === 'x' ? '' : '';
                const platformName = post.platform === 'x' ? 'X Post' : 'LinkedIn';
                const preview = post.content ? post.content.substring(0, 150) + (post.content.length > 150 ? '...' : '') : 'No content yet';

                return `
                    <div class="day-view-post" onclick="openPostModal('${post.id}')">
                        <div class="day-view-post-header">
                            <span class="day-view-post-time">${formatTime(post.time)}</span>
                            <span class="day-view-post-platform">${icon}</span>
                            <span class="day-view-post-type">${platformName}</span>
                            <span class="day-view-post-status ${post.status}">${post.status}</span>
                        </div>
                        <div class="day-view-post-content ${post.content ? '' : 'empty'}">${preview}</div>
                    </div>
                `;
            }).join('');
        }

        function loadMarketingSchedule() {
            const saved = localStorage.getItem('marketing_schedule');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Check if old format (has colons in IDs) - regenerate if so
                const firstKey = Object.keys(parsed)[0];
                const firstPost = parsed[firstKey]?.[0];
                if (firstPost && firstPost.id && firstPost.id.includes(':')) {
                    console.log('[Marketing] Old format detected, regenerating...');
                    generateWeekSchedule();
                } else {
                    marketingSchedule = parsed;
                }
            } else {
                generateWeekSchedule();
            }
        }

        function saveMarketingSchedule() {
            localStorage.setItem('marketing_schedule', JSON.stringify(marketingSchedule));
        }

        function generateWeekSchedule() {
            generateMonthSchedule();
        }

        function generateMonthSchedule() {
            // Preserve any posts that already have content
            const oldSchedule = { ...marketingSchedule };
            marketingSchedule = {};

            // Generate 6 weeks centered on current month (covers full month view)
            const today = new Date();
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            const firstOfMonth = new Date(year, month, 1);
            const startDate = new Date(firstOfMonth);
            startDate.setDate(startDate.getDate() - firstOfMonth.getDay()); // Start from Sunday

            for (let i = 0; i < 42; i++) { // 6 weeks = 42 days
                const date = new Date(startDate);
                date.setDate(startDate.getDate() + i);
                const dateKey = date.toISOString().split('T')[0];
                const dayOfWeek = date.getDay();
                marketingSchedule[dateKey] = [];

                Object.entries(CADENCES).forEach(([cadenceId, cadence]) => {
                    if (cadence.days.includes(dayOfWeek)) {
                        cadence.times.forEach(time => {
                            const timeId = time.replace(':', '');
                            const postId = `${dateKey}_${cadenceId}_${timeId}`;
                            // Preserve existing content if it was already drafted
                            const oldPost = (oldSchedule[dateKey] || []).find(p => p.id === postId);
                            marketingSchedule[dateKey].push(oldPost || {
                                id: postId,
                                cadence: cadenceId,
                                time: time,
                                status: 'empty',
                                content: '',
                                image: null
                            });
                        });
                    }
                });

                marketingSchedule[dateKey].sort((a, b) => a.time.localeCompare(b.time));
            }

            saveMarketingSchedule();
            renderCalendar();
        }

        function renderScheduleGrid() {
            const grid = document.getElementById('scheduleGrid');
            console.log('[Marketing] renderScheduleGrid - grid element:', grid);
            if (!grid) { console.log('[Marketing] ERROR: scheduleGrid not found!'); return; }

            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const today = new Date();
            const startOfWeek = new Date(today);
            startOfWeek.setDate(today.getDate() - today.getDay());

            let html = '';
            for (let d = 0; d < 7; d++) {
                const date = new Date(startOfWeek);
                date.setDate(startOfWeek.getDate() + d);
                const dateKey = date.toISOString().split('T')[0];
                const posts = marketingSchedule[dateKey] || [];
                const isWeekend = d === 0 || d === 6;

                html += `
                    <div class="schedule-day ${isWeekend ? 'weekend' : ''}">
                        <div class="schedule-day-header">
                            <span>${days[d]}</span>
                            <span class="schedule-day-date">${date.getDate()}</span>
                        </div>
                        <div class="schedule-posts">
                            ${posts.map(post => renderSchedulePost(post)).join('')}
                        </div>
                    </div>
                `;
            }

            grid.innerHTML = html;
            console.log('[Marketing] Grid rendered with HTML length:', html.length);
        }

        function renderSchedulePost(post) {
            const cadence = CADENCES[post.cadence];
            const preview = post.content ? post.content.substring(0, 30) + '...' : '';

            return `
                <div class="schedule-post ${post.status}" onclick="openPostModal('${post.id}')">
                    <div class="schedule-post-time">${formatTime(post.time)}</div>
                    <div class="schedule-post-type">
                        <span>${cadence?.icon || ''}</span>
                        <span>${cadence?.name || 'Post'}</span>
                    </div>
                    ${post.status === 'empty' ? '<div style="margin-top:4px">+ Add</div>' : ''}
                    ${preview ? `<div class="schedule-post-preview">${preview}</div>` : ''}
                </div>
            `;
        }

        function formatTime(time) {
            const [h, m] = time.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}${m !== '00' ? ':' + m : ''} ${ampm}`;
        }

        function openPostModal(postId) {
            console.log('[Marketing] openPostModal called with:', postId);
            console.log('[Marketing] Full schedule:', marketingSchedule);
            currentPostId = postId;
            const parts = postId.split('_');
            const dateKey = parts[0];
            console.log('[Marketing] Looking for dateKey:', dateKey);
            const posts = marketingSchedule[dateKey] || [];
            console.log('[Marketing] Posts for date:', posts);
            const post = posts.find(p => p.id === postId);

            if (!post) { console.log('[Marketing] Post not found:', postId, 'in', posts.map(p => p.id)); return; }

            const cadence = CADENCES[post.cadence];
            const date = new Date(dateKey + 'T' + post.time);

            document.getElementById('postModalIcon').textContent = cadence?.icon || '';
            document.getElementById('postModalTitle').textContent = cadence?.name || 'Post';
            document.getElementById('postModalDate').textContent = date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ', ' + formatTime(post.time);
            document.getElementById('postCadenceName').textContent = cadence?.name || 'Unknown';
            document.getElementById('postContentInput').value = post.content || '';

            const badge = document.getElementById('postStatusBadge');
            badge.textContent = post.status.toUpperCase();
            badge.className = 'post-status-badge ' + post.status;

            if (isMarketingAdmin()) {
                document.getElementById('postStatusSelect').value = post.status;
            }

            const preview = document.getElementById('imagePreview');
            if (post.image) {
                document.getElementById('previewImg').src = post.image;
                preview.style.display = 'block';
            } else {
                preview.style.display = 'none';
            }

            // Clear AI context input
            document.getElementById('aiContextInput').value = '';

            // Render proposals for this post
            renderProposals();

            // Hide propose form by default
            hideProposeForm();

            // Show/hide publish section for admins
            const publishSection = document.getElementById('postPublishSection');
            if (publishSection) {
                publishSection.style.display = isMarketingAdmin() ? 'block' : 'none';
            }

            // Clear publish status
            const publishStatus = document.getElementById('publishStatus');
            if (publishStatus) {
                publishStatus.textContent = '';
                publishStatus.className = 'publish-status';
            }

            document.getElementById('postModalOverlay').classList.add('active');
        }

        function closePostModal(e) {
            if (e && e.target !== e.currentTarget) return;
            document.getElementById('postModalOverlay').classList.remove('active');
            currentPostId = null;
        }

        function savePostContent() {
            if (!currentPostId) return;
            const [dateKey] = currentPostId.split('_');
            const posts = marketingSchedule[dateKey];
            const post = posts?.find(p => p.id === currentPostId);

            if (post) {
                post.content = document.getElementById('postContentInput').value;
                if (post.content && post.status === 'empty') {
                    post.status = 'draft';
                }
                saveMarketingSchedule();
                renderScheduleGrid();
                closePostModal();
            }
        }

        function copyPostContent() {
            const content = document.getElementById('postContentInput').value;
            navigator.clipboard.writeText(content);
            alert('Content copied to clipboard!');
        }

        function updatePostStatus(status) {
            if (!currentPostId || !isMarketingAdmin()) return;
            const [dateKey] = currentPostId.split('_');
            const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
            if (post) {
                post.status = status;
                saveMarketingSchedule();

                const badge = document.getElementById('postStatusBadge');
                badge.textContent = status.toUpperCase();
                badge.className = 'post-status-badge ' + status;
            }
        }

        function markAsReady() {
            updatePostStatus('ready');
            savePostContent();
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('previewImg').src = e.target.result;
                    document.getElementById('imagePreview').style.display = 'block';

                    if (currentPostId) {
                        const [dateKey] = currentPostId.split('_');
                        const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
                        if (post) {
                            post.image = e.target.result;
                            saveMarketingSchedule();
                        }
                    }
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function removeImage() {
            document.getElementById('imagePreview').style.display = 'none';
            document.getElementById('postImageInput').value = '';
            if (currentPostId) {
                const [dateKey] = currentPostId.split('_');
                const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
                if (post) {
                    post.image = null;
                    saveMarketingSchedule();
                }
            }
        }

        function toggleCadence(cadenceId, active) {
            const card = document.querySelector(`[data-cadence="${cadenceId}"]`);
            if (card) {
                card.dataset.active = active.toString();
            }
        }

        function proposeCadenceChange(cadenceId) {
            const cadence = CADENCES[cadenceId];
            const name = cadence?.name || cadenceId;
            const proposal = prompt(`Propose a change to "${name}" cadence:\n\nDescribe your proposed change (frequency, logic, timing, etc.):`);
            if (proposal && proposal.trim()) {
                alert(`Your proposal for "${name}" has been submitted!\n\nThis will appear in the governance queue for voting.`);
            }
        }

        // ========== PHASE 2: AI Generation & Proposals ==========

        // Storage for proposals
        let marketingProposals = {};

        function loadProposals() {
            try {
                const saved = localStorage.getItem('suite_marketing_proposals');
                if (saved) {
                    marketingProposals = JSON.parse(saved);
                }
            } catch (e) {
                console.log('[Marketing] Could not load proposals');
            }
        }

        function saveProposals() {
            localStorage.setItem('suite_marketing_proposals', JSON.stringify(marketingProposals));
        }

        // AI Draft Generation
        async function generateAIDraft() {
            const btn = document.getElementById('generateAiBtn');
            const btnText = document.getElementById('generateBtnText');
            const context = document.getElementById('aiContextInput').value.trim();

            if (!currentPostId) return;

            const [dateKey] = currentPostId.split('_');
            const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
            if (!post) return;

            const cadence = CADENCES[post.cadence];

            // Show loading state
            btn.disabled = true;
            btnText.innerHTML = '<span class="spinner"></span> Generating...';

            // Build prompt based on cadence type
            let prompt = `Write a social media post for ${cadence?.name || 'SUITE'}.`;

            if (post.cadence === 'x-posts') {
                prompt = `Write a short, engaging X (Twitter) post for SUITE - an AI-native app ecosystem. Keep it under 280 characters. Be authentic, not corporate. Focus on building in public vibes.`;
            } else if (post.cadence === 'app-highlights') {
                prompt = `Write a short X post highlighting a SUITE app. SUITE has 29+ apps including HydroTrack, FocusFlow, QuickBudget, etc. Pick one and write an engaging feature highlight. Keep it casual and authentic.`;
            } else if (post.cadence === 'ecosystem-updates') {
                prompt = `Write a brief ecosystem update for SUITE. Mention progress, new features, or community growth. Keep it under 280 characters and authentic.`;
            } else if (post.cadence === 'linkedin-posts') {
                prompt = `Write a professional but authentic LinkedIn post about building SUITE, an AI-native app ecosystem. Focus on the journey, lessons learned, or technical achievements. 2-3 short paragraphs max.`;
            }

            if (context) {
                prompt += ` Context for this post: ${context}`;
            }

            try {
                // Use the existing Gemini API endpoint
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: prompt,
                        temperature: 0.8
                    })
                });

                if (!response.ok) throw new Error('API error');

                const data = await response.json();
                const generatedText = data.text || data.response || '';

                if (generatedText) {
                    document.getElementById('postContentInput').value = generatedText;
                }
            } catch (err) {
                console.error('[Marketing] AI generation error:', err);
                // Fallback: generate a template
                let fallback = '';
                if (post.cadence === 'x-posts') {
                    fallback = ` Building in public update:\n\n${context || '[What did you ship today?]'}\n\n#buildinpublic #ai #suite`;
                } else if (post.cadence === 'linkedin-posts') {
                    fallback = `Building SUITE - Week Update\n\n${context || '[Share your progress]'}\n\nThe journey continues. `;
                } else {
                    fallback = `${context || 'Share your update here...'}`;
                }
                document.getElementById('postContentInput').value = fallback;
            }

            // Reset button
            btn.disabled = false;
            btnText.textContent = 'Generate Draft';
        }

        // Proposal System
        function showProposeForm() {
            document.getElementById('proposeForm').classList.add('active');
            document.getElementById('proposeEditBtn').style.display = 'none';
            document.getElementById('proposeTextarea').focus();
        }

        function hideProposeForm() {
            document.getElementById('proposeForm').classList.remove('active');
            document.getElementById('proposeEditBtn').style.display = 'block';
            document.getElementById('proposeTextarea').value = '';
        }

        function submitProposal() {
            if (!currentPostId) return;

            const content = document.getElementById('proposeTextarea').value.trim();
            if (!content) {
                alert('Please write some content for your proposal.');
                return;
            }

            // Get user info
            const email = localStorage.getItem('user_email') || '';
            const telegramUser = localStorage.getItem('telegram_user');
            const telegram = telegramUser ? JSON.parse(telegramUser) : null;
            const author = telegram?.username || email.split('@')[0] || 'Anonymous';

            // Create proposal
            if (!marketingProposals[currentPostId]) {
                marketingProposals[currentPostId] = [];
            }

            marketingProposals[currentPostId].push({
                id: Date.now().toString(),
                content: content,
                author: author,
                upvotes: 0,
                downvotes: 0,
                voters: [],
                timestamp: Date.now()
            });

            saveProposals();
            renderProposals();
            hideProposeForm();
        }

        function renderProposals() {
            const container = document.getElementById('postProposalsList');
            if (!currentPostId || !marketingProposals[currentPostId]?.length) {
                container.innerHTML = '<p class="no-proposals">No proposals yet - be the first!</p>';
                return;
            }

            const proposals = marketingProposals[currentPostId].sort((a, b) => (b.upvotes - b.downvotes) - (a.upvotes - a.downvotes));

            container.innerHTML = proposals.map(p => `
                <div class="proposal-card">
                    <div class="proposal-header">
                        <span class="proposal-author">@${p.author}  ${formatTimeAgo(p.timestamp)}</span>
                        <div class="proposal-votes">
                            <button class="proposal-vote-btn upvote" onclick="voteProposal('${p.id}', 'up')">
                                 ${p.upvotes}
                            </button>
                            <button class="proposal-vote-btn downvote" onclick="voteProposal('${p.id}', 'down')">
                                 ${p.downvotes}
                            </button>
                        </div>
                    </div>
                    <div class="proposal-content">${escapeHtml(p.content)}</div>
                    <div class="proposal-actions">
                        <button class="proposal-use-btn" onclick="useProposal('${p.id}')"> Use This</button>
                        ${isMarketingAdmin() ? `<button class="proposal-use-btn" onclick="deleteProposal('${p.id}')"> Delete</button>` : ''}
                    </div>
                </div>
            `).join('');
        }

        function voteProposal(proposalId, direction) {
            if (!currentPostId || !marketingProposals[currentPostId]) return;

            const proposal = marketingProposals[currentPostId].find(p => p.id === proposalId);
            if (!proposal) return;

            // Simple vote tracking (could use user ID in future)
            const voterId = localStorage.getItem('user_email') || 'anon';
            if (proposal.voters?.includes(voterId)) {
                return; // Already voted
            }

            proposal.voters = proposal.voters || [];
            proposal.voters.push(voterId);

            if (direction === 'up') {
                proposal.upvotes++;
            } else {
                proposal.downvotes++;
            }

            saveProposals();
            renderProposals();
        }

        function useProposal(proposalId) {
            if (!currentPostId || !marketingProposals[currentPostId]) return;

            const proposal = marketingProposals[currentPostId].find(p => p.id === proposalId);
            if (proposal) {
                document.getElementById('postContentInput').value = proposal.content;
            }
        }

        function deleteProposal(proposalId) {
            if (!currentPostId || !marketingProposals[currentPostId] || !isMarketingAdmin()) return;

            marketingProposals[currentPostId] = marketingProposals[currentPostId].filter(p => p.id !== proposalId);
            saveProposals();
            renderProposals();
        }

        function formatTimeAgo(timestamp) {
            const diff = Date.now() - timestamp;
            const mins = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);

            if (mins < 1) return 'just now';
            if (mins < 60) return `${mins}m ago`;
            if (hours < 24) return `${hours}h ago`;
            return `${days}d ago`;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ========== PHASE 3: API Publishing ==========

        async function publishToX() {
            if (!currentPostId || !isMarketingAdmin()) return;

            const content = document.getElementById('postContentInput').value.trim();
            if (!content) {
                alert('No content to post!');
                return;
            }

            const btn = document.getElementById('publishXBtn');
            const statusEl = document.getElementById('publishStatus');

            btn.disabled = true;
            statusEl.textContent = 'Publishing to X...';
            statusEl.className = 'publish-status';

            try {
                const response = await fetch('/api/post-to-x', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: content,
                        postId: currentPostId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.textContent = ' Posted to X successfully!';
                    statusEl.className = 'publish-status success';

                    // Update post status
                    updatePostStatus('posted');

                    // Store tweet ID
                    const [dateKey] = currentPostId.split('_');
                    const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
                    if (post) {
                        post.tweetId = data.tweetId;
                        post.postedAt = Date.now();
                        saveMarketingSchedule();
                    }
                } else {
                    throw new Error(data.error || 'Failed to post');
                }
            } catch (err) {
                console.error('[Marketing] X post error:', err);
                statusEl.textContent = ` Error: ${err.message}`;
                statusEl.className = 'publish-status error';
            }

            btn.disabled = false;
        }

        async function publishToLinkedIn() {
            if (!currentPostId || !isMarketingAdmin()) return;

            const content = document.getElementById('postContentInput').value.trim();
            if (!content) {
                alert('No content to post!');
                return;
            }

            const btn = document.getElementById('publishLinkedInBtn');
            const statusEl = document.getElementById('publishStatus');

            btn.disabled = true;
            statusEl.textContent = 'Publishing to LinkedIn...';
            statusEl.className = 'publish-status';

            try {
                const response = await fetch('/api/post-to-linkedin', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        text: content,
                        postId: currentPostId
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    statusEl.textContent = ' Posted to LinkedIn successfully!';
                    statusEl.className = 'publish-status success';

                    // Update post status
                    updatePostStatus('posted');

                    // Store post ID
                    const [dateKey] = currentPostId.split('_');
                    const post = marketingSchedule[dateKey]?.find(p => p.id === currentPostId);
                    if (post) {
                        post.linkedinId = data.postId;
                        post.postedAt = Date.now();
                        saveMarketingSchedule();
                    }
                } else {
                    throw new Error(data.error || 'Failed to post');
                }
            } catch (err) {
                console.error('[Marketing] LinkedIn post error:', err);
                statusEl.textContent = ` Error: ${err.message}`;
                statusEl.className = 'publish-status error';
            }

            btn.disabled = false;
        }

        // Load proposals on init
        loadProposals();

        // Initialize when switching to marketing view
        function switchFactorySection(section) {
            factoryCurrentSection = section;
            factoryAppFilter = 'all'; // Reset app filter when switching sections

            // Update tabs
            document.querySelectorAll('.factory-section-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.section === section);
            });

            // Toggle between governance layout and client requests panel
            var govLayout = document.getElementById('factoryGovernanceLayout');
            var crPanel = document.getElementById('clientRequestsPanel');
            if (section === 'client_requests') {
                if (govLayout) govLayout.style.display = 'none';
                if (crPanel) crPanel.style.display = 'block';
                loadClientRequests();
                checkClientsDaemonStatus();
            } else {
                if (govLayout) govLayout.style.display = '';
                if (crPanel) crPanel.style.display = 'none';
                renderFactoryProposals();
            }
        }

        async function loadFactoryProposals() {
            try {
                console.log('[Factory] Loading proposals from Supabase...');
                console.log('[Factory] SUPABASE_URL:', SUPABASE_URL);

                // Get all proposals
                const url = `${SUPABASE_URL}/rest/v1/factory_proposals?select=*&order=created_at.desc`;
                console.log('[Factory] Fetching:', url);

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                console.log('[Factory] Response status:', response.status);
                console.log('[Factory] Response ok:', response.ok);

                if (response.ok) {
                    factoryProposals = await response.json();
                    console.log('[Factory] Loaded proposals:', factoryProposals);
                    console.log('[Factory] Proposals count:', factoryProposals.length);

                    // Filter to governance sections client-side
                    factoryProposals = factoryProposals.filter(p =>
                        ['suite_apps', 'business', 'content', 'social'].includes(p.section)
                    );
                    console.log('[Factory] After filtering:', factoryProposals.length);

                    renderFactoryProposals();
                    updateFactoryCounts();

                    // Load user votes if logged in
                    if (getFactoryCurrentUser()) {
                        await loadFactoryUserVotes();
                    }
                } else {
                    const errorText = await response.text();
                    console.error('[Factory] Failed to load:', response.status, errorText);
                }
            } catch (error) {
                console.error('[Factory] Error loading proposals:', error);
            }
        }

        async function loadFactoryUserVotes() {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) return;

            try {
                const userId = await ensureFactoryUser();
                if (!userId) return;

                const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${userId}&select=proposal_id,vote_power`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${accessToken}`
                        }
                    }
                );

                if (response.ok) {
                    const votes = await response.json();
                    factoryUserVotes = {};
                    votes.forEach(v => {
                        factoryUserVotes[v.proposal_id] = v.vote_power;
                    });
                    renderFactoryProposals();
                }
            } catch (error) {
                console.error('Failed to load user votes:', error);
            }
        }

        function getFactoryCurrentUser() {
            // Check for Supabase auth via localStorage token
            const sbKey = 'sb-rdsmdywbdiskxknluiym-auth-token';
            const sbToken = localStorage.getItem(sbKey);
            if (sbToken) {
                try {
                    const session = JSON.parse(sbToken);
                    const user = session?.user;
                    if (user) {
                        return {
                            id: user.id,
                            supabase_id: user.id,
                            email: user.email,
                            display_name: user.user_metadata?.full_name || user.email?.split('@')[0] || 'User',
                            reputation: 0
                        };
                    }
                } catch (e) {
                    console.error('[Factory] Error parsing Supabase token:', e);
                }
            }
            // Check for telegram
            const tgUser = localStorage.getItem('telegram_user');
            if (tgUser) {
                try {
                    const user = JSON.parse(tgUser);
                    return {
                        id: user.id?.toString(),
                        telegram_id: user.id?.toString(),
                        display_name: user.username || user.first_name,
                        reputation: 0
                    };
                } catch (e) {
                    console.error('[Factory] Error parsing telegram user:', e);
                }
            }
            // Check for wallet
            const wallet = localStorage.getItem('connectedWallet');
            if (wallet) {
                return {
                    id: wallet,
                    wallet_address: wallet,
                    display_name: `${wallet.slice(0,6)}...${wallet.slice(-4)}`,
                    reputation: 0
                };
            }
            return null;
        }

        function updateFactoryCounts() {
            // Count proposals by section
            const sections = ['suite_apps', 'business', 'content', 'social'];
            sections.forEach(section => {
                const count = factoryProposals.filter(p => p.section === section).length;
                const el = document.getElementById(`factory${section.charAt(0).toUpperCase() + section.slice(1).replace('_', '')}Count`);
                if (el) el.textContent = count;
            });

            // Apps count
            document.getElementById('factoryAppsCount').textContent =
                factoryProposals.filter(p => p.section === 'suite_apps').length;
            document.getElementById('factoryBusinessCount').textContent =
                factoryProposals.filter(p => p.section === 'business').length;
            document.getElementById('factoryContentCount').textContent =
                factoryProposals.filter(p => p.section === 'content').length;
            document.getElementById('factorySocialCount').textContent =
                factoryProposals.filter(p => p.section === 'social').length;

            // Client requests count (async, separate query)
            updateClientRequestsCount();

            // Agent count
            const agentCount = factoryProposals.filter(p => p.from_agent === true).length;
            const agentsCountEl = document.getElementById('factoryAgentsCount');
            if (agentsCountEl) agentsCountEl.textContent = agentCount;
        }

        function renderFactoryProposals() {
            // Show/hide sidebar based on section (only show for suite_apps)
            const sidebar = document.getElementById('factoryAppFilterSidebar');
            if (sidebar) {
                sidebar.style.display = factoryCurrentSection === 'suite_apps' ? 'block' : 'none';
            }

            // Update the sidebar filter
            renderFactoryAppFilter();

            const sectionProposals = factoryProposals.filter(p => p.section === factoryCurrentSection);

            // Apply app filter
            const filteredProposals = sectionProposals.filter(p => {
                if (factoryAppFilter === 'all') return true;
                if (factoryAppFilter === 'new_app') return p.is_new_app || p.app_slug === 'new_app';
                if (factoryAppFilter === 'general') return !p.is_new_app && (!p.app_slug || p.app_slug === '');
                return p.app_slug === factoryAppFilter && !p.is_new_app;
            });

            const submitted = filteredProposals.filter(p => p.status === 'submitted');
            const voting = filteredProposals.filter(p => p.status === 'open_voting');
            const working = filteredProposals.filter(p => p.status === 'working_on');
            const implemented = filteredProposals.filter(p =>
                p.status === 'passed' || p.status === 'implemented'
            );

            // Split submitted into new app ideas vs refinements
            const newAppIdeas = submitted.filter(p => p.is_new_app || p.app_slug === 'new_app');
            const refinements = submitted.filter(p => !p.is_new_app && p.app_slug !== 'new_app');

            // Update column counts
            document.getElementById('factorySubmittedCount').textContent = submitted.length;
            document.getElementById('factoryNewAppsCount').textContent = newAppIdeas.length;
            document.getElementById('factoryRefinementsCount').textContent = refinements.length;
            document.getElementById('factoryVotingCount').textContent = voting.length;
            document.getElementById('factoryWorkingCount').textContent = working.length;
            document.getElementById('factoryImplementedCount').textContent = implemented.length;

            // Render new app ideas
            document.getElementById('factoryNewAppsCards').innerHTML =
                newAppIdeas.length ? newAppIdeas.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No new app ideas yet</p></div>';

            // Render refinements
            document.getElementById('factoryRefinementsCards').innerHTML =
                refinements.length ? refinements.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No refinements yet</p></div>';

            document.getElementById('factoryVotingCards').innerHTML =
                voting.length ? voting.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No proposals in voting</p></div>';

            document.getElementById('factoryWorkingCards').innerHTML =
                working.length ? working.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No active work</p></div>';

            document.getElementById('factoryImplementedCards').innerHTML =
                implemented.length ? implemented.map(p => renderFactoryProposalCard(p)).join('') :
                '<div class="factory-empty-state"><div class="factory-empty-icon"></div><p>No implemented proposals</p></div>';
        }

        function switchSubmittedTab(tab) {
            // Update tab buttons
            document.querySelectorAll('.factory-submitted-tab').forEach(t => {
                t.classList.toggle('active', t.dataset.subtab === tab);
            });

            // Show/hide content
            document.getElementById('factoryNewAppsCards').classList.toggle('active', tab === 'newapps');
            document.getElementById('factoryNewAppsCards').style.display = tab === 'newapps' ? 'block' : 'none';
            document.getElementById('factoryRefinementsCards').classList.toggle('active', tab === 'refinements');
            document.getElementById('factoryRefinementsCards').style.display = tab === 'refinements' ? 'block' : 'none';
        }

        function isFactoryAdmin() {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) return false;
            // Check wallet
            if (currentUser.wallet_address) {
                if (ADMIN_WALLETS.includes(currentUser.wallet_address.toLowerCase())) return true;
            }
            // Check email (Gmail login)
            if (currentUser.email) {
                const email = currentUser.email.toLowerCase();
                if (email.includes('stuart') || email.includes('5915')) return true;
            }
            // Check Telegram
            const tgUser = localStorage.getItem('telegram_user');
            if (tgUser) {
                try {
                    const tg = JSON.parse(tgUser);
                    if (tg.username && tg.username.toLowerCase() === 'stuartdefi') return true;
                } catch (e) {}
            }
            return false;
        }

        function getSupabaseAccessToken() {
            const sbKey = 'sb-rdsmdywbdiskxknluiym-auth-token';
            const raw = localStorage.getItem(sbKey);
            if (raw) {
                try {
                    const session = JSON.parse(raw);
                    return session?.access_token || null;
                } catch (e) {}
            }
            return null;
        }

        async function deleteFactoryProposal(proposalId) {
            if (!confirm('Are you sure you want to delete this proposal?')) return;

            if (!isFactoryAdmin()) {
                alert('Admin access required');
                return;
            }

            // Use authenticated user JWT if available (needed for RLS)
            const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;
            console.log('[Factory] Deleting proposal:', proposalId, 'using JWT:', !!getSupabaseAccessToken());

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/factory_proposals?id=eq.${proposalId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Prefer': 'return=minimal'
                    }
                });

                console.log('[Factory] Delete response status:', response.status);

                if (response.ok || response.status === 204) {
                    await loadFactoryProposals();
                } else {
                    const errText = await response.text();
                    console.error('[Factory] Delete failed:', errText);
                    alert('Failed to delete proposal. RLS may block this action.');
                }
            } catch (err) {
                console.error('Delete error:', err);
                alert('Error deleting proposal');
            }
        }

        function renderFactoryProposalCard(proposal) {
            const category = FACTORY_CATEGORIES[proposal.category] || FACTORY_CATEGORIES.general;
            const authorName = proposal.author?.display_name || 'Anonymous';
            const votesFor = proposal.votes_for || 0;
            const userVoteCount = factoryUserVotes[proposal.id] || 0;
            const nextVoteCost = getFactoryVoteCost(userVoteCount + 1);
            const canVote = getFactoryCurrentUser() && ['submitted', 'open_voting'].includes(proposal.status);
            const isAdmin = isFactoryAdmin();
            const formattedDate = new Date(proposal.created_at).toLocaleDateString('en-US', {
                month: 'short',
                day: 'numeric'
            });

            // Generate app tag
            let appTag = '';
            if (proposal.is_new_app || proposal.app_slug === 'new_app') {
                appTag = '<span class="factory-app-tag new-app"> New App</span>';
            } else if (proposal.app_slug && proposal.app_slug !== '') {
                const app = factoryApps.find(a => a.slug === proposal.app_slug);
                const appName = app ? app.name : proposal.app_slug;
                appTag = `<span class="factory-app-tag"> ${escapeFactoryHtml(appName)}</span>`;
            } else {
                appTag = '<span class="factory-app-tag general"> General</span>';
            }

            // Admin delete button
            const adminControls = isAdmin ? `
                <button class="factory-admin-delete" onclick="event.stopPropagation(); deleteFactoryProposal('${proposal.id}')" title="Delete proposal">
                    
                </button>
            ` : '';

            return `
                <div class="factory-proposal-card" data-id="${proposal.id}" onclick="toggleProposalExpand(this, event)">
                    ${adminControls}
                    ${appTag}
                    <div class="factory-proposal-category">${category.emoji} ${category.label}</div>
                    <div class="factory-proposal-title">${escapeFactoryHtml(proposal.title || 'Untitled')}</div>
                    <div class="factory-proposal-content">${escapeFactoryHtml(proposal.content || '')}</div>
                    <div class="factory-proposal-meta">
                        <span class="factory-proposal-author"> ${escapeFactoryHtml(authorName)}</span>
                        <span> ${formattedDate}</span>
                    </div>
                    <div class="factory-vote-buttons">
                        <button class="factory-vote-btn for ${userVoteCount > 0 ? 'voted' : ''}" onclick="event.stopPropagation(); addFactoryVote('${proposal.id}')" ${!canVote ? 'disabled' : ''}>
                             <span class="factory-vote-count">${votesFor}</span>
                        </button>
                        <button class="factory-vote-btn against" onclick="event.stopPropagation(); removeFactoryVote('${proposal.id}')" ${!canVote || userVoteCount === 0 ? 'disabled' : ''}>
                            
                        </button>
                        <button class="factory-comment-btn ${(proposal.comment_count || 0) > 0 ? 'has-comments' : ''}" onclick="event.stopPropagation(); toggleFactoryComments('${proposal.id}')">
                             ${proposal.comment_count || 0}
                        </button>
                    </div>
                    <div class="factory-comments-section" id="factory-comments-${proposal.id}">
                        <div class="factory-comments-list" id="factory-comments-list-${proposal.id}">
                            <div class="factory-no-comments">Loading...</div>
                        </div>
                        ${getFactoryCurrentUser() ? `
                        <div class="factory-comment-form">
                            <input type="text" class="factory-comment-input" id="factory-comment-input-${proposal.id}"
                                placeholder="Add a comment..." maxlength="500"
                                onkeypress="if(event.key==='Enter') postFactoryComment('${proposal.id}')">
                            <button class="factory-comment-submit" onclick="postFactoryComment('${proposal.id}')">Post</button>
                        </div>
                        ` : '<p class="factory-no-comments">Connect to comment</p>'}
                    </div>
                </div>
            `;
        }

        function escapeFactoryHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        function getFactoryVoteCost(voteNumber) {
            if (voteNumber <= 1) return 0;
            return Math.floor(voteNumber * (voteNumber - 1) / 2);
        }

        async function addFactoryVote(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const userVoteCount = factoryUserVotes[proposalId] || 0;
            const newVotePower = userVoteCount + 1;
            const cost = getFactoryVoteCost(newVotePower);

            try {
                const userId = await ensureFactoryUser();
                if (!userId) {
                    alert('Could not identify user. Please sign in again.');
                    return;
                }

                const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;
                const headers = {
                    'Content-Type': 'application/json',
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${accessToken}`
                };

                // Check if user already has a vote on this proposal
                const existingRes = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${userId}&proposal_id=eq.${proposalId}&select=id,vote_power`,
                    { headers }
                );
                const existing = await existingRes.json();

                let voteRes;
                if (existing && existing.length > 0) {
                    // Update existing vote (increase vote_power for quadratic)
                    voteRes = await fetch(
                        `${SUPABASE_URL}/rest/v1/factory_votes?id=eq.${existing[0].id}`,
                        {
                            method: 'PATCH',
                            headers: { ...headers, 'Prefer': 'return=minimal' },
                            body: JSON.stringify({
                                vote_power: newVotePower,
                                rep_spent: cost
                            })
                        }
                    );
                } else {
                    // Insert new vote
                    voteRes = await fetch(`${SUPABASE_URL}/rest/v1/factory_votes`, {
                        method: 'POST',
                        headers: { ...headers, 'Prefer': 'return=minimal' },
                        body: JSON.stringify({
                            user_id: userId,
                            proposal_id: proposalId,
                            vote_direction: 1,
                            vote_power: newVotePower,
                            rep_spent: cost
                        })
                    });
                }

                if (!voteRes.ok) {
                    const err = await voteRes.text();
                    console.error('[Factory] Vote error:', err);
                    alert('Failed to vote.');
                    return;
                }

                // Trigger on factory_votes automatically updates votes_for on the proposal
                factoryUserVotes[proposalId] = newVotePower;
                await loadFactoryProposals();
                updateFactoryUserCredits();
            } catch (err) {
                console.error('Vote error:', err);
                alert('Error voting');
            }
        }

        async function removeFactoryVote(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const userVoteCount = factoryUserVotes[proposalId] || 0;
            if (userVoteCount <= 0) {
                alert('No votes to remove');
                return;
            }

            try {
                const userId = await ensureFactoryUser();
                if (!userId) {
                    alert('Could not identify user.');
                    return;
                }

                const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;
                const newVotePower = userVoteCount - 1;

                if (newVotePower <= 0) {
                    // Remove vote entirely
                    const delRes = await fetch(`${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${userId}&proposal_id=eq.${proposalId}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${accessToken}`,
                            'Prefer': 'return=minimal'
                        }
                    });

                    if (!delRes.ok && delRes.status !== 204) {
                        alert('Failed to remove vote');
                        return;
                    }

                    // Trigger doesn't fire on DELETE, so manually update proposal count
                    const propRes = await fetch(`${SUPABASE_URL}/rest/v1/factory_proposals?id=eq.${proposalId}&select=votes_for`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${accessToken}`
                        }
                    });
                    const propData = await propRes.json();
                    const currentVotes = (propData && propData[0]) ? (propData[0].votes_for || 0) : 0;

                    await fetch(`${SUPABASE_URL}/rest/v1/factory_proposals?id=eq.${proposalId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${accessToken}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ votes_for: Math.max(0, currentVotes - 1) })
                    });
                } else {
                    // Reduce vote_power (quadratic downvote)
                    const cost = getFactoryVoteCost(newVotePower);
                    await fetch(`${SUPABASE_URL}/rest/v1/factory_votes?user_id=eq.${userId}&proposal_id=eq.${proposalId}`, {
                        method: 'PATCH',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${accessToken}`,
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ vote_power: newVotePower, rep_spent: cost })
                    });
                    // Trigger fires on UPDATE and recalculates votes_for
                }

                factoryUserVotes[proposalId] = Math.max(0, newVotePower);
                await loadFactoryProposals();
                updateFactoryUserCredits();
            } catch (err) {
                console.error('Remove vote error:', err);
                alert('Error removing vote');
            }
        }

        // Expand/collapse proposal card
        function toggleProposalExpand(card, event) {
            // Don't expand if clicking a button or link inside
            if (event.target.closest('button, a, input')) return;
            card.classList.toggle('expanded');
        }

        // Comments
        async function toggleFactoryComments(proposalId) {
            const section = document.getElementById(`factory-comments-${proposalId}`);
            if (!section) return;

            const isOpen = section.classList.contains('open');

            // Close all other comment sections
            document.querySelectorAll('.factory-comments-section.open').forEach(s => {
                s.classList.remove('open');
            });

            if (!isOpen) {
                section.classList.add('open');
                await loadFactoryComments(proposalId);
            }
        }

        async function loadFactoryComments(proposalId) {
            const listEl = document.getElementById(`factory-comments-list-${proposalId}`);
            if (!listEl) return;

            listEl.innerHTML = '<div class="factory-no-comments">Loading...</div>';

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_comments?proposal_id=eq.${proposalId}&select=id,content,created_at,user_id,factory_users(display_name)&order=created_at.asc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const comments = await response.json();
                    renderFactoryComments(proposalId, comments);
                }
            } catch (error) {
                listEl.innerHTML = '<div class="factory-no-comments">Error loading comments</div>';
            }
        }

        function renderFactoryComments(proposalId, comments) {
            const listEl = document.getElementById(`factory-comments-list-${proposalId}`);
            if (!listEl) return;

            if (!comments || comments.length === 0) {
                listEl.innerHTML = '<div class="factory-no-comments">No comments yet</div>';
                return;
            }

            const isAdmin = isFactoryAdmin();
            listEl.innerHTML = comments.map(comment => {
                const authorName = comment.factory_users?.display_name || 'Anonymous';
                const timeAgo = formatFactoryTimeAgo(new Date(comment.created_at));
                const deleteBtn = isAdmin ? `<button class="factory-comment-delete" onclick="deleteFactoryComment('${comment.id}', '${proposalId}')" title="Delete comment"></button>` : '';
                return `
                    <div class="factory-comment-item">
                        <div class="factory-comment-header">
                            <span class="factory-comment-author">@${escapeFactoryHtml(authorName)}</span>
                            <span class="factory-comment-time">${timeAgo}</span>
                            ${deleteBtn}
                        </div>
                        <div class="factory-comment-content">${escapeFactoryHtml(comment.content)}</div>
                    </div>
                `;
            }).join('');
        }

        function formatFactoryTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        // Ensure user exists in factory_users, return their UUID
        async function ensureFactoryUser() {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) return null;

            const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;
            const displayName = currentUser.display_name || 'Anonymous';

            // Check if user already exists by email, telegram, or wallet
            let lookupQuery = '';
            if (currentUser.email) {
                lookupQuery = `display_name=eq.${encodeURIComponent(displayName)}`;
            } else if (currentUser.telegram_id) {
                lookupQuery = `telegram_id=eq.${currentUser.telegram_id}`;
            } else if (currentUser.wallet_address) {
                lookupQuery = `wallet_address=eq.${currentUser.wallet_address}`;
            }

            try {
                // Try to find existing user
                const lookupRes = await fetch(`${SUPABASE_URL}/rest/v1/factory_users?${lookupQuery}&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                const existing = await lookupRes.json();
                if (existing && existing.length > 0) return existing[0].id;

                // Create new user
                const newUser = { display_name: displayName };
                if (currentUser.telegram_id) newUser.telegram_id = currentUser.telegram_id;
                if (currentUser.wallet_address) newUser.wallet_address = currentUser.wallet_address;

                const createRes = await fetch(`${SUPABASE_URL}/rest/v1/factory_users`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(newUser)
                });
                const created = await createRes.json();
                if (created && created.length > 0) return created[0].id;
                return null;
            } catch (e) {
                console.error('[Factory] ensureFactoryUser error:', e);
                return null;
            }
        }

        async function postFactoryComment(proposalId) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const inputEl = document.getElementById(`factory-comment-input-${proposalId}`);
            if (!inputEl) return;

            const content = inputEl.value.trim();
            if (!content) return;

            const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;

            try {
                // Ensure user has a factory_users record
                const userId = await ensureFactoryUser();
                if (!userId) {
                    alert('Could not create user profile. Try again.');
                    return;
                }

                // Insert comment directly
                const response = await fetch(`${SUPABASE_URL}/rest/v1/factory_comments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        proposal_id: proposalId,
                        user_id: userId,
                        content: content
                    })
                });

                console.log('[Factory] Comment post status:', response.status);

                if (response.ok || response.status === 201) {
                    inputEl.value = '';
                    await loadFactoryComments(proposalId);
                    await loadFactoryProposals();
                } else {
                    const errText = await response.text();
                    console.error('[Factory] Comment post failed:', errText);
                    alert('Failed to post comment');
                }
            } catch (err) {
                console.error('Comment error:', err);
                alert('Error posting comment');
            }
        }

        async function deleteFactoryComment(commentId, proposalId) {
            if (!confirm('Delete this comment?')) return;

            const accessToken = getSupabaseAccessToken() || SUPABASE_ANON_KEY;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/factory_comments?id=eq.${commentId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${accessToken}`,
                        'Prefer': 'return=minimal'
                    }
                });

                console.log('[Factory] Comment delete status:', response.status);

                if (response.ok || response.status === 204) {
                    await loadFactoryComments(proposalId);
                    await loadFactoryProposals();
                } else {
                    alert('Failed to delete comment');
                }
            } catch (err) {
                console.error('Comment delete error:', err);
                alert('Error deleting comment');
            }
        }

        // Submit proposal
        function showFactorySubmitModal(section) {
            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            // Reset form
            document.getElementById('factoryProposalContent').value = '';
            document.getElementById('factoryProposalApp').value = '';
            document.getElementById('factoryIsNewApp').checked = false;

            // Set section (default to current section)
            const targetSection = section || factoryCurrentSection;
            document.getElementById('factoryProposalSection').value = targetSection;

            // Initialize app fields visibility based on section
            onFactorySectionChange();

            document.getElementById('factorySubmitModal').classList.add('active');
        }

        function hideFactorySubmitModal() {
            document.getElementById('factorySubmitModal').classList.remove('active');
            document.getElementById('factoryProposalContent').value = '';
            document.getElementById('factoryProposalApp').value = '';
            document.getElementById('factoryIsNewApp').checked = false;
            // Reset visibility
            document.getElementById('factoryAppGroup').style.display = 'block';
            document.getElementById('factoryNewAppGroup').style.display = 'block';
        }

        function showFactoryAuthModal() {
            document.getElementById('factoryAuthModal').classList.add('active');
        }

        function hideFactoryAuthModal() {
            document.getElementById('factoryAuthModal').classList.remove('active');
        }

        async function submitFactoryProposal(event) {
            event.preventDefault();

            const currentUser = getFactoryCurrentUser();
            if (!currentUser) {
                showFactoryAuthModal();
                return;
            }

            const section = document.getElementById('factoryProposalSection').value;
            const content = document.getElementById('factoryProposalContent').value.trim();
            const isNewApp = document.getElementById('factoryIsNewApp').checked;
            const appSlug = document.getElementById('factoryProposalApp').value;

            if (!content) {
                alert('Please describe your idea');
                return;
            }

            const submitBtn = document.getElementById('factorySubmitBtn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Analyzing & Submitting...';

            try {
                const payload = {
                    content,
                    section
                };

                // Add app-related fields for suite_apps section
                if (section === 'suite_apps') {
                    if (isNewApp) {
                        payload.is_new_app = true;
                        payload.app_slug = 'new_app';
                    } else if (appSlug) {
                        payload.app_slug = appSlug;
                    }
                }

                // Add auth based on user type
                if (currentUser.telegram_id) {
                    payload.telegram_auth = { id: currentUser.telegram_id, username: currentUser.display_name };
                } else if (currentUser.wallet_address) {
                    payload.wallet_address = currentUser.wallet_address;
                } else if (currentUser.supabase_id || currentUser.email) {
                    payload.supabase_auth = {
                        id: currentUser.supabase_id,
                        email: currentUser.email,
                        display_name: currentUser.display_name
                    };
                }

                const response = await fetch(`${SUPABASE_URL}/functions/v1/factory-submit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    hideFactorySubmitModal();
                    await loadFactoryProposals();
                } else {
                    alert(result.error || 'Failed to submit proposal');
                }
            } catch (err) {
                console.error('Submit error:', err);
                alert('Error submitting proposal');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit Proposal';
            }
        }

        // Leaderboard
        async function loadFactoryLeaderboard() {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?select=display_name,reputation&order=reputation.desc&limit=10`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const leaders = await response.json();
                    renderFactoryLeaderboard(leaders);
                }
            } catch (error) {
                console.error('Failed to load leaderboard:', error);
            }
        }

        function renderFactoryLeaderboard(leaders) {
            const container = document.getElementById('factoryLeaderboardList');
            if (!container) return;

            if (!leaders || leaders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: var(--text-tertiary);">No leaders yet</p>';
                return;
            }

            const medals = ['', '', ''];
            container.innerHTML = leaders.map((user, i) => `
                <div class="factory-leaderboard-item">
                    <span class="factory-leaderboard-rank">${medals[i] || '#' + (i + 1)}</span>
                    <span class="factory-leaderboard-name">${escapeFactoryHtml(user.display_name || 'Anonymous')}</span>
                    <span class="factory-leaderboard-credits">${user.reputation || 0} credits</span>
                </div>
            `).join('');
        }

        // ========== REWARDS SYSTEM ==========
        let rewardsDataLoaded = false;
        let rewardsPoolData = {
            totalPool: 0,
            contributors: [],
            donations: [],
            nextDistribution: null
        };

        async function loadRewardsData() {
            // Update UI to show loading state if needed
            try {
                // Load pool stats from Supabase
                const [poolResponse, contributorsResponse, donationsResponse] = await Promise.all([
                    // Get total pool amount
                    fetch(`${SUPABASE_URL}/rest/v1/rewards_pool?select=*&limit=1`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }),
                    // Get approved proposals this month (contributors)
                    fetch(`${SUPABASE_URL}/rest/v1/factory_proposals?select=*&status=eq.approved&order=created_at.desc`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }),
                    // Get recent donations
                    fetch(`${SUPABASE_URL}/rest/v1/rewards_donations?select=*&order=created_at.desc&limit=10`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    })
                ]);

                // Process pool data
                if (poolResponse.ok) {
                    const poolData = await poolResponse.json();
                    if (poolData.length > 0) {
                        rewardsPoolData.totalPool = poolData[0].total_amount || 0;
                        rewardsPoolData.nextDistribution = poolData[0].next_distribution;
                    }
                }

                // Process contributors (approved proposals)
                if (contributorsResponse.ok) {
                    const proposals = await contributorsResponse.json();
                    // Group by creator
                    const contributorMap = {};
                    proposals.forEach(p => {
                        const creator = p.creator_id || p.creator_address || 'anonymous';
                        if (!contributorMap[creator]) {
                            contributorMap[creator] = {
                                name: p.creator_name || truncateAddress(creator),
                                proposals: 0,
                                address: creator
                            };
                        }
                        contributorMap[creator].proposals++;
                    });
                    rewardsPoolData.contributors = Object.values(contributorMap)
                        .sort((a, b) => b.proposals - a.proposals);
                }

                // Process donations
                if (donationsResponse.ok) {
                    const donations = await donationsResponse.json();
                    rewardsPoolData.donations = donations;
                }

                // Update the UI
                renderRewardsUI();
                rewardsDataLoaded = true;

            } catch (error) {
                console.error('Failed to load rewards data:', error);
                // Show fallback UI with zeros
                renderRewardsUI();
            }

            // Update user-specific data if logged in
            updateUserRewardsUI();
        }

        function renderRewardsUI() {
            // Update pool amount
            const poolAmount = document.getElementById('rewardsPoolAmount');
            if (poolAmount) {
                poolAmount.textContent = `$${rewardsPoolData.totalPool.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            // Update next distribution date
            const nextDist = document.getElementById('rewardsNextDistribution');
            if (nextDist) {
                if (rewardsPoolData.nextDistribution) {
                    const date = new Date(rewardsPoolData.nextDistribution);
                    const now = new Date();
                    const daysLeft = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
                    nextDist.textContent = daysLeft > 0 ? `${daysLeft} days` : 'Soon';
                } else {
                    // Default to end of month
                    const now = new Date();
                    const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                    const daysLeft = Math.ceil((endOfMonth - now) / (1000 * 60 * 60 * 24));
                    nextDist.textContent = `${daysLeft} days`;
                }
            }

            // Update contributor count
            const contribCount = document.getElementById('rewardsContributorCount');
            if (contribCount) {
                contribCount.textContent = rewardsPoolData.contributors.length;
            }

            // Update approved count (total proposals)
            const approvedCount = document.getElementById('rewardsApprovedCount');
            if (approvedCount) {
                const total = rewardsPoolData.contributors.reduce((sum, c) => sum + c.proposals, 0);
                approvedCount.textContent = total;
            }

            // Render recent donors
            const donorsContainer = document.getElementById('rewardsRecentDonors');
            if (donorsContainer) {
                if (rewardsPoolData.donations.length === 0) {
                    donorsContainer.innerHTML = '<p class="rewards-empty">Be the first to donate!</p>';
                } else {
                    donorsContainer.innerHTML = rewardsPoolData.donations.map(d => `
                        <div class="rewards-donor-item">
                            <span class="rewards-donor-address">${d.donor_name || truncateAddress(d.donor_address || 'anon')}</span>
                            <span class="rewards-donor-amount">+$${d.amount}</span>
                        </div>
                    `).join('');
                }
            }

            // Render top contributors
            const contribList = document.getElementById('rewardsContributorsList');
            if (contribList) {
                if (rewardsPoolData.contributors.length === 0) {
                    contribList.innerHTML = '<p class="rewards-empty">No approved contributions yet this month</p>';
                } else {
                    const totalProposals = rewardsPoolData.contributors.reduce((sum, c) => sum + c.proposals, 0);
                    const medals = ['', '', ''];
                    contribList.innerHTML = rewardsPoolData.contributors.slice(0, 10).map((c, i) => {
                        const share = totalProposals > 0 ? (c.proposals / totalProposals) * rewardsPoolData.totalPool : 0;
                        return `
                            <div class="rewards-contributor-row">
                                <span class="rewards-contributor-rank">${medals[i] || '#' + (i + 1)}</span>
                                <div class="rewards-contributor-info">
                                    <span class="rewards-contributor-name">${escapeFactoryHtml(c.name)}</span>
                                    <span class="rewards-contributor-proposals">${c.proposals} approved proposal${c.proposals !== 1 ? 's' : ''}</span>
                                </div>
                                <span class="rewards-contributor-payout">~$${share.toFixed(2)}</span>
                            </div>
                        `;
                    }).join('');
                }
            }
        }

        function updateUserRewardsUI() {
            const authPrompt = document.getElementById('rewardsAuthPrompt');
            const userEarnings = document.getElementById('rewardsUserEarnings');

            if (!currentUser) {
                // Show auth prompt
                if (authPrompt) authPrompt.style.display = 'block';
                if (userEarnings) userEarnings.style.display = 'none';
                return;
            }

            // Hide auth prompt, show earnings
            if (authPrompt) authPrompt.style.display = 'none';
            if (userEarnings) userEarnings.style.display = 'block';

            // Find user's contributions
            const userContrib = rewardsPoolData.contributors.find(c =>
                c.address === currentUser.id || c.address === currentUser.wallet_address
            );

            const totalProposals = rewardsPoolData.contributors.reduce((sum, c) => sum + c.proposals, 0);
            const userProposals = userContrib ? userContrib.proposals : 0;
            const userShare = totalProposals > 0 ? (userProposals / totalProposals) * rewardsPoolData.totalPool : 0;
            const userRank = userContrib ? rewardsPoolData.contributors.indexOf(userContrib) + 1 : '--';

            // Update payout display
            const payoutEl = document.getElementById('rewardsYourPayout');
            if (payoutEl) {
                payoutEl.textContent = `$${userShare.toFixed(2)}`;
            }

            // Update rank
            const rankEl = document.getElementById('rewardsYourRank');
            const totalEl = document.getElementById('rewardsYourTotal');
            if (rankEl) rankEl.textContent = userRank;
            if (totalEl) totalEl.textContent = rewardsPoolData.contributors.length || '--';

            // Update contributions list
            const contribContainer = document.getElementById('rewardsYourContributions');
            if (contribContainer) {
                if (userProposals === 0) {
                    contribContainer.innerHTML = '<p class="rewards-empty">No approved proposals yet this month</p>';
                } else {
                    contribContainer.innerHTML = `
                        <div class="rewards-contribution-item">
                            <span class="rewards-contribution-title">${userProposals} approved proposal${userProposals !== 1 ? 's' : ''}</span>
                            <span class="rewards-contribution-share">~$${userShare.toFixed(2)}</span>
                        </div>
                    `;
                }
            }
        }

        function truncateAddress(address) {
            if (!address || address.length < 10) return address || 'anon';
            return address.slice(0, 6) + '...' + address.slice(-4);
        }

        function openRewardDeposit() {
            // Remove existing overlay if present
            const existing = document.querySelector('.rp-deposit-overlay');
            if (existing) existing.remove();

            const overlay = document.createElement('div');
            overlay.className = 'rp-deposit-overlay';
            overlay.onclick = (e) => { if (e.target === overlay) overlay.remove(); };
            overlay.innerHTML = `
                <div class="rp-deposit-modal">
                    <button class="rp-deposit-close" onclick="this.closest('.rp-deposit-overlay').remove()">&times;</button>
                    <h3>Deposit to Reward Pool</h3>
                    <p class="rp-subtitle">Send USDC to fund the reward pool. All credit holders earn proportional rewards.</p>
                    <div class="rp-amount-presets">
                        <button class="rp-preset-btn" onclick="setRpDepositAmount(5)">$5</button>
                        <button class="rp-preset-btn" onclick="setRpDepositAmount(25)">$25</button>
                        <button class="rp-preset-btn" onclick="setRpDepositAmount(100)">$100</button>
                        <button class="rp-preset-btn" onclick="setRpDepositAmount(500)">$500</button>
                    </div>
                    <input type="number" class="rp-custom-input" id="rpDepositAmount" placeholder="Enter USDC amount" min="1" step="any" />
                    <div class="rp-network-note">
                        <span class="rp-chain-badge">BASE</span> USDC on Base network required
                    </div>
                    <button class="rp-deposit-submit" id="rpDepositBtn" onclick="executeRewardPoolDeposit()">
                        Deposit USDC
                    </button>
                    <div class="rp-deposit-status" id="rpDepositStatus"></div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function setRpDepositAmount(amount) {
            document.getElementById('rpDepositAmount').value = amount;
            document.querySelectorAll('.rp-preset-btn').forEach(b => b.classList.remove('active'));
            event.target.classList.add('active');
        }

        async function executeRewardPoolDeposit() {
            const btn = document.getElementById('rpDepositBtn');
            const statusEl = document.getElementById('rpDepositStatus');
            const amount = parseFloat(document.getElementById('rpDepositAmount').value);

            if (!amount || amount < 1) {
                statusEl.className = 'rp-deposit-status rp-status-error';
                statusEl.textContent = 'Please enter at least 1 USDC';
                return;
            }

            if (!STAKING_REWARDS_ADDRESS) {
                statusEl.className = 'rp-deposit-status rp-status-error';
                statusEl.textContent = 'Reward pool contract not yet deployed';
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                statusEl.className = 'rp-deposit-status rp-status-error';
                statusEl.textContent = 'Please install MetaMask or a Web3 wallet';
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            const originalText = btn.textContent;
            btn.disabled = true;

            try {
                // Switch to Base network
                statusEl.className = 'rp-deposit-status rp-status-pending';
                statusEl.textContent = 'Switching to Base network...';
                await ensureBaseNetwork();

                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const userAddress = await signer.getAddress();

                localStorage.setItem('connectedWallet', userAddress);
                localStorage.setItem('suiteWalletAddress', userAddress);

                const usdcAmountWei = ethers.parseUnits(amount.toString(), 6);
                const usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);

                // Check balance
                statusEl.textContent = 'Checking USDC balance...';
                const balance = await usdcContract.balanceOf(userAddress);
                if (balance < usdcAmountWei) {
                    throw new Error(`Insufficient USDC balance. You have ${ethers.formatUnits(balance, 6)} USDC`);
                }

                // Approve StakingRewards contract to pull USDC
                statusEl.textContent = 'Checking approval...';
                btn.textContent = 'Checking...';
                const allowance = await usdcContract.allowance(userAddress, STAKING_REWARDS_ADDRESS);
                if (allowance < usdcAmountWei) {
                    statusEl.textContent = 'Approve USDC spend in your wallet...';
                    btn.textContent = 'Approve in wallet...';
                    const approveTx = await usdcContract.approve(STAKING_REWARDS_ADDRESS, ethers.MaxUint256);
                    statusEl.textContent = 'Waiting for approval...';
                    await approveTx.wait();
                }

                // Call depositRewards on the StakingRewards contract
                statusEl.textContent = 'Confirm deposit in your wallet...';
                btn.textContent = 'Confirm in wallet...';
                const rewardsContract = new ethers.Contract(STAKING_REWARDS_ADDRESS, STAKING_REWARDS_ABI, signer);
                const tx = await rewardsContract.depositRewards(usdcAmountWei);

                statusEl.textContent = 'Waiting for confirmation...';
                btn.textContent = 'Confirming...';
                await tx.wait();

                // Success
                statusEl.className = 'rp-deposit-status rp-status-success';
                statusEl.textContent = `Deposited ${amount} USDC to the reward pool!`;
                btn.textContent = 'Done!';
                showToast(`Deposited ${amount} USDC to the reward pool!`);

                // Refresh banner data from chain
                setTimeout(() => loadRewardPoolBanner(), 2000);
                setTimeout(() => {
                    const overlay = document.querySelector('.rp-deposit-overlay');
                    if (overlay) overlay.remove();
                }, 3000);

            } catch (err) {
                console.error('Pool deposit failed:', err);
                statusEl.className = 'rp-deposit-status rp-status-error';
                statusEl.textContent = err.reason || err.message || 'Transaction failed';
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        // Claim earned USDC rewards
        async function claimRewardPoolUsdc() {
            if (!STAKING_REWARDS_ADDRESS) {
                showToast('Reward pool contract not yet deployed');
                return;
            }
            if (typeof window.ethereum === 'undefined') {
                showToast('Please install MetaMask or a Web3 wallet');
                return;
            }

            try {
                await ensureBaseNetwork();
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const rewardsContract = new ethers.Contract(STAKING_REWARDS_ADDRESS, STAKING_REWARDS_ABI, signer);

                showToast('Confirm claim in your wallet...');
                const tx = await rewardsContract.claimUsdc();
                showToast('Claiming rewards...');
                await tx.wait();
                showToast('Rewards claimed!');

                setTimeout(() => loadRewardPoolBanner(), 2000);
            } catch (err) {
                console.error('Claim failed:', err);
                showToast(err.reason || err.message || 'Claim failed');
            }
        }

        function promptConnectWallet() {
            // Use the existing wallet connection flow
            if (typeof window.ethereum !== 'undefined') {
                connectWallet();
            } else {
                alert('Please install MetaMask or a Web3 wallet to connect.\nhttps://metamask.io/download/');
                window.open('https://metamask.io/download/', '_blank');
            }
        }

        // Update reward pool banner based on wallet connection status
        function updateRewardPoolWalletStatus() {
            const walletLink = document.getElementById('rpWalletLink');
            const claimBtn = document.querySelector('.rp-claim-btn');
            const wallet = localStorage.getItem('connectedWallet');

            if (wallet) {
                const truncated = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                if (walletLink) {
                    walletLink.textContent = truncated;
                    walletLink.style.color = '#10b981';
                    walletLink.onclick = null;
                }
                if (claimBtn) claimBtn.style.display = 'flex';
            } else {
                if (walletLink) {
                    walletLink.textContent = 'Connect wallet';
                    walletLink.style.color = '#fbbf24';
                    walletLink.onclick = (e) => { e.preventDefault(); promptConnectWallet(); };
                }
                if (claimBtn) claimBtn.style.display = 'none';
            }
        }

        // Reward pool countdown - distributes 1st of every month
        function updateRewardPoolCountdown() {
            const el = document.getElementById('rewardPoolCountdown');
            const bar = document.getElementById('rewardPoolBarFill');
            if (!el) return;

            const now = new Date();
            // Next distribution = 1st of next month at midnight UTC
            const nextDist = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 1, 0, 0, 0));
            // Start of current period = 1st of this month
            const periodStart = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1, 0, 0, 0));

            const remaining = nextDist - now;
            const totalPeriod = nextDist - periodStart;
            const elapsed = now - periodStart;
            const progress = Math.min(100, Math.max(0, (elapsed / totalPeriod) * 100));

            const days = Math.floor(remaining / (1000 * 60 * 60 * 24));
            const hours = Math.floor((remaining % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            const mins = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
            const secs = Math.floor((remaining % (1000 * 60)) / 1000);

            const pad = n => String(n).padStart(2, '0');
            if (days > 0) {
                el.innerHTML = `${days}<span class="rpc-unit">d</span>${pad(hours)}<span class="rpc-unit">h</span>${pad(mins)}<span class="rpc-unit">m</span>${pad(secs)}<span class="rpc-unit">s</span>`;
            } else {
                el.innerHTML = `${pad(hours)}<span class="rpc-unit">h</span>${pad(mins)}<span class="rpc-unit">m</span>${pad(secs)}<span class="rpc-unit">s</span>`;
            }

            if (bar) bar.style.width = progress.toFixed(1) + '%';
        }

        updateRewardPoolCountdown();
        setInterval(updateRewardPoolCountdown, 1000);

        // Reward pool data  reads from StakingRewards contract on Base
        const rpFmtUSD = n => '$' + n.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 });
        const rpFmtCredits = n => {
            if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
            if (n >= 1000) return (n / 1000).toFixed(0) + 'K';
            return n.toLocaleString();
        };

        function renderRewardPoolValues(poolBalance, holders, creditsCirculating, rewardForDuration, userEarned) {
            const el = id => document.getElementById(id);

            if (el('rewardPoolDisplay')) el('rewardPoolDisplay').innerHTML = `${rpFmtUSD(poolBalance)}<span class="reward-pool-currency">USDC</span>`;
            if (el('rpHolders')) el('rpHolders').textContent = holders.toLocaleString();
            if (el('rpCredits')) el('rpCredits').textContent = rpFmtCredits(creditsCirculating);
            if (el('rpLastMonth')) el('rpLastMonth').textContent = rpFmtUSD(rewardForDuration);

            // APY = (rewardForDuration * 12) / totalStakedUSD * 100
            const totalStakedUSD = creditsCirculating / 1000;
            const annualized = rewardForDuration * 12;
            const apy = totalStakedUSD > 0 ? ((annualized / totalStakedUSD) * 100) : 0;
            if (el('rpAPY')) el('rpAPY').textContent = apy.toFixed(1) + '%';

            // User's earned (claimable) USDC from the on-chain contract
            const shareEl = document.querySelector('.reward-pool-share');
            if (shareEl) {
                if (userEarned > 0) {
                    const fmtEarned = userEarned < 0.01 ? '<0.01' : userEarned.toFixed(2);
                    shareEl.innerHTML = `Claimable: <strong>${fmtEarned} USDC</strong>`;
                } else if (localStorage.getItem('connectedWallet')) {
                    shareEl.innerHTML = `Claimable: <strong>0 USDC</strong>`;
                } else {
                    shareEl.innerHTML = `Claimable: <strong>connect wallet</strong>`;
                }
            }

            updateRewardPoolWalletStatus();
        }

        async function loadRewardPoolBanner() {
            let poolBalance = 0;
            let holders = 0;
            let creditsCirculating = 0;
            let rewardForDuration = 0;
            let userEarned = 0;

            try {
                const provider = new ethers.JsonRpcProvider(BASE_RPC);

                if (STAKING_REWARDS_ADDRESS) {
                    const rewardsContract = new ethers.Contract(STAKING_REWARDS_ADDRESS, STAKING_REWARDS_ABI, provider);
                    const usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, provider);

                    const [balanceRaw, totalCreditsRaw, rewardForDurationRaw] = await Promise.all([
                        usdcContract.balanceOf(STAKING_REWARDS_ADDRESS),
                        rewardsContract.totalCredits(),
                        rewardsContract.getRewardForDuration()
                    ]);

                    poolBalance = parseFloat(ethers.formatUnits(balanceRaw, 6));
                    rewardForDuration = parseFloat(ethers.formatUnits(rewardForDurationRaw, 6));
                    creditsCirculating = parseFloat(ethers.formatUnits(totalCreditsRaw, 18));

                    const wallet = localStorage.getItem('connectedWallet');
                    if (wallet) {
                        try {
                            const earnedRaw = await rewardsContract.earned(wallet);
                            userEarned = parseFloat(ethers.formatUnits(earnedRaw, 6));
                        } catch (e) { console.warn('Could not read earned:', e); }
                    }
                }

                // Holder count from Supabase
                const headers = { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` };
                try {
                    const creditsRes = await fetch(`${SUPABASE_URL}/rest/v1/user_credits?select=credits&credits=gt.0`, { headers });
                    if (creditsRes.ok) holders = (await creditsRes.json()).length;
                } catch (e) { console.warn('Could not fetch holders:', e); }

            } catch (err) {
                console.error('Failed to load reward pool data:', err);
            }

            renderRewardPoolValues(poolBalance, holders, creditsCirculating, rewardForDuration, userEarned);
        }

        // Show zeros immediately, then load real data
        renderRewardPoolValues(0, 0, 0, 0, 0);
        loadRewardPoolBanner();

        function selectDonationAmount(amount) {
            // Update input field
            const input = document.getElementById('rewardsDonationAmount');
            if (input) {
                input.value = amount;
            }

            // Update button states
            document.querySelectorAll('.rewards-amount-btn').forEach(btn => {
                btn.classList.remove('active');
                if (parseInt(btn.textContent.replace('$', '')) === amount) {
                    btn.classList.add('active');
                }
            });
        }

        async function submitDonation() {
            const input = document.getElementById('rewardsDonationAmount');
            const amount = parseFloat(input?.value);

            if (!amount || amount <= 0) {
                alert('Please enter a valid donation amount');
                return;
            }

            if (!currentUser) {
                openAuthModal();
                return;
            }

            const donateBtn = document.querySelector('.rewards-donate-btn');
            const originalText = donateBtn.textContent;
            donateBtn.textContent = 'Processing...';
            donateBtn.disabled = true;

            try {
                // Record the donation in Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rewards_donations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        donor_address: currentUser.wallet_address || currentUser.id,
                        donor_name: currentUser.display_name || null,
                        amount: amount,
                        status: 'pending' // Will be 'confirmed' after actual payment
                    })
                });

                if (response.ok) {
                    // Update the pool total (in real app, this would be done server-side after payment confirmation)
                    await fetch(`${SUPABASE_URL}/rest/v1/rpc/increment_rewards_pool`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        body: JSON.stringify({ amount: amount })
                    }).catch(() => {}); // Ignore if RPC doesn't exist yet

                    // Show success
                    donateBtn.textContent = 'Thank you!';
                    donateBtn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';

                    // Clear input
                    if (input) input.value = '';
                    document.querySelectorAll('.rewards-amount-btn').forEach(btn => btn.classList.remove('active'));

                    // Reload data
                    setTimeout(() => {
                        donateBtn.textContent = originalText;
                        donateBtn.disabled = false;
                        loadRewardsData();
                    }, 2000);

                } else {
                    throw new Error('Failed to record donation');
                }

            } catch (error) {
                console.error('Donation failed:', error);
                donateBtn.textContent = 'Failed - Try Again';
                donateBtn.disabled = false;
                setTimeout(() => {
                    donateBtn.textContent = originalText;
                }, 2000);
            }
        }

        // Fleet Stream Visualizer - Multi-Agent Support
        let fleetStreamInitialized = false;
        let fleetLastActivity = Date.now();
        let fleetChannel = null;
        const fleetAgents = new Map(); // agentId -> agent data

        // Agent color palette
        const agentColors = [
            { bg: 'linear-gradient(135deg, #6366f1, #8b5cf6)', color: '#6366f1' },
            { bg: 'linear-gradient(135deg, #22c55e, #10b981)', color: '#22c55e' },
            { bg: 'linear-gradient(135deg, #f59e0b, #eab308)', color: '#f59e0b' },
            { bg: 'linear-gradient(135deg, #ec4899, #f43f5e)', color: '#ec4899' },
            { bg: 'linear-gradient(135deg, #06b6d4, #0ea5e9)', color: '#06b6d4' },
            { bg: 'linear-gradient(135deg, #8b5cf6, #a855f7)', color: '#8b5cf6' }
        ];

        function initFleetStream() {
            if (fleetStreamInitialized) return;
            fleetStreamInitialized = true;

            // Create Supabase client for realtime if not exists
            if (!window.fleetSupabase) {
                window.fleetSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            }

            // Subscribe to Supabase Realtime
            fleetChannel = window.fleetSupabase.channel('fleet-stream');

            fleetChannel
                .on('broadcast', { event: 'fleet-event' }, (payload) => {
                    handleFleetEvent(payload.payload);
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        const statusDot = document.getElementById('fleetStatusDot');
                        const statusText = document.getElementById('fleetStatusText');
                        if (statusDot) statusDot.classList.add('connected');
                        if (statusText) statusText.textContent = 'Connected';
                        addFleetLog('', 'Connected to Fleet stream');
                    }
                });

            // Update agent timers every second
            setInterval(updateAgentTimers, 1000);

            // Check for stale agents every 30 seconds
            setInterval(checkStaleAgents, 30000);

            // Load GitHub commits
            loadStreamCommits();
        }

        function handleFleetEvent(data) {
            if (!data) return;

            fleetLastActivity = Date.now();

            // Handle different event types
            switch (data.type) {
                case 'streamer_online':
                    addFleetLog(data.icon || '', data.label || 'Streamer online');
                    break;

                case 'fleet_summary':
                    // Update from fleet summary
                    updateFleetStats(data.activeCount || 0, data.idleCount || 0);
                    if (data.agents) {
                        data.agents.forEach(agent => {
                            updateAgent(agent.id, {
                                ...agent,
                                type: 'summary'
                            });
                        });
                    }
                    break;

                case 'action':
                case 'thinking':
                case 'complete':
                case 'status_change':
                    if (data.agentId) {
                        updateAgent(data.agentId, data);
                        const prefix = data.project ? `[${data.project}] ` : '';
                        addFleetLog(data.icon || '', `${prefix}${data.action}${data.detail ? ': ' + data.detail : ''}`);
                    }
                    break;

                default:
                    // Legacy event format
                    if (data.label) {
                        addFleetLog(data.icon || '', data.label);
                    }
            }

            renderAgentCards();
        }

        function updateAgent(agentId, data) {
            const existing = fleetAgents.get(agentId);
            const colorIndex = existing?.colorIndex ?? fleetAgents.size % agentColors.length;

            fleetAgents.set(agentId, {
                id: agentId,
                project: data.project || existing?.project || 'Unknown',
                status: data.status || existing?.status || 'active',
                action: data.action || existing?.action || 'Working',
                icon: data.icon || existing?.icon || '',
                detail: data.detail || existing?.detail || '',
                sessionStart: data.sessionStart || existing?.sessionStart || Date.now(),
                lastActivity: Date.now(),
                colorIndex: colorIndex
            });

            // Hide empty state when we have agents
            const emptyState = document.getElementById('fleetEmptyState');
            if (emptyState && fleetAgents.size > 0) {
                emptyState.style.display = 'none';
            }
        }

        function renderAgentCards() {
            const grid = document.getElementById('fleetAgentsGrid');
            if (!grid) return;

            // Update counts
            const activeCount = Array.from(fleetAgents.values()).filter(a => a.status === 'active').length;
            const idleCount = Array.from(fleetAgents.values()).filter(a => a.status === 'idle').length;
            updateFleetStats(activeCount, idleCount);

            // Get or create cards for each agent
            fleetAgents.forEach((agent, agentId) => {
                let card = grid.querySelector(`[data-agent-id="${agentId}"]`);

                if (!card) {
                    card = createAgentCard(agent);
                    grid.appendChild(card);
                } else {
                    updateAgentCard(card, agent);
                }
            });
        }

        function createAgentCard(agent) {
            const card = document.createElement('div');
            card.className = `fleet-agent-card ${agent.status}`;
            card.dataset.agentId = agent.id;

            const colors = agentColors[agent.colorIndex];
            const sessionDuration = formatDuration(Date.now() - agent.sessionStart);

            card.innerHTML = `
                <div class="fleet-agent-card-header">
                    <div class="fleet-agent-project">
                        <div class="fleet-agent-avatar" style="background: ${colors.bg}"></div>
                        <div class="fleet-agent-info">
                            <h4>${escapeHtml(agent.project)}</h4>
                            <span>Agent ${agent.id}</span>
                        </div>
                    </div>
                    <div class="fleet-agent-status-badge ${agent.status}">${agent.status}</div>
                </div>
                <div class="fleet-agent-action">
                    <div class="fleet-agent-action-header">
                        <span class="fleet-agent-action-icon">${agent.icon}</span>
                        <span class="fleet-agent-action-label">${agent.action}</span>
                    </div>
                    <div class="fleet-agent-action-detail">${escapeHtml(agent.detail)}</div>
                </div>
                <div class="fleet-agent-footer">
                    <div class="fleet-agent-timer">
                        <span class="fleet-agent-timer-icon"></span>
                        <span class="fleet-agent-timer-value">${sessionDuration}</span>
                    </div>
                    <span style="color: ${colors.color}"></span>
                </div>
            `;

            return card;
        }

        function updateAgentCard(card, agent) {
            // Update status class
            card.className = `fleet-agent-card ${agent.status}`;

            // Update status badge
            const badge = card.querySelector('.fleet-agent-status-badge');
            if (badge) {
                badge.className = `fleet-agent-status-badge ${agent.status}`;
                badge.textContent = agent.status;
            }

            // Update action
            const actionIcon = card.querySelector('.fleet-agent-action-icon');
            const actionLabel = card.querySelector('.fleet-agent-action-label');
            const actionDetail = card.querySelector('.fleet-agent-action-detail');
            if (actionIcon) actionIcon.textContent = agent.icon;
            if (actionLabel) actionLabel.textContent = agent.action;
            if (actionDetail) actionDetail.textContent = agent.detail;

            // Update timer
            const timerValue = card.querySelector('.fleet-agent-timer-value');
            if (timerValue) {
                timerValue.textContent = formatDuration(Date.now() - agent.sessionStart);
            }
        }

        function updateAgentTimers() {
            fleetAgents.forEach((agent, agentId) => {
                const card = document.querySelector(`[data-agent-id="${agentId}"]`);
                if (card) {
                    const timerValue = card.querySelector('.fleet-agent-timer-value');
                    if (timerValue) {
                        timerValue.textContent = formatDuration(Date.now() - agent.sessionStart);
                    }
                }
            });
        }

        function checkStaleAgents() {
            const now = Date.now();
            const STALE_THRESHOLD = 120000; // 2 minutes

            fleetAgents.forEach((agent, agentId) => {
                if (now - agent.lastActivity > STALE_THRESHOLD) {
                    // Mark as idle if stale
                    agent.status = 'idle';
                    agent.action = 'Idle';
                    agent.icon = '';
                    agent.detail = 'No recent activity';
                }
            });

            renderAgentCards();
        }

        function updateFleetStats(active, idle) {
            const activeEl = document.getElementById('fleetActiveCount');
            const idleEl = document.getElementById('fleetIdleCount');
            if (activeEl) activeEl.textContent = active;
            if (idleEl) idleEl.textContent = idle;
        }

        function formatDuration(ms) {
            const seconds = Math.floor(ms / 1000);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ${seconds % 60}s`;
            const hours = Math.floor(minutes / 60);
            return `${hours}h ${minutes % 60}m`;
        }

        function addFleetLog(icon, text) {
            const log = document.getElementById('fleetActivityLog');
            if (!log) return;

            const entry = document.createElement('div');
            entry.className = 'fleet-log-entry';

            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

            entry.innerHTML = `
                <span class="fleet-log-icon">${icon}</span>
                <span class="fleet-log-text">${text}</span>
                <span class="fleet-log-time">${time}</span>
            `;

            // Insert at the top
            const firstEntry = log.querySelector('.fleet-log-entry');
            if (firstEntry) {
                log.insertBefore(entry, firstEntry);
            } else {
                log.appendChild(entry);
            }

            // Keep only last 30 entries
            while (log.querySelectorAll('.fleet-log-entry').length > 30) {
                log.removeChild(log.lastElementChild);
            }
        }

        // Toggle commits section collapse
        function toggleCommits() {
            const list = document.getElementById('streamCommits');
            const btn = document.getElementById('commitsToggleBtn');
            if (!list || !btn) return;
            list.classList.toggle('collapsed');
            btn.classList.toggle('collapsed');
        }

        // Load GitHub commits for Stream view
        async function loadStreamCommits() {
            const container = document.getElementById('streamCommits');
            if (!container) return;

            try {
                const response = await fetch('https://api.github.com/repos/stuart5915/suitegpt/commits?per_page=20');
                if (!response.ok) throw new Error('Failed to fetch commits');

                const commits = await response.json();

                container.innerHTML = commits.map(commit => {
                    const message = commit.commit.message.split('\n')[0];
                    const author = commit.commit.author.name;
                    const date = new Date(commit.commit.author.date);
                    const timeAgo = getTimeAgo(date);
                    const sha = commit.sha.substring(0, 7);
                    const url = commit.html_url;

                    return `
                        <div class="stream-commit">
                            <div class="stream-commit-icon">
                                <svg viewBox="0 0 16 16" fill="currentColor">
                                    <path fill-rule="evenodd" d="M10.5 7.75a2.5 2.5 0 11-5 0 2.5 2.5 0 015 0zm1.43.75a4.002 4.002 0 01-7.86 0H.75a.75.75 0 110-1.5h3.32a4.001 4.001 0 017.86 0h3.32a.75.75 0 110 1.5h-3.32z"></path>
                                </svg>
                            </div>
                            <div class="stream-commit-content">
                                <div class="stream-commit-message">
                                    <a href="${url}" target="_blank">${escapeHtml(message)}</a>
                                </div>
                                <div class="stream-commit-meta">${sha}  ${author}  ${timeAgo}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Failed to load commits:', error);
                container.innerHTML = `
                    <div class="stream-loading">
                        <p>Failed to load commits</p>
                    </div>
                `;
            }
        }

        function getTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 60) return 'just now';
            const minutes = Math.floor(seconds / 60);
            if (minutes < 60) return `${minutes}m ago`;
            const hours = Math.floor(minutes / 60);
            if (hours < 24) return `${hours}h ago`;
            const days = Math.floor(hours / 24);
            if (days < 7) return `${days}d ago`;
            return date.toLocaleDateString();
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        async function updateFactoryUserCredits() {
            const currentUser = getFactoryCurrentUser();
            const creditsEl = document.getElementById('factoryUserCredits');

            if (!currentUser || !creditsEl) {
                if (creditsEl) creditsEl.textContent = '0';
                return;
            }

            try {
                // Try to get user reputation from database
                let query = `${SUPABASE_URL}/rest/v1/factory_users?select=reputation`;

                if (currentUser.telegram_id) {
                    query += `&telegram_id=eq.${currentUser.telegram_id}`;
                } else if (currentUser.wallet_address) {
                    query += `&wallet_address=eq.${currentUser.wallet_address}`;
                } else if (currentUser.supabase_id) {
                    query += `&id=eq.${currentUser.supabase_id}`;
                }

                const response = await fetch(query, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (response.ok) {
                    const users = await response.json();
                    if (users.length > 0) {
                        creditsEl.textContent = users[0].reputation || 0;
                    }
                }
            } catch (error) {
                console.error('Failed to load user credits:', error);
            }
        }

        function startCreate(type) {
            const premiumTypes = ['saas', 'internal-tool', 'automation', 'mobile-app', 'api', 'enterprise'];
            const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));

            if (premiumTypes.includes(type)) {
                if (!isLoggedIn) {
                    openConnectModal();
                    return;
                }
            }

            window.location.href = `/factory.html?create=${type}`;
        }

        function enrollCreator() {
            const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));

            if (!isLoggedIn) {
                openConnectModal();
                return;
            }

            alert('Enrollment request submitted! We will review your application and get back to you soon.');
        }

        // ========================
        // AUTH STATE MANAGEMENT
        // ========================

        // Check for Telegram WebApp (Mini App) data
        function checkTelegramWebApp() {
            if (window.Telegram && window.Telegram.WebApp) {
                const webApp = window.Telegram.WebApp;
                const initData = webApp.initDataUnsafe;

                if (initData && initData.user) {
                    const user = initData.user;
                    const tgUser = {
                        id: user.id,
                        username: user.username || user.first_name,
                        first_name: user.first_name,
                        last_name: user.last_name,
                        photo_url: user.photo_url,
                        auth_date: Math.floor(Date.now() / 1000),
                        from_webapp: true
                    };

                    localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                    console.log('Logged in via Telegram WebApp:', tgUser.username);

                    // Expand the WebApp to full height
                    webApp.expand();

                    return true;
                }
            }
            return false;
        }

        // ========================
        // GOOGLE & EMAIL AUTH
        // ========================

        // Google OAuth login
        async function loginWithGoogle() {
            if (!supabaseClient) {
                alert('Auth system loading, please try again in a moment');
                return;
            }

            try {
                const { data, error } = await supabaseClient.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin + '/'
                    }
                });

                if (error) {
                    console.error('Google login error:', error);
                    alert('Login failed. Please try again.');
                }
                // User will be redirected to Google, then back
            } catch (err) {
                console.error('Google login error:', err);
                alert('Login failed. Please try again.');
            }
        }

        // Email auth state
        let emailAuthMode = 'check'; // 'check' or 'auth'

        function showEmailForm() {
            const primaryOptions = document.querySelector('.connect-options-primary');
            const emailForm = document.getElementById('emailAuthForm');
            if (primaryOptions) primaryOptions.style.display = 'none';
            if (emailForm) emailForm.style.display = 'flex';
            emailAuthMode = 'check';
            // Reset form state
            const passwordField = document.getElementById('authPassword');
            const emailBtn = document.getElementById('emailAuthBtn');
            if (passwordField) passwordField.style.display = 'none';
            if (emailBtn) emailBtn.textContent = 'Continue';
        }

        function hideEmailForm() {
            const primaryOptions = document.querySelector('.connect-options-primary');
            const emailForm = document.getElementById('emailAuthForm');
            if (primaryOptions) primaryOptions.style.display = 'flex';
            if (emailForm) emailForm.style.display = 'none';
            // Reset form
            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            if (emailInput) emailInput.value = '';
            if (passwordInput) {
                passwordInput.value = '';
                passwordInput.style.display = 'none';
            }
            emailAuthMode = 'check';
        }

        async function handleEmailAuth() {
            if (!supabaseClient) {
                alert('Auth system loading, please try again in a moment');
                return;
            }

            const emailInput = document.getElementById('authEmail');
            const passwordInput = document.getElementById('authPassword');
            const btn = document.getElementById('emailAuthBtn');

            const email = emailInput ? emailInput.value.trim() : '';
            const password = passwordInput ? passwordInput.value : '';

            if (!email) {
                alert('Please enter your email');
                return;
            }

            // Validate email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                alert('Please enter a valid email address');
                return;
            }

            if (emailAuthMode === 'check') {
                // Show password field
                if (passwordInput) passwordInput.style.display = 'block';
                if (btn) btn.textContent = 'Log in / Sign up';
                emailAuthMode = 'auth';
                passwordInput.focus();
                return;
            }

            // Validate password
            if (!password || password.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }

            // Disable button during auth
            if (btn) {
                btn.disabled = true;
                btn.textContent = 'Please wait...';
            }

            try {
                // Try to sign in first
                let { data, error } = await supabaseClient.auth.signInWithPassword({
                    email,
                    password
                });

                if (error) {
                    if (error.message.includes('Invalid login credentials')) {
                        // User doesn't exist or wrong password, try to sign up
                        const signUpResult = await supabaseClient.auth.signUp({
                            email,
                            password
                        });

                        if (signUpResult.error) {
                            throw signUpResult.error;
                        }

                        data = signUpResult.data;

                        // Check if email confirmation is required
                        if (data.user && !data.session) {
                            alert('Account created! Please check your email to confirm your account.');
                            hideEmailForm();
                            if (btn) {
                                btn.disabled = false;
                                btn.textContent = 'Continue';
                            }
                            return;
                        }
                    } else {
                        throw error;
                    }
                }

                // Success - close modal and update auth state
                if (data.user || data.session) {
                    closeConnectModal();
                    await checkAuthState();
                }
            } catch (err) {
                console.error('Email auth error:', err);
                alert(err.message || 'Authentication failed. Please try again.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.textContent = 'Log in / Sign up';
                }
            }
        }

        // Check for Supabase session on page load (for OAuth redirect)
        async function checkSupabaseSession() {
            if (!supabaseClient) return null;

            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                return session?.user || null;
            } catch (err) {
                console.error('Error checking Supabase session:', err);
                return null;
            }
        }

        // Check if user is logged in
        async function checkAuthState() {
            // First check if opened as Telegram WebApp
            checkTelegramWebApp();

            // Check Supabase session (Google/Email)
            const supabaseUser = await checkSupabaseSession();

            const wallet = localStorage.getItem('connectedWallet') ||
                          localStorage.getItem('walletAddress') ||
                          localStorage.getItem('suiteWalletAddress') ||
                          localStorage.getItem('suiteWallet');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {
                    console.error('Failed to parse telegram_user:', e);
                    localStorage.removeItem('telegram_user');
                }
            }

            const isLoggedIn = !!(wallet || telegramUser || supabaseUser);

            // Update sidebar profile
            const profileName = document.getElementById('sidebarProfileName');
            const profileStatus = document.getElementById('sidebarProfileStatus');
            const profileAvatar = document.getElementById('sidebarAvatar');
            const creditsSection = document.getElementById('profileCreditsSection');

            if (isLoggedIn) {
                document.body.classList.remove('logged-out');

                // Show credits section in dropdown
                if (creditsSection) creditsSection.style.display = 'block';

                if (supabaseUser) {
                    // Google/Email user
                    const displayName = supabaseUser.user_metadata?.full_name ||
                                       supabaseUser.user_metadata?.name ||
                                       supabaseUser.email?.split('@')[0] || 'User';
                    if (profileName) profileName.textContent = displayName;
                    if (profileAvatar) {
                        if (supabaseUser.user_metadata?.avatar_url) {
                            userAvatarUrl = supabaseUser.user_metadata.avatar_url;
                            profileAvatar.innerHTML = `<img src="${supabaseUser.user_metadata.avatar_url}" alt="${displayName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                        } else {
                            userAvatarUrl = null;
                            // Default avatar for email users
                            profileAvatar.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                                <circle cx="12" cy="7" r="4"/>
                            </svg>`;
                        }
                    }
                    // Fetch credits for email user
                    fetchUserCredits(supabaseUser.email, 'email');
                } else if (telegramUser) {
                    // Telegram user
                    const displayName = telegramUser.username || telegramUser.first_name || 'User';
                    if (profileName) profileName.textContent = displayName;
                    if (profileAvatar && telegramUser.photo_url) {
                        userAvatarUrl = telegramUser.photo_url;
                        profileAvatar.innerHTML = `<img src="${telegramUser.photo_url}" alt="${displayName}" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
                    } else {
                        userAvatarUrl = null;
                    }
                    // Fetch credits for telegram user
                    fetchUserCredits(telegramUser.id, 'telegram');
                } else if (wallet) {
                    // Wallet user
                    const shortWallet = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                    if (profileName) profileName.textContent = shortWallet;
                    // Fetch credits for wallet user
                    fetchUserCredits(wallet, 'wallet');
                }
            } else {
                document.body.classList.add('logged-out');
                userAvatarUrl = null; // Reset avatar for chat messages
                if (profileName) profileName.textContent = 'Get Started';
                if (profileStatus) profileStatus.textContent = 'Connect to save progress';
                if (creditsSection) creditsSection.style.display = 'none';
                if (profileAvatar) {
                    profileAvatar.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                        <circle cx="12" cy="7" r="4"/>
                    </svg>`;
                }
                // Reset credits display
                updateCreditsDisplay(0);
            }

            // Update linked accounts display in dropdown
            renderLinkedAccounts();

            return isLoggedIn;
        }

        // Fetch user credits from Supabase (suite_credits table with unified auth)
        async function fetchUserCredits(userId, authType) {
            try {
                let credits = 0;

                if (authType === 'wallet') {
                    // Direct query by wallet address
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/suite_credits?wallet_address=eq.${userId.toLowerCase()}&select=balance`,
                        {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.balance || 0;
                    }
                } else if (authType === 'telegram') {
                    // Use RPC function for telegram lookup
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/get_credits_by_telegram`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ tg_id: String(userId) })
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.user_balance || 0;
                    }
                } else if (authType === 'email') {
                    // Use RPC to get or create credits for email user
                    const supabaseUser = await checkSupabaseSession();
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/get_or_create_credits_by_email`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                p_email: userId,
                                p_supabase_id: supabaseUser?.id || null
                            })
                        }
                    );
                    if (response.ok) {
                        const data = await response.json();
                        credits = data[0]?.user_balance || 0;
                    }

                    // Auto-link: If wallet exists locally, try to link email to it
                    const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (wallet && supabaseUser) {
                        await autoLinkEmailToWallet(wallet, userId, supabaseUser.id);
                    }
                }

                updateCreditsDisplay(credits);
            } catch (error) {
                console.error('Error fetching credits:', error);
                updateCreditsDisplay(0);
            }
        }

        // Auto-link email to wallet when both are present
        async function autoLinkEmailToWallet(walletAddress, email, supabaseId) {
            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/rpc/link_email_to_wallet`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            p_wallet_address: walletAddress,
                            p_email: email,
                            p_supabase_id: supabaseId
                        })
                    }
                );
                if (response.ok) {
                    const result = await response.json();
                    if (result.success) {
                        console.log('[Auth] Auto-linked email to wallet:', result.merged ? `merged ${result.merged_credits} credits` : 'linked');
                    } else {
                        console.log('[Auth] Could not auto-link email to wallet:', result.error);
                    }
                }
            } catch (error) {
                console.error('[Auth] Error auto-linking email:', error);
            }
        }

        // Render linked accounts in the profile dropdown
        async function renderLinkedAccounts() {
            const container = document.getElementById('linkedAccountsList');
            if (!container) return;

            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {}
            }
            const supabaseUser = await checkSupabaseSession();

            let html = '';

            // Wallet status - always show connect option if not connected
            if (wallet) {
                const shortWallet = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                html += `
                    <button class="link-account-btn connected" onclick="disconnectWallet()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Wallet</span>
                        <span class="linked-account-value">${shortWallet}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="connectWalletToLink()">+ Connect Wallet</button>`;
            }

            // Google/Email status - always show connect option if not connected
            if (supabaseUser) {
                const displayEmail = supabaseUser.email?.length > 20
                    ? supabaseUser.email.slice(0, 17) + '...'
                    : supabaseUser.email;
                html += `
                    <button class="link-account-btn connected" onclick="disconnectGoogle()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Google</span>
                        <span class="linked-account-value">${displayEmail}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="linkGoogleAccount()">+ Link Google</button>`;
            }

            // Telegram status - always show connect option if not connected
            if (telegramUser) {
                const tgDisplay = telegramUser.username ? `@${telegramUser.username}` : telegramUser.first_name;
                html += `
                    <button class="link-account-btn connected" onclick="disconnectTelegram()">
                        <span class="linked-account-status"><span class="checkmark">&#10003;</span> Telegram</span>
                        <span class="linked-account-value">${tgDisplay}</span>
                    </button>
                `;
            } else {
                html += `<button class="link-account-btn" onclick="linkTelegramAccount()">+ Link Telegram</button>`;
            }

            // Always show the linked accounts section (guests can connect)
            const section = document.getElementById('linkedAccountsSection');
            if (section) {
                section.style.display = 'block';
            }

            container.innerHTML = html || '<div class="linked-account" style="color:var(--text-tertiary)">No accounts linked</div>';
        }

        // Link Google account to existing wallet/telegram
        async function linkGoogleAccount() {
            if (!supabaseClient) {
                alert('Auth system not ready. Please refresh the page.');
                return;
            }

            // Use clean redirect URL (origin + pathname only)
            const redirectUrl = window.location.origin + window.location.pathname;
            console.log('[Auth] Starting Google OAuth, redirect to:', redirectUrl);

            // Trigger Google OAuth - auto-linking happens in auth state change handler
            const { data, error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: { redirectTo: redirectUrl }
            });

            if (error) {
                console.error('[Auth] Google OAuth error:', error);
                alert('Failed to start Google sign-in: ' + error.message);
            }
        }

        // Connect wallet for linking (when user has email but no wallet)
        async function connectWalletToLink() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];

                // Store wallet
                localStorage.setItem('connectedWallet', walletAddress);

                // Try to link wallet to email credits
                const supabaseUser = await checkSupabaseSession();
                if (supabaseUser) {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/rpc/link_wallet_to_email`,
                        {
                            method: 'POST',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                p_wallet_address: walletAddress,
                                p_email: supabaseUser.email
                            })
                        }
                    );

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            console.log('[Auth] Linked wallet to email account');
                            alert('Wallet linked successfully! You can now withdraw credits.');
                            // Fetch wallet credits directly since that's where the merged balance is
                            await fetchUserCredits(walletAddress, 'wallet');
                        } else {
                            console.warn('[Auth] Could not link wallet:', result.error);
                            if (result.error?.includes('already has credits')) {
                                alert('This wallet already has credits associated with it. Contact support to merge accounts.');
                            }
                        }
                    }
                }

                // Refresh UI
                checkAuthState();
                renderLinkedAccounts();

            } catch (error) {
                console.error('[Auth] Wallet connection error:', error);
                if (error.code === 4001) {
                    alert('Connection cancelled');
                } else {
                    alert('Failed to connect wallet: ' + error.message);
                }
            }
        }

        // Link Telegram account using widget
        function linkTelegramAccount() {
            const botId = '8341049569'; // SUITEHubBot
            const botUsername = 'SUITEHubBot';

            // Check if mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile: Open Telegram app directly
                window.location.href = `tg://resolve?domain=${botUsername}&start=link`;
                setTimeout(() => {
                    window.location.href = `https://t.me/${botUsername}?start=link`;
                }, 500);
            } else {
                // On desktop: Use Telegram Login Widget
                if (!window.Telegram || !window.Telegram.Login) {
                    const script = document.createElement('script');
                    script.src = 'https://telegram.org/js/telegram-widget.js?22';
                    script.onload = () => openTelegramLinkAuth(botId);
                    document.head.appendChild(script);
                } else {
                    openTelegramLinkAuth(botId);
                }
            }
        }

        function openTelegramLinkAuth(botId) {
            window.Telegram.Login.auth(
                { bot_id: botId, request_access: true },
                async (user) => {
                    if (user) {
                        // Store Telegram user
                        const tgUser = {
                            id: user.id,
                            username: user.username || user.first_name,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            photo_url: user.photo_url,
                            auth_date: user.auth_date,
                            hash: user.hash
                        };
                        localStorage.setItem('telegram_user', JSON.stringify(tgUser));

                        // Link to existing wallet/email in database
                        const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                        if (wallet) {
                            try {
                                await fetch(`${SUPABASE_URL}/rest/v1/rpc/link_telegram_to_wallet`, {
                                    method: 'POST',
                                    headers: {
                                        'apikey': SUPABASE_ANON_KEY,
                                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                        'Content-Type': 'application/json'
                                    },
                                    body: JSON.stringify({
                                        p_wallet_address: wallet,
                                        p_telegram_id: String(user.id),
                                        p_telegram_username: user.username || null
                                    })
                                });
                            } catch (e) {
                                console.error('Error linking Telegram:', e);
                            }
                        }

                        checkAuthState();
                        renderLinkedAccounts();
                    }
                }
            );
        }

        // Credits state (must be declared before updateCreditsDisplay)
        // Disconnect functions
        function disconnectWallet() {
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('suiteWalletAddress');
            checkAuthState();
            renderLinkedAccounts();
        }

        async function disconnectGoogle() {
            if (supabaseClient) {
                await supabaseClient.auth.signOut();
            }
            checkAuthState();
            renderLinkedAccounts();
        }

        function disconnectTelegram() {
            localStorage.removeItem('telegram_user');
            checkAuthState();
            renderLinkedAccounts();
        }

        let userCredits = 0;
        let userAvatarUrl = null; // Store user's profile picture for chat messages

        // Update credits display in sidebar and dropdown
        function updateCreditsDisplay(credits) {
            userCredits = credits;
            const formattedCredits = credits.toLocaleString();
            const usdValue = (credits / 1000).toFixed(2);

            // Update sidebar status (only when logged in)
            const profileStatus = document.getElementById('sidebarProfileStatus');
            if (profileStatus && !document.body.classList.contains('logged-out')) {
                profileStatus.textContent = `${formattedCredits} credits`;
            }

            // Update dropdown credits
            const dropdownCredits = document.getElementById('dropdownCredits');
            if (dropdownCredits) dropdownCredits.textContent = formattedCredits;

            // Update withdrawal modal if it exists
            const withdrawalCredits = document.getElementById('withdrawalCredits');
            const withdrawalValue = document.getElementById('withdrawalValue');
            if (withdrawalCredits) withdrawalCredits.textContent = formattedCredits;
            if (withdrawalValue) withdrawalValue.textContent = `~$${usdValue} USD value`;
        }

        // Start a new chat
        function startNewChat() {
            // Close builder mode if open
            exitBuilderMode();

            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const learnView = document.getElementById('learnView');

            // Clear chat
            if (chatMessages) chatMessages.innerHTML = '';

            // Reset conversation history and current chat ID
            if (typeof conversationHistory !== 'undefined') {
                conversationHistory = [];
            }
            if (typeof currentChatId !== 'undefined') {
                currentChatId = null;
            }

            // Clear insights
            if (typeof clearInsights === 'function') {
                clearInsights();
            }

            // Hide all other views
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');

            // Close connections view if open
            const connectionsView = document.getElementById('connectionsView');
            if (connectionsView) connectionsView.classList.remove('active');

            // Also hide article reader if open
            hideArticle();

            // Reset UI to welcome state
            if (welcomeState) {
                welcomeState.style.display = '';
                welcomeState.classList.remove('chat-active');
            }
            // Also remove active class from chat container
            const chatContainer = document.getElementById('chatContainer');
            if (chatContainer) {
                chatContainer.classList.remove('active');
            }
            if (useCasesSection) {
                useCasesSection.style.display = 'block';
            }
            if (chatInput) {
                chatInput.value = '';
                chatInput.focus();
            }

            // Reset model selector to Auto (default)
            currentModel = 'flash';
            const modelNameEl = document.getElementById('modelName');
            if (modelNameEl) modelNameEl.textContent = 'Auto';
            // Reset dropdown active state
            document.querySelectorAll('.model-dropdown-item').forEach(item => item.classList.remove('active'));
            const autoItem = document.querySelector('.model-dropdown-item[data-mode="auto"]');
            if (autoItem) autoItem.classList.add('active');

            // Update URL to /chat
            history.pushState({ view: 'chat' }, '', '/chat');

            // Close mobile sidebar if open
            closeMobileSidebar();
        }

        // Toggle chat search (placeholder for future implementation)
        function toggleChatSearch() {
            // For now, focus the chat input and show a search hint
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.placeholder = 'Search your chats...';
                chatInput.focus();
                // Reset placeholder after a delay
                setTimeout(() => {
                    chatInput.placeholder = 'I need help with...';
                }, 3000);
            }
        }

        // Open login modal
        function openLoginModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Open signup modal (same as login)
        function openSignupModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Alias for openLoginModal (used in various places)
        function openConnectModal() {
            document.getElementById('connectModalOverlay').classList.add('active');
        }

        // Close connect modal
        function closeConnectModal() {
            document.getElementById('connectModalOverlay').classList.remove('active');
        }

        // Sidebar toggle functions
        function closeSidebar() {
            document.getElementById('sidebar').classList.add('collapsed');
            document.querySelector('.main-content').classList.add('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.add('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.add('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'true');
        }

        function openSidebar() {
            document.getElementById('sidebar').classList.remove('collapsed');
            document.querySelector('.main-content').classList.remove('sidebar-collapsed');
            document.querySelector('.bg-gradient').classList.remove('sidebar-collapsed');
            document.getElementById('sidebarOpenBtn').classList.remove('visible');
            localStorage.setItem('suitegpt_sidebar_collapsed', 'false');
        }

        // Restore sidebar state on load
        if (localStorage.getItem('suitegpt_sidebar_collapsed') === 'true') {
            closeSidebar();
        }

        // Connect wallet
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                if (accounts.length > 0) {
                    const address = accounts[0];
                    localStorage.setItem('connectedWallet', address);
                    localStorage.setItem('suiteWalletAddress', address);
                    localStorage.setItem('suiteWallet', address);
                    window.walletAddress = address;

                    console.log('Wallet connected:', address);
                    closeConnectModal();
                    checkAuthState();

                    // Dispatch event for other components
                    window.dispatchEvent(new CustomEvent('navAuthChanged', { detail: { wallet: address } }));
                }
            } catch (error) {
                console.error('Wallet connection failed:', error);
                if (error.code === 4001) {
                    console.log('Connection cancelled by user');
                }
            }
        }

        // Telegram login
        function loginWithTelegram() {
            const botId = '8341049569'; // SUITEHubBot
            const botUsername = 'SUITEHubBot';
            closeConnectModal();

            // Check if mobile
            const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

            if (isMobile) {
                // On mobile: Open Telegram app directly to bot
                // User can tap the Menu button in bot to login via web app
                window.location.href = `tg://resolve?domain=${botUsername}&start=login`;

                // Fallback to t.me link if tg:// doesn't work
                setTimeout(() => {
                    window.location.href = `https://t.me/${botUsername}?start=login`;
                }, 500);
            } else {
                // On desktop: Use standard widget
                if (!window.Telegram || !window.Telegram.Login) {
                    const script = document.createElement('script');
                    script.src = 'https://telegram.org/js/telegram-widget.js?22';
                    script.onload = () => openTelegramAuth(botId);
                    document.head.appendChild(script);
                } else {
                    openTelegramAuth(botId);
                }
            }
        }

        function openTelegramAuth(botId) {
            window.Telegram.Login.auth(
                { bot_id: botId, request_access: true },
                (user) => {
                    if (user) {
                        const tgUser = {
                            id: user.id,
                            username: user.username || user.first_name,
                            first_name: user.first_name,
                            last_name: user.last_name,
                            photo_url: user.photo_url,
                            auth_date: user.auth_date,
                            hash: user.hash
                        };

                        localStorage.setItem('telegram_user', JSON.stringify(tgUser));
                        checkAuthState();
                        window.location.reload();
                    }
                }
            );
        }

        // Initial auth state check is deferred until Supabase is ready
        // See Supabase initialization section below

        // Listen for auth changes
        window.addEventListener('storage', (e) => {
            if (['connectedWallet', 'walletAddress', 'suiteWalletAddress', 'telegram_user'].includes(e.key)) {
                checkAuthState();
            }
        });

        // Listen for custom auth events from nav component
        window.addEventListener('navAuthChanged', () => {
            checkAuthState();
        });

        // ========================
        // SUITE Apps Catalog
        // ========================
        const SUITE_APPS = {
            'foodvitals': {
                name: 'FoodVitals',
                description: 'Weekly meal tracking + AI nutrition insights',
                iconUrl: '/assets/icons/foodvitals-icon.jpg',
                iconBg: 'linear-gradient(135deg, #22c55e, #16a34a)',
                url: '/foodvitals/',
                screens: ['/foodvitals/']
            },
            'trueform': {
                name: 'TrueForm AI',
                description: 'AI physiotherapy and exercise guidance',
                iconUrl: '/assets/icons/trueform-icon.jpg',
                iconBg: 'linear-gradient(135deg, #3b82f6, #1d4ed8)',
                url: '/trueform/',
                screens: ['/trueform/', '/trueform/scan.html', '/trueform/exercises.html', '/trueform/reports.html']
            },
            'opticrep': {
                name: 'OpticRep',
                description: 'AI workout trainer with form analysis',
                iconUrl: '/assets/icons/opticrep-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f97316, #ea580c)',
                url: '/opticrep/',
                screens: ['/opticrep/workout.html', '/opticrep/coach.html', '/opticrep/journal.html']
            },
            'cheshbon': {
                name: 'Cheshbon',
                description: 'Bible reading & reflection app with AI-powered insights and customizable reading plans',
                iconUrl: '/assets/icons/cheshbon-icon.jpg',
                iconBg: 'linear-gradient(135deg, #eab308, #ca8a04)',
                url: '/cheshbon/',
                screens: ['/cheshbon/']
            },
            'remcast': {
                name: 'RemCast',
                description: 'Dream journal with AI analysis, image generation, and video reels from your dreams',
                iconUrl: '/assets/icons/remcast-icon.jpg',
                iconBg: 'linear-gradient(135deg, #8b5cf6, #7c3aed)',
                url: '/remcast-app/',
                screens: ['/remcast-app/', '/remcast-app/journal.html', '/remcast-app/profile.html']
            },
            'defi-knowledge': {
                name: 'DeFi Knowledge',
                description: 'Learn DeFi concepts and strategies',
                iconUrl: '/assets/icons/defiknowledge-icon.png',
                iconBg: 'linear-gradient(135deg, #06b6d4, #0891b2)',
                url: '/defi-knowledge-app/',
                screens: ['/defi-knowledge-app/']
            },
            'cadence-ai': {
                name: 'Cadence AI',
                description: 'AI-powered social media scheduling',
                iconUrl: '/assets/icons/cadence-icon.jpg',
                iconBg: 'linear-gradient(135deg, #ec4899, #db2777)',
                url: 'https://cadence-ai-nextjs.vercel.app'
            },
            // Spirituality Apps
            'jesus-is-god': {
                name: 'Jesus Is God',
                description: 'Explore the truth of who Jesus is',
                iconUrl: '/assets/icons/jesus-is-god-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f59e0b, #d97706)',
                url: '/jesus-is-god.html'
            },
            // Health & Wellness Apps
            'hydrotrack': {
                name: 'HydroTrack',
                description: 'Track your daily water intake',
                iconUrl: '/assets/icons/hydrotrack-icon.jpg',
                iconBg: 'linear-gradient(135deg, #38bdf8, #0284c7)',
                url: '/hydrotrack.html'
            },
            'sleepwell': {
                name: 'SleepWell',
                description: 'AI sleep quality tracker',
                iconUrl: '/assets/icons/sleepwell-icon.jpg',
                iconBg: 'linear-gradient(135deg, #818cf8, #4f46e5)',
                url: '/sleepwell.html'
            },
            'moodlog': {
                name: 'MoodLog',
                description: 'Track emotions, find patterns',
                iconUrl: '/assets/icons/moodlog-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f472b6, #db2777)',
                url: '/moodlog.html'
            },
            'pillpal': {
                name: 'PillPal',
                description: 'Never miss a medication',
                iconUrl: '/assets/icons/pillpal-icon.jpg',
                iconBg: 'linear-gradient(135deg, #fb7185, #e11d48)',
                url: '/pillpal.html'
            },
            'breatheasy': {
                name: 'BreathEasy',
                description: 'Guided breathing exercises',
                iconUrl: '/assets/icons/breatheasy-icon.jpg',
                iconBg: 'linear-gradient(135deg, #5eead4, #14b8a6)',
                url: '/breatheasy.html'
            },
            'stepgoal': {
                name: 'StepGoal',
                description: 'Daily step counter & goals',
                iconUrl: '/assets/icons/stepgoal-icon.jpg',
                iconBg: 'linear-gradient(135deg, #a3e635, #65a30d)',
                url: '/stepgoal.html'
            },
            'stretchtimer': {
                name: 'StretchTimer',
                description: 'Desk break reminders',
                iconUrl: '/assets/icons/stretchtimer-icon.jpg',
                iconBg: 'linear-gradient(135deg, #c084fc, #9333ea)',
                url: '/stretchtimer.html'
            },
            // Productivity & Learning Apps
            'focusflow': {
                name: 'FocusFlow',
                description: 'Pomodoro timer with stats',
                iconUrl: '/assets/icons/focusflow-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f97316, #c2410c)',
                url: '/focusflow.html'
            },
            'quickbudget': {
                name: 'QuickBudget',
                description: 'Simple expense tracker',
                iconUrl: '/assets/icons/quickbudget-icon.jpg',
                iconBg: 'linear-gradient(135deg, #4ade80, #16a34a)',
                url: '/quickbudget.html'
            },
            'flashmind': {
                name: 'FlashMind',
                description: 'AI-powered flashcards',
                iconUrl: '/assets/icons/flashmind-icon.jpg',
                iconBg: 'linear-gradient(135deg, #60a5fa, #2563eb)',
                url: '/flashmind.html'
            },
            'bookshelf': {
                name: 'BookShelf',
                description: 'Track books & reading goals',
                iconUrl: '/assets/icons/bookshelf-icon.jpg',
                iconBg: 'linear-gradient(135deg, #a78bfa, #7c3aed)',
                url: '/bookshelf.html'
            },
            'skilltree': {
                name: 'SkillTree',
                description: 'Track learning progress',
                iconUrl: '/assets/icons/skilltree-icon.jpg',
                iconBg: 'linear-gradient(135deg, #34d399, #059669)',
                url: '/skilltree.html'
            },
            'mealprep': {
                name: 'MealPrep',
                description: 'Weekly meal planner',
                iconUrl: '/assets/icons/mealprep-icon.jpg',
                iconBg: 'linear-gradient(135deg, #fbbf24, #d97706)',
                url: '/mealprep.html'
            },
            'cleanhome': {
                name: 'CleanHome',
                description: 'Cleaning schedule & tasks',
                iconUrl: '/assets/icons/cleanhome-icon.jpg',
                iconBg: 'linear-gradient(135deg, #2dd4bf, #0d9488)',
                url: '/cleanhome.html'
            },
            // Lifestyle & Social Apps
            'datenight': {
                name: 'DateNight',
                description: 'Date ideas & planning',
                iconUrl: '/assets/icons/datenight-icon.jpg',
                iconBg: 'linear-gradient(135deg, #fb7185, #be123c)',
                url: '/datenight.html'
            },
            'petcare': {
                name: 'PetCare',
                description: 'Pet health & care tracker',
                iconUrl: '/assets/icons/petcare-icon.jpg',
                iconBg: 'linear-gradient(135deg, #fdba74, #ea580c)',
                url: '/petcare.html'
            },
            'packlight': {
                name: 'PackLight',
                description: 'Smart packing lists',
                iconUrl: '/assets/icons/packlight-icon.jpg',
                iconBg: 'linear-gradient(135deg, #93c5fd, #1d4ed8)',
                url: '/packlight.html'
            },
            'giftguru': {
                name: 'GiftGuru',
                description: 'Gift ideas & tracking',
                iconUrl: '/assets/icons/giftguru-icon.jpg',
                iconBg: 'linear-gradient(135deg, #f0abfc, #a855f7)',
                url: '/giftguru.html'
            },
            'habitstack': {
                name: 'HabitStack',
                description: 'Chain habits together',
                iconUrl: '/assets/icons/habitstack-icon.jpg',
                iconBg: 'linear-gradient(135deg, #fcd34d, #b45309)',
                url: '/habitstack.html'
            },
            'quickdecide': {
                name: 'QuickDecide',
                description: 'Decision helper & coin flip',
                iconUrl: '/assets/icons/quickdecide-icon.jpg',
                iconBg: 'linear-gradient(135deg, #67e8f9, #0891b2)',
                url: '/quickdecide.html'
            },
            'visual-feedback': {
                name: 'Visual Feedback',
                description: 'Chrome extension for agentic coding - Alt+X to select elements',
                iconUrl: '/assets/icons/visual-feedback-icon.jpg',
                iconBg: 'linear-gradient(135deg, #6366f1, #8b5cf6)',
                url: '/extensions/suite-visual-feedback/',
                isExtension: true
            },
            // Platforms
            'proto-golf': {
                name: 'ProtoGolf',
                description: 'AI-powered golf training platform with swing analysis',
                iconUrl: '/assets/icons/protogolf-icon.jpg',
                iconBg: 'linear-gradient(135deg, #22c55e, #15803d)',
                url: '/proto-golf-site/index.html'
            },
            'galtwoodco': {
                name: 'Galtwood Co',
                description: 'Custom woodworking & live edge furniture',
                iconUrl: '/assets/icons/galtwoodco-icon.jpg',
                iconBg: 'linear-gradient(135deg, #c9a66b, #8b6914)',
                url: '/galtwoodco/index.html'
            },
            'movestrong': {
                name: 'MoveStrong',
                description: 'Functional fitness equipment & training',
                iconUrl: '/assets/icons/movestrong-icon.jpg',
                iconBg: 'linear-gradient(135deg, #ef4444, #b91c1c)',
                url: '/movestrong/index.html'
            },
            'transcribe': {
                name: 'Transcribe',
                description: 'Transcribe audio & video files using AI',
                iconBg: 'linear-gradient(135deg, #8b5cf6, #6d28d9)',
                url: '/transcribe.html'
            },
            'bgswap': {
                name: 'Background Swap',
                description: 'Remove & replace photo backgrounds with AI',
                iconBg: 'linear-gradient(135deg, #ec4899, #be185d)',
                url: '/bgswap.html'
            }
        };

        // Compact app catalog for AI insights analysis
        const SUITE_APPS_COMPACT = Object.entries(SUITE_APPS)
            .map(([key, app]) => `${key}: ${app.description}`)
            .join('\n');

        // ========================
        // APPS PANEL FUNCTIONALITY
        // ========================

        // Track current active category
        let currentAppsCategory = 'all';

        function openAppsPanel(skipPushState = false) {
            // Close builder mode if open
            exitBuilderMode();

            // Show inline apps view instead of modal
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const appDetailView = document.getElementById('appDetailView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const connectionsView = document.getElementById('connectionsView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views, show apps view
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (connectionsView) connectionsView.classList.remove('active');
            if (appDetailView) appDetailView.classList.remove('active');
            if (appsView) appsView.classList.add('active');
            currentDetailAppKey = null;

            // Also hide article reader if open
            hideArticle();

            // Update URL to /apps
            if (!skipPushState) {
                history.pushState({ view: 'apps' }, '', '/apps');
            }

            // Scroll to top of chat area
            if (chatArea) chatArea.scrollTop = 0;
            closeMobileSidebar();

            // Render the new UI
            renderFeaturedApps();
            renderCategoryTabs();
            renderAppsGrid('all');

            // Focus search input
            setTimeout(() => {
                const searchInput = document.getElementById('appsViewSearch');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        function renderFeaturedApps() {
            const container = document.getElementById('appsFeaturedScroll');
            if (!container) return;

            const featuredApps = FEATURED_APPS
                .map(key => ({ key, ...SUITE_APPS[key] }))
                .filter(app => app.name); // Filter out any undefined apps

            container.innerHTML = featuredApps.map((app, index) => {
                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';

                return `
                    <div class="apps-featured-item" onclick="launchApp('${app.key}', '${app.url}', '${app.name}')">
                        ${index === 0 ? '<span class="apps-featured-badge">HOT</span>' : ''}
                        <div class="apps-view-item-icon" style="background: ${app.iconBg}">
                            ${iconHtml}
                        </div>
                        <div class="apps-view-item-name">${app.name}</div>
                    </div>
                `;
            }).join('');
        }

        function renderCategoryTabs() {
            const container = document.getElementById('appsCategoryTabs');
            if (!container) return;

            container.innerHTML = Object.entries(APP_CATEGORIES).map(([key, cat]) => `
                <button class="apps-category-tab ${key === currentAppsCategory ? 'active' : ''}"
                        onclick="switchCategory('${key}')"
                        data-category="${key}">
                    <span class="apps-category-tab-icon">${cat.icon}</span>${cat.label}
                </button>
            `).join('');
        }

        function switchCategory(category) {
            currentAppsCategory = category;

            // Update active tab
            document.querySelectorAll('.apps-category-tab').forEach(tab => {
                tab.classList.toggle('active', tab.dataset.category === category);
            });

            // Re-render the grid
            renderAppsGrid(category);
        }

        function renderAppsGrid(category) {
            const container = document.getElementById('appsGrid');
            if (!container) return;

            // Filter apps by category
            const apps = Object.entries(SUITE_APPS)
                .map(([key, app]) => ({ key, ...app }))
                .filter(app => {
                    if (category === 'all') return true;
                    const appCategory = APP_CATEGORY_MAP[app.key] || 'lifestyle';
                    return appCategory === category;
                });

            container.innerHTML = apps.map(app => {
                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : app.icon || '';

                return `
                    <div class="apps-view-item"
                         data-name="${app.name.toLowerCase()}"
                         data-desc="${app.description.toLowerCase()}"
                         data-category="${APP_CATEGORY_MAP[app.key] || 'lifestyle'}"
                         onclick="launchApp('${app.key}', '${app.url}', '${app.name}')">
                        <div class="apps-view-item-icon" style="background: ${app.iconBg}">
                            ${iconHtml}
                        </div>
                        <div class="apps-view-item-name">${app.name}</div>
                        <div class="apps-view-item-desc">${app.description}</div>
                    </div>
                `;
            }).join('');
        }

        function closeAppsView(skipPushState = false) {
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const appDetailView = document.getElementById('appDetailView');
            const useCasesSection = document.getElementById('useCasesSection');
            const searchInput = document.getElementById('appsViewSearch');

            // Show welcome state, hide apps view and detail view
            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';
            if (appsView) appsView.classList.remove('active');
            if (appDetailView) appDetailView.classList.remove('active');
            if (searchInput) searchInput.value = '';

            // Reset category to all
            currentAppsCategory = 'all';
            currentDetailAppKey = null;

            // Update URL back to root
            if (!skipPushState) {
                history.pushState({ view: 'home' }, '', '/');
            }
        }

        function closeAppsPanel() {
            // Keep for backwards compatibility
            closeAppsView();
        }

        function switchAppsTab(tierId) {
            // Legacy function - redirect to category switching
            switchCategory('all');
        }

        function filterApps(query) {
            const items = document.querySelectorAll('.apps-panel-item');
            const lower = query.toLowerCase();

            items.forEach(item => {
                const name = item.dataset.name;
                const desc = item.dataset.desc;
                const matches = name.includes(lower) || desc.includes(lower);
                item.style.display = matches ? '' : 'none';
            });
        }

        function filterAppsInline(query) {
            const lower = query.toLowerCase().trim();
            const featuredSection = document.getElementById('appsFeaturedSection');
            const categoriesSection = document.querySelector('.apps-categories');

            // If searching, hide featured and categories, show all matching apps
            if (lower.length > 0) {
                if (featuredSection) featuredSection.style.display = 'none';
                if (categoriesSection) categoriesSection.style.display = 'none';

                // Show all apps that match, regardless of category
                const container = document.getElementById('appsGrid');
                const allApps = Object.entries(SUITE_APPS)
                    .map(([key, app]) => ({ key, ...app }))
                    .filter(app => {
                        const name = app.name.toLowerCase();
                        const desc = app.description.toLowerCase();
                        return name.includes(lower) || desc.includes(lower);
                    });

                container.innerHTML = allApps.map(app => {
                    const iconHtml = app.iconUrl
                        ? `<img src="${app.iconUrl}" alt="${app.name}">`
                        : app.icon || '';

                    return `
                        <div class="apps-view-item"
                             data-name="${app.name.toLowerCase()}"
                             data-desc="${app.description.toLowerCase()}"
                             onclick="launchApp('${app.key}', '${app.url}', '${app.name}')">
                            <div class="apps-view-item-icon" style="background: ${app.iconBg}">
                                ${iconHtml}
                            </div>
                            <div class="apps-view-item-name">${app.name}</div>
                            <div class="apps-view-item-desc">${app.description}</div>
                        </div>
                    `;
                }).join('');
            } else {
                // Restore normal view
                if (featuredSection) featuredSection.style.display = '';
                if (categoriesSection) categoriesSection.style.display = '';
                renderAppsGrid(currentAppsCategory);
            }
        }

        // Apps source state
        let currentAppsSource = 'suite';
        let communityAppsCache = [];

        function switchAppsSource(source, skipPushState) {
            currentAppsSource = source;

            // Update toggle buttons
            document.getElementById('appsSuiteBtn').classList.toggle('active', source === 'suite');
            document.getElementById('appsCommunityBtn').classList.toggle('active', source === 'community');

            // Show/hide sections
            document.getElementById('appsSuiteSection').style.display = source === 'suite' ? '' : 'none';
            document.getElementById('appsCommunitySection').style.display = source === 'community' ? '' : 'none';

            // Update URL
            if (!skipPushState) {
                const url = source === 'community' ? '/apps/community' : '/apps';
                history.pushState({ view: 'apps', source: source }, '', url);
            }

            // Load community apps if needed
            if (source === 'community') {
                loadCommunityApps();
            }
        }

        async function loadCommunityApps() {
            const grid = document.getElementById('communityAppsGrid');
            const emptyState = document.getElementById('communityEmptyState');

            if (!supabaseClient) {
                if (grid) grid.innerHTML = '';
                if (emptyState) emptyState.style.display = 'flex';
                return;
            }

            try {
                // Fetch operators (community partners) from suite_operators
                const { data: operators, error } = await supabaseClient
                    .from('suite_operators')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Only show operators that have a linked app
                communityAppsCache = (operators || []).filter(op => (op.app_key && SUITE_APPS[op.app_key]) || op.user_app_id);
                updateCommunityAppsCount(communityAppsCache.length);

                if (communityAppsCache.length === 0) {
                    if (grid) grid.innerHTML = '';
                    if (emptyState) emptyState.style.display = 'flex';
                    return;
                }

                if (emptyState) emptyState.style.display = 'none';
                renderCommunityApps(communityAppsCache);

            } catch (error) {
                console.error('Error loading community partners:', error);
                if (grid) grid.innerHTML = '';
                if (emptyState) emptyState.style.display = 'flex';
            }
        }

        function renderCommunityApps(operators) {
            const grid = document.getElementById('communityAppsGrid');
            if (!grid) return;

            grid.innerHTML = operators.map(op => {
                const linkedApp = SUITE_APPS[op.app_key];
                const isUserApp = !linkedApp && op.user_app_id;

                // Skip if neither a linked SUITE app nor a user app
                if (!linkedApp && !isUserApp) return '';

                const statusClass = op.status || 'active';
                const statusLabel = {
                    'active': 'Active',
                    'pending': 'Pending',
                    'completed': 'Live',
                    'paused': 'Paused'
                }[statusClass] || statusClass;

                const iconBg = linkedApp ? (linkedApp.iconBg || 'linear-gradient(135deg, #6366f1, #8b5cf6)') : (op.icon_bg || 'linear-gradient(135deg, #22c55e, #10b981)');
                const iconContent = linkedApp && linkedApp.iconUrl ? `<img src="${linkedApp.iconUrl}" alt="${op.name}">` : (isUserApp ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>' : '');
                const cardClickAction = isUserApp && op.slug
                    ? `openAppDetail('${op.slug}')`
                    : isUserApp
                        ? `launchCommunityApp('${op.user_app_id}')`
                        : `launchApp('${op.app_key}', '${linkedApp.url}', '${linkedApp.name}')`;
                const directLaunchAction = isUserApp ? `launchCommunityApp('${op.user_app_id}')` : `launchApp('${op.app_key}', '${linkedApp.url}', '${linkedApp.name}')`;
                const desc = op.description || (linkedApp ? linkedApp.description : '') || 'Community app';

                return `
                    <div class="apps-view-item community-app-card"
                         data-name="${op.name.toLowerCase()}"
                         data-desc="${(op.description || '').toLowerCase()}"
                         onclick="${cardClickAction}">
                        <div class="community-app-badge">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="12" height="12">
                                <path d="M3 21h18M5 21V7l8-4v18M19 21V11l-6-4"/>
                            </svg>
                            ${statusLabel}
                        </div>
                        <div class="apps-view-item-icon" style="background: ${iconBg}">
                            ${iconContent}
                        </div>
                        <div class="apps-view-item-name">${op.name}</div>
                        <div class="apps-view-item-desc">${desc}</div>
                        <button class="community-app-launch-btn" onclick="event.stopPropagation(); ${directLaunchAction}">Open App</button>
                    </div>
                `;
            }).join('');
        }

        function filterCommunityApps(query) {
            const lower = query.toLowerCase().trim();

            if (lower.length === 0) {
                renderCommunityApps(communityAppsCache);
                return;
            }

            const filtered = communityAppsCache.filter(app => {
                const name = app.name.toLowerCase();
                const desc = (app.description || '').toLowerCase();
                return name.includes(lower) || desc.includes(lower);
            });

            renderCommunityApps(filtered);
        }

        function updateCommunityAppsCount(count) {
            const countEl = document.getElementById('communityAppsCount');
            if (countEl) countEl.textContent = count;
        }

        async function launchCommunityApp(appId) {
            if (!supabaseClient) return;

            try {
                // Fetch the app code
                const { data: app, error } = await supabaseClient
                    .from('user_apps')
                    .select('*')
                    .eq('id', appId)
                    .single();

                if (error) throw error;

                // Increment uses count
                supabaseClient
                    .from('user_apps')
                    .update({ uses: (app.uses || 0) + 1 })
                    .eq('id', appId)
                    .then(() => {});

                // Inject Credit SDK and open the app in a blob URL
                const appCode = injectCreditSDK(app.code, appId);
                const blob = new Blob([appCode], { type: 'text/html' });
                const blobUrl = URL.createObjectURL(blob);

                closeAppsPanel();

                // On mobile, go fullscreen; on desktop, open in mobile view like other apps
                if (window.innerWidth < 768) {
                    closeAppsView();
                    previewApp(null, blobUrl, app.name);
                } else {
                    openMobileAppView(null, blobUrl, app.name);
                }

            } catch (error) {
                console.error('Error launching community app:', error);
                alert('Failed to launch app');
            }
        }

        // Current previewing app key
        let currentPreviewApp = null;

        // Current detail page app key
        let currentDetailAppKey = null;
        let currentDetailCommunityApp = null;

        // Pending app launch info (for modal)
        let pendingAppLaunch = { key: null, url: null, name: null };

        function openAppDetail(appKey, skipPushState) {
            const app = SUITE_APPS[appKey];
            if (!app) {
                // Try community app by slug
                openCommunityAppDetail(appKey, skipPushState);
                return;
            }

            currentDetailCommunityApp = null;

            currentDetailAppKey = appKey;

            // Exit builder mode
            exitBuilderMode();

            // Hide all other views
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const connectionsView = document.getElementById('connectionsView');
            const detailView = document.getElementById('appDetailView');

            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (connectionsView) connectionsView.classList.remove('active');
            if (appsView) appsView.classList.remove('active');
            hideArticle();

            // Populate detail view
            const iconEl = document.getElementById('appDetailIcon');
            const nameEl = document.getElementById('appDetailName');
            const categoryEl = document.getElementById('appDetailCategory');
            const descEl = document.getElementById('appDetailDescription');
            const addBtn = document.getElementById('appDetailAddBtn');
            const screenshotsContainer = document.getElementById('appDetailScreenshots');
            const screenshotsSection = document.getElementById('appDetailScreenshotsSection');
            const infoGrid = document.getElementById('appDetailInfoGrid');

            if (app.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else {
                iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            }

            nameEl.textContent = app.name;
            const category = APP_CATEGORY_MAP[appKey] || 'lifestyle';
            categoryEl.textContent = category;
            descEl.textContent = app.description;

            // Populate screenshot previews
            const screens = app.screens || [app.url];
            screenshotsContainer.innerHTML = '';
            if (!app.isExtension && !app.url.startsWith('http')) {
                screens.forEach(screenUrl => {
                    const frame = document.createElement('div');
                    frame.className = 'app-detail-phone-frame';
                    const iframe = document.createElement('iframe');
                    iframe.className = 'app-detail-phone-iframe';
                    iframe.src = screenUrl;
                    iframe.loading = 'lazy';
                    iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
                    frame.appendChild(iframe);
                    screenshotsContainer.appendChild(frame);
                });
                screenshotsSection.style.display = '';
            } else {
                screenshotsSection.style.display = 'none';
            }

            // Populate info grid
            const categoryLabel = (APP_CATEGORY_MAP[appKey] || 'lifestyle').replace(/^\w/, c => c.toUpperCase());
            infoGrid.innerHTML = `
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Category</div>
                    <div class="app-detail-info-value">${categoryLabel}</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Platform</div>
                    <div class="app-detail-info-value">${app.isExtension ? 'Chrome Extension' : 'Web'}</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Developer</div>
                    <div class="app-detail-info-value">SUITE</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Price</div>
                    <div class="app-detail-info-value">Free</div>
                </div>
            `;

            // Update add button state
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            if (savedApps.includes(appKey)) {
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');
            } else {
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Add to Profile`;
                addBtn.classList.remove('added');
            }

            // Show detail view
            if (detailView) detailView.classList.add('active');

            // Push URL
            if (!skipPushState) {
                history.pushState({ view: 'appDetail', appKey: appKey }, '', '/apps/' + appKey);
            }

            closeMobileSidebar();
        }

        async function openCommunityAppDetail(slug, skipPushState) {
            // Find community app by slug in cache, or fetch from DB
            let op = communityAppsCache.find(o => o.slug === slug);

            if (!op && supabaseClient) {
                try {
                    const { data, error } = await supabaseClient
                        .from('suite_operators')
                        .select('*')
                        .eq('slug', slug)
                        .single();
                    if (!error && data) op = data;
                } catch (e) {
                    console.error('Error fetching community app by slug:', e);
                }
            }

            if (!op) {
                // Not found  fall back to apps grid
                openAppsPanel(skipPushState);
                return;
            }

            currentDetailAppKey = slug;
            currentDetailCommunityApp = { slug: op.slug, user_app_id: op.user_app_id };

            // Exit builder mode
            exitBuilderMode();

            // Hide all other views
            const welcomeState = document.getElementById('welcomeState');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');
            const connectionsView = document.getElementById('connectionsView');
            const detailView = document.getElementById('appDetailView');

            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');
            if (learnView) learnView.classList.remove('active');
            if (connectionsView) connectionsView.classList.remove('active');
            if (appsView) appsView.classList.remove('active');
            hideArticle();

            // Populate detail view
            const iconEl = document.getElementById('appDetailIcon');
            const nameEl = document.getElementById('appDetailName');
            const categoryEl = document.getElementById('appDetailCategory');
            const descEl = document.getElementById('appDetailDescription');
            const addBtn = document.getElementById('appDetailAddBtn');
            const screenshotsSection = document.getElementById('appDetailScreenshotsSection');
            const infoGrid = document.getElementById('appDetailInfoGrid');

            const iconBg = op.icon_bg || 'linear-gradient(135deg, #22c55e, #10b981)';
            iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="40" height="40"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>';
            iconEl.style.background = iconBg;

            nameEl.textContent = op.name;
            categoryEl.textContent = 'Community';
            descEl.textContent = op.description || 'Community app';

            // No screenshots for community apps (blob URLs)
            if (screenshotsSection) screenshotsSection.style.display = 'none';

            // Info grid
            infoGrid.innerHTML = `
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Category</div>
                    <div class="app-detail-info-value">Community</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Platform</div>
                    <div class="app-detail-info-value">Web</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Developer</div>
                    <div class="app-detail-info-value">${op.name}</div>
                </div>
                <div class="app-detail-info-item">
                    <div class="app-detail-info-label">Price</div>
                    <div class="app-detail-info-value">Free</div>
                </div>
            `;

            // Update add button state
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            if (savedApps.includes(slug)) {
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');
            } else {
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Add to Profile`;
                addBtn.classList.remove('added');
            }

            // Show detail view
            if (detailView) detailView.classList.add('active');

            // Push URL
            if (!skipPushState) {
                history.pushState({ view: 'appDetail', appKey: slug }, '', '/apps/' + slug);
            }

            closeMobileSidebar();
        }

        function closeAppDetail() {
            const detailView = document.getElementById('appDetailView');
            if (detailView) {
                // Clear iframe sources to stop background loading
                detailView.querySelectorAll('.app-detail-phone-iframe').forEach(iframe => {
                    iframe.src = 'about:blank';
                });
                detailView.classList.remove('active');
            }
            currentDetailAppKey = null;
            currentDetailCommunityApp = null;
            openAppsPanel();
        }

        function openAppFromDetail() {
            if (!currentDetailAppKey) return;

            // Check if it's a community app
            if (currentDetailCommunityApp) {
                launchCommunityApp(currentDetailCommunityApp.user_app_id);
                return;
            }

            const app = SUITE_APPS[currentDetailAppKey];
            if (!app) return;

            // Extensions open in new tab
            if (app.isExtension) {
                window.open(app.url, '_blank');
                return;
            }

            if (window.innerWidth < 768) {
                // Mobile: fullscreen iframe
                history.pushState({ view: 'appFullscreen', appKey: currentDetailAppKey }, '', '/apps/' + currentDetailAppKey + '/fullscreen');
                previewApp(currentDetailAppKey, app.url, app.name);
            } else {
                // Desktop: mobile view popup
                history.pushState({ view: 'appOpen', appKey: currentDetailAppKey }, '', '/apps/' + currentDetailAppKey + '/open');
                openMobileAppView(currentDetailAppKey, app.url, app.name);
            }
        }

        function addAppToProfileFromDetail() {
            if (!currentDetailAppKey) return;

            const addBtn = document.getElementById('appDetailAddBtn');
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const appName = SUITE_APPS[currentDetailAppKey]?.name
                || (currentDetailCommunityApp && communityAppsCache.find(o => o.slug === currentDetailCommunityApp.slug)?.name)
                || 'App';

            if (savedApps.includes(currentDetailAppKey)) {
                // Remove
                const idx = savedApps.indexOf(currentDetailAppKey);
                savedApps.splice(idx, 1);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Add to Profile`;
                addBtn.classList.remove('added');
                showToast(`${appName} removed from your profile`);
            } else {
                // Add
                savedApps.push(currentDetailAppKey);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                addBtn.innerHTML = `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');
                showToast(`${appName} added to your profile!`);
            }

            // Live-update sidebar and Your Apps list
            renderSidebarApps();
            renderDashboardApps();
        }

        function launchApp(appKey, url, name) {
            const app = SUITE_APPS[appKey];

            // Check if this is an extension
            if (app && app.isExtension) {
                // Open the extension folder/download page
                window.open(url, '_blank');
                return;
            }

            // All other apps go to detail page
            openAppDetail(appKey);
        }

        function showAppLaunchModal(appKey, url, name) {
            const app = SUITE_APPS[appKey];
            const overlay = document.getElementById('appLaunchModalOverlay');
            const iconEl = document.getElementById('appLaunchModalIcon');
            const nameEl = document.getElementById('appLaunchModalName');

            if (!overlay) return;

            // Store pending launch info
            pendingAppLaunch = { key: appKey, url, name };

            // Set app info
            nameEl.textContent = name || app?.name || 'App';

            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else if (app?.icon) {
                iconEl.innerHTML = app.icon;
                iconEl.style.background = app.iconBg || 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            } else {
                iconEl.innerHTML = '';
                iconEl.style.background = 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            }

            overlay.classList.add('active');
        }

        function closeAppLaunchModal() {
            const overlay = document.getElementById('appLaunchModalOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        function launchAppFullscreen() {
            closeAppLaunchModal();
            previewApp(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        function launchAppMobile() {
            closeAppLaunchModal();
            openMobileAppView(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        function openMobileAppView(appKey, url, name) {
            const app = SUITE_APPS[appKey];
            const container = document.getElementById('mobileAppContainer');
            const frame = document.getElementById('mobileAppFrame');
            const iconEl = document.getElementById('mobileAppIcon');
            const titleEl = document.getElementById('mobileAppTitle');

            if (!container || !frame) return;

            currentPreviewApp = appKey;
            pendingAppLaunch = { key: appKey, url, name };

            // Set app info
            titleEl.textContent = name || app?.name || 'App';

            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else if (app?.icon) {
                iconEl.innerHTML = app.icon;
                iconEl.style.background = app.iconBg || 'linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))';
            } else {
                iconEl.innerHTML = '';
                iconEl.style.background = 'var(--bg-card)';
            }

            // Center the container initially
            container.style.top = '50%';
            container.style.left = '50%';
            container.style.transform = 'translate(-50%, -50%)';

            // Load the app
            frame.src = url;
            container.classList.add('active');

            // Initialize dragging
            initMobileAppDrag();

            // Update sidebar active state
            updateSidebarActiveApp(appKey);
        }

        // Update sidebar to show which app is active
        function updateSidebarActiveApp(activeAppKey) {
            document.querySelectorAll('.sidebar-app-tab').forEach(tab => {
                const tabAppKey = tab.getAttribute('data-app-key');
                if (tabAppKey === activeAppKey) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        function closeMobileApp() {
            const container = document.getElementById('mobileAppContainer');
            const frame = document.getElementById('mobileAppFrame');
            const returningToApp = currentPreviewApp;

            if (container) {
                container.classList.remove('active');
                // Reset position for next open
                container.style.transform = 'translate(-50%, -50%)';
            }
            if (frame) frame.src = '';
            currentPreviewApp = null;

            // Clear sidebar active state
            updateSidebarActiveApp(null);

            // Navigate back to detail page if we came from one
            if (returningToApp && SUITE_APPS[returningToApp]) {
                openAppDetail(returningToApp);
            }
        }

        // Minimize app to sidebar (save + close)
        function minimizeToSidebar() {
            if (!currentPreviewApp) {
                closeMobileApp();
                return;
            }

            const appKey = currentPreviewApp;
            const app = SUITE_APPS[appKey];
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            // Add to saved apps if not already there
            if (!savedApps.includes(appKey)) {
                savedApps.push(appKey);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                showToast(`${app?.name || 'App'} saved to your apps`);
            } else {
                showToast(`${app?.name || 'App'} minimized`);
            }

            // Close the mobile view
            closeMobileApp();

            // Update sidebar
            renderSidebarApps();
            renderYourApps(); // Also update dashboard if open
        }

        // Toggle Your Apps section expand/collapse
        function toggleYourApps() {
            const header = document.querySelector('.sidebar-your-apps .sidebar-expandable');
            const list = document.getElementById('sidebarAppsList');

            if (header && list) {
                header.classList.toggle('collapsed');
                list.classList.toggle('collapsed');
            }
        }

        // Render saved apps in sidebar
        async function renderSidebarApps() {
            const list = document.getElementById('sidebarAppsList');
            const countEl = document.getElementById('yourAppsCount');
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            if (!list) return;

            // Clear list
            list.innerHTML = '';

            // Render saved SUITE apps
            savedApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const tab = document.createElement('div');
                tab.className = 'sidebar-app-tab';
                tab.setAttribute('data-app-key', appKey);

                if (currentPreviewApp === appKey) {
                    tab.classList.add('active');
                }

                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}">`
                    : (app.icon || '');

                tab.innerHTML = `
                    <div class="sidebar-app-tab-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                        ${iconHtml}
                    </div>
                    <span class="sidebar-app-tab-name">${app.name}</span>
                    <button class="sidebar-app-tab-remove" onclick="event.stopPropagation(); removeSidebarApp('${appKey}')" title="Remove">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                `;

                tab.onclick = () => {
                    launchApp(appKey, app.url, app.name);
                };

                list.appendChild(tab);
            });

            // Fetch user-created apps from Supabase
            let userCreatedApps = [];
            const sidebarUser = getFactoryCurrentUser();
            if (supabaseClient && sidebarUser) {
                try {
                    const { data, error } = await supabaseClient
                        .from('user_apps')
                        .select('id, name, icon_bg, code')
                        .eq('user_id', sidebarUser.id)
                        .order('created_at', { ascending: false })
                        .limit(20);
                    if (!error && data) userCreatedApps = data;
                } catch (e) {
                    console.error('Failed to load user apps for sidebar:', e);
                }
            }

            // Render user-created apps
            userCreatedApps.forEach(uApp => {
                const tab = document.createElement('div');
                tab.className = 'sidebar-app-tab';
                tab.setAttribute('data-user-app-id', uApp.id);

                tab.innerHTML = `
                    <div class="sidebar-app-tab-icon" style="background: ${uApp.icon_bg || 'linear-gradient(135deg, #22c55e, #10b981)'}">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                    </div>
                    <span class="sidebar-app-tab-name">${uApp.name}</span>
                    <button class="sidebar-app-tab-remove" onclick="event.stopPropagation(); removeUserApp('${uApp.id}')" title="Remove">
                        <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 6L6 18M6 6l12 12"/>
                        </svg>
                    </button>
                `;

                tab.onclick = () => {
                    launchCommunityApp(uApp.id);
                };

                list.appendChild(tab);
            });

            // Update count
            const totalCount = savedApps.length + userCreatedApps.length;
            if (countEl) {
                countEl.textContent = `(${totalCount})`;
            }

            // Show empty state if no apps at all
            if (totalCount === 0) {
                list.innerHTML = `
                    <div class="sidebar-apps-empty">
                        <button class="sidebar-apps-empty-btn" onclick="openAppsPanel()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Add
                        </button>
                        <button class="sidebar-apps-empty-btn" onclick="openBuilderMode()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 5v14M5 12h14" stroke-linecap="round"/>
                            </svg>
                            Create
                        </button>
                    </div>
                `;
            }
        }

        async function removeUserApp(appId) {
            if (!supabaseClient) return;
            try {
                await supabaseClient.from('user_apps').delete().eq('id', appId);
                renderSidebarApps();
                renderDashboardApps();
            } catch (e) {
                console.error('Failed to remove user app:', e);
            }
        }

        // Remove app from sidebar
        function removeSidebarApp(appKey) {
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            const index = savedApps.indexOf(appKey);

            if (index > -1) {
                savedApps.splice(index, 1);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));
                renderSidebarApps();
                renderYourApps(); // Also update dashboard if open
                showToast(`${SUITE_APPS[appKey]?.name || 'App'} removed from your apps`);
            }
        }

        function switchToFullscreen() {
            closeMobileApp();
            previewApp(pendingAppLaunch.key, pendingAppLaunch.url, pendingAppLaunch.name);
        }

        // Dragging functionality for mobile app container
        function initMobileAppDrag() {
            const container = document.getElementById('mobileAppContainer');
            const header = document.getElementById('mobileAppHeader');
            const notch = container?.querySelector('.mobile-app-notch');

            if (!container || !header) return;

            let isDragging = false;
            let startX, startY, startLeft, startTop;
            let hasMoved = false;

            const onMouseDown = (e) => {
                if (e.target.closest('.mobile-app-btn')) return; // Don't drag when clicking buttons

                isDragging = true;
                hasMoved = false;

                // Get current position
                const rect = container.getBoundingClientRect();
                startLeft = rect.left;
                startTop = rect.top;
                startX = e.clientX || e.touches?.[0]?.clientX;
                startY = e.clientY || e.touches?.[0]?.clientY;

                // Remove centering transform once we start dragging
                container.style.transform = 'none';
                container.style.left = startLeft + 'px';
                container.style.top = startTop + 'px';

                header.style.cursor = 'grabbing';
                if (notch) notch.style.cursor = 'grabbing';
                e.preventDefault();
            };

            const onMouseMove = (e) => {
                if (!isDragging) return;

                const clientX = e.clientX || e.touches?.[0]?.clientX;
                const clientY = e.clientY || e.touches?.[0]?.clientY;

                const deltaX = clientX - startX;
                const deltaY = clientY - startY;

                if (Math.abs(deltaX) > 5 || Math.abs(deltaY) > 5) {
                    hasMoved = true;
                }

                let newLeft = startLeft + deltaX;
                let newTop = startTop + deltaY;

                // Keep within viewport
                const rect = container.getBoundingClientRect();
                const maxLeft = window.innerWidth - rect.width;
                const maxTop = window.innerHeight - rect.height;

                newLeft = Math.max(0, Math.min(newLeft, maxLeft));
                newTop = Math.max(0, Math.min(newTop, maxTop));

                container.style.left = newLeft + 'px';
                container.style.top = newTop + 'px';
            };

            const onMouseUp = () => {
                isDragging = false;
                header.style.cursor = 'grab';
                if (notch) notch.style.cursor = 'grab';
            };

            // Remove old listeners if any
            header.onmousedown = null;
            document.onmousemove = null;
            document.onmouseup = null;

            // Add listeners to header
            header.addEventListener('mousedown', onMouseDown);
            header.addEventListener('touchstart', onMouseDown, { passive: false });

            // Also add listeners to notch for dragging
            if (notch) {
                notch.addEventListener('mousedown', onMouseDown);
                notch.addEventListener('touchstart', onMouseDown, { passive: false });
                notch.style.cursor = 'grab';
            }

            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('touchmove', onMouseMove, { passive: false });
            document.addEventListener('mouseup', onMouseUp);
            document.addEventListener('touchend', onMouseUp);
        }

        async function previewApp(appKey, appUrl, appName) {
            const overlay = document.getElementById('appPreviewOverlay');
            const frame = document.getElementById('appPreviewFrame');
            const nameEl = document.getElementById('appPreviewName');
            const iconEl = document.getElementById('appPreviewIcon');
            const addBtn = document.getElementById('appPreviewAddBtn');

            if (!overlay || !frame) return;

            currentPreviewApp = appKey;

            // Get app info
            const app = appKey ? SUITE_APPS[appKey] : null;

            // Set app name
            nameEl.textContent = appName || app?.name || 'App';

            // Set app icon
            if (app?.iconUrl) {
                iconEl.innerHTML = `<img src="${app.iconUrl}" alt="${app.name}">`;
                iconEl.style.background = app.iconBg || 'var(--bg-card)';
            } else {
                iconEl.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>`;
                iconEl.style.background = 'var(--bg-card)';
            }

            // Reset add button state
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');
            if (appKey && savedApps.includes(appKey)) {
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');
            } else {
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 5v14M5 12h14"/></svg> Add to Profile`;
                addBtn.classList.remove('added');
            }

            // Build URL with auth token for cross-domain apps
            let finalUrl = appUrl;
            if (appUrl.startsWith('http') && supabaseClient) {
                try {
                    const { data: { session } } = await supabaseClient.auth.getSession();
                    if (session?.access_token) {
                        const url = new URL(appUrl);
                        url.searchParams.set('suite_token', session.access_token);
                        url.searchParams.set('suite_refresh', session.refresh_token);
                        finalUrl = url.toString();
                    }
                } catch (e) {
                    console.log('Could not get session for app:', e);
                }
            }

            // Load the app in iframe
            frame.src = finalUrl;

            // Show overlay
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeAppPreview() {
            const overlay = document.getElementById('appPreviewOverlay');
            const frame = document.getElementById('appPreviewFrame');
            const returningToApp = currentPreviewApp;

            if (overlay) {
                overlay.classList.remove('active');
            }

            // Clear iframe after animation
            setTimeout(() => {
                if (frame) frame.src = '';
            }, 300);

            document.body.style.overflow = '';
            currentPreviewApp = null;

            // Navigate back to detail page if we came from one
            if (returningToApp && SUITE_APPS[returningToApp]) {
                openAppDetail(returningToApp);
            }
        }

        function addAppToProfile() {
            if (!currentPreviewApp) return;

            const addBtn = document.getElementById('appPreviewAddBtn');
            const savedApps = JSON.parse(localStorage.getItem('savedApps') || '[]');

            if (!savedApps.includes(currentPreviewApp)) {
                savedApps.push(currentPreviewApp);
                localStorage.setItem('savedApps', JSON.stringify(savedApps));

                // Update button
                addBtn.innerHTML = `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"/></svg> Added!`;
                addBtn.classList.add('added');

                // Show toast
                showToast(`${SUITE_APPS[currentPreviewApp]?.name || 'App'} added to your profile!`);
            }
        }

        function showToast(message) {
            // Remove existing toast
            const existingToast = document.querySelector('.app-toast');
            if (existingToast) existingToast.remove();

            const toast = document.createElement('div');
            toast.className = 'app-toast';
            toast.innerHTML = `
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M20 6L9 17l-5-5"/>
                </svg>
                ${message}
            `;
            document.body.appendChild(toast);

            // Animate in
            setTimeout(() => toast.classList.add('visible'), 10);

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('visible');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Apps button click handler - open in-page apps panel
        document.addEventListener('DOMContentLoaded', () => {
            const appsBtn = document.getElementById('appsBtn');
            if (appsBtn) {
                appsBtn.addEventListener('click', openAppsPanel);
            }

            // Check if we should open Factory based on URL
            checkInitialRoute();

            // Initialize sidebar apps
            renderSidebarApps();

            // Check for Stripe payment success/cancel
            checkPaymentStatus();
        });

        // Close on Escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                // Close app preview first (highest priority)
                const appPreview = document.getElementById('appPreviewOverlay');
                if (appPreview && appPreview.classList.contains('active')) {
                    closeAppPreview();
                    return;
                }
                const overlay = document.getElementById('appsPanelOverlay');
                if (overlay && overlay.classList.contains('active')) {
                    closeAppsPanel();
                }
                const upgradeOverlay = document.getElementById('upgradeModalOverlay');
                if (upgradeOverlay && upgradeOverlay.classList.contains('active')) {
                    closeUpgradeModal();
                }
                closeProfileDropdown();
            }
        });

        // ========================
        // TOOLS & ATTACHMENTS
        // ========================
        function toggleToolsDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('toolsDropdown');
            dropdown.classList.toggle('active');
            // Close other dropdowns
            document.getElementById('attachDropdown')?.classList.remove('active');
            document.getElementById('mentionDropdown')?.classList.remove('active');
        }

        function closeToolsDropdown() {
            const dropdown = document.getElementById('toolsDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        function selectTool(tool) {
            closeToolsDropdown();
            const toolNames = {
                'deep-research': 'Deep Research',
                'create-video': 'Create Videos',
                'create-image': 'Create Images',
                'web-search': 'Web Search',
                'code': 'Code Interpreter',
                'voice': 'Voice Mode'
            };
            // TODO: Enable the selected tool for the next message
            console.log('Selected tool:', tool);

            // Pro features that require upgrade
            const proFeatures = ['create-video', 'create-image', 'voice'];
            if (proFeatures.includes(tool)) {
                const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));
                if (isLoggedIn) {
                    openUpgradeModal();
                } else {
                    openConnectModal();
                }
                return;
            }

            // Add tool indicator to chat input
            const chatInput = document.getElementById('chatInput');
            chatInput.placeholder = `Using ${toolNames[tool]}... Type your message`;
            chatInput.focus();
        }

        // Attach dropdown functions
        function toggleAttachDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('attachDropdown');
            dropdown.classList.toggle('active');
            // Close other dropdowns
            document.getElementById('toolsDropdown')?.classList.remove('active');
            document.getElementById('mentionDropdown')?.classList.remove('active');
        }

        function closeAttachDropdown() {
            const dropdown = document.getElementById('attachDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        // Attach button
        document.addEventListener('DOMContentLoaded', () => {
            const attachBtn = document.getElementById('attachBtn');
            const fileInput = document.getElementById('fileInput');
            const toolsBtn = document.getElementById('toolsBtn');

            if (attachBtn) {
                attachBtn.addEventListener('click', toggleAttachDropdown);
            }

            // Handle file input change
            if (fileInput) {
                fileInput.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length > 0) {
                        // TODO: Handle file upload
                        console.log('Files selected:', files);
                        alert(`Selected ${files.length} file(s). File upload coming soon!`);
                        fileInput.value = ''; // Reset
                    }
                });
            }

            // Add click handlers to attach dropdown items
            const attachDropdown = document.getElementById('attachDropdown');
            if (attachDropdown) {
                attachDropdown.querySelectorAll('.action-dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        closeAttachDropdown();
                        if (item.dataset.attach === 'files') {
                            fileInput?.click();
                        }
                    });
                });
            }

            if (toolsBtn) {
                toolsBtn.addEventListener('click', toggleToolsDropdown);
            }

            // Add click handlers to tools dropdown items
            const toolsDropdown = document.getElementById('toolsDropdown');
            if (toolsDropdown) {
                toolsDropdown.querySelectorAll('.action-dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const tool = item.dataset.tool;
                        if (tool) selectTool(tool);
                    });
                });
            }
        });

        // Close tools dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const toolsBtn = document.getElementById('toolsBtn');
            const toolsDropdown = document.getElementById('toolsDropdown');
            if (toolsBtn && toolsDropdown && !toolsBtn.contains(e.target)) {
                closeToolsDropdown();
            }
        });

        // Close attach dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const attachBtn = document.getElementById('attachBtn');
            const attachDropdown = document.getElementById('attachDropdown');
            if (attachBtn && attachDropdown && !attachBtn.contains(e.target) && !attachDropdown.contains(e.target)) {
                closeAttachDropdown();
            }
        });

        // ========================
        // MENTION (@) DROPDOWN
        // ========================
        function toggleMentionDropdown(e) {
            e.stopPropagation();
            const dropdown = document.getElementById('mentionDropdown');
            dropdown.classList.toggle('active');
            // Close other dropdowns
            document.getElementById('attachDropdown')?.classList.remove('active');
            document.getElementById('toolsDropdown')?.classList.remove('active');

            // Populate apps on first open
            if (dropdown.classList.contains('active')) {
                populateMentionDropdown();
            }
        }

        function closeMentionDropdown() {
            const dropdown = document.getElementById('mentionDropdown');
            if (dropdown) dropdown.classList.remove('active');
        }

        function populateMentionDropdown() {
            const appsList = document.getElementById('mentionAppsList');
            if (!appsList || appsList.children.length > 0) return; // Already populated

            // Get top apps from SUITE_APPS
            const topApps = ['trueform', 'hydrotrack', 'foodvitals', 'sleepwell', 'quickbudget', 'focusflow', 'mealprep', 'moodlog'];

            topApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const btn = document.createElement('button');
                btn.className = 'mention-dropdown-item';
                btn.onclick = () => selectMention(appKey, app.name, 'app');

                btn.innerHTML = `
                    <span class="mention-item-icon">
                        <img src="${app.iconUrl}" alt="${app.name}" onerror="this.parentElement.textContent='${app.name.charAt(0)}'">
                    </span>
                    <span>${app.name}</span>
                `;

                appsList.appendChild(btn);
            });
        }

        function selectMention(id, name, type) {
            closeMentionDropdown();

            const chatInput = document.getElementById('chatInput');
            const currentValue = chatInput.value;
            const mentionText = type === 'app' ? `@${name} ` : `@${name} `;

            // Insert mention at cursor or append
            chatInput.value = currentValue + mentionText;
            chatInput.focus();

            // Enable send button if there's content
            const sendBtn = document.getElementById('sendBtn');
            if (sendBtn && chatInput.value.trim()) {
                sendBtn.disabled = false;
            }

            console.log('Selected mention:', type, id, name);
        }

        // Initialize mention button
        document.addEventListener('DOMContentLoaded', () => {
            const mentionBtn = document.getElementById('mentionBtn');
            if (mentionBtn) {
                mentionBtn.addEventListener('click', toggleMentionDropdown);
            }

            // Add click handlers to mention dropdown items
            const mentionDropdown = document.getElementById('mentionDropdown');
            if (mentionDropdown) {
                mentionDropdown.querySelectorAll('.action-dropdown-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const mention = item.dataset.mention;
                        if (mention) {
                            closeMentionDropdown();
                            const chatInput = document.getElementById('chatInput');
                            chatInput.value = chatInput.value + `@${mention} `;
                            chatInput.focus();
                        }
                    });
                });
            }
        });

        // Close mention dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const mentionBtn = document.getElementById('mentionBtn');
            const mentionDropdown = document.getElementById('mentionDropdown');
            if (mentionBtn && mentionDropdown && !mentionBtn.contains(e.target)) {
                closeMentionDropdown();
            }
        });

        // ========================
        // MODEL SELECTOR
        // ========================
        let currentModel = 'flash'; // Default to Auto (uses Flash under the hood)

        function toggleModelDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('modelDropdown');
            const selector = document.getElementById('modelSelector');
            dropdown.classList.toggle('active');
            selector.classList.toggle('active');

            // Show the correct tab based on current model
            if (dropdown.classList.contains('active')) {
                const isPaidModel = ['pro', 'sonnet', 'opus'].includes(currentModel);
                const tabToShow = isPaidModel ? 'paid' : 'free';

                dropdown.querySelectorAll('.model-dropdown-tab').forEach(t => t.classList.remove('active'));
                dropdown.querySelectorAll('.model-dropdown-panel').forEach(p => p.classList.remove('active'));

                const activeTab = dropdown.querySelector(`.model-dropdown-tab[data-tab="${tabToShow}"]`);
                const activePanel = dropdown.querySelector(`[data-panel="${tabToShow}"]`);
                if (activeTab) activeTab.classList.add('active');
                if (activePanel) activePanel.classList.add('active');
            }
        }

        function closeModelDropdown() {
            const dropdown = document.getElementById('modelDropdown');
            const selector = document.getElementById('modelSelector');
            if (dropdown) dropdown.classList.remove('active');
            if (selector) selector.classList.remove('active');
        }

        function selectMode(mode, modeName) {
            // Auto mode uses flash under the hood
            currentModel = (mode === 'auto') ? 'flash' : mode;

            // Update the selector display
            const nameEl = document.getElementById('modelName');
            if (nameEl) nameEl.textContent = modeName;

            // Update active state in dropdown
            const items = document.querySelectorAll('.model-dropdown-item');
            items.forEach(item => item.classList.remove('active'));

            // Mark the selected item as active
            const selectedItem = document.querySelector(`.model-dropdown-item[data-mode="${mode}"]`);
            if (selectedItem) selectedItem.classList.add('active');

            closeModelDropdown();

            // Check if Pro mode requires upgrade
            if (mode === 'opus') {
                const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));
                if (!isLoggedIn) {
                    openConnectModal();
                    return;
                }
            }

            console.log('Selected mode:', mode);
        }

        // =========================================
        // SUITEGPT BUILDER MODE
        // =========================================

        let builderState = {
            messages: [],
            spec: {
                name: 'Your App',
                description: '',
                features: [],
                cost: 50
            },
            isLoading: false
        };

        function openBuilderMode(skipPushState = false) {
            const builderMode = document.getElementById('builderMode');
            if (builderMode) {
                builderMode.classList.add('active');
                document.body.style.overflow = 'hidden';

                // Show choice screen by default
                resetBuilderToChoiceScreen();

                // Update URL to / (Builder is the home page)
                if (!skipPushState) {
                    history.pushState({ view: 'builder' }, '', '/');
                }
            }
        }

        function exitBuilderMode() {
            const builderMode = document.getElementById('builderMode');
            if (builderMode) {
                builderMode.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function closeBuilderMode() {
            // Exit builder mode and return to main chat
            exitBuilderMode();
            // Reset to choice screen for next time
            resetBuilderToChoiceScreen();
            // Update URL to /chat
            history.pushState({ view: 'chat' }, '', '/chat');
            // Focus the main chat input
            const chatInput = document.getElementById('chatInput');
            if (chatInput) chatInput.focus();
        }

        function resetBuilderToChoiceScreen() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const createAppChoiceScreen = document.getElementById('createAppChoiceScreen');
            const builderContent = document.getElementById('builderContent');
            const builderInputArea = document.querySelector('.builder-input-area');
            const quickAppScreen = document.getElementById('quickAppScreen');
            const quickAppPreview = document.getElementById('quickAppPreviewView');
            const ideaScreen = document.getElementById('ideaScreen');
            const importScreen = document.getElementById('importAppScreen');

            if (choiceScreen) choiceScreen.style.display = 'flex';
            if (createAppChoiceScreen) createAppChoiceScreen.style.display = 'none';
            if (builderContent) builderContent.style.display = 'none';
            if (builderInputArea) builderInputArea.style.display = 'none';
            if (quickAppScreen) quickAppScreen.classList.remove('active');
            if (quickAppPreview) quickAppPreview.style.display = 'none';
            if (ideaScreen) ideaScreen.classList.remove('active');
            if (importScreen) importScreen.classList.remove('active');
        }

        function goBackToBuilderChoice() {
            // Hide proposal split view if visible
            const splitView = document.getElementById('proposalSplitView');
            if (splitView) splitView.style.display = 'none';

            // Hide quick app screen if visible
            const quickAppScreen = document.getElementById('quickAppScreen');
            if (quickAppScreen) quickAppScreen.classList.remove('active');

            // Hide create app choice screen if visible
            const createAppChoiceScreen = document.getElementById('createAppChoiceScreen');
            if (createAppChoiceScreen) createAppChoiceScreen.style.display = 'none';

            // Hide idea/import screens
            const ideaScreen = document.getElementById('ideaScreen');
            if (ideaScreen) ideaScreen.classList.remove('active');
            const importScreen = document.getElementById('importAppScreen');
            if (importScreen) importScreen.classList.remove('active');

            // Reset to choice screen
            resetBuilderToChoiceScreen();

            // Update URL to builder home
            history.pushState({ view: 'suitegptbuilder' }, '', '/suitegptbuilder');
        }

        // ===== IDEA MODE =====
        function enterIdeaMode() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const ideaScreen = document.getElementById('ideaScreen');

            if (choiceScreen) choiceScreen.style.display = 'none';
            if (ideaScreen) ideaScreen.classList.add('active');

            // Clear fields
            const nameInput = document.getElementById('ideaName');
            const descInput = document.getElementById('ideaDescription');
            if (nameInput) nameInput.value = '';
            if (descInput) descInput.value = '';

            history.pushState({ view: 'suitegptbuilder', mode: 'idea' }, '', '/suitegptbuilder/idea');
        }

        async function submitIdea() {
            const name = document.getElementById('ideaName')?.value?.trim();
            const description = document.getElementById('ideaDescription')?.value?.trim();
            const currentUser = getFactoryCurrentUser();

            if (!name) {
                showToast('Please give your idea a name.');
                return;
            }
            if (!description || description.length < 10) {
                showToast('Please describe your idea in at least a sentence or two.');
                return;
            }

            if (!supabaseClient || !currentUser) {
                alert('Please sign in to submit an idea.');
                return;
            }

            const btn = document.getElementById('ideaSubmitBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Submitting...'; }

            try {
                const { error } = await supabaseClient
                    .from('factory_proposals')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        description: description,
                        status: 'idea',
                        type: 'new'
                    });

                if (error) throw error;

                showToast('Idea submitted! The community can now vote on it.');
                exitBuilderMode();
                renderDashboardApps();
            } catch (e) {
                console.error('Failed to submit idea:', e);
                showToast('Failed to submit idea. Please try again.');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Submit Idea'; }
            }
        }

        // ===== IMPORT MODE =====
        function enterImportMode() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const importScreen = document.getElementById('importAppScreen');

            if (choiceScreen) choiceScreen.style.display = 'none';
            if (importScreen) importScreen.classList.add('active');

            // Clear fields
            const nameInput = document.getElementById('importAppName');
            const descInput = document.getElementById('importAppDescription');
            const codeInput = document.getElementById('importAppCode');
            if (nameInput) nameInput.value = '';
            if (descInput) descInput.value = '';
            if (codeInput) codeInput.value = '';

            history.pushState({ view: 'suitegptbuilder', mode: 'import' }, '', '/suitegptbuilder/import');
        }

        async function importApp() {
            const name = document.getElementById('importAppName')?.value?.trim();
            const description = document.getElementById('importAppDescription')?.value?.trim();
            const code = document.getElementById('importAppCode')?.value?.trim();
            const currentUser = getFactoryCurrentUser();

            if (!name) {
                showToast('Please enter an app name.');
                return;
            }
            if (!code) {
                showToast('Please paste your HTML code.');
                return;
            }

            if (!supabaseClient || !currentUser) {
                alert('Please sign in to import an app.');
                return;
            }

            const btn = document.getElementById('importAppBtn');
            if (btn) { btn.disabled = true; btn.textContent = 'Importing...'; }

            try {
                const { data, error } = await supabaseClient
                    .from('user_apps')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        description: description || '',
                        code: code,
                        icon_bg: 'linear-gradient(135deg, #8b5cf6, #6366f1)',
                        is_public: true
                    })
                    .select()
                    .single();

                if (error) throw error;

                if (data) {
                    ensureOperatorEntry(data.id, name, description || '');
                    createAutoProposal(data.id, name, description || '');
                }

                showToast(`"${name}" imported to your projects!`);
                exitBuilderMode();
                renderDashboardApps();
                renderSidebarApps();
            } catch (e) {
                console.error('Failed to import app:', e);
                showToast('Failed to import. Please try again.');
            } finally {
                if (btn) { btn.disabled = false; btn.textContent = 'Import'; }
            }
        }

        // ===== CREATE APP MODE =====
        let promptBreakdownGenerated = false;
        let generatedPrompts = {
            features: '',
            design: '',
            interactions: ''
        };

        function enterCreateAppMode() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const createAppChoiceScreen = document.getElementById('createAppChoiceScreen');
            const quickAppScreen = document.getElementById('quickAppScreen');
            const builderContent = document.getElementById('builderContent');

            if (choiceScreen) choiceScreen.style.display = 'none';
            if (createAppChoiceScreen) createAppChoiceScreen.style.display = 'none';
            if (builderContent) builderContent.style.display = 'none';
            if (quickAppScreen) quickAppScreen.classList.add('active');

            // Update URL
            history.pushState({ view: 'suitegptbuilder', mode: 'create' }, '', '/suitegptbuilder/create');

            // Focus input
            setTimeout(() => {
                const input = document.getElementById('quickAppInput');
                if (input) input.focus();
            }, 100);

            // Reset prompt breakdown state
            resetPromptBreakdown();
            updateQuickAppBuildBtn();
        }

        // Alias for backward compatibility
        function enterQuickAppMode() {
            enterCreateAppMode();
        }

        function handleQuickAppKeydown(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                const input = document.getElementById('quickAppInput');
                if (input && input.value.trim()) {
                    buildQuickApp();
                }
            }
            // Update button state
            setTimeout(updateQuickAppBuildBtn, 0);
        }

        function updateQuickAppBuildBtn() {
            const input = document.getElementById('quickAppInput');
            const buildBtn = document.getElementById('quickAppBuildBtn');
            const hasContent = input && input.value.trim().length > 0;

            if (buildBtn) buildBtn.disabled = !hasContent;
        }

        function useQuickAppIdea(idea) {
            const input = document.getElementById('quickAppInput');
            if (input) {
                input.value = idea;
                input.focus();
                resetPromptBreakdown();
                checkAndGeneratePrompts();
                updateQuickAppBuildBtn();
            }
        }

        // ===== PROMPT BREAKDOWN FUNCTIONS =====
        const PROMPT_THRESHOLD = 100; // Characters needed to trigger prompt generation
        let isGeneratingPrompts = false;

        function resetPromptBreakdown() {
            promptBreakdownGenerated = false;
            generatedPrompts = { features: '', design: '', interactions: '' };
            const container = document.getElementById('promptBreakdownContainer');
            if (container) container.classList.remove('active');

            // Reset card states
            ['Features', 'Design', 'Interactions'].forEach(type => {
                const card = document.getElementById(`promptCard${type}`);
                if (card) card.classList.remove('expanded');
                const preview = document.getElementById(`promptPreview${type}`);
                if (preview) { preview.textContent = 'Generating'; preview.classList.add('loading'); }
                const textarea = document.getElementById(`promptText${type}`);
                if (textarea) {
                    textarea.value = '';
                    textarea.classList.add('loading');
                    textarea.style.height = 'auto';
                }
            });
        }

        function checkAndGeneratePrompts() {
            const input = document.getElementById('quickAppInput');
            if (!input) return;

            const text = input.value.trim();
            const container = document.getElementById('promptBreakdownContainer');

            // If text is too short, hide prompts
            if (text.length < PROMPT_THRESHOLD) {
                if (container) container.classList.remove('active');
                promptBreakdownGenerated = false;
                return;
            }

            // If we already generated prompts for similar content, don't regenerate
            if (promptBreakdownGenerated && generatedPrompts.features) {
                if (container) container.classList.add('active');
                return;
            }

            // Generate prompts
            generatePromptBreakdown(text);
        }

        async function generatePromptBreakdown(idea) {
            if (isGeneratingPrompts) return;
            isGeneratingPrompts = true;

            const container = document.getElementById('promptBreakdownContainer');
            if (container) container.classList.add('active');

            // Set loading state
            ['Features', 'Design', 'Interactions'].forEach(type => {
                const preview = document.getElementById(`promptPreview${type}`);
                if (preview) { preview.textContent = 'Generating'; preview.classList.add('loading'); }
                const textarea = document.getElementById(`promptText${type}`);
                if (textarea) {
                    textarea.value = '';
                    textarea.classList.add('loading');
                }
            });

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Analyze this app idea and break it down into 3 focused prompts for building it. Each prompt should be specific and detailed.

APP IDEA:
"${idea}"

Return a JSON object with exactly these 3 keys:
- "features": Detailed prompt describing the core features and functionality. Include specific features, data storage needs, and logic.
- "design": Detailed prompt describing the visual design. Include specific colors, layout, typography, spacing, animations, and visual effects.
- "interactions": Detailed prompt describing user interactions and behaviors. Include what happens on click, hover, scroll, input, etc.`,
                        model: 'gemini-3-flash-preview',
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2000,
                            responseMimeType: 'application/json'
                        }
                    })
                });

                if (!response.ok) throw new Error('API failed: ' + response.status);

                const data = await response.json();
                let jsonText = (data.text || '').trim();
                console.log('Prompt breakdown raw:', jsonText.substring(0, 200));

                // Parse JSON - try direct first, then fallback extractions
                let prompts;
                try {
                    prompts = JSON.parse(jsonText);
                } catch (e1) {
                    // Fallback: strip markdown code blocks
                    const codeBlock = jsonText.match(/```(?:json)?\s*([\s\S]*?)```/);
                    if (codeBlock) {
                        try { prompts = JSON.parse(codeBlock[1].trim()); } catch(e2) {}
                    }
                    if (!prompts) {
                        const braceMatch = jsonText.match(/\{[\s\S]*\}/);
                        if (braceMatch) {
                            try { prompts = JSON.parse(braceMatch[0]); } catch(e3) {}
                        }
                    }
                }

                if (prompts && (prompts.features || prompts.design || prompts.interactions)) {
                    generatedPrompts.features = prompts.features || '';
                    generatedPrompts.design = prompts.design || '';
                    generatedPrompts.interactions = prompts.interactions || '';

                    // Update the UI
                    updatePromptCard('features', generatedPrompts.features);
                    updatePromptCard('design', generatedPrompts.design);
                    updatePromptCard('interactions', generatedPrompts.interactions);

                    promptBreakdownGenerated = true;
                } else {
                    console.error('Could not parse prompts from:', jsonText);
                    throw new Error('Invalid JSON response');
                }
            } catch (error) {
                console.error('Failed to generate prompts:', error);
                ['Features', 'Design', 'Interactions'].forEach(type => {
                    const preview = document.getElementById(`promptPreview${type}`);
                    if (preview) { preview.textContent = 'Click to write your own prompt'; preview.classList.remove('loading'); }
                    const textarea = document.getElementById(`promptText${type}`);
                    if (textarea) {
                        textarea.value = '';
                        textarea.placeholder = 'Type your own prompt here...';
                        textarea.classList.remove('loading');
                    }
                });
            }

            isGeneratingPrompts = false;
        }

        function updatePromptCard(type, content) {
            const capitalType = type.charAt(0).toUpperCase() + type.slice(1);
            const textarea = document.getElementById(`promptText${capitalType}`);
            const preview = document.getElementById(`promptPreview${capitalType}`);

            if (textarea) {
                textarea.value = content;
                textarea.classList.remove('loading');
            }
            if (preview) {
                preview.textContent = content || 'Generating';
                preview.classList.remove('loading');
            }
        }

        function togglePromptCard(type, event) {
            // Don't toggle if clicking inside the textarea
            if (event && event.target.tagName === 'TEXTAREA') return;

            const card = document.getElementById(`promptCard${type}`);
            if (!card) return;

            const isExpanding = !card.classList.contains('expanded');
            card.classList.toggle('expanded');

            // Auto-resize textarea when expanding
            if (isExpanding) {
                const textarea = document.getElementById(`promptText${type}`);
                if (textarea) {
                    autoResizePromptCard(textarea);
                    textarea.focus();
                }
            }
        }

        function autoResizePromptCard(el) {
            el.style.height = 'auto';
            el.style.height = el.scrollHeight + 'px';
        }

        function onQuickAppInput() {
            const input = document.getElementById('quickAppInput');
            if (!input) return;

            // Auto-resize
            input.style.height = 'auto';
            input.style.height = Math.min(input.scrollHeight, 200) + 'px';

            // Check for prompt generation threshold
            checkAndGeneratePrompts();
            updateQuickAppBuildBtn();
        }

        async function generateNovelAppIdea() {
            const btn = document.getElementById('surpriseMeBtn');
            const input = document.getElementById('quickAppInput');
            if (!btn || !input) return;

            btn.classList.add('loading');
            btn.innerHTML = `
                <svg class="spinning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
                Thinking of something novel...
            `;

            try {
                // Get existing app names to avoid duplicates
                const existingApps = Object.values(SUITE_APPS).map(app => app.name.toLowerCase());
                const existingAppsList = existingApps.join(', ');

                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Generate ONE useful, practical app idea that solves a real problem people have. It should be something people would actually use regularly, not a gimmick or tech demo.

EXISTING APPS TO AVOID (don't suggest anything similar):
${existingAppsList}

The app will be a single-page HTML web app with access to AI text generation and localStorage for persistence.

Requirements for your idea:
- It must solve a REAL problem or fill a genuine need (productivity, learning, health, finance, creativity, communication, organization, etc.)
- It must be something people would bookmark and come back to daily or weekly
- Be specific about what the app does, the key screens/views, and the user workflow
- 3-5 sentences describing the idea
- DO NOT just mash together random APIs (voice + camera + AI + canvas). Focus on ONE core value proposition.
- DO NOT suggest AR, voice-to-anything, camera-based, or "point your phone at things" ideas
- Think about what apps are missing from people's lives, not what technology can do

BAD ideas (gimmicky tech demos, not useful):
- "Point your camera at objects and AI describes them"
- "Speak into your mic and AI turns it into art"
- "Shake your phone to generate random things"
- "AI art critic that roasts your drawings"

GOOD ideas (genuinely useful, people would actually use them):
- "A meal prep planner where you enter what's in your fridge, set dietary goals, and AI generates a week of recipes with a consolidated grocery list. Track what you've cooked, rate meals, and it learns your preferences over time."
- "A freelancer invoice and client tracker. Log projects, hours, and rates. Auto-generate professional invoices as PDFs. Dashboard shows unpaid invoices, monthly revenue trends, and client payment history."
- "A personal knowledge base where you paste articles, notes, and ideas. AI auto-tags and connects related entries. Search across everything with natural language like 'what did I save about marketing strategies?' and get summarized answers."
- "A debate prep tool where you enter a topic and AI generates the strongest arguments for both sides, with evidence and counterpoints. Practice responding to each argument and get scored on persuasiveness."

Now generate ONE practical, useful app idea that people would genuinely want to use. Output ONLY the idea description:`,
                        model: 'gemini-3-flash-preview',
                        generationConfig: { temperature: 1.2, maxOutputTokens: 4000 }
                    })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    console.error('Gemini API error:', response.status, errData);
                    throw new Error('API request failed: ' + (errData.error || response.status));
                }

                const data = await response.json();
                if (data.text) {
                    input.value = data.text.trim().replace(/^["']|["']$/g, '');
                    input.style.height = 'auto';
                    input.style.height = Math.min(input.scrollHeight, 200) + 'px';
                    resetPromptBreakdown();
                    checkAndGeneratePrompts();
                    updateQuickAppBuildBtn();
                } else {
                    throw new Error('No text in response');
                }
            } catch (error) {
                console.error('Failed to generate idea:', error);
                // Fallback to random creative ideas
                const fallbackIdeas = [
                    'A meal prep planner where you enter what\'s in your fridge, set dietary preferences and calorie goals, and AI generates a full week of recipes with a consolidated grocery list. Rate meals after cooking and it learns what you like. Tracks macros and shows nutrition trends over time.',
                    'A personal CRM for networking. After every meeting, coffee chat, or conference, quickly log who you met, what you talked about, and follow-up actions. AI suggests when to reconnect based on time elapsed. Search your contacts with natural language like "who did I meet at the fintech conference?"',
                    'A freelancer project tracker with built-in invoicing. Log clients, projects, hours, and rates. Auto-generate clean invoices. Dashboard shows unpaid invoices, monthly revenue, top clients by revenue, and projects at risk of scope creep based on hours logged vs estimated.',
                    'A personal knowledge base where you paste articles, bookmarks, notes, and random ideas. AI auto-tags everything and finds connections between entries. Search with natural language like "what did I save about productivity systems?" and get a summarized answer pulling from all your saved content.',
                    'A subscription tracker that shows you exactly where your money goes each month. Add all your subscriptions with renewal dates and costs. Get alerts before renewals, see total monthly/yearly spend, and AI analyzes which ones you\'re actually using vs wasting money on based on usage patterns you log.'
                ];
                input.value = fallbackIdeas[Math.floor(Math.random() * fallbackIdeas.length)];
                input.style.height = 'auto';
                input.style.height = Math.min(input.scrollHeight, 200) + 'px';
                resetPromptBreakdown();
                checkAndGeneratePrompts();
                updateQuickAppBuildBtn();
            }

            btn.classList.remove('loading');
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Surprise me with a novel idea
            `;
        }

        // ===== BUILD PROGRESS OVERLAY =====
        const BUILD_STEPS = [
            { label: 'Analyzing your idea', icon: 'search' },
            { label: 'Planning features & logic', icon: 'list' },
            { label: 'Designing the interface', icon: 'palette' },
            { label: 'Writing the code', icon: 'code' },
            { label: 'Polishing & testing', icon: 'sparkle' }
        ];

        function showBuildProgress() {
            // Remove existing overlay if any
            const existing = document.getElementById('buildProgressOverlay');
            if (existing) existing.remove();

            const stepIcons = {
                search: '<circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/>',
                list: '<line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/>',
                palette: '<circle cx="13.5" cy="6.5" r="2.5"/><circle cx="17.5" cy="10.5" r="2.5"/><circle cx="8.5" cy="7.5" r="2.5"/><circle cx="6.5" cy="12" r="2.5"/><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10c.93 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.04-.24-.3-.39-.65-.39-1.04 0-.83.67-1.5 1.5-1.5H16c3.31 0 6-2.69 6-6 0-5.17-4.49-9.42-10-9.92z"/>',
                code: '<polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/>',
                sparkle: '<path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>'
            };

            const spinnerSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>';
            const checkSvg = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>';

            const stepsHtml = BUILD_STEPS.map((step, i) => `
                <div class="build-step-item" id="buildStep${i}" data-icon='${stepIcons[step.icon]}'>
                    <div class="build-step-dot">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">${stepIcons[step.icon]}</svg>
                    </div>
                    <span>${step.label}</span>
                </div>
            `).join('');

            const overlay = document.createElement('div');
            overlay.id = 'buildProgressOverlay';
            overlay.className = 'build-progress-overlay';
            overlay.innerHTML = `
                <div class="build-progress-content">
                    <div class="build-progress-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="36" height="36">
                            <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                        </svg>
                    </div>
                    <div class="build-progress-title">Building your app</div>
                    <div class="build-progress-step" id="buildProgressStep">${BUILD_STEPS[0].label}...</div>
                    <div class="build-progress-bar-track">
                        <div class="build-progress-bar" id="buildProgressBar" style="width: 5%"></div>
                    </div>
                    <div class="build-progress-steps">
                        ${stepsHtml}
                    </div>
                </div>
            `;

            document.body.appendChild(overlay);

            // Start animating through steps
            animateBuildSteps();
        }

        let buildStepInterval = null;

        function animateBuildSteps() {
            let currentStep = 0;
            const bar = document.getElementById('buildProgressBar');
            const stepText = document.getElementById('buildProgressStep');

            // Activate first step
            const firstStep = document.getElementById('buildStep0');
            if (firstStep) firstStep.classList.add('active');
            if (bar) bar.style.width = '10%';

            buildStepInterval = setInterval(() => {
                // Mark current as done
                const cur = document.getElementById(`buildStep${currentStep}`);
                if (cur) {
                    cur.classList.remove('active');
                    cur.classList.add('done');
                    // Replace icon with checkmark
                    const dot = cur.querySelector('.build-step-dot');
                    if (dot) dot.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>';
                }

                currentStep++;
                if (currentStep >= BUILD_STEPS.length) {
                    clearInterval(buildStepInterval);
                    buildStepInterval = null;
                    if (bar) bar.style.width = '95%';
                    if (stepText) stepText.textContent = 'Almost there...';
                    return;
                }

                // Activate next
                const next = document.getElementById(`buildStep${currentStep}`);
                if (next) next.classList.add('active');

                // Update progress
                const pct = 10 + (currentStep / BUILD_STEPS.length) * 85;
                if (bar) bar.style.width = pct + '%';

                // Fade step text
                if (stepText) {
                    stepText.classList.add('fading');
                    setTimeout(() => {
                        stepText.textContent = BUILD_STEPS[currentStep].label + '...';
                        stepText.classList.remove('fading');
                    }, 300);
                }
            }, 3000);
        }

        function hideBuildProgress() {
            if (buildStepInterval) {
                clearInterval(buildStepInterval);
                buildStepInterval = null;
            }
            const overlay = document.getElementById('buildProgressOverlay');
            if (overlay) {
                overlay.style.opacity = '0';
                overlay.style.transition = 'opacity 0.3s ease';
                setTimeout(() => overlay.remove(), 300);
            }
        }

        const SUITE_API_REFERENCE = `
AVAILABLE APIs (use these in the generated code if the idea calls for AI features):

1. Gemini AI (text generation):
   fetch('/api/gemini', {
     method: 'POST',
     headers: {'Content-Type': 'application/json'},
     body: JSON.stringify({
       prompt: 'your prompt here',
       model: 'gemini-3-flash-preview',
       generationConfig: { temperature: 0.7, maxOutputTokens: 8192 }
     })
   }).then(r => r.json()).then(data => data.text)

2. Groq AI (fast chat - good for conversational features):
   fetch('/api/groq', {
     method: 'POST',
     headers: {'Content-Type': 'application/json'},
     body: JSON.stringify({
       messages: [{role: 'user', content: 'your message'}],
       model: 'llama-3.3-70b-versatile',
       temperature: 0.7,
       max_tokens: 2048
     })
   }).then(r => r.json()).then(data => data.text)

IMPORTANT - Credit Charging for AI Actions:
Before ANY AI API call (Gemini or Groq), you MUST charge credits using the SUITE SDK:
   window.SUITE.chargeCredits('ai_action', function(result) {
     if (result.success) {
       // proceed with the AI API call
     } else {
       // show error: result.error (e.g. "Insufficient credits")
     }
   });
This is required. Do NOT call AI APIs without charging credits first. The SUITE SDK is automatically available in all apps.

Use localStorage for data persistence. All browser APIs are available (Canvas, Audio, Speech, etc).`;

        async function buildQuickApp() {
            const input = document.getElementById('quickAppInput');
            const btn = document.getElementById('quickAppBuildBtn');
            if (!input || !input.value.trim()) return;

            const idea = input.value.trim();

            // Get the edited prompts from the cards (if generated)
            const featuresPrompt = document.getElementById('promptTextFeatures')?.value || '';
            const designPrompt = document.getElementById('promptTextDesign')?.value || '';
            const interactionsPrompt = document.getElementById('promptTextInteractions')?.value || '';
            const hasDetailedPrompts = featuresPrompt && designPrompt && interactionsPrompt;

            btn.disabled = true;
            btn.innerHTML = `
                <svg class="spinning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
                Planning...
            `;

            // Show build progress overlay while planning
            showBuildProgress();

            try {
                const extraContext = hasDetailedPrompts
                    ? `\n\nDetailed specs provided by user:\nFEATURES: ${featuresPrompt}\nDESIGN: ${designPrompt}\nINTERACTIONS: ${interactionsPrompt}`
                    : '';

                const buildPlan = await generateBuildPlan(idea, extraContext);

                if (!buildPlan || !buildPlan.steps || buildPlan.steps.length === 0) {
                    throw new Error('Failed to generate build plan');
                }

                const appName = buildPlan.appName || idea.split(' ').slice(0, 3).map(w => w.charAt(0).toUpperCase() + w.slice(1)).join(' ');

                window.quickAppResult = {
                    name: appName,
                    idea: idea,
                    html: '',
                    buildSteps: buildPlan.steps,
                    completedSteps: []
                };

                showMultiStepBuildView(buildPlan, appName, idea);

            } catch (error) {
                console.error('Failed to plan app build:', error);
                const overlay = document.getElementById('buildProgressOverlay');
                if (overlay) overlay.remove();
                alert('Failed to plan app build. Please try again.');
            }

            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                    <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                </svg>
                Build It
            `;
            updateQuickAppBuildBtn();
        }

        async function generateBuildPlan(idea, extraContext) {
            const response = await fetch('/api/gemini', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    prompt: `You are an expert app architect. Break this app idea into sequential build steps for a single-page HTML app.

APP IDEA: "${idea}"
${extraContext}

Rules:
- Step 1 is ALWAYS the base scaffold: HTML structure, navigation/layout, CSS theme (dark theme #0f0f0f), and visual shell. No real logic yet.
- Each subsequent step adds 1-2 specific features to the existing HTML.
- The final step is ALWAYS polish: animations, transitions, empty states, error handling, micro-interactions.
- Generate 4-8 steps depending on complexity.
- Each step's "prompt" should be a detailed, specific instruction for what to build/add.
- Keep step titles short (3-6 words).

Return JSON in this exact format:
{
  "appName": "Short App Name",
  "steps": [
    { "title": "App Shell & Layout", "description": "Create the base HTML structure with navigation and dark theme", "prompt": "detailed build instruction..." },
    { "title": "Feature Name", "description": "What this adds", "prompt": "detailed build instruction..." }
  ]
}`,
                    model: 'gemini-3-flash-preview',
                    generationConfig: {
                        temperature: 0.7,
                        maxOutputTokens: 3000,
                        responseMimeType: 'application/json'
                    }
                })
            });

            const data = await response.json();
            let jsonText = (data.text || '').trim();
            try {
                return JSON.parse(jsonText);
            } catch (e) {
                const match = jsonText.match(/\{[\s\S]*\}/);
                if (match) return JSON.parse(match[0]);
                throw new Error('Failed to parse build plan');
            }
        }

        function showMultiStepBuildView(plan, appName, idea) {
            // Remove the planning overlay
            const overlay = document.getElementById('buildProgressOverlay');
            if (overlay) overlay.remove();

            const quickAppScreen = document.getElementById('quickAppScreen');
            if (quickAppScreen) quickAppScreen.classList.remove('active');

            let previewView = document.getElementById('quickAppPreviewView');
            if (!previewView) {
                previewView = document.createElement('div');
                previewView.id = 'quickAppPreviewView';
                previewView.className = 'proposal-split-view';
                document.getElementById('builderMode').appendChild(previewView);
            }

            const stepsHtml = plan.steps.map((step, i) => `
                <div class="build-log-step pending" id="buildLogStep${i}" data-step-index="${i}">
                    <div class="build-log-step-icon">${i + 1}</div>
                    <div class="build-log-step-content">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div class="build-log-step-title">${step.title}</div>
                            <div style="font-size: 0.7rem; color: var(--text-tertiary); white-space: nowrap;">~20 cr</div>
                        </div>
                        <div class="build-log-step-desc">${step.description}</div>
                    </div>
                </div>
            `).join('');

            previewView.innerHTML = `
                <div class="proposal-app-preview">
                    <div class="proposal-app-header">
                        <button onclick="exitQuickAppPreview()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; margin: -8px; margin-right: 4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="proposal-app-header-icon" style="background: linear-gradient(135deg, #22c55e, #10b981)">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/>
                            </svg>
                        </div>
                        <div class="proposal-app-header-info">
                            <div class="proposal-app-header-name">${appName}</div>
                            <div class="proposal-app-header-hint" id="buildHeaderHint">Building step by step...</div>
                        </div>
                    </div>
                    <div class="proposal-phone-frame" id="quickAppPhoneFrame">
                        <div class="proposal-phone-notch"></div>
                        <div class="proposal-phone-screen">
                            <iframe id="quickAppFrame" srcdoc="<html><body style='background:#0f0f0f;color:#666;display:flex;align-items:center;justify-content:center;height:100vh;margin:0;font-family:system-ui'><div style='text-align:center'><div style='font-size:2rem;margin-bottom:12px'></div><div>Preparing scaffold...</div></div></body></html>"></iframe>
                        </div>
                        <div class="proposal-phone-home"></div>
                        <div class="proposal-resize-handle"></div>
                    </div>
                </div>
                <div class="proposal-chat-panel">
                    <div class="proposal-chat-header">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div style="font-weight: 600; color: var(--text-primary);">Build Queue</div>
                            <div id="buildCreditCost" style="font-size: 0.75rem; color: var(--text-tertiary); display: flex; align-items: center; gap: 4px;">
                                <span style="color: #fbbf24;"></span> ~${plan.steps.length * 20} credits total
                            </div>
                        </div>
                        <p class="proposal-chat-subtitle">Auto-building ${plan.steps.length} steps...</p>
                    </div>
                    <div class="build-log-container" id="buildLogContainer">
                        ${stepsHtml}
                    </div>
                    <div class="proposal-chat-messages" id="quickAppChatMessages" style="display: none;"></div>
                    <div class="proposal-chat-input-area">
                        <div class="proposal-chat-input-wrapper">
                            <textarea class="proposal-chat-input" id="quickAppChatInput" placeholder="Tweak something between steps..." rows="1" onkeydown="handleQuickAppChatKeydown(event)"></textarea>
                            <button class="proposal-chat-send" onclick="sendQuickAppIteration()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="proposal-fork-actions" id="buildActionButtons" style="display: none; flex-wrap: wrap;">
                        <button class="suggest-refinements-btn" id="suggestRefinementsBtn" onclick="suggestRefinements()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                            </svg>
                            Suggest Refinements
                        </button>
                        <button class="proposal-fork-btn secondary" onclick="exitQuickAppPreview()">Back</button>
                        <button class="proposal-fork-btn primary" onclick="saveQuickApp()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                <path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Save App
                        </button>
                    </div>
                </div>
            `;

            previewView.style.display = 'flex';

            // Auto-run all steps sequentially starting from step 0
            executeFeatureStep(0);
        }

        window._buildStepRunning = false;

        async function executeFeatureStep(stepIndex) {
            const steps = window.quickAppResult?.buildSteps;
            if (!steps || !steps[stepIndex] || window._buildStepRunning) return;

            window._buildStepRunning = true;
            const step = steps[stepIndex];
            const stepEl = document.getElementById(`buildLogStep${stepIndex}`);

            // Mark as active
            if (stepEl) {
                stepEl.classList.remove('pending');
                stepEl.classList.add('active');
                const reasoningEl = document.createElement('div');
                reasoningEl.className = 'build-log-step-reasoning';
                reasoningEl.textContent = stepIndex === 0 ? 'Creating the app foundation...' : `Adding ${step.title.toLowerCase()}...`;
                stepEl.querySelector('.build-log-step-content').appendChild(reasoningEl);
                const iconEl = stepEl.querySelector('.build-log-step-icon');
                if (iconEl) iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14" class="spinning"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>';
            }

            const container = document.getElementById('buildLogContainer');
            if (container && stepEl) stepEl.scrollIntoView({ behavior: 'smooth', block: 'nearest' });

            // Update header hint
            const hint = document.getElementById('buildHeaderHint');
            if (hint) hint.textContent = `Step ${stepIndex + 1}/${steps.length}: ${step.title}`;

            try {
                let buildPrompt;
                const currentHtml = window.quickAppResult.html;

                if (stepIndex === 0 || !currentHtml) {
                    buildPrompt = `Create the base scaffold for a single-page HTML app.

APP IDEA: "${window.quickAppResult.idea}"

THIS STEP: ${step.prompt}

Requirements:
- Self-contained HTML with embedded CSS and JavaScript
- Modern dark theme (background #0f0f0f, light text, subtle borders)
- Mobile-friendly and responsive
- Include navigation/layout structure
- Use placeholder content where features will be added later
- Make it visually polished even as a shell
${SUITE_API_REFERENCE}

Output ONLY the complete HTML code, starting with <!DOCTYPE html> and ending with </html>. No explanations or markdown.`;
                } else {
                    buildPrompt = `Here is the current HTML of an app being built step-by-step:

\`\`\`html
${currentHtml}
\`\`\`

APP IDEA: "${window.quickAppResult.idea}"

YOUR TASK FOR THIS STEP: ${step.prompt}

Rules:
- Add this feature to the existing app. Do NOT remove or break existing features.
- Keep all existing functionality intact.
- Integrate the new feature naturally into the existing layout/navigation.
- Maintain the same visual style and theme.
- If this feature needs AI, use the available APIs below.
${SUITE_API_REFERENCE}

Output ONLY the COMPLETE updated HTML (with all existing + new code), starting with <!DOCTYPE html> and ending with </html>. No explanations or markdown.`;
                }

                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: buildPrompt,
                        model: 'gemini-3-flash-preview',
                        generationConfig: {
                            temperature: stepIndex === 0 ? 0.7 : 0.5,
                            maxOutputTokens: 32000
                        }
                    })
                });

                const data = await response.json();
                let html = data.text || '';

                const htmlMatch = html.match(/<!DOCTYPE html>[\s\S]*<\/html>/i);
                if (htmlMatch) html = htmlMatch[0];
                if (!html) throw new Error('No HTML generated');

                // Update stored HTML and preview
                window.quickAppResult.html = html;
                window.quickAppResult.completedSteps.push(stepIndex);

                const iframe = document.getElementById('quickAppFrame');
                if (iframe) iframe.srcdoc = html;

                // Auto-save to user_apps (insert after step 1, update on subsequent steps)
                const autoSaveUser = getFactoryCurrentUser();
                if (supabaseClient && autoSaveUser) {
                    try {
                        if (stepIndex === 0 && !window.quickAppResult.savedAppId) {
                            const { data: savedApp, error } = await supabaseClient
                                .from('user_apps')
                                .insert({
                                    user_id: autoSaveUser.id,
                                    name: window.quickAppResult.name,
                                    description: window.quickAppResult.idea,
                                    code: html,
                                    icon_bg: 'linear-gradient(135deg, #22c55e, #10b981)',
                                    is_public: true
                                })
                                .select()
                                .single();
                            if (!error && savedApp) {
                                window.quickAppResult.savedAppId = savedApp.id;
                                renderSidebarApps(); // Show in sidebar immediately
                                ensureOperatorEntry(savedApp.id, window.quickAppResult.name, window.quickAppResult.idea);
                                createAutoProposal(savedApp.id, window.quickAppResult.name, window.quickAppResult.idea);
                            }
                        } else if (window.quickAppResult.savedAppId) {
                            await supabaseClient
                                .from('user_apps')
                                .update({ code: html })
                                .eq('id', window.quickAppResult.savedAppId);
                        }
                    } catch (saveErr) {
                        console.error('Auto-save failed:', saveErr);
                    }
                }

                // Mark step as done
                if (stepEl) {
                    stepEl.classList.remove('active');
                    stepEl.classList.add('done');
                    stepEl.style.cursor = 'default';
                    const iconEl = stepEl.querySelector('.build-log-step-icon');
                    if (iconEl) iconEl.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="20 6 9 17 4 12"/></svg>';
                    const reasoningEl = stepEl.querySelector('.build-log-step-reasoning');
                    if (reasoningEl) reasoningEl.textContent = 'Done';
                }

                // Check if all steps done
                if (window.quickAppResult.completedSteps.length === steps.length) {
                    transitionToIterationMode();
                } else {
                    // Auto-run next pending step
                    window._buildStepRunning = false;
                    const nextIndex = steps.findIndex((s, idx) => !window.quickAppResult.completedSteps.includes(idx));
                    if (nextIndex !== -1) {
                        executeFeatureStep(nextIndex);
                        return; // skip setting _buildStepRunning below since we already did
                    }
                }

            } catch (error) {
                console.error(`Build step ${stepIndex} failed:`, error);
                if (stepEl) {
                    stepEl.classList.remove('active');
                    stepEl.classList.add('error');
                    const iconEl = stepEl.querySelector('.build-log-step-icon');
                    if (iconEl) iconEl.innerHTML = '!';
                    const reasoningEl = stepEl.querySelector('.build-log-step-reasoning');
                    if (reasoningEl) reasoningEl.textContent = 'Failed  click to retry';
                    stepEl.style.cursor = 'pointer';
                    stepEl.onclick = () => {
                        stepEl.classList.remove('error');
                        stepEl.classList.add('pending');
                        const r = stepEl.querySelector('.build-log-step-reasoning');
                        if (r) r.remove();
                        executeFeatureStep(stepIndex);
                    };
                }
            }

            window._buildStepRunning = false;
        }

        function transitionToIterationMode() {
            const hint = document.getElementById('buildHeaderHint');
            if (hint) hint.textContent = 'Your app is ready! Tell me what to change.';

            // Collapse build log into summary
            const logContainer = document.getElementById('buildLogContainer');
            if (logContainer && window.quickAppResult?.buildSteps) {
                const steps = window.quickAppResult.buildSteps;
                const summaryStepsHtml = steps.map(s =>
                    `<div class="build-log-summary-step"><span style="color: #10b981;"></span> ${s.title}</div>`
                ).join('');

                logContainer.innerHTML = `
                    <div class="build-log-summary" onclick="this.classList.toggle('expanded')">
                        <div class="build-log-summary-header">
                            <span> Built in ${steps.length} steps</span>
                            <svg class="build-log-summary-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><polyline points="6 9 12 15 18 9"/></svg>
                        </div>
                        <div class="build-log-summary-steps">${summaryStepsHtml}</div>
                    </div>
                `;
                logContainer.style.flex = 'none';
            }

            // Show chat area
            const chatMessages = document.getElementById('quickAppChatMessages');
            if (chatMessages) {
                chatMessages.style.display = 'flex';
                chatMessages.innerHTML = `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content">
                            <strong>Your ${window.quickAppResult.name} is ready!</strong><br><br>
                            Built in ${window.quickAppResult.buildSteps.length} steps. Try it out in the preview, then tell me what you'd like to change.
                        </div>
                    </div>
                `;
            }

            // Show action buttons
            const actionBtns = document.getElementById('buildActionButtons');
            if (actionBtns) actionBtns.style.display = 'flex';

            const chatInput = document.getElementById('quickAppChatInput');
            if (chatInput) {
                chatInput.placeholder = 'What would you like to change?';
                chatInput.focus();
            }

            // Refresh sidebar to show the newly built app
            renderSidebarApps();
        }

        // Legacy wrapper for any code that calls showQuickAppPreview directly
        function showQuickAppPreview(html, appName, idea) {
            window.quickAppResult = { name: appName, idea: idea, html: html, buildSteps: [], completedSteps: [] };
            showMultiStepBuildView({ appName, steps: [] }, appName, idea);
            // Immediately transition since no steps to build
            const iframe = document.getElementById('quickAppFrame');
            if (iframe) iframe.srcdoc = html;
            transitionToIterationMode();
        }

        function exitQuickAppPreview() {
            const previewView = document.getElementById('quickAppPreviewView');
            if (previewView) previewView.style.display = 'none';

            // Go back to quick app screen
            enterQuickAppMode();
        }

        let quickAppMessages = [];

        function handleQuickAppChatKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendQuickAppIteration();
            }
        }

        async function sendQuickAppIteration() {
            const input = document.getElementById('quickAppChatInput');
            const messagesContainer = document.getElementById('quickAppChatMessages');
            if (!input || !input.value.trim() || !window.quickAppResult) return;

            const userMessage = input.value.trim();
            input.value = '';

            // Add user message to UI
            messagesContainer.innerHTML += `
                <div class="proposal-message user">
                    <div class="proposal-message-content">${userMessage}</div>
                </div>
            `;

            // Add loading indicator
            messagesContainer.innerHTML += `
                <div class="proposal-message assistant" id="quickAppLoading">
                    <div class="proposal-message-content">
                        <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                    </div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `Here is the current HTML of an app:

\`\`\`html
${window.quickAppResult.html}
\`\`\`

The user wants this change: "${userMessage}"

Apply the requested change and output the COMPLETE updated HTML. Start with <!DOCTYPE html> and end with </html>. No explanations, just the code.`,
                        model: 'gemini-3-flash-preview',
                        generationConfig: { temperature: 0.5, maxOutputTokens: 32000 }
                    })
                });

                const data = await response.json();
                let html = data.text || '';

                // Extract HTML
                const htmlMatch = html.match(/<!DOCTYPE html>[\s\S]*<\/html>/i);
                if (htmlMatch) {
                    html = htmlMatch[0];
                    window.quickAppResult.html = html;

                    // Update iframe
                    const iframe = document.getElementById('quickAppFrame');
                    if (iframe) {
                        iframe.srcdoc = html;
                    }

                    // Remove loading, add response
                    document.getElementById('quickAppLoading')?.remove();
                    messagesContainer.innerHTML += `
                        <div class="proposal-message assistant">
                            <div class="proposal-message-content">Done! I've applied the change. What else would you like to adjust?</div>
                        </div>
                    `;
                } else {
                    throw new Error('No HTML in response');
                }

            } catch (error) {
                console.error('Iteration failed:', error);
                document.getElementById('quickAppLoading')?.remove();
                messagesContainer.innerHTML += `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content" style="color: #f87171;">Sorry, I couldn't apply that change. Please try describing it differently.</div>
                    </div>
                `;
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        async function suggestRefinements() {
            const btn = document.getElementById('suggestRefinementsBtn');
            const messagesContainer = document.getElementById('quickAppChatMessages');
            if (!window.quickAppResult || !btn || !messagesContainer) return;

            btn.disabled = true;
            btn.innerHTML = `
                <svg class="spinning" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                    <path d="M21 12a9 9 0 11-6.219-8.56"/>
                </svg>
                Analyzing app...
            `;

            // Add loading message to chat
            messagesContainer.innerHTML += `
                <div class="proposal-message assistant" id="refinementLoading">
                    <div class="proposal-message-content">
                        <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span> Analyzing your app for improvements
                    </div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `You are a senior UX engineer and app reviewer. Analyze this HTML app and suggest exactly 5 specific, actionable improvements.

APP IDEA: "${window.quickAppResult.idea}"

HTML CODE:
\`\`\`html
${window.quickAppResult.html}
\`\`\`

For each suggestion, provide:
- "category": one of "ux", "polish", "feature", "perf", "a11y"
- "title": Short title (3-6 words)
- "description": One sentence explaining what to improve
- "prompt": The exact instruction to give to an AI to implement this change (be specific about what code changes are needed)

Focus on things that would make the biggest impact. Look for:
- Missing empty/loading/error states
- Animations and micro-interactions that are missing
- Features the user likely expects but aren't there
- Visual polish (shadows, gradients, spacing, transitions)
- Responsiveness issues
- Accessibility gaps

Return as JSON array. No markdown, no code blocks.`,
                        model: 'gemini-3-flash-preview',
                        generationConfig: {
                            temperature: 0.7,
                            maxOutputTokens: 2000,
                            responseMimeType: 'application/json'
                        }
                    })
                });

                if (!response.ok) throw new Error('API failed: ' + response.status);

                const data = await response.json();
                let jsonText = (data.text || '').trim();

                let suggestions;
                try {
                    suggestions = JSON.parse(jsonText);
                } catch (e) {
                    const arrMatch = jsonText.match(/\[[\s\S]*\]/);
                    if (arrMatch) suggestions = JSON.parse(arrMatch[0]);
                }

                if (!Array.isArray(suggestions) || suggestions.length === 0) {
                    throw new Error('No suggestions returned');
                }

                const categoryIcons = {
                    ux: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg>',
                    polish: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>',
                    feature: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M12 8v8M8 12h8"/></svg>',
                    perf: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>',
                    a11y: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>'
                };

                const cardsHtml = suggestions.map((s, i) => {
                    const cat = s.category || 'polish';
                    const icon = categoryIcons[cat] || categoryIcons.polish;
                    const prompt = (s.prompt || s.description || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    return `
                        <div class="refinement-card" onclick="applyRefinement('${prompt}')">
                            <div class="refinement-card-icon ${cat}">${icon}</div>
                            <div class="refinement-card-text">
                                <div class="refinement-card-title">${s.title || 'Improvement'}</div>
                                <div class="refinement-card-desc">${s.description || ''}</div>
                            </div>
                            <div class="refinement-card-apply">Apply </div>
                        </div>
                    `;
                }).join('');

                // Remove loading, show suggestions
                document.getElementById('refinementLoading')?.remove();
                messagesContainer.innerHTML += `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content">
                            <strong>Here are some refinements I'd suggest:</strong>
                            <div class="refinement-suggestions">
                                ${cardsHtml}
                            </div>
                        </div>
                    </div>
                `;

            } catch (error) {
                console.error('Failed to get refinements:', error);
                document.getElementById('refinementLoading')?.remove();
                messagesContainer.innerHTML += `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content" style="color: #f87171;">Couldn't analyze the app. Try again or describe what you'd like to improve.</div>
                    </div>
                `;
            }

            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            // Reset button
            btn.disabled = false;
            btn.innerHTML = `
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                </svg>
                Suggest Refinements
            `;
        }

        function applyRefinement(prompt) {
            const input = document.getElementById('quickAppChatInput');
            if (input) {
                input.value = prompt;
                sendQuickAppIteration();
            }
        }

        async function ensureOperatorEntry(userAppId, name, description) {
            const currentUser = getFactoryCurrentUser();
            if (!supabaseClient || !currentUser) return;
            try {
                // Check if operator already exists for this user_app_id
                const { data: existing } = await supabaseClient
                    .from('suite_operators')
                    .select('id')
                    .eq('user_app_id', userAppId)
                    .maybeSingle();

                if (existing) {
                    // Update name/description
                    await supabaseClient
                        .from('suite_operators')
                        .update({ name, description })
                        .eq('id', existing.id);
                } else {
                    // Insert new operator
                    await supabaseClient
                        .from('suite_operators')
                        .insert({
                            user_app_id: userAppId,
                            user_id: currentUser.id,
                            name,
                            description,
                            status: 'active'
                        });
                }
            } catch (e) {
                console.error('ensureOperatorEntry failed (non-blocking):', e);
            }
        }

        // ===== AUTO-PROPOSAL ON BUILD =====
        async function createAutoProposal(userAppId, name, description) {
            const currentUser = getFactoryCurrentUser();
            if (!supabaseClient || !currentUser) return;
            try {
                // Check if proposal already exists for this user_app
                const { data: existing } = await supabaseClient
                    .from('factory_proposals')
                    .select('id')
                    .eq('user_app_id', userAppId)
                    .maybeSingle();
                if (existing) return; // Already has a proposal

                await supabaseClient
                    .from('factory_proposals')
                    .insert({
                        user_id: currentUser.id,
                        name: name,
                        description: description || 'Community-built app submitted for governance review.',
                        status: 'idea',
                        type: 'new',
                        user_app_id: userAppId
                    });
                console.log('Auto-proposal created for app:', name);
            } catch (e) {
                console.error('createAutoProposal failed (non-blocking):', e);
            }
        }

        // ===== CREDIT SDK INJECTION =====
        function injectCreditSDK(html, appId) {
            const sdkScript = `
<scr` + `ipt>
// SUITE Credit SDK  injected by SuiteGPT
window.SUITE = window.SUITE || {};
window.SUITE._pendingCharges = {};
window.SUITE._chargeCounter = 0;
window.SUITE.chargeCredits = function(feature, callback) {
    var id = 'charge_' + (++window.SUITE._chargeCounter) + '_' + Date.now();
    window.SUITE._pendingCharges[id] = callback || function() {};
    window.parent.postMessage({
        type: 'suite-charge-credits',
        appId: '${appId}',
        feature: feature || 'ai_action',
        chargeId: id
    }, '*');
};
window.addEventListener('message', function(e) {
    if (e.data && e.data.type === 'suite-charge-result' && e.data.chargeId) {
        var cb = window.SUITE._pendingCharges[e.data.chargeId];
        if (cb) {
            cb({ success: e.data.success, error: e.data.error, totalCharged: e.data.totalCharged });
            delete window.SUITE._pendingCharges[e.data.chargeId];
        }
    }
});
</scr` + `ipt>`;
            // Inject before </head> or at the start of <body>
            if (html.includes('</head>')) {
                return html.replace('</head>', sdkScript + '\n</head>');
            } else if (html.includes('<body')) {
                return html.replace(/<body[^>]*>/, (match) => match + sdkScript);
            }
            return sdkScript + html;
        }

        // ===== PARENT CREDIT CHARGE LISTENER =====
        window.addEventListener('message', async function(e) {
            if (!e.data || e.data.type !== 'suite-charge-credits') return;
            const { appId, feature, chargeId } = e.data;
            if (!appId || !chargeId) return;

            const currentUser = getFactoryCurrentUser();
            if (!supabaseClient || !currentUser) {
                e.source?.postMessage({ type: 'suite-charge-result', chargeId, success: false, error: 'Not signed in' }, '*');
                return;
            }

            try {
                // Get user wallet
                const walletAddress = currentUser.user_metadata?.wallet_address || currentUser.email;
                if (!walletAddress) {
                    e.source?.postMessage({ type: 'suite-charge-result', chargeId, success: false, error: 'No wallet found' }, '*');
                    return;
                }

                // Call the deduct_app_credits RPC
                const { data, error } = await supabaseClient.rpc('deduct_app_credits', {
                    p_wallet: walletAddress.toLowerCase(),
                    p_base_cost: BASE_AI_COST,
                    p_user_app_id: appId
                });

                if (error) throw error;

                const result = typeof data === 'string' ? JSON.parse(data) : data;
                e.source?.postMessage({
                    type: 'suite-charge-result',
                    chargeId,
                    success: result.success,
                    error: result.error || null,
                    totalCharged: result.total_charged || 0
                }, '*');
            } catch (err) {
                console.error('Credit charge failed:', err);
                e.source?.postMessage({ type: 'suite-charge-result', chargeId, success: false, error: err.message }, '*');
            }
        });

        // ===== APP SETTINGS MODAL =====
        async function openAppSettings(appId) {
            if (!supabaseClient) return;

            try {
                const { data: app, error } = await supabaseClient
                    .from('user_apps')
                    .select('id, name, description, builder_markup, total_earnings, is_public, is_listed')
                    .eq('id', appId)
                    .single();

                if (error) throw error;

                const markup = parseFloat(app.builder_markup) || 0;
                const earnings = parseFloat(app.total_earnings) || 0;
                const totalCost = BASE_AI_COST + markup;

                const overlay = document.getElementById('appSettingsOverlay');
                const body = document.getElementById('appSettingsBody');
                if (!overlay || !body) return;

                body.innerHTML = `
                    <input type="hidden" id="appSettingsId" value="${app.id}">
                    <div class="app-settings-group">
                        <label class="app-settings-label">App Name</label>
                        <div class="app-settings-value">${app.name || 'Untitled'}</div>
                    </div>
                    <div class="app-settings-group">
                        <label class="app-settings-label">Credit Pricing</label>
                        <div class="app-settings-pricing">
                            <div class="app-settings-pricing-row">
                                <span>Base API Cost (SUITE)</span>
                                <span class="app-settings-cost-badge">${BASE_AI_COST} credits</span>
                            </div>
                            <div class="app-settings-pricing-row">
                                <span>Your Markup</span>
                                <input type="number" id="appSettingsMarkup" class="app-settings-markup-input" min="0" max="100" step="1" value="${markup}" onchange="updateAppSettingsCostPreview()" oninput="updateAppSettingsCostPreview()">
                            </div>
                            <div class="app-settings-pricing-row total">
                                <span>User Pays</span>
                                <span id="appSettingsTotalCost" class="app-settings-total-cost">${totalCost} credits</span>
                            </div>
                        </div>
                    </div>
                    <div class="app-settings-group">
                        <label class="app-settings-label">Your Earnings</label>
                        <div class="app-settings-earnings">${earnings.toFixed(2)} credits earned</div>
                    </div>
                    <div class="app-settings-group">
                        <label class="app-settings-label">Visibility</label>
                        <div class="app-settings-toggles">
                            <label class="app-settings-toggle">
                                <input type="checkbox" id="appSettingsPublic" ${app.is_public ? 'checked' : ''}>
                                <span>Public (others can use)</span>
                            </label>
                            <label class="app-settings-toggle">
                                <input type="checkbox" id="appSettingsListed" ${app.is_listed ? 'checked' : ''}>
                                <span>Listed (show in app store)</span>
                            </label>
                        </div>
                    </div>
                    <button class="app-settings-save-btn" onclick="saveAppSettings()">Save Settings</button>
                `;

                overlay.classList.add('active');
            } catch (err) {
                console.error('Failed to load app settings:', err);
                alert('Failed to load app settings.');
            }
        }

        function updateAppSettingsCostPreview() {
            const markupInput = document.getElementById('appSettingsMarkup');
            const totalEl = document.getElementById('appSettingsTotalCost');
            if (!markupInput || !totalEl) return;
            const markup = parseFloat(markupInput.value) || 0;
            totalEl.textContent = (BASE_AI_COST + markup) + ' credits';
        }

        async function saveAppSettings() {
            const appId = document.getElementById('appSettingsId')?.value;
            const markup = parseFloat(document.getElementById('appSettingsMarkup')?.value) || 0;
            const isPublic = document.getElementById('appSettingsPublic')?.checked || false;
            const isListed = document.getElementById('appSettingsListed')?.checked || false;

            if (!supabaseClient || !appId) return;

            try {
                const { error } = await supabaseClient
                    .from('user_apps')
                    .update({
                        builder_markup: markup,
                        is_public: isPublic,
                        is_listed: isListed
                    })
                    .eq('id', appId);

                if (error) throw error;

                showToast('App settings saved!');
                closeAppSettings();
                renderDashboardApps();
            } catch (err) {
                console.error('Failed to save app settings:', err);
                alert('Failed to save settings: ' + err.message);
            }
        }

        function closeAppSettings(event) {
            if (event && event.target !== event.currentTarget) return;
            const overlay = document.getElementById('appSettingsOverlay');
            if (overlay) overlay.classList.remove('active');
        }

        async function saveQuickApp() {
            if (!window.quickAppResult) return;

            const { name, idea, html } = window.quickAppResult;
            const currentUser = getFactoryCurrentUser();

            if (!supabaseClient || !currentUser) {
                alert('Please sign in to save your app to your collection.');
                return;
            }

            try {
                if (window.quickAppResult.savedAppId) {
                    // Already auto-saved during build - just update with latest code
                    const { error } = await supabaseClient
                        .from('user_apps')
                        .update({ code: html, name: name, description: idea })
                        .eq('id', window.quickAppResult.savedAppId);
                    if (error) throw error;
                    ensureOperatorEntry(window.quickAppResult.savedAppId, name, idea);
                    createAutoProposal(window.quickAppResult.savedAppId, name, idea);
                } else {
                    // Not yet saved - insert new
                    const { data, error } = await supabaseClient
                        .from('user_apps')
                        .insert({
                            user_id: currentUser.id,
                            name: name,
                            description: idea,
                            code: html,
                            icon_bg: 'linear-gradient(135deg, #22c55e, #10b981)',
                            is_public: true
                        })
                        .select()
                        .single();
                    if (error) throw error;
                    if (data) {
                        window.quickAppResult.savedAppId = data.id;
                        ensureOperatorEntry(data.id, name, idea);
                        createAutoProposal(data.id, name, idea);
                    }
                }

                alert(`"${name}" saved!`);
                exitQuickAppPreview();
                goBackToBuilderChoice();

            } catch (error) {
                console.error('Save failed:', error);
                alert('Failed to save app. Please try again.');
            }
        }

        function enterBuilderCreateMode() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const createAppChoiceScreen = document.getElementById('createAppChoiceScreen');
            const builderContent = document.getElementById('builderContent');
            const builderInputArea = document.querySelector('.builder-input-area');
            const builderMessages = document.getElementById('builderMessages');

            // Hide choice screens, show builder content
            if (choiceScreen) choiceScreen.style.display = 'none';
            if (createAppChoiceScreen) createAppChoiceScreen.style.display = 'none';
            if (builderContent) builderContent.style.display = 'flex';
            if (builderInputArea) builderInputArea.style.display = 'block';

            // Reset to Create mode welcome message
            if (builderMessages) {
                builderMessages.innerHTML = `
                    <div class="builder-message assistant">
                        <div class="builder-message-avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                            </svg>
                        </div>
                        <div class="builder-message-content">
                            <p class="builder-welcome-text">Welcome to SuiteGPT Builder. Tell me what you want to create, and I'll help you build it.</p>
                            <div class="builder-starter-prompts">
                                <button class="builder-starter-chip" onclick="useBuilderStarter('I want to build an app that')">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <path d="M12 8v8M8 12h8"/>
                                        </svg>
                                    </span>
                                    Build an app
                                </button>
                                <button class="builder-starter-chip" onclick="useBuilderStarter('I need a tool that helps me')">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/>
                                        </svg>
                                    </span>
                                    Create a tool
                                </button>
                                <button class="builder-starter-chip" onclick="useBuilderStarter('Modify an existing app:')">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M12 20h9M16.5 3.5a2.12 2.12 0 013 3L7 19l-4 1 1-4L16.5 3.5z"/>
                                        </svg>
                                    </span>
                                    Modify an app
                                </button>
                                <button class="builder-starter-chip" onclick="useBuilderStarter('I have an idea:')">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                                        </svg>
                                    </span>
                                    Share an idea
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Update URL
            history.pushState({ view: 'suitegptbuilder', mode: 'create-full' }, '', '/suitegptbuilder/create/full');

            // Focus input
            setTimeout(() => {
                const builderInput = document.getElementById('builderInput');
                if (builderInput) builderInput.focus();
            }, 100);
        }

        let proposalSelectedApp = null;

        function enterBuilderProposalMode() {
            const choiceScreen = document.getElementById('builderChoiceScreen');
            const builderContent = document.getElementById('builderContent');
            const builderInputArea = document.querySelector('.builder-input-area');

            // Hide choice screen, show builder content
            if (choiceScreen) choiceScreen.style.display = 'none';
            if (builderContent) builderContent.style.display = 'flex';
            if (builderInputArea) builderInputArea.style.display = 'block';

            // Update URL
            history.pushState({ view: 'suitegptbuilder', mode: 'proposal' }, '', '/suitegptbuilder/proposal');

            // Clear existing messages and show proposal welcome
            const builderMessages = document.getElementById('builderMessages');
            if (builderMessages) {
                builderMessages.innerHTML = `
                    <div class="builder-message assistant">
                        <div class="builder-message-avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                            </svg>
                        </div>
                        <div class="builder-message-content">
                            <p class="builder-welcome-text">Let's create a proposal. First, select the app you want to propose changes for:</p>
                            <div class="proposal-app-selector">
                                <div class="proposal-app-search">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                                        <circle cx="11" cy="11" r="8"/>
                                        <path d="M21 21l-4.35-4.35"/>
                                    </svg>
                                    <input type="text" placeholder="Search apps..." id="proposalAppSearch" oninput="filterProposalApps(this.value)">
                                </div>
                                <div class="proposal-app-list" id="proposalAppList">
                                    ${getProposalAppListHTML()}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            // Focus search
            setTimeout(() => {
                const searchInput = document.getElementById('proposalAppSearch');
                if (searchInput) searchInput.focus();
            }, 100);
        }

        function getProposalAppListHTML() {
            // Use all apps from SUITE_APPS
            return Object.entries(SUITE_APPS).map(([appKey, app]) => {
                const iconHtml = app.iconUrl
                    ? `<img src="${app.iconUrl}" alt="${app.name}" onerror="this.style.display='none'">`
                    : `<div style="background: ${app.iconBg || 'linear-gradient(135deg, #6366f1, #4f46e5)'}; width: 100%; height: 100%; border-radius: 10px;"></div>`;
                return `
                    <button class="proposal-app-item" onclick="selectProposalApp('${appKey}', '${app.name}')" data-app-name="${app.name.toLowerCase()}">
                        <div class="proposal-app-icon">${iconHtml}</div>
                        <span class="proposal-app-name">${app.name}</span>
                    </button>
                `;
            }).join('');
        }

        function filterProposalApps(query) {
            const items = document.querySelectorAll('.proposal-app-item');
            const lower = query.toLowerCase();
            items.forEach(item => {
                const name = item.dataset.appName || item.querySelector('.proposal-app-name').textContent.toLowerCase();
                item.style.display = name.includes(lower) ? '' : 'none';
            });
        }

        let proposalMessages = [];
        let proposalMode = 'propose';
        let capturedElement = null;
        let vfActive = false;

        function selectProposalApp(appKey, appName) {
            proposalSelectedApp = { key: appKey, name: appName };
            proposalMessages = [];
            capturedElement = null;
            proposalMode = 'propose';
            vfActive = false;

            const app = SUITE_APPS[appKey];
            if (!app) return;

            const builderContent = document.getElementById('builderContent');
            const builderInputArea = document.querySelector('.builder-input-area');
            if (builderContent) builderContent.style.display = 'none';
            if (builderInputArea) builderInputArea.style.display = 'none';

            let splitView = document.getElementById('proposalSplitView');
            if (!splitView) {
                splitView = document.createElement('div');
                splitView.id = 'proposalSplitView';
                splitView.className = 'proposal-split-view';
                document.getElementById('builderMode').appendChild(splitView);
            }

            splitView.innerHTML = `
                <div class="proposal-app-preview">
                    <div class="proposal-app-header" id="proposalAppHeader">
                        <button onclick="exitProposalSplitView()" style="background: none; border: none; color: var(--text-secondary); cursor: pointer; padding: 8px; margin: -8px; margin-right: 4px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                        <div class="proposal-app-header-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                            ${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : ''}
                        </div>
                        <div class="proposal-app-header-info">
                            <div class="proposal-app-header-name">${app.name}</div>
                            <div class="proposal-app-header-hint" id="proposalHint">Click "Select Element" to pick a part of the app</div>
                        </div>
                        <button onclick="toggleVF()" id="vfBtn" style="background: rgba(99,102,241,0.2); border: 1px solid rgba(99,102,241,0.3); color: #a5b4fc; padding: 8px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg>
                            Select Element
                        </button>
                    </div>
                    <div class="proposal-phone-frame" id="proposalPhoneFrame">
                        <div class="proposal-phone-notch"></div>
                        <div class="proposal-phone-screen">
                            <iframe src="${app.url}" id="proposalAppFrame" onload="injectVF()"></iframe>
                        </div>
                        <div class="proposal-phone-home"></div>
                        <div class="proposal-resize-handle"></div>
                    </div>
                </div>
                <div class="proposal-chat-panel">
                    <div class="proposal-chat-header">
                        <div class="proposal-mode-tabs">
                            <button class="proposal-mode-tab active" id="proposeTab" onclick="setProposalMode('propose')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                                Propose
                            </button>
                            <button class="proposal-mode-tab fork-tab" id="forkTab" onclick="setProposalMode('fork')">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="18" r="3"/><circle cx="6" cy="6" r="3"/><circle cx="18" cy="6" r="3"/><path d="M18 9v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2V9"/><path d="M12 12v3"/></svg>
                                Fork
                            </button>
                        </div>
                        <p class="proposal-chat-subtitle" id="modeSubtitle">Submit to governance (24hr review)</p>
                    </div>
                    <div id="capturedElDisplay" style="display:none;padding:0 16px;"></div>
                    <div class="proposal-chat-messages" id="proposalChatMessages">
                        <div class="proposal-message assistant">
                            <div class="proposal-message-content">
                                <strong>What would you like to change about ${app.name}?</strong><br><br>
                                <span style="color:#a5b4fc;">Tip:</span> Click "Select Element" to pick a specific part of the app.
                            </div>
                        </div>
                    </div>
                    <div class="proposal-chat-input-area">
                        <div class="proposal-chat-input-wrapper">
                            <textarea class="proposal-chat-input" id="proposalChatInput" placeholder="Describe your proposed change..." rows="1" onkeydown="handleProposalInputKeydown(event)"></textarea>
                            <button class="proposal-chat-send" onclick="sendProposalMessage()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                                    <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    <div class="proposal-fork-actions" id="forkActions" style="display:none;">
                        <button class="proposal-fork-btn secondary" onclick="exitProposalSplitView()">Cancel</button>
                        <button class="proposal-fork-btn primary" id="forkBtn" onclick="applyFork()" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 6L9 17l-5-5"/></svg>
                            Fork & Apply Changes
                        </button>
                    </div>
                </div>
            `;

            splitView.style.display = 'flex';
            window.addEventListener('message', handleVFMessage);

            setTimeout(() => {
                const input = document.getElementById('proposalChatInput');
                if (input) input.focus();
            }, 100);
        }

        // Mode switching
        function setProposalMode(mode) {
            proposalMode = mode;
            document.getElementById('proposeTab')?.classList.toggle('active', mode === 'propose');
            document.getElementById('forkTab')?.classList.toggle('active', mode === 'fork');
            const sub = document.getElementById('modeSubtitle');
            if (sub) {
                sub.textContent = mode === 'fork' ? 'Your copy, instant changes (90% revenue)' : 'Submit to governance (24hr review)';
                sub.style.color = mode === 'fork' ? '#4ade80' : '';
            }
            document.getElementById('forkActions').style.display = mode === 'fork' ? 'flex' : 'none';
            updateForkBtn();
        }

        function updateForkBtn() {
            const btn = document.getElementById('forkBtn');
            if (btn && proposalMode === 'fork') {
                btn.disabled = proposalMessages.filter(m => m.role === 'user').length === 0;
            }
        }

        // Visual Feedback
        function toggleVF() {
            vfActive = !vfActive;
            const btn = document.getElementById('vfBtn');
            const header = document.getElementById('proposalAppHeader');
            if (vfActive) {
                btn.style.background = 'rgba(99,102,241,0.5)';
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg> Click element...';
                header?.classList.add('vf-active');
                document.getElementById('proposalAppFrame')?.contentWindow?.postMessage({type:'vf-start'}, '*');
            } else {
                btn.style.background = 'rgba(99,102,241,0.2)';
                btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg> Select Element';
                header?.classList.remove('vf-active');
                document.getElementById('proposalAppFrame')?.contentWindow?.postMessage({type:'vf-stop'}, '*');
            }
        }

        function injectVF() {
            const iframe = document.getElementById('proposalAppFrame');
            if (!iframe) return;
            try {
                const doc = iframe.contentDocument || iframe.contentWindow?.document;
                if (doc) {
                    const s = doc.createElement('script');
                    s.textContent = `(function(){let on=false,hl;function mk(){if(hl)return;hl=document.createElement('div');hl.style.cssText='position:fixed;pointer-events:none;border:3px solid #6366f1;background:rgba(99,102,241,0.15);z-index:999999;display:none;border-radius:4px;';document.body.appendChild(hl);}document.addEventListener('mousemove',e=>{if(!on)return;const el=document.elementFromPoint(e.clientX,e.clientY);if(el&&el!==hl){const r=el.getBoundingClientRect();hl.style.top=r.top+'px';hl.style.left=r.left+'px';hl.style.width=r.width+'px';hl.style.height=r.height+'px';hl.style.display='block';}});document.addEventListener('click',e=>{if(!on)return;e.preventDefault();e.stopPropagation();const el=document.elementFromPoint(e.clientX,e.clientY);if(el&&el!==hl){window.parent.postMessage({type:'vf-picked',data:{tag:el.tagName.toLowerCase(),id:el.id||'',cls:el.className||'',txt:(el.innerText||'').substring(0,80).trim()}},'*');on=false;hl.style.display='none';document.body.style.cursor='';}},true);window.addEventListener('message',e=>{if(e.data.type==='vf-start'){on=true;mk();document.body.style.cursor='crosshair';}else if(e.data.type==='vf-stop'){on=false;if(hl)hl.style.display='none';document.body.style.cursor='';}});})();`;
                    doc.body.appendChild(s);
                }
            } catch(e) { console.log('VF inject failed:', e.message); }
        }

        function handleVFMessage(e) {
            if (e.data.type === 'vf-picked') {
                capturedElement = e.data.data;
                vfActive = false;
                const btn = document.getElementById('vfBtn');
                const header = document.getElementById('proposalAppHeader');
                if (btn) { btn.style.background = 'rgba(99,102,241,0.2)'; btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg> Select Element'; }
                header?.classList.remove('vf-active');
                showCapturedEl(capturedElement);
            }
        }

        function showCapturedEl(el) {
            const d = document.getElementById('capturedElDisplay');
            if (!d) return;
            const sel = el.tag + (el.id ? '#'+el.id : '') + (el.cls ? '.'+el.cls.split(' ').filter(c=>c).slice(0,2).join('.') : '');
            d.innerHTML = `<div class="captured-element"><div class="captured-element-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M15 15l-2 5L9 9l11 4-5 2z"/></svg></div><div class="captured-element-info"><div class="captured-element-tag">${sel}</div><div class="captured-element-text">${el.txt||'(no text)'}</div></div><button class="captured-element-remove" onclick="clearCapturedEl()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M18 6L6 18M6 6l12 12"/></svg></button></div>`;
            d.style.display = 'block';
            const msgs = document.getElementById('proposalChatMessages');
            if (msgs) {
                msgs.innerHTML += `<div class="proposal-message assistant"><div class="proposal-message-content"><span style="color:#a5b4fc;">Selected:</span> <code style="background:rgba(99,102,241,0.2);padding:2px 6px;border-radius:4px;">${sel}</code>${el.txt?'<br><span style="color:var(--text-tertiary);">"'+el.txt.substring(0,50)+(el.txt.length>50?'...':'')+'"</span>':''}<br><br>What would you like to change?</div></div>`;
                msgs.scrollTop = msgs.scrollHeight;
            }
        }

        function clearCapturedEl() {
            capturedElement = null;
            const d = document.getElementById('capturedElDisplay');
            if (d) { d.innerHTML = ''; d.style.display = 'none'; }
        }

        // Apply Fork with Kimi K2
        async function applyFork() {
            if (!proposalSelectedApp) return;
            const user = supabaseClient ? (await supabaseClient.auth.getUser()).data.user : null;
            if (!user) { alert('Please log in to fork apps'); return; }

            const btn = document.getElementById('forkBtn');
            if (btn) { btn.disabled = true; btn.innerHTML = '<span class="typing-dots"><span>.</span><span>.</span><span>.</span></span> Creating fork...'; }

            try {
                const app = SUITE_APPS[proposalSelectedApp.key];
                const resp = await fetch(app.url);
                const originalCode = await resp.text();

                const changes = proposalMessages.filter(m => m.role === 'user').map(m => m.content).join('\\n');
                const elCtx = capturedElement ? `Target element: ${capturedElement.tag}${capturedElement.id?'#'+capturedElement.id:''}${capturedElement.cls?'.'+capturedElement.cls.split(' ').slice(0,2).join('.'):''}\\nElement text: "${capturedElement.txt||''}"\\n\\n` : '';

                const kimiResp = await fetch('/api/kimi', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messages: [
                            { role: 'system', content: 'You are an expert web developer. Apply the requested changes to this HTML app. Return ONLY the complete modified HTML code. Make minimal, targeted changes.' },
                            { role: 'user', content: 'Original HTML:\\n```html\\n' + originalCode + '\\n```\\n\\n' + elCtx + 'Requested changes:\\n' + changes + '\\n\\nReturn the modified HTML.' }
                        ],
                        temperature: 0.3,
                        max_tokens: 32000
                    })
                });

                const kimiData = await kimiResp.json();
                if (!kimiResp.ok) throw new Error(kimiData.error || 'Kimi API error');

                let newCode = (kimiData.text || '').replace(/^```html\\n?/i, '').replace(/\\n?```$/i, '').trim();
                if (!newCode || newCode.length < 100) throw new Error('Invalid AI response');

                const { error } = await supabaseClient.from('user_apps').insert({
                    user_id: user.id,
                    name: 'My ' + app.name,
                    description: 'Forked from ' + app.name,
                    icon_url: app.iconUrl,
                    icon_bg: app.iconBg,
                    code: newCode,
                    forked_from: proposalSelectedApp.key,
                    revenue_split: 90,
                    is_public: false,
                    is_listed: false
                });

                if (error) throw error;

                alert('Fork created! Find it in Your Apps section.');
                exitProposalSplitView();

            } catch (err) {
                console.error('Fork error:', err);
                alert('Fork failed: ' + err.message);
                if (btn) { btn.disabled = false; btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18"><path d="M20 6L9 17l-5-5"/></svg> Fork & Apply Changes'; }
            }
        }

        function exitProposalSplitView() {
            window.removeEventListener('message', handleVFMessage);
            const splitView = document.getElementById('proposalSplitView');
            if (splitView) splitView.style.display = 'none';

            // Go back to proposal mode app selection
            enterBuilderProposalMode();
        }

        function handleProposalInputKeydown(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendProposalMessage();
            }
        }

        async function sendProposalMessage() {
            const input = document.getElementById('proposalChatInput');
            const messagesContainer = document.getElementById('proposalChatMessages');
            if (!input || !messagesContainer) return;

            const text = input.value.trim();
            if (!text) return;

            // Add user message
            proposalMessages.push({ role: 'user', content: text });
            messagesContainer.innerHTML += `
                <div class="proposal-message user">
                    <div class="proposal-message-content">${text}</div>
                </div>
            `;
            input.value = '';
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            updateForkBtn();

            // Show typing indicator
            const typingId = 'proposal-typing-' + Date.now();
            messagesContainer.innerHTML += `
                <div class="proposal-message assistant" id="${typingId}">
                    <div class="proposal-message-content">
                        <span class="typing-dots"><span>.</span><span>.</span><span>.</span></span>
                    </div>
                </div>
            `;
            messagesContainer.scrollTop = messagesContainer.scrollHeight;

            try {
                // Call AI to help refine the proposal
                const systemPrompt = `You are helping a user create a proposal for changes to the app "${proposalSelectedApp.name}".
                Help them clarify and refine their ideas. Ask follow-up questions if needed.
                Keep responses concise (2-3 sentences max).
                When they've described enough, offer to summarize into a formal proposal.`;

                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: 'gemini-2.0-flash',
                        systemInstruction: systemPrompt,
                        contents: proposalMessages.map(m => ({
                            role: m.role === 'assistant' ? 'model' : 'user',
                            parts: [{ text: m.content }]
                        }))
                    })
                });

                const data = await response.json();
                const aiText = data.text || 'I understand. Can you tell me more about what you have in mind?';

                // Remove typing indicator and add response
                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();

                proposalMessages.push({ role: 'assistant', content: aiText });
                messagesContainer.innerHTML += `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content">${aiText}</div>
                    </div>
                `;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

            } catch (error) {
                console.error('Proposal chat error:', error);
                const typingEl = document.getElementById(typingId);
                if (typingEl) typingEl.remove();

                messagesContainer.innerHTML += `
                    <div class="proposal-message assistant">
                        <div class="proposal-message-content">I understand your idea. Keep describing what you'd like to change!</div>
                    </div>
                `;
            }
        }

        // Builder Model Dropdown Functions
        let currentBuilderModel = 'suitegpt';

        function toggleBuilderModelDropdown(e) {
            if (e) e.stopPropagation();
            const dropdown = document.getElementById('builderModelDropdown');
            const selector = document.getElementById('builderModelSelector');
            if (dropdown) dropdown.classList.toggle('active');
            if (selector) selector.classList.toggle('active');
        }

        function closeBuilderModelDropdown() {
            const dropdown = document.getElementById('builderModelDropdown');
            const selector = document.getElementById('builderModelSelector');
            if (dropdown) dropdown.classList.remove('active');
            if (selector) selector.classList.remove('active');
        }

        // Pending switch state for confirmation modal
        let pendingBuilderSwitch = { mode: null, modeName: null };

        function switchBuilderModel(mode, modeName) {
            closeBuilderModelDropdown();

            // If staying in suitegpt mode, just update the display
            if (mode === 'suitegpt') {
                currentBuilderModel = mode;
                const nameEl = document.getElementById('builderModelName');
                if (nameEl) nameEl.textContent = modeName;
                updateBuilderDropdownActive(mode);
                return;
            }

            // Switching away from builder - show confirmation modal
            pendingBuilderSwitch = { mode, modeName };
            openBuilderSwitchModal();
        }

        function openBuilderSwitchModal() {
            const modal = document.getElementById('builderSwitchModal');
            if (modal) modal.classList.add('active');
        }

        function closeBuilderSwitchModal() {
            const modal = document.getElementById('builderSwitchModal');
            if (modal) modal.classList.remove('active');
            pendingBuilderSwitch = { mode: null, modeName: null };
        }

        function confirmBuilderSwitch() {
            const { mode, modeName } = pendingBuilderSwitch;
            if (!mode) return;

            closeBuilderSwitchModal();

            // Exit builder mode
            exitBuilderMode();

            // Update main chat model selector
            currentModel = mode;
            const mainNameEl = document.getElementById('modelName');
            if (mainNameEl) mainNameEl.textContent = modeName;

            // Update main dropdown active state
            const mainItems = document.querySelectorAll('#modelDropdown .model-dropdown-item');
            mainItems.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.mode === mode) {
                    item.classList.add('active');
                }
            });

            // Check if Pro mode requires upgrade
            if (mode === 'opus') {
                const isLoggedIn = !!(localStorage.getItem('connectedWallet') || localStorage.getItem('telegram_user'));
                if (!isLoggedIn) {
                    openConnectModal();
                    return;
                }
            }

            console.log('Switched to model:', mode);
        }

        function updateBuilderDropdownActive(mode) {
            const items = document.querySelectorAll('.builder-model-dropdown-item');
            items.forEach(item => {
                item.classList.remove('active');
                if (item.dataset.mode === mode) {
                    item.classList.add('active');
                }
            });
        }

        // Set up builder switch confirm button
        document.addEventListener('DOMContentLoaded', function() {
            const confirmBtn = document.getElementById('builderSwitchConfirmBtn');
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmBuilderSwitch);
            }
        });

        // Close modal when clicking overlay
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('builderSwitchModal');
            if (e.target === modal) {
                closeBuilderSwitchModal();
            }
        });

        // Set up delete chat confirm button
        document.addEventListener('DOMContentLoaded', function() {
            const deleteConfirmBtn = document.getElementById('deleteChatConfirmBtn');
            if (deleteConfirmBtn) {
                deleteConfirmBtn.addEventListener('click', confirmDeleteChat);
            }
        });

        // Close delete chat modal when clicking overlay
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('deleteChatModal');
            if (e.target === modal) {
                closeDeleteChatModal();
            }
        });

        // Close builder dropdown when clicking outside
        document.addEventListener('click', function(e) {
            const dropdown = document.getElementById('builderModelDropdown');
            const selector = document.getElementById('builderModelSelector');
            if (dropdown && selector && !selector.contains(e.target) && !dropdown.contains(e.target)) {
                closeBuilderModelDropdown();
            }
        });

        function useBuilderStarter(prefix) {
            const builderInput = document.getElementById('builderInput');
            if (builderInput) {
                builderInput.value = prefix + ' ';
                builderInput.focus();
                // Move cursor to end
                builderInput.selectionStart = builderInput.selectionEnd = builderInput.value.length;
            }
        }

        function sendBuilderMessage() {
            const builderInput = document.getElementById('builderInput');
            const builderMessages = document.getElementById('builderMessages');
            const message = builderInput?.value.trim();

            if (!message || builderState.isLoading) return;

            builderState.isLoading = true;
            builderInput.value = '';

            // Add user message
            const userMsgHtml = `
                <div class="builder-message user">
                    <div class="builder-message-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="18" height="18">
                            <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/>
                            <circle cx="12" cy="7" r="4"/>
                        </svg>
                    </div>
                    <div class="builder-message-content">${escapeHtml(message)}</div>
                </div>
            `;
            builderMessages.insertAdjacentHTML('beforeend', userMsgHtml);
            builderMessages.scrollTop = builderMessages.scrollHeight;

            builderState.messages.push({ role: 'user', content: message });

            // Show typing indicator
            const typingHtml = `
                <div class="builder-message assistant" id="builderTyping">
                    <div class="builder-message-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                        </svg>
                    </div>
                    <div class="builder-message-content">
                        <div class="typing-indicator"><span></span><span></span><span></span></div>
                    </div>
                </div>
            `;
            builderMessages.insertAdjacentHTML('beforeend', typingHtml);
            builderMessages.scrollTop = builderMessages.scrollHeight;

            // Simulate AI response (in production, this would call the API)
            setTimeout(() => {
                processBuilderResponse(message);
            }, 1500);
        }

        function processBuilderResponse(userMessage) {
            const builderMessages = document.getElementById('builderMessages');
            const typingEl = document.getElementById('builderTyping');
            if (typingEl) typingEl.remove();

            // Generate contextual response based on the conversation stage
            let response = '';
            let showSpec = false;

            if (builderState.messages.length === 1) {
                // First message - acknowledge and ask clarifying questions
                builderState.spec.description = userMessage;

                // Extract app name from message
                const nameMatch = userMessage.match(/(?:app|tool|thing) (?:that |for |to )?(.+?)(?:\.|,|$)/i);
                if (nameMatch) {
                    const extracted = nameMatch[1].trim();
                    builderState.spec.name = extracted.length > 30 ? extracted.substring(0, 30) + '...' : extracted;
                }

                response = `Great idea! Let me understand this better:\n\n**What you described:** ${userMessage.substring(0, 100)}${userMessage.length > 100 ? '...' : ''}\n\nA few questions to nail down the details:\n\n1. **Who is this for?** (yourself, a team, public users?)\n2. **What's the most important feature?**\n3. **Should it work offline?**`;
                showSpec = true;
            } else if (builderState.messages.length === 2) {
                // Second message - extract features
                builderState.spec.features = [
                    'Core functionality based on your description',
                    'Clean, intuitive interface',
                    'Data persistence'
                ];

                // Add user-mentioned features
                if (userMessage.toLowerCase().includes('offline')) {
                    builderState.spec.features.push('Offline support');
                }
                if (userMessage.toLowerCase().includes('team') || userMessage.toLowerCase().includes('share')) {
                    builderState.spec.features.push('Sharing & collaboration');
                    builderState.spec.cost = 75;
                }

                response = `Perfect! I'm building out the spec now. Here's what I'm thinking:\n\n**Features I'll include:**\n${builderState.spec.features.map(f => `- ${f}`).join('\n')}\n\nDoes this capture what you need? Or would you like to add/change anything?`;
                showSpec = true;
            } else {
                // Further refinements
                if (userMessage.toLowerCase().includes('add') || userMessage.toLowerCase().includes('also')) {
                    const newFeature = userMessage.replace(/^(add|also|and|include|i want|i need)\s*/i, '').trim();
                    if (newFeature && newFeature.length > 3) {
                        builderState.spec.features.push(newFeature.charAt(0).toUpperCase() + newFeature.slice(1));
                        builderState.spec.cost += 10;
                    }
                    response = `Added! Your updated spec is ready. Check the card on the right - when you're happy with it, hit "Request Build" to submit.`;
                } else if (userMessage.toLowerCase().includes('look') || userMessage.toLowerCase().includes('good') || userMessage.toLowerCase().includes('yes') || userMessage.toLowerCase().includes('perfect')) {
                    response = `Awesome! Your app spec is ready to go. Click **"Request Build"** to submit it to our build queue. It'll be reviewed and built within 24 hours typically.\n\nOnce it's ready, you'll be able to:\n- Use it immediately\n- Make it public or keep it private\n- Earn credits if others use it`;
                } else {
                    response = `Got it! I've updated the spec. Take a look at the card and let me know if it looks right, or tell me what else to change.`;
                }
                showSpec = true;
            }

            builderState.messages.push({ role: 'assistant', content: response });

            // Add assistant message
            const assistantMsgHtml = `
                <div class="builder-message assistant">
                    <div class="builder-message-avatar">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                            <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                        </svg>
                    </div>
                    <div class="builder-message-content">${formatBuilderMessage(response)}</div>
                </div>
            `;
            builderMessages.insertAdjacentHTML('beforeend', assistantMsgHtml);
            builderMessages.scrollTop = builderMessages.scrollHeight;

            // Show spec panel if needed
            if (showSpec) {
                updateBuilderSpec();
                const specPanel = document.getElementById('builderSpecPanel');
                if (specPanel) specPanel.classList.add('active');
            }

            builderState.isLoading = false;
        }

        function formatBuilderMessage(text) {
            // Convert markdown-like formatting
            return text
                .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                .replace(/\n/g, '<br>')
                .replace(/- (.+)/g, '<span style="display:block;padding-left:16px;"> $1</span>');
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function updateBuilderSpec() {
            const titleEl = document.getElementById('specCardTitle');
            const statusEl = document.getElementById('specCardStatus');
            const descEl = document.querySelector('#specDescription .spec-value');
            const featuresEl = document.querySelector('#specFeatures .spec-features-list');
            const costEl = document.getElementById('specCost');

            if (titleEl) titleEl.textContent = builderState.spec.name || 'Your App';
            if (statusEl) statusEl.textContent = builderState.messages.length > 2 ? 'Ready to build' : 'Defining...';

            if (descEl) {
                descEl.textContent = builderState.spec.description || 'Describe your idea to get started';
                descEl.classList.toggle('spec-placeholder', !builderState.spec.description);
            }

            if (featuresEl) {
                if (builderState.spec.features.length > 0) {
                    featuresEl.innerHTML = builderState.spec.features
                        .map(f => `<div class="spec-feature-item">${f}</div>`)
                        .join('');
                } else {
                    featuresEl.innerHTML = '<div class="spec-feature-item spec-placeholder">Features will appear here</div>';
                }
            }

            if (costEl) {
                costEl.textContent = `${builderState.spec.cost} credits`;
            }

            // Update action button cost
            const actionCost = document.querySelector('.spec-action-cost');
            if (actionCost) actionCost.textContent = `${builderState.spec.cost} credits`;
        }

        function refineSpec() {
            const builderInput = document.getElementById('builderInput');
            if (builderInput) {
                builderInput.value = 'I want to change ';
                builderInput.focus();
                builderInput.selectionStart = builderInput.selectionEnd = builderInput.value.length;
            }
        }

        function submitBuildRequest() {
            // In production, this would submit to the backend
            alert(`Build request submitted!\n\nApp: ${builderState.spec.name}\nCost: ${builderState.spec.cost} credits\n\nYou'll be notified when your app is ready (typically within 24 hours).`);

            // Reset and close
            builderState = {
                messages: [],
                spec: { name: 'Your App', description: '', features: [], cost: 50 },
                isLoading: false
            };

            // Reset UI
            const builderMessages = document.getElementById('builderMessages');
            const specPanel = document.getElementById('builderSpecPanel');

            if (specPanel) specPanel.classList.remove('active');

            // Reset to welcome message
            if (builderMessages) {
                builderMessages.innerHTML = `
                    <div class="builder-message assistant">
                        <div class="builder-message-avatar">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20">
                                <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                            </svg>
                        </div>
                        <div class="builder-message-content">
                            <p class="builder-welcome-text">Build request submitted! Want to create something else?</p>
                            <div class="builder-starter-prompts">
                                <button class="builder-starter-chip" onclick="useBuilderStarter('I want to build an app that')">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <rect x="3" y="3" width="18" height="18" rx="2"/>
                                            <path d="M12 8v8M8 12h8"/>
                                        </svg>
                                    </span>
                                    Build another app
                                </button>
                                <button class="builder-starter-chip" onclick="exitBuilderMode()">
                                    <span class="starter-icon">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                                            <path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/>
                                            <polyline points="16 17 21 12 16 7"/>
                                            <line x1="21" y1="12" x2="9" y2="12"/>
                                        </svg>
                                    </span>
                                    Back to chat
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // Builder input auto-resize and enter to send
        document.addEventListener('DOMContentLoaded', () => {
            const builderInput = document.getElementById('builderInput');
            if (builderInput) {
                builderInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 150) + 'px';
                });

                builderInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendBuilderMessage();
                    }
                });
            }
        });

        // Initialize model selector
        document.addEventListener('DOMContentLoaded', () => {
            const modelSelector = document.getElementById('modelSelector');
            const modelDropdown = document.getElementById('modelDropdown');

            if (modelSelector) {
                modelSelector.addEventListener('click', toggleModelDropdown);
            }

            // Add click handlers to mode items
            if (modelDropdown) {
                modelDropdown.querySelectorAll('.model-dropdown-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const mode = item.dataset.mode;
                        const modeName = item.dataset.name;
                        // Remove active from all items
                        modelDropdown.querySelectorAll('.model-dropdown-item').forEach(i => i.classList.remove('active'));
                        item.classList.add('active');
                        selectMode(mode, modeName);
                    });
                });

                // Tab switching
                modelDropdown.querySelectorAll('.model-dropdown-tab').forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const tabName = tab.dataset.tab;
                        // Update tab active state
                        modelDropdown.querySelectorAll('.model-dropdown-tab').forEach(t => t.classList.remove('active'));
                        tab.classList.add('active');
                        // Update panel visibility
                        modelDropdown.querySelectorAll('.model-dropdown-panel').forEach(p => p.classList.remove('active'));
                        const panel = modelDropdown.querySelector(`[data-panel="${tabName}"]`);
                        if (panel) panel.classList.add('active');
                    });
                });
            }
        });

        // Close model dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const selector = document.getElementById('modelSelector');
            const dropdown = document.getElementById('modelDropdown');
            if (selector && dropdown && !selector.contains(e.target) && !dropdown.contains(e.target)) {
                closeModelDropdown();
            }
        });

        // ========================
        // PROFILE DROPDOWN
        // ========================
        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown.classList.toggle('active');
        }

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            if (dropdown) dropdown.classList.remove('active');
            // Reset to main view when closing
            showMainView();
        }

        function showMainView() {
            document.getElementById('profileMainView').style.display = 'block';
            document.getElementById('profileSettingsView').style.display = 'none';
            const aiView = document.getElementById('profileAIDashboardView');
            if (aiView) aiView.style.display = 'none';
        }

        function showSettingsView() {
            document.getElementById('profileMainView').style.display = 'none';
            document.getElementById('profileSettingsView').style.display = 'block';
            const aiView = document.getElementById('profileAIDashboardView');
            if (aiView) aiView.style.display = 'none';
        }

        // AI Notifications Settings functions
        let aiSettingsCache = null;

        function showAIDashboardView() {
            document.getElementById('profileMainView').style.display = 'none';
            document.getElementById('profileSettingsView').style.display = 'none';
            document.getElementById('profileAIDashboardView').style.display = 'block';

            // Load current settings
            loadAISettings();
        }

        async function loadAISettings() {
            const cloudSyncToggle = document.getElementById('aiSettingCloudSync');
            const insightsToggle = document.getElementById('aiSettingInsights');
            const notificationsSelect = document.getElementById('aiSettingNotifications');
            const appsSection = document.getElementById('aiAppsSection');

            // Check if user is logged in
            if (!currentUser) {
                cloudSyncToggle.disabled = true;
                insightsToggle.disabled = true;
                notificationsSelect.disabled = true;
                return;
            }

            cloudSyncToggle.disabled = false;
            insightsToggle.disabled = false;
            notificationsSelect.disabled = false;

            try {
                const { data, error } = await supabase
                    .from('user_ai_settings')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .single();

                if (data) {
                    aiSettingsCache = data;
                    cloudSyncToggle.checked = data.data_sync_enabled || false;
                    insightsToggle.checked = data.ai_insights_enabled || false;
                    notificationsSelect.value = data.notification_frequency || 'never';

                    // Show apps section if insights enabled
                    if (data.ai_insights_enabled) {
                        appsSection.style.display = 'block';
                        renderAppsCheckboxes(data.apps_included || []);
                    }
                }
            } catch (e) {
                console.warn('Could not load AI settings:', e.message);
            }
        }

        async function toggleAISetting(setting, value) {
            if (!currentUser) {
                showToast('Please sign in to enable this feature');
                return;
            }

            try {
                // Upsert the setting
                const updateData = { [setting]: value };
                updateData.user_id = currentUser.id;
                updateData.updated_at = new Date().toISOString();

                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert(updateData, { onConflict: 'user_id' });

                if (error) throw error;

                // Update cache
                if (aiSettingsCache) {
                    aiSettingsCache[setting] = value;
                }

                // Show/hide apps section when insights toggled
                if (setting === 'ai_insights_enabled') {
                    const appsSection = document.getElementById('aiAppsSection');
                    if (value) {
                        appsSection.style.display = 'block';
                        renderAppsCheckboxes(aiSettingsCache?.apps_included || []);
                    } else {
                        appsSection.style.display = 'none';
                    }
                }

                showToast(value ? 'Setting enabled' : 'Setting disabled');
            } catch (e) {
                console.error('Failed to update setting:', e);
                showToast('Failed to update setting');
            }
        }

        async function updateNotificationFrequency(value) {
            if (!currentUser) return;

            try {
                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert({
                        user_id: currentUser.id,
                        notification_frequency: value,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;
                showToast(`Notifications set to ${value}`);
            } catch (e) {
                console.error('Failed to update notification frequency:', e);
            }
        }

        function renderAppsCheckboxes(includedApps) {
            const container = document.getElementById('aiAppsCheckboxes');
            if (!container) return;

            // Apps that support data sync
            const syncableApps = ['hydrotrack', 'moodlog', 'sleepwell', 'foodvitals'];

            container.innerHTML = '';

            syncableApps.forEach(appKey => {
                const app = SUITE_APPS[appKey];
                if (!app) return;

                const isChecked = includedApps.includes(appKey);
                const checkbox = document.createElement('label');
                checkbox.className = 'ai-apps-checkbox';
                checkbox.innerHTML = `
                    <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleAppAccess('${appKey}', this.checked)">
                    <span>${app.name}</span>
                `;
                container.appendChild(checkbox);
            });
        }

        async function toggleAppAccess(appKey, include) {
            if (!currentUser || !aiSettingsCache) return;

            let apps = aiSettingsCache.apps_included || [];

            if (include && !apps.includes(appKey)) {
                apps.push(appKey);
            } else if (!include) {
                apps = apps.filter(a => a !== appKey);
            }

            try {
                const { error } = await supabase
                    .from('user_ai_settings')
                    .upsert({
                        user_id: currentUser.id,
                        apps_included: apps,
                        updated_at: new Date().toISOString()
                    }, { onConflict: 'user_id' });

                if (error) throw error;

                aiSettingsCache.apps_included = apps;
            } catch (e) {
                console.error('Failed to update app access:', e);
            }
        }

        // Learn View functions
        function openLearnView() {
            // Close builder mode if open
            exitBuilderMode();

            // Close the dropdown
            closeProfileDropdown();

            // Get elements
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const appsView = document.getElementById('appsView');
            const creatorDashboard = document.getElementById('creatorDashboard');
            const factoryView = document.getElementById('factoryView');
            const learnView = document.getElementById('learnView');
            const chatArea = document.querySelector('.chat-area');

            // Hide all other views
            if (welcomeState) welcomeState.style.display = 'none';
            if (useCasesSection) useCasesSection.style.display = 'none';
            if (appsView) appsView.classList.remove('active');
            if (creatorDashboard) creatorDashboard.classList.remove('active');
            if (factoryView) factoryView.classList.remove('active');

            // Show learn view
            if (learnView) learnView.classList.add('active');

            // Scroll to top
            if (chatArea) chatArea.scrollTop = 0;
        }

        function closeLearnView() {
            const welcomeState = document.getElementById('welcomeState');
            const useCasesSection = document.getElementById('useCasesSection');
            const learnView = document.getElementById('learnView');

            // Hide learn view
            if (learnView) learnView.classList.remove('active');

            // Show welcome state
            if (welcomeState) welcomeState.style.display = '';
            if (useCasesSection) useCasesSection.style.display = '';

            // Also hide article reader if open
            hideArticle();
        }

        // Article content database
        const articleContent = {
            'fitness': `
                <h1>5 Best Free AI Fitness Apps (2026)</h1>
                <div class="article-meta-info">
                    <span>January 26, 2026</span>
                    <span>5 min read</span>
                </div>

                <div class="article-highlight">
                    <p>Looking for AI fitness apps that actually work  and don't charge you $15/month? We built them. Here are the 5 best free AI fitness apps on SUITE, no ads, no subscriptions, no catch.</p>
                </div>

                <p>The fitness app market is crowded with subscription-heavy apps that promise the world but charge monthly fees that add up fast. At SUITE, we believe everyone deserves access to AI-powered health tools  which is why every app here is completely free to use.</p>

                <h2>1. TrueForm AI  Posture & Movement Analysis</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/trueform-icon.jpg" class="app-icon-img" alt="TrueForm AI"> TrueForm AI</h3>
                    <p>Fix your form, prevent injuries, and move better with real-time AI feedback. TrueForm analyzes your posture and movement patterns, providing personalized exercises to correct imbalances.</p>
                    <ul>
                        <li>Real-time posture analysis</li>
                        <li>Personalized corrective exercises</li>
                        <li>Injury prevention insights</li>
                    </ul>
                </div>

                <h2>2. OpticRep  AI Rep Counter</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/opticrep-icon.jpg" class="app-icon-img" alt="OpticRep"> OpticRep</h3>
                    <p>Count your workout reps automatically with AI. OpticRep uses your camera to track exercises and count reps in real-time  no manual counting, no losing track mid-set.</p>
                    <ul>
                        <li>Automatic rep counting via camera</li>
                        <li>Multiple exercise recognition</li>
                        <li>Workout history tracking</li>
                    </ul>
                </div>

                <h2>3. FoodVitals  Smart Nutrition Tracking</h2>
                <div class="app-feature-card">
                    <h3><img src="/assets/icons/foodvitals-icon.jpg" class="app-icon-img" alt="FoodVitals"> FoodVitals</h3>
                    <p>Track your nutrition the smart way with AI. Snap a photo of your meal and FoodVitals identifies ingredients, estimates portions, and logs your macros automatically.</p>
                    <ul>
                        <li>AI-powered food recognition</li>
                        <li>Automatic macro calculation</li>
                        <li>Personalized nutrition insights</li>
                    </ul>
                </div>

                <h2>4. HydroTrack  AI Water Tracking</h2>
                <div class="app-feature-card">
                    <h3>HydroTrack</h3>
                    <p>Stop guessing how much water you need. HydroTrack uses AI to calculate your optimal daily intake based on your weight, activity level, and climate. Get smart reminders throughout the day.</p>
                    <ul>
                        <li>Personalized hydration goals</li>
                        <li>Smart reminder scheduling</li>
                        <li>Progress tracking with streaks</li>
                    </ul>
                </div>

                <h2>5. SleepWell  AI Sleep Analysis</h2>
                <div class="app-feature-card">
                    <h3>SleepWell</h3>
                    <p>Track your sleep patterns and get AI-powered insights to improve your rest. SleepWell analyzes your habits and provides personalized recommendations for better sleep quality.</p>
                    <ul>
                        <li>Sleep quality scoring</li>
                        <li>Pattern analysis</li>
                        <li>Personalized sleep tips</li>
                    </ul>
                </div>

                <h2>Why These Apps Are Free</h2>
                <p>SUITE is a nonprofit platform. We believe AI tools should be accessible to everyone, not locked behind paywalls. Our apps are funded by optional yield deposits  users who deposit crypto earn yield, and a portion supports the platform. But you never have to pay to use the apps.</p>

                <div class="cta-section">
                    <h3>Ready to Level Up Your Fitness?</h3>
                    <p>Try any of these apps right now  just ask SuiteGPT to open them for you.</p>
                    <a href="#" class="cta-button" onclick="hideArticle(); closeLearnView(); return false;">Open SuiteGPT</a>
                </div>
            `,
            'ai-fleet': `
                <h1>The AI Fleet: Apps That Build Themselves</h1>
                <div class="article-meta-info">
                    <span>January 15, 2026</span>
                    <span>6 min read</span>
                </div>

                <div class="article-highlight">
                    <p>Every day, our AI builds a new app. Stake to keep it alive. Earn from its success. This is inside-out UBI.</p>
                </div>

                <h2>What is the AI Fleet?</h2>
                <p>The AI Fleet is SUITE's autonomous app factory. Every single day, our AI agents create a brand new app  designed, coded, and deployed without human intervention. These apps range from productivity tools to health trackers to creative utilities.</p>

                <p>But here's where it gets interesting: the apps don't just exist in a vacuum. They need community support to survive.</p>

                <h2>How It Works</h2>
                <p>When the AI creates an app, it enters a 7-day trial period. During this time, users can:</p>
                <ul>
                    <li><strong>Use the app</strong>  Try it out, see if it solves a real problem</li>
                    <li><strong>Stake on it</strong>  Commit credits to show you believe in the app</li>
                    <li><strong>Provide feedback</strong>  Help the AI improve future versions</li>
                </ul>

                <p>Apps that reach their stake threshold graduate to the permanent fleet. Apps that don't? They're retired, but the AI learns from what didn't work.</p>

                <h2>Earn From Success</h2>
                <p>When you stake on an app early and it succeeds, you earn a portion of the app's future revenue. It's like being an early investor, but with time instead of money. The more the app is used, the more everyone who believed in it earns.</p>

                <h2>Inside-Out UBI</h2>
                <p>Traditional UBI proposals give everyone money from a central fund. The AI Fleet does the opposite  it creates value from nothing (AI-generated apps), and distributes that value to everyone who participates.</p>

                <p>You don't need capital to earn. You need attention and good judgment. Find apps that will succeed, stake early, and earn.</p>

                <div class="cta-section">
                    <h3>Explore the Fleet</h3>
                    <p>See today's AI-generated apps and stake on your favorites.</p>
                    <a href="factory.html" class="cta-button">Visit the Factory</a>
                </div>
            `,
            'yield': `
                <h1>The Yield-Powered App: Free to Use, Paid by DeFi</h1>
                <div class="article-meta-info">
                    <span>January 13, 2026</span>
                    <span>5 min read</span>
                </div>

                <div class="article-highlight">
                    <p>How we killed the monthly subscription. Your deposit generates yield that pays for AI  forever.</p>
                </div>

                <h2>The Problem with Subscriptions</h2>
                <p>Every AI tool wants $20/month. ChatGPT, Notion AI, Grammarly, fitness apps  the subscriptions add up fast. For many people around the world, these costs are simply unaffordable.</p>

                <p>We asked ourselves: what if there was a way to make AI free without ads, without data selling, without compromises?</p>

                <h2>The Yield-Powered Model</h2>
                <p>Here's how it works:</p>
                <ol>
                    <li><strong>You deposit crypto</strong> into your SUITE vault</li>
                    <li><strong>Your deposit earns yield</strong> through DeFi protocols</li>
                    <li><strong>A portion of the yield</strong> pays for your AI usage</li>
                    <li><strong>You keep your deposit</strong>  it's always yours to withdraw</li>
                </ol>

                <p>Your money stays your money. The yield it generates pays for the service. It's like having a savings account that pays your bills.</p>

                <h2>Why This Works</h2>
                <p>DeFi yields typically range from 3-10% APY. Even a modest deposit can generate enough yield to cover extensive AI usage. And because the principal is never spent, you can use SUITE indefinitely.</p>

                <h2>No Deposit? No Problem</h2>
                <p>You can always use SUITE apps without any deposit. You get free credits just for signing up, and you can earn more through community activities. The vault is an option for power users who want unlimited usage.</p>

                <div class="cta-section">
                    <h3>Learn More About the Vault</h3>
                    <p>See how yield-powered apps can work for you.</p>
                    <a href="docs/vault.html" class="cta-button">Read the Docs</a>
                </div>
            `
        };

        function showArticle(articleId) {
            const articlesGrid = document.getElementById('learnArticlesGrid');
            const articleReader = document.getElementById('learnArticleReader');
            const articleContentEl = document.getElementById('learnArticleContent');
            const learnView = document.getElementById('learnView');

            if (!articleContent[articleId]) {
                console.error('Article not found:', articleId);
                return;
            }

            // Hide the articles grid
            if (articlesGrid) articlesGrid.style.display = 'none';

            // Show the article reader
            if (articleReader) articleReader.style.display = 'block';

            // Load the article content
            if (articleContentEl) articleContentEl.innerHTML = articleContent[articleId];

            // Scroll to top of learn view
            if (learnView) learnView.scrollTop = 0;
        }

        function hideArticle() {
            const articlesGrid = document.getElementById('learnArticlesGrid');
            const articleReader = document.getElementById('learnArticleReader');
            const articleContentEl = document.getElementById('learnArticleContent');
            const learnView = document.getElementById('learnView');

            // Show the articles grid
            if (articlesGrid) articlesGrid.style.display = '';

            // Hide the article reader
            if (articleReader) articleReader.style.display = 'none';

            // Clear the content
            if (articleContentEl) articleContentEl.innerHTML = '';

            // Scroll to top
            if (learnView) learnView.scrollTop = 0;
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const profile = document.getElementById('sidebarProfile');
            const dropdown = document.getElementById('profileDropdown');
            if (profile && dropdown && !profile.contains(e.target) && !dropdown.contains(e.target)) {
                closeProfileDropdown();
            }
        });

        function openSettings() {
            closeProfileDropdown();
            // TODO: Open settings panel
            alert('Settings coming soon!');
        }

        async function logout() {
            closeProfileDropdown();

            // Clear localStorage auth
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('walletAddress');
            localStorage.removeItem('suiteWalletAddress');
            localStorage.removeItem('suiteWallet');
            localStorage.removeItem('telegram_user');

            // Sign out of Supabase (Google/Email)
            if (supabaseClient) {
                try {
                    await supabaseClient.auth.signOut();
                } catch (err) {
                    console.error('Supabase signout error:', err);
                }
            }

            await checkAuthState();
            location.reload();
        }

        // ========================
        // ADD TO HOME SCREEN (PWA)
        // ========================
        let deferredPrompt = null;

        // Check if running as PWA or dismissed
        function checkAddToHomeVisibility() {
            const btn = document.getElementById('addToHomeBtn');
            if (!btn) return;

            // Hide if already running as PWA
            const isStandalone = window.matchMedia('(display-mode: standalone)').matches
                || window.navigator.standalone === true;

            // Hide if user dismissed it
            const dismissed = localStorage.getItem('addToHomeDismissed');

            // Hide if already installed (no prompt available and not iOS)
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isStandalone || dismissed) {
                btn.classList.remove('visible');
                btn.classList.add('hidden');
            } else {
                btn.classList.remove('hidden');
                btn.classList.add('visible');
            }
        }

        // Capture the install prompt
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            checkAddToHomeVisibility();
        });

        // Handle add to home click
        function handleAddToHome() {
            const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);

            if (isIOS) {
                // Show iOS instructions
                alert('To add SuiteGPT to your home screen:\n\n1. Tap the Share button (square with arrow)\n2. Scroll down and tap "Add to Home Screen"\n3. Tap "Add" to confirm');
                return;
            }

            if (deferredPrompt) {
                // Show the install prompt
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                        const btn = document.getElementById('addToHomeBtn');
                        if (btn) btn.classList.add('hidden');
                    }
                    deferredPrompt = null;
                });
            } else {
                // Fallback for browsers that don't support beforeinstallprompt
                alert('To add SuiteGPT to your home screen, use your browser\'s menu and look for "Add to Home Screen" or "Install App" option.');
            }
        }

        // Dismiss the button
        function dismissAddToHome() {
            localStorage.setItem('addToHomeDismissed', 'true');
            const btn = document.getElementById('addToHomeBtn');
            if (btn) {
                btn.classList.remove('visible');
                btn.classList.add('hidden');
            }
        }

        // Listen for app installed
        window.addEventListener('appinstalled', () => {
            console.log('SuiteGPT was installed');
            const btn = document.getElementById('addToHomeBtn');
            if (btn) btn.classList.add('hidden');
            deferredPrompt = null;
        });

        // Check visibility on load
        document.addEventListener('DOMContentLoaded', checkAddToHomeVisibility);

        // ========================
        // UPGRADE MODAL
        // ========================
        function openUpgradeModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('upgradeModalOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeUpgradeModal() {
            const overlay = document.getElementById('upgradeModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchUpgradeTab(tab) {
            const tabs = document.querySelectorAll('.upgrade-tab');
            const subscriptionSection = document.getElementById('subscriptionSection');
            const creditsSection = document.getElementById('creditsSection');

            tabs.forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            if (tab === 'subscription') {
                subscriptionSection.classList.add('active');
                creditsSection.classList.remove('active');
            } else {
                subscriptionSection.classList.remove('active');
                creditsSection.classList.add('active');
            }
        }

        function selectPlan(plan) {
            closeUpgradeModal();
            // TODO: Integrate with payment provider (Stripe, etc.)
            alert(`Selected ${plan} plan! Payment integration coming soon.`);
        }

        function selectCreditPack(credits) {
            closeUpgradeModal();
            // TODO: Integrate with payment provider
            alert(`Selected ${credits} credits! Payment integration coming soon.`);
        }

        // ========================
        // CREDITS MODAL
        // ========================
        function openCreditsModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('creditsModalOverlay');
            const amountEl = document.getElementById('creditsModalAmount');

            // Update modal with current credits
            if (amountEl) {
                amountEl.textContent = userCredits.toLocaleString();
            }

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            updateCreditsRewardsStatus();
        }

        async function updateCreditsRewardsStatus() {
            const statusEl = document.getElementById('creditsRewardsStatus');
            const titleEl = document.getElementById('creditsRewardsTitle');
            const subEl = document.getElementById('creditsRewardsSub');
            const actionArea = document.getElementById('creditsRewardsActionArea');
            const earnedRow = document.getElementById('creditsRewardsEarned');
            const earnedAmt = document.getElementById('creditsRewardsEarnedAmt');
            if (!statusEl) return;

            const wallet = localStorage.getItem('connectedWallet');

            if (!wallet) {
                statusEl.className = 'credits-rewards-status not-earning';
                titleEl.textContent = 'Earning rewards: OFF';
                subEl.innerHTML = 'Connect a wallet to start earning USDC from the reward pool';
                actionArea.innerHTML = '<span class="credits-rewards-nowallet"><a href="#" onclick="event.preventDefault(); closeCreditsModal(); connectWallet();">Link wallet</a></span>';
                earnedRow.style.display = 'none';
                return;
            }

            try {
                const provider = new ethers.JsonRpcProvider('https://mainnet.base.org');
                const rewardsContract = new ethers.Contract(STAKING_REWARDS_ADDRESS, STAKING_REWARDS_ABI, provider);
                const stakingContract = new ethers.Contract(SUITE_STAKING_ADDRESS, [
                    'function stakedBalance(address) view returns (uint256)',
                    'function totalCredits(address) view returns (uint256)'
                ], provider);

                const [stakedBal, earned] = await Promise.all([
                    stakingContract.stakedBalance(wallet),
                    rewardsContract.earned(wallet)
                ]);

                const stakedNum = parseFloat(ethers.formatUnits(stakedBal, 18));
                const earnedNum = parseFloat(ethers.formatUnits(earned, 6));

                if (stakedNum > 0) {
                    statusEl.className = 'credits-rewards-status earning';
                    titleEl.textContent = 'Earning rewards: ON';
                    subEl.innerHTML = '<strong>' + stakedNum.toLocaleString() + '</strong> credits staked on-chain';
                    actionArea.innerHTML = '<button class="credits-rewards-action withdraw-suite" onclick="closeCreditsModal(); withdrawSuiteTokens();">Withdraw as SUITE</button>';
                    earnedRow.style.display = 'flex';
                    earnedAmt.textContent = '$' + earnedNum.toFixed(earnedNum < 0.01 ? 4 : 2);
                } else {
                    statusEl.className = 'credits-rewards-status not-earning';
                    titleEl.textContent = 'Earning rewards: OFF';
                    subEl.innerHTML = 'Your credits are not staked on-chain yet';
                    actionArea.innerHTML = '<button class="credits-rewards-action enable-rewards" onclick="closeCreditsModal(); enableCreditRewards();">Enable rewards</button>';
                    earnedRow.style.display = earnedNum > 0 ? 'flex' : 'none';
                    if (earnedNum > 0) earnedAmt.textContent = '$' + earnedNum.toFixed(earnedNum < 0.01 ? 4 : 2);
                }
            } catch (err) {
                console.error('Failed to check rewards status:', err);
                statusEl.className = 'credits-rewards-status not-earning';
                titleEl.textContent = 'Earning rewards';
                subEl.innerHTML = 'Unable to check on-chain status';
                actionArea.innerHTML = '';
                earnedRow.style.display = 'none';
            }
        }

        async function withdrawSuiteTokens() {
            try {
                if (!window.ethereum) {
                    alert('Please install MetaMask or another wallet to withdraw.');
                    return;
                }
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const stakingContract = new ethers.Contract(SUITE_STAKING_ADDRESS, [
                    'function stakedBalance(address) view returns (uint256)',
                    'function unstake(uint256) external'
                ], signer);

                const wallet = await signer.getAddress();
                const staked = await stakingContract.stakedBalance(wallet);
                if (staked === 0n) {
                    alert('No SUITE tokens staked to withdraw.');
                    return;
                }

                const stakedDisplay = parseFloat(ethers.formatUnits(staked, 18)).toLocaleString();
                if (!confirm('Withdraw ' + stakedDisplay + ' SUITE tokens to your wallet?\n\nYou will stop earning USDC rewards while unstaked.')) return;

                const tx = await stakingContract.unstake(staked);
                alert('Withdrawal submitted! Waiting for confirmation...');
                await tx.wait();
                alert('SUITE tokens withdrawn to your wallet. You can re-enable rewards anytime.');
            } catch (err) {
                console.error('Withdraw failed:', err);
                if (err.code !== 'ACTION_REJECTED') {
                    alert('Withdrawal failed: ' + (err.reason || err.message));
                }
            }
        }

        async function enableCreditRewards() {
            alert('Coming soon: Your credits will be automatically staked on-chain when you purchase them.\n\nFor now, you can stake SUITE tokens manually if you have them in your wallet.');
        }

        function closeCreditsModal() {
            const overlay = document.getElementById('creditsModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            // Reset expanded state when closing
            const bonusSection = document.getElementById('bonusCreditsSection');
            if (bonusSection) bonusSection.classList.remove('expanded');
        }

        function toggleBonusExplanation() {
            const bonusSection = document.getElementById('bonusCreditsSection');
            if (bonusSection) {
                bonusSection.classList.toggle('expanded');
            }
        }

        // ========================
        // BUY CREDITS MODAL
        // ========================
        function openBuyModal() {
            showBuyMethodState();
            document.getElementById('buyAmount').value = '10';
            document.getElementById('fiatAmount').value = '10';
            updateBuyPreview();
            updateFiatPreview();
            document.getElementById('buyModalOverlay').classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeBuyModal() {
            document.getElementById('buyModalOverlay').classList.remove('active');
            document.body.style.overflow = '';
        }

        function backToCreditsModal() {
            closeBuyModal();
            openCreditsModal();
        }

        function handleBuyModalBack() {
            const methodVisible = document.getElementById('buyMethodState').style.display !== 'none';
            if (methodVisible) {
                backToCreditsModal();
            } else {
                showBuyMethodState();
            }
        }

        function showBuyMethodState() {
            document.getElementById('buyMethodState').style.display = 'block';
            document.getElementById('buyCryptoState').style.display = 'none';
            document.getElementById('buyFiatState').style.display = 'none';
        }

        function showBuyCryptoState() {
            document.getElementById('buyMethodState').style.display = 'none';
            document.getElementById('buyCryptoState').style.display = 'block';
            document.getElementById('buyFiatState').style.display = 'none';
        }

        function showBuyFiatState() {
            document.getElementById('buyMethodState').style.display = 'none';
            document.getElementById('buyCryptoState').style.display = 'none';
            document.getElementById('buyFiatState').style.display = 'block';
            updateFiatPreview();
        }

        function setFiatAmount(amount) {
            document.getElementById('fiatAmount').value = amount;
            document.querySelectorAll('.fiat-amount-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.fiat-amount-btn[data-amount="${amount}"]`)?.classList.add('active');
            updateFiatPreview();
        }

        function updateFiatPreview() {
            const amount = parseFloat(document.getElementById('fiatAmount').value) || 0;
            const credits = amount * CREDITS_PER_USDC;
            document.getElementById('fiatPreviewCredits').textContent = credits.toLocaleString();
            document.getElementById('fiatPayText').textContent = `Pay $${amount} with Card`;
        }

        function updateBuyPreview() {
            const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
            const credits = amount * CREDITS_PER_USDC;
            document.getElementById('buyPreviewCredits').textContent = credits.toLocaleString();
        }

        // Ensure user exists in Supabase before checkout
        async function ensureUserExists(walletAddress) {
            const response = await fetch('/api/ensure-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress })
            });

            const data = await response.json();

            if (!response.ok || data.error) {
                console.error('Failed to ensure user exists:', data.error);
                throw new Error('Failed to set up user account');
            }

            console.log('User ready:', data.created ? 'created new' : 'already exists');
        }

        async function initiateStripeCheckout() {
            const amount = parseFloat(document.getElementById('fiatAmount').value) || 0;
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');

            if (!wallet) {
                showToast('Please connect your wallet first', 'error');
                return;
            }

            if (amount < 1 || amount > 1000) {
                showToast('Amount must be between $1 and $1000', 'error');
                return;
            }

            const btn = document.getElementById('btnFiatPay');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>Setting up...</span>';

            try {
                // Ensure user exists in database before checkout
                await ensureUserExists(wallet);

                btn.innerHTML = '<span>Redirecting to Stripe...</span>';

                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, walletAddress: wallet })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Redirect to Stripe Checkout
                window.location.href = data.url;

            } catch (error) {
                console.error('Stripe checkout error:', error);
                showToast('Failed to start checkout: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        async function executeBuy() {
            const btn = document.getElementById('btnBuyConfirm');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Connecting...';

                // Check network and switch if needed
                await ensureBaseNetwork();

                // Get signer
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();

                const usdcAmount = parseFloat(document.getElementById('buyAmount').value);
                if (!usdcAmount || usdcAmount <= 0) {
                    throw new Error('Please enter a valid amount');
                }

                // USDC has 6 decimals
                const usdcAmountWei = ethers.parseUnits(usdcAmount.toString(), 6);

                // Check USDC balance
                const usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                const balance = await usdcContract.balanceOf(await signer.getAddress());
                if (balance < usdcAmountWei) {
                    throw new Error('Insufficient USDC balance');
                }

                // Check and approve USDC
                btn.textContent = 'Checking approval...';
                const allowance = await usdcContract.allowance(await signer.getAddress(), SUITE_STAKING_ADDRESS);
                if (allowance < usdcAmountWei) {
                    btn.textContent = 'Approving USDC...';
                    const approveTx = await usdcContract.approve(SUITE_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                // Buy and stake
                btn.textContent = 'Buying credits...';
                const stakingContract = new ethers.Contract(SUITE_STAKING_ADDRESS, STAKING_ABI, signer);
                const tx = await stakingContract.buyAndStake(usdcAmountWei);
                await tx.wait();

                // Success
                closeBuyModal();
                showToast('Credits purchased successfully!', 'success');

                // Reload credits
                if (window.refreshNavCredits) window.refreshNavCredits();
                await loadUserCredits();

            } catch (err) {
                console.error('Buy failed:', err);
                showToast(err.message || 'Transaction failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function ensureBaseNetwork() {
            if (!window.ethereum) {
                throw new Error('Please install MetaMask');
            }

            const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
            const chainId = parseInt(chainIdHex, 16);

            if (chainId !== BASE_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x' + BASE_CHAIN_ID.toString(16),
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: [BASE_RPC],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    } else {
                        throw new Error('Please switch to Base network');
                    }
                }
            }
        }

        // Check for payment success on page load
        function checkPaymentStatus() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('payment') === 'success') {
                showToast('Payment successful! Credits added to your account.', 'success');
                window.history.replaceState({}, '', window.location.pathname);
                setTimeout(() => loadUserCredits(), 1000);
            } else if (params.get('payment') === 'cancelled') {
                showToast('Payment was cancelled', 'info');
                window.history.replaceState({}, '', window.location.pathname);
            }
        }

        // ========================
        // SETTINGS MODAL
        // ========================
        function openSettingsModal() {
            const overlay = document.getElementById('settingsModalOverlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeSettingsModal() {
            const overlay = document.getElementById('settingsModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function switchSettingsPanel(panelId) {
            // Update nav items
            document.querySelectorAll('.settings-nav-item').forEach(item => {
                item.classList.toggle('active', item.dataset.panel === panelId);
            });

            // Update panels
            const panelMap = {
                'docs': { id: 'settingsPanelDocs', title: 'Documentation' },
                'learn': { id: 'settingsPanelLearn', title: 'Learn' },
                'community': { id: 'settingsPanelCommunity', title: 'Community Chat' },
                'import': { id: 'settingsPanelImport', title: 'Import History' }
            };

            // Hide all panels
            document.querySelectorAll('.settings-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // Show selected panel
            const panelInfo = panelMap[panelId];
            if (panelInfo) {
                const panel = document.getElementById(panelInfo.id);
                if (panel) panel.classList.add('active');

                const title = document.getElementById('settingsPanelTitle');
                if (title) title.textContent = panelInfo.title;
            }
        }

        function triggerHistoryImport() {
            // Use existing import modal
            const importModal = document.getElementById('importModal');
            if (importModal) {
                importModal.classList.add('active');
                if (typeof resetImportModal === 'function') {
                    resetImportModal();
                }
            }
        }

        // ========================
        // WITHDRAWAL MODAL
        // ========================
        function openWithdrawalModal() {
            closeProfileDropdown();
            const overlay = document.getElementById('withdrawalModalOverlay');
            const amountInput = document.getElementById('withdrawalAmount');

            // Update modal with current credits
            updateCreditsDisplay(userCredits);

            // Clear previous input
            if (amountInput) amountInput.value = '';

            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeWithdrawalModal() {
            const overlay = document.getElementById('withdrawalModalOverlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
        }

        function backToCreditsFromWithdrawal() {
            closeWithdrawalModal();
            openCreditsModal();
        }

        function setMaxWithdrawal() {
            const amountInput = document.getElementById('withdrawalAmount');
            if (amountInput) {
                amountInput.value = userCredits;
            }
        }

        async function submitWithdrawal() {
            const amountInput = document.getElementById('withdrawalAmount');
            const confirmBtn = document.getElementById('withdrawalConfirmBtn');
            const amount = parseInt(amountInput?.value) || 0;

            if (amount <= 0) {
                alert('Please enter a valid amount');
                return;
            }

            if (amount > userCredits) {
                alert('Amount exceeds your available credits');
                return;
            }

            // Get user info
            const wallet = localStorage.getItem('connectedWallet') ||
                          localStorage.getItem('walletAddress') ||
                          localStorage.getItem('suiteWalletAddress') ||
                          localStorage.getItem('suiteWallet');
            const telegramUserStr = localStorage.getItem('telegram_user');
            let telegramUser = null;
            if (telegramUserStr) {
                try {
                    telegramUser = JSON.parse(telegramUserStr);
                } catch (e) {
                    console.error('Failed to parse telegram_user:', e);
                }
            }

            if (!wallet && !telegramUser) {
                alert('Please log in to request a withdrawal');
                return;
            }

            // Disable button while processing
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.textContent = 'Processing...';
            }

            try {
                // Create withdrawal request in Supabase
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/withdrawal_requests`,
                    {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            user_id: telegramUser?.id || wallet,
                            auth_type: telegramUser ? 'telegram' : 'wallet',
                            amount: amount,
                            usd_value: amount / 1000,
                            status: 'pending',
                            requested_at: new Date().toISOString()
                        })
                    }
                );

                if (response.ok) {
                    closeWithdrawalModal();
                    alert(`Withdrawal request for ${amount.toLocaleString()} credits (~$${(amount / 1000).toFixed(2)}) submitted successfully! You'll be notified when funds are available.`);
                } else {
                    throw new Error('Failed to submit withdrawal request');
                }
            } catch (error) {
                console.error('Withdrawal error:', error);
                alert('Failed to submit withdrawal request. Please try again later.');
            } finally {
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirm Withdrawal Request';
                }
            }
        }

        // Initialize Supabase client for Auth (config declared at top of script)
        if (window.supabase) {
            supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            console.log('[Auth] Supabase client created');

            // Check for OAuth callback in URL (code parameter)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.has('code')) {
                console.log('[Auth] OAuth code detected in URL, exchanging...');
            }

            // Listen for auth state changes (handles OAuth redirect)
            supabaseClient.auth.onAuthStateChange(async (event, session) => {
                console.log('[Auth] Supabase event:', event, session ? `has session: ${session.user?.email}` : 'no session');

                if (session) {
                    console.log('[Auth] User authenticated:', session.user?.email);

                    // Store email in localStorage for cross-app auth
                    if (session.user?.email) {
                        localStorage.setItem('user_email', session.user.email);
                    }

                    // Close modal if open
                    const modal = document.getElementById('connectModalOverlay');
                    if (modal && modal.classList.contains('active')) {
                        closeConnectModal();
                    }

                    // Auto-link: If user has wallet, link this email to it
                    const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (wallet && session.user?.email) {
                        await autoLinkEmailToWallet(wallet, session.user.email, session.user.id);
                    }

                    // Always update auth state when we have a session
                    checkAuthState();
                    renderLinkedAccounts();
                    loadUserChats(); // Load user's chat history
                } else if (event === 'SIGNED_OUT') {
                    // Clear email from localStorage
                    localStorage.removeItem('user_email');

                    // Only reset if no other auth methods
                    const hasTelegram = localStorage.getItem('telegram_user');
                    const hasWallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                    if (!hasTelegram && !hasWallet) {
                        checkAuthState();
                    }
                    // Clear chat history on sign out
                    userChats = [];
                    renderChatHistory();
                }
            });

            // Check session on page load (handles OAuth redirect)
            supabaseClient.auth.getSession().then(({ data: { session }, error }) => {
                if (error) {
                    console.error('[Auth] Session check error:', error);
                }
                console.log('[Auth] Explicit session check:', session ? session.user?.email : 'no session');

                // Store email in localStorage for cross-app auth
                if (session?.user?.email) {
                    localStorage.setItem('user_email', session.user.email);
                }

                // Always call checkAuthState after Supabase is ready
                checkAuthState();
                renderLinkedAccounts();
                // Load user's chat history if logged in
                if (session) {
                    loadUserChats();
                }
            });
        } else {
            console.error('[Auth] Supabase library not loaded!');
            // Still check auth state for wallet/telegram users
            checkAuthState();
        }

        // One-time migration: update Vestine's Pet Care app with new design
        (async function migrateVestinePage() {
            const migKey = 'vestine_v4_redesign';
            if (localStorage.getItem(migKey)) return;
            try {
                const session = await supabaseClient?.auth?.getSession();
                if (!session?.data?.session) return;
                const resp = await fetch('/vestine-page.html');
                if (!resp.ok) return;
                const newCode = await resp.text();
                if (!newCode || newCode.length < 500) return;
                const { error } = await supabaseClient
                    .from('user_apps')
                    .update({ code: newCode, icon_bg: 'linear-gradient(160deg, #4A7A5B, #1B3A2D)' })
                    .eq('id', '5ef849de-0e31-48c1-aafc-11ea47de956c');
                if (!error) {
                    localStorage.setItem(migKey, '1');
                    console.log('[Migration] Vestine page updated to v2');
                }
            } catch(e) { console.log('[Migration] Vestine skip:', e); }
        })();

        // DOM Elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');
        const welcomeState = document.getElementById('welcomeState');
        const chatContainer = document.getElementById('chatContainer');
        const chatMessages = document.getElementById('chatMessages');
        const useCasesGrid = document.getElementById('useCasesGrid');
        const useCasesSection = document.getElementById('useCasesSection');
        const useCaseCount = document.getElementById('useCaseCount');

        // Sidebar Elements
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');

        // State
        let isLoading = false;
        let conversationHistory = [];
        let useCases = [];
        let currentIntent = 'all';
        // userCredits is declared earlier near updateCreditsDisplay

        // SuiteGPT Insights State
        let insightsState = {
            isMinimized: false,
            pendingInsights: [],
            shownInsights: [],
            badgeCount: 0,
            suggestedAppKeys: new Set(),
            lastAnalyzedIndex: 0
        };

        // ========================
        // CHAT PERSISTENCE STATE
        // ========================
        let currentChatId = null;
        let userChats = [];
        let chatSaveTimeout = null;

        // ========================
        // CHAT PERSISTENCE FUNCTIONS
        // ========================

        // Generate title from first user message
        function generateChatTitle(message) {
            const maxLength = 40;
            const cleaned = message.replace(/\n/g, ' ').trim();
            if (cleaned.length <= maxLength) return cleaned;
            return cleaned.substring(0, maxLength).trim() + '...';
        }

        // Save current chat to Supabase
        async function saveCurrentChat() {
            if (!supabaseClient) return;

            // Get current user
            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                console.log('[Chat] No user logged in, chat not saved');
                return;
            }

            // Don't save empty chats
            if (conversationHistory.length === 0) return;

            // Collect current insights to save (deduplicated)
            const allInsights = [
                ...insightsState.shownInsights,
                ...insightsState.pendingInsights
            ];
            // Dedupe by type + stringified data
            const seen = new Set();
            const insightsToSave = allInsights.filter(insight => {
                const key = insight.type + JSON.stringify(insight.data);
                if (seen.has(key)) return false;
                seen.add(key);
                return true;
            });

            const chatData = {
                user_id: user.id,
                title: generateChatTitle(conversationHistory[0]?.content || 'New Chat'),
                messages: conversationHistory,
                model: currentModel,
                is_builder: false,
                insights: insightsToSave,
                updated_at: new Date().toISOString()
            };

            try {
                if (currentChatId) {
                    // Update existing chat
                    const { error } = await supabaseClient
                        .from('chats')
                        .update({
                            messages: chatData.messages,
                            model: chatData.model,
                            insights: chatData.insights,
                            updated_at: chatData.updated_at
                        })
                        .eq('id', currentChatId);

                    if (error) throw error;
                    console.log('[Chat] Updated chat:', currentChatId);
                } else {
                    // Create new chat
                    const { data, error } = await supabaseClient
                        .from('chats')
                        .insert(chatData)
                        .select()
                        .single();

                    if (error) throw error;
                    currentChatId = data.id;
                    console.log('[Chat] Created new chat:', currentChatId);

                    // Refresh chat list in sidebar
                    loadUserChats();
                }
            } catch (error) {
                console.error('[Chat] Save error:', error);
            }
        }

        // Debounced save (saves 1 second after last message)
        function scheduleChatSave() {
            if (chatSaveTimeout) clearTimeout(chatSaveTimeout);
            chatSaveTimeout = setTimeout(saveCurrentChat, 1000);
        }

        // Load all chats for current user
        async function loadUserChats() {
            if (!supabaseClient) return;

            const { data: { user } } = await supabaseClient.auth.getUser();
            if (!user) {
                userChats = [];
                renderChatHistory();
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('chats')
                    .select('id, title, model, is_builder, updated_at')
                    .eq('user_id', user.id)
                    .order('updated_at', { ascending: false })
                    .limit(50);

                if (error) throw error;

                userChats = data || [];
                renderChatHistory();
                console.log('[Chat] Loaded', userChats.length, 'chats');
            } catch (error) {
                console.error('[Chat] Load error:', error);
                userChats = [];
                renderChatHistory();
            }
        }

        // Load a specific chat by ID
        async function loadChat(chatId) {
            // Close builder mode if open
            exitBuilderMode();

            if (!supabaseClient) return;

            try {
                const { data, error } = await supabaseClient
                    .from('chats')
                    .select('*')
                    .eq('id', chatId)
                    .single();

                if (error) throw error;

                // Set current chat
                currentChatId = data.id;
                conversationHistory = data.messages || [];
                currentModel = data.model || 'flash';

                // Update model selector display
                const modelNames = {
                    'flash': 'Auto',
                    'pro': 'Gemini 2.0 Pro',
                    'sonnet': 'Claude Sonnet 4',
                    'opus': 'Claude Opus 4',
                    'llama': 'Llama 3.3 70B'
                };
                const nameEl = document.getElementById('modelName');
                if (nameEl) nameEl.textContent = modelNames[currentModel] || 'Auto';

                // Get DOM elements
                const chatMessagesEl = document.getElementById('chatMessages');
                const welcomeStateEl = document.getElementById('welcomeState');
                const chatContainerEl = document.getElementById('chatContainer');
                const useCasesSection = document.getElementById('useCasesSection');

                // Hide all other views (like startNewChat does)
                const appsView = document.getElementById('appsView');
                const creatorDashboard = document.getElementById('creatorDashboard');
                const factoryView = document.getElementById('factoryView');
                const learnView = document.getElementById('learnView');
                const connectionsView = document.getElementById('connectionsView');

                if (appsView) appsView.classList.remove('active');
                if (creatorDashboard) creatorDashboard.classList.remove('active');
                if (factoryView) factoryView.classList.remove('active');
                if (learnView) learnView.classList.remove('active');
                if (connectionsView) connectionsView.classList.remove('active');

                // Hide article reader if open
                if (typeof hideArticle === 'function') hideArticle();

                // Show welcome state (chat area) and hide use cases
                if (welcomeStateEl) {
                    welcomeStateEl.style.display = '';
                    welcomeStateEl.classList.add('chat-active');
                }
                if (useCasesSection) useCasesSection.style.display = 'none';

                // Render messages
                if (chatMessagesEl) chatMessagesEl.innerHTML = '';
                if (chatContainerEl) chatContainerEl.classList.add('active');
                showInsightsPanel();

                conversationHistory.forEach(msg => {
                    addMessageToDOM(msg.content, msg.role);
                });

                // Scroll to bottom
                if (chatContainerEl) {
                    const wrapper = chatContainerEl.querySelector('.chat-messages-wrapper');
                    if (wrapper) wrapper.scrollTop = wrapper.scrollHeight;
                    else chatContainerEl.scrollTop = chatContainerEl.scrollHeight;
                }

                // Restore insights if any were saved with this chat
                clearInsights();
                if (data.insights && data.insights.length > 0) {
                    data.insights.forEach(insight => {
                        addInsight(insight.type, insight.data);
                    });
                    // Show the insights panel
                    const suiteInsights = document.getElementById('suiteInsights');
                    if (suiteInsights) suiteInsights.classList.add('active');
                }

                // Update chat history to show active state
                renderChatHistory();

                // Close sidebar on mobile
                closeMobileSidebar();

                // Update URL
                history.pushState({ view: 'chat', chatId }, '', '/');

                console.log('[Chat] Loaded chat:', chatId);
            } catch (error) {
                console.error('[Chat] Error loading chat:', error);
            }
        }

        // Add message to DOM without saving (used when loading existing chat)
        function addMessageToDOM(content, role) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'user' && userAvatarUrl) {
                avatar.innerHTML = `<img src="${userAvatarUrl}" alt="You" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else if (role === 'user') {
                avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            } else {
                avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = renderMarkdown(content);

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
        }

        // Simple markdown renderer for chat messages
        function renderMarkdown(text) {
            if (!text) return '';

            let html = text
                // Escape HTML first
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                // Code blocks (```)
                .replace(/```(\w*)\n?([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                // Inline code (`)
                .replace(/`([^`]+)`/g, '<code>$1</code>')
                // Bold (**text** or __text__)
                .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
                .replace(/__([^_]+)__/g, '<strong>$1</strong>')
                // Italic (*text* or _text_)
                .replace(/\*([^*]+)\*/g, '<em>$1</em>')
                .replace(/_([^_]+)_/g, '<em>$1</em>')
                // Markdown links [text](url)
                .replace(/\[([^\]]+)\]\((https?:\/\/[^\s)]+)\)/g, '<a href="$2" target="_blank" rel="noopener noreferrer">$1</a>')
                // Headers (## text)
                .replace(/^### (.+)$/gm, '<h4>$1</h4>')
                .replace(/^## (.+)$/gm, '<h3>$1</h3>')
                .replace(/^# (.+)$/gm, '<h2>$1</h2>')
                // Bullet points
                .replace(/^[\-\*] (.+)$/gm, '<li>$1</li>')
                // Numbered lists
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                // Line breaks
                .replace(/\n/g, '<br>');

            // Wrap consecutive <li> in <ul>
            html = html.replace(/(<li>.*?<\/li>)(<br>)?(?=<li>|$)/g, '$1');
            html = html.replace(/(<li>[\s\S]*?<\/li>)+/g, '<ul>$&</ul>');

            return html;
        }

        // Delete chat modal functions
        let pendingDeleteChatId = null;

        function openDeleteChatModal(chatId, event) {
            if (event) event.stopPropagation();
            pendingDeleteChatId = chatId;
            const modal = document.getElementById('deleteChatModal');
            if (modal) modal.classList.add('active');
        }

        function closeDeleteChatModal() {
            const modal = document.getElementById('deleteChatModal');
            if (modal) modal.classList.remove('active');
            pendingDeleteChatId = null;
        }

        async function confirmDeleteChat() {
            if (!pendingDeleteChatId) return;

            const chatId = pendingDeleteChatId;
            closeDeleteChatModal();

            try {
                const { error } = await supabaseClient
                    .from('chats')
                    .delete()
                    .eq('id', chatId);

                if (error) throw error;

                // If deleting current chat, start new one
                if (chatId === currentChatId) {
                    startNewChat();
                }

                // Refresh list
                loadUserChats();
            } catch (error) {
                console.error('[Chat] Delete error:', error);
            }
        }

        // Render chat history in sidebar
        function renderChatHistory() {
            const container = document.getElementById('chatHistoryList');
            if (!container) return;

            if (userChats.length === 0) {
                container.innerHTML = `
                    <div class="chat-history-empty">
                        <p>No chat history yet</p>
                        <span>Your conversations will appear here</span>
                    </div>
                `;
                return;
            }

            const formatTime = (dateStr) => {
                const date = new Date(dateStr);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins}m ago`;
                if (diffHours < 24) return `${diffHours}h ago`;
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            };

            container.innerHTML = userChats.map(chat => `
                <div class="chat-history-item ${chat.id === currentChatId ? 'active' : ''}"
                     onclick="loadChat('${chat.id}')"
                     data-chat-id="${chat.id}">
                    <div class="chat-history-item-icon">
                        ${chat.is_builder
                            ? '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/></svg>'
                            : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 01-2 2H7l-4 4V5a2 2 0 012-2h14a2 2 0 012 2z"/></svg>'
                        }
                    </div>
                    <div class="chat-history-item-content">
                        <span class="chat-history-item-title">${escapeHtml(chat.title)}</span>
                        <span class="chat-history-item-time">${formatTime(chat.updated_at)}</span>
                    </div>
                    <button class="chat-history-delete-btn" onclick="openDeleteChatModal('${chat.id}', event)" title="Delete chat">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14">
                            <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/>
                        </svg>
                    </button>
                </div>
            `).join('');
        }

        // Insights DOM Elements
        const suiteInsights = document.getElementById('suiteInsights');
        const insightsContent = document.getElementById('insightsContent');
        const insightsMinimizeBtn = document.getElementById('insightsMinimizeBtn');
        const insightsMinimizedBtn = document.getElementById('insightsMinimizedBtn');
        const insightsBadge = document.getElementById('insightsBadge');

        // Initialize insights panel interactions
        if (insightsMinimizeBtn) {
            insightsMinimizeBtn.addEventListener('click', minimizeInsights);
        }
        if (insightsMinimizedBtn) {
            insightsMinimizedBtn.addEventListener('click', expandInsights);
        }

        // Show insights side panel (called when chat becomes active)
        function showInsightsPanel() {
            if (suiteInsights && !insightsState.isMinimized) {
                suiteInsights.classList.add('active');
                if (insightsMinimizedBtn) insightsMinimizedBtn.classList.remove('active');
            }
        }

        function minimizeInsights() {
            insightsState.isMinimized = true;
            if (suiteInsights) suiteInsights.classList.remove('active');
            if (insightsMinimizedBtn) insightsMinimizedBtn.classList.add('active');
        }

        function expandInsights() {
            insightsState.isMinimized = false;
            if (insightsMinimizedBtn) insightsMinimizedBtn.classList.remove('active');

            // Show accumulated insights
            if (insightsState.pendingInsights.length > 0) {
                renderInsightsSummary();
            }

            if (suiteInsights) suiteInsights.classList.add('active');

            // Reset badge
            insightsState.badgeCount = 0;
            updateInsightsBadge();
        }

        function updateInsightsBadge() {
            if (insightsBadge) {
                insightsBadge.textContent = insightsState.badgeCount;
                insightsBadge.setAttribute('data-count', insightsState.badgeCount);
            }
        }

        function addInsight(type, data) {
            const insight = { type, data, timestamp: Date.now() };
            insightsState.pendingInsights.push(insight);

            if (insightsState.isMinimized) {
                // Increment badge when minimized
                insightsState.badgeCount++;
                updateInsightsBadge();
            } else {
                // Show insight immediately if panel is open
                renderSingleInsight(insight);
                if (suiteInsights) suiteInsights.classList.add('active');
            }
        }

        // Analyze conversation for relevant app suggestions using AI (runs in background)
        async function analyzeForAppSuggestions(userMessage, aiResponse) {
            // Skip if conversation hasn't grown since last analysis
            if (conversationHistory.length <= insightsState.lastAnalyzedIndex) return;
            insightsState.lastAnalyzedIndex = conversationHistory.length;

            // Show thinking indicator in insights panel
            if (insightsContent) {
                const thinkingEl = document.createElement('div');
                thinkingEl.className = 'insights-thinking';
                thinkingEl.id = 'insightsThinking';
                thinkingEl.innerHTML = '<span class="insights-thinking-dot"></span><span class="insights-thinking-dot"></span><span class="insights-thinking-dot"></span> Analyzing conversation...';
                // Remove empty state if present
                const emptyState = insightsContent.querySelector('.insights-empty-state');
                if (emptyState) emptyState.remove();
                insightsContent.appendChild(thinkingEl);
            }

            try {
                const response = await fetch('/api/gemini', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        prompt: `You are an app recommendation engine. Analyze this chat exchange and determine if any existing apps could address the user's underlying need, OR suggest a custom app idea.

USER: ${userMessage}

ASSISTANT: ${(aiResponse || '').substring(0, 500)}

AVAILABLE APPS:
${SUITE_APPS_COMPACT}

ALREADY SUGGESTED (do not repeat): ${[...insightsState.suggestedAppKeys].join(', ') || 'none'}

Respond with ONLY valid JSON, no markdown fences:
{"matched_apps": [{"slug": "exact-key-from-list", "reason": "one sentence why this helps"}], "build_suggestion": null}

If no existing app matches, set matched_apps to [] and provide:
{"matched_apps": [], "build_suggestion": {"name": "AppName", "description": "what it would do for the user"}}

Rules:
- Only match apps that genuinely address the user's underlying need
- Maximum 2 matched apps
- If the conversation is casual (greetings, jokes, small talk), return: {"matched_apps": [], "build_suggestion": null}
- Use exact slug keys from the AVAILABLE APPS list`,
                        model: 'gemini-2.0-flash',
                        enableSearch: false,
                        generationConfig: {
                            temperature: 0.3,
                            maxOutputTokens: 256
                        }
                    })
                });

                if (!response.ok) return;

                const data = await response.json();
                const text = (data.text || '').trim();

                // Parse JSON  strip markdown code fences if present
                const jsonStr = text.replace(/^```json?\s*/, '').replace(/\s*```$/, '');
                const result = JSON.parse(jsonStr);

                // Process matched apps
                if (result.matched_apps && Array.isArray(result.matched_apps)) {
                    for (const match of result.matched_apps) {
                        const app = SUITE_APPS[match.slug];
                        if (app && !insightsState.suggestedAppKeys.has(match.slug)) {
                            insightsState.suggestedAppKeys.add(match.slug);
                            addInsight('app', {
                                appKey: match.slug,
                                appName: app.name,
                                appUrl: app.url,
                                reason: match.reason
                            });
                        }
                    }
                }

                // Process build suggestion (only if no apps matched)
                if (result.build_suggestion && (!result.matched_apps || result.matched_apps.length === 0)) {
                    const alreadySuggestedBuild = insightsState.pendingInsights.some(i => i.type === 'build')
                        || insightsState.shownInsights.some(i => i.type === 'build');

                    if (!alreadySuggestedBuild) {
                        addInsight('build', {
                            topic: result.build_suggestion.name,
                            description: result.build_suggestion.description
                        });
                    }
                }

            } catch (e) {
                console.debug('[Insights] Analysis failed:', e.message);
            } finally {
                // Remove thinking indicator
                const thinking = document.getElementById('insightsThinking');
                if (thinking) thinking.remove();
            }
        }

        function renderSingleInsight(insight) {
            if (!insightsContent) return;

            const insightEl = document.createElement('div');
            insightEl.className = 'insight-item';

            if (insight.type === 'app') {
                const reason = insight.data.reason
                    ? `<p class="insight-reason">${insight.data.reason}</p>`
                    : '';
                insightEl.innerHTML = `
                    <div class="insight-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                    </div>
                    <div class="insight-text">
                        <p><strong>${insight.data.appName}</strong> could help with this.</p>
                        ${reason}
                        <div class="insight-actions">
                            <button class="insight-btn primary" onclick="previewApp('${insight.data.appKey}', '${insight.data.appUrl}', '${insight.data.appName}')">Try it</button>
                            <button class="insight-btn-dismiss" onclick="dismissInsight(this)">Dismiss</button>
                        </div>
                    </div>
                `;
            } else if (insight.type === 'idea') {
                insightEl.innerHTML = `
                    <div class="insight-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/>
                            <circle cx="12" cy="12" r="4"/>
                        </svg>
                    </div>
                    <div class="insight-text">
                        <p>This sounds like a great app idea! Want to request it?</p>
                        <div class="insight-actions">
                            <button class="insight-btn primary" onclick="requestAppFromInsight('${encodeURIComponent(insight.data.idea)}')">Request App</button>
                            <button class="insight-btn-dismiss" onclick="dismissInsight(this)">Not now</button>
                        </div>
                    </div>
                `;
            } else if (insight.type === 'build') {
                const buildTitle = insight.data.topic || 'a custom app';
                const buildDesc = insight.data.description
                    ? `<p class="insight-reason">${insight.data.description}</p>`
                    : '';
                insightEl.innerHTML = `
                    <div class="insight-icon build-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16">
                            <polygon points="12 2 22 8.5 22 15.5 12 22 2 15.5 2 8.5 12 2"/>
                            <line x1="12" y1="22" x2="12" y2="15.5"/>
                            <polyline points="22 8.5 12 15.5 2 8.5"/>
                        </svg>
                    </div>
                    <div class="insight-text">
                        <p>Idea: <strong>${buildTitle}</strong></p>
                        ${buildDesc}
                        <div class="insight-actions">
                            <button class="insight-btn build-btn" onclick="openBuilderFromInsight()">Build it</button>
                            <button class="insight-btn-dismiss" onclick="dismissInsight(this)">Not now</button>
                        </div>
                    </div>
                `;
            }

            insightsContent.appendChild(insightEl);
            insightsState.shownInsights.push(insight);
        }

        function renderInsightsSummary() {
            if (!insightsContent) return;
            insightsContent.innerHTML = '';

            const apps = insightsState.pendingInsights.filter(i => i.type === 'app');
            const ideas = insightsState.pendingInsights.filter(i => i.type === 'idea');

            if (apps.length === 0 && ideas.length === 0) return;

            let summaryHtml = '<div class="insights-summary">';
            summaryHtml += '<div class="insights-summary-title">Based on your conversation:</div>';

            if (apps.length > 0) {
                summaryHtml += '<div class="insights-summary-apps">';
                summaryHtml += '<div class="insights-summary-label">Apps that could help</div>';
                apps.forEach(app => {
                    summaryHtml += `<span class="insights-app-chip" onclick="previewApp('${app.data.appKey}', '${app.data.appUrl}', '${app.data.appName}')">${app.data.appName}</span>`;
                });
                summaryHtml += '</div>';
            }

            if (ideas.length > 0) {
                summaryHtml += '<div class="insights-summary-ideas">';
                summaryHtml += '<div class="insights-summary-label">App ideas detected</div>';
                ideas.forEach(idea => {
                    const shortIdea = idea.data.idea.substring(0, 50) + (idea.data.idea.length > 50 ? '...' : '');
                    summaryHtml += `<span class="insights-idea-chip" onclick="requestAppFromInsight('${encodeURIComponent(idea.data.idea)}')">${shortIdea}</span>`;
                });
                summaryHtml += '</div>';
            }

            summaryHtml += '</div>';
            insightsContent.innerHTML = summaryHtml;

            // Move pending to shown
            insightsState.shownInsights = [...insightsState.shownInsights, ...insightsState.pendingInsights];
            insightsState.pendingInsights = [];
        }

        function dismissInsight(btn) {
            const insightItem = btn.closest('.insight-item');
            if (insightItem) {
                insightItem.style.opacity = '0';
                insightItem.style.transform = 'translateX(20px)';
                setTimeout(() => insightItem.remove(), 200);
            }
        }

        function requestAppFromInsight(encodedIdea) {
            const idea = decodeURIComponent(encodedIdea);
            // Open creator dashboard with the idea pre-filled
            openCreatorDashboard();
            // Could also add to chat or open a modal
            setTimeout(() => {
                const chatInput = document.getElementById('chatInput');
                if (chatInput) {
                    chatInput.value = `I'd like to request an app: ${idea}`;
                    chatInput.focus();
                }
            }, 300);
        }

        function openBuilderFromInsight() {
            // Extract topic/context from recent conversation
            let context = '';
            if (conversationHistory.length > 0) {
                // Get the last few messages for context
                const recentMessages = conversationHistory.slice(-4);
                const topics = [];

                recentMessages.forEach(msg => {
                    if (msg.role === 'user') {
                        // Extract key topic from user message
                        const topic = extractTopic(msg.content);
                        if (topic && !topics.includes(topic)) {
                            topics.push(topic);
                        }
                    }
                });

                if (topics.length > 0) {
                    context = `Build an app to help with: ${topics.join(', ')}`;
                }
            }

            // Open builder mode
            openBuilderMode();

            // Pre-fill the builder input if we have context
            if (context) {
                setTimeout(() => {
                    const builderInput = document.getElementById('builderInput');
                    if (builderInput) {
                        builderInput.value = context;
                        builderInput.focus();
                        // Auto-resize the textarea
                        builderInput.style.height = 'auto';
                        builderInput.style.height = builderInput.scrollHeight + 'px';
                    }
                }, 350);
            }

            // Dismiss the insights panel
            clearInsights();
        }

        function clearInsights() {
            insightsState.pendingInsights = [];
            insightsState.shownInsights = [];
            insightsState.badgeCount = 0;
            insightsState.suggestedAppKeys = new Set();
            insightsState.lastAnalyzedIndex = 0;
            updateInsightsBadge();
            if (insightsContent) insightsContent.innerHTML = '<div class="insights-empty-state"><p>Insights will appear here as you chat. I\'ll suggest relevant SUITE apps based on your conversation.</p></div>';
            if (suiteInsights) suiteInsights.classList.remove('active');
            if (insightsMinimizedBtn) insightsMinimizedBtn.classList.remove('active');
            insightsState.isMinimized = false;
        }

        // Detect app ideas in user messages
        function detectAppIdea(message) {
            const ideaPatterns = [
                /i wish there was an? (?:app|tool|way to) (.+)/i,
                /it would be (?:cool|nice|great|awesome) if (?:there was|I could) (.+)/i,
                /is there an? (?:app|tool|way) (?:that|to) (.+)/i,
                /i need (?:something|an app|a tool) (?:that|to|for) (.+)/i,
                /can you (?:build|make|create) (?:me )?an? (?:app|tool) (.+)/i,
                /i want an? (?:app|tool) (?:that|to|for) (.+)/i
            ];

            for (const pattern of ideaPatterns) {
                const match = message.match(pattern);
                if (match) {
                    return match[0]; // Return the full matched idea
                }
            }
            return null;
        }

        // Mobile sidebar toggle
        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', () => {
                sidebar.classList.toggle('open');
                sidebarOverlay.classList.toggle('active');
            });
        }

        if (sidebarOverlay) {
            sidebarOverlay.addEventListener('click', () => {
                sidebar.classList.remove('open');
                sidebarOverlay.classList.remove('active');
            });
        }

        // Load use cases - show hardcoded immediately, update from Supabase if available
        async function loadUseCases() {
            // Show hardcoded data immediately so users don't wait
            useCases = getHardcodedUseCases();
            renderUseCases();

            // Then try to fetch from Supabase with a timeout
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout

                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/use_cases?is_visible=eq.true&order=helpful_count.desc`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        },
                        signal: controller.signal
                    }
                );

                clearTimeout(timeoutId);

                if (response.ok) {
                    const supabaseUseCases = await response.json();
                    if (supabaseUseCases && supabaseUseCases.length > 0) {
                        useCases = supabaseUseCases;
                        renderUseCases();
                    }
                }
            } catch (error) {
                // Silently fail - we already have hardcoded data showing
                console.log('Using hardcoded use cases (Supabase unavailable)');
            }
        }

        // Hardcoded fallback
        function getHardcodedUseCases() {
            return [
                // Original use cases
                { query: "I can't focus at work anymore", response: "FocusFlow uses the Pomodoro technique to help you concentrate in focused sprints.", recommended_app: "focusflow", intent: "problems", helpful_count: 58 },
                { query: "I have back pain from sitting all day", response: "StretchTimer reminds you to take breaks and suggests desk stretches.", recommended_app: "stretchtimer", intent: "problems", helpful_count: 56 },
                { query: "I want to become financially free", response: "Start by tracking where your money goes with QuickBudget.", recommended_app: "quickbudget", intent: "desires", helpful_count: 89 },
                { query: "I want to get healthier without obsessing", response: "FoodVitals takes a gentle approach - weekly reflections instead of daily tracking.", recommended_app: "foodvitals", intent: "desires", helpful_count: 67 },
                { query: "Show me what apps you have for fitness", response: "We've got OpticRep (AI workout trainer), StepGoal (walking), and TrueForm AI (physio).", recommended_app: "opticrep", intent: "find", helpful_count: 61 },
                { query: "How can I make money building apps?", response: "With SUITE, you build apps and earn from every user through our credit system.", recommended_app: null, intent: "build", helpful_count: 94 },
                // Health & Wellness
                { query: "I never drink enough water", response: "HydroTrack makes it easy - just tap to log each glass and watch your progress.", recommended_app: "hydrotrack", intent: "problems", helpful_count: 72 },
                { query: "I can't sleep well at night", response: "SleepWell helps you track sleep patterns and find what works for you.", recommended_app: "sleepwell", intent: "problems", helpful_count: 68 },
                { query: "I feel anxious all the time", response: "MoodLog helps you track emotions and spot patterns. BreathEasy has calming exercises.", recommended_app: "moodlog", intent: "problems", helpful_count: 81 },
                { query: "I keep forgetting my vitamins", response: "PillPal tracks all your medications and helps you never miss a dose.", recommended_app: "pillpal", intent: "problems", helpful_count: 65 },
                { query: "I need to calm down right now", response: "BreathEasy has guided 4-7-8 and box breathing exercises to help you relax.", recommended_app: "breatheasy", intent: "problems", helpful_count: 77 },
                { query: "I want to walk more", response: "StepGoal lets you set daily targets and track your progress over time.", recommended_app: "stepgoal", intent: "desires", helpful_count: 59 },
                // Productivity & Learning
                { query: "I procrastinate too much", response: "FocusFlow's Pomodoro timer helps you work in focused bursts with built-in breaks.", recommended_app: "focusflow", intent: "problems", helpful_count: 84 },
                { query: "Where does all my money go?", response: "QuickBudget tracks your expenses by category so you can see exactly where it goes.", recommended_app: "quickbudget", intent: "problems", helpful_count: 79 },
                { query: "I need to study for an exam", response: "FlashMind creates flashcards with spaced repetition to help you memorize.", recommended_app: "flashmind", intent: "problems", helpful_count: 71 },
                { query: "I want to read more books", response: "BookShelf tracks your reading list, progress, and helps you hit your goals.", recommended_app: "bookshelf", intent: "desires", helpful_count: 63 },
                { query: "I want to learn a new skill", response: "SkillTree breaks skills into milestones and tracks your progress visually.", recommended_app: "skilltree", intent: "desires", helpful_count: 66 },
                { query: "I never know what to cook", response: "MealPrep helps you plan your whole week and generates a shopping list.", recommended_app: "mealprep", intent: "problems", helpful_count: 74 },
                { query: "My house is always messy", response: "CleanHome creates a cleaning schedule so you know exactly what to do when.", recommended_app: "cleanhome", intent: "problems", helpful_count: 62 },
                // Lifestyle & Social
                { query: "I need date night ideas", response: "DateNight has tons of ideas - romantic, budget-friendly, adventurous, or at-home.", recommended_app: "datenight", intent: "desires", helpful_count: 69 },
                { query: "I need to track my pet's vet visits", response: "PetCare keeps track of all your pet's health info, feeding, and appointments.", recommended_app: "petcare", intent: "problems", helpful_count: 57 },
                { query: "I always forget things when traveling", response: "PackLight generates packing lists based on your trip type and duration.", recommended_app: "packlight", intent: "problems", helpful_count: 73 },
                { query: "I never know what gift to buy", response: "GiftGuru helps you track gift ideas for everyone and never forget a birthday.", recommended_app: "giftguru", intent: "problems", helpful_count: 64 },
                { query: "I want to build better habits", response: "HabitStack lets you chain habits together and track your streaks.", recommended_app: "habitstack", intent: "desires", helpful_count: 82 },
                { query: "I can't decide between options", response: "QuickDecide has a random picker, coin flip, and pro/con lists to help you choose.", recommended_app: "quickdecide", intent: "problems", helpful_count: 55 }
            ];
        }

        // Render use cases
        function renderUseCases() {
            if (!useCasesGrid) return;

            const filtered = currentIntent === 'all'
                ? useCases
                : useCases.filter(uc => uc.intent === currentIntent);

            if (useCaseCount) useCaseCount.textContent = `(${filtered.length})`;

            const intentStyles = {
                'problems': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M14.7 6.3a1 1 0 000 1.4l1.6 1.6a1 1 0 001.4 0l3.77-3.77a6 6 0 01-7.94 7.94l-6.91 6.91a2.12 2.12 0 01-3-3l6.91-6.91a6 6 0 017.94-7.94l-3.76 3.76z"/></svg>', label: 'Problem', class: 'problem' },
                'desires': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>', label: 'Desire', class: 'desire' },
                'ideas': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"/></svg>', label: 'Idea', class: 'idea' },
                'find': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><circle cx="11" cy="11" r="8"/><path d="M21 21l-4.35-4.35"/></svg>', label: 'Find', class: 'find' },
                'change': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>', label: 'Change', class: 'change' },
                'build': { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M12 2L2 7l10 5 10-5-10-5zM2 17l10 5 10-5M2 12l10 5 10-5"/></svg>', label: 'Build', class: 'build' }
            };

            useCasesGrid.innerHTML = filtered.map(uc => {
                const app = SUITE_APPS[uc.recommended_app] || {};
                const intentInfo = intentStyles[uc.intent] || intentStyles['find'];

                return `
                    <div class="use-case-card" data-query="${encodeURIComponent(uc.query)}" data-response="${encodeURIComponent(uc.response)}" data-app="${uc.recommended_app || ''}">
                        <span class="intent-badge ${intentInfo.class}">
                            <span>${intentInfo.icon}</span>
                            <span>${intentInfo.label}</span>
                        </span>
                        <div class="use-case-query">"${uc.query}"</div>
                        <div class="use-case-meta">
                            <div class="use-case-app">
                                ${uc.recommended_app ? `
                                    <div class="use-case-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                                    <span class="use-case-app-name">${app.name || 'Custom App'}</span>
                                ` : `
                                    <div class="use-case-app-icon" style="background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary))"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg></div>
                                    <span class="use-case-app-name">Custom / Build & Earn</span>
                                `}
                            </div>
                            <div class="use-case-helpful">
                                <svg viewBox="0 0 24 24" fill="currentColor"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"/></svg>
                                ${uc.helpful_count || 0}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            // Add click handlers - each click starts a fresh chat
            document.querySelectorAll('.use-case-card').forEach(card => {
                card.addEventListener('click', () => {
                    const query = decodeURIComponent(card.dataset.query);
                    const response = decodeURIComponent(card.dataset.response);
                    const app = card.dataset.app;

                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    welcomeState.classList.add('chat-active');
                    chatContainer.classList.add('active');
                    showInsightsPanel();
                    addMessage(query, 'user');
                    addMessage(response, 'assistant', app);
                    conversationHistory.push({ role: 'user', content: query });
                    conversationHistory.push({ role: 'assistant', content: response });
                });
            });
        }

        // Enable/disable send button
        chatInput.addEventListener('input', () => {
            sendBtn.disabled = !chatInput.value.trim() || isLoading;
        });

        // Send on Enter
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey && !sendBtn.disabled) {
                e.preventDefault();
                sendMessage();
            }
        });

        sendBtn.addEventListener('click', sendMessage);

        // Quick suggestion chips - each click starts a fresh chat
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.addEventListener('click', () => {
                const query = chip.dataset.query;
                if (query) {
                    // Reset chat state for new conversation
                    chatMessages.innerHTML = '';
                    conversationHistory = [];

                    chatInput.value = query;
                    sendMessage();
                }
            });
        });

        // Add message to chat
        function addMessage(content, role, appRecommendation = null, userQuery = null) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            if (role === 'user' && userAvatarUrl) {
                avatar.innerHTML = `<img src="${userAvatarUrl}" alt="You" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">`;
            } else if (role === 'user') {
                avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>';
            } else {
                avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = renderMarkdown(content);

            if (appRecommendation && SUITE_APPS[appRecommendation]) {
                const app = SUITE_APPS[appRecommendation];
                const appCard = document.createElement('div');
                appCard.className = 'app-card-inline';
                appCard.style.cursor = 'pointer';
                appCard.onclick = () => previewApp(appRecommendation, app.url, app.name);
                appCard.innerHTML = `
                    <div class="app-icon-inline" style="background: ${app.iconBg}">${app.iconUrl ? `<img src="${app.iconUrl}" alt="${app.name}">` : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7" rx="1"/><rect x="14" y="3" width="7" height="7" rx="1"/><rect x="3" y="14" width="7" height="7" rx="1"/><rect x="14" y="14" width="7" height="7" rx="1"/></svg>'}</div>
                    <div class="app-info-inline">
                        <h4>${app.name}</h4>
                        <p>${app.description}</p>
                    </div>
                    <span class="app-arrow"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="20" height="20"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                `;
                contentDiv.appendChild(appCard);

                const quickActionsDiv = document.createElement('div');
                quickActionsDiv.className = 'quick-actions';
                quickActionsDiv.innerHTML = `
                    <button class="quick-action-btn" data-action="use-case" data-app="${appRecommendation}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
                        How does this help?
                    </button>
                    <button class="quick-action-btn primary" data-action="open" data-app="${appRecommendation}" data-url="${app.url}">
                        <span class="icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="16" height="16"><path d="M5 12h14M12 5l7 7-7 7"/></svg></span>
                        Open ${app.name}
                    </button>
                `;
                contentDiv.appendChild(quickActionsDiv);

                quickActionsDiv.querySelectorAll('.quick-action-btn').forEach(btn => {
                    btn.addEventListener('click', () => handleQuickAction(btn.dataset.action, btn.dataset.app, btn.dataset.url, userQuery));
                });
            }

            if (role === 'assistant' && !appRecommendation) {
                const feedbackDiv = document.createElement('div');
                feedbackDiv.className = 'feedback-buttons';
                feedbackDiv.innerHTML = `
                    <button class="feedback-btn" data-feedback="good"> Helpful</button>
                    <button class="feedback-btn" data-feedback="bad"> Not helpful</button>
                `;
                contentDiv.appendChild(feedbackDiv);

                feedbackDiv.querySelectorAll('.feedback-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        feedbackDiv.querySelectorAll('.feedback-btn').forEach(b => b.classList.remove('active-good', 'active-bad'));
                        btn.classList.add(btn.dataset.feedback === 'good' ? 'active-good' : 'active-bad');
                    });
                });
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            // Scroll the chat messages wrapper to bottom
            const wrapper = chatContainer.querySelector('.chat-messages-wrapper');
            if (wrapper) wrapper.scrollTop = wrapper.scrollHeight;
            else chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        // Handle quick action button clicks
        function handleQuickAction(action, appId, url, originalQuery) {
            const app = SUITE_APPS[appId];
            if (!app) return;

            switch (action) {
                case 'use-case':
                    const useCaseQuery = `Tell me specifically how ${app.name} can help with my situation`;
                    addMessage(useCaseQuery, 'user');
                    conversationHistory.push({ role: 'user', content: useCaseQuery });
                    addTypingIndicator();

                    setTimeout(() => {
                        removeTypingIndicator();
                        const response = getUseCaseResponse(app, originalQuery);
                        addMessage(response, 'assistant');
                        conversationHistory.push({ role: 'assistant', content: response });
                    }, 1200);
                    break;

                case 'open':
                    previewApp(appId, url, app.name);
                    break;
            }
        }

        function getUseCaseResponse(app, originalQuery) {
            const responses = {
                'foodvitals': `Here's how FoodVitals specifically helps you:\n\n1. **Weekly Check-ins, Not Daily Logging** - Less pressure, more sustainable.\n\n2. **AI-Powered Insights** - Personalized suggestions based on YOUR habits.\n\n3. **No Calorie Counting** - Focus on how food makes you feel.\n\nWant to try it?`,
                'trueform': `Here's how TrueForm AI specifically helps you:\n\n1. **AI Posture Assessment** - Use your camera to analyze your posture.\n\n2. **Personalized Stretching Routines** - Based on YOUR specific issues.\n\n3. **Form Correction in Real-Time** - The AI watches and corrects you.\n\nReady to start?`,
                'opticrep': `Here's how OpticRep specifically helps you:\n\n1. **AI Rep Counter** - Automatically counts your reps using your camera.\n\n2. **Form Analysis** - Real-time feedback on your exercise form.\n\n3. **Workout Programs** - AI-generated programs based on your goals.\n\nWant to start your first workout?`,
                'cheshbon': `Here's how Cheshbon specifically helps you:\n\n1. **Custom Reading Plans** - Read through the Bible at your own pace on a schedule that works for you.\n\n2. **Daily Reflections** - Journal your thoughts on each reading with guided prompts.\n\n3. **AI-Powered Insights** - Get deeper understanding of passages with AI-generated analysis and context.\n\nReady to start?`,
                'remcast': `Here's how RemCast specifically helps you:\n\n1. **Dream Journal** - Log your dreams with voice or text as soon as you wake up.\n\n2. **AI Dream Analysis** - Get insights into recurring themes, symbols, and patterns.\n\n3. **Dream Visuals** - Generate images and video reels from your dreams using AI.\n\nReady to explore your dreams?`,
                'defi-knowledge': `Here's how DeFi Knowledge specifically helps you:\n\n1. **Structured Learning Path** - From basics to advanced.\n\n2. **No Shill, Just Education** - We teach concepts, not promote protocols.\n\n3. **Interactive Simulations** - Practice without risking real money.\n\nReady to start learning?`,
                // Health & Wellness
                'hydrotrack': `Here's how HydroTrack specifically helps you:\n\n1. **Simple One-Tap Logging** - Just tap to add a glass of water.\n\n2. **Visual Progress** - See your daily progress with a satisfying progress ring.\n\n3. **Streak Tracking** - Build consistency with daily streaks.\n\nReady to stay hydrated?`,
                'sleepwell': `Here's how SleepWell specifically helps you:\n\n1. **Sleep Quality Tracking** - Log bedtime, wake time, and rate your rest.\n\n2. **Pattern Recognition** - See weekly averages and spot trends.\n\n3. **Personalized Tips** - Get suggestions based on your sleep patterns.\n\nReady to sleep better?`,
                'moodlog': `Here's how MoodLog specifically helps you:\n\n1. **Quick Mood Check-ins** - 5 simple moods to choose from.\n\n2. **Calendar View** - See your emotional patterns over time.\n\n3. **Optional Notes** - Add context when you need to.\n\nReady to understand your emotions better?`,
                'pillpal': `Here's how PillPal specifically helps you:\n\n1. **Medication Schedules** - Set up all your meds with their times.\n\n2. **Check-off System** - Mark when you've taken each dose.\n\n3. **Streak Tracking** - Stay consistent with visual progress.\n\nReady to never miss a dose?`,
                'breatheasy': `Here's how BreathEasy specifically helps you:\n\n1. **Guided Breathing** - 4-7-8 and box breathing animations.\n\n2. **Visual Guides** - Watch the circle expand and contract.\n\n3. **Session Options** - Choose 1-5 minute sessions.\n\nReady to feel calmer?`,
                'stepgoal': `Here's how StepGoal specifically helps you:\n\n1. **Daily Goal Setting** - Set your target steps.\n\n2. **Manual Entry** - Log steps easily without a fitness tracker.\n\n3. **Weekly Charts** - Track your progress over time.\n\nReady to move more?`,
                'stretchtimer': `Here's how StretchTimer specifically helps you:\n\n1. **Break Reminders** - Set intervals (30/45/60 min).\n\n2. **Stretch Suggestions** - Get quick stretches when the timer hits.\n\n3. **Daily Tracking** - See how many breaks you've taken.\n\nReady to take better care of yourself at work?`,
                // Productivity & Learning
                'focusflow': `Here's how FocusFlow specifically helps you:\n\n1. **Pomodoro Technique** - 25 min work, 5 min break by default.\n\n2. **Session Counter** - Track your focus sessions.\n\n3. **Customizable** - Adjust durations to fit your style.\n\nReady to focus better?`,
                'quickbudget': `Here's how QuickBudget specifically helps you:\n\n1. **Quick Expense Entry** - Amount, category, done.\n\n2. **Category Breakdown** - See where your money goes.\n\n3. **Budget Limits** - Set monthly limits and track against them.\n\nReady to take control of your spending?`,
                'flashmind': `Here's how FlashMind specifically helps you:\n\n1. **Create Decks** - Organize flashcards by topic.\n\n2. **Flip Animation** - Study with satisfying card flips.\n\n3. **Spaced Repetition** - Cards you struggle with appear more often.\n\nReady to study smarter?`,
                'bookshelf': `Here's how BookShelf specifically helps you:\n\n1. **Track Your Books** - Want to Read, Reading, Finished.\n\n2. **Page Progress** - See how far you are in each book.\n\n3. **Reading Stats** - Track books per month.\n\nReady to read more?`,
                'skilltree': `Here's how SkillTree specifically helps you:\n\n1. **Add Skills** - List what you want to learn.\n\n2. **Set Milestones** - Break skills into achievable steps.\n\n3. **Track Progress** - Visual progress bars keep you motivated.\n\nReady to level up your skills?`,
                'mealprep': `Here's how MealPrep specifically helps you:\n\n1. **Weekly Grid** - Plan breakfast, lunch, dinner for 7 days.\n\n2. **Favorite Meals** - Save meals you make often.\n\n3. **Shopping List** - Auto-generate from your meal plan.\n\nReady to simplify meal planning?`,
                'cleanhome': `Here's how CleanHome specifically helps you:\n\n1. **Add Rooms** - Set up areas to clean.\n\n2. **Set Frequency** - Daily, weekly, or monthly tasks.\n\n3. **Overdue Alerts** - See what needs attention.\n\nReady for a cleaner home?`,
                // Lifestyle & Social
                'datenight': `Here's how DateNight specifically helps you:\n\n1. **Random Ideas** - Get surprise date suggestions.\n\n2. **Categories** - Romantic, Adventure, Budget, Home.\n\n3. **History** - Track dates you've done together.\n\nReady for your next date?`,
                'petcare': `Here's how PetCare specifically helps you:\n\n1. **Pet Profiles** - Add all your pets with details.\n\n2. **Activity Logging** - Track feeding, walks, vet visits.\n\n3. **Reminders** - Never miss important pet care.\n\nReady to be a better pet parent?`,
                'packlight': `Here's how PackLight specifically helps you:\n\n1. **Trip Templates** - Beach, Business, Winter, Camping.\n\n2. **Auto-Generate Lists** - Based on trip type and duration.\n\n3. **Check Items Off** - Know exactly what's packed.\n\nReady for stress-free packing?`,
                'giftguru': `Here's how GiftGuru specifically helps you:\n\n1. **People Profiles** - Store interests, sizes, preferences.\n\n2. **Gift Ideas** - Track ideas for each person.\n\n3. **Status Tracking** - Bought, wrapped, given.\n\nReady to nail gift-giving?`,
                'habitstack': `Here's how HabitStack specifically helps you:\n\n1. **Chain Habits** - Link habits in sequence.\n\n2. **Streak Counter** - Don't break the chain!\n\n3. **Morning/Evening Routines** - Build powerful routines.\n\nReady to build lasting habits?`,
                'quickdecide': `Here's how QuickDecide specifically helps you:\n\n1. **Random Picker** - Add options and let fate decide.\n\n2. **Coin Flip** - Simple yes/no decisions.\n\n3. **Pro/Con Lists** - Think it through when needed.\n\nReady to stop overthinking?`
            };

            return responses[app.id] || `${app.name} is designed to help with exactly what you described. Let me know if you want to dive deeper!`;
        }

        function addTypingIndicator() {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';
            messageDiv.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatMessages.appendChild(messageDiv);
            // Scroll the chat messages wrapper to bottom
            const typingWrapper = chatContainer.querySelector('.chat-messages-wrapper');
            if (typingWrapper) typingWrapper.scrollTop = typingWrapper.scrollHeight;
            else chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function removeTypingIndicator() {
            document.getElementById('typingIndicator')?.remove();
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message || isLoading) return;

            const userQuery = message;

            isLoading = true;
            sendBtn.disabled = true;
            chatInput.value = '';
            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');
            showInsightsPanel();

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });
            addTypingIndicator();

            // Check for app ideas in user message
            const detectedIdea = detectAppIdea(message);
            if (detectedIdea) {
                addInsight('idea', { idea: detectedIdea });
            }

            try {
                // Check if this is a personal insight query
                if (isPersonalInsightQuery(message)) {
                    const insightResult = await getPersonalInsight(message);
                    removeTypingIndicator();

                    if (insightResult.success) {
                        let response = insightResult.message;
                        if (insightResult.appsAnalyzed?.length > 0) {
                            response += `\n\n*Based on data from: ${insightResult.appsAnalyzed.map(a => SUITE_APPS[a]?.name || a).join(', ')}*`;
                        }
                        addMessage(response, 'assistant', null, userQuery);
                        conversationHistory.push({ role: 'assistant', content: response });
                    } else {
                        addMessage(insightResult.message, 'assistant', null, userQuery);
                        conversationHistory.push({ role: 'assistant', content: insightResult.message });
                    }
                } else {
                    // Route to appropriate AI model based on selection
                    let aiResponse = '';
                    console.log('[Chat] Using model:', currentModel);

                    if (currentModel === 'flash' || currentModel === 'pro') {
                        // Gemini models - call our API proxy
                        const geminiModel = currentModel === 'flash' ? 'gemini-2.0-flash' : 'gemini-2.0-pro-exp-02-05';

                        // Build conversation history for Gemini
                        const geminiContents = conversationHistory.map(msg => ({
                            role: msg.role === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.content }]
                        }));

                        // System instruction with current date for accurate info
                        const today = new Date();
                        const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                        const systemInstruction = `Today's date is ${dateStr}. You are a helpful AI assistant. Always provide accurate, up-to-date information. When discussing current events, facts, or data, use information current as of ${today.getFullYear()}. If you're unsure about recent changes, mention that the user should verify for the most current information.`;

                        const response = await fetch('/api/gemini', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: geminiModel,
                                contents: geminiContents,
                                systemInstruction: systemInstruction,
                                enableSearch: true
                            })
                        });

                        if (!response.ok) throw new Error('Gemini API failed');

                        const data = await response.json();
                        aiResponse = data.text || 'Sorry, I could not generate a response.';

                        // Append source links if Google Search grounding was used
                        if (data.groundingChunks && data.groundingChunks.length > 0) {
                            const sources = data.groundingChunks
                                .filter(c => c.web)
                                .map(c => `[${c.web.title || c.web.uri}](${c.web.uri})`)
                                .slice(0, 3);
                            if (sources.length > 0) {
                                aiResponse += `\n\n**Sources:**\n${sources.join('\n')}`;
                            }
                        }

                    } else if (currentModel === 'sonnet' || currentModel === 'opus') {
                        // Claude models - call Anthropic via edge function
                        const claudeModel = currentModel === 'sonnet' ? 'claude-sonnet-4-20250514' : 'claude-opus-4-20250514';

                        const response = await fetch(`${SUPABASE_URL}/functions/v1/claude-chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                model: claudeModel,
                                messages: conversationHistory.slice(-10)
                            })
                        });

                        if (!response.ok) throw new Error('Claude API failed');

                        const data = await response.json();
                        aiResponse = data.response || data.text || 'Sorry, I could not generate a response.';

                    } else if (currentModel === 'llama') {
                        // Llama 3.3 70B via Groq
                        const today = new Date();
                        const dateStr = today.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

                        // Build messages array for Groq (OpenAI format)
                        const groqMessages = [
                            {
                                role: 'system',
                                content: `Today's date is ${dateStr}. You are a helpful AI assistant. Always provide accurate, up-to-date information.`
                            },
                            ...conversationHistory.map(msg => ({
                                role: msg.role,
                                content: msg.content
                            }))
                        ];

                        const response = await fetch('/api/groq', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                model: 'llama-3.3-70b-versatile',
                                messages: groqMessages
                            })
                        });

                        if (!response.ok) {
                            const errorData = await response.json();
                            if (response.status === 429) {
                                throw new Error('Rate limit reached. Please wait a moment and try again.');
                            }
                            throw new Error(errorData.error || 'Groq API failed');
                        }

                        const data = await response.json();
                        aiResponse = data.text || 'Sorry, I could not generate a response.';

                    } else {
                        // Fallback to SuiteGPT chat (app recommendations)
                        const response = await fetch(`${SUPABASE_URL}/functions/v1/suitegpt-chat`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            },
                            body: JSON.stringify({
                                message: message,
                                history: conversationHistory.slice(-10)
                            })
                        });

                        if (!response.ok) throw new Error('Failed');

                        const data = await response.json();
                        aiResponse = data.response;

                        // Track app recommendation as insight
                        if (data.recommendedApp && SUITE_APPS[data.recommendedApp]) {
                            const app = SUITE_APPS[data.recommendedApp];
                            addInsight('app', {
                                appKey: data.recommendedApp,
                                appName: app.name,
                                appUrl: app.url
                            });
                        }
                    }

                    removeTypingIndicator();
                    addMessage(aiResponse, 'assistant', null, userQuery);
                    conversationHistory.push({ role: 'assistant', content: aiResponse });

                    // Analyze message for app suggestions in background (fire-and-forget)
                    // Uses setTimeout to ensure the chat response renders first
                    setTimeout(() => analyzeForAppSuggestions(message, aiResponse), 100);
                }

            } catch (error) {
                removeTypingIndicator();
                console.error('[Chat] API error:', error.message);

                // Show the actual error to the user instead of a silent fallback
                const errorMsg = error.message.includes('Rate limit')
                    ? error.message
                    : `Something went wrong (${error.message}). Please try again or switch to a different model.`;
                addMessage(errorMsg, 'assistant', null, userQuery);
                conversationHistory.push({ role: 'assistant', content: errorMsg });
            }

            isLoading = false;
            sendBtn.disabled = !chatInput.value.trim();
            chatInput.focus();

            // Save chat to Supabase (debounced)
            scheduleChatSave();
        }

        function getLocalResponse(message) {
            const keywords = {
                'foodvitals': ['nutrition', 'diet', 'calories', 'food', 'meals', 'weight', 'eating', 'healthy'],
                'trueform': ['back pain', 'posture', 'stretching', 'physical therapy', 'mobility', 'pain', 'sitting'],
                'opticrep': ['workout', 'gym', 'fitness', 'exercise', 'training', 'muscle', 'strength'],
                'cheshbon': ['bible', 'scripture', 'reading plan', 'faith', 'reflection', 'devotional', 'christian', 'gospel'],
                'remcast': ['dream', 'dreams', 'sleep', 'nightmare', 'subconscious', 'journal', 'lucid', 'dreaming'],
                'defi-knowledge': ['defi', 'crypto', 'blockchain', 'yield', 'trading'],
                // Health & Wellness
                'hydrotrack': ['water', 'hydration', 'thirsty', 'drink', 'dehydrated', 'glasses'],
                'sleepwell': ['sleep', 'insomnia', 'tired', 'rest', 'bedtime', 'wake up', 'fatigue'],
                'moodlog': ['mood', 'anxiety', 'stressed', 'mental health', 'depression', 'emotions', 'feelings'],
                'pillpal': ['medication', 'pills', 'vitamins', 'medicine', 'prescription', 'supplements'],
                'breatheasy': ['breathing', 'panic', 'calm', 'relax', 'meditation', 'stress relief', 'anxious'],
                'stepgoal': ['steps', 'walking', 'sedentary', 'move more', 'pedometer', '10000 steps'],
                'stretchtimer': ['desk', 'breaks', 'sitting too much', 'neck pain', 'computer', 'office'],
                // Productivity & Learning
                'focusflow': ['focus', 'concentrate', 'procrastinate', 'pomodoro', 'distracted', 'productivity'],
                'quickbudget': ['expenses', 'track spending', 'where my money', 'budget tracker', 'bills'],
                'flashmind': ['study', 'memorize', 'flashcards', 'exam', 'learn language', 'vocabulary'],
                'bookshelf': ['read', 'books', 'reading list', 'book tracker', 'library'],
                'skilltree': ['learn', 'skill', 'improve', 'progress', 'guitar', 'coding', 'new skill'],
                'mealprep': ['cook', 'meal plan', 'dinner ideas', 'recipe', 'what to eat', 'weekly meals'],
                'cleanhome': ['clean', 'messy', 'chores', 'housework', 'tidying', 'cleaning schedule'],
                // Lifestyle & Social
                'datenight': ['date', 'romantic', 'couple', 'date ideas', 'date night', 'anniversary'],
                'petcare': ['pet', 'dog', 'cat', 'vet', 'pet health', 'animal', 'feeding schedule'],
                'packlight': ['pack', 'travel', 'trip', 'packing list', 'vacation', 'luggage', 'forget'],
                'giftguru': ['gift', 'present', 'birthday', 'christmas', 'what to buy', 'gift ideas'],
                'habitstack': ['habit', 'routine', 'daily habit', 'streak', 'habit chain', 'build habits'],
                'quickdecide': ['decide', 'choice', 'flip coin', 'can\'t choose', 'which one', 'decision']
            };

            const lower = message.toLowerCase();
            let matchedApp = null;

            for (const [app, words] of Object.entries(keywords)) {
                if (words.some(w => lower.includes(w))) {
                    matchedApp = app;
                    break;
                }
            }

            if (matchedApp) {
                const appData = SUITE_APPS[matchedApp];
                return {
                    response: `${appData.name} is perfect for this!\n\n${appData.description}.`,
                    recommendedApp: matchedApp
                };
            }

            return {
                response: `I'm here to help! What would you like to know?`,
                recommendedApp: null
            };
        }

        // Personal AI Insights Detection
        const PERSONAL_QUERY_PATTERNS = [
            /how('s| is| was) my (hydration|water|sleep|mood|health)/i,
            /analyze my (hydration|water|sleep|mood|health|patterns?)/i,
            /give me insights? (about|on) my/i,
            /what (do|does|did) my (data|apps?|tracking) (show|say|reveal)/i,
            /my (weekly|daily|monthly) (summary|report|stats)/i,
            /(summary|report|analysis) of my (health|wellness|data)/i,
            /how am i doing (with|on) my/i,
            /show me my (progress|trends|patterns)/i
        ];

        function isPersonalInsightQuery(message) {
            return PERSONAL_QUERY_PATTERNS.some(pattern => pattern.test(message));
        }

        async function getPersonalInsight(query) {
            if (!currentUser) {
                return {
                    success: false,
                    message: "To get personalized insights, please sign in and enable AI Insights in Settings > AI Notifications."
                };
            }

            try {
                // Check if user has AI insights enabled
                const { data: settings } = await supabase
                    .from('user_ai_settings')
                    .select('ai_insights_enabled')
                    .eq('user_id', currentUser.id)
                    .single();

                if (!settings?.ai_insights_enabled) {
                    return {
                        success: false,
                        message: "AI Insights is not enabled. Go to Settings > AI Notifications to enable personalized analysis of your app data."
                    };
                }

                // Call the AI insights function
                const response = await fetch(`${SUPABASE_URL}/functions/v1/ai-insights`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${await supabaseClient.auth.getSession().then(r => r.data.session?.access_token)}`
                    },
                    body: JSON.stringify({ query })
                });

                if (!response.ok) {
                    const error = await response.json();
                    return {
                        success: false,
                        message: error.message || "I couldn't analyze your data right now. Please try again later."
                    };
                }

                const data = await response.json();
                return {
                    success: true,
                    message: data.insight,
                    appsAnalyzed: data.apps_analyzed
                };

            } catch (e) {
                console.error('Error getting personal insight:', e);
                return {
                    success: false,
                    message: "I had trouble connecting to the insights service. Please try again."
                };
            }
        }

        // Initialize
        loadUseCases();

        // ============================================
        // CHAT IMPORT FEATURE
        // ============================================

        const importModal = document.getElementById('importModal');
        const importModalClose = document.getElementById('importModalClose');
        const importSources = document.querySelectorAll('.import-source');
        const importInstructions = document.getElementById('importInstructions');
        const importDropzone = document.getElementById('importDropzone');
        const importFileInput = document.getElementById('importFileInput');
        const importStepUpload = document.getElementById('importStepUpload');
        const importProgress = document.getElementById('importProgress');
        const importProgressText = document.getElementById('importProgressText');
        const importProgressFill = document.getElementById('importProgressFill');
        const importResults = document.getElementById('importResults');
        const importDone = document.getElementById('importDone');
        const importRequestCustom = document.getElementById('importRequestCustom');

        let selectedSource = 'chatgpt';
        let analysisResults = null;

        const sourceInstructions = {
            chatgpt: {
                icon: '',
                title: 'How to export from ChatGPT',
                steps: [
                    'Go to <code>chat.openai.com</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Data controls</strong>',
                    'Click <strong>Export data</strong>',
                    'Check your email for the download link',
                    'Upload the <code>conversations.json</code> file below'
                ]
            },
            claude: {
                icon: '',
                title: 'How to export from Claude',
                steps: [
                    'Go to <code>claude.ai</code>',
                    'Click your profile  <strong>Settings</strong>',
                    'Go to <strong>Account</strong> tab',
                    'Click <strong>Export Data</strong>',
                    'Download the JSON file',
                    'Upload it below'
                ]
            },
            gemini: {
                icon: '',
                title: 'How to export from Gemini',
                steps: [
                    'Go to <code>takeout.google.com</code>',
                    'Deselect all, then select <strong>Gemini Apps</strong>',
                    'Click <strong>Next step</strong>  <strong>Create export</strong>',
                    'Download when ready',
                    'Extract and upload the conversations JSON'
                ]
            }
        };

        importModalClose.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importModal.addEventListener('click', (e) => {
            if (e.target === importModal) {
                importModal.classList.remove('active');
            }
        });

        importSources.forEach(source => {
            source.addEventListener('click', () => {
                importSources.forEach(s => s.classList.remove('selected'));
                source.classList.add('selected');
                selectedSource = source.dataset.source;
                updateInstructions();
            });
        });

        function updateInstructions() {
            const instructions = sourceInstructions[selectedSource];
            importInstructions.innerHTML = `
                <h4>${instructions.icon} ${instructions.title}</h4>
                <ol>
                    ${instructions.steps.map(step => `<li>${step}</li>`).join('')}
                </ol>
            `;
        }

        importDropzone.addEventListener('click', () => importFileInput.click());

        importDropzone.addEventListener('dragover', (e) => {
            e.preventDefault();
            importDropzone.classList.add('dragover');
        });

        importDropzone.addEventListener('dragleave', () => {
            importDropzone.classList.remove('dragover');
        });

        importDropzone.addEventListener('drop', (e) => {
            e.preventDefault();
            importDropzone.classList.remove('dragover');
            const file = e.dataTransfer.files[0];
            if (file) processFile(file);
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) processFile(file);
        });

        let isTestMode = false;

        function checkRateLimit() {
            if (isTestMode) return { allowed: true };

            const lastImport = localStorage.getItem('suitegpt_last_import');
            if (lastImport) {
                const lastTime = new Date(lastImport);
                const now = new Date();
                const hoursSince = (now - lastTime) / (1000 * 60 * 60);

                if (hoursSince < 24) {
                    const hoursLeft = Math.ceil(24 - hoursSince);
                    return { allowed: false, hoursLeft };
                }
            }
            return { allowed: true };
        }

        function setRateLimitTimestamp() {
            if (!isTestMode) {
                localStorage.setItem('suitegpt_last_import', new Date().toISOString());
            }
        }

        const loadTestDataBtn = document.getElementById('loadTestData');
        loadTestDataBtn.addEventListener('click', async () => {
            isTestMode = true;
            loadTestDataBtn.textContent = 'Loading test data...';

            try {
                const response = await fetch('/test-data/sample-chatgpt-export.json');
                if (!response.ok) throw new Error('Could not load test data');

                const testData = await response.json();
                const blob = new Blob([JSON.stringify(testData)], { type: 'application/json' });
                const fakeFile = new File([blob], 'test-conversations.json', { type: 'application/json' });

                processFile(fakeFile);
            } catch (error) {
                console.error('Error loading test data:', error);
                alert('Could not load test data. Try uploading your own file.');
                loadTestDataBtn.textContent = 'Load sample data to test the flow';
            }
        });

        function resetImportModal() {
            importStepUpload.style.display = 'block';
            importProgress.classList.remove('active');
            importResults.classList.remove('active');
            importProgressFill.style.width = '0%';
            importFileInput.value = '';
            isTestMode = false;
            loadTestDataBtn.textContent = 'Load sample data to test the flow';
        }

        async function processFile(file) {
            const rateCheck = checkRateLimit();
            if (!rateCheck.allowed) {
                alert(`You can only import once per day. Please try again in ${rateCheck.hoursLeft} hours.`);
                return;
            }

            const consentAnalyze = document.getElementById('consentAnalyze').checked;
            if (!consentAnalyze) {
                alert('Please consent to analysis to continue.');
                return;
            }

            importStepUpload.style.display = 'none';
            importProgress.classList.add('active');
            updateProgress(10, 'Reading file...');

            try {
                let conversations = [];

                if (file.name.endsWith('.zip')) {
                    updateProgress(20, 'Extracting zip file...');
                    const JSZip = await loadJSZip();
                    const zip = await JSZip.loadAsync(file);
                    const conversationsFile = zip.file('conversations.json');
                    if (conversationsFile) {
                        const content = await conversationsFile.async('string');
                        conversations = JSON.parse(content);
                    } else {
                        throw new Error('conversations.json not found in zip');
                    }
                } else {
                    const content = await file.text();
                    conversations = JSON.parse(content);
                }

                updateProgress(40, 'Parsing conversations...');

                const extractedData = extractMessages(conversations, selectedSource);

                updateProgress(60, 'Analyzing patterns...');

                const analysis = await analyzeChats(extractedData);

                updateProgress(100, 'Complete!');

                setRateLimitTimestamp();

                setTimeout(() => {
                    displayResults(analysis, extractedData);
                }, 500);

            } catch (error) {
                console.error('Import error:', error);
                alert('Error processing file: ' + error.message);
                resetImportModal();
            }
        }

        async function loadJSZip() {
            if (window.JSZip) return window.JSZip;

            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
                script.onload = () => resolve(window.JSZip);
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        function extractMessages(data, source) {
            let messages = [];
            let conversationCount = 0;

            if (source === 'chatgpt') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.mapping) {
                            Object.values(conv.mapping).forEach(node => {
                                if (node.message && node.message.author && node.message.author.role === 'user') {
                                    const content = node.message.content;
                                    if (content && content.parts) {
                                        messages.push(...content.parts.filter(p => typeof p === 'string'));
                                    }
                                }
                            });
                        }
                    });
                }
            } else if (source === 'claude') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.messages) {
                            conv.messages.forEach(msg => {
                                if (msg.role === 'human' || msg.role === 'user') {
                                    messages.push(msg.content || msg.text);
                                }
                            });
                        }
                    });
                }
            } else if (source === 'gemini') {
                if (Array.isArray(data)) {
                    conversationCount = data.length;
                    data.forEach(conv => {
                        if (conv.parts) {
                            conv.parts.forEach(part => {
                                if (part.role === 'user') {
                                    messages.push(part.text);
                                }
                            });
                        }
                    });
                }
            }

            return {
                source,
                conversationCount,
                messageCount: messages.length,
                messages: messages.filter(m => m && m.length > 0)
            };
        }

        async function analyzeChats(extractedData) {
            const consentImprove = document.getElementById('consentImprove').checked;

            const sampleSize = Math.min(extractedData.messages.length, 200);
            const sampledMessages = extractedData.messages
                .sort(() => Math.random() - 0.5)
                .slice(0, sampleSize);

            const messagesSummary = sampledMessages.join('\n---\n').slice(0, 50000);

            try {
                const response = await fetch(`${SUPABASE_URL}/functions/v1/analyze-chat-history`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        messages: messagesSummary,
                        source: extractedData.source,
                        messageCount: extractedData.messageCount,
                        conversationCount: extractedData.conversationCount,
                        storeInsights: consentImprove
                    })
                });

                if (!response.ok) {
                    throw new Error('Analysis API failed');
                }

                return await response.json();
            } catch (error) {
                console.error('API Error, using local analysis:', error);
                return localAnalysis(extractedData);
            }
        }

        function localAnalysis(extractedData) {
            const messages = extractedData.messages;
            const allText = messages.join(' ').toLowerCase();

            const topics = {
                'Health & Fitness': ['workout', 'exercise', 'diet', 'nutrition', 'weight', 'health', 'fitness', 'gym', 'steps', 'walking'],
                'Finance & Money': ['money', 'budget', 'invest', 'savings', 'financial', 'income', 'expenses', 'crypto', 'spending'],
                'Productivity': ['productivity', 'schedule', 'task', 'todo', 'organize', 'habit', 'routine', 'reminder', 'focus', 'pomodoro'],
                'Sleep & Wellness': ['sleep', 'tired', 'insomnia', 'rest', 'meditation', 'stress', 'anxiety', 'mood', 'mental health'],
                'Learning': ['study', 'learn', 'read', 'book', 'course', 'skill', 'flashcard', 'memorize'],
                'Home & Life': ['clean', 'cook', 'meal', 'recipe', 'home', 'pet', 'travel', 'pack']
            };

            const detectedTopics = [];
            for (const [topic, keywords] of Object.entries(topics)) {
                const count = keywords.reduce((acc, keyword) => {
                    const regex = new RegExp(keyword, 'gi');
                    const matches = allText.match(regex);
                    return acc + (matches ? matches.length : 0);
                }, 0);
                if (count > 2) {
                    detectedTopics.push({ topic, count });
                }
            }
            detectedTopics.sort((a, b) => b.count - a.count);

            const recommendations = [];
            // Fitness
            if (allText.includes('fitness') || allText.includes('workout') || allText.includes('exercise')) {
                recommendations.push({ id: 'opticrep', ...SUITE_APPS['opticrep'], matchScore: 88 });
            }
            // Nutrition
            if (allText.includes('nutrition') || allText.includes('food') || allText.includes('diet')) {
                recommendations.push({ id: 'foodvitals', ...SUITE_APPS['foodvitals'], matchScore: 90 });
            }
            // Money
            if (allText.includes('money') || allText.includes('budget') || allText.includes('financial')) {
                recommendations.push({ id: 'quickbudget', ...SUITE_APPS['quickbudget'], matchScore: 85 });
            }
            // Habits
            if (allText.includes('habit') || allText.includes('routine')) {
                recommendations.push({ id: 'habitstack', ...SUITE_APPS['habitstack'], matchScore: 82 });
            }
            // Sleep
            if (allText.includes('sleep') || allText.includes('tired') || allText.includes('insomnia')) {
                recommendations.push({ id: 'sleepwell', ...SUITE_APPS['sleepwell'], matchScore: 87 });
            }
            // Mental health
            if (allText.includes('stress') || allText.includes('anxiety') || allText.includes('mood')) {
                recommendations.push({ id: 'moodlog', ...SUITE_APPS['moodlog'], matchScore: 86 });
            }
            // Focus
            if (allText.includes('focus') || allText.includes('concentrate') || allText.includes('procrastin')) {
                recommendations.push({ id: 'focusflow', ...SUITE_APPS['focusflow'], matchScore: 84 });
            }
            // Reading
            if (allText.includes('book') || allText.includes('read')) {
                recommendations.push({ id: 'bookshelf', ...SUITE_APPS['bookshelf'], matchScore: 80 });
            }
            // Water
            if (allText.includes('water') || allText.includes('hydrat')) {
                recommendations.push({ id: 'hydrotrack', ...SUITE_APPS['hydrotrack'], matchScore: 83 });
            }
            // Meal planning
            if (allText.includes('cook') || allText.includes('meal') || allText.includes('recipe')) {
                recommendations.push({ id: 'mealprep', ...SUITE_APPS['mealprep'], matchScore: 81 });
            }

            const topicIcons = {
                'Health & Fitness': '',
                'Finance & Money': '',
                'Productivity': '',
                'Sleep & Wellness': '',
                'Learning': '',
                'Home & Life': ''
            };

            return {
                topics: detectedTopics.slice(0, 5),
                insights: detectedTopics.slice(0, 3).map(({ topic, count }) => ({
                    category: topic,
                    description: `You frequently discuss ${topic.toLowerCase()} topics (${count}+ mentions)`,
                    icon: topicIcons[topic] || ''
                })),
                recommendations: recommendations.slice(0, 4),
                extractedIdeas: [],
                matchedIdeas: [],
                unmatchedIdeas: [],
                summary: `Based on ${extractedData.messageCount} messages, we found ${detectedTopics.length} main topics of interest.`
            };
        }

        function updateProgress(percent, text) {
            importProgressFill.style.width = percent + '%';
            importProgressText.textContent = text;
        }

        function displayResults(analysis, extractedData) {
            analysisResults = analysis;

            importProgress.classList.remove('active');
            importResults.classList.add('active');

            document.getElementById('statConversations').textContent = extractedData.conversationCount.toLocaleString();
            document.getElementById('statMessages').textContent = extractedData.messageCount.toLocaleString();
            document.getElementById('statTopics').textContent = (analysis.topics?.length || 0);

            const insightsList = document.getElementById('insightsList');
            let insightsHtml = '';

            if (analysis.summary) {
                insightsHtml += `<div class="import-summary-text">${analysis.summary}</div>`;
            }

            insightsHtml += (analysis.insights || []).map(insight => `
                <div class="import-insight-item">
                    <div class="import-insight-icon" style="background: rgba(99, 102, 241, 0.15);">
                        ${insight.icon || ''}
                    </div>
                    <div class="import-insight-content">
                        <h5>${insight.category}</h5>
                        <p>${insight.description}</p>
                    </div>
                </div>
            `).join('');

            insightsList.innerHTML = insightsHtml;

            const recommendationsList = document.getElementById('recommendationsList');
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                recommendationsList.innerHTML = analysis.recommendations.map(app => `
                    <a href="${app.url || '#'}" class="import-app-rec">
                        <div class="import-app-icon" style="background: ${app.iconBg || 'var(--bg-card)'}">
                            ${app.icon || ''}
                        </div>
                        <div class="import-app-info">
                            <h5>${app.name}</h5>
                            <p>${app.description}</p>
                        </div>
                        <div class="import-app-match">${app.matchScore || 85}% match</div>
                    </a>
                `).join('');
            } else {
                recommendationsList.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-tertiary);">
                        <p>No exact matches found, but we can build something custom!</p>
                    </div>
                `;
            }

            const unmatchedSection = document.getElementById('importUnmatched');
            const unmatchedList = document.getElementById('unmatchedList');

            if (analysis.unmatchedIdeas && analysis.unmatchedIdeas.length > 0) {
                unmatchedSection.style.display = 'block';
                unmatchedList.innerHTML = analysis.unmatchedIdeas.map((idea) => `
                    <div class="unmatched-idea">
                        <div class="unmatched-idea-text">"${idea.text}"</div>
                        <div class="unmatched-idea-meta">
                            <span class="unmatched-idea-category">${idea.category}</span>
                            <button class="unmatched-idea-request" data-idea="${encodeURIComponent(idea.text)}">
                                Request This App 
                            </button>
                        </div>
                    </div>
                `).join('');

                unmatchedList.querySelectorAll('.unmatched-idea-request').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const idea = decodeURIComponent(btn.dataset.idea);
                        requestAppIdea(idea);
                    });
                });
            } else {
                unmatchedSection.style.display = 'none';
            }
        }

        function requestAppIdea(idea) {
            importModal.classList.remove('active');

            welcomeState.classList.add('chat-active');
            chatContainer.classList.add('active');
            showInsightsPanel();

            const message = `I'd like to request an app that: ${idea}`;

            addMessage(message, 'user');
            conversationHistory.push({ role: 'user', content: message });

            addTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                const response = `Great idea! We can build this for you.\n\n` +
                    `Here's how it works:\n` +
                    `1. We'll review your request\n` +
                    `2. AI Fleet will design and build the app\n` +
                    `3. You'll have it within 1-12 hours\n\n` +
                    `Want to submit this request?`;
                addMessage(response, 'assistant');
                conversationHistory.push({ role: 'assistant', content: response });
            }, 1500);
        }

        importDone.addEventListener('click', () => {
            importModal.classList.remove('active');
        });

        importRequestCustom.addEventListener('click', () => {
            importModal.classList.remove('active');

            if (analysisResults && analysisResults.summary) {
                welcomeState.classList.add('chat-active');
                chatContainer.classList.add('active');
                showInsightsPanel();

                const message = `Based on my chat history, I'm interested in: ${analysisResults.topics?.slice(0, 3).map(t => t.topic).join(', ')}. Can you help me find or build something for this?`;

                addMessage(message, 'user');
                conversationHistory.push({ role: 'user', content: message });

                addTypingIndicator();
                setTimeout(() => {
                    removeTypingIndicator();
                    const response = `Great! Based on your interests, I can see you're focused on ${analysisResults.topics?.[0]?.topic?.toLowerCase() || 'several areas'}.\n\nWe can either:\n1. Set you up with existing apps that match your needs\n2. Build something custom tailored to your specific workflow\n\nWhat sounds better to you?`;
                    addMessage(response, 'assistant');
                    conversationHistory.push({ role: 'assistant', content: response });
                }, 1500);
            }
        });

        // ============================================
        // PWA SERVICE WORKER REGISTRATION
        // ============================================

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/suitegpt-sw.js')
                    .then((registration) => {
                        console.log('SuiteGPT SW registered:', registration.scope);
                    })
                    .catch((error) => {
                        console.log('SuiteGPT SW registration failed:', error);
                    });
            });
        }

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            setTimeout(() => {
                showInstallPrompt();
            }, 30000);
        });

        function showInstallPrompt() {
            if (!deferredPrompt) return;

            if (sessionStorage.getItem('pwa-prompt-shown')) return;
            sessionStorage.setItem('pwa-prompt-shown', 'true');

            const promptDiv = document.createElement('div');
            promptDiv.className = 'pwa-install-prompt visible';
            promptDiv.innerHTML = `
                <div class="pwa-install-content">
                    <div class="pwa-install-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="5" y="2" width="14" height="20" rx="2" ry="2"/>
                            <line x1="12" y1="18" x2="12.01" y2="18"/>
                        </svg>
                    </div>
                    <div class="pwa-install-text">
                        <h4>Add SuiteGPT to Home Screen</h4>
                        <p>Quick access to your app concierge anytime</p>
                    </div>
                </div>
                <div class="pwa-install-actions">
                    <button class="pwa-install-btn secondary" id="pwaLater">Later</button>
                    <button class="pwa-install-btn primary" id="pwaInstall">Add to Home</button>
                </div>
            `;
            document.body.appendChild(promptDiv);

            document.getElementById('pwaInstall').addEventListener('click', async () => {
                promptDiv.remove();
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                console.log('PWA install outcome:', outcome);
                deferredPrompt = null;
            });

            document.getElementById('pwaLater').addEventListener('click', () => {
                promptDiv.remove();
            });
        }
    </script>

    <!-- Agent Telos Modal -->
    <div class="swarm-telos-modal-overlay" id="agentTelosModal" style="display:none;" onclick="if(event.target===this)closeAgentTelos()">
        <div class="swarm-telos-modal">
            <div class="swarm-telos-modal-header">
                <h3 id="agentTelosName">Agent Telos</h3>
                <button class="swarm-telos-modal-close" onclick="closeAgentTelos()">&times;</button>
            </div>
            <div class="swarm-telos-meta" id="agentTelosMeta"></div>
            <div class="swarm-telos-objective" id="agentTelosObjective">
                <h4>Current Objective</h4>
                <p>Loading...</p>
            </div>
            <div class="swarm-telos-pending" id="agentTelosPending" style="display:none;">
            </div>
            <div class="swarm-telos-updates" id="agentTelosUpdates">
                <h4>Recent Activity</h4>
            </div>
            <div class="swarm-telos-doc-section" id="agentTelosDocs">
                <h4>Telos Documents
                    <button class="swarm-telos-doc-toggle active" onclick="showTelosDoc('small')" id="telosDocSmallBtn">Small Telos</button>
                    <button class="swarm-telos-doc-toggle" onclick="showTelosDoc('large')" id="telosDocLargeBtn">Full Telos</button>
                </h4>
                <div class="swarm-telos-doc-content" id="telosDocContent">
                    <p style="color:var(--text-tertiary)">Select a document to view...</p>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
