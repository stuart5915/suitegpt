<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Wallet | SUITE</title>
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <meta name="description"
        content="Your SUITE Wallet - deposit, withdraw, earn with Community Arbitrage, and view Treasury stats.">
    <!-- Ethers.js for blockchain interactions -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="/suite-styles.css">
    <link rel="stylesheet" href="/nav.css">
    <style>
        /* ============================================
           BUBBLY WALLET PAGE - PancakeSwap Vibes
           ============================================ */

        :root {
            --gradient-warm: linear-gradient(135deg, #fff5eb 0%, #ffe4d4 20%, #ffd4e3 50%, #e8d5f9 80%, #d4e5ff 100%);
            --accent-orange: #ff9500;
            --accent-pink: #ff6b9d;
            --accent-purple: #a855f7;
            --text-dark: #2d1b4e;
            --text-medium: #5a4a6f;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.12);
            --radius-xl: 28px;
            --radius-lg: 20px;
        }

        /* Universal box-sizing */
        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--gradient-warm);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
            overflow-y: scroll;
        }

        /* Animated background blobs */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        .blob-1 {
            width: 500px;
            height: 500px;
            background: #ffb3d9;
            top: -100px;
            left: -100px;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: #b3d4ff;
            top: 50%;
            right: -100px;
            animation-delay: -5s;
        }

        .blob-3 {
            width: 350px;
            height: 350px;
            background: #ffe0b3;
            bottom: -50px;
            left: 30%;
            animation-delay: -10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -30px) scale(1.05);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.95);
            }
        }

        @keyframes float-reverse {

            0%,
            100% {
                transform: scaleX(-1) translate(0, 0);
            }

            33% {
                transform: scaleX(-1) translate(-30px, 30px);
            }

            66% {
                transform: scaleX(-1) translate(20px, -20px);
            }
        }

        /* Ensure CTA button stays white */
        .nav-links a.nav-cta,
        .nav-links a.nav-cta:hover,
        .nav-links a.nav-cta:active {
            color: #ffffff !important;
        }

        /* Wallet Page Container */
        .wallet-page {
            padding-top: 100px;
            min-height: 100vh;
            position: relative;
        }

        .wallet-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px 24px 16px;
        }

        /* Hero Header with Gradient Title */
        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .wallet-header h1 {
            font-size: 2rem;
            font-weight: 900;
            font-style: italic;
            background: linear-gradient(135deg, #ff9500 0%, #ff6b9d 50%, #ff9a8b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: bounce-in 0.6s ease;
        }

        @keyframes bounce-in {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-radius: 100px;
            font-family: monospace;
            font-size: 0.9rem;
            box-shadow: var(--shadow-soft);
        }

        .wallet-address .dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(0.85);
                opacity: 0.7;
            }
        }

        .disconnect-btn {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-medium);
            padding: 10px 20px;
            border-radius: 100px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .disconnect-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
            transform: translateY(-2px);
        }

        .connect-btn-inline {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 100px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(255, 149, 0, 0.3);
        }

        .connect-btn-inline:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 40px rgba(255, 149, 0, 0.4);
        }

        /* Main Content Wrapper - Unified Container */
        .wallet-main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        .wallet-dashboard {
            width: 100%;
            display: block;
        }

        /* UX Notice - Subtle inside wrapper */
        .ux-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 149, 0, 0.06);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ux-notice-icon {
            font-size: 1.4rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        .ux-notice-text {
            font-size: 0.85rem;
            color: var(--text-medium);
            line-height: 1.5;
        }

        .ux-notice-text strong {
            color: var(--accent-orange);
            font-weight: 700;
        }

        /* Glassmorphism Balance Cards */
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .balance-card {
            padding: 14px 12px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .balance-card:hover {
            transform: translateY(-4px);
        }

        .balance-card.primary {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 107, 157, 0.08));
            border-radius: var(--radius-lg);
        }

        .balance-label {
            font-size: 0.7rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .balance-value {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-dark), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .balance-sub {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 4px;
            font-weight: 600;
        }

        /* Add to Wallet Button */
        .add-to-wallet-btn {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-medium);
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-soft);
        }

        .add-to-wallet-btn:hover {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            background: rgba(255, 149, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Treasury Stats - Glassmorphism */
        .treasury-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .treasury-stat {
            flex: 1;
            min-width: 160px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(34, 197, 94, 0.06);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .treasury-stat:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .treasury-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            font-weight: 600;
        }

        .treasury-value {
            font-size: 1rem;
            font-weight: 800;
            color: #22c55e;
        }

        .treasury-value-stacked {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .treasury-usd {
            font-size: 1.1rem;
            font-weight: 800;
            color: #22c55e;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .treasury-eth {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-medium);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* Admin Panel - Keep functional but style-update */
        .admin-panel {
            border: 2px solid #ef4444 !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.02)) !important;
        }

        .admin-notice {
            color: #ef4444;
            font-size: 0.9rem;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .admin-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .admin-stat {
            flex: 1;
            background: rgba(239, 68, 68, 0.1);
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .admin-label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .admin-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #ef4444;
            font-family: 'SF Mono', monospace;
        }

        .admin-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .admin-btn {
            flex: 1;
            padding: 14px 18px;
            border-radius: 100px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: none;
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: white;
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.25);
        }

        .admin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.35);
        }

        .admin-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
        }

        .admin-btn.danger:hover {
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.35);
        }

        .admin-btn.secondary {
            background: var(--card-bg);
            color: var(--text-dark);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: var(--shadow-soft);
        }

        .admin-ownership {
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            padding-top: 18px;
        }

        .admin-ownership h4 {
            margin-bottom: 12px;
            color: var(--text-medium);
            font-size: 0.9rem;
            font-weight: 700;
        }

        .admin-input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 100px;
            background: var(--card-bg);
            color: var(--text-dark);
            margin-bottom: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.1);
        }

        /* Action Buttons - Bouncy */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border-radius: 100px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.deposit {
            background: linear-gradient(135deg, #22c55e, #10b981);
            border: none;
            color: white;
            box-shadow: 0 8px 28px rgba(34, 197, 94, 0.3);
        }

        .action-btn.deposit:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 14px 40px rgba(34, 197, 94, 0.4);
        }

        .action-btn.withdraw {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-dark);
            box-shadow: var(--shadow-soft);
        }

        .action-btn.withdraw:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn.stake {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));
            border: 2px solid rgba(168, 85, 247, 0.3);
            color: var(--accent-purple);
        }

        .action-btn.stake:hover {
            transform: translateY(-4px);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2);
        }

        /* Sections - Glassmorphism */
        .wallet-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
            position: relative;
            z-index: 10;
        }

        .wallet-section h3 {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dark);
        }

        /* Transaction History */
        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .tx-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tx-action {
            font-weight: 500;
        }

        .tx-date {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .tx-amount {
            font-weight: 600;
        }

        .tx-amount.positive {
            color: #22c55e;
        }

        .tx-amount.negative {
            color: #ef4444;
        }

        /* Voting Section */
        .vote-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vote-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vote-option:hover {
            border-color: var(--accent-primary);
        }

        .vote-option input {
            display: none;
        }

        .vote-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            position: relative;
        }

        .vote-option input:checked+.vote-radio {
            border-color: var(--accent-primary);
        }

        .vote-option input:checked+.vote-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .vote-label {
            flex: 1;
        }

        .vote-count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .vote-btn {
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Connected Apps */
        .apps-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .app-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .app-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.1));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .app-name {
            font-weight: 500;
        }

        .app-status {
            font-size: 0.75rem;
            color: #22c55e;
        }

        /* UX Notice */
        .ux-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(168, 85, 247, 0.05));
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .ux-notice-icon {
            font-size: 1.5rem;
        }

        .ux-notice-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .ux-notice-text strong {
            color: #22d3ee;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 10000;
            pointer-events: auto;
        }

        .modal * {
            pointer-events: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.4rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px 12px;
            position: relative;
            z-index: 1001;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Amount Selector */
        .amount-selector {
            margin-bottom: 24px;
        }

        .amount-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .amount-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .amount-option {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .amount-option:hover,
        .amount-option.selected {
            border-color: var(--accent-primary);
            background: rgba(168, 85, 247, 0.1);
        }

        .custom-amount {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-amount input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .custom-amount input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .suite-preview {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), transparent);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .suite-preview-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .suite-preview-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Payment Options */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-option:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .payment-icon {
            font-size: 1.5rem;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .payment-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .payment-arrow {
            color: var(--text-tertiary);
        }

        /* Withdraw specific */
        .balance-display {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .balance-display-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .balance-display-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .fee-notice {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 16px;
        }

        /* Boost Cards */
        .boost-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 149, 0, 0.1);
            border: 2px solid rgba(255, 149, 0, 0.2);
            padding: 12px 16px;
            border-radius: 14px;
            transition: all 0.2s;
        }

        .boost-item:hover {
            border-color: var(--accent-orange);
            transform: translateY(-2px);
        }

        .boost-item-icon {
            font-size: 1.5rem;
        }

        .boost-item-info {
            flex: 1;
        }

        .boost-item-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .boost-item-status {
            font-size: 0.75rem;
            color: var(--text-medium);
        }

        .boost-item-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .boost-item-btn.mint {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
            color: white;
        }

        .boost-item-btn.mint:hover {
            transform: scale(1.05);
        }

        .boost-item-btn.redeem {
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: white;
        }

        .boost-item-btn.redeem:hover {
            transform: scale(1.05);
        }

        .boost-item-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .info-tooltip {
            cursor: help;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .info-tooltip:hover {
            opacity: 1;
        }

        /* New Dashboard Grid Layout */
        .wallet-grid {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .wallet-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Glassmorphism Card Base */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            box-sizing: border-box;
            width: 100%;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }

        /* Vault Hero Card Specifics - Horizontal */
        .vault-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 248, 240, 0.8));
            border: 2px solid rgba(255, 149, 0, 0.1);
            display: flex;
            flex-direction: row;
            /* Horizontal layout */
            justify-content: space-between;
            align-items: center;
            padding: 30px 40px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            flex-wrap: wrap;
            gap: 20px;
        }

        .vault-content-left {
            text-align: left;
        }

        .vault-content-right {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .dashboard-bottom {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .vault-card {
                flex-direction: column;
                text-align: center;
            }

            .vault-content-left {
                text-align: center;
            }

            .vault-content-right {
                flex-direction: column;
                width: 100%;
            }

            .dashboard-bottom {
                gap: 16px;
            }

            /* Stack Treasury Vault and Open Market cards vertically on mobile */
            .wallet-main-content>div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        .vault-balance-large {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #2d1b4e 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            line-height: 1.1;
        }

        .vault-actions-row {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            width: 100%;
            justify-content: center;
        }

        .btn-deposit-hero {
            padding: 16px 40px;
            font-size: 1.1rem;
            border-radius: 18px;
            background: linear-gradient(135deg, #ff9500, #ff7b00);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
            color: white;
            font-weight: 800;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-withdraw-hero {
            padding: 16px 40px;
            font-size: 1.1rem;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #2d1b4e;
            color: #2d1b4e;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-withdraw-hero:hover {
            background: rgba(45, 27, 78, 0.05);
            transform: translateY(-2px);
        }

        /* Right Sidebar Stack */
        .sidebar-stack {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-pill {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #2d1b4e;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Tabs */
        .wallet-tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .wallet-tab {
            padding: 12px 4px;
            font-weight: 700;
            color: var(--text-tertiary);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .wallet-tab.active {
            color: var(--accent-primary);
        }

        .wallet-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-primary);
            border-radius: 2px;
        }

        /* Connect Buttons Hover Effects */
        #discordLoginBtn2:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
        }

        #connectWalletBtn2:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 149, 0, 0.4);
        }

        /* Yield Allocation Slider Styles */
        .yield-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
        }

        .yield-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.15s ease;
        }

        .yield-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .yield-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .yield-slider::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }

        /* Mobile Styles - 600px */
        @media (max-width: 600px) {
            .wallet-page {
                padding-top: 80px;
            }

            .wallet-container {
                padding: 0 12px 20px;
                max-width: 100%;
                width: 100%;
            }

            .wallet-dashboard,
            .wallet-main-content {
                width: 100% !important;
                display: block !important;
            }

            /* Hide floating mascot on mobile */
            .wallet-mascot {
                display: none !important;
            }

            .wallet-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
                display: block !important;
                margin-bottom: 0 !important;
            }

            .wallet-header h1 {
                font-size: 1.6rem;
            }

            .wallet-address {
                padding: 10px 16px;
                font-size: 0.8rem;
                width: 100%;
                justify-content: center;
            }

            .vault-card {
                padding: 20px 16px;
            }

            .vault-balance-large {
                font-size: 2.5rem;
            }

            .vault-actions-row {
                flex-direction: column;
                gap: 10px;
                margin-top: 20px;
            }

            .btn-deposit-hero,
            .btn-withdraw-hero {
                width: 100%;
                padding: 14px 24px;
                font-size: 1rem;
                justify-content: center;
            }

            .glass-card {
                padding: 16px;
                border-radius: 16px;
            }

            .modal {
                padding: 20px;
                border-radius: 16px;
                width: 95%;
            }

            .modal-header h2 {
                font-size: 1.1rem;
            }

            .payment-options {
                gap: 10px;
            }

            .payment-option {
                padding: 14px;
            }

            .payment-icon {
                font-size: 1.3rem;
            }

            .payment-title {
                font-size: 0.9rem;
            }

            .payment-desc {
                font-size: 0.75rem;
            }

            .amount-options {
                grid-template-columns: repeat(2, 1fr);
                gap: 8px;
            }

            .amount-option {
                padding: 12px 8px;
                font-size: 0.9rem;
            }

            /* AI Fleet Vault mobile styles */
            #vaultDetailsPanel > div:first-child {
                grid-template-columns: 1fr !important;
            }

            /* Credits Overview mobile - stats row */
            .glass-card > div:first-child {
                flex-direction: column !important;
                align-items: flex-start !important;
            }

            /* AI Fleet Vault header - stack on mobile */
            .glass-card > div[style*="justify-content: space-between"] {
                flex-direction: column !important;
                align-items: flex-start !important;
                gap: 16px !important;
            }

            /* Action buttons row */
            .glass-card > div[style*="justify-content: space-between"] > div:last-child {
                width: 100%;
            }

            .glass-card > div[style*="justify-content: space-between"] > div:last-child button {
                flex: 1;
            }
        }

        /* Mobile Styles - 480px */
        @media (max-width: 480px) {
            .wallet-container {
                padding: 0 10px 16px;
                max-width: 100%;
                width: 100%;
            }

            .wallet-dashboard,
            .wallet-main-content {
                width: 100% !important;
                display: block !important;
            }

            .wallet-mascot {
                display: none !important;
            }

            .wallet-header {
                display: block !important;
                margin-bottom: 0 !important;
            }

            .wallet-header h1 {
                font-size: 1.4rem;
            }

            .wallet-address {
                font-size: 0.75rem;
                padding: 8px 12px;
            }

            .vault-card {
                padding: 16px 12px;
            }

            .vault-balance-large {
                font-size: 2rem;
            }

            .vault-label {
                font-size: 0.85rem;
            }

            .btn-deposit-hero,
            .btn-withdraw-hero {
                padding: 12px 20px;
                font-size: 0.9rem;
            }

            .glass-card {
                padding: 14px;
                width: 100%;
                box-sizing: border-box;
            }

            .modal {
                padding: 16px;
            }

            .modal-header {
                padding-bottom: 12px;
                margin-bottom: 16px;
            }

            .modal-header h2 {
                font-size: 1rem;
            }

            .tab-btn {
                padding: 10px 12px;
                font-size: 0.8rem;
            }

            .stat-value {
                font-size: 1.3rem;
            }

            .stat-label {
                font-size: 0.7rem;
            }

            /* Deposit/Withdraw buttons stack vertically */
            #vaultDetailsPanel > div:first-child > div {
                padding: 16px !important;
            }

            #vaultDetailsPanel > div:first-child > div > div:last-child {
                flex-direction: column !important;
            }

            #vaultDetailsPanel > div:first-child > div > div:last-child button {
                width: 100% !important;
                padding: 12px 16px !important;
            }

            /* Vault header stats */
            .glass-card > div > div[style*="gap: 24px"] {
                gap: 12px !important;
            }
        }

        /* Very small screens - 380px */
        @media (max-width: 380px) {
            .wallet-container {
                padding: 0 8px 16px;
                max-width: 100%;
                width: 100%;
            }

            .wallet-dashboard,
            .wallet-main-content {
                width: 100% !important;
                display: block !important;
            }

            .wallet-mascot {
                display: none !important;
            }

            .wallet-header {
                display: block !important;
                margin-bottom: 0 !important;
            }

            .vault-balance-large {
                font-size: 1.8rem;
            }

            .amount-options {
                grid-template-columns: 1fr 1fr;
            }

            .amount-option {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            /* Credits balance smaller on tiny screens */
            #userCreditsBalance {
                font-size: 1.8rem !important;
            }

            /* USDC icon smaller on tiny screens */
            .glass-card img[alt="USDC"] {
                width: 40px !important;
                height: 40px !important;
            }
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav id="main-nav"></nav>
    <script src="/nav-component.js"></script>

    <!-- Animated Background Blobs -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <main class="wallet-page">
        <div class="wallet-container">
            <!-- Clay Treasure Chest - Fixed to right side of page (behind everything) -->
            <img src="/assets/clay/treasure-chest.png" alt=""
                style="position: absolute; top: 700px; right: 50px; width: 630px; height: auto; opacity: 1; pointer-events: none; z-index: 0;" />

            <!-- Wallet Dashboard (always visible) -->
            <section class="wallet-dashboard connected" id="walletDashboard" style="display: block; width: 100%;">

                <!-- Header with Clay Mascot (no wallet address here anymore) -->
                <div class="wallet-header" style="position: relative; display: block; margin-bottom: 0;">
                    <!-- Clay Wallet with Wings Mascot -->
                    <img src="/assets/clay/wallet-wings.png" alt="" class="wallet-mascot"
                        style="position: absolute; top: 0px; left: -250px; width: 420px; height: auto; opacity: 0.9; pointer-events: none; animation: float 4s ease-in-out infinite;" />
                </div>

                <!-- Main Content Wrapper -->
                <div class="wallet-main-content" style="position: relative; z-index: 10; width: 100%;">

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- CREDITS OVERVIEW - Primary Balance Display -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div class="glass-card" style="background: linear-gradient(135deg, #0a0a1a, #1a1a2e); border: 1px solid rgba(255, 149, 0, 0.2); padding: 24px; margin-bottom: 20px;">

                        <!-- Credits Balance Row -->
                        <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 16px;">
                                <div style="width: 56px; height: 56px; background: linear-gradient(135deg, #ff9500, #ff6b9d); border-radius: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                    <span style="font-size: 1.5rem;">âš¡</span>
                                </div>
                                <div>
                                    <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">Your Credits</div>
                                    <div id="userCreditsBalance" style="font-size: 2.2rem; font-weight: 900; background: linear-gradient(135deg, #ff9500, #ff6b9d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0</div>
                                </div>
                            </div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                                <div style="text-align: center; padding: 10px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Earning Rate</div>
                                    <div style="font-weight: 700; color: #22c55e; font-size: 0.95rem;">+<span id="creditEarningRate">0</span>/mo</div>
                                </div>
                                <div style="text-align: center; padding: 10px 16px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;">
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">$ Value</div>
                                    <div id="creditsUsdValue" style="font-weight: 700; color: #ffffff; font-size: 0.95rem;">$0.00</div>
                                </div>
                            </div>
                        </div>

                        <!-- How It Works - Collapsible (attached to Credits) -->
                        <div style="border-top: 1px solid rgba(255, 149, 0, 0.15); padding-top: 16px;">
                            <div onclick="toggleCreditsInfo()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1rem;">ðŸ’¡</span>
                                    <span style="font-size: 0.9rem; font-weight: 700; color: #ffffff;">How It Works</span>
                                </div>
                                <span id="creditsInfoToggle" style="font-size: 1rem; color: #6b7280; transition: transform 0.3s;">â–¼</span>
                            </div>

                            <!-- Expandable Content -->
                            <div id="creditsInfoContent" style="display: none; margin-top: 16px;">

                                <!-- Credit Conversion -->
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px; text-align: center;">
                                    <div style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 8px;">Conversion Rate</div>
                                    <div style="font-size: 1.6rem; font-weight: 800; background: linear-gradient(135deg, #ff9500, #ff6b9d); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">$1 USD = 1,000 SUITE</div>
                                    <div style="font-size: 0.85rem; color: #6b7280; margin-top: 4px;">1 SUITE = $0.001</div>
                                </div>

                                <!-- The Flow - Visual Steps -->
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 0.85rem; font-weight: 700; color: #ffffff; margin-bottom: 12px;">The Credit Flow</div>

                                    <!-- Step 1: Get Credits -->
                                    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;">
                                        <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #22c55e, #10b981); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.75rem; flex-shrink: 0;">1</div>
                                        <div>
                                            <div style="font-weight: 700; color: #ffffff; font-size: 0.85rem;">Get Credits</div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5;">
                                                <span style="color: #3b82f6;">Card/Fiat</span> â€¢ <span style="color: #22c55e;">Crypto</span> â€¢ <span style="color: #a855f7;">Watch Ads</span> â€¢ <span style="color: #ff9500;">Stake LP</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Step 2: Link Identity -->
                                    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;">
                                        <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #5865F2, #4752C4); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.75rem; flex-shrink: 0;">2</div>
                                        <div>
                                            <div style="font-weight: 700; color: #ffffff; font-size: 0.85rem;">Link Your Identity</div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5;">Connect Discord to use credits across all SUITE apps</div>
                                        </div>
                                    </div>

                                    <!-- Step 3: Use in Apps -->
                                    <div style="display: flex; gap: 12px; margin-bottom: 12px; align-items: flex-start;">
                                        <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #a855f7, #8b5cf6); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.75rem; flex-shrink: 0;">3</div>
                                        <div>
                                            <div style="font-weight: 700; color: #ffffff; font-size: 0.85rem;">Use Credits in Apps</div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5;">AI features show credit cost â†’ Pay per use</div>
                                        </div>
                                    </div>

                                    <!-- Step 4: Top Up -->
                                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                                        <div style="width: 24px; height: 24px; background: linear-gradient(135deg, #ff9500, #ff6b9d); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: white; font-weight: 800; font-size: 0.75rem; flex-shrink: 0;">4</div>
                                        <div>
                                            <div style="font-weight: 700; color: #ffffff; font-size: 0.85rem;">Top Up Anytime</div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5;">Deposit more, watch ads, or earn yield passively</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- AI Feature Costs -->
                                <div style="background: rgba(168,85,247,0.1); border: 1px solid rgba(168,85,247,0.2); border-radius: 12px; padding: 12px; margin-bottom: 12px;">
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7; margin-bottom: 10px;">Typical AI Costs</div>
                                    <div style="display: flex; gap: 8px; flex-wrap: wrap; justify-content: center;">
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1rem; font-weight: 800; color: #ffffff;">5</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Chat</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1rem; font-weight: 800; color: #ffffff;">10</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Photo</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1rem; font-weight: 800; color: #ffffff;">10-20</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Pro AI</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); padding: 8px 12px; border-radius: 8px; text-align: center;">
                                            <div style="font-size: 1rem; font-weight: 800; color: #22c55e;">FREE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Local</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Vault Info -->
                                <div style="background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.2); border-radius: 12px; padding: 12px; margin-bottom: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                        <span style="font-size: 0.9rem;">ðŸ¦</span>
                                        <span style="font-size: 0.75rem; font-weight: 700; color: #ff9500;">AI Fleet Vault</span>
                                    </div>
                                    <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.5; margin-bottom: 8px;">
                                        Deposit USDC â†’ earn <strong style="color: #22c55e;">~42% APY</strong> â†’ split yield between you (up to 90%) and apps (min 10%)
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; text-align: center;">
                                            <div style="font-size: 0.65rem; color: #ff9500; font-weight: 700;">YOUR YIELD</div>
                                            <div style="font-size: 0.7rem; color: #9ca3af;">Up to 90%</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px; text-align: center;">
                                            <div style="font-size: 0.65rem; color: #a855f7; font-weight: 700;">APP FUNDING</div>
                                            <div style="font-size: 0.7rem; color: #9ca3af;">Min 10%</div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Withdrawable Info -->
                                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 12px;">
                                    <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 8px;">
                                        <span style="font-size: 0.9rem;">ðŸ”“</span>
                                        <span style="font-size: 0.75rem; font-weight: 700; color: #22c55e;">Your Crypto is Always Yours</span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px;">
                                            <div style="font-size: 0.65rem; color: #22c55e; font-weight: 700; margin-bottom: 2px;">âœ“ WITHDRAWABLE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Crypto deposits, LP tokens, yield</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 6px; padding: 8px;">
                                            <div style="font-size: 0.65rem; color: #ef4444; font-weight: 700; margin-bottom: 2px;">âœ— NOT WITHDRAWABLE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af;">Fiat purchases, ad rewards</div>
                                        </div>
                                    </div>
                                </div>

                            </div>
                        </div>

                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <!-- YOUR PROFILE - Collapsible Section -->
                        <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                        <div style="border-top: 1px solid rgba(255, 149, 0, 0.15); padding-top: 16px; margin-top: 16px;">
                            <div onclick="toggleProfileSection()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 1rem;">ðŸ‘¤</span>
                                    <span style="font-size: 0.9rem; font-weight: 700; color: #ffffff;">Your Profile</span>
                                    <span id="profileFactoryRep" style="font-size: 0.7rem; background: rgba(255, 149, 0, 0.2); color: #ff9500; padding: 2px 8px; border-radius: 100px; font-weight: 700; display: none;">â—ˆ 0 REP</span>
                                </div>
                                <span id="profileToggle" style="font-size: 1rem; color: #6b7280; transition: transform 0.3s;">â–¼</span>
                            </div>

                            <!-- Profile Expandable Content -->
                            <div id="profileContent" style="display: none; margin-top: 16px;">

                                <!-- Connected Accounts -->
                                <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Connected Accounts</div>

                                    <!-- Wallet Connection -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px; margin-bottom: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.1rem;">ðŸ”—</span>
                                            <div>
                                                <div style="font-size: 0.8rem; font-weight: 600; color: #ffffff;" id="profileWalletAddress">No wallet connected</div>
                                                <div style="font-size: 0.65rem; color: #6b7280;">Primary Wallet</div>
                                            </div>
                                        </div>
                                        <div id="profileWalletStatus" style="font-size: 0.7rem; padding: 4px 10px; border-radius: 100px; font-weight: 600; background: rgba(239, 68, 68, 0.2); color: #ef4444;">Not Connected</div>
                                    </div>

                                    <!-- Telegram Connection -->
                                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.3); border-radius: 8px;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <span style="font-size: 1.1rem;">ðŸ“±</span>
                                            <div>
                                                <div style="font-size: 0.8rem; font-weight: 600; color: #ffffff;" id="profileTelegramUsername">Not linked</div>
                                                <div style="font-size: 0.65rem; color: #6b7280;">Telegram Account</div>
                                            </div>
                                        </div>
                                        <button id="profileTelegramBtn" onclick="linkTelegramFromProfile()" style="font-size: 0.7rem; padding: 4px 12px; border-radius: 100px; font-weight: 600; background: #0088cc; color: white; border: none; cursor: pointer;">Link</button>
                                    </div>
                                </div>

                                <!-- Factory Rep -->
                                <div style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 107, 157, 0.05)); border: 1px solid rgba(255, 149, 0, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.1rem;">ðŸ›ï¸</span>
                                            <span style="font-size: 0.85rem; font-weight: 700; color: #ff9500;">Factory Governance</span>
                                        </div>
                                        <a href="/factory.html" style="font-size: 0.7rem; color: #9ca3af; text-decoration: none;">View Factory â†’</a>
                                    </div>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 900; color: #ff9500;" id="profileRepScore">0</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Reputation</div>
                                        </div>
                                        <div style="background: rgba(0,0,0,0.3); border-radius: 8px; padding: 12px; text-align: center;">
                                            <div style="font-size: 1.5rem; font-weight: 900; color: #a855f7;" id="profileProposals">0</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Proposals</div>
                                        </div>
                                    </div>
                                    <div id="profileFounderBadge" style="display: none; margin-top: 12px; text-align: center;">
                                        <span style="background: linear-gradient(135deg, #ff9500, #ff6b00); color: #000; font-size: 0.7rem; padding: 4px 12px; border-radius: 100px; font-weight: 800;">ðŸ† FOUNDER</span>
                                    </div>
                                </div>

                                <!-- Connected Apps (Coming Soon) -->
                                <div style="background: rgba(255,255,255,0.03); border: 1px dashed rgba(255,255,255,0.1); border-radius: 12px; padding: 16px;">
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 12px;">Connected Apps</div>
                                    <div style="text-align: center; padding: 20px;">
                                        <div style="font-size: 2rem; margin-bottom: 8px; opacity: 0.5;">ðŸ“±</div>
                                        <div style="font-size: 0.85rem; color: #6b7280; margin-bottom: 8px;">Connect apps for personalized AI suggestions</div>
                                        <div style="font-size: 0.75rem; color: #9ca3af;">Coming soon: Strava, MyFitnessPal, Apple Health...</div>
                                    </div>
                                </div>

                            </div>
                        </div>

                    </div>

                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <!-- AI FLEET VAULT - Dark Theme (matches SUITE Shell) -->
                    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                    <div style="margin-bottom: 16px;">

                        <div id="aiFleetVaultCard" class="glass-card"
                            style="background: linear-gradient(135deg, #0a0a1a, #1a1a2e); border: 1px solid rgba(255, 149, 0, 0.2); padding: 24px; position: relative; overflow: hidden; cursor: pointer;"
                            onclick="toggleVaultPanel(event)">

                            <!-- Collapsed Header (always visible) -->
                            <div style="display: flex; align-items: center; justify-content: space-between; gap: 20px;">

                                <!-- Left: Icon + Title -->
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div style="width: 48px; height: 48px; border-radius: 14px; overflow: hidden; flex-shrink: 0;">
                                        <img src="/assets/usdc-logo.png" alt="USDC" style="width: 100%; height: 100%; object-fit: contain;">
                                    </div>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.2rem; font-weight: 800; color: #ffffff;">AI Fleet Vault</span>
                                            <span style="font-size: 0.65rem; background: rgba(34, 197, 94, 0.2); color: #22c55e; padding: 3px 8px; border-radius: 100px; font-weight: 700;">LIVE</span>
                                        </div>
                                        <div style="font-size: 0.8rem; color: #9ca3af; white-space: nowrap;">Deposit USDC â†’ Get Credits + Yield</div>
                                    </div>
                                </div>

                                <!-- Collapsed Stats -->
                                <div style="display: flex; align-items: center; gap: 20px; flex-shrink: 0;">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <div style="text-align: center;">
                                            <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase;">APY</div>
                                            <div style="font-size: 1.1rem; font-weight: 800; color: #22c55e;">~42%</div>
                                        </div>
                                        <div style="font-size: 0.55rem; color: #9ca3af; line-height: 1.4; padding-left: 10px; border-left: 1px solid rgba(255,255,255,0.15);">
                                            <div style="display: flex; align-items: center; gap: 4px;"><span style="color: #22c55e;">â€¢</span> Yearn ~8%</div>
                                            <div style="display: flex; align-items: center; gap: 4px;"><span style="color: #a855f7;">â€¢</span> App Revenue</div>
                                            <div style="display: flex; align-items: center; gap: 4px;"><span style="color: #ff9500;">â€¢</span> Credit Sales</div>
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase;">TVL</div>
                                        <div style="font-size: 1.1rem; font-weight: 800; color: #ff9500;" id="vaultTVL">Loading...</div>
                                    </div>
                                    <script>
                                    (async function() {
                                        try {
                                            const res = await fetch('https://mainnet.base.org', {
                                                method: 'POST',
                                                headers: { 'Content-Type': 'application/json' },
                                                body: JSON.stringify({
                                                    jsonrpc: '2.0',
                                                    method: 'eth_getBalance',
                                                    params: ['0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1', 'latest'],
                                                    id: 1
                                                })
                                            });
                                            const data = await res.json();
                                            const ethBal = parseInt(data.result, 16) / 1e18;
                                            const usdVal = ethBal * 3650;
                                            const el = document.getElementById('vaultTVL');
                                            if (el) {
                                                let txt = usdVal >= 1000000 ? '$' + (usdVal/1000000).toFixed(2) + 'M' :
                                                         usdVal >= 1000 ? '$' + (usdVal/1000).toFixed(1) + 'K' :
                                                         usdVal >= 0.01 ? '$' + usdVal.toFixed(2) :
                                                         usdVal > 0 ? '$' + usdVal.toFixed(6) : '$0.00';
                                                el.textContent = txt;
                                            }
                                        } catch(e) {
                                            const el = document.getElementById('vaultTVL');
                                            if (el) el.textContent = '$0.00';
                                        }
                                    })();
                                    </script>
                                    <!-- Expand Button -->
                                    <button id="vaultExpandBtn" onclick="toggleVaultPanel(event)"
                                        style="padding: 10px 20px; background: linear-gradient(135deg, #ff9500, #ff6b9d); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 0.85rem; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: all 0.3s ease;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(255, 149, 0, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <span>Open Vault</span>
                                    </button>
                                </div>
                            </div>

                            <!-- Expanded Content (hidden by default) -->
                            <div id="vaultExpandedContent" style="display: none; margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255, 149, 0, 0.2);">

                                <!-- Hidden inputs for deposit/withdraw amounts (used by modals) -->
                                <input type="hidden" id="vaultDepositAmount" value="0">
                                <input type="hidden" id="vaultWithdrawAmount" value="0">
                                <input type="hidden" id="depositAssetSelect" value="USDC">

                            <!-- â•â•â• FULL-WIDTH DEPOSIT BAR â•â•â• -->
                            <div id="depositBar" style="margin-top: 24px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.12), rgba(16, 185, 129, 0.08)); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 16px 20px; cursor: pointer; transition: all 0.3s ease;" onclick="toggleDepositPanel(event)">
                                <!-- Collapsed Header (always visible) -->
                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
                                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="width: 40px; height: 40px; background: linear-gradient(135deg, #22c55e, #10b981); border-radius: 10px; display: flex; align-items: center; justify-content: center;">
                                                <img src="/assets/usdc-logo.png" alt="USDC" style="width: 24px; height: 24px;">
                                            </div>
                                            <div>
                                                <div style="font-weight: 700; color: #ffffff; font-size: 0.9rem;">Deposit / Get Credits</div>
                                                <div style="font-size: 0.7rem; color: #9ca3af;">USDC â†’ Credits + Yield</div>
                                            </div>
                                        </div>
                                        <!-- Inline Stats -->
                                        <div style="display: flex; gap: 16px; padding-left: 16px; border-left: 1px solid rgba(255,255,255,0.1);">
                                            <div>
                                                <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Your USDC</div>
                                                <div id="walletUSDCBalance" style="font-weight: 700; color: #ffffff; font-size: 0.95rem;">Connect Wallet</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Your Deposit</div>
                                                <div style="font-weight: 700; color: #a855f7; font-size: 0.95rem;" id="vaultDeposit">$0.00</div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- Deposit Button -->
                                    <button id="depositExpandBtn" onclick="event.stopPropagation(); openDepositOptionsModal()"
                                        style="padding: 12px 24px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; white-space: nowrap; display: flex; align-items: center; gap: 8px;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(34, 197, 94, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                        <span>âš¡ Deposit</span>
                                    </button>
                                </div>

                                <!-- Expanded Content (hidden by default) -->
                                <div id="depositExpandedContent" style="display: none; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(34, 197, 94, 0.2);">

                                    <!-- Tab Buttons -->
                                    <div style="display: flex; gap: 8px; margin-bottom: 20px; background: rgba(0,0,0,0.3); padding: 6px; border-radius: 12px;" onclick="event.stopPropagation()">
                                        <button id="depositTabYieldBtn" onclick="switchDepositInlineTab('yield')" style="flex: 1; padding: 12px 16px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                                            ðŸ“ˆâš¡ Yield Deposit
                                        </button>
                                        <button id="depositTabDirectBtn" onclick="switchDepositInlineTab('direct')" style="flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.05); color: #9ca3af; border: none; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;">
                                            âš¡ Direct Swap
                                        </button>
                                    </div>

                                    <!-- â•â•â• YIELD TAB CONTENT â•â•â• -->
                                    <div id="depositYieldTab">
                                        <!-- Amount Input Row -->
                                        <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                                <div style="flex: 1; position: relative;">
                                                    <input type="text" inputmode="decimal" id="depositAmountInput" placeholder="0.00"
                                                        style="width: 100%; padding: 14px 60px 14px 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 10px; color: #ffffff; font-size: 1.3rem; font-weight: 700; outline: none;"
                                                        oninput="this.value = this.value.replace(/[^0-9.]/g, ''); updateDepositFromInput()"
                                                        onclick="event.stopPropagation()"
                                                        onfocus="this.style.borderColor='#22c55e';"
                                                        onblur="this.style.borderColor='rgba(34, 197, 94, 0.3)';">
                                                    <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-weight: 600;">USDC</span>
                                                </div>
                                                <button onclick="event.stopPropagation(); setMaxDeposit()" style="padding: 14px 20px; background: rgba(34, 197, 94, 0.2); color: #22c55e; border: 1px solid rgba(34, 197, 94, 0.4); border-radius: 10px; font-weight: 700; cursor: pointer;">MAX</button>
                                            </div>
                                            <!-- Percentage Slider -->
                                            <div style="display: flex; align-items: center; gap: 12px;" onclick="event.stopPropagation()">
                                                <input type="range" id="depositPercentSlider" min="0" max="100" value="0" step="1"
                                                    style="flex: 1; accent-color: #22c55e; cursor: pointer;"
                                                    oninput="updateDepositFromSlider(this.value)">
                                                <span id="depositPercentDisplay" style="min-width: 50px; text-align: right; font-weight: 800; color: #22c55e; font-size: 1rem;">0%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #6b7280; margin-top: 4px;">
                                                <span>0%</span>
                                                <span>25%</span>
                                                <span>50%</span>
                                                <span>75%</span>
                                                <span>100%</span>
                                            </div>
                                        </div>

                                        <!-- Yield Split Row -->
                                        <div style="display: flex; align-items: center; gap: 12px; background: rgba(168, 85, 247, 0.15); border: 1px solid rgba(168, 85, 247, 0.25); border-radius: 12px; padding: 12px 14px; margin-bottom: 16px;" onclick="event.stopPropagation()">
                                            <span style="font-size: 0.8rem; color: #a855f7; font-weight: 600; white-space: nowrap;">âš¡ Yield Split:</span>
                                            <input type="range" id="yieldSplitSlider" class="yield-slider" min="10" max="90" value="90"
                                                style="flex: 1; min-width: 80px; accent-color: #a855f7;"
                                                oninput="updateYieldSplit(this.value); updateDepositEstimates();">
                                            <div style="display: flex; align-items: center; gap: 4px; flex-shrink: 0;">
                                                <span style="font-weight: 800; color: #22c55e; font-size: 0.9rem;" id="keepPercentDisplay">90%</span>
                                                <span style="color: #6b7280; font-size: 0.7rem;">you</span>
                                                <span style="color: #6b7280; font-size: 0.7rem;">/</span>
                                                <span style="font-weight: 800; color: #a855f7; font-size: 0.9rem;" id="fundPercentDisplay">10%</span>
                                                <span style="color: #6b7280; font-size: 0.7rem;">apps</span>
                                            </div>
                                        </div>

                                        <!-- Earnings Breakdown -->
                                        <div style="background: rgba(0,0,0,0.15); border-radius: 10px; padding: 14px; margin-bottom: 16px;">
                                            <div style="font-size: 0.75rem; color: #9ca3af; margin-bottom: 10px;">Estimated Yearly Returns</div>
                                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; text-align: center;">
                                                <div>
                                                    <div style="font-size: 0.65rem; color: #6b7280; text-transform: uppercase;">Total Yield</div>
                                                    <div id="estTotalYield" style="font-weight: 800; color: #ffffff; font-size: 1rem;">$0.00</div>
                                                </div>
                                                <div style="border-left: 1px solid rgba(255,255,255,0.1); border-right: 1px solid rgba(255,255,255,0.1);">
                                                    <div style="font-size: 0.65rem; color: #22c55e; text-transform: uppercase;">Back to You</div>
                                                    <div id="estYieldToYou" style="font-weight: 800; color: #22c55e; font-size: 1rem;">$0.00</div>
                                                </div>
                                                <div>
                                                    <div style="font-size: 0.65rem; color: #a855f7; text-transform: uppercase;">Funding Apps</div>
                                                <div id="estYieldToApps" style="font-weight: 800; color: #a855f7; font-size: 1rem;">$0.00</div>
                                            </div>
                                        </div>
                                    </div>

                                        <!-- Action Button with Info -->
                                        <div style="display: flex; align-items: center; gap: 12px;">
                                            <!-- Info Icon with Tooltip -->
                                            <div style="position: relative; display: flex; align-items: center;">
                                                <div class="fees-info-icon" style="width: 36px; height: 36px; background: rgba(99, 102, 241, 0.15); border: 2px solid rgba(99, 102, 241, 0.4); border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; color: #6366f1; font-weight: 700; transition: all 0.2s ease; flex-shrink: 0;"
                                                    onmouseover="this.style.background='rgba(99, 102, 241, 0.25)'; this.style.borderColor='#6366f1'; this.nextElementSibling.style.opacity='1'; this.nextElementSibling.style.visibility='visible';"
                                                    onmouseout="this.style.background='rgba(99, 102, 241, 0.15)'; this.style.borderColor='rgba(99, 102, 241, 0.4)'; this.nextElementSibling.style.opacity='0'; this.nextElementSibling.style.visibility='hidden';">
                                                    i
                                                </div>
                                                <!-- Tooltip -->
                                                <div style="position: absolute; bottom: calc(100% + 10px); left: 0; background: rgba(20, 20, 30, 0.98); border: 1px solid rgba(255,255,255,0.15); border-radius: 12px; padding: 14px 18px; min-width: 180px; opacity: 0; visibility: hidden; transition: all 0.2s ease; z-index: 9999; box-shadow: 0 8px 24px rgba(0,0,0,0.5);">
                                                    <div style="font-weight: 700; color: #ffffff; margin-bottom: 10px; font-size: 0.85rem;">ðŸ’µ Fees</div>
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                                        <span style="color: #9ca3af; font-size: 0.8rem;">Deposit Fee</span>
                                                        <span style="font-weight: 700; color: #22c55e; font-size: 0.8rem;">0%</span>
                                                    </div>
                                                    <div style="display: flex; justify-content: space-between; margin-bottom: 6px;">
                                                        <span style="color: #9ca3af; font-size: 0.8rem;">Withdrawal Fee</span>
                                                        <span style="font-weight: 700; color: #22c55e; font-size: 0.8rem;">0%</span>
                                                    </div>
                                                    <div style="display: flex; justify-content: space-between;">
                                                        <span style="color: #9ca3af; font-size: 0.8rem;">Min App Allocation</span>
                                                        <span style="font-weight: 700; color: #a855f7; font-size: 0.8rem;">10%</span>
                                                    </div>
                                                    <!-- Arrow -->
                                                    <div style="position: absolute; bottom: -6px; left: 18px; transform: rotate(45deg); width: 12px; height: 12px; background: rgba(20, 20, 30, 0.98); border-right: 1px solid rgba(255,255,255,0.15); border-bottom: 1px solid rgba(255,255,255,0.15);"></div>
                                                </div>
                                            </div>
                                            <button onclick="event.stopPropagation(); executeVaultDeposit()"
                                                style="flex: 1; padding: 16px 28px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);"
                                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(34, 197, 94, 0.4)';"
                                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(34, 197, 94, 0.3)';">
                                                âš¡ Deposit & Earn Yield
                                            </button>
                                        </div>
                                    </div><!-- End depositYieldTab -->

                                    <!-- â•â•â• DIRECT SWAP TAB CONTENT â•â•â• -->
                                    <div id="depositDirectTab" style="display: none;">
                                        <!-- Info Banner -->
                                        <div style="background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 12px; padding: 14px; margin-bottom: 16px;">
                                            <div style="display: flex; align-items: flex-start; gap: 10px;">
                                                <span style="font-size: 1.2rem;">âš¡</span>
                                                <div>
                                                    <div style="font-weight: 700; color: #ff9500; font-size: 0.9rem; margin-bottom: 4px;">Instant Credits</div>
                                                    <div style="font-size: 0.75rem; color: #9ca3af; line-height: 1.4;">Swap USDC directly for credits. One-way conversion - no withdrawal, no yield. Just instant credits to use in apps.</div>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Amount Input Row -->
                                        <div style="background: rgba(0,0,0,0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 12px;">
                                                <div style="flex: 1; position: relative;">
                                                    <input type="text" inputmode="decimal" id="directSwapAmountInput" placeholder="0.00"
                                                        style="width: 100%; padding: 14px 60px 14px 16px; background: rgba(255,255,255,0.1); border: 2px solid rgba(255, 149, 0, 0.3); border-radius: 10px; color: #ff9500; font-size: 1.3rem; font-weight: 700; outline: none;"
                                                        oninput="this.value = this.value.replace(/[^0-9.]/g, ''); updateDirectSwapPreview()"
                                                        onclick="event.stopPropagation()"
                                                        onfocus="this.style.borderColor='#ff9500';"
                                                        onblur="this.style.borderColor='rgba(255, 149, 0, 0.3)';">
                                                    <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #9ca3af; font-weight: 600;">USDC</span>
                                                </div>
                                                <button onclick="event.stopPropagation(); setMaxDirectSwap()" style="padding: 14px 20px; background: rgba(255, 149, 0, 0.2); color: #ff9500; border: 1px solid rgba(255, 149, 0, 0.4); border-radius: 10px; font-weight: 700; cursor: pointer;">MAX</button>
                                            </div>
                                            <!-- Percentage Slider -->
                                            <div style="display: flex; align-items: center; gap: 12px;" onclick="event.stopPropagation()">
                                                <input type="range" id="directSwapSlider" min="0" max="100" value="0" step="1"
                                                    style="flex: 1; accent-color: #ff9500; cursor: pointer;"
                                                    oninput="updateDirectSwapFromSlider(this.value)">
                                                <span id="directSwapPercentDisplay" style="min-width: 50px; text-align: right; font-weight: 800; color: #ff9500; font-size: 1rem;">0%</span>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #6b7280; margin-top: 4px;">
                                                <span>0%</span>
                                                <span>25%</span>
                                                <span>50%</span>
                                                <span>75%</span>
                                                <span>100%</span>
                                            </div>
                                        </div>

                                        <!-- Conversion Preview -->
                                        <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="color: #9ca3af; font-size: 0.9rem;">You'll receive:</span>
                                                <span id="directSwapCreditsPreview" style="font-weight: 800; color: #22c55e; font-size: 1.3rem;">0 Credits</span>
                                            </div>
                                            <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px;">$1 USDC = 1,000 SUITE credits</div>
                                        </div>

                                        <!-- Swap Button -->
                                        <button onclick="event.stopPropagation(); executeDirectSwap()"
                                            style="width: 100%; padding: 16px 28px; background: linear-gradient(135deg, #ff9500, #f97316); color: white; border: none; border-radius: 12px; font-weight: 800; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 14px rgba(255, 149, 0, 0.3);"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(255, 149, 0, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(255, 149, 0, 0.3)';">
                                            âš¡ Swap for Credits
                                        </button>
                                    </div><!-- End depositDirectTab -->
                                </div>
                            </div>

                            <!-- â•â•â• FULL-WIDTH WITHDRAW BAR â•â•â• -->
                            <div style="margin-top: 12px; background: rgba(239, 68, 68, 0.08); border: 2px solid rgba(239, 68, 68, 0.25); border-radius: 16px; padding: 16px 20px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; gap: 16px; flex-wrap: wrap;">
                                    <!-- Left: Position Info -->
                                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                                        <div style="display: flex; align-items: center; gap: 10px;">
                                            <div style="width: 40px; height: 40px; background: rgba(239, 68, 68, 0.2); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">ðŸ“¤</div>
                                            <div>
                                                <div style="font-weight: 700; color: #ffffff; font-size: 0.9rem;">Withdraw</div>
                                                <div style="font-size: 0.7rem; color: #9ca3af;">From vault position</div>
                                            </div>
                                        </div>

                                        <!-- Inline Stats -->
                                        <div style="display: flex; gap: 16px; padding-left: 16px; border-left: 1px solid rgba(255,255,255,0.1);">
                                            <div>
                                                <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Vault Share</div>
                                                <div id="userVaultDeposited" style="font-weight: 700; color: #ffffff; font-size: 0.95rem;">$0.00</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Credits Used</div>
                                                <div id="userCreditsUsed" style="font-weight: 700; color: #f97316; font-size: 0.95rem;">-$0.00</div>
                                            </div>
                                            <div>
                                                <div style="font-size: 0.65rem; color: #22c55e; text-transform: uppercase;">Available</div>
                                                <div id="userAvailableWithdraw" style="font-weight: 800; color: #22c55e; font-size: 0.95rem;">$0.00</div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Action Button -->
                                    <button onclick="openWithdrawModal()"
                                        style="padding: 12px 24px; background: rgba(239, 68, 68, 0.15); color: #ef4444; border: 2px solid rgba(239, 68, 68, 0.4); border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; white-space: nowrap;"
                                        onmouseover="this.style.background='rgba(239, 68, 68, 0.25)'; this.style.borderColor='#ef4444';"
                                        onmouseout="this.style.background='rgba(239, 68, 68, 0.15)'; this.style.borderColor='rgba(239, 68, 68, 0.4)';">
                                        Request Withdraw
                                    </button>
                                </div>
                            </div>

                            <!-- Your Withdrawals Card (shown when user has pending withdrawals) -->
                            <div id="userWithdrawalsCard" style="display: none; background: rgba(249, 115, 22, 0.15); border: 1px solid rgba(249, 115, 22, 0.3); border-radius: 16px; padding: 20px; margin-top: 20px;">
                                <div style="font-weight: 700; color: #f97316; margin-bottom: 12px; font-size: 0.95rem;">ðŸ“¤ Your Withdrawals</div>
                                <div id="userWithdrawalsList" style="font-size: 0.85rem;">Loading...</div>
                            </div>

                            </div><!-- End vaultExpandedContent -->
                        </div>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- MY FUNDED APPS - Shows user's funding contributions -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div class="glass-card" style="margin-top: 20px; padding: 24px; background: linear-gradient(135deg, rgba(16, 100, 50, 0.25), rgba(10, 80, 60, 0.2)); border: 2px solid rgba(34, 197, 94, 0.25);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <div style="width: 48px; height: 48px; background: linear-gradient(135deg, #22c55e, #10b981); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">ðŸ’°</div>
                            <div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="font-size: 1.3rem; font-weight: 800; color: #2d1b4e;">My Funded Apps</span>
                                    <span id="fundedAppsYieldBadge" style="background: linear-gradient(135deg, #a855f7, #7c3aed); color: white; font-size: 0.7rem; font-weight: 700; padding: 4px 10px; border-radius: 20px;">10% yield</span>
                                </div>
                                <div style="font-size: 0.85rem; color: #6b7280;">Earn 100% revenue share from apps you fund</div>
                            </div>
                        </div>
                        <button onclick="loadMyFundedApps()" style="background: none; border: none; cursor: pointer; padding: 8px;" title="Refresh">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/>
                            </svg>
                        </button>
                    </div>

                    <!-- Revenue Forever Info -->
                    <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 10px; padding: 14px 16px; margin-bottom: 20px;">
                        <div style="display: flex; gap: 10px; align-items: flex-start;">
                            <span style="font-size: 1.1rem;">ðŸŒ±</span>
                            <div style="font-size: 0.82rem; color: #4b5563; line-height: 1.5;">
                                <strong style="color: #166534;">Revenue forever.</strong> Once you fund an app, you earn a share of its revenue for as long as it exists. More funding = better updates, marketing, and longevity. <a href="/learn/yield-powered-app.html" style="color: #22c55e; font-weight: 600; text-decoration: none;">learn more â†’</a>
                            </div>
                        </div>
                    </div>

                    <!-- Summary Stats -->
                    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                            <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Total Funded</div>
                            <div id="myTotalFunded" style="font-weight: 800; color: #22c55e; font-size: 1.2rem;">$0</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                            <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Apps Funded</div>
                            <div id="myAppsFunded" style="font-weight: 800; color: #2d1b4e; font-size: 1.2rem;">0</div>
                        </div>
                        <div style="text-align: center; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px;">
                            <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Total Earnings</div>
                            <div id="myTotalEarnings" style="font-weight: 800; color: #a855f7; font-size: 1.2rem;">$0</div>
                        </div>
                    </div>

                    <!-- Funded Apps List -->
                    <div id="myFundedAppsList" style="display: flex; flex-direction: column; gap: 12px;">
                        <a href="/suite-shell.html" style="text-decoration: none;">
                            <div style="background: rgba(255,255,255,0.6); border: 2px dashed rgba(34, 197, 94, 0.4); border-radius: 12px; padding: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(34, 197, 94, 0.1)'; this.style.borderColor='rgba(34, 197, 94, 0.6)'" onmouseout="this.style.background='rgba(255,255,255,0.6)'; this.style.borderColor='rgba(34, 197, 94, 0.4)'">
                                <div style="width: 48px; height: 48px; background: rgba(34, 197, 94, 0.15); border-radius: 50%; display: flex; align-items: center; justify-content: center;">
                                    <span style="font-size: 1.8rem; color: #22c55e; font-weight: 300;">+</span>
                                </div>
                                <span style="color: #22c55e; font-weight: 600; font-size: 0.95rem;">Start funding an app</span>
                            </div>
                        </a>
                    </div>
                </div>

                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <!-- ADMIN DASHBOARD (Only visible to admin wallets) -->
                <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
                <div id="adminDashboard" style="display: none; margin-top: 24px;">
                    <div class="glass-card"
                        style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.05)); border: 2px solid rgba(239, 68, 68, 0.2); padding: 24px;">

                        <!-- Admin Header -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div
                                style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                ðŸ”</div>
                            <div>
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #dc2626;">Treasury
                                    Admin Dashboard</h4>
                                <p style="margin: 0; font-size: 0.85rem; color: #6b7280;">Multi-sig admin wallet
                                    connected</p>
                            </div>
                            <div
                                style="margin-left: auto; background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">
                                â— Admin Active
                            </div>
                        </div>

                        <!-- Treasury Overview Grid -->
                        <div
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Reported
                                    Value</div>
                                <div id="adminReportedValue"
                                    style="font-size: 1.3rem; font-weight: 800; color: #2d1b4e;">$0</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Contract
                                    Balance</div>
                                <div id="adminContractBalance"
                                    style="font-size: 1.3rem; font-weight: 800; color: #3b82f6;">0 ETH</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Estimated
                                    APY</div>
                                <div id="adminEstimatedAPY"
                                    style="font-size: 1.3rem; font-weight: 800; color: #22c55e;">0%</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Last
                                    Updated</div>
                                <div id="adminLastUpdated" style="font-size: 0.9rem; font-weight: 700; color: #6b7280;">
                                    Never</div>
                            </div>
                        </div>

                        <!-- Value Update Section -->
                        <div
                            style="background: rgba(255,255,255,0.6); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem; margin-bottom: 12px;">
                                ðŸ“Š Report Weekly Value</div>
                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 12px;">
                                Enter your current Yearn position value. APY will be calculated automatically from the previous report.
                            </div>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
                                <div>
                                    <label
                                        style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Total
                                        Value (USD)</label>
                                    <input type="number" id="adminNewValue" placeholder="10500.00" step="0.01"
                                        style="width: 100%; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label
                                        style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Notes (optional)</label>
                                    <input type="text" id="adminReportNotes" placeholder="e.g. Yearn +2% this week"
                                        style="width: 100%; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <button onclick="reportVaultValue()"
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    Report Value
                                </button>
                            </div>
                            <div id="lastReportInfo" style="margin-top: 12px; font-size: 0.8rem; color: #6b7280; display: none;">
                                Last report: <span id="lastReportValue">$0</span> on <span id="lastReportDate">-</span>
                            </div>
                        </div>

                        <!-- Fund Management -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <!-- Withdraw to Admin -->
                            <div
                                style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #dc2626; font-size: 0.9rem; margin-bottom: 12px;">
                                    â¬†ï¸ Withdraw to Admin Wallet</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="adminWithdrawAmount" placeholder="USDC amount"
                                        style="flex: 1; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                    <button onclick="adminWithdraw()"
                                        style="padding: 10px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        Withdraw
                                    </button>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 8px;">Sends USDC to your
                                    connected admin wallet for deployment</div>
                            </div>

                            <!-- Deposit from Admin -->
                            <div
                                style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #22c55e; font-size: 0.9rem; margin-bottom: 12px;">
                                    â¬‡ï¸ Deposit from Admin Wallet</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="adminDepositAmount" placeholder="USDC amount"
                                        style="flex: 1; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                    <button onclick="adminDeposit()"
                                        style="padding: 10px 16px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        Deposit
                                    </button>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 8px;">Return USDC from
                                    your wallet back to treasury</div>
                            </div>
                        </div>

                        <!-- Active Strategy Selection -->
                        <div
                            style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem;">ðŸ“Š Active Strategy</div>
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <span style="font-size: 0.7rem; color: #6b7280;">Change Strategy:</span>
                                    <select id="strategySelect" onchange="updateActiveStrategy()"
                                        style="padding: 6px 12px; border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 6px; font-size: 0.8rem; background: white; cursor: pointer;">
                                        <option value="usdc_yvault" selected>USDC yVault (Katana) - 42% APR</option>
                                        <option value="eth_lending">ETH Lending (Kinetic) - 8% APY</option>
                                        <option value="eth_usdt_lp">ETH/USDT LP (SparkDex) - 25% APY</option>
                                        <option value="custom">Custom Strategy...</option>
                                    </select>
                                </div>
                            </div>

                            <!-- Current Active Strategy Display -->
                            <div id="activeStrategyDisplay"
                                style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 14px 16px; background: rgba(255,255,255,0.9); border-radius: 10px; align-items: center;">
                                <div>
                                    <div id="strategyName" style="font-weight: 700; color: #2d1b4e; font-size: 0.95rem;">USDC yVault</div>
                                    <div id="strategyDesc" style="font-size: 0.75rem; color: #6b7280;">Katana â€¢ Vault Bridge â€¢ Yearn</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">TVL</div>
                                    <div id="strategyTVL" style="font-weight: 700; color: #2d1b4e;">$90.06M</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">APR</div>
                                    <div id="strategyAPR" style="font-weight: 800; color: #22c55e; font-size: 1.1rem;">42.10%</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">Chain</div>
                                    <div id="strategyChain" style="font-weight: 600; color: #3b82f6;">Base</div>
                                </div>
                                <a id="strategyLink" href="https://basescan.org/address/0x80c34BD3A3569E126e7055831036aa7b212cB159" target="_blank"
                                    style="padding: 6px 12px; background: rgba(59, 130, 246, 0.1); color: #3b82f6; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-decoration: none;">View â†—</a>
                            </div>

                            <div style="margin-top: 10px; font-size: 0.7rem; color: #6b7280;">
                                Multi-strategy vault via Yearn. Eligible for STEER points + KAT rewards. Changing strategy will update display across all user views.
                            </div>
                        </div>

                        <!-- Pending Withdrawals -->
                        <div
                            style="background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 12px; padding: 16px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: #f97316; font-size: 0.9rem;">â³ Pending User
                                    Withdrawals</div>
                                <button onclick="processAllWithdrawals()"
                                    style="padding: 6px 12px; background: #f97316; color: white; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">
                                    Process All Ready
                                </button>
                            </div>
                            <div id="pendingWithdrawalsList"
                                style="font-size: 0.85rem; color: #6b7280; text-align: center; padding: 12px;">
                                No pending withdrawals
                            </div>
                        </div>

                        <!-- Emergency Controls -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button onclick="togglePauseWithdrawals()" id="pauseWithdrawalsBtn"
                                    style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                    â¸ï¸ Pause Withdrawals
                                </button>
                                <button onclick="togglePauseDeposits()" id="pauseDepositsBtn"
                                    style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                    â¸ï¸ Pause Deposits
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- App Build Requests (Admin) Section -->
                    <div class="glass-card" style="margin-top: 20px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e; display: flex; align-items: center; gap: 10px;">
                                ðŸ“ App Build Requests
                            </h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="refresh-btn" onclick="loadAppBuildRequests()" title="Refresh"
                                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#a855f7"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2v6h-6" />
                                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                        <path d="M3 22v-6h6" />
                                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                    </svg>
                                </button>
                                <span id="buildRequestCount"
                                    style="background: linear-gradient(135deg, #a855f7, #ec4899); color: white; padding: 4px 12px; border-radius: 100px; font-weight: 700; font-size: 0.8rem;">0 requests</span>
                            </div>
                        </div>
                        <div id="buildRequestsGrid" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">
                                ðŸ“­ Loading requests...
                            </div>
                        </div>
                    </div>

                    <!-- Influencer Waitlist (Admin) Section -->
                    <div class="glass-card" style="margin-top: 20px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e; display: flex; align-items: center; gap: 10px;">
                                ðŸ“¢ Influencer Waitlist
                            </h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="refresh-btn" onclick="loadInfluencerWaitlist()" title="Refresh"
                                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff9500"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2v6h-6" />
                                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                        <path d="M3 22v-6h6" />
                                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                    </svg>
                                </button>
                                <span id="influencerCount"
                                    style="background: linear-gradient(135deg, #ff9500, #ff6b9d); color: white; padding: 4px 12px; border-radius: 100px; font-weight: 700; font-size: 0.8rem;">0 signups</span>
                            </div>
                        </div>
                        <div id="influencerWaitlistGrid" style="display: flex; flex-direction: column; gap: 8px;">
                            <div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">
                                ðŸ“­ Loading waitlist...
                            </div>
                        </div>
                    </div>

                    <!-- All Apps (Admin) Section -->
                    <div class="glass-card" style="margin-top: 20px; padding: 24px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3
                                style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e; display: flex; align-items: center; gap: 10px;">
                                ðŸ›¡ï¸ All Apps (Admin)
                            </h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="refresh-btn" onclick="loadAllAppsAdmin()" title="Refresh"
                                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff9500"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2v6h-6" />
                                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                        <path d="M3 22v-6h6" />
                                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                    </svg>
                                </button>
                                <span id="adminAppCount"
                                    style="background: linear-gradient(135deg, #ff9500, #ff6b9d); color: white; padding: 4px 12px; border-radius: 100px; font-weight: 700; font-size: 0.8rem;">0
                                    apps</span>
                            </div>
                        </div>
                        <div id="adminAppsGrid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <div
                                style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem; grid-column: 1 / -1;">
                                ðŸ“­ Loading apps...
                            </div>
                        </div>
                    </div>

                    <!-- Revenue Tracking (Admin) Section -->
                    <div class="glass-card" style="margin-top: 20px; padding: 24px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e; display: flex; align-items: center; gap: 10px;">
                                ðŸ’° Revenue Tracking
                            </h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="refresh-btn" onclick="loadRevenueData()" title="Refresh"
                                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#22c55e"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2v6h-6" />
                                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                        <path d="M3 22v-6h6" />
                                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                    </svg>
                                </button>
                                <span id="revenueAppCount"
                                    style="background: linear-gradient(135deg, #22c55e, #10b981); color: white; padding: 4px 12px; border-radius: 100px; font-weight: 700; font-size: 0.8rem;">0 apps</span>
                            </div>
                        </div>

                        <!-- Revenue Summary Stats -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px; margin-bottom: 20px;">
                            <div style="background: rgba(34, 197, 94, 0.1); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Total App Revenue</div>
                                <div id="totalAppRevenue" style="font-size: 1.3rem; font-weight: 700; color: #22c55e;">$0.00</div>
                            </div>
                            <div style="background: rgba(168, 85, 247, 0.1); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Funder Share (100%)</div>
                                <div id="totalFunderShare" style="font-size: 1.3rem; font-weight: 700; color: #a855f7;">$0.00</div>
                            </div>
                            <div style="background: rgba(249, 115, 22, 0.1); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Launch+ Apps</div>
                                <div id="graduatedAppCount" style="font-size: 1.3rem; font-weight: 700; color: #a855f7;">0</div>
                            </div>
                        </div>

                        <!-- Record Revenue Form -->
                        <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #2d1b4e; margin-bottom: 12px; font-size: 0.9rem;">Record New Revenue</div>
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end;">
                                <div style="flex: 1; min-width: 200px;">
                                    <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Select App</label>
                                    <select id="revenueAppSelect" style="width: 100%; padding: 10px 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem; background: white;">
                                        <option value="">-- Select App --</option>
                                    </select>
                                </div>
                                <div style="min-width: 120px;">
                                    <label style="display: block; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">Revenue Amount ($)</label>
                                    <input type="number" id="revenueAmount" placeholder="100.00" step="0.01" min="0"
                                        style="width: 100%; padding: 10px 12px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <button onclick="recordRevenue()"
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                    Record & Distribute
                                </button>
                            </div>
                            <div style="margin-top: 10px; font-size: 0.75rem; color: #6b7280;">
                                100% of revenue goes to funders, proportional to their contributions
                            </div>
                        </div>

                        <!-- Revenue Apps Grid -->
                        <div id="revenueAppsGrid" style="display: flex; flex-direction: column; gap: 12px;">
                            <div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">
                                ðŸ“­ Loading apps with funding...
                            </div>
                        </div>
                    </div>

                </div>

            </section>
        </div>
    </main>

    <!-- Add Funds Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Get SUITE</h2>
                <button class="modal-close" onclick="closeModal('depositModal')">?</button>
            </div>



            <div class="payment-options">
                <div class="payment-option" onclick="handlePayment('card')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Credit / Debit Card</div>
                        <div class="payment-desc">Visa, Mastercard, Amex</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handlePayment('apple')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Apple Pay</div>
                        <div class="payment-desc">One-tap checkout</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handlePayment('crypto')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Crypto (USDC / ETH)</div>
                        <div class="payment-desc">Send from any wallet</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
            </div>

            <p class="fee-notice">0.5% deposit fee ? Your funds are always withdrawable</p>
        </div>
    </div>

    <!-- Crypto Deposit Modal -->
    <div class="modal-overlay" id="cryptoDepositModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Deposit Crypto</h2>
                <button class="modal-close" onclick="closeModal('cryptoDepositModal')">?</button>
            </div>

            <!-- Network Warning -->
            <div class="network-warning" id="networkWarning" style="display: none;">
                <span></span>
                <span>Please switch to <strong>Base</strong> network in MetaMask</span>
                <button onclick="switchToBase()" class="switch-network-btn">Switch Network</button>
            </div>

            <!-- Wallet Balances -->
            <div class="wallet-balances-display">
                <div class="balance-header">Your Base Wallet</div>
                <div class="crypto-balance-row">
                    <div class="crypto-icon eth"></div>
                    <div class="crypto-info">
                        <span class="crypto-name">ETH</span>
                        <span class="crypto-balance" id="ethBalance">0.0000</span>
                    </div>
                    <span class="crypto-usd" id="ethUsdValue">~$0.00</span>
                </div>
                <div class="crypto-balance-row">
                    <div class="crypto-icon usdc"></div>
                    <div class="crypto-info">
                        <span class="crypto-name">USDC</span>
                        <span class="crypto-balance" id="usdcBalance">0.00</span>
                    </div>
                    <span class="crypto-usd" id="usdcUsdValue">~$0.00</span>
                </div>
            </div>

            <!-- Asset Selector -->
            <div class="asset-selector">
                <div class="asset-label">Deposit Asset:</div>
                <div class="asset-tabs">
                    <button class="asset-tab active" data-asset="eth" onclick="selectAsset('eth', this)">
                        ?? ETH
                    </button>
                    <button class="asset-tab" data-asset="usdc" onclick="selectAsset('usdc', this)">
                        ?? USDC
                    </button>
                </div>
            </div>

            <!-- Amount Input -->
            <div class="deposit-amount-section">
                <div class="amount-label">Amount to deposit:</div>
                <div class="crypto-amount-input-wrapper">
                    <button class="amount-adjust-btn minus" onclick="adjustAmount(-0.00001)">-</button>
                    <div class="crypto-amount-input">
                        <input type="number" id="cryptoDepositAmount" placeholder="0.000000" step="0.000001" min="0"
                            oninput="updateCryptoPreview()">
                        <span class="input-asset" id="inputAssetLabel">ETH</span>
                    </div>
                    <button class="amount-adjust-btn plus" onclick="adjustAmount(0.00001)">+</button>
                </div>
                <div class="percentage-buttons">
                    <button onclick="setPercentage(25)">25%</button>
                    <button onclick="setPercentage(50)">50%</button>
                    <button onclick="setPercentage(75)">75%</button>
                    <button onclick="setPercentage(100)">MAX</button>
                </div>
            </div>

            <!-- SUITE Preview -->
            <div class="suite-receive-preview">
                <div class="receive-label">You'll receive:</div>
                <div class="receive-value">
                    <span id="cryptoSuitePreview">0 SUITE</span>
                    <span class="receive-usd" id="cryptoUsdPreview">(~$0.00)</span>
                </div>
                <div class="receive-note">After 0.5% deposit fee ? Earning ~18% APY</div>
            </div>

            <!-- Deposit Button -->
            <button class="crypto-deposit-btn" id="cryptoDepositBtn" onclick="executeCryptoDeposit()">
                ?? Deposit Now
            </button>

            <p class="fee-notice">Funds are always withdrawable ? No lock-up period</p>
        </div>
    </div>

    <!-- Custom Notification Modal -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal notification-modal">
            <div class="notification-icon" id="notificationIcon">??</div>
            <h2 id="notificationTitle">Success!</h2>
            <p id="notificationMessage">Your transaction was submitted.</p>
            <div class="notification-details" id="notificationDetails"></div>
            <button class="notification-btn" onclick="closeNotification()">Got it</button>
        </div>
    </div>

    <!-- Full Edit App Modal -->
    <div class="edit-modal-overlay" id="editModalOverlay">
        <div class="edit-modal">
            <h3>âœï¸ Edit App</h3>
            <form id="editAppForm">
                <input type="hidden" id="editAppSlug">
                <div class="form-group">
                    <label for="editName">App Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editTagline">Tagline</label>
                    <input type="text" id="editTagline" placeholder="Short description...">
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" placeholder="Detailed description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editType">Type</label>
                        <select id="editType">
                            <option value="app">App</option>
                            <option value="game">Game</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory">
                            <option value="productivity">Productivity</option>
                            <option value="health">Health</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="fitness">Fitness</option>
                            <option value="finance">Finance</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="education">Education</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus">
                            <option value="approved">ðŸŸ¢ Live</option>
                            <option value="development">ðŸŸ¡ Development</option>
                            <option value="paused">â¸ï¸ Paused</option>
                            <option value="featured">â­ Featured</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>App Icon</label>
                    <div class="upload-zone" id="iconUploadZone" ondrop="handleEditDrop(event, 'editIconUrl')"
                        ondragover="handleEditDragOver(event)" onclick="document.getElementById('iconFileInput').click()">
                        <img class="upload-preview" id="iconPreview" style="display: none;">
                        <div class="upload-placeholder" id="iconPlaceholder">
                            <span>ðŸ“·</span>
                            <span>Drop image or click to upload</span>
                        </div>
                        <input type="file" id="iconFileInput" accept="image/*" style="display:none"
                            onchange="handleEditFileSelect(event, 'editIconUrl', 'iconPreview', 'iconPlaceholder')">
                    </div>
                    <input type="hidden" id="editIconUrl">
                </div>
                <div class="form-group">
                    <label for="editAppUrl">App URL</label>
                    <input type="text" id="editAppUrl" placeholder="/app.html or https://yourapp.vercel.app">
                </div>
                <div class="form-group">
                    <label>Screenshots</label>
                    <div class="screenshots-grid">
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot1')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss1FileInput').click()">
                            <button type="button" class="remove-btn" id="ss1Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot1', 'ss1Preview', 'ss1Placeholder', 'ss1Remove')">Ã—</button>
                            <img class="upload-preview" id="ss1Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss1Placeholder"><span>ðŸ“· 1</span></div>
                            <input type="file" id="ss1FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot1', 'ss1Preview', 'ss1Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot2')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss2FileInput').click()">
                            <button type="button" class="remove-btn" id="ss2Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot2', 'ss2Preview', 'ss2Placeholder', 'ss2Remove')">Ã—</button>
                            <img class="upload-preview" id="ss2Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss2Placeholder"><span>ðŸ“· 2</span></div>
                            <input type="file" id="ss2FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot2', 'ss2Preview', 'ss2Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot3')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss3FileInput').click()">
                            <button type="button" class="remove-btn" id="ss3Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot3', 'ss3Preview', 'ss3Placeholder', 'ss3Remove')">Ã—</button>
                            <img class="upload-preview" id="ss3Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss3Placeholder"><span>ðŸ“· 3</span></div>
                            <input type="file" id="ss3FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot3', 'ss3Preview', 'ss3Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot4')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss4FileInput').click()">
                            <button type="button" class="remove-btn" id="ss4Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot4', 'ss4Preview', 'ss4Placeholder', 'ss4Remove')">Ã—</button>
                            <img class="upload-preview" id="ss4Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss4Placeholder"><span>ðŸ“· 4</span></div>
                            <input type="file" id="ss4FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot4', 'ss4Preview', 'ss4Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot5')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss5FileInput').click()">
                            <button type="button" class="remove-btn" id="ss5Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot5', 'ss5Preview', 'ss5Placeholder', 'ss5Remove')">Ã—</button>
                            <img class="upload-preview" id="ss5Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss5Placeholder"><span>ðŸ“· 5</span></div>
                            <input type="file" id="ss5FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot5', 'ss5Preview', 'ss5Placeholder')">
                        </div>
                    </div>
                    <input type="hidden" id="editScreenshot1">
                    <input type="hidden" id="editScreenshot2">
                    <input type="hidden" id="editScreenshot3">
                    <input type="hidden" id="editScreenshot4">
                    <input type="hidden" id="editScreenshot5">
                </div>

                <!-- App Features Manager -->
                <div style="border-top: 2px dashed #e5e7eb; margin: 20px 0; padding-top: 20px;">
                    <label style="font-weight: 800; font-size: 1.1rem; color: #1f2937; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        âš¡ App Features
                        <span style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">(What users can do in this app)</span>
                    </label>

                    <!-- Features List -->
                    <div id="editFeaturesList" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px; max-height: 300px; overflow-y: auto;">
                        <!-- Features populated dynamically -->
                        <div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 0.9rem;">Loading features...</div>
                    </div>

                    <!-- Add Feature Form -->
                    <div style="background: #f9fafb; border: 1px dashed #d1d5db; border-radius: 12px; padding: 16px;">
                        <div style="font-weight: 600; font-size: 0.85rem; color: #374151; margin-bottom: 12px;">âž• Add New Feature</div>
                        <div style="display: grid; grid-template-columns: auto 1fr 1fr auto; gap: 8px; align-items: end;">
                            <div>
                                <label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 4px;">Icon</label>
                                <input type="text" id="newFeatureIcon" placeholder="ðŸ“¸" maxlength="4"
                                    style="width: 50px; padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1.2rem; text-align: center;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 4px;">Feature Name</label>
                                <input type="text" id="newFeatureName" placeholder="e.g., Scan meal photo"
                                    style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <div>
                                <label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 4px;">Credits Cost (0 = free)</label>
                                <input type="number" id="newFeatureCost" placeholder="0" min="0" step="0.5" value="0"
                                    style="padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem;">
                            </div>
                            <button type="button" onclick="addNewFeature()"
                                style="padding: 8px 16px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                Add
                            </button>
                        </div>
                        <div style="margin-top: 8px;">
                            <label style="display: block; font-size: 0.7rem; color: #6b7280; margin-bottom: 4px;">Description (optional)</label>
                            <input type="text" id="newFeatureDesc" placeholder="Brief description of what this feature does"
                                style="width: 100%; padding: 8px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 0.9rem;">
                        </div>
                    </div>
                </div>

                <!-- Hidden inputs for legacy compatibility -->
                <input type="hidden" id="editFreeFeatures">
                <input type="hidden" id="editProFeatures">

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-save">ðŸ’¾ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Edit Modal Styles */
        .edit-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .edit-modal-overlay.active { display: flex; }
        .edit-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .edit-modal h3 {
            font-size: 1.4rem;
            font-weight: 800;
            color: #2d1b4e;
            margin-bottom: 24px;
        }
        .edit-modal .form-group { margin-bottom: 20px; }
        .edit-modal .form-group label {
            display: block;
            font-weight: 700;
            color: #2d1b4e;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .edit-modal .form-group input,
        .edit-modal .form-group select,
        .edit-modal .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
        }
        .edit-modal .form-group input:focus,
        .edit-modal .form-group select:focus,
        .edit-modal .form-group textarea:focus {
            outline: none;
            border-color: #ff9500;
        }
        .edit-modal .form-group textarea { min-height: 100px; resize: vertical; }
        .edit-modal .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .edit-modal .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .edit-modal .btn-cancel {
            background: #f3f4f6;
            color: #5a4a6f;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        .edit-modal .btn-save {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        .edit-modal .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .edit-modal .upload-zone:hover { border-color: #ff9500; background: #fff8f0; }
        .edit-modal .upload-zone.small { min-height: 80px; padding: 12px; }
        .edit-modal .upload-preview {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 8px;
        }
        .edit-modal .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .edit-modal .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .edit-modal .upload-zone .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: none;
            z-index: 10;
            padding: 0;
        }
        .edit-modal .upload-zone .remove-btn:hover {
            background: #dc2626;
        }
    </style>

    <style>
        /* Crypto Deposit Modal Styles */
        .network-warning {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .switch-network-btn {
            margin-left: auto;
            padding: 6px 12px;
            background: #ef4444;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .wallet-balances-display {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .balance-header {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .crypto-balance-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .crypto-balance-row:last-child {
            border-bottom: none;
        }

        .crypto-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .crypto-icon.eth {
            background: rgba(98, 126, 234, 0.2);
        }

        .crypto-icon.usdc {
            background: rgba(39, 117, 202, 0.2);
        }

        .crypto-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .crypto-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .crypto-balance {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: monospace;
        }

        .crypto-usd {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .asset-selector {
            margin-bottom: 20px;
        }

        .asset-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .asset-tabs {
            display: flex;
            gap: 8px;
        }

        .asset-tab {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .asset-tab:hover {
            border-color: var(--accent-primary);
        }

        .asset-tab.active {
            background: rgba(168, 85, 247, 0.15);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .deposit-amount-section {
            margin-bottom: 20px;
        }

        .crypto-amount-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .amount-adjust-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 2px solid var(--accent-primary);
            background: transparent;
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .amount-adjust-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.05);
        }

        .amount-adjust-btn:active {
            transform: scale(0.95);
        }

        .crypto-amount-input {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .crypto-amount-input:focus-within {
            border-color: var(--accent-primary);
        }

        .crypto-amount-input input {
            flex: 1;
            padding: 14px 16px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .crypto-amount-input input:focus {
            outline: none;
        }

        .input-asset {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .percentage-buttons {
            display: flex;
            gap: 8px;
        }

        .percentage-buttons button {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .percentage-buttons button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .suite-receive-preview {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(232, 93, 59, 0.15), rgba(249, 115, 22, 0.1));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .receive-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .receive-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .receive-usd {
            font-size: 1.1rem;
            font-weight: 500;
            color: #22c55e;
        }

        .receive-note {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        .crypto-deposit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #22c55e, #10b981);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .crypto-deposit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
        }

        .crypto-deposit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Notification Modal Styles */
        .notification-modal {
            text-align: center;
            padding: 30px;
            max-width: 400px;
        }

        .notification-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .notification-modal h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.5rem;
        }

        .notification-modal p {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .notification-details {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .notification-details:empty {
            display: none;
        }

        .notification-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 149, 0, 0.3);
        }
    </style>

    <!-- Cash Out Modal -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Cash Out</h2>
                <button class="modal-close" onclick="closeModal('withdrawModal')">?</button>
            </div>

            <div class="balance-display">
                <div class="balance-display-value" id="cashOutBalance">0 SUITE</div>
                <div class="balance-display-label">Available to cash out ? ? $0.00</div>
            </div>

            <div class="amount-selector">
                <div class="amount-label">How much would you like to cash out?</div>
                <div class="custom-amount">
                    <input type="number" id="withdrawAmount" placeholder="Amount in SUITE" value="0">
                    <button class="amount-option" onclick="document.getElementById('withdrawAmount').value = 0"
                        style="padding: 12px 20px;">MAX</button>
                </div>
            </div>

            <div class="payment-options">
                <div class="payment-option" onclick="handleWithdraw('paypal')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">PayPal</div>
                        <div class="payment-desc">Instant to your PayPal email</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('card')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Original Card</div>
                        <div class="payment-desc">Refund to card you deposited with</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('giftcard')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Gift Card</div>
                        <div class="payment-desc">Amazon, Visa Prepaid, more</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('crypto')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Crypto Wallet</div>
                        <div class="payment-desc">Send USDC to any address</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('bank')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Bank Transfer</div>
                        <div class="payment-desc">Interac e-Transfer (Canada) or Wire</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
            </div>

            <p class="fee-notice">0.5% withdrawal fee applies</p>
        </div>
    </div>


    <script>
        // ============================================
        // ADMIN WALLET CONFIGURATION
        // ============================================
        const ADMIN_WALLETS = [
            '0x92D67D8ad8B986e78b369bE0272E121AE5ACAd59'.toLowerCase(),  // Laptop MetaMask
            '0xDEfc3AE5a990206101463d208E7e1446c58a72bD'.toLowerCase(),  // PC MetaMask  
            '0x53cf707eF11cD213D8f1710996C22049a45B8215'.toLowerCase()   // PC Hardware Wallet
        ];

        // TreasuryVault contract address (update after deployment)
        const TREASURY_VAULT_ADDRESS = '0x0000000000000000000000000000000000000000'; // TODO: Update after deploy

        // TreasuryVault ABI (simplified)
        const TREASURY_VAULT_ABI = [
            'function isAdmin(address) view returns (bool)',
            'function treasuryValue() view returns (uint256)',
            'function estimatedAPY() view returns (uint256)',
            'function lastValueUpdate() view returns (uint256)',
            'function withdrawalsPaused() view returns (bool)',
            'function depositsPaused() view returns (bool)',
            'function updateTreasuryValue(uint256 newValue)',
            'function updateEstimatedAPY(uint256 newAPY)',
            'function withdrawToAdmin(uint256 amount)',
            'function depositFromAdmin() payable',
            'function pauseWithdrawals(bool paused)',
            'function pauseDeposits(bool paused)',
            'function getPendingWithdrawalsCount() view returns (uint256)'
        ];

        let treasuryVaultContract = null;

        // Check if connected wallet is admin
        function isAdminWallet(address) {
            if (!address) return false;
            return ADMIN_WALLETS.includes(address.toLowerCase());
        }

        // Show/hide admin dashboard based on connected wallet
        function updateAdminDashboardVisibility() {
            const adminDashboard = document.getElementById('adminDashboard');
            if (adminDashboard && walletAddress) {
                if (isAdminWallet(walletAddress)) {
                    adminDashboard.style.display = 'block';
                    loadAdminData();
                    loadPendingWithdrawals(); // Load pending withdrawal requests
                } else {
                    adminDashboard.style.display = 'none';
                }
            }
        }

        // Load admin dashboard data
        async function loadAdminData() {
            try {
                // For now, show placeholder data until contract is deployed
                // Once deployed, this will read from the actual contract
                document.getElementById('adminReportedValue').textContent = '$0';
                document.getElementById('adminContractBalance').textContent = '0 ETH';
                document.getElementById('adminEstimatedAPY').textContent = '0%';
                document.getElementById('adminLastUpdated').textContent = 'Not deployed';

                // Update liquid reserve display with actual contract balance
                if (window.ethereum) {
                    try {
                        const provider = new ethers.BrowserProvider(window.ethereum);
                        const balance = await provider.getBalance(TREASURY_VAULT_ADDRESS);
                        const ethBalance = parseFloat(ethers.formatEther(balance));
                        document.getElementById('adminContractBalance').textContent = `${ethBalance.toFixed(4)} ETH`;
                        document.getElementById('liquidReserveValue').textContent = `$${(ethBalance * 2500).toLocaleString()}`; // Rough ETH price
                    } catch (e) {
                        // Contract not deployed yet
                    }
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Update treasury value and APY
        // ========== VAULT REPORTING SYSTEM ==========
        const VAULT_SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const VAULT_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // Report new vault value (admin function)
        async function reportVaultValue() {
            const newValue = document.getElementById('adminNewValue')?.value;
            const notes = document.getElementById('adminReportNotes')?.value || null;

            if (!newValue || parseFloat(newValue) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid value');
                return;
            }

            try {
                showNotification('â³', 'Submitting', 'Recording vault value...');

                // Get connected wallet address for audit trail
                const adminWallet = userAddress || 'admin';

                // Insert new report to Supabase
                const response = await fetch(`${VAULT_SUPABASE_URL}/rest/v1/vault_value_reports`, {
                    method: 'POST',
                    headers: {
                        'apikey': VAULT_SUPABASE_KEY,
                        'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        reported_value_usd: parseFloat(newValue),
                        reported_by: adminWallet,
                        notes: notes
                    })
                });

                if (!response.ok) {
                    throw new Error('Failed to submit report');
                }

                const result = await response.json();
                const report = result[0];

                // Update UI with results
                document.getElementById('adminReportedValue').textContent = `$${parseFloat(newValue).toLocaleString()}`;
                document.getElementById('adminLastUpdated').textContent = new Date().toLocaleString();

                // Show calculated APY if available
                if (report.calculated_apy !== null) {
                    document.getElementById('adminEstimatedAPY').textContent = `${report.calculated_apy.toFixed(2)}%`;
                    showNotification('âœ…', 'Reported', `Value recorded! Calculated APY: ${report.calculated_apy.toFixed(2)}%`);
                } else {
                    showNotification('âœ…', 'Reported', 'First report recorded. APY will calculate after next report.');
                }

                // Clear inputs
                document.getElementById('adminNewValue').value = '';
                document.getElementById('adminReportNotes').value = '';

                // Refresh public stats
                loadVaultPublicStats();

            } catch (error) {
                console.error('Report error:', error);
                showNotification('âŒ', 'Error', error.message || 'Failed to submit report');
            }
        }

        // Load vault stats for public display
        async function loadVaultPublicStats() {
            try {
                // Get latest report
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/vault_value_reports?order=reported_at.desc&limit=1`,
                    {
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) return;

                const reports = await response.json();
                if (reports.length === 0) return;

                const latest = reports[0];

                // Update Fleet TVL display
                const tvlEl = document.getElementById('vaultTVL');
                if (tvlEl && latest.reported_value_usd) {
                    const val = parseFloat(latest.reported_value_usd);
                    if (val >= 1000000) {
                        tvlEl.textContent = '$' + (val / 1000000).toFixed(2) + 'M';
                    } else if (val >= 1000) {
                        tvlEl.textContent = '$' + (val / 1000).toFixed(1) + 'K';
                    } else {
                        tvlEl.textContent = '$' + val.toFixed(2);
                    }
                }

                // Update APY display
                const apyEl = document.getElementById('vaultAPR');
                if (apyEl && latest.calculated_apy !== null) {
                    apyEl.textContent = `~${latest.calculated_apy.toFixed(1)}%`;
                }

                // Update admin panel if visible
                const adminReportedEl = document.getElementById('adminReportedValue');
                if (adminReportedEl) {
                    adminReportedEl.textContent = `$${parseFloat(latest.reported_value_usd).toLocaleString()}`;
                }

                const adminAPYEl = document.getElementById('adminEstimatedAPY');
                if (adminAPYEl && latest.calculated_apy !== null) {
                    adminAPYEl.textContent = `${latest.calculated_apy.toFixed(2)}%`;
                }

                const adminLastEl = document.getElementById('adminLastUpdated');
                if (adminLastEl) {
                    adminLastEl.textContent = new Date(latest.reported_at).toLocaleString();
                }

                // Show last report info
                const lastReportInfo = document.getElementById('lastReportInfo');
                if (lastReportInfo) {
                    lastReportInfo.style.display = 'block';
                    document.getElementById('lastReportValue').textContent = `$${parseFloat(latest.reported_value_usd).toLocaleString()}`;
                    document.getElementById('lastReportDate').textContent = new Date(latest.reported_at).toLocaleDateString();
                }

            } catch (error) {
                console.error('Error loading vault stats:', error);
            }
        }

        // Load yield allocation aggregate stats
        async function loadYieldAllocationStats() {
            try {
                // First try the view (if schema is deployed)
                let response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/yield_allocation_stats`,
                    {
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                        }
                    }
                );

                let avgKeep = 90;
                let avgApps = 10;

                if (response.ok) {
                    const stats = await response.json();
                    if (stats.length > 0) {
                        avgKeep = Math.round(stats[0].avg_keep_percent || 90);
                        avgApps = Math.round(stats[0].avg_apps_percent || 10);
                    }
                } else {
                    // Fallback: calculate from treasury_yield_preferences table directly
                    const allocResponse = await fetch(
                        `${VAULT_SUPABASE_URL}/rest/v1/treasury_yield_preferences?select=keep_percent`,
                        {
                            headers: {
                                'apikey': VAULT_SUPABASE_KEY,
                                'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                            }
                        }
                    );

                    if (allocResponse.ok) {
                        const allocations = await allocResponse.json();
                        if (allocations.length > 0) {
                            const total = allocations.reduce((sum, a) => sum + (a.keep_percent || 90), 0);
                            avgKeep = Math.round(total / allocations.length);
                            avgApps = 100 - avgKeep;
                        }
                    }
                }

                // Update UI
                const usersEl = document.getElementById('yieldToUsers');
                const appsEl = document.getElementById('yieldToApps');

                if (usersEl) usersEl.textContent = `${avgKeep}%`;
                if (appsEl) appsEl.textContent = `${avgApps}%`;

                console.log('Yield allocation stats:', { avgKeep, avgApps });

            } catch (error) {
                console.error('Error loading yield stats:', error);
            }
        }

        // Legacy function - redirects to new system
        async function updateTreasuryValues() {
            reportVaultValue();
        }

        // Strategy configurations
        const STRATEGIES = {
            usdc_yvault: {
                name: 'USDC yVault',
                desc: 'Katana â€¢ Vault Bridge â€¢ Yearn',
                tvl: '$90.06M',
                apr: '42.10%',
                chain: 'Base',
                chainColor: '#3b82f6',
                link: 'https://basescan.org/address/0x80c34BD3A3569E126e7055831036aa7b212cB159'
            },
            eth_lending: {
                name: 'ETH Lending',
                desc: 'Kinetic â€¢ Collateral lending',
                tvl: '$15.2M',
                apr: '8.00%',
                chain: 'Flare',
                chainColor: '#f97316',
                link: 'https://kinetic.market'
            },
            eth_usdt_lp: {
                name: 'ETH/USDT LP',
                desc: 'SparkDex â€¢ Liquidity provision',
                tvl: '$8.5M',
                apr: '25.00%',
                chain: 'Flare',
                chainColor: '#f97316',
                link: 'https://sparkdex.ai'
            },
            custom: {
                name: 'Custom Strategy',
                desc: 'Configure your own strategy',
                tvl: '-',
                apr: '-',
                chain: '-',
                chainColor: '#6b7280',
                link: '#'
            }
        };

        // Update active strategy from admin dropdown
        function updateActiveStrategy() {
            const select = document.getElementById('strategySelect');
            const strategyKey = select?.value || 'usdc_yvault';
            const strategy = STRATEGIES[strategyKey];

            if (!strategy) return;

            // Update admin dashboard display
            const nameEl = document.getElementById('strategyName');
            const descEl = document.getElementById('strategyDesc');
            const tvlEl = document.getElementById('strategyTVL');
            const aprEl = document.getElementById('strategyAPR');
            const chainEl = document.getElementById('strategyChain');
            const linkEl = document.getElementById('strategyLink');

            if (nameEl) nameEl.textContent = strategy.name;
            if (descEl) descEl.textContent = strategy.desc;
            if (tvlEl) tvlEl.textContent = strategy.tvl;
            if (aprEl) aprEl.textContent = strategy.apr;
            if (chainEl) {
                chainEl.textContent = strategy.chain;
                chainEl.style.color = strategy.chainColor;
            }
            if (linkEl) linkEl.href = strategy.link;

            // Update the user-facing vault header badge
            const vaultStrategyName = document.querySelector('.strategy-badge-name');
            const vaultStrategyDesc = document.querySelector('.strategy-badge-desc');
            const vaultStrategyLinkEl = document.getElementById('vaultStrategyLink');
            if (vaultStrategyName) vaultStrategyName.textContent = strategy.name;
            if (vaultStrategyDesc) vaultStrategyDesc.textContent = `${strategy.chain} â€¢ ${strategy.tvl} TVL`;
            if (vaultStrategyLinkEl) vaultStrategyLinkEl.href = strategy.link;

            // Update EST. APR in vault header
            const vaultAPR = document.getElementById('vaultAPR');
            if (vaultAPR) vaultAPR.textContent = strategy.apr;

            showNotification('âœ…', 'Strategy Updated', `Active strategy changed to ${strategy.name}`);
        }

        // Withdraw USDC to admin wallet
        async function adminWithdraw() {
            const amount = document.getElementById('adminWithdrawAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet');
                return;
            }

            try {
                showNotification('â³', 'Withdrawing', 'Please confirm the transaction...');

                // Contract call will be added after deployment
                showNotification('âš ï¸', 'Pending', 'Contract not deployed yet. Deploy TreasuryVault first.');
                document.getElementById('adminWithdrawAmount').value = '';
            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('âŒ', 'Error', error.message || 'Withdrawal failed');
            }
        }

        // Deposit ETH from admin wallet
        async function adminDeposit() {
            const amount = document.getElementById('adminDepositAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet');
                return;
            }

            try {
                showNotification('â³', 'Depositing', 'Please confirm the transaction...');

                // Contract call will be added after deployment
                showNotification('âš ï¸', 'Pending', 'Contract not deployed yet. Deploy TreasuryVault first.');
                document.getElementById('adminDepositAmount').value = '';
            } catch (error) {
                console.error('Deposit error:', error);
                showNotification('âŒ', 'Error', error.message || 'Deposit failed');
            }
        }

        // Toggle pause withdrawals
        async function togglePauseWithdrawals() {
            if (!signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet');
                return;
            }
            showNotification('âš ï¸', 'Pending', 'Contract not deployed yet');
        }

        // Toggle pause deposits
        async function togglePauseDeposits() {
            if (!signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet');
                return;
            }
            showNotification('âš ï¸', 'Pending', 'Contract not deployed yet');
        }

        // Load pending withdrawals for admin view (all non-completed statuses)
        async function loadPendingWithdrawals() {
            const listEl = document.getElementById('pendingWithdrawalsList');
            if (!listEl) return;

            try {
                // Load all non-completed withdrawals
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?status=in.(pending,approved,ready)&order=requested_at.asc`,
                    {
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load withdrawals');

                const withdrawals = await response.json();

                if (withdrawals.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; color: #6b7280;">No pending withdrawals</div>';
                    return;
                }

                // Group by status
                const pending = withdrawals.filter(w => w.status === 'pending');
                const approved = withdrawals.filter(w => w.status === 'approved');
                const ready = withdrawals.filter(w => w.status === 'ready');

                let html = '';
                let totalAmount = withdrawals.reduce((sum, w) => sum + parseFloat(w.amount_usd), 0);

                // Summary
                html += `<div style="font-size: 0.8rem; color: #f97316; margin-bottom: 10px; font-weight: 600;">
                    Total: $${totalAmount.toFixed(2)} (${pending.length} pending, ${approved.length} approved, ${ready.length} ready)
                </div>`;

                // Helper to render withdrawal item
                const renderItem = (w, bgColor, statusLabel, buttons) => `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; background: ${bgColor}; border-radius: 8px; margin-bottom: 8px;">
                        <div>
                            <div style="font-weight: 600; color: #1f2937;">${w.wallet_address.slice(0, 6)}...${w.wallet_address.slice(-4)}</div>
                            <div style="font-size: 0.7rem; color: #6b7280;">${new Date(w.requested_at || w.created_at).toLocaleDateString()} â€¢ ${statusLabel}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: #1f2937;">$${parseFloat(w.amount_usd).toFixed(2)}</div>
                            <div style="display: flex; gap: 4px; margin-top: 4px;">${buttons}</div>
                        </div>
                    </div>
                `;

                // Pending - need approval
                if (pending.length > 0) {
                    html += '<div style="font-size: 0.75rem; font-weight: 700; color: #f97316; margin: 8px 0 4px;">PENDING REVIEW</div>';
                    pending.forEach(w => {
                        html += renderItem(w, 'rgba(249, 115, 22, 0.1)', 'Awaiting review',
                            `<button onclick="approveWithdrawal('${w.id}')" style="font-size: 0.65rem; padding: 3px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">Approve</button>
                             <button onclick="cancelWithdrawal('${w.id}')" style="font-size: 0.65rem; padding: 3px 8px; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Reject</button>`
                        );
                    });
                }

                // Approved - need to prepare USDC
                if (approved.length > 0) {
                    html += '<div style="font-size: 0.75rem; font-weight: 700; color: #3b82f6; margin: 8px 0 4px;">PREPARING USDC</div>';
                    approved.forEach(w => {
                        html += renderItem(w, 'rgba(59, 130, 246, 0.1)', 'Move USDC to treasury',
                            `<button onclick="markWithdrawalReady('${w.id}')" style="font-size: 0.65rem; padding: 3px 8px; background: #22c55e; color: white; border: none; border-radius: 4px; cursor: pointer;">Mark Ready</button>`
                        );
                    });
                }

                // Ready - user can claim
                if (ready.length > 0) {
                    html += '<div style="font-size: 0.75rem; font-weight: 700; color: #22c55e; margin: 8px 0 4px;">READY FOR USER</div>';
                    ready.forEach(w => {
                        html += renderItem(w, 'rgba(34, 197, 94, 0.1)', 'User can claim',
                            `<span style="font-size: 0.65rem; color: #22c55e;">âœ“ Waiting for user</span>`
                        );
                    });
                }

                listEl.innerHTML = html;

            } catch (error) {
                console.error('Error loading pending withdrawals:', error);
                listEl.innerHTML = '<div style="color: #ef4444;">Error loading withdrawals</div>';
            }
        }

        // Admin: Mark withdrawal as ready (USDC has been moved to treasury)
        async function markWithdrawalReady(withdrawalId) {
            if (!confirm('Mark this withdrawal as ready?\n\nThis means USDC has been moved to the treasury contract and user can now claim.')) return;

            try {
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?id=eq.${withdrawalId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            status: 'ready',
                            ready_at: new Date().toISOString()
                        })
                    }
                );

                if (!response.ok) throw new Error('Failed to update');

                showNotification('âœ“', 'Ready', 'Withdrawal marked as ready. User can now claim.');
                loadPendingWithdrawals();
            } catch (error) {
                console.error('Error marking ready:', error);
                showNotification('âŒ', 'Error', 'Failed to mark as ready');
            }
        }

        // Admin: Cancel/reject a withdrawal
        async function cancelWithdrawal(withdrawalId) {
            const reason = prompt('Reason for rejection (optional):');
            if (reason === null) return; // User cancelled prompt

            try {
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?id=eq.${withdrawalId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            status: 'cancelled',
                            cancelled_at: new Date().toISOString(),
                            admin_notes: reason || 'Rejected by admin'
                        })
                    }
                );

                if (!response.ok) throw new Error('Failed to update');

                showNotification('âœ“', 'Cancelled', 'Withdrawal request cancelled.');
                loadPendingWithdrawals();
            } catch (error) {
                console.error('Error cancelling:', error);
                showNotification('âŒ', 'Error', 'Failed to cancel');
            }
        }

        // Admin: Approve a withdrawal request (marks as approved - need to prepare USDC next)
        async function approveWithdrawal(withdrawalId) {
            // First get the withdrawal details
            try {
                const detailsResponse = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?id=eq.${withdrawalId}&select=wallet_address,amount_usd`,
                    {
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                        }
                    }
                );

                if (!detailsResponse.ok) throw new Error('Failed to get withdrawal details');

                const details = await detailsResponse.json();
                if (!details.length) throw new Error('Withdrawal not found');

                const { wallet_address, amount_usd } = details[0];

                if (!confirm(`Approve $${amount_usd} withdrawal for ${wallet_address.slice(0, 6)}...?\n\nAfter approving, you need to:\n1. Move $${amount_usd} USDC to the treasury contract\n2. Click "Mark Ready" when done`)) return;

                // Update Supabase status to 'approved'
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?id=eq.${withdrawalId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({
                            status: 'approved',
                            approved_at: new Date().toISOString()
                        })
                    }
                );

                if (response.ok) {
                    showNotification('âœ…', 'Approved', `Withdrawal approved. Now move $${amount_usd} USDC to treasury, then mark as ready.`);
                    loadPendingWithdrawals();
                } else {
                    throw new Error('Failed to update status');
                }
            } catch (error) {
                console.error('Error approving withdrawal:', error);
                if (error.code === 4001) {
                    showNotification('âš ï¸', 'Cancelled', 'Transaction was rejected');
                } else {
                    showNotification('âŒ', 'Error', error.message || 'Failed to approve withdrawal');
                }
            }
        }

        // Admin: Process all pending withdrawals at once
        async function processAllWithdrawals() {
            if (!confirm('Approve ALL pending withdrawals? Make sure you have enough USDC in treasury.')) return;

            try {
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?status=eq.pending`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'approved',
                            processed_at: new Date().toISOString()
                        })
                    }
                );

                if (response.ok) {
                    showNotification('âœ…', 'Processed', 'All withdrawals approved!');
                    loadPendingWithdrawals();
                } else {
                    throw new Error('Failed to process');
                }
            } catch (error) {
                console.error('Error processing withdrawals:', error);
                showNotification('âŒ', 'Error', 'Failed to process withdrawals');
            }
        }

        // Add new position (placeholder)
        function addPosition() {
            showNotification('ðŸ“', 'Positions', 'Position tracking is manual - update values in the UI');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.wallet-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show the selected tab content
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
            }

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load staking data when switching to staking tab
            if (tabName === 'staking') {
                loadStakingData();
                loadAppsForStaking();
            }
        }

        // ========== STAKING SYSTEM ==========

        // AppStaking Contract on Base Mainnet
        const APP_STAKING_ADDRESS = '0x6074E2aD3871Bd0c6981b597280c544b68C1AF4c';
        const APP_STAKING_ABI = [
            "function stake(uint256 amount) external",
            "function withdraw(uint256 amount) external",
            "function allocate(bytes32 appId, uint256 amount) external",
            "function deallocate(bytes32 appId, uint256 amount) external",
            "function getUserStake(address user) view returns (uint256 totalStaked, uint256 unallocatedPower, uint256 allocatedPower)",
            "function getUserAllocation(address user, bytes32 appId) view returns (uint256)",
            "function getAppTier(bytes32 appId) view returns (uint256)",
            "function getAppProgress(bytes32 appId) view returns (uint256 currentTier, uint256 currentPower, uint256 nextThreshold, uint256 progressBps)"
        ];

        let stakingContract = null;

        // Initialize staking contract when wallet connects
        async function initStakingContract() {
            if (!window.ethereum || !signer) return null;
            try {
                stakingContract = new ethers.Contract(APP_STAKING_ADDRESS, APP_STAKING_ABI, signer);
                return stakingContract;
            } catch (error) {
                console.error('Error initializing staking contract:', error);
                return null;
            }
        }

        // Load apps for the staking dropdown (populates BOTH main and tab dropdowns)
        async function loadAppsForStaking() {
            const selectMain = document.getElementById('stakingAppSelectMain');
            const selectTab = document.getElementById('stakingAppSelect');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?select=id,name,slug&status=in.(published,approved,featured)&order=name`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const apps = await response.json();

                // Populate both dropdowns
                [selectMain, selectTab].forEach(select => {
                    if (!select) return;
                    select.innerHTML = '<option value="">Choose an app...</option>';
                    apps.forEach(app => {
                        const option = document.createElement('option');
                        option.value = app.slug;
                        option.textContent = app.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading apps for staking:', error);
            }
        }

        // Combined Stake + Allocate for main view quick action
        async function stakeAndAllocate() {
            const amountInput = document.getElementById('stakeAmountMain');
            const appSelect = document.getElementById('stakingAppSelectMain');
            const amount = amountInput?.value;
            const appSlug = appSelect?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a stake amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('â³', 'Staking', 'Please approve SUITE spending...');

                // First approve SUITE spending
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);
                const amountWei = ethers.parseEther(amount);

                const allowance = await suiteToken.allowance(walletAddress, APP_STAKING_ADDRESS);
                if (allowance < amountWei) {
                    const approveTx = await suiteToken.approve(APP_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                showNotification('â³', 'Staking', 'Please confirm the stake transaction...');

                if (!stakingContract) await initStakingContract();
                const stakeTx = await stakingContract.stake(amountWei);
                await stakeTx.wait();

                // If an app is selected, allocate to it
                if (appSlug) {
                    showNotification('â³', 'Allocating', 'Please confirm allocation...');
                    const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                    const allocateTx = await stakingContract.allocate(appId, amountWei);
                    await allocateTx.wait();
                    showNotification('âœ…', 'Success', `Staked ${amount} SUITE and allocated to ${appSelect.options[appSelect.selectedIndex].text}!`);
                } else {
                    showNotification('âœ…', 'Success', `Staked ${amount} SUITE!`);
                }

                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Stake error:', error);
                showNotification('âŒ', 'Error', error.reason || error.message || 'Staking failed');
            }
        }

        // Load apps on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadAppsForStaking();
        });

        // Load user's staking data
        async function loadStakingData() {
            const updateEl = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            if (!walletAddress) {
                updateEl('stakingTotalStaked', '0 SUITE');
                updateEl('stakingAllocated', '0 SUITE');
                updateEl('stakingAvailable', '0 SUITE');
                updateEl('stakingTotalStakedMain', '0 SUITE');
                return;
            }

            try {
                if (!stakingContract) await initStakingContract();
                if (!stakingContract) return;

                const [totalStaked, unallocatedPower, allocatedPower] = await stakingContract.getUserStake(walletAddress);

                const totalFormatted = `${formatNumber(ethers.formatEther(totalStaked))} SUITE`;
                const allocatedFormatted = `${formatNumber(ethers.formatEther(allocatedPower))} SUITE`;
                const availableFormatted = `${formatNumber(ethers.formatEther(unallocatedPower))} SUITE`;

                // Update both main view and tab view
                updateEl('stakingTotalStaked', totalFormatted);
                updateEl('stakingAllocated', allocatedFormatted);
                updateEl('stakingAvailable', availableFormatted);
                updateEl('stakingTotalStakedMain', totalFormatted);

                // Load allocations
                await loadUserAllocations();
            } catch (error) {
                console.error('Error loading staking data:', error);
            }
        }

        // Load user's allocations
        async function loadUserAllocations() {
            const listEl = document.getElementById('stakingAllocationsList');
            if (!listEl || !walletAddress) return;

            try {
                // Fetch from Supabase (cached data)
                const response = await fetch(`${SUPABASE_URL}/rest/v1/app_stakes?staker_address=eq.${walletAddress.toLowerCase()}&select=*,apps(name,slug,icon_url)`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const allocations = await response.json();

                if (!allocations || allocations.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">No allocations yet. Deposit ETH/USDC and stake LP tokens to support an app!</div>';
                    return;
                }

                listEl.innerHTML = allocations.map(alloc => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(168, 85, 247, 0.05); border-radius: 12px;">
                        <img src="${alloc.apps?.icon_url || '/assets/suite-logo-new.png'}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;" onerror="this.src='/assets/suite-logo-new.png'">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #2d1b4e;">${alloc.apps?.name || 'Unknown App'}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">${formatNumber(alloc.amount_staked)} SUITE allocated</div>
                        </div>
                        <button onclick="deallocatePower('${alloc.apps?.slug}', ${alloc.amount_staked})" style="padding: 6px 12px; background: white; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading allocations:', error);
                listEl.innerHTML = '<div style="text-align: center; padding: 24px; color: #ef4444; font-size: 0.9rem;">Error loading allocations</div>';
            }
        }

        // Stake SUITE tokens
        async function stakeSUITE() {
            const amountInput = document.getElementById('stakeAmount');
            const amount = amountInput?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('â³', 'Staking', 'Please approve SUITE spending...');

                // First approve SUITE spending
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);
                const amountWei = ethers.parseEther(amount);

                const allowance = await suiteToken.allowance(walletAddress, APP_STAKING_ADDRESS);
                if (allowance < amountWei) {
                    const approveTx = await suiteToken.approve(APP_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                showNotification('â³', 'Staking', 'Please confirm the stake transaction...');

                if (!stakingContract) await initStakingContract();
                const tx = await stakingContract.stake(amountWei);
                await tx.wait();

                showNotification('âœ…', 'Success', `Staked ${amount} SUITE!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Stake error:', error);
                showNotification('âŒ', 'Error', error.reason || error.message || 'Staking failed');
            }
        }

        // Withdraw staked SUITE
        async function withdrawStake() {
            const amountInput = document.getElementById('withdrawStakeAmount');
            const amount = amountInput?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('â³', 'Withdrawing', 'Please confirm the withdrawal...');

                if (!stakingContract) await initStakingContract();
                const amountWei = ethers.parseEther(amount);
                const tx = await stakingContract.withdraw(amountWei);
                await tx.wait();

                showNotification('âœ…', 'Success', `Withdrawn ${amount} SUITE!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('âŒ', 'Error', error.reason || error.message || 'Withdrawal failed');
            }
        }

        // Allocate power to an app
        async function allocatePower() {
            const appSelect = document.getElementById('stakingAppSelect');
            const amountInput = document.getElementById('allocateAmount');
            const appSlug = appSelect?.value;
            const amount = amountInput?.value;

            if (!appSlug) {
                showNotification('âš ï¸', 'Error', 'Please select an app');
                return;
            }

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('âš ï¸', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('â³', 'Allocating', 'Please confirm the allocation...');

                if (!stakingContract) await initStakingContract();

                // Convert app slug to bytes32
                const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                const amountWei = ethers.parseEther(amount);

                const tx = await stakingContract.allocate(appId, amountWei);
                await tx.wait();

                showNotification('âœ…', 'Success', `Allocated ${amount} power to ${appSelect.options[appSelect.selectedIndex].text}!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Allocate error:', error);
                showNotification('âŒ', 'Error', error.reason || error.message || 'Allocation failed');
            }
        }

        // Deallocate power from an app
        async function deallocatePower(appSlug, amount) {
            if (!confirm(`Remove ${formatNumber(amount)} power from this app?`)) return;

            try {
                showNotification('â³', 'Removing', 'Please confirm the deallocation...');

                if (!stakingContract) await initStakingContract();

                const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                const amountWei = ethers.parseEther(amount.toString());

                const tx = await stakingContract.deallocate(appId, amountWei);
                await tx.wait();

                showNotification('âœ…', 'Success', 'Power removed!');
                await loadStakingData();
            } catch (error) {
                console.error('Deallocate error:', error);
                showNotification('âŒ', 'Error', error.reason || error.message || 'Deallocation failed');
            }
        }

        // Helper to format numbers
        function formatNumber(num) {
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(2);
        }

        // Wallet Connection Logic
        const walletDashboard = document.getElementById('walletDashboard');
        const connectBtn = document.getElementById('connectWalletBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const addressDisplay = document.getElementById('walletAddressDisplay');
        const connectedInfo = document.getElementById('walletConnectedInfo');

        // Check if MetaMask is installed
        const isMetaMaskInstalled = () => typeof window.ethereum !== 'undefined';

        // Connect wallet (only if element exists)
        if (connectBtn) {
            connectBtn.addEventListener('click', async () => {
                if (!isMetaMaskInstalled()) {
                    alert('Please install MetaMask to connect your wallet!');
                    window.open('https://metamask.io/download/', '_blank');
                    return;
                }

                try {
                    const accounts = await window.ethereum.request({
                        method: 'eth_requestAccounts'
                    });

                    if (accounts.length > 0) {
                        const address = accounts[0];
                        showConnectedState(address);
                    }
                } catch (error) {
                    console.error('Error connecting wallet:', error);
                    alert('Failed to connect wallet. Please try again.');
                }
            });
        }

        // Disconnect wallet (only if element exists)
        if (disconnectBtn) {
            disconnectBtn.addEventListener('click', () => {
                showDisconnectedState();
            });
        }

        function showConnectedState(address) {
            const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
            if (addressDisplay) addressDisplay.textContent = shortAddress;

            // Set global wallet address
            window.walletAddress = address;

            // Show connected UI, hide connect button (only if elements exist)
            if (connectBtn) connectBtn.style.display = 'none';
            if (connectedInfo) connectedInfo.style.display = 'flex';
            if (disconnectBtn) disconnectBtn.style.display = 'block';

            // Set initial balances to 0 (real values come from fetchTreasuryStats)
            document.getElementById('availableBalance').textContent = '0';
            document.getElementById('stakedBalance').textContent = '0';
            document.getElementById('totalValue').textContent = '$0.00';

            // Fetch real balance from chain
            fetchUserSuiteBalance(address);

            // Fetch and show wallet ETH balance
            fetchWalletEthBalance(address);

            // Check if connected wallet is the contract owner
            checkIfOwner(address);

            // Show admin dashboard if admin wallet
            if (typeof updateAdminDashboardVisibility === 'function') {
                updateAdminDashboardVisibility();
            }
        }

        async function fetchWalletEthBalance(address) {
            try {
                if (!window.ethereum) return;

                // Get ETH balance
                const balanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                });

                const ethBalance = parseInt(balanceHex, 16) / 1e18;
                const usdValue = ethBalance * ETH_PRICE_USD;

                // Update UI
                document.getElementById('walletEthBalance').textContent = `${ethBalance.toFixed(6)} ETH`;
                document.getElementById('walletEthValue').textContent = `~$${usdValue.toFixed(2)}`;
                document.getElementById('walletEthSection').style.display = 'block';

            } catch (error) {
                console.error('Error fetching wallet ETH balance:', error);
            }
        }

        async function fetchUserSuiteBalance(address) {
            try {
                if (!window.ethereum) return;

                const provider = new ethers.BrowserProvider(window.ethereum);
                const suiteContract = new ethers.Contract(SUITE_TOKEN_ADDRESS, SUITE_ABI, provider);

                const balance = await suiteContract.balanceOf(address);
                const formattedBalance = ethers.formatUnits(balance, 18);
                const numericBalance = parseFloat(formattedBalance);
                const displayBalance = numericBalance.toLocaleString(undefined, { maximumFractionDigits: 2 });

                document.getElementById('availableBalance').textContent = displayBalance;

                // Calculate USD value based on backing rate from treasury
                // Get backing rate from displayed value or calculate
                const backingRateText = document.getElementById('backingRate').textContent;
                const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;

                // Total Value = balance * backing rate (after 0.5% fee)
                const totalUsdValue = numericBalance * backingRate * 0.995;
                document.getElementById('totalValue').textContent = `$${totalUsdValue.toFixed(2)}`;

            } catch (error) {
                console.log('Could not fetch SUITE balance:', error);
            }
        }

        // Add SUITE token to MetaMask
        async function addSuiteToWallet() {
            if (!isMetaMaskInstalled()) {
                showNotification('??', 'MetaMask Required', 'Please install MetaMask to add tokens to your wallet.');
                return;
            }

            try {
                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: SUITE_TOKEN_ADDRESS,
                            symbol: 'SUITE',
                            decimals: 18,
                            image: 'https://your-domain.com/suite-icon.png' // Optional: Add your logo URL
                        },
                    },
                });

                if (wasAdded) {
                    showNotification('?', 'Token Added!', 'SUITE has been added to your MetaMask wallet.');
                }
            } catch (error) {
                console.error('Error adding token:', error);
                showNotification('?', 'Failed to Add Token', error.message || 'Could not add SUITE to wallet.');
            }
        }

        function showDisconnectedState() {
            // Show connect button, hide connected UI (only if elements exist)
            if (connectBtn) connectBtn.style.display = 'block';
            if (connectedInfo) connectedInfo.style.display = 'none';
            if (disconnectBtn) disconnectBtn.style.display = 'none';

            // Hide admin panel
            const adminPanel = document.getElementById('adminPanel');
            if (adminPanel) adminPanel.style.display = 'none';

            // Reset balances to 0 but keep dashboard visible
            document.getElementById('availableBalance').textContent = '0';
            document.getElementById('stakedBalance').textContent = '0';
            document.getElementById('totalValue').textContent = '$0.00';
        }

        // Check if already connected
        async function checkConnection() {
            if (isMetaMaskInstalled()) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    showConnectedState(accounts[0]);
                }
            }
        }

        // Listen for account changes
        if (isMetaMaskInstalled()) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    showDisconnectedState();
                } else {
                    showConnectedState(accounts[0]);
                }
            });
        }

        // Check connection on load
        checkConnection();

        // Poll for wallet changes (catches connections via nav modal)
        let lastKnownWallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWallet') || null;
        setInterval(() => {
            const currentWallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWallet');
            if (currentWallet !== lastKnownWallet) {
                lastKnownWallet = currentWallet;
                if (currentWallet) {
                    window.walletAddress = currentWallet;
                    showConnectedState(currentWallet);
                } else {
                    showDisconnectedState();
                }
            }
        }, 500);

        // Modal Functions
        let selectedAmount = 50;

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Custom notification modal functions
        function showNotification(icon, title, message, details = '') {
            document.getElementById('notificationIcon').textContent = icon;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            document.getElementById('notificationDetails').textContent = details;
            openModal('notificationModal');
        }

        function closeNotification() {
            closeModal('notificationModal');
            // Refresh balances after closing notification
            checkConnection();
            fetchTreasuryStats();
        }

        // Close modal when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        function selectAmount(amount, element) {
            selectedAmount = amount;
            document.querySelectorAll('.amount-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            const customAmountEl = document.getElementById('customAmount');
            if (customAmountEl) customAmountEl.value = '';
            updateSuitePreview();
        }

        function updateSuitePreview() {
            const customAmountEl = document.getElementById('customAmount');
            const suitePreviewEl = document.getElementById('suitePreviewValue');
            if (!suitePreviewEl) return;

            const customAmount = customAmountEl ? parseFloat(customAmountEl.value) : '';
            const amount = customAmount ? parseFloat(customAmount) : selectedAmount;
            const suiteAmount = (amount * 1000).toLocaleString();
            suitePreviewEl.textContent = suiteAmount + ' SUITE';
        }

        function handlePayment(method) {
            // Get amount safely (customAmount might not exist in simplified modal)
            const customAmountEl = document.getElementById('customAmount');
            const amount = customAmountEl ? (parseFloat(customAmountEl.value) || selectedAmount) : selectedAmount;

            switch (method) {
                case 'card':
                    alert(`[STRIPE] Would open Stripe checkout for $${amount}\n\nThis will:\n1. Charge your card $${amount}\n2. Deposit to treasury\n3. Mint ${(amount * 1000).toLocaleString()} SUITE to your wallet\n4. ONE popup (approval + deposit bundled)`);
                    closeModal('depositModal');
                    break;
                case 'apple':
                    alert(`[APPLE PAY] Would trigger Apple Pay for $${amount}`);
                    closeModal('depositModal');
                    break;
                case 'crypto':
                    // Open the new crypto deposit modal
                    closeModal('depositModal');
                    openCryptoDepositModal();
                    break;
            }
        }

        // Open crypto deposit modal
        function openCryptoDepositModal() {
            showCryptoDeposit();
        }

        // ===== CRYPTO DEPOSIT FUNCTIONS =====

        // Configuration - DEPLOYED CONTRACTS
        const BASE_CHAIN_ID = '0x2105'; // Base Mainnet: 8453
        const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; // Base Sepolia: 84532
        const BASE_RPC_URL = 'https://mainnet.base.org';
        const ETH_PRICE_USD = 3650; // For UI display only - V4 uses proportional shares

        // Fetch and display real Treasury TVL on page load
        async function updateTreasuryTVL() {
            const tvlDisplay = document.getElementById('vaultTVL');
            if (!tvlDisplay) {
                console.log('TVL display element not found, retrying...');
                setTimeout(updateTreasuryTVL, 500);
                return;
            }

            try {
                const treasuryAddress = '0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1';

                // Fetch ETH balance via public RPC
                const response = await fetch('https://mainnet.base.org', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jsonrpc: '2.0',
                        method: 'eth_getBalance',
                        params: [treasuryAddress, 'latest'],
                        id: 1
                    })
                });

                const data = await response.json();
                console.log('Treasury RPC response:', data);

                if (data.result) {
                    const ethBalance = parseInt(data.result, 16) / 1e18;
                    const usdValue = ethBalance * 3650; // ETH price

                    // Format the TVL display
                    let displayText;
                    if (usdValue >= 1000000) {
                        displayText = '$' + (usdValue / 1000000).toFixed(2) + 'M';
                    } else if (usdValue >= 1000) {
                        displayText = '$' + (usdValue / 1000).toFixed(1) + 'K';
                    } else if (usdValue >= 0.01) {
                        displayText = '$' + usdValue.toFixed(2);
                    } else if (usdValue > 0) {
                        // Show very small amounts with more precision
                        displayText = '$' + usdValue.toFixed(6);
                    } else {
                        displayText = '$0.00';
                    }

                    tvlDisplay.textContent = displayText;
                    tvlDisplay.title = ethBalance.toFixed(10) + ' ETH\n$' + usdValue.toFixed(8) + ' USD';
                    tvlDisplay.style.cursor = 'help';

                    console.log('Treasury TVL:', ethBalance.toFixed(10), 'ETH (~$' + usdValue.toFixed(6) + ')');
                }
            } catch (error) {
                console.error('Error fetching treasury TVL:', error);
                tvlDisplay.textContent = '$0.00';
            }
        }

        // Load TVL after page is ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(updateTreasuryTVL, 100);
                loadVaultPublicStats(); // Load from Supabase reports
                loadYieldAllocationStats(); // Load yield split stats
            });
        } else {
            setTimeout(updateTreasuryTVL, 100);
            loadVaultPublicStats(); // Load from Supabase reports
            loadYieldAllocationStats(); // Load yield split stats
        }

        // ===== DEPLOYED SUITE CONTRACTS =====
        const SUITE_TOKEN_ADDRESS = '0xE6892803DF59D79cFB4794e7da9549df4eE70f71';
        const TREASURY_ADDRESS = '0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1'; // TreasuryV4 with 0x
        const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // Base Mainnet USDC

        // ===== 0x API CONFIG =====
        // API key is optional - 0x has free public access
        // Get a key from https://dashboard.0x.org for higher rate limits
        const ZERO_X_API_KEY = ''; // Optional - leave empty for free tier
        const ZERO_X_API_URL = 'https://base.api.0x.org'; // Base mainnet endpoint

        // TreasuryV4 ABI (proportional share model with 0x)
        const TREASURY_ABI = [
            'function depositETH() external payable',
            'function depositWithSwap(address sellToken, uint256 sellAmount, bytes calldata swapCalldata) external',
            'function withdraw(uint256 suiteAmount) external',
            'function previewDeposit(uint256 ethAmount) external view returns (uint256)',
            'function previewWithdraw(uint256 suiteAmount) external view returns (uint256)',
            'function getTreasuryStats() external view returns (uint256 treasuryETH, uint256 totalSupply, uint256 suitePerETH)',
            'function totalTreasuryETH() external view returns (uint256)'
        ];

        // SUITE Token ABI
        const SUITE_ABI = [
            'function totalSupply() external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)'
        ];

        // ERC-20 ABI for approvals and balances
        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)',
            'function decimals() external view returns (uint8)'
        ];

        // Function to get 0x swap quote
        async function get0xQuote(sellToken, buyToken, sellAmount) {
            const params = new URLSearchParams({
                sellToken: sellToken,
                buyToken: buyToken,
                sellAmount: sellAmount,
                takerAddress: await getConnectedAddress()
            });

            // Build headers - only include API key if provided
            const headers = {};
            if (ZERO_X_API_KEY) {
                headers['0x-api-key'] = ZERO_X_API_KEY;
            }

            const response = await fetch(`${ZERO_X_API_URL}/swap/v1/quote?${params}`, { headers });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.reason || 'Failed to get 0x quote');
            }

            return await response.json();
        }

        async function getConnectedAddress() {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            return accounts[0];
        }

        let selectedCryptoAsset = 'eth';
        let walletBalances = { eth: 0, usdc: 0 };

        // Fetch and display live treasury values
        async function fetchTreasuryStats() {
            try {
                // Get ETH balance of treasury contract directly
                const treasuryBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [TREASURY_ADDRESS, 'latest']
                });
                const treasuryEth = treasuryBalanceHex ? parseInt(treasuryBalanceHex, 16) / 1e18 : 0;

                // Get total SUITE supply
                const supplyData = '0x18160ddd'; // totalSupply()
                const supplyHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: SUITE_TOKEN_ADDRESS, data: supplyData }, 'latest']
                });
                const totalSupply = supplyHex && supplyHex !== '0x' ? parseInt(supplyHex, 16) / 1e18 : 0;

                // Calculate total treasury value in USD
                const treasuryValueUsd = isNaN(treasuryEth) ? 0 : treasuryEth * ETH_PRICE_USD;
                const displayEth = isNaN(treasuryEth) ? 0 : treasuryEth;
                const displaySupply = isNaN(totalSupply) ? 0 : totalSupply;

                // Update UI - stacked display with precision
                document.getElementById('treasuryValueUsd').textContent = '$' + treasuryValueUsd.toFixed(6);
                document.getElementById('treasuryValueEth').textContent = displayEth.toFixed(10) + ' ETH';
                document.getElementById('totalSupply').textContent =
                    displaySupply.toLocaleString() + ' SUITE';

                // Calculate backing rate (floor price)
                const backingRate = displaySupply > 0 ? treasuryValueUsd / displaySupply : 0;
                document.getElementById('backingRate').textContent =
                    '$' + backingRate.toFixed(6) + '/SUITE';

                // Calculate market cap (floor price * supply = treasury value for now)
                // When DEX is live, this would be DEX price * supply
                const marketCap = treasuryValueUsd; // For now, market cap = treasury value
                document.getElementById('marketCap').textContent =
                    '$' + marketCap.toFixed(2);

                // Fees collected (placeholder - would come from contract events)
                document.getElementById('feesCollected').textContent = '$0.00';

            } catch (error) {
                console.error('Error fetching treasury stats:', error);
                // Show zeros if contract not ready
                document.getElementById('treasuryValueUsd').textContent = '$0.000000';
                document.getElementById('treasuryValueEth').textContent = '0.0000000000 ETH';
                document.getElementById('totalSupply').textContent = '0 SUITE';
                document.getElementById('backingRate').textContent = '$0.000000/SUITE';
            }
        }

        async function openCryptoDepositModal() {
            // First, just open the modal immediately
            openModal('cryptoDepositModal');

            // Then try to fetch data (don't block modal opening)
            try {
                await fetchWalletBalances();
            } catch (e) { console.log('fetchWalletBalances error:', e); }

            try {
                await checkNetwork();
            } catch (e) { console.log('checkNetwork error:', e); }

            try {
                await fetchTreasuryStats();
            } catch (e) { console.log('fetchTreasuryStats error:', e); }

            try {
                updateCryptoPreview();
            } catch (e) { console.log('updateCryptoPreview error:', e); }
        }

        async function checkNetwork() {
            if (!isMetaMaskInstalled()) return;

            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const isBase = chainId === BASE_CHAIN_ID || chainId === BASE_SEPOLIA_CHAIN_ID;

                document.getElementById('networkWarning').style.display = isBase ? 'none' : 'flex';
            } catch (error) {
                console.error('Error checking network:', error);
            }
        }

        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_CHAIN_ID }],
                });
                document.getElementById('networkWarning').style.display = 'none';
                await fetchWalletBalances();
            } catch (switchError) {
                // Chain not added to MetaMask - add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org'],
                            }],
                        });
                    } catch (addError) {
                        console.error('Error adding Base network:', addError);
                    }
                }
            }
        }

        async function fetchWalletBalances() {
            if (!isMetaMaskInstalled()) return;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                const address = accounts[0];

                // Fetch ETH balance
                const ethBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                });
                const ethBalance = parseInt(ethBalanceHex, 16) / 1e18;
                walletBalances.eth = ethBalance;

                // Update UI
                document.getElementById('ethBalance').textContent = ethBalance.toFixed(4);
                document.getElementById('ethUsdValue').textContent = `~$${(ethBalance * ETH_PRICE_USD).toFixed(2)}`;

                // Fetch USDC balance (ERC-20)
                try {
                    const usdcBalanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{
                            to: USDC_ADDRESS,
                            data: '0x70a08231000000000000000000000000' + address.slice(2)
                        }, 'latest']
                    });
                    const usdcBalance = parseInt(usdcBalanceHex, 16) / 1e6; // USDC has 6 decimals
                    walletBalances.usdc = usdcBalance;

                    document.getElementById('usdcBalance').textContent = usdcBalance.toFixed(2);
                    document.getElementById('usdcUsdValue').textContent = `~$${usdcBalance.toFixed(2)}`;
                } catch (e) {
                    // USDC might not be on the current network
                    document.getElementById('usdcBalance').textContent = '0.00';
                    document.getElementById('usdcUsdValue').textContent = '~$0.00';
                }

            } catch (error) {
                console.error('Error fetching balances:', error);
            }
        }

        function selectAsset(asset, element) {
            selectedCryptoAsset = asset;
            document.querySelectorAll('.asset-tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('inputAssetLabel').textContent = asset.toUpperCase();
            document.getElementById('cryptoDepositAmount').value = '';
            updateCryptoPreview();
        }

        function adjustAmount(delta) {
            const input = document.getElementById('cryptoDepositAmount');
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + delta);
            // Show 6 decimals for ETH, 2 for USDC
            const decimals = selectedCryptoAsset === 'eth' ? 6 : 2;
            input.value = newValue.toFixed(decimals);
            updateCryptoPreview();
        }

        function setPercentage(percent) {
            const balance = selectedCryptoAsset === 'eth' ? walletBalances.eth : walletBalances.usdc;
            const amount = (balance * percent / 100);

            // For ETH, leave a little for gas
            const finalAmount = selectedCryptoAsset === 'eth' && percent === 100
                ? Math.max(0, amount - 0.0005) // leave 0.0005 for gas
                : amount;

            // Show 6 decimals for ETH, 2 for USDC
            const decimals = selectedCryptoAsset === 'eth' ? 6 : 2;
            document.getElementById('cryptoDepositAmount').value = finalAmount.toFixed(decimals);
            updateCryptoPreview();
        }

        function updateCryptoPreview() {
            const amount = parseFloat(document.getElementById('cryptoDepositAmount').value) || 0;
            let usdValue = 0;

            if (selectedCryptoAsset === 'eth') {
                usdValue = amount * ETH_PRICE_USD;
            } else {
                usdValue = amount; // USDC is 1:1 with USD
            }

            // After 0.5% fee
            const afterFee = usdValue * 0.995;
            // 1000 SUITE per $1
            const suiteAmount = Math.floor(afterFee * 1000);

            document.getElementById('cryptoSuitePreview').textContent =
                suiteAmount.toLocaleString() + ' SUITE';

            // Show USD value
            document.getElementById('cryptoUsdPreview').textContent =
                `(~$${afterFee.toFixed(2)})`;

            // Enable/disable deposit button
            document.getElementById('cryptoDepositBtn').disabled = suiteAmount === 0;
        }

        async function executeCryptoDeposit() {
            const amount = parseFloat(document.getElementById('cryptoDepositAmount').value) || 0;
            if (amount <= 0) {
                showNotification('??', 'Enter an Amount', 'Please enter an amount to deposit.');
                return;
            }

            const btn = document.getElementById('cryptoDepositBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '? Processing...';
            btn.disabled = true;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    showNotification('??', 'Connect Wallet', 'Please connect your wallet first.');
                    return;
                }

                const fromAddress = accounts[0];

                if (selectedCryptoAsset === 'eth') {
                    // For ETH deposits - call depositETH() on Treasury
                    // This will mint SUITE tokens to the user
                    const amountWei = '0x' + Math.floor(amount * 1e18).toString(16);

                    // depositETH() function selector
                    const depositEthData = '0xf6326fb3'; // depositETH()

                    btn.innerHTML = '?? Depositing ETH...';

                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: fromAddress,
                            to: TREASURY_ADDRESS,
                            value: amountWei,
                            data: depositEthData,
                        }],
                    });

                    const suiteReceived = Math.floor(amount * ETH_PRICE_USD * 0.995 * 1000);
                    closeModal('cryptoDepositModal');
                    showNotification(
                        '?',
                        'ETH Deposit Submitted!',
                        `You'll receive ~${suiteReceived.toLocaleString()} SUITE once the transaction confirms.`,
                        `Tx: ${txHash}`
                    );

                    // Prompt to link Discord if not logged in (to use credits in apps)
                    const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                    if (!currentUser?.id) {
                        setTimeout(() => showDiscordLinkPrompt(fromAddress), 2000);
                    }

                    // Refresh treasury stats after deposit
                    setTimeout(() => {
                        fetchTreasuryStats();
                        checkConnection();
                    }, 5000);

                } else {
                    // USDC deposits via Treasury contract
                    const amountUSDC = Math.floor(amount * 1e6); // USDC has 6 decimals

                    // Step 1: Check if we need to approve USDC spending
                    btn.innerHTML = '?? Checking approval...';

                    // Check current allowance
                    const allowanceData = '0xdd62ed3e' +
                        fromAddress.slice(2).padStart(64, '0') +
                        TREASURY_ADDRESS.slice(2).padStart(64, '0');

                    const allowanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: USDC_ADDRESS, data: allowanceData }, 'latest']
                    });

                    const currentAllowance = parseInt(allowanceHex, 16);

                    if (currentAllowance < amountUSDC) {
                        // Need to approve
                        btn.innerHTML = '?? Approve USDC...';

                        const approveData = '0x095ea7b3' +
                            TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                            amountUSDC.toString(16).padStart(64, '0'); // Approve exact amount only

                        await window.ethereum.request({
                            method: 'eth_sendTransaction',
                            params: [{
                                from: fromAddress,
                                to: USDC_ADDRESS,
                                data: approveData,
                            }]
                        });

                        alert('? USDC Approved!\n\nNow click Deposit again to complete the deposit.');
                        btn.innerHTML = '?? Deposit Now';
                        btn.disabled = false;
                        return;
                    }

                    // Step 2: Deposit USDC to Treasury
                    btn.innerHTML = '?? Depositing...';

                    // Encode depositUSDC(amount) call
                    const depositData = '0x47e7ef24' +
                        amountUSDC.toString(16).padStart(64, '0');

                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: fromAddress,
                            to: TREASURY_ADDRESS,
                            data: depositData,
                        }]
                    });

                    const suiteReceived = Math.floor(amount * 0.995 * 1000);
                    closeModal('cryptoDepositModal');
                    showNotification(
                        '?',
                        'USDC Deposit Submitted!',
                        `You'll receive ~${suiteReceived.toLocaleString()} SUITE once the transaction confirms.`,
                        `Tx: ${txHash}`
                    );

                    // Prompt to link Discord if not logged in (to use credits in apps)
                    const currentUserUSDC = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                    if (!currentUserUSDC?.id) {
                        setTimeout(() => showDiscordLinkPrompt(fromAddress), 2000);
                    }

                    // Refresh after deposit
                    setTimeout(() => {
                        fetchTreasuryStats();
                        checkConnection();
                    }, 5000);
                }

            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction was cancelled.');
                } else {
                    showNotification('?', 'Transaction Failed', 'Something went wrong. Please try again.', error.message || '');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleWithdraw(method) {
            const amount = parseFloat(document.getElementById('withdrawAmount').value) || 0;

            // Get backing rate for precise calculation
            const backingRateText = document.getElementById('backingRate').textContent;
            const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
            const usdValue = (amount * backingRate * 0.995); // After 0.5% fee
            const usdcValue = usdValue.toFixed(6); // 6 decimals for USDC precision

            switch (method) {
                case 'paypal':
                    closeModal('withdrawModal');
                    showNotification('???', 'PayPal Cash Out', `Would send $${usdcValue} to your PayPal email.`, 'Coming soon!');
                    break;
                case 'card':
                    closeModal('withdrawModal');
                    showNotification('??', 'Card Refund', `Would refund $${usdcValue} to your original card.`, 'Coming soon!');
                    break;
                case 'giftcard':
                    closeModal('withdrawModal');
                    showNotification('??', 'Gift Card', `Choose a gift card worth $${usdcValue}`, 'Coming soon!');
                    break;
                case 'crypto':
                    // Actually execute the crypto withdrawal
                    await executeCryptoWithdraw(amount);
                    break;
                case 'bank':
                    closeModal('withdrawModal');
                    showNotification('??', 'Bank Transfer', `Would initiate $${usdcValue} transfer.`, 'Coming soon!');
                    break;
            }
        }

        async function executeCryptoWithdraw(suiteAmount) {
            if (suiteAmount <= 0) {
                showNotification('??', 'Enter Amount', 'Please enter an amount to withdraw.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    showNotification('??', 'Connect Wallet', 'Please connect your wallet first.');
                    return;
                }

                const fromAddress = accounts[0];

                closeModal('withdrawModal');
                showNotification('?', 'Processing Withdrawal', 'Please confirm the transaction in MetaMask...', '');

                // Convert SUITE amount to wei (18 decimals)
                const suiteWei = '0x' + Math.floor(suiteAmount * 1e18).toString(16);

                // First: Approve Treasury to spend SUITE tokens
                // approve(address spender, uint256 amount)
                const approveData = '0x095ea7b3' +
                    TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                    suiteWei.slice(2).padStart(64, '0');

                await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: SUITE_TOKEN_ADDRESS,
                        data: approveData,
                    }],
                });

                // Wait a bit for approval to process
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Second: Call withdraw(uint256 suiteAmount) on Treasury
                // Function selector for withdraw(uint256)
                const withdrawData = '0x2e1a7d4d' + suiteWei.slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: TREASURY_ADDRESS,
                        data: withdrawData,
                    }],
                });

                // Calculate expected ETH received
                const backingRateText = document.getElementById('backingRate').textContent;
                const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
                const expectedUsd = suiteAmount * backingRate * 0.995;
                const expectedEth = (expectedUsd / ETH_PRICE_USD).toFixed(8);

                showNotification(
                    '?',
                    'Withdrawal Submitted!',
                    `You'll receive ~${expectedEth} ETH (~$${expectedUsd.toFixed(6)}) once confirmed.`,
                    `Tx: ${txHash}`
                );

                // Refresh balances
                setTimeout(() => {
                    checkConnection();
                    fetchTreasuryStats();
                }, 5000);

            } catch (error) {
                console.error('Withdraw error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction was cancelled.');
                } else {
                    showNotification('?', 'Withdrawal Failed', 'Something went wrong.', error.message || '');
                }
            }
        }

        // Wire up buttons
        document.getElementById('depositBtn').addEventListener('click', () => {
            openModal('depositModal');
        });

        document.getElementById('withdrawBtn').addEventListener('click', () => {
            // Get balance from the displayed available balance
            const availableBalanceText = document.getElementById('availableBalance').textContent;
            const availableBalance = parseFloat(availableBalanceText.replace(/,/g, '')) || 0;

            // Get backing rate for USD calculation
            const backingRateText = document.getElementById('backingRate').textContent;
            const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
            const usdValue = (availableBalance * backingRate * 0.995).toFixed(2);

            // Update Cash Out modal with actual balance
            document.getElementById('cashOutBalance').textContent = `${availableBalance.toLocaleString()} SUITE`;
            document.querySelector('#withdrawModal .balance-display-label').textContent = `Available to cash out ? ? $${usdValue}`;
            document.getElementById('withdrawAmount').value = availableBalance;
            document.getElementById('withdrawAmount').max = availableBalance;

            // Update MAX button
            const maxBtn = document.querySelector('#withdrawModal .amount-option');
            if (maxBtn) {
                maxBtn.onclick = () => { document.getElementById('withdrawAmount').value = availableBalance; };
            }

            openModal('withdrawModal');
        });

        document.getElementById('stakeBtn').addEventListener('click', () => {
            showNotification('?', 'Staking Coming Soon', 'Stake your SUITE to earn voting power and unlock charity voting.');
        });

        // ===== ADMIN PANEL FUNCTIONS =====

        // Hardcoded admin addresses (can see admin panel)
        const ADMIN_ADDRESSES = [
            '0x92d67d8ad8b986e78b369be0272e121ae5acad59', // Stuart's primary wallet
            '0xdefc3ae5a990206101463d208e7e1446c58a72bd', // Treasury owner (deployer)
        ];

        async function checkIfOwner(connectedAddress) {
            try {
                const connectedLower = connectedAddress.toLowerCase();

                // Check if in admin list first
                const isAdmin = ADMIN_ADDRESSES.includes(connectedLower);

                // Also check contract owner
                const ownerData = '0x8da5cb5b'; // owner()
                const ownerHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: TREASURY_ADDRESS, data: ownerData }, 'latest']
                });

                // Extract address from response (remove 0x and leading zeros)
                const ownerAddress = '0x' + ownerHex.slice(26).toLowerCase();
                const isContractOwner = connectedLower === ownerAddress;

                console.log('Admin check:', { connectedLower, ownerAddress, isAdmin, isContractOwner });

                if (isAdmin || isContractOwner) {
                    document.getElementById('adminPanel').style.display = 'block';
                    updateAdminStats();
                } else {
                    document.getElementById('adminPanel').style.display = 'none';
                }

                return isAdmin || isContractOwner;
            } catch (error) {
                console.log('Could not check owner:', error);
                return false;
            }
        }

        async function updateAdminStats() {
            try {
                // Get treasury ETH balance
                const treasuryBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [TREASURY_ADDRESS, 'latest']
                });
                const treasuryEth = parseInt(treasuryBalanceHex, 16) / 1e18;
                const treasuryUsd = treasuryEth * ETH_PRICE_USD;

                // Get actual accumulatedFees from contract
                const feesData = '0x79ddb121'; // accumulatedFees()
                const feesHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: TREASURY_ADDRESS, data: feesData }, 'latest']
                });
                const accumulatedFeesWei = feesHex && feesHex !== '0x' ? parseInt(feesHex, 16) : 0;
                const accumulatedFeesEth = accumulatedFeesWei / 1e18;
                const accumulatedFeesUsd = accumulatedFeesEth * ETH_PRICE_USD;

                document.getElementById('adminTreasuryEth').textContent = treasuryEth.toFixed(10) + ' ETH';
                document.getElementById('accumulatedFees').textContent = '$' + accumulatedFeesUsd.toFixed(6);

                // Enable/disable withdraw button based on minimum threshold (0.001 ETH)
                const withdrawBtn = document.getElementById('withdrawFeesBtn');
                const withdrawHelper = document.getElementById('withdrawFeesHelper');
                const MIN_WITHDRAW_ETH = 0.001;

                if (accumulatedFeesEth >= MIN_WITHDRAW_ETH) {
                    withdrawBtn.disabled = false;
                    withdrawHelper.textContent = `${accumulatedFeesEth.toFixed(6)} ETH available to withdraw`;
                    withdrawHelper.style.color = '#2ecc71';
                } else {
                    withdrawBtn.disabled = true;
                    withdrawHelper.textContent = `Minimum ${MIN_WITHDRAW_ETH} ETH in fees required (current: ${accumulatedFeesEth.toFixed(6)} ETH)`;
                    withdrawHelper.style.color = '#888';
                }
            } catch (error) {
                console.log('Could not update admin stats:', error);
            }
        }

        async function withdrawFees() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                showNotification('?', 'Processing', 'Please confirm in MetaMask...');

                // withdrawFees(address to) function selector: 0x476343ee + address
                // Send fees to the caller's address
                const withdrawFeesData = '0x476343ee' + accounts[0].slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: TREASURY_ADDRESS,
                        data: withdrawFeesData,
                    }],
                });

                showNotification('?', 'Fees Withdrawn!', 'Transaction submitted.', `Tx: ${txHash}`);
                setTimeout(updateAdminStats, 5000);
            } catch (error) {
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled.');
                } else {
                    showNotification('?', 'Error', error.message || 'Failed to withdraw fees.');
                }
            }
        }

        // Community Arbitrage execution
        async function executeArb() {
            const btn = document.getElementById('executeArbBtn');
            const originalText = btn.innerHTML;

            try {
                // Update button to loading state
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size: 1.2rem;">?</span> Executing...';
                btn.style.opacity = '0.7';

                // Mock execution - in production this would:
                // 1. Mint SUITE from Treasury at floor price
                // 2. Sell on DEX at market price
                // 3. Split profit 50/50 (user/treasury)

                await new Promise(resolve => setTimeout(resolve, 2000));

                // Show success
                showNotification('??', 'Arb Executed!', 'You earned +120 SUITE! Treasury received +120 SUITE.');

                // Update button to success
                btn.innerHTML = '<span style="font-size: 1.2rem;">?</span> Success! +120 SUITE';
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';

                // Reset after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.opacity = '1';
                }, 3000);

            } catch (error) {
                showNotification('?', 'Failed', error.message || 'Could not execute arb.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
            }
        }

        // Note: emergencyWithdraw removed - not supported in TreasuryV4

        async function transferOwnership() {
            const newOwner = document.getElementById('newOwnerAddress').value.trim();

            if (!newOwner || !newOwner.startsWith('0x') || newOwner.length !== 42) {
                showNotification('??', 'Invalid Address', 'Please enter a valid Ethereum address.');
                return;
            }

            if (!confirm(`Transfer ownership to:\n${newOwner}\n\nYou will lose admin access. Continue?`)) {
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                showNotification('?', 'Processing', 'Please confirm in MetaMask...');

                // transferOwnership(address) function selector + encoded address
                const transferData = '0xf2fde38b' + newOwner.slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: TREASURY_ADDRESS,
                        data: transferData,
                    }],
                });

                showNotification('?', 'Ownership Transferred', `New owner: ${newOwner.slice(0, 10)}...`, `Tx: ${txHash}`);
                document.getElementById('adminPanel').style.display = 'none';
            } catch (error) {
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled.');
                } else {
                    showNotification('?', 'Error', error.message || 'Failed to transfer ownership.');
                }
            }
        }

        // Fetch treasury stats and check connection on page load
        if (window.ethereum) {
            fetchTreasuryStats();
            checkConnection(); // Auto-connect if already authorized
            // Refresh every 30 seconds
            setInterval(fetchTreasuryStats, 30000);
        }

        // Fetch ad revenue stats from Supabase
        async function fetchAdRevenueStats() {
            const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ad_events?created_at=gte.${today}T00:00:00&event_type=eq.credited&select=error_message,suite_amount`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const events = await response.json();

                if (!Array.isArray(events)) return;

                // Calculate stats
                const totalSuite = events.length * 2; // 2 SUITE per ad
                const verified = events.filter(e => e.error_message?.includes('verified:true')).length;
                const verifiedPercent = events.length > 0 ? Math.round((verified / events.length) * 100) : 0;
                const estimatedRevenue = events.length * 0.002; // ~$0.002 per ad

                // Update UI
                const adRevenueEl = document.getElementById('adRevenueToday');
                const suiteIssuedEl = document.getElementById('suiteIssuedAds');
                const verifiedEl = document.getElementById('verifiedAdsPercent');

                if (adRevenueEl) adRevenueEl.textContent = '$' + estimatedRevenue.toFixed(2);
                if (suiteIssuedEl) suiteIssuedEl.textContent = totalSuite;
                if (verifiedEl) {
                    verifiedEl.textContent = verifiedPercent + '%';
                    // Color based on percentage
                    if (verifiedPercent >= 80) verifiedEl.style.color = '#22c55e';
                    else if (verifiedPercent >= 50) verifiedEl.style.color = '#f59e0b';
                    else verifiedEl.style.color = '#ef4444';
                }
            } catch (error) {
                console.log('Could not fetch ad stats:', error);
            }
        }

        // Load ad stats on page load
        fetchAdRevenueStats();
        setInterval(fetchAdRevenueStats, 60000); // Refresh every minute

        // ============================================
        // BOOST NFT SYSTEM
        // ============================================

        const SUITE_BOOSTS_ADDRESS = null; // TODO: Set after deployment
        const SUITE_BOOSTS_ABI = [
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function getAllBoostBalances(address account) view returns (uint256[5])",
            "function redeem(uint256 boostType, uint256 amount)"
        ];

        const BOOST_TYPES = {
            1: { name: 'Priority Queue', icon: '?', dbType: 'priority-queue' },
            2: { name: 'AI Pack', icon: '??', dbType: 'ai-pack' },
            3: { name: 'App Slot', icon: '??', dbType: 'app-slot' },
            4: { name: 'Featured Week', icon: '?', dbType: 'featured-week' },
            5: { name: '2x Earn', icon: '2??', dbType: '2x-earn' }
        };

        // Load database boosts (from Discord/Supabase)
        async function loadDatabaseBoosts() {
            const container = document.getElementById('databaseBoostsContent');
            if (!container) return;

            // Check for Discord user in localStorage
            const savedUser = localStorage.getItem('suiteUser');
            if (!savedUser) {
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">Connect Discord on <a href="earn.html" style="color: var(--accent-orange);">Earn page</a> to view boosts</span>';
                return;
            }

            const user = JSON.parse(savedUser);

            try {
                const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_boosts?discord_id=eq.${user.id}&status=eq.active&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const boosts = await response.json();

                if (!Array.isArray(boosts) || boosts.length === 0) {
                    container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">No account boosts. <a href="boost.html" style="color: var(--accent-orange);">Buy some ?</a></span>';
                    return;
                }

                container.innerHTML = boosts.map(boost => {
                    const boostInfo = Object.values(BOOST_TYPES).find(b => b.dbType === boost.boost_type) || { name: boost.boost_type, icon: '??' };
                    return `
                        <div class="boost-item">
                            <span class="boost-item-icon">${boostInfo.icon}</span>
                            <div class="boost-item-info">
                                <div class="boost-item-name">${boostInfo.name}</div>
                                <div class="boost-item-status">Active ? ${boost.status}</div>
                            </div>
                            <button class="boost-item-btn mint" onclick="mintBoostAsNFT('${boost.id}')" ${!walletAddress ? 'disabled title="Connect wallet first"' : ''}>
                                Mint NFT
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading database boosts:', error);
                container.innerHTML = '<span style="color: #ef4444; font-size: 0.9rem;">Error loading boosts</span>';
            }
        }

        // Load NFT boosts (from wallet)
        async function loadNFTBoosts() {
            const container = document.getElementById('nftBoostsContent');
            if (!container) return;

            if (!walletAddress || !SUITE_BOOSTS_ADDRESS) {
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">' +
                    (!walletAddress ? 'Connect wallet to view NFT boosts' : 'NFT contract not deployed yet') + '</span>';
                return;
            }

            try {
                const boostsContract = new ethers.Contract(SUITE_BOOSTS_ADDRESS, SUITE_BOOSTS_ABI, provider);
                const balances = await boostsContract.getAllBoostBalances(walletAddress);

                let html = '';
                for (let i = 0; i < 5; i++) {
                    const count = Number(balances[i]);
                    if (count > 0) {
                        const boostType = BOOST_TYPES[i + 1];
                        html += `
                            <div class="boost-item">
                                <span class="boost-item-icon">${boostType.icon}</span>
                                <div class="boost-item-info">
                                    <div class="boost-item-name">${boostType.name}</div>
                                    <div class="boost-item-status">NFT ? ${count}x owned</div>
                                </div>
                                <button class="boost-item-btn redeem" onclick="redeemNFTBoost(${i + 1})">
                                    Redeem
                                </button>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html || '<span style="color: var(--text-tertiary); font-size: 0.9rem;">No NFT boosts. Mint from account boosts above.</span>';

            } catch (error) {
                console.error('Error loading NFT boosts:', error);
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">NFT contract not deployed yet</span>';
            }
        }

        // Mint a database boost as NFT
        async function mintBoostAsNFT(boostId) {
            if (!walletAddress) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Minting...';

                // Call backend to mint (backend handles state machine + on-chain minting)
                const response = await fetch('/api/boost-mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        boost_id: boostId,
                        wallet_address: walletAddress
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('? Boost minted as NFT! Check your wallet.');
                    await loadDatabaseBoosts();
                    await loadNFTBoosts();
                } else {
                    throw new Error(result.error || 'Minting failed');
                }

            } catch (error) {
                console.error('Mint error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Redeem an NFT boost back to database
        async function redeemNFTBoost(boostType) {
            if (!walletAddress || !signer) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const boostsContract = new ethers.Contract(SUITE_BOOSTS_ADDRESS, SUITE_BOOSTS_ABI, signer);

                // User burns the NFT
                const tx = await boostsContract.redeem(boostType, 1);
                alert('Transaction submitted. Please wait...');
                await tx.wait();

                // Tell backend to credit the database boost
                const savedUser = localStorage.getItem('suiteUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    await fetch('/api/boost-redeem', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            discord_id: user.id,
                            boost_type: boostType,
                            tx_hash: tx.hash
                        })
                    });
                }

                alert('? Boost redeemed to your account!');
                await loadDatabaseBoosts();
                await loadNFTBoosts();

            } catch (error) {
                console.error('Redeem error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Load boosts when wallet connects or page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadDatabaseBoosts();
            loadNFTBoosts();
        });

        // Refresh boosts when wallet connects
        const originalUpdateUI = typeof updateUI === 'function' ? updateUI : null;
        if (originalUpdateUI) {
            window.updateUI = async function () {
                await originalUpdateUI.apply(this, arguments);
                await loadDatabaseBoosts();
                await loadNFTBoosts();
            };
        }

        // ========== DISCORD BRIDGE FUNCTIONS ==========

        const BRIDGE_ADDRESS = '0x0000000000000000000000000000000000000000'; // TODO: Deploy and update
        const DISCORD_CLIENT_ID = '1457474266390986865';
        const BRIDGE_REDIRECT_URI = window.location.origin + '/wallet.html';

        const BRIDGE_ABI = [
            "function deposit(string calldata discordId, uint256 amount) external",
            "function bridgeBalance() view returns (uint256)"
        ];

        // ERC20_ABI already declared above - reuse it for bridge

        // Check Discord connection for bridge on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkBridgeDiscordConnection();
            loadBridgeBalances();
        });

        function checkBridgeDiscordConnection() {
            const savedUser = localStorage.getItem('suiteUser');
            const statusEl = document.getElementById('bridgeDiscordStatus');
            const connectBtn = document.getElementById('bridgeConnectDiscord');
            const userEl = document.getElementById('bridgeDiscordUser');

            if (savedUser) {
                const user = JSON.parse(savedUser);
                if (statusEl) statusEl.style.display = 'block';
                if (userEl) userEl.textContent = `? Connected as ${user.username}`;
                if (connectBtn) connectBtn.style.display = 'none';
            } else {
                if (statusEl) statusEl.style.display = 'none';
                if (connectBtn) connectBtn.style.display = 'flex';
            }
        }

        function connectDiscordForBridge() {
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(BRIDGE_REDIRECT_URI)}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        async function loadBridgeBalances() {
            // Load wallet SUITE balance (will be updated when wallet connects)
            const walletBalanceEl = document.getElementById('bridgeWalletBalance');
            const discordBalanceEl = document.getElementById('bridgeDiscordBalance');

            // Wallet balance (from existing availableBalance element)
            const availableBal = document.getElementById('availableBalance');
            if (availableBal && walletBalanceEl) {
                walletBalanceEl.textContent = availableBal.textContent || '0';
            }

            // Discord balance from Supabase
            const savedUser = localStorage.getItem('suiteUser');
            if (savedUser && discordBalanceEl) {
                const user = JSON.parse(savedUser);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/user_balances?discord_id=eq.${user.id}&select=balance`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    const data = await response.json();
                    if (data && data[0]) {
                        discordBalanceEl.textContent = Number(data[0].balance).toLocaleString();
                    }
                } catch (error) {
                    console.error('Error loading Discord balance:', error);
                }
            }
        }

        async function depositToDiscord() {
            const amountInput = document.getElementById('bridgeAmount');
            const amount = amountInput?.value;

            if (!amount || amount <= 0) {
                alert('Please enter an amount');
                return;
            }

            // Check Discord connection
            const savedUser = localStorage.getItem('suiteUser');
            if (!savedUser) {
                alert('Please connect Discord first');
                return;
            }
            const user = JSON.parse(savedUser);

            // Check wallet connection
            if (!window.ethereum) {
                alert('Please install MetaMask');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    alert('Please connect your wallet first');
                    return;
                }

                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const amountWei = ethers.parseEther(amount.toString());

                // Get SUITE token address from treasury
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);

                // Check allowance
                const allowance = await suiteToken.allowance(accounts[0], BRIDGE_ADDRESS);
                if (allowance < amountWei) {
                    showNotification('?', 'Approving', 'Please approve SUITE spending...');
                    const approveTx = await suiteToken.approve(BRIDGE_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                // Deposit to bridge
                showNotification('?', 'Depositing', 'Please confirm the deposit...');
                const bridgeContract = new ethers.Contract(BRIDGE_ADDRESS, BRIDGE_ABI, signer);
                const depositTx = await bridgeContract.deposit(user.id, amountWei);
                await depositTx.wait();

                showNotification('?', 'Success!', `Deposited ${amount} SUITE to Discord. It will appear in your balance shortly.`);
                amountInput.value = '';

                // Reload balances after a short delay
                setTimeout(loadBridgeBalances, 5000);

            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled');
                } else {
                    showNotification('?', 'Error', error.message || 'Deposit failed');
                }
            }
        }

        // Handle OAuth callback for bridge
        (function handleBridgeOAuth() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');

            if (accessToken) {
                fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                })
                    .then(res => res.json())
                    .then(user => {
                        const userData = {
                            id: user.id,
                            username: user.username,
                            avatar: user.avatar
                                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                                : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator || '0') % 5}.png`
                        };
                        localStorage.setItem('suiteUser', JSON.stringify(userData));
                        window.history.replaceState(null, '', window.location.pathname);
                        checkBridgeDiscordConnection();
                        loadBridgeBalances();
                    });
            }
        })();

        // Tab Switching Logic
        window.switchTab = function (tabId) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });

            // Show target content
            const target = document.getElementById('tab-' + tabId);
            if (target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
            }

            // Update tabs
            document.querySelectorAll('.wallet-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick')?.includes(`'${tabId}'`)) {
                    tab.classList.add('active');
                }
            });
        };

        window.openLockModal = function () {
            alert("? Staking for Reputation is coming soon!");
        };
    </script>

    <script>
        // ========== USER CREDITS SYSTEM ==========
        async function loadUserCredits() {
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_credits?discord_id=eq.${currentUser.id}&select=*`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY } }
                );
                const data = await response.json();

                if (data && data.length > 0) {
                    const credits = parseFloat(data[0].credits) || 0;
                    const creditsEl = document.getElementById('userCredits');
                    if (creditsEl && credits > 0) {
                        creditsEl.innerHTML = `${credits.toFixed(0)} <button onclick="claimCredits(${credits})" style="background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; padding: 4px 12px; border-radius: 100px; font-size: 0.7rem; font-weight: 700; cursor: pointer; margin-left: 8px;">Claim</button>`;
                    } else if (creditsEl) {
                        creditsEl.textContent = '0';
                    }
                }
            } catch (err) {
                console.error('Error loading credits:', err);
            }
        }

        async function claimCredits(amount) {
            if (!amount || amount <= 0) { alert('No credits to claim!'); return; }
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (!currentUser) { alert('Please log in via Discord first.'); return; }
            if (!userAddress) { alert('Please connect your wallet first.'); return; }

            if (!confirm(`Claim ${amount} credits?\n\nWill send ${amount} SUITE to ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`)) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/claim_credits`, {
                    method: 'POST',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_discord_id: currentUser.id, p_amount: amount })
                });
                const success = await response.json();
                if (!success) { alert('Failed - insufficient balance.'); return; }

                alert(`Claimed ${amount} credits! SUITE transfer pending Treasury integration.`);
                loadUserCredits();
            } catch (err) {
                alert('Error claiming credits.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadUserCredits);
        window.loadUserCredits = loadUserCredits;

        // ========== DISCORD LOGIN ==========
        function loginWithDiscord() {
            // Discord OAuth2 URL - using the same flow as developer portal
            const DISCORD_CLIENT_ID = '1457474266390986865'; // Your Discord App Client ID
            const REDIRECT_URI = encodeURIComponent(window.location.origin + '/oauth-callback.html');
            const SCOPE = encodeURIComponent('identify email');

            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=${SCOPE}`;

            // Open Discord auth in a popup
            const popup = window.open(authUrl, 'Discord Login', 'width=500,height=700');

            // Listen for the callback
            window.addEventListener('message', function handleAuthMessage(event) {
                if (event.origin !== window.location.origin) return;
                if (event.data && event.data.type === 'discord-auth-success') {
                    const user = event.data.user;
                    localStorage.setItem('suiteDev', JSON.stringify(user));
                    updateAuthUI(user);
                    popup.close();
                    window.removeEventListener('message', handleAuthMessage);
                }
            });
        }

        function updateAuthUI(user) {
            const discordBtn = document.getElementById('discordLoginBtn');
            if (discordBtn && user) {
                discordBtn.innerHTML = `<img src="${user.avatar ? 'https://cdn.discordapp.com/avatars/' + user.id + '/' + user.avatar + '.png' : 'https://cdn.discordapp.com/embed/avatars/0.png'}" style="width: 24px; height: 24px; border-radius: 50%;"> ${user.username}`;
                discordBtn.onclick = () => {
                    if (confirm('Log out of Discord?')) {
                        localStorage.removeItem('suiteDev');
                        location.reload();
                    }
                };
            }
        }

        // Check if already logged in on page load
        document.addEventListener('DOMContentLoaded', async function () {
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (currentUser) {
                updateAuthUI(currentUser);
                // Check for pending wallet link (after Discord OAuth redirect)
                await checkPendingWalletLink();
            }
        });

        // ========== WALLET CONNECTION ==========

        // Link wallet address to Discord account in Supabase
        async function linkWalletToDiscord(walletAddress, discordId) {
            try {
                // Upsert to user_credits - links wallet to Discord
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/user_credits`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        discord_id: discordId,
                        wallet_address: walletAddress.toLowerCase(),
                        updated_at: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    console.log(`Linked wallet ${walletAddress.slice(0,8)}... to Discord ${discordId}`);
                    showNotification('ðŸ”—', 'Wallet Linked', 'Your wallet is now linked to your Discord account');
                }
            } catch (error) {
                console.error('Failed to link wallet to Discord:', error);
            }
        }

        // Show prompt to link Discord after deposit (if not logged in)
        function showDiscordLinkPrompt(walletAddress) {
            const existing = document.getElementById('discordLinkPrompt');
            if (existing) existing.remove();

            const prompt = document.createElement('div');
            prompt.id = 'discordLinkPrompt';
            prompt.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: linear-gradient(135deg, #1a1225 0%, #2d1b4e 100%);
                            padding: 32px; border-radius: 20px; z-index: 10000; max-width: 400px;
                            border: 1px solid rgba(139, 92, 246, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <h3 style="color: white; margin: 0 0 12px 0; font-size: 1.3rem;">ðŸŽ‰ Deposit Successful!</h3>
                    <p style="color: rgba(255,255,255,0.7); margin: 0 0 20px 0; line-height: 1.5;">
                        Link your Discord to use credits in SUITE apps like FoodVitals, OpticRep, and more.
                    </p>
                    <button onclick="loginWithDiscordForLink('${walletAddress}')"
                            style="width: 100%; padding: 14px; background: #5865F2; color: white;
                                   border: none; border-radius: 12px; font-weight: 600; font-size: 1rem;
                                   cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 71 55" fill="white">
                            <path d="M60.1 4.9A58.5 58.5 0 0045.4.2a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.4 37.4 0 0025.4.3a.2.2 0 00-.2-.1 58.4 58.4 0 00-14.7 4.6.2.2 0 00-.1 0A60 60 0 00.4 43.8a.2.2 0 000 .2 58.7 58.7 0 0017.7 9 .2.2 0 00.2-.1 42 42 0 003.6-5.9.2.2 0 00-.1-.3 38.7 38.7 0 01-5.5-2.6.2.2 0 010-.4l1.1-.9a.2.2 0 01.2 0 41.8 41.8 0 0035.6 0 .2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.4 36.4 0 01-5.5 2.6.2.2 0 00-.1.3 47.2 47.2 0 003.6 5.9.2.2 0 00.3.1 58.5 58.5 0 0017.7-9 .2.2 0 000-.2c1.2-12.7-2-23.7-8.4-33.5a.2.2 0 00-.1 0zM23.7 35.9c-2.9 0-5.3-2.7-5.3-6s2.3-6 5.3-6 5.4 2.7 5.3 6-2.3 6-5.3 6zm19.6 0c-2.9 0-5.3-2.7-5.3-6s2.3-6 5.3-6 5.4 2.7 5.3 6-2.3 6-5.3 6z"/>
                        </svg>
                        Connect Discord
                    </button>
                    <button onclick="document.getElementById('discordLinkPrompt').remove()"
                            style="width: 100%; padding: 12px; background: transparent; color: rgba(255,255,255,0.5);
                                   border: none; margin-top: 12px; cursor: pointer; font-size: 0.9rem;">
                        Skip for now
                    </button>
                </div>
                <div onclick="document.getElementById('discordLinkPrompt').remove()"
                     style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                            background: rgba(0,0,0,0.7); z-index: 9999;"></div>
            `;
            document.body.appendChild(prompt);
        }

        // Login with Discord specifically for linking wallet
        function loginWithDiscordForLink(walletAddress) {
            // Store wallet address to link after OAuth
            localStorage.setItem('pendingWalletLink', walletAddress);
            // Trigger Discord OAuth
            const DISCORD_CLIENT_ID = '1457474266390986865';
            const REDIRECT_URI = window.location.origin + '/wallet.html';
            const SCOPE = 'identify';
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${SCOPE}`;
            window.location.href = authUrl;
        }

        // Check for pending wallet link after Discord OAuth
        async function checkPendingWalletLink() {
            const pendingWallet = localStorage.getItem('pendingWalletLink');
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');

            if (pendingWallet && currentUser?.id) {
                await linkWalletToDiscord(pendingWallet, currentUser.id);
                localStorage.removeItem('pendingWalletLink');
            }
        }

        async function connectWallet() {
            const walletBtn = document.querySelector('.nav-wallet');

            // Check if already connected - disconnect if so
            if (walletBtn && walletBtn.classList.contains('connected')) {
                walletBtn.classList.remove('connected');
                walletBtn.innerHTML = 'ðŸ”— Connect Wallet';
                localStorage.removeItem('suiteWallet');
                localStorage.removeItem('suiteWalletAddress');
                window.walletAddress = null;

                // Hide admin dashboard
                const adminDashboard = document.getElementById('adminDashboard');
                if (adminDashboard) {
                    adminDashboard.style.display = 'none';
                }
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect.');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];

                // Store connected wallet (both keys for compatibility)
                localStorage.setItem('suiteWallet', address);
                localStorage.setItem('suiteWalletAddress', address); // For nav-component.js

                // Update nav wallet button (shared nav)
                const navWalletBtn = document.querySelector('.nav-wallet');
                if (navWalletBtn) {
                    navWalletBtn.classList.add('connected');
                    navWalletBtn.innerHTML = `âœ… ${address.slice(0, 6)}...${address.slice(-4)}`;
                }

                // Update old style wallet button if exists
                const walletBtn = document.getElementById('connectWalletBtn');
                if (walletBtn) {
                    walletBtn.innerHTML = `âœ… ${address.slice(0, 6)}...${address.slice(-4)}`;
                    walletBtn.onclick = disconnectWallet;
                }

                // Update global wallet address if it exists
                if (typeof userAddress !== 'undefined') {
                    window.userAddress = address;
                }

                // Check for admin dashboard visibility
                window.walletAddress = address;
                if (typeof updateAdminDashboardVisibility === 'function') {
                    updateAdminDashboardVisibility();
                }

                // Load yield allocation from Supabase
                loadYieldAllocation(address).then(savedKeep => {
                    if (savedKeep !== null) {
                        const slider = document.getElementById('yieldSplitSlider');
                        if (slider) {
                            slider.value = savedKeep;
                            updateYieldSplit(savedKeep);
                        }
                    }
                });

                // Load user's vault position (deposits, withdrawals)
                loadUserVaultPosition(address);

                // Fetch USDC balance for deposit UI
                fetchUSDCBalance();

                // Auto-link wallet to Discord if logged in
                const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                if (currentUser?.id) {
                    await linkWalletToDiscord(address, currentUser.id);
                }

                console.log('Connected wallet:', address);
            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        function disconnectWallet() {
            // Clear all wallet keys (matching nav-component.js)
            localStorage.removeItem('connectedWallet');
            localStorage.removeItem('walletAddress');
            localStorage.removeItem('suiteWalletAddress');
            localStorage.removeItem('suiteWallet');
            window.walletAddress = null;

            // Hide admin dashboard
            const adminDashboard = document.getElementById('adminDashboard');
            if (adminDashboard) {
                adminDashboard.style.display = 'none';
            }

            // Update page-specific wallet UI
            const walletBtn = document.getElementById('connectWalletBtn');
            if (walletBtn) {
                walletBtn.innerHTML = 'ðŸ”— Connect Wallet';
                walletBtn.onclick = connectWallet;
            }

            // Refresh nav display
            if (window.refreshNavCredits) {
                window.refreshNavCredits();
            }

            // Reload to reset wallet page state
            window.location.reload();
        }

        // Toggle tooltip visibility and position near the clicked button
        function toggleTooltip(tooltipId, event) {
            event.stopPropagation();
            const tooltip = document.getElementById(tooltipId);
            const button = event.target.closest('button');

            if (tooltip && button) {
                const isVisible = tooltip.style.display === 'block';

                // Hide all tooltips first
                document.querySelectorAll('#howItWorksTooltip, #arbTooltip').forEach(t => {
                    t.style.display = 'none';
                });

                if (!isVisible) {
                    // Position tooltip near the button
                    const rect = button.getBoundingClientRect();
                    tooltip.style.left = (rect.left + window.scrollX - 10) + 'px';
                    tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                    tooltip.style.display = 'block';
                }
            }
        }

        // Close tooltips when clicking outside
        document.addEventListener('click', function (e) {
            const tooltips = document.querySelectorAll('#howItWorksTooltip, #arbTooltip');
            const isInfoButton = e.target.closest('button[onclick*="toggleTooltip"]');

            if (!isInfoButton) {
                tooltips.forEach(tooltip => {
                    if (!tooltip.contains(e.target)) {
                        tooltip.style.display = 'none';
                    }
                });
            }
        });

        // Restore wallet connection on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedWallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWallet');
            if (savedWallet) {
                const walletBtn = document.getElementById('connectWalletBtn');
                if (walletBtn) {
                    walletBtn.innerHTML = `âœ… ${savedWallet.slice(0, 6)}...${savedWallet.slice(-4)}`;
                    walletBtn.onclick = disconnectWallet;
                }

                // Check for admin dashboard visibility
                window.walletAddress = savedWallet;
                if (typeof updateAdminDashboardVisibility === 'function') {
                    updateAdminDashboardVisibility();
                }

                // Load yield allocation from Supabase for saved wallet
                if (typeof loadYieldAllocation === 'function') {
                    loadYieldAllocation(savedWallet).then(savedKeep => {
                        if (savedKeep !== null) {
                            const slider = document.getElementById('yieldSplitSlider');
                            if (slider) {
                                slider.value = savedKeep;
                                updateYieldSplit(savedKeep);
                            }
                        }
                    });
                }

                // Fetch USDC balance for deposit UI
                if (typeof fetchUSDCBalance === 'function') {
                    setTimeout(fetchUSDCBalance, 500); // Delay to ensure ethers is loaded
                }
            }
        });

        // Listen for nav component auth changes (wallet connect/disconnect)
        window.addEventListener('navAuthChanged', function(e) {
            console.log('[wallet.html] navAuthChanged event received', e.detail);
            handleWalletChange();
        });

        // Also listen for storage changes (catches cross-tab updates)
        window.addEventListener('storage', function(e) {
            if (e.key === 'connectedWallet' || e.key === 'suiteWallet') {
                console.log('[wallet.html] Storage change detected', e.key, e.newValue);
                handleWalletChange();
            }
        });

        // Poll for wallet connection on page load (catches race conditions)
        let walletCheckCount = 0;
        const walletCheckInterval = setInterval(function() {
            walletCheckCount++;
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWallet');
            if (wallet && !window.walletAddress) {
                console.log('[wallet.html] Wallet found via polling:', wallet);
                handleWalletChange();
            }
            if (walletCheckCount >= 10 || window.walletAddress) {
                clearInterval(walletCheckInterval);
            }
        }, 500);

        function handleWalletChange() {
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWallet');
            if (wallet) {
                window.walletAddress = wallet;
                fetchUSDCBalance();
                if (typeof updateAdminDashboardVisibility === 'function') {
                    updateAdminDashboardVisibility();
                }
                if (typeof loadYieldAllocation === 'function') {
                    loadYieldAllocation(wallet);
                }
                if (typeof loadUserVaultData === 'function') {
                    loadUserVaultData();
                }
            } else {
                window.walletAddress = null;
                const balanceEl = document.getElementById('walletUSDCBalance');
                if (balanceEl) balanceEl.textContent = 'Connect Wallet';
            }
        }

        // Yield Allocation Slider Logic
        function updateYieldSplit(keepPercent) {
            keepPercent = parseInt(keepPercent);
            // Enforce max 90% (minimum 10% to apps)
            if (keepPercent > 90) keepPercent = 90;
            if (keepPercent < 10) keepPercent = 10;
            const fundPercent = 100 - keepPercent;

            // Update display values
            const keepDisplay = document.getElementById('keepPercentDisplay');
            const fundDisplay = document.getElementById('fundPercentDisplay');
            if (keepDisplay) keepDisplay.textContent = keepPercent + '%';
            if (fundDisplay) fundDisplay.textContent = fundPercent + '%';

            // Update My Funded Apps yield badge
            const fundedAppsBadge = document.getElementById('fundedAppsYieldBadge');
            if (fundedAppsBadge) fundedAppsBadge.textContent = fundPercent + '% yield';

            // Also update header stats
            const yieldToUsers = document.getElementById('yieldToUsers');
            const yieldToApps = document.getElementById('yieldToApps');
            if (yieldToUsers) yieldToUsers.textContent = keepPercent + '%';
            if (yieldToApps) yieldToApps.textContent = fundPercent + '%';

            // Save to localStorage
            localStorage.setItem('yieldKeepPercent', keepPercent);

            // Save to Supabase if wallet connected
            if (window.walletAddress) {
                saveYieldAllocation(window.walletAddress, keepPercent);
            }
        }

        // ========== DEPOSIT ESTIMATES & USDC BALANCE ==========
        let userUSDCBalance = 0;
        let depositPanelExpanded = false;
        const USDC_CONTRACT = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
        const VAULT_APY = 0.42; // 42% combined APY
        const YIELD_SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const YIELD_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        // Toggle vault panel expand/collapse
        let vaultPanelExpanded = false;
        function toggleVaultPanel(event) {
            if (event) event.stopPropagation();

            vaultPanelExpanded = !vaultPanelExpanded;
            const content = document.getElementById('vaultExpandedContent');
            const chevron = document.getElementById('vaultChevron');
            const card = document.getElementById('aiFleetVaultCard');
            const btn = document.getElementById('vaultExpandBtn');

            if (vaultPanelExpanded) {
                content.style.display = 'block';
                if (chevron) chevron.style.transform = 'rotate(180deg)';
                card.style.cursor = 'default';
                if (btn) btn.querySelector('span').textContent = 'Close Vault';
            } else {
                content.style.display = 'none';
                if (chevron) chevron.style.transform = 'rotate(0deg)';
                card.style.cursor = 'pointer';
                if (btn) btn.querySelector('span').textContent = 'Open Vault';
            }
        }

        // Toggle deposit panel expand/collapse
        function toggleDepositPanel(event) {
            if (event) event.stopPropagation();

            depositPanelExpanded = !depositPanelExpanded;
            const content = document.getElementById('depositExpandedContent');
            const chevron = document.getElementById('depositChevron');
            const bar = document.getElementById('depositBar');

            if (depositPanelExpanded) {
                content.style.display = 'block';
                chevron.style.transform = 'rotate(180deg)';
                bar.style.cursor = 'default';
            } else {
                content.style.display = 'none';
                chevron.style.transform = 'rotate(0deg)';
                bar.style.cursor = 'pointer';
            }
        }

        // Update deposit from percentage slider
        function updateDepositFromSlider(percent) {
            percent = parseInt(percent) || 0;
            const amount = userUSDCBalance * (percent / 100);

            // Update input field
            const input = document.getElementById('depositAmountInput');
            if (input) input.value = amount.toFixed(2);

            // Update percent display
            const percentDisplay = document.getElementById('depositPercentDisplay');
            if (percentDisplay) percentDisplay.textContent = percent + '%';

            updateDepositEstimates();
        }

        // Update deposit from manual input
        function updateDepositFromInput() {
            const input = document.getElementById('depositAmountInput');
            const amount = parseFloat(input?.value) || 0;

            // Calculate and update percentage slider
            if (userUSDCBalance > 0) {
                const percent = Math.min((amount / userUSDCBalance) * 100, 100);
                const slider = document.getElementById('depositPercentSlider');
                const percentDisplay = document.getElementById('depositPercentDisplay');
                if (slider) slider.value = percent;
                if (percentDisplay) percentDisplay.textContent = Math.round(percent) + '%';
            }

            updateDepositEstimates();
        }

        // Update deposit estimates based on input amount and yield split
        function updateDepositEstimates() {
            const amountInput = document.getElementById('depositAmountInput');
            const amount = parseFloat(amountInput?.value) || 0;

            // Get yield split percentages
            const keepPercent = parseInt(document.getElementById('yieldSplitSlider')?.value) || 90;
            const fundPercent = 100 - keepPercent;

            // Calculate yearly estimates
            const totalYield = amount * VAULT_APY;
            const yieldToYou = totalYield * (keepPercent / 100);
            const yieldToApps = totalYield * (fundPercent / 100);

            // Update display
            const estTotal = document.getElementById('estTotalYield');
            const estYou = document.getElementById('estYieldToYou');
            const estApps = document.getElementById('estYieldToApps');

            if (estTotal) estTotal.textContent = '$' + totalYield.toFixed(2);
            if (estYou) estYou.textContent = '$' + yieldToYou.toFixed(2);
            if (estApps) estApps.textContent = '$' + yieldToApps.toFixed(2);
        }

        // Set max deposit amount from wallet balance
        function setMaxDeposit() {
            if (!window.walletAddress) {
                showNotification('âš ï¸', 'Connect Wallet', 'Please connect your wallet first');
                return;
            }
            if (userUSDCBalance <= 0) {
                showNotification('âš ï¸', 'No Balance', 'You have no USDC in your wallet');
                return;
            }

            const input = document.getElementById('depositAmountInput');
            const slider = document.getElementById('depositPercentSlider');
            const percentDisplay = document.getElementById('depositPercentDisplay');

            if (input) input.value = userUSDCBalance.toFixed(2);
            if (slider) slider.value = 100;
            if (percentDisplay) percentDisplay.textContent = '100%';

            updateDepositEstimates();
        }

        // Fetch and display user's USDC balance
        async function fetchUSDCBalance() {
            const balanceEl = document.getElementById('walletUSDCBalance');
            if (!window.walletAddress) {
                if (balanceEl) balanceEl.textContent = 'Connect Wallet';
                userUSDCBalance = 0;
                return;
            }

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const usdcContract = new ethers.Contract(USDC_CONTRACT, [
                    'function balanceOf(address) view returns (uint256)'
                ], provider);

                const balance = await usdcContract.balanceOf(window.walletAddress);
                userUSDCBalance = parseFloat(ethers.formatUnits(balance, 6));

                if (balanceEl) {
                    balanceEl.textContent = '$' + userUSDCBalance.toFixed(2);
                }

                // Update slider max if balance is higher than 1000
                const slider = document.getElementById('depositAmountSlider');
                if (slider && userUSDCBalance > 1000) {
                    slider.max = Math.ceil(userUSDCBalance);
                }
            } catch (err) {
                console.error('Error fetching USDC balance:', err);
                if (balanceEl) balanceEl.textContent = '$0.00';
                userUSDCBalance = 0;
            }
        }

        // Execute vault deposit (OLD - replaced by new contract version below)
        // This function is kept for reference but the new one at line ~7500 takes precedence
        async function executeVaultDepositOLD() {
            const amount = parseFloat(document.getElementById('depositAmountInput')?.value) || 0;

            if (!window.walletAddress) {
                showNotification('âš ï¸', 'Connect Wallet', 'Please connect your wallet first');
                return;
            }

            if (amount <= 0) {
                showNotification('âš ï¸', 'Invalid Amount', 'Please enter an amount to deposit');
                return;
            }

            if (amount > userUSDCBalance) {
                showNotification('âš ï¸', 'Insufficient Balance', `You only have $${userUSDCBalance.toFixed(2)} USDC`);
                return;
            }

            try {
                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();

                // USDC contract
                const usdcContract = new ethers.Contract(USDC_CONTRACT, [
                    'function approve(address spender, uint256 amount) returns (bool)',
                    'function transfer(address to, uint256 amount) returns (bool)'
                ], signer);

                const amountWei = ethers.parseUnits(amount.toString(), 6);
                const treasuryAddress = '0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1';

                showNotification('â³', 'Processing', 'Sending USDC to vault...');

                // Transfer USDC to treasury
                const tx = await usdcContract.transfer(treasuryAddress, amountWei);
                await tx.wait();

                // Record deposit in database
                const keepPercent = parseInt(document.getElementById('yieldSplitSlider')?.value) || 90;
                await recordVaultDeposit(window.walletAddress, amount, keepPercent);

                showNotification('âœ…', 'Success!', `Deposited $${amount} USDC and received ${(amount * 1000).toLocaleString()} credits!`);

                // Clear input and refresh balances
                document.getElementById('depositAmountInput').value = '';
                updateDepositEstimates();
                fetchUSDCBalance();
                loadUserVaultData();

            } catch (err) {
                console.error('Deposit error:', err);
                showNotification('âŒ', 'Error', err.message || 'Failed to deposit');
            }
        }

        // Record deposit in Supabase
        async function recordVaultDeposit(wallet, amount, keepPercent) {
            try {
                await fetch(`${YIELD_SUPABASE_URL}/rest/v1/treasury_deposits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': YIELD_SUPABASE_KEY,
                        'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`,
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({
                        wallet_address: wallet.toLowerCase(),
                        amount_usdc: amount,
                        usd_value_at_deposit: amount,
                        lp_tokens_issued: amount, // 1:1 for now
                        yield_keep_percent: keepPercent
                    })
                });

                // Also grant credits
                const credits = amount * 1000; // $1 = 1000 credits
                await fetch(`${YIELD_SUPABASE_URL}/rest/v1/rpc/add_credits`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': YIELD_SUPABASE_KEY,
                        'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`
                    },
                    body: JSON.stringify({
                        p_wallet: wallet.toLowerCase(),
                        p_amount: credits
                    })
                });
            } catch (err) {
                console.error('Error recording deposit:', err);
            }
        }

        // Fetch USDC balance when wallet connects
        document.addEventListener('walletConnected', fetchUSDCBalance);

        // ========== YIELD ALLOCATION DATABASE FUNCTIONS ==========
        // (Using YIELD_SUPABASE_URL and YIELD_SUPABASE_KEY defined above)

        // Save yield allocation to Supabase
        async function saveYieldAllocation(walletAddress, keepPercent) {
            if (!walletAddress) return;

            try {
                // Use upsert to insert or update
                const response = await fetch(`${YIELD_SUPABASE_URL}/rest/v1/treasury_yield_preferences`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': YIELD_SUPABASE_KEY,
                        'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        wallet_address: walletAddress.toLowerCase(),
                        keep_percent: parseInt(keepPercent),
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    console.error('Failed to save yield allocation:', await response.text());
                } else {
                    console.log('Yield allocation saved:', keepPercent + '% keep');
                }
            } catch (error) {
                console.error('Error saving yield allocation:', error);
            }
        }

        // Load yield allocation from Supabase
        async function loadYieldAllocation(walletAddress) {
            if (!walletAddress) return null;

            try {
                const response = await fetch(
                    `${YIELD_SUPABASE_URL}/rest/v1/treasury_yield_preferences?wallet_address=eq.${walletAddress.toLowerCase()}&select=keep_percent`,
                    {
                        headers: {
                            'apikey': YIELD_SUPABASE_KEY,
                            'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const keepPercent = Math.min(data[0].keep_percent, 90); // Enforce max 90%
                        console.log('Loaded yield allocation from DB:', keepPercent + '% keep');
                        return keepPercent;
                    }
                }
            } catch (error) {
                console.error('Error loading yield allocation:', error);
            }

            return null; // No saved allocation found
        }

        // Initialize yield slider on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedKeepPercent = Math.min(localStorage.getItem('yieldKeepPercent') || 90, 90);
            const slider = document.getElementById('yieldSplitSlider');
            if (slider) {
                slider.value = savedKeepPercent;
                updateYieldSplit(savedKeepPercent);
            }
        });

        // ========== VAULT DETAILS PANEL ==========
        function toggleVaultDetails() {
            const panel = document.getElementById('vaultDetailsPanel');
            const btn = document.getElementById('vaultDetailsBtn');
            if (!panel) return;

            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            if (btn) {
                btn.textContent = isHidden ? 'Details â–²' : 'Details â–¼';
            }

            // Load balances when panel opens
            if (isHidden) {
                loadDetailsBalances();
            }
        }

        // ========== CREDITS INFO PANEL ==========
        function toggleCreditsInfo() {
            const content = document.getElementById('creditsInfoContent');
            const toggle = document.getElementById('creditsInfoToggle');
            if (!content) return;

            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            if (toggle) {
                toggle.textContent = isHidden ? 'â–²' : 'â–¼';
                toggle.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        // ========== YOUR PROFILE SECTION ==========
        function toggleProfileSection() {
            const content = document.getElementById('profileContent');
            const toggle = document.getElementById('profileToggle');
            if (!content) return;

            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            if (toggle) {
                toggle.textContent = isHidden ? 'â–²' : 'â–¼';
                toggle.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }

            // Load profile data when expanded
            if (isHidden) {
                loadProfileData();
            }
        }

        async function loadProfileData() {
            const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

            // Update wallet display
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            const walletEl = document.getElementById('profileWalletAddress');
            const walletStatusEl = document.getElementById('profileWalletStatus');

            if (wallet && walletEl) {
                walletEl.textContent = wallet.slice(0, 6) + '...' + wallet.slice(-4);
                if (walletStatusEl) {
                    walletStatusEl.textContent = 'Connected';
                    walletStatusEl.style.background = 'rgba(34, 197, 94, 0.2)';
                    walletStatusEl.style.color = '#22c55e';
                }
            }

            // Update Telegram display
            const tgUser = JSON.parse(localStorage.getItem('telegram_user') || 'null');
            const tgEl = document.getElementById('profileTelegramUsername');
            const tgBtn = document.getElementById('profileTelegramBtn');

            if (tgUser && tgEl) {
                tgEl.textContent = '@' + (tgUser.username || tgUser.first_name);
                if (tgBtn) {
                    tgBtn.textContent = 'Linked âœ“';
                    tgBtn.style.background = '#22c55e';
                    tgBtn.onclick = null;
                }
            }

            // Fetch Factory rep from database
            try {
                let query = '';
                if (tgUser && tgUser.id) {
                    query = `telegram_id=eq.${tgUser.id}`;
                } else if (wallet) {
                    query = `wallet_address=eq.${wallet.toLowerCase()}`;
                }

                if (query) {
                    const response = await fetch(
                        `${SUPABASE_URL}/rest/v1/factory_users?${query}&select=*`,
                        {
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                            }
                        }
                    );

                    if (response.ok) {
                        const users = await response.json();
                        if (users.length > 0) {
                            const user = users[0];
                            const repEl = document.getElementById('profileRepScore');
                            const proposalsEl = document.getElementById('profileProposals');
                            const founderEl = document.getElementById('profileFounderBadge');
                            const headerRepEl = document.getElementById('profileFactoryRep');

                            if (repEl) repEl.textContent = user.reputation || 0;
                            if (founderEl && user.is_founder) founderEl.style.display = 'block';
                            if (headerRepEl && user.reputation > 0) {
                                headerRepEl.textContent = 'â—ˆ ' + user.reputation + ' REP';
                                headerRepEl.style.display = 'inline-block';
                            }

                            // Count actual proposals from database
                            if (proposalsEl && user.id) {
                                const proposalResponse = await fetch(
                                    `${SUPABASE_URL}/rest/v1/factory_proposals?author_id=eq.${user.id}&select=id`,
                                    {
                                        headers: {
                                            'apikey': SUPABASE_ANON_KEY,
                                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                                        }
                                    }
                                );
                                if (proposalResponse.ok) {
                                    const proposals = await proposalResponse.json();
                                    proposalsEl.textContent = proposals.length;
                                }
                            }
                        }
                    }
                }
            } catch (err) {
                console.error('Error loading factory profile:', err);
            }
        }

        function linkTelegramFromProfile() {
            const origin = window.location.origin;
            const width = 550;
            const height = 470;
            const left = Math.max(0, (screen.width - width) / 2);
            const top = Math.max(0, (screen.height - height) / 2);

            const authUrl = `https://oauth.telegram.org/auth?bot_id=8341049569&origin=${encodeURIComponent(origin)}&request_access=write`;

            const popup = window.open(
                authUrl,
                'telegram_auth',
                `width=${width},height=${height},left=${left},top=${top},toolbar=no,menubar=no,scrollbars=yes,resizable=yes`
            );

            window.addEventListener('message', function handleTelegramAuth(event) {
                if (event.origin !== 'https://oauth.telegram.org') return;

                try {
                    const data = JSON.parse(event.data);
                    if (data.event === 'auth_result' && data.result) {
                        const user = data.result;
                        localStorage.setItem('telegram_user', JSON.stringify(user));

                        // Update UI
                        loadProfileData();

                        // Also link to factory user in database if wallet connected
                        linkWalletToTelegram(user);

                        window.removeEventListener('message', handleTelegramAuth);
                    }
                } catch (e) {
                    console.error('Telegram auth error:', e);
                }
            });

            if (!popup || popup.closed) {
                alert('Popup was blocked. Please allow popups for this site.');
            }
        }

        async function linkWalletToTelegram(tgUser) {
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            if (!wallet || !tgUser) return;

            const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

            try {
                // Check if user exists by telegram_id
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/factory_users?telegram_id=eq.${tgUser.id}&select=id`,
                    {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    }
                );

                const users = await response.json();

                if (users.length > 0) {
                    // Update existing user with wallet
                    await fetch(
                        `${SUPABASE_URL}/rest/v1/factory_users?id=eq.${users[0].id}`,
                        {
                            method: 'PATCH',
                            headers: {
                                'apikey': SUPABASE_ANON_KEY,
                                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ wallet_address: wallet.toLowerCase() })
                        }
                    );
                    console.log('Wallet linked to existing Telegram user');
                }
            } catch (err) {
                console.error('Error linking wallet to telegram:', err);
            }
        }

        // Load profile data on page load if already connected
        document.addEventListener('DOMContentLoaded', function() {
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            const tgUser = localStorage.getItem('telegram_user');
            if (wallet || tgUser) {
                // Pre-load rep badge in header
                loadProfileData();
            }
        });

        // ========== VAULT FLOW EXPLAINER ==========
        function toggleVaultFlow() {
            const content = document.getElementById('vaultFlowContent');
            const toggle = document.getElementById('vaultFlowToggle');
            if (!content) return;

            const isHidden = content.style.display === 'none';
            content.style.display = isHidden ? 'block' : 'none';
            if (toggle) {
                toggle.textContent = isHidden ? 'â–²' : 'â–¼';
                toggle.style.transform = isHidden ? 'rotate(180deg)' : 'rotate(0deg)';
            }
        }

        // ========== UPDATE CREDITS DISPLAY ==========
        function updateCreditsDisplay(credits) {
            const balanceEl = document.getElementById('userCreditsBalance');
            const usdValueEl = document.getElementById('creditsUsdValue');
            const earningRateEl = document.getElementById('creditEarningRate');

            if (balanceEl) {
                balanceEl.textContent = credits.toLocaleString();
            }
            if (usdValueEl) {
                // 1000 credits = $1
                const usdValue = credits / 1000;
                usdValueEl.textContent = '$' + usdValue.toFixed(2);
            }
            if (earningRateEl) {
                // Estimate monthly earning rate based on 10% APY
                // User deposit in USD = credits / 1000
                // Monthly yield = (deposit * 0.10) / 12
                // In credits = monthly yield * 1000
                const deposit = credits / 1000;
                const monthlyYield = (deposit * 0.10) / 12;
                const monthlyCredits = Math.round(monthlyYield * 1000);
                earningRateEl.textContent = monthlyCredits.toLocaleString();
            }
        }

        function switchVaultTab(tab) {
            const depositTab = document.getElementById('vaultDepositTab');
            const withdrawTab = document.getElementById('vaultWithdrawTab');
            const yieldTab = document.getElementById('vaultYieldTab');
            const depositBtn = document.getElementById('vaultTabDeposit');
            const withdrawBtn = document.getElementById('vaultTabWithdraw');
            const yieldBtn = document.getElementById('vaultTabYield');

            // Hide all tabs, reset all buttons
            depositTab.style.display = 'none';
            withdrawTab.style.display = 'none';
            if (yieldTab) yieldTab.style.display = 'none';

            depositBtn.style.background = 'rgba(0,0,0,0.05)';
            depositBtn.style.color = '#6b7280';
            withdrawBtn.style.background = 'rgba(0,0,0,0.05)';
            withdrawBtn.style.color = '#6b7280';
            if (yieldBtn) {
                yieldBtn.style.background = 'rgba(0,0,0,0.05)';
                yieldBtn.style.color = '#6b7280';
            }

            if (tab === 'deposit') {
                depositTab.style.display = 'block';
                depositBtn.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
                depositBtn.style.color = 'white';
            } else if (tab === 'withdraw') {
                withdrawTab.style.display = 'block';
                withdrawBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                withdrawBtn.style.color = 'white';
            } else if (tab === 'yield') {
                if (yieldTab) yieldTab.style.display = 'block';
                if (yieldBtn) {
                    yieldBtn.style.background = 'linear-gradient(135deg, #a855f7, #ec4899)';
                    yieldBtn.style.color = 'white';
                }
            }
        }

        // Track balances for details panel
        let detailsUsdcBalance = 0;
        let detailsAvailableWithdrawAmt = 0;

        async function loadDetailsBalances() {
            if (!window.ethereum) return;
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    const address = accounts[0];

                    // Fetch USDC balance
                    const balanceData = '0x70a08231' + address.slice(2).padStart(64, '0');
                    const balanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: VAULT_USDC_ADDRESS, data: balanceData }, 'latest']
                    });
                    detailsUsdcBalance = parseInt(balanceHex, 16) / 1e6;
                    const balanceEl = document.getElementById('detailsUsdcBalance');
                    if (balanceEl) balanceEl.textContent = 'Balance: $' + detailsUsdcBalance.toFixed(2);

                    // Fetch available withdraw
                    const withdrawable = await calculateUserWithdrawable(address);
                    detailsAvailableWithdrawAmt = withdrawable.available;
                    const availEl = document.getElementById('detailsAvailableWithdraw');
                    if (availEl) availEl.textContent = 'Available: $' + detailsAvailableWithdrawAmt.toFixed(2);
                }
            } catch (e) {
                console.error('Failed to load details balances:', e);
            }
        }

        // Details panel deposit functions
        function updateDetailsDepositFromSlider(percent) {
            const amount = (detailsUsdcBalance * percent / 100).toFixed(2);
            document.getElementById('vaultDepositAmount').value = amount;
        }

        function updateDetailsDepositSlider() {
            const amount = parseFloat(document.getElementById('vaultDepositAmount').value) || 0;
            const percent = detailsUsdcBalance > 0 ? Math.min(100, (amount / detailsUsdcBalance) * 100) : 0;
            document.getElementById('detailsDepositSlider').value = percent;
        }

        function setDetailsDepositPercent(percent) {
            document.getElementById('detailsDepositSlider').value = percent;
            updateDetailsDepositFromSlider(percent);
        }

        // Details panel withdraw functions
        function updateDetailsWithdrawFromSlider(percent) {
            const amount = (detailsAvailableWithdrawAmt * percent / 100).toFixed(2);
            document.getElementById('vaultWithdrawAmount').value = amount;
        }

        function updateDetailsWithdrawSlider() {
            const amount = parseFloat(document.getElementById('vaultWithdrawAmount').value) || 0;
            const percent = detailsAvailableWithdrawAmt > 0 ? Math.min(100, (amount / detailsAvailableWithdrawAmt) * 100) : 0;
            document.getElementById('detailsWithdrawSlider').value = percent;
        }

        function setDetailsWithdrawPercent(percent) {
            document.getElementById('detailsWithdrawSlider').value = percent;
            updateDetailsWithdrawFromSlider(percent);
        }

        function setMaxDeposit() {
            setDetailsDepositPercent(100);
        }

        function setMaxWithdraw() {
            setDetailsWithdrawPercent(100);
        }

        // Custom Asset Dropdown Functions
        function toggleAssetDropdown() {
            const dropdown = document.getElementById('assetDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        function selectAsset(symbol, iconUrl) {
            document.getElementById('selectedAssetIcon').src = iconUrl;
            document.getElementById('selectedAssetName').textContent = symbol;
            document.getElementById('depositAssetSelect').value = symbol;
            document.getElementById('assetDropdown').style.display = 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const assetSelector = document.getElementById('assetSelector');
            if (assetSelector && !assetSelector.contains(e.target)) {
                document.getElementById('assetDropdown').style.display = 'none';
            }
        });

        // ========== REAL VAULT DEPOSIT/WITHDRAW ==========
        const VAULT_TREASURY_ADDRESS = '0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1';
        const VAULT_USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // Base USDC (6 decimals)

        // VaultClaims contract for user withdrawals
        const VAULT_CLAIMS_ADDRESS = '0x6E192BCD12B93AAD8f04Dc2e68fd2043C5808280'; // Deployed on Base
        const VAULT_CLAIMS_ABI = [
            'function claim() external',
            'function claimableAmount(address) view returns (uint256)',
            'function hasClaim(address) view returns (bool)',
            'function getBalance() view returns (uint256)',
            'function isAdmin(address) view returns (bool)',
            'function deposit(uint256) external',
            'function approveClaim(address, uint256) external',
            'function batchApproveClaims(address[], uint256[]) external'
        ];

        // SuiteYieldVault contract for instant deposits/withdrawals
        const SUITE_YIELD_VAULT_ADDRESS = '0x72d28EEA52ab54448f0A8CCEd2E3d224De759D42';
        const SUITE_YIELD_VAULT_ABI = [
            'function deposit(uint256 amount) external',
            'function withdraw(uint256 amount) external',
            'function getLiquidBalance() view returns (uint256)',
            'function getWithdrawableAmount(address user) view returns (uint256)',
            'function getSpendableCredits(address user) view returns (uint256)',
            'function getUserPosition(address user) view returns (uint256 deposited, uint256 credits, uint256 used, uint256 withdrawable, uint256 pending, uint8 yieldPref)',
            'function userDeposits(address) view returns (uint256)',
            'function userCredits(address) view returns (uint256)',
            'function creditsUsed(address) view returns (uint256)',
            'function setYieldPreference(uint8 keepPercent) external'
        ];

        async function executeVaultDeposit() {
            // Check both inline input and hidden modal field
            const inlineAmount = document.getElementById('depositAmountInput')?.value;
            const modalAmount = document.getElementById('vaultDepositAmount')?.value;
            const amount = parseFloat(inlineAmount) > 0 ? inlineAmount : modalAmount;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }

            if (!window.ethereum) {
                showNotification('âš ï¸', 'Error', 'Please install MetaMask or another wallet');
                return;
            }

            try {
                // Get connected wallet
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const fromAddress = accounts[0];

                // Convert amount to USDC units (6 decimals)
                const amountUSDC = Math.floor(parseFloat(amount) * 1e6);

                // Check USDC balance first
                const balanceData = '0x70a08231' + fromAddress.slice(2).padStart(64, '0');
                const balanceHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: VAULT_USDC_ADDRESS, data: balanceData }, 'latest']
                });
                const balance = parseInt(balanceHex, 16);

                if (balance < amountUSDC) {
                    showNotification('âš ï¸', 'Error', `Insufficient USDC. You have $${(balance / 1e6).toFixed(2)}`);
                    return;
                }

                // Step 1: Check allowance for SuiteYieldVault contract
                showNotification('ðŸ¦', 'Checking', 'Checking USDC approval...');

                const allowanceData = '0xdd62ed3e' +
                    fromAddress.slice(2).padStart(64, '0') +
                    SUITE_YIELD_VAULT_ADDRESS.slice(2).padStart(64, '0');

                const allowanceHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: VAULT_USDC_ADDRESS, data: allowanceData }, 'latest']
                });
                const currentAllowance = parseInt(allowanceHex, 16);

                // Step 2: Approve if needed
                if (currentAllowance < amountUSDC) {
                    showNotification('ðŸ¦', 'Approving', 'Please approve USDC spending in your wallet...');

                    const approveData = '0x095ea7b3' +
                        SUITE_YIELD_VAULT_ADDRESS.slice(2).padStart(64, '0') +
                        amountUSDC.toString(16).padStart(64, '0'); // Approve exact amount only

                    const approveTx = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: fromAddress,
                            to: VAULT_USDC_ADDRESS,
                            data: approveData,
                        }]
                    });

                    showNotification('ðŸ¦', 'Approved', 'USDC approved! Waiting for confirmation...');

                    // Wait for approval to be mined
                    await waitForVaultTransaction(approveTx);
                }

                // Step 3: Call deposit on SuiteYieldVault contract
                showNotification('ðŸ¦', 'Depositing', 'Please confirm the deposit in your wallet...');

                // deposit(uint256 amount) - function selector: 0xb6b55f25
                const depositData = '0xb6b55f25' +
                    amountUSDC.toString(16).padStart(64, '0');

                const depositTx = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: SUITE_YIELD_VAULT_ADDRESS,
                        data: depositData,
                    }]
                });

                showNotification('ðŸ¦', 'Confirming', 'Waiting for transaction confirmation...');

                // Wait for deposit to be mined
                await waitForVaultTransaction(depositTx);

                // Step 4: Record deposit in Supabase (for off-chain tracking)
                try {
                    await fetch(`${VAULT_SUPABASE_URL}/rest/v1/treasury_deposits`, {
                        method: 'POST',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            wallet_address: fromAddress.toLowerCase(),
                            amount_deposited: parseFloat(amount),
                            token_type: 'USDC',
                            usd_value_at_deposit: parseFloat(amount), // USDC = 1:1 USD
                            lp_tokens_issued: parseFloat(amount) * 1000, // 1 USDC = 1000 credits
                            notes: `Contract deposit Tx: ${depositTx}`
                        })
                    });
                } catch (dbError) {
                    console.error('Failed to record deposit in database:', dbError);
                    // Don't fail the whole operation - deposit succeeded on-chain
                }

                // Step 5: Update UI
                const creditsEarned = (parseFloat(amount) * 1000).toLocaleString();
                showNotification('âœ…', 'Success!', `Deposited $${amount} USDC and received ${creditsEarned} credits!`);

                // Clear both input fields
                if (document.getElementById('depositAmountInput')) {
                    document.getElementById('depositAmountInput').value = '';
                }
                if (document.getElementById('vaultDepositAmount')) {
                    document.getElementById('vaultDepositAmount').value = '';
                }

                // Refresh balances
                if (typeof fetchWalletBalances === 'function') {
                    await fetchWalletBalances(fromAddress);
                }
                if (typeof fetchUSDCBalance === 'function') {
                    fetchUSDCBalance();
                }
                if (typeof updateDepositEstimates === 'function') {
                    updateDepositEstimates();
                }
                if (typeof loadUserVaultData === 'function') {
                    loadUserVaultData();
                }
                loadVaultPublicStats();

            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showNotification('âš ï¸', 'Cancelled', 'Transaction was rejected');
                } else {
                    showNotification('âŒ', 'Error', error.message || 'Deposit failed');
                }
            }
        }

        async function executeVaultWithdraw() {
            const amount = document.getElementById('vaultWithdrawAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }

            if (!window.ethereum) {
                showNotification('âš ï¸', 'Error', 'Please install MetaMask or another wallet');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const walletAddress = accounts[0];
                const amountUSDC = Math.floor(parseFloat(amount) * 1e6);

                // Check withdrawable amount from contract
                showNotification('ðŸ¦', 'Checking', 'Checking withdrawable balance...');

                // getWithdrawableAmount(address) - function selector: 0x2e1a7d4d is withdraw, we need getWithdrawableAmount
                // getWithdrawableAmount(address user) returns (uint256) - selector: 0xd4c3eea0
                const withdrawableData = '0xd4c3eea0' + walletAddress.slice(2).padStart(64, '0');
                const withdrawableHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: SUITE_YIELD_VAULT_ADDRESS, data: withdrawableData }, 'latest']
                });
                const contractWithdrawable = parseInt(withdrawableHex, 16) / 1e6;

                if (parseFloat(amount) > contractWithdrawable) {
                    showNotification('âš ï¸', 'Error', `Maximum withdrawable: $${contractWithdrawable.toFixed(2)}`);
                    return;
                }

                // Check liquid balance in contract
                // getLiquidBalance() - selector: 0xf2f4eb26
                const liquidData = '0xf2f4eb26';
                const liquidHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: SUITE_YIELD_VAULT_ADDRESS, data: liquidData }, 'latest']
                });
                const liquidBalance = parseInt(liquidHex, 16) / 1e6;

                if (liquidBalance >= parseFloat(amount)) {
                    // Instant withdrawal - enough liquid in contract
                    showNotification('ðŸ¦', 'Withdrawing', 'Please confirm the withdrawal in your wallet...');

                    // withdraw(uint256 amount) - function selector: 0x2e1a7d4d
                    const withdrawData = '0x2e1a7d4d' + amountUSDC.toString(16).padStart(64, '0');

                    const withdrawTx = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: walletAddress,
                            to: SUITE_YIELD_VAULT_ADDRESS,
                            data: withdrawData,
                        }]
                    });

                    showNotification('ðŸ¦', 'Confirming', 'Waiting for transaction confirmation...');
                    await waitForVaultTransaction(withdrawTx);

                    showNotification('âœ…', 'Success!', `Withdrew $${amount} USDC instantly!`);
                    document.getElementById('vaultWithdrawAmount').value = '';

                    // Refresh balances
                    if (typeof fetchWalletBalances === 'function') {
                        await fetchWalletBalances(walletAddress);
                    }
                    loadVaultPublicStats();

                } else {
                    // Not enough liquid - create withdrawal request (fallback)
                    // This will trigger the contract's request system
                    showNotification('ðŸ¦', 'Requesting', 'Not enough liquid funds. Creating withdrawal request...');

                    // withdraw(uint256 amount) - will create a request if not enough liquid
                    const withdrawData = '0x2e1a7d4d' + amountUSDC.toString(16).padStart(64, '0');

                    const withdrawTx = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: walletAddress,
                            to: SUITE_YIELD_VAULT_ADDRESS,
                            data: withdrawData,
                        }]
                    });

                    showNotification('ðŸ¦', 'Confirming', 'Waiting for transaction confirmation...');
                    await waitForVaultTransaction(withdrawTx);

                    showNotification('ðŸ“¤', 'Request Created',
                        `Withdrawal request for $${amount} created. Will be processed when funds return from yield strategies.`);
                    document.getElementById('vaultWithdrawAmount').value = '';
                }

                // Reload user's position
                loadUserWithdrawals(walletAddress);
                loadUserVaultPosition(walletAddress);

            } catch (error) {
                console.error('Withdrawal error:', error);
                if (error.code === 4001) {
                    showNotification('âš ï¸', 'Cancelled', 'Transaction was rejected');
                } else {
                    showNotification('âŒ', 'Error', error.message || 'Withdrawal failed');
                }
            }
        }

        // Calculate user's max withdrawable amount
        async function calculateUserWithdrawable(walletAddress) {
            const wallet = walletAddress.toLowerCase();

            try {
                // Get user's LP tokens
                const depositsRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_deposits?wallet_address=eq.${wallet}&withdrawn=eq.false&select=lp_tokens_issued,usd_value_at_deposit`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const deposits = await depositsRes.json();
                const userLP = deposits.reduce((sum, d) => sum + parseFloat(d.lp_tokens_issued || 0), 0);
                const userDeposited = deposits.reduce((sum, d) => sum + parseFloat(d.usd_value_at_deposit || 0), 0);

                // Get total LP supply
                const totalLPRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_deposits?withdrawn=eq.false&select=lp_tokens_issued`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const allDeposits = await totalLPRes.json();
                const totalLP = allDeposits.reduce((sum, d) => sum + parseFloat(d.lp_tokens_issued || 0), 0);

                // Get current vault value
                const vaultRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/vault_value_reports?order=reported_at.desc&limit=1`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const vaultReports = await vaultRes.json();
                let vaultValue = vaultReports.length > 0 ? parseFloat(vaultReports[0].reported_value_usd) : 0;

                // If no vault reports, use total deposits
                if (vaultValue === 0) {
                    vaultValue = allDeposits.reduce((sum, d) => sum + parseFloat(d.usd_value_at_deposit || 0), 0);
                }

                // Calculate user's vault share
                const lpSharePercent = totalLP > 0 ? (userLP / totalLP) : 0;
                const vaultShare = lpSharePercent * vaultValue;

                // Get user's credits used
                const creditsRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/suite_credits?wallet_address=eq.${wallet}&select=total_used`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const credits = await creditsRes.json();
                const creditsUsed = credits.length > 0 ? parseFloat(credits[0].total_used || 0) : 0;

                // Get yield allocated to apps
                const yieldToAppsRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/app_funding?user_id=eq.${wallet}&source=eq.yield&select=amount`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const yieldToAppsData = await yieldToAppsRes.json();
                const yieldToApps = yieldToAppsData.reduce((sum, y) => sum + parseFloat(y.amount || 0), 0);

                // Get pending withdrawal requests
                const pendingRes = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?wallet_address=eq.${wallet}&status=in.(pending,approved,ready)&select=amount_usd`,
                    { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                );
                const pending = await pendingRes.json();
                const pendingWithdrawals = pending.reduce((sum, p) => sum + parseFloat(p.amount_usd || 0), 0);

                // Calculate available (vault share - credits used in USD - yield to apps - pending)
                const creditsUsedUsd = creditsUsed / 1000; // Convert credits to USD
                const available = Math.max(vaultShare - creditsUsedUsd - yieldToApps - pendingWithdrawals, 0);

                // Calculate spendable credits (vault share in credits - spent - yield to apps in credits)
                const grossCredits = Math.floor(vaultShare * 1000);
                const yieldToAppsCredits = Math.floor(yieldToApps * 1000);
                const spendableCredits = Math.max(grossCredits - creditsUsed - yieldToAppsCredits, 0);

                return {
                    userLP,
                    totalLP,
                    lpSharePercent: lpSharePercent * 100,
                    vaultValue,
                    vaultShare,
                    creditsUsed,
                    yieldToApps,
                    yieldToAppsCredits,
                    pendingWithdrawals,
                    available,
                    userDeposited,
                    grossCredits,
                    spendableCredits
                };

            } catch (error) {
                console.error('Error calculating withdrawable:', error);
                return {
                    userLP: 0, totalLP: 0, lpSharePercent: 0, vaultValue: 0,
                    vaultShare: 0, creditsUsed: 0, yieldToApps: 0, yieldToAppsCredits: 0,
                    pendingWithdrawals: 0, available: 0, userDeposited: 0,
                    grossCredits: 0, spendableCredits: 0
                };
            }
        }

        // Set max withdraw amount
        async function setMaxWithdraw() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (!accounts[0]) {
                    showNotification('âš ï¸', 'Error', 'Please connect your wallet first');
                    return;
                }

                const withdrawable = await calculateUserWithdrawable(accounts[0]);
                const input = document.getElementById('vaultWithdrawAmount');
                if (input) {
                    input.value = withdrawable.available.toFixed(2);
                }

                showNotification('ðŸ’°', 'Max Withdraw',
                    `Vault share: $${withdrawable.vaultShare.toFixed(2)}\n` +
                    `Credits used: -$${withdrawable.creditsUsed.toFixed(2)}\n` +
                    `Pending: -$${withdrawable.pendingWithdrawals.toFixed(2)}\n` +
                    `Available: $${withdrawable.available.toFixed(2)}`
                );
            } catch (error) {
                console.error('Error setting max withdraw:', error);
            }
        }

        // Helper: Wait for transaction to be mined
        async function waitForVaultTransaction(txHash, maxAttempts = 30) {
            for (let i = 0; i < maxAttempts; i++) {
                const receipt = await window.ethereum.request({
                    method: 'eth_getTransactionReceipt',
                    params: [txHash]
                });

                if (receipt) {
                    if (receipt.status === '0x1') {
                        return receipt;
                    } else {
                        throw new Error('Transaction failed');
                    }
                }

                await new Promise(resolve => setTimeout(resolve, 2000)); // Wait 2 seconds
            }
            throw new Error('Transaction timeout');
        }

        // ========== USER VAULT POSITION ==========
        async function loadUserVaultPosition(walletAddress) {
            if (!walletAddress) return;

            try {
                // Get full calculation
                const data = await calculateUserWithdrawable(walletAddress);

                // Update UI elements
                const depositedEl = document.getElementById('userVaultDeposited');
                const earnedEl = document.getElementById('userVaultEarned');
                const lpEl = document.getElementById('userVaultLPTokens');
                const vaultDepositEl = document.getElementById('vaultDeposit');

                // Calculate earnings (vault share - original deposit)
                const earnings = data.vaultShare - data.userDeposited;

                if (depositedEl) depositedEl.textContent = `$${data.userDeposited.toFixed(2)}`;
                if (earnedEl) earnedEl.textContent = `$${earnings.toFixed(2)}`;
                if (lpEl) lpEl.textContent = data.userLP.toFixed(0);
                if (vaultDepositEl) vaultDepositEl.textContent = `$${data.vaultShare.toFixed(2)}`;

                // Update the "Available to Withdraw" display if it exists
                const availableEl = document.getElementById('userAvailableWithdraw');
                if (availableEl) {
                    availableEl.textContent = `$${data.available.toFixed(2)}`;
                }

                // Update credits used display if it exists
                const creditsUsedEl = document.getElementById('userCreditsUsed');
                if (creditsUsedEl) {
                    creditsUsedEl.textContent = `-$${(data.creditsUsed / 1000).toFixed(2)}`;
                }

                // Update main credits balance display (dynamic calculation)
                const creditsBalanceEl = document.getElementById('userCreditsBalance');
                const creditsUsdEl = document.getElementById('creditsUsdValue');
                if (creditsBalanceEl) {
                    creditsBalanceEl.textContent = data.spendableCredits.toLocaleString();
                }
                if (creditsUsdEl) {
                    creditsUsdEl.textContent = `$${(data.spendableCredits / 1000).toFixed(2)}`;
                }

                // Load user's withdrawals
                await loadUserWithdrawals(walletAddress);

            } catch (error) {
                console.error('Error loading user vault position:', error);
            }
        }

        // Load user's withdrawal requests
        async function loadUserWithdrawals(walletAddress) {
            if (!walletAddress) return;

            const card = document.getElementById('userWithdrawalsCard');
            const list = document.getElementById('userWithdrawalsList');
            if (!card || !list) return;

            try {
                const response = await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?wallet_address=eq.${walletAddress.toLowerCase()}&order=created_at.desc`,
                    {
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to load');

                const withdrawals = await response.json();

                // Only show card if there are withdrawals
                if (withdrawals.length === 0) {
                    card.style.display = 'none';
                    return;
                }

                card.style.display = 'block';

                let html = '';
                withdrawals.forEach(w => {
                    let statusBadge = '';
                    let actionBtn = '';
                    let statusNote = '';

                    if (w.status === 'pending') {
                        statusBadge = '<span style="background: #f97316; color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">Pending</span>';
                        statusNote = '<div style="font-size: 0.7rem; color: #f97316; margin-top: 4px;">Waiting for admin review (1-2 days)</div>';
                    } else if (w.status === 'approved') {
                        statusBadge = '<span style="background: #3b82f6; color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">Approved</span>';
                        statusNote = '<div style="font-size: 0.7rem; color: #3b82f6; margin-top: 4px;">Admin preparing USDC...</div>';
                    } else if (w.status === 'ready') {
                        statusBadge = '<span style="background: #22c55e; color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">Ready to Claim</span>';
                        actionBtn = `<button onclick="claimWithdrawal('${w.id}', ${w.amount_usd})" style="margin-top: 6px; padding: 6px 12px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; width: 100%;">Claim $${parseFloat(w.amount_usd).toFixed(2)}</button>`;
                    } else if (w.status === 'completed') {
                        statusBadge = '<span style="background: #6b7280; color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">Completed</span>';
                        if (w.tx_hash) {
                            statusNote = `<div style="font-size: 0.65rem; color: #6b7280; margin-top: 4px;"><a href="https://basescan.org/tx/${w.tx_hash}" target="_blank" style="color: #3b82f6;">View tx</a></div>`;
                        }
                    } else if (w.status === 'cancelled') {
                        statusBadge = '<span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 600;">Cancelled</span>';
                    }

                    html += `
                        <div style="padding: 10px; background: rgba(255,255,255,0.3); border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-weight: 700; color: #1f2937;">$${parseFloat(w.amount_usd).toFixed(2)}</span>
                                ${statusBadge}
                            </div>
                            <div style="font-size: 0.75rem; color: #6b7280; margin-top: 4px;">
                                Requested ${new Date(w.requested_at || w.created_at).toLocaleDateString()}
                            </div>
                            ${statusNote}
                            ${actionBtn}
                        </div>
                    `;
                });

                list.innerHTML = html;

            } catch (error) {
                console.error('Error loading withdrawals:', error);
                list.innerHTML = '<div style="color: #ef4444;">Error loading</div>';
            }
        }

        // User claims approved withdrawal from VaultClaims contract
        async function claimWithdrawal(withdrawalId, amount) {
            if (!confirm(`Claim $${amount.toFixed(2)} USDC?\n\nThis will transfer USDC directly to your wallet.`)) return;

            // Check if contract is deployed
            if (VAULT_CLAIMS_ADDRESS === '0x0000000000000000000000000000000000000000') {
                showNotification('âš ï¸', 'Not Ready', 'Claims contract not deployed yet. Admin will send manually.');
                return;
            }

            try {
                showNotification('â³', 'Processing', 'Claiming from contract...');

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const userAddress = accounts[0];

                // Check if user has claimable amount in contract
                // claimableAmount(address) selector = 0x1e83409a... actually let's use a simpler approach
                // Call claim() function: selector = 0x4e71d92d
                const claimData = '0x4e71d92d'; // claim() function selector

                const tx = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: userAddress,
                        to: VAULT_CLAIMS_ADDRESS,
                        data: claimData,
                        gas: '0x30D40' // 200,000 gas
                    }]
                });

                showNotification('â³', 'Confirming', 'Waiting for transaction confirmation...');

                // Wait for transaction
                await waitForVaultTransaction(tx);

                // Mark as completed in Supabase
                await fetch(
                    `${VAULT_SUPABASE_URL}/rest/v1/treasury_withdrawals?id=eq.${withdrawalId}`,
                    {
                        method: 'PATCH',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            status: 'completed',
                            claimed_at: new Date().toISOString(),
                            tx_hash: tx
                        })
                    }
                );

                showNotification('âœ…', 'Claimed!', `$${amount.toFixed(2)} USDC sent to your wallet!`);

                // Reload user withdrawals
                loadUserWithdrawals(userAddress);

            } catch (error) {
                console.error('Error claiming withdrawal:', error);
                if (error.code === 4001) {
                    showNotification('âš ï¸', 'Cancelled', 'Transaction was rejected');
                } else if (error.message?.includes('Nothing to claim')) {
                    showNotification('âš ï¸', 'Error', 'No claimable amount found. Contact admin.');
                } else {
                    showNotification('âŒ', 'Error', error.message || 'Failed to claim');
                }
            }
        }

        // Check user's claimable amount from contract
        async function checkClaimableAmount(userAddress) {
            if (VAULT_CLAIMS_ADDRESS === '0x0000000000000000000000000000000000000000') {
                return 0;
            }

            try {
                // claimableAmount(address) = 0xa6a7bef4 + address padded
                const data = '0xa6a7bef4' + userAddress.slice(2).padStart(64, '0');

                const result = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: VAULT_CLAIMS_ADDRESS, data: data }, 'latest']
                });

                // Convert from wei (6 decimals for USDC)
                const amountRaw = parseInt(result, 16);
                return amountRaw / 1e6;
            } catch (error) {
                console.error('Error checking claimable amount:', error);
                return 0;
            }
        }

        // ========== APP TIER HELPER ==========
        function getAppTier(funded) {
            if (funded >= 15000) return { name: 'Scale', icon: 'ðŸ¢', color: '#ff9500' };
            if (funded >= 5000) return { name: 'Launch', icon: 'ðŸš€', color: '#a855f7' };
            if (funded >= 2500) return { name: 'Growth', icon: 'ðŸŒ³', color: '#3b82f6' };
            if (funded >= 1000) return { name: 'Sprout', icon: 'ðŸŒ¿', color: '#4ade80' };
            return { name: 'Seed', icon: 'ðŸŒ±', color: '#22c55e' };
        }

        // ========== MY FUNDED APPS SECTION ==========
        let myFundedApps = [];

        async function loadMyFundedApps() {
            const list = document.getElementById('myFundedAppsList');
            const totalFunded = document.getElementById('myTotalFunded');
            const appsFunded = document.getElementById('myAppsFunded');
            const totalEarnings = document.getElementById('myTotalEarnings');

            if (!list || !currentUserId) {
                if (list) {
                    list.innerHTML = `<div style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">
                        Please connect your wallet to see your funded apps.
                    </div>`;
                }
                return;
            }

            try {
                // Fetch user's funding from app_funding table
                const response = await fetch(
                    `${ADMIN_SUPABASE_URL}/rest/v1/app_funding?user_id=eq.${currentUserId}&select=*,apps(id,name,slug,total_funded,total_revenue,is_graduated)`,
                    {
                        headers: {
                            'apikey': ADMIN_SUPABASE_KEY,
                            'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                        }
                    }
                );

                const funding = await response.json();

                if (!funding || funding.length === 0) {
                    list.innerHTML = `<div style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">
                        You haven't funded any apps yet.<br>
                        <a href="/suite-shell.html" style="color: #22c55e; text-decoration: underline;">Browse apps</a> to start funding and earn revenue share!
                    </div>`;
                    if (totalFunded) totalFunded.textContent = '$0';
                    if (appsFunded) appsFunded.textContent = '0';
                    if (totalEarnings) totalEarnings.textContent = '$0';
                    return;
                }

                // Group funding by app
                const appFunding = {};
                funding.forEach(f => {
                    if (!f.apps) return;
                    const appId = f.app_id;
                    if (!appFunding[appId]) {
                        appFunding[appId] = {
                            app: f.apps,
                            totalContributed: 0,
                            contributions: []
                        };
                    }
                    appFunding[appId].totalContributed += parseFloat(f.amount) || 0;
                    appFunding[appId].contributions.push(f);
                });

                myFundedApps = Object.values(appFunding);

                // Calculate totals
                let totalFundedAmount = 0;
                let totalEarningsAmount = 0;

                myFundedApps.forEach(af => {
                    totalFundedAmount += af.totalContributed;
                    const appTotalFunded = parseFloat(af.app.total_funded) || 0;
                    const appRevenue = parseFloat(af.app.total_revenue) || 0;
                    const percentage = appTotalFunded > 0 ? (af.totalContributed / appTotalFunded) : 0;
                    const earnings = appRevenue * percentage; // 100% to funders, proportional
                    totalEarningsAmount += earnings;
                });

                // Update summary stats
                if (totalFunded) totalFunded.textContent = '$' + Math.floor(totalFundedAmount).toLocaleString();
                if (appsFunded) appsFunded.textContent = myFundedApps.length.toString();
                if (totalEarnings) totalEarnings.textContent = '$' + totalEarningsAmount.toFixed(2);

                // Render funded apps list
                list.innerHTML = myFundedApps.map(af => {
                    const app = af.app;
                    const appTotalFunded = parseFloat(app.total_funded) || 0;
                    const appRevenue = parseFloat(app.total_revenue) || 0;
                    const percentage = appTotalFunded > 0 ? ((af.totalContributed / appTotalFunded) * 100) : 0;
                    const earnings = appRevenue * (percentage / 100); // 100% to funders
                    const tier = getAppTier(appTotalFunded);

                    return `
                        <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid ${tier.color}20; box-shadow: 0 0 0 1px ${tier.color}10;">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 700; color: #2d1b4e; font-size: 1rem; display: flex; align-items: center; gap: 8px;">
                                        ${app.name}
                                        <span style="background: ${tier.color}20; color: ${tier.color}; font-size: 0.65rem; padding: 2px 8px; border-radius: 100px; font-weight: 700;">${tier.icon} ${tier.name}</span>
                                    </div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">Your contribution: $${af.totalContributed.toFixed(2)}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.7rem; color: #9ca3af;">YOUR SHARE</div>
                                    <div style="font-weight: 800; color: #a855f7; font-size: 1.1rem;">${percentage.toFixed(1)}%</div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 12px; padding-top: 12px; border-top: 1px solid #f3f4f6;">
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">App Total</div>
                                    <div style="font-weight: 600; color: #2d1b4e; font-size: 0.85rem;">$${Math.floor(appTotalFunded).toLocaleString()}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">App Revenue</div>
                                    <div style="font-weight: 600; color: #22c55e; font-size: 0.85rem;">$${appRevenue.toFixed(0)}</div>
                                </div>
                                <div style="text-align: center;">
                                    <div style="font-size: 0.65rem; color: #9ca3af;">Your Earnings</div>
                                    <div style="font-weight: 600; color: #a855f7; font-size: 0.85rem;">$${earnings.toFixed(2)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (err) {
                console.error('Error loading funded apps:', err);
                list.innerHTML = `<div style="text-align: center; padding: 24px; color: #ef4444; font-size: 0.9rem;">
                    Failed to load funded apps. Please try again.
                </div>`;
            }
        }

        // Load funded apps when wallet connects
        document.addEventListener('walletConnected', loadMyFundedApps);

        // ========== APP BUILD REQUESTS ADMIN SECTION ==========
        let buildRequests = [];
        let influencerWaitlist = [];

        async function loadAppBuildRequests() {
            const grid = document.getElementById('buildRequestsGrid');
            const count = document.getElementById('buildRequestCount');
            if (!grid) return;

            try {
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/app_build_requests?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });
                buildRequests = await response.json();
                renderBuildRequests();
            } catch (err) {
                console.error('Error loading build requests:', err);
                grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load requests</div>';
            }
        }

        function renderBuildRequests() {
            const grid = document.getElementById('buildRequestsGrid');
            const count = document.getElementById('buildRequestCount');

            if (buildRequests.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">ðŸ“­ No app build requests yet</div>';
                count.textContent = '0 requests';
                return;
            }

            count.textContent = `${buildRequests.length} request${buildRequests.length !== 1 ? 's' : ''}`;

            const statusColors = {
                'pending': '#f59e0b',
                'contacted': '#3b82f6',
                'in_progress': '#8b5cf6',
                'completed': '#10b981',
                'declined': '#ef4444'
            };

            const complexityLabels = ['', 'Simple', 'Basic', 'Medium', 'Complex', 'Enterprise'];

            grid.innerHTML = buildRequests.map(req => `
                <div style="background: white; border-radius: 16px; padding: 16px; border: 1px solid #e5e7eb;">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                        <div>
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 1rem;">${req.name}</div>
                            <div style="font-size: 0.85rem; color: #6b7280;">${req.telegram}</div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <span style="background: ${statusColors[req.status] || '#9ca3af'}20; color: ${statusColors[req.status] || '#9ca3af'}; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600;">${req.status}</span>
                            <span style="background: #a855f720; color: #a855f7; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600;">Level ${req.complexity} - ${complexityLabels[req.complexity]}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
                        <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; color: #4b5563;">${req.business_type}</span>
                        <span style="background: ${req.deployment_type === 'suite_shell' ? '#10b98120' : '#6b728020'}; color: ${req.deployment_type === 'suite_shell' ? '#10b981' : '#6b7280'}; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600;">${req.deployment_type === 'suite_shell' ? 'ðŸš€ SUITE Shell' : 'ðŸ”’ Private'}</span>
                        <span style="background: #f3f4f6; padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; color: #4b5563;">${new Date(req.created_at).toLocaleDateString()}</span>
                    </div>
                    <div style="font-size: 0.9rem; color: #374151; line-height: 1.5; margin-bottom: 12px; white-space: pre-wrap;">${req.description}</div>

                    <!-- Quote & Invoice Section -->
                    <div style="background: #f9fafb; border-radius: 12px; padding: 12px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
                            <div style="display: flex; align-items: center; gap: 6px;">
                                <span style="font-size: 0.8rem; color: #6b7280; font-weight: 600;">Quote:</span>
                                <span style="color: #6b7280;">$</span>
                                <input type="number"
                                       id="price-${req.id}"
                                       value="${req.quoted_price || ''}"
                                       placeholder="0"
                                       onchange="updateQuotedPrice('${req.id}', this.value)"
                                       style="width: 80px; padding: 6px 8px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 0.9rem; font-weight: 600;">
                            </div>
                            <button onclick="sendInvoice('${req.id}', '${req.name}', '${req.telegram}', '${req.business_type}', '${req.deployment_type || 'suite_shell'}')"
                                    style="padding: 6px 14px; border-radius: 8px; background: linear-gradient(135deg, #10b981, #059669); color: white; border: none; font-size: 0.8rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 6px;">
                                <span>ðŸ’³</span> Send Invoice
                            </button>
                        </div>
                    </div>

                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <select onchange="updateRequestStatus('${req.id}', this.value)" style="padding: 6px 12px; border-radius: 8px; border: 1px solid #e5e7eb; font-size: 0.8rem; cursor: pointer;">
                            <option value="pending" ${req.status === 'pending' ? 'selected' : ''}>Pending</option>
                            <option value="contacted" ${req.status === 'contacted' ? 'selected' : ''}>Contacted</option>
                            <option value="in_progress" ${req.status === 'in_progress' ? 'selected' : ''}>In Progress</option>
                            <option value="completed" ${req.status === 'completed' ? 'selected' : ''}>Completed</option>
                            <option value="declined" ${req.status === 'declined' ? 'selected' : ''}>Declined</option>
                        </select>
                        ${req.telegram ? `<a href="https://t.me/${req.telegram.replace('@', '')}" target="_blank"
                           style="padding: 6px 12px; border-radius: 8px; background: #0088cc; color: white; text-decoration: none; font-size: 0.8rem; font-weight: 600;">
                            ðŸ’¬ Message on Telegram
                        </a>` : ''}
                    </div>
                </div>
            `).join('');
        }

        async function updateRequestStatus(id, status) {
            try {
                await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/app_build_requests?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: status })
                });
                // Update local data
                const req = buildRequests.find(r => r.id === id);
                if (req) req.status = status;
                renderBuildRequests();
            } catch (err) {
                console.error('Error updating status:', err);
            }
        }

        // Stripe Payment Link - SET YOUR LINK HERE
        // Create a payment link in Stripe Dashboard with custom/variable pricing
        const STRIPE_PAYMENT_LINK = 'https://buy.stripe.com/YOUR_PAYMENT_LINK_HERE';

        async function updateQuotedPrice(id, price) {
            try {
                await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/app_build_requests?id=eq.${id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ quoted_price: parseFloat(price) || null })
                });
                // Update local data
                const req = buildRequests.find(r => r.id === id);
                if (req) req.quoted_price = parseFloat(price) || null;
            } catch (err) {
                console.error('Error updating price:', err);
            }
        }

        function sendInvoice(id, name, telegram, businessType, deploymentType) {
            const priceInput = document.getElementById(`price-${id}`);
            const price = priceInput?.value;

            if (!price || parseFloat(price) <= 0) {
                alert('Please enter a quote amount first');
                priceInput?.focus();
                return;
            }

            const isSuiteShell = deploymentType === 'suite_shell';

            // Build invoice message based on deployment type
            const message = isSuiteShell
                ? `Hey ${name}! ðŸ‘‹

Here's your quote for your ${businessType} app:

ðŸ’° Total: $${parseFloat(price).toLocaleString()}

This includes:
âœ… Custom app development
âœ… Launch on SUITE Shell
âœ… Community testing & feedback
âœ… 30 days of support post-launch

Your app will be available to SUITE users for testing, feedback, and real usage data!

To proceed, click the payment link below:
${STRIPE_PAYMENT_LINK}

Once payment is confirmed, we'll start building right away! Let me know if you have any questions.`
                : `Hey ${name}! ðŸ‘‹

Here's your quote for your ${businessType} app:

ðŸ’° Total: $${parseFloat(price).toLocaleString()}

This includes:
âœ… Custom white-label app
âœ… Your own branding
âœ… Private deployment
âœ… 30 days of support post-launch

To proceed, click the payment link below:
${STRIPE_PAYMENT_LINK}

Once payment is confirmed, we'll start building right away! Let me know if you have any questions.`;

            // Encode for Telegram URL
            const encodedMessage = encodeURIComponent(message);
            const telegramUsername = telegram.replace('@', '');
            const telegramUrl = `https://t.me/${telegramUsername}?text=${encodedMessage}`;

            // Open Telegram with pre-filled message
            window.open(telegramUrl, '_blank');

            // Update status to contacted
            updateRequestStatus(id, 'contacted');
        }

        async function loadInfluencerWaitlist() {
            const grid = document.getElementById('influencerWaitlistGrid');
            const count = document.getElementById('influencerCount');
            if (!grid) return;

            try {
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/influencer_waitlist?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });
                influencerWaitlist = await response.json();
                renderInfluencerWaitlist();
            } catch (err) {
                console.error('Error loading influencer waitlist:', err);
                grid.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load waitlist</div>';
            }
        }

        function renderInfluencerWaitlist() {
            const grid = document.getElementById('influencerWaitlistGrid');
            const count = document.getElementById('influencerCount');

            if (influencerWaitlist.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">ðŸ“­ No influencer signups yet</div>';
                count.textContent = '0 signups';
                return;
            }

            count.textContent = `${influencerWaitlist.length} signup${influencerWaitlist.length !== 1 ? 's' : ''}`;

            grid.innerHTML = influencerWaitlist.map(inf => `
                <div style="display: flex; justify-content: space-between; align-items: center; background: white; border-radius: 12px; padding: 12px 16px; border: 1px solid #e5e7eb;">
                    <div style="font-size: 0.9rem; color: #2d1b4e; font-weight: 600;">${inf.email}</div>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <span style="font-size: 0.8rem; color: #9ca3af;">${new Date(inf.created_at).toLocaleDateString()}</span>
                        <a href="mailto:${inf.email}?subject=SUITE Influencer Partnership"
                           style="padding: 4px 10px; border-radius: 8px; background: linear-gradient(135deg, #ff9500, #ff6b9d); color: white; text-decoration: none; font-size: 0.75rem; font-weight: 600;">
                            Email
                        </a>
                    </div>
                </div>
            `).join('');
        }

        // Load build requests, influencer waitlist, and revenue data when admin dashboard becomes visible
        const buildRequestsObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.attributeName === 'style') {
                    const adminDashboard = document.getElementById('adminDashboard');
                    if (adminDashboard && adminDashboard.style.display !== 'none') {
                        loadAppBuildRequests();
                        loadInfluencerWaitlist();
                        loadRevenueData();
                    }
                }
            });
        });

        const adminDashboardForRequests = document.getElementById('adminDashboard');
        if (adminDashboardForRequests) {
            buildRequestsObserver.observe(adminDashboardForRequests, { attributes: true });
        }

        // ========== ALL APPS ADMIN SECTION ==========
        const ADMIN_DISCORD_ID = '1135315153824993402';
        const ADMIN_API_URL = 'http://10.0.0.142:3000/api/admin';
        const ADMIN_SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const ADMIN_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';
        let adminApps = [];

        // Fetch features from app_features table for an app
        async function fetchAppFeatures(appId) {
            try {
                const response = await fetch(
                    `${ADMIN_SUPABASE_URL}/rest/v1/app_features?app_id=eq.${appId}&select=*`,
                    {
                        headers: {
                            'apikey': ADMIN_SUPABASE_KEY,
                            'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                        }
                    }
                );
                if (!response.ok) return { free: [], paid: [] };
                const features = await response.json();

                // Separate free and paid features
                const free = features
                    .filter(f => f.type === 'free' || f.type === 'freemium')
                    .map(f => f.name);
                const paid = features
                    .filter(f => f.type === 'paid')
                    .map(f => `${f.name} (${f.credit_cost || 0} credits)`);

                return { free, paid };
            } catch (err) {
                console.error('Error fetching app features:', err);
                return { free: [], paid: [] };
            }
        }

        async function loadAllAppsAdmin() {
            const grid = document.getElementById('adminAppsGrid');
            const count = document.getElementById('adminAppCount');
            if (!grid) return;

            try {
                // Fetch directly from Supabase
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/apps?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch apps');
                adminApps = await response.json();
                renderAdminApps();
            } catch (err) {
                console.error('Error loading admin apps:', err);
                grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444; font-size: 0.9rem; grid-column: 1 / -1;">âš ï¸ ${err.message || 'Could not load apps'}</div>`;
            }
        }

        function renderAdminApps() {
            const grid = document.getElementById('adminAppsGrid');
            const count = document.getElementById('adminAppCount');

            if (adminApps.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem; grid-column: 1 / -1;">ðŸ“­ No apps found.</div>';
                count.textContent = '0 apps';
                return;
            }

            count.textContent = `${adminApps.length} app${adminApps.length !== 1 ? 's' : ''}`;

            grid.innerHTML = adminApps.map(app => {
                const isLive = app.status === 'approved' || app.status === 'featured';
                const statusColor = isLive ? '#22c55e' : app.status === 'pending' ? '#f59e0b' : '#9ca3af';
                const statusLabel = app.status === 'approved' ? 'Live' :
                    app.status === 'featured' ? 'Featured' :
                        app.status === 'pending' ? 'Pending' : 'Offline';

                return `
                    <div style="background: rgba(255,255,255,0.8); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${app.icon_url || '/assets/suite-logo-new.png'}" alt="${app.name}" 
                                style="width: 48px; height: 48px; border-radius: 12px; object-fit: cover;"
                                onerror="this.src='/assets/suite-logo-new.png'">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; color: #2d1b4e; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.name}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.tagline || 'No tagline'}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(34, 197, 94, 0.1); color: ${statusColor}; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">
                                <span style="width: 6px; height: 6px; background: ${statusColor}; border-radius: 50%;"></span>
                                ${statusLabel}
                            </span>
                            <span style="background: rgba(168, 85, 247, 0.1); color: #a855f7; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600;">${app.category || 'app'}</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: auto;">
                            <a href="/suite-shell.html?app=${app.slug}" target="_blank"
                                style="flex: 1; text-align: center; padding: 8px; background: rgba(0,0,0,0.04); color: #2d1b4e; border-radius: 8px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">View</a>
                            <button onclick="openEditModal('${app.slug}')"
                                style="flex: 1; padding: 8px; background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Edit</button>
                            <button onclick="toggleAppLive('${app.slug}', ${isLive})"
                                style="flex: 1; padding: 8px; background: ${isLive ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; color: ${isLive ? '#ef4444' : '#22c55e'}; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                ${isLive ? 'Take Offline' : 'Go Live'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleAppLive(slug, currentlyLive) {
            const newStatus = currentlyLive ? 'pending' : 'approved';
            try {
                // Update directly in Supabase
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/apps?slug=eq.${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: newStatus })
                });
                if (!response.ok) throw new Error('Failed to update app');

                // Update local state
                const app = adminApps.find(a => a.slug === slug);
                if (app) app.status = newStatus;
                renderAdminApps();
                showNotification(currentlyLive ? 'â¸ï¸' : 'ðŸŸ¢', 'Updated', `${slug} is now ${currentlyLive ? 'offline' : 'live'}`);
            } catch (err) {
                console.error('Toggle failed:', err);
                showNotification('âš ï¸', 'Error', err.message);
            }
        }

        // ============================================
        // REVENUE TRACKING FUNCTIONS
        // ============================================
        let revenueApps = [];
        const GRADUATION_THRESHOLD = 5000;

        async function loadRevenueData() {
            const grid = document.getElementById('revenueAppsGrid');
            const count = document.getElementById('revenueAppCount');
            const select = document.getElementById('revenueAppSelect');
            if (!grid) return;

            try {
                // Fetch apps with funding data
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/apps?select=id,name,slug,emoji_icon,total_funded,total_revenue,is_graduated,funder_count&order=total_funded.desc.nullslast`, {
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });
                if (!response.ok) throw new Error('Failed to fetch apps');
                revenueApps = await response.json();

                // Render stats and grid
                renderRevenueStats();
                renderRevenueApps();

                // Populate select dropdown (only apps with funding)
                const fundedApps = revenueApps.filter(a => parseFloat(a.total_funded) > 0);
                select.innerHTML = '<option value="">-- Select App --</option>' +
                    fundedApps.map(app => `<option value="${app.id}">${app.emoji_icon || 'ðŸ“±'} ${app.name} ($${parseFloat(app.total_funded || 0).toFixed(0)} funded)</option>`).join('');

            } catch (err) {
                console.error('Error loading revenue data:', err);
                grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444; font-size: 0.9rem;">âš ï¸ ${err.message || 'Could not load data'}</div>`;
            }
        }

        function renderRevenueStats() {
            const totalRevenue = revenueApps.reduce((sum, app) => sum + parseFloat(app.total_revenue || 0), 0);
            const funderShare = totalRevenue; // 100% to funders
            const graduatedCount = revenueApps.filter(a => parseFloat(a.total_funded) >= GRADUATION_THRESHOLD).length;

            document.getElementById('totalAppRevenue').textContent = `$${totalRevenue.toFixed(2)}`;
            document.getElementById('totalFunderShare').textContent = `$${funderShare.toFixed(2)}`;
            document.getElementById('graduatedAppCount').textContent = graduatedCount.toString();
            document.getElementById('revenueAppCount').textContent = `${revenueApps.filter(a => parseFloat(a.total_funded) > 0).length} apps`;
        }

        function renderRevenueApps() {
            const grid = document.getElementById('revenueAppsGrid');

            // Only show apps that have received funding
            const fundedApps = revenueApps.filter(a => parseFloat(a.total_funded) > 0);

            if (fundedApps.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem;">ðŸ“­ No apps have received funding yet.</div>';
                return;
            }

            grid.innerHTML = fundedApps.map(app => {
                const funded = parseFloat(app.total_funded) || 0;
                const revenue = parseFloat(app.total_revenue) || 0;
                const funderCount = parseInt(app.funder_count) || 0;
                const tier = getAppTier(funded);
                const funderEarnings = revenue; // 100% to funders

                // Calculate next tier target
                let nextTierTarget = 1000;
                if (funded >= 15000) nextTierTarget = null;
                else if (funded >= 5000) nextTierTarget = 15000;
                else if (funded >= 2500) nextTierTarget = 5000;
                else if (funded >= 1000) nextTierTarget = 2500;

                const progress = nextTierTarget ? Math.min((funded / nextTierTarget) * 100, 100) : 100;

                return `
                    <div style="background: white; border-radius: 12px; padding: 16px; border: 1px solid ${tier.color}30; box-shadow: 0 0 0 1px ${tier.color}15;">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span style="font-size: 1.5rem;">${app.emoji_icon || 'ðŸ“±'}</span>
                                <div>
                                    <div style="font-weight: 700; color: #2d1b4e; font-size: 1rem;">${app.name}</div>
                                    <div style="font-size: 0.8rem; color: #6b7280;">${funderCount} funder${funderCount !== 1 ? 's' : ''}</div>
                                </div>
                            </div>
                            <span style="background: ${tier.color}20; color: ${tier.color}; padding: 4px 10px; border-radius: 100px; font-size: 0.7rem; font-weight: 700;">${tier.icon} ${tier.name}</span>
                        </div>

                        <!-- Funding Progress -->
                        <div style="margin-bottom: 12px;">
                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; margin-bottom: 4px;">
                                <span>Funded</span>
                                <span>$${funded.toFixed(0)}${nextTierTarget ? ' / $' + nextTierTarget : ' (Max Tier)'}</span>
                            </div>
                            <div style="height: 8px; background: #e5e7eb; border-radius: 100px; overflow: hidden;">
                                <div style="height: 100%; width: ${progress}%; background: linear-gradient(90deg, ${tier.color}, ${tier.color}cc); border-radius: 100px;"></div>
                            </div>
                        </div>

                        <!-- Revenue Stats -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
                            <div style="background: rgba(34, 197, 94, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280;">Total Revenue</div>
                                <div style="font-size: 1rem; font-weight: 700; color: #22c55e;">$${revenue.toFixed(2)}</div>
                            </div>
                            <div style="background: rgba(168, 85, 247, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280;">Funder Earnings (100%)</div>
                                <div style="font-size: 1rem; font-weight: 700; color: #a855f7;">$${funderEarnings.toFixed(2)}</div>
                            </div>
                        </div>

                        <!-- View Funders Button -->
                        <button onclick="viewAppFunders('${app.id}', '${app.name}')"
                            style="width: 100%; margin-top: 12px; padding: 10px; background: rgba(0,0,0,0.04); border: none; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: #2d1b4e; cursor: pointer;">
                            View Funders & Distributions
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function recordRevenue() {
            const appId = document.getElementById('revenueAppSelect').value;
            const amount = parseFloat(document.getElementById('revenueAmount').value);

            if (!appId) {
                showNotification('âš ï¸', 'Select App', 'Please select an app to record revenue for.');
                return;
            }
            if (!amount || amount <= 0) {
                showNotification('âš ï¸', 'Enter Amount', 'Please enter a valid revenue amount.');
                return;
            }

            try {
                // Call the distribute_app_revenue function via RPC
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/rpc/distribute_app_revenue`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_app_id: appId,
                        p_revenue_amount: amount
                    })
                });

                if (!response.ok) {
                    const error = await response.text();
                    throw new Error(error || 'Failed to distribute revenue');
                }

                const distributionId = await response.json();

                // Clear form
                document.getElementById('revenueAppSelect').value = '';
                document.getElementById('revenueAmount').value = '';

                // Refresh data
                await loadRevenueData();

                const selectedApp = revenueApps.find(a => a.id === appId);
                showNotification('ðŸ’°', 'Revenue Recorded', `$${amount.toFixed(2)} distributed for ${selectedApp?.name || 'App'}. 100% to funders.`);

            } catch (err) {
                console.error('Error recording revenue:', err);
                showNotification('âš ï¸', 'Error', err.message || 'Failed to record revenue');
            }
        }

        async function viewAppFunders(appId, appName) {
            try {
                // Fetch funders for this app
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/rpc/get_app_funders`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ p_app_id: appId })
                });

                if (!response.ok) throw new Error('Failed to fetch funders');
                const funders = await response.json();

                // Fetch recent distributions
                const distResponse = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/revenue_distributions?app_id=eq.${appId}&order=distributed_at.desc&limit=5`, {
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });
                const distributions = await distResponse.json();

                // Show in a modal/alert (simple version)
                let fundersHtml = funders.length > 0 ?
                    funders.map(f => `â€¢ ${f.user_id.substring(0, 8)}... - $${parseFloat(f.total_contributed).toFixed(2)} (${f.contribution_percentage}%)`).join('\n') :
                    'No funders yet';

                let distHtml = distributions.length > 0 ?
                    distributions.map(d => `â€¢ $${parseFloat(d.total_revenue).toFixed(2)} on ${new Date(d.distributed_at).toLocaleDateString()}`).join('\n') :
                    'No distributions yet';

                alert(`${appName} Funders:\n\n${fundersHtml}\n\nRecent Distributions:\n${distHtml}`);

            } catch (err) {
                console.error('Error fetching funders:', err);
                showNotification('âš ï¸', 'Error', err.message || 'Failed to fetch funder data');
            }
        }

        // Edit Modal Functions
        async function openEditModal(slug) {
            // Verify admin wallet is connected
            if (!walletAddress || !isAdminWallet(walletAddress)) {
                showNotification('âš ï¸', 'Unauthorized', 'Admin wallet required');
                return;
            }

            const app = adminApps.find(a => a.slug === slug);
            if (!app) {
                showNotification('âš ï¸', 'Error', 'App not found');
                return;
            }

            document.getElementById('editAppSlug').value = slug;
            document.getElementById('editName').value = app.name || '';
            document.getElementById('editTagline').value = app.tagline || '';
            document.getElementById('editDescription').value = app.description || '';
            document.getElementById('editType').value = app.type || 'app';
            document.getElementById('editCategory').value = app.category || 'lifestyle';
            document.getElementById('editStatus').value = app.status || 'approved';
            document.getElementById('editAppUrl').value = app.app_url || '';
            document.getElementById('editIconUrl').value = app.icon_url || '';
            document.getElementById('editScreenshot1').value = app.screenshot_1 || '';
            document.getElementById('editScreenshot2').value = app.screenshot_2 || '';
            document.getElementById('editScreenshot3').value = app.screenshot_3 || '';
            document.getElementById('editScreenshot4').value = app.screenshot_4 || '';
            document.getElementById('editScreenshot5').value = app.screenshot_5 || '';

            // Load features from app_features table
            await loadEditFeatures(app.id);

            // Store app ID for feature operations
            window.currentEditAppId = app.id;

            // Show existing images
            showPreviewIfExists('iconPreview', 'iconPlaceholder', app.icon_url);
            showPreviewIfExists('ss1Preview', 'ss1Placeholder', app.screenshot_1, 'ss1Remove');
            showPreviewIfExists('ss2Preview', 'ss2Placeholder', app.screenshot_2, 'ss2Remove');
            showPreviewIfExists('ss3Preview', 'ss3Placeholder', app.screenshot_3, 'ss3Remove');
            showPreviewIfExists('ss4Preview', 'ss4Placeholder', app.screenshot_4, 'ss4Remove');
            showPreviewIfExists('ss5Preview', 'ss5Placeholder', app.screenshot_5, 'ss5Remove');

            document.getElementById('editModalOverlay').classList.add('active');
        }

        function showPreviewIfExists(previewId, placeholderId, url, removeId = null) {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            const removeBtn = removeId ? document.getElementById(removeId) : null;
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }

        function removeScreenshot(hiddenId, previewId, placeholderId, removeId) {
            document.getElementById(hiddenId).value = '';
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).src = '';
            document.getElementById(placeholderId).style.display = 'flex';
            document.getElementById(removeId).style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('active');
            window.currentEditFeatures = [];
            window.currentEditAppId = null;
        }

        // ============================================
        // APP FEATURES MANAGEMENT
        // ============================================
        window.currentEditFeatures = [];

        async function loadEditFeatures(appId) {
            const list = document.getElementById('editFeaturesList');
            if (!list) return;

            list.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 0.9rem;">Loading features...</div>';

            try {
                const response = await fetch(
                    `${ADMIN_SUPABASE_URL}/rest/v1/app_features?app_id=eq.${appId}&is_active=eq.true&order=sort_order,credits_cost,name`,
                    {
                        headers: {
                            'apikey': ADMIN_SUPABASE_KEY,
                            'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                        }
                    }
                );

                if (!response.ok) throw new Error('Failed to fetch features');
                window.currentEditFeatures = await response.json();
                renderEditFeatures();
            } catch (err) {
                console.error('Error loading features:', err);
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444; font-size: 0.9rem;">Failed to load features</div>';
            }
        }

        function renderEditFeatures() {
            const list = document.getElementById('editFeaturesList');
            if (!list) return;

            if (window.currentEditFeatures.length === 0) {
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #9ca3af; font-size: 0.9rem;">No features yet. Add some below!</div>';
                return;
            }

            list.innerHTML = window.currentEditFeatures.map((f, idx) => {
                const isFree = parseFloat(f.credits_cost) === 0;
                const borderColor = isFree ? '#22c55e' : '#a855f7';
                const costLabel = isFree
                    ? '<span style="background: #dcfce7; color: #16a34a; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 700;">FREE</span>'
                    : `<span style="background: #f3e8ff; color: #9333ea; padding: 2px 8px; border-radius: 100px; font-size: 0.7rem; font-weight: 700;">${f.credits_cost} credits</span>`;

                return `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: white; border: 1px solid #e5e7eb; border-left: 4px solid ${borderColor}; border-radius: 8px;">
                        <span style="font-size: 1.3rem; width: 30px; text-align: center;">${f.icon || 'âœ“'}</span>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 600; color: #1f2937; font-size: 0.9rem;">${f.name}</div>
                            ${f.description ? `<div style="font-size: 0.75rem; color: #6b7280; margin-top: 2px;">${f.description}</div>` : ''}
                        </div>
                        ${costLabel}
                        <button type="button" onclick="deleteFeature('${f.id}')"
                            style="padding: 4px 8px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; border-radius: 6px; cursor: pointer; font-size: 0.8rem;">
                            ðŸ—‘ï¸
                        </button>
                    </div>
                `;
            }).join('');
        }

        async function addNewFeature() {
            const appId = window.currentEditAppId;
            if (!appId) {
                showNotification('âš ï¸', 'Error', 'No app selected');
                return;
            }

            const icon = document.getElementById('newFeatureIcon').value.trim() || 'âœ“';
            const name = document.getElementById('newFeatureName').value.trim();
            const cost = parseFloat(document.getElementById('newFeatureCost').value) || 0;
            const desc = document.getElementById('newFeatureDesc').value.trim();

            if (!name) {
                showNotification('âš ï¸', 'Error', 'Feature name is required');
                return;
            }

            try {
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/app_features`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        app_id: appId,
                        name: name,
                        description: desc || null,
                        icon: icon,
                        credits_cost: cost,
                        sort_order: window.currentEditFeatures.length
                    })
                });

                if (!response.ok) throw new Error('Failed to add feature');
                const newFeature = await response.json();

                window.currentEditFeatures.push(newFeature[0] || newFeature);
                renderEditFeatures();

                // Clear inputs
                document.getElementById('newFeatureIcon').value = '';
                document.getElementById('newFeatureName').value = '';
                document.getElementById('newFeatureCost').value = '0';
                document.getElementById('newFeatureDesc').value = '';

                showNotification('âœ…', 'Added', `Feature "${name}" added`);
            } catch (err) {
                console.error('Error adding feature:', err);
                showNotification('âš ï¸', 'Error', err.message || 'Failed to add feature');
            }
        }

        async function deleteFeature(featureId) {
            if (!confirm('Delete this feature?')) return;

            try {
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/app_features?id=eq.${featureId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to delete feature');

                window.currentEditFeatures = window.currentEditFeatures.filter(f => f.id !== featureId);
                renderEditFeatures();
                showNotification('ðŸ—‘ï¸', 'Deleted', 'Feature removed');
            } catch (err) {
                console.error('Error deleting feature:', err);
                showNotification('âš ï¸', 'Error', err.message || 'Failed to delete feature');
            }
        }

        // Close modal when clicking overlay
        document.getElementById('editModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeEditModal();
        });

        function handleEditDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        async function handleEditDrop(e, hiddenInputId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                await uploadEditImage(file, hiddenInputId);
            }
        }

        async function handleEditFileSelect(e, hiddenInputId, previewId, placeholderId) {
            const file = e.target.files[0];
            if (file) {
                const url = await uploadEditImage(file, hiddenInputId);
                if (url) {
                    // Derive remove button ID from preview ID (ss1Preview -> ss1Remove)
                    const removeId = previewId.replace('Preview', 'Remove');
                    showPreviewIfExists(previewId, placeholderId, url, removeId);
                }
            }
        }

        async function uploadEditImage(file, hiddenInputId) {
            // Verify admin wallet is connected
            if (!walletAddress || !isAdminWallet(walletAddress)) {
                showNotification('âš ï¸', 'Unauthorized', 'Admin wallet required');
                return null;
            }

            // Upload directly to Supabase Storage
            const bucket = 'app-assets';
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
            const filePath = `uploads/${fileName}`;

            try {
                // Upload file to Supabase Storage
                const response = await fetch(`${ADMIN_SUPABASE_URL}/storage/v1/object/${bucket}/${filePath}`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': file.type,
                        'x-upsert': 'true'
                    },
                    body: file
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Upload failed: ${errorText}`);
                }

                // Get public URL
                const publicUrl = `${ADMIN_SUPABASE_URL}/storage/v1/object/public/${bucket}/${filePath}`;
                document.getElementById(hiddenInputId).value = publicUrl;
                console.log('Uploaded:', publicUrl);
                return publicUrl;
            } catch (err) {
                console.error('Upload failed:', err);
                showNotification('âš ï¸', 'Upload Failed', err.message);
                return null;
            }
        }

        // Form submission
        document.getElementById('editAppForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Verify admin wallet is connected
            if (!walletAddress || !isAdminWallet(walletAddress)) {
                showNotification('âš ï¸', 'Unauthorized', 'Admin wallet required');
                return;
            }

            const slug = document.getElementById('editAppSlug').value;
            const updates = {
                name: document.getElementById('editName').value,
                tagline: document.getElementById('editTagline').value,
                description: document.getElementById('editDescription').value,
                type: document.getElementById('editType').value,
                category: document.getElementById('editCategory').value,
                status: document.getElementById('editStatus').value,
                app_url: document.getElementById('editAppUrl').value,
                icon_url: document.getElementById('editIconUrl').value,
                free_features: document.getElementById('editFreeFeatures').value,
                pro_features: document.getElementById('editProFeatures').value,
                screenshot_1: document.getElementById('editScreenshot1').value || null,
                screenshot_2: document.getElementById('editScreenshot2').value || null,
                screenshot_3: document.getElementById('editScreenshot3').value || null,
                screenshot_4: document.getElementById('editScreenshot4').value || null,
                screenshot_5: document.getElementById('editScreenshot5').value || null
            };

            try {
                // Update directly in Supabase
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/apps?slug=eq.${slug}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(updates)
                });
                if (!response.ok) throw new Error('Failed to update app');

                // Update local state
                const app = adminApps.find(a => a.slug === slug);
                if (app) Object.assign(app, updates);

                renderAdminApps();
                closeEditModal();
                showNotification('âœ…', 'Saved', `${updates.name} has been updated`);
            } catch (err) {
                console.error('Save failed:', err);
                showNotification('âš ï¸', 'Error', err.message);
            }
        });

        // Load admin apps when admin dashboard becomes visible
        const adminDashboard = document.getElementById('adminDashboard');
        if (adminDashboard) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (adminDashboard.style.display !== 'none') {
                            loadAllAppsAdmin();
                        }
                    }
                });
            });
            observer.observe(adminDashboard, { attributes: true });
        }
    </script>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- DEPOSIT OPTIONS MODAL - Initial Popup -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="depositOptionsModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 10001; align-items: center; justify-content: center; backdrop-filter: blur(10px);">
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 24px; padding: 32px; max-width: 440px; width: 90%; border: 2px solid rgba(34, 197, 94, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px;">
                <div>
                    <div style="font-size: 1.4rem; font-weight: 800; color: #ffffff;">Get Credits</div>
                    <div style="font-size: 0.85rem; color: #9ca3af;">Choose how you'd like to add credits</div>
                </div>
                <button onclick="closeDepositOptionsModal()" style="background: none; border: none; color: #9ca3af; font-size: 1.8rem; cursor: pointer; padding: 4px; line-height: 1;">&times;</button>
            </div>

            <!-- Option Cards -->
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <!-- Fiat Option -->
                <div onclick="selectDepositOption('fiat')" style="background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s ease;"
                    onmouseover="this.style.borderColor='#3b82f6'; this.style.transform='translateX(4px)';"
                    onmouseout="this.style.borderColor='rgba(59, 130, 246, 0.3)'; this.style.transform='translateX(0)';">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">ðŸ’³</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 800; color: #ffffff; font-size: 1.1rem; margin-bottom: 2px;">Pay with Card</div>
                            <div style="font-size: 0.8rem; color: #9ca3af;">Instant credits via Stripe checkout</div>
                        </div>
                        <div style="color: #3b82f6; font-size: 1.2rem;">â†’</div>
                    </div>
                </div>

                <!-- Crypto Direct Option -->
                <div onclick="selectDepositOption('crypto')" style="background: rgba(255, 149, 0, 0.1); border: 2px solid rgba(255, 149, 0, 0.3); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s ease;"
                    onmouseover="this.style.borderColor='#ff9500'; this.style.transform='translateX(4px)';"
                    onmouseout="this.style.borderColor='rgba(255, 149, 0, 0.3)'; this.style.transform='translateX(0)';">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #ff9500, #f97316); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">ðŸ’°</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 800; color: #ffffff; font-size: 1.1rem; margin-bottom: 2px;">Crypto Direct</div>
                            <div style="font-size: 0.8rem; color: #9ca3af;">Swap USDC for credits instantly</div>
                        </div>
                        <div style="color: #ff9500; font-size: 1.2rem;">â†’</div>
                    </div>
                </div>

                <!-- Crypto Yield Option -->
                <div onclick="selectDepositOption('yield')" style="background: rgba(34, 197, 94, 0.1); border: 2px solid rgba(34, 197, 94, 0.3); border-radius: 16px; padding: 20px; cursor: pointer; transition: all 0.2s ease;"
                    onmouseover="this.style.borderColor='#22c55e'; this.style.transform='translateX(4px)';"
                    onmouseout="this.style.borderColor='rgba(34, 197, 94, 0.3)'; this.style.transform='translateX(0)';">
                    <div style="display: flex; align-items: center; gap: 16px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #22c55e, #10b981); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; flex-shrink: 0;">ðŸ“ˆ</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 800; color: #ffffff; font-size: 1.1rem; margin-bottom: 2px;">Deposit & Earn Yield</div>
                            <div style="font-size: 0.8rem; color: #9ca3af;">Get credits + earn ~42% APY on deposit</div>
                        </div>
                        <div style="color: #22c55e; font-size: 1.2rem;">â†’</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- GET CREDITS MODAL - Detailed Options -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="depositModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 24px; padding: 32px; max-width: 520px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid rgba(34, 197, 94, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <button onclick="backToDepositOptions()" style="background: rgba(255,255,255,0.1); border: none; color: #9ca3af; font-size: 1.2rem; cursor: pointer; padding: 8px 12px; border-radius: 8px;">â†</button>
                    <div>
                        <div id="depositModalTitle" style="font-size: 1.3rem; font-weight: 800; color: #ffffff;">Get SUITE Credits</div>
                        <div id="depositModalSubtitle" style="font-size: 0.85rem; color: #9ca3af;">Choose how to fund your account</div>
                    </div>
                </div>
                <button onclick="closeDepositModal()" style="background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 4px;">&times;</button>
            </div>

            <!-- â•â•â• FIAT DIRECT TAB â•â•â• -->
            <div id="depositTabFiat" style="display: block;">
                <div style="text-align: center; padding: 20px; background: rgba(59, 130, 246, 0.1); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 16px; margin-bottom: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">ðŸ’³</div>
                    <div style="font-weight: 700; color: #ffffff; font-size: 1.1rem; margin-bottom: 4px;">Pay with Card</div>
                    <div style="font-size: 0.85rem; color: #9ca3af;">Instant credits via Stripe</div>
                </div>

                <!-- Amount Input -->
                <div style="margin-bottom: 20px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Amount (USD)</div>
                    <div style="position: relative;">
                        <span style="position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 1.4rem; font-weight: 700; color: #9ca3af;">$</span>
                        <input type="number" id="fiatDepositAmount" placeholder="10.00" min="1" step="1"
                            style="width: 100%; padding: 16px 16px 16px 40px; font-size: 1.4rem; font-weight: 700; background: rgba(0,0,0,0.4); border: 2px solid rgba(59, 130, 246, 0.3); border-radius: 12px; color: #ffffff; outline: none;"
                            oninput="updateFiatCreditsPreview()">
                    </div>
                </div>

                <!-- Quick Amount Buttons -->
                <div style="display: flex; gap: 8px; margin-bottom: 20px;">
                    <button onclick="setFiatAmount(5)" style="flex: 1; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: #3b82f6; font-weight: 700; font-size: 0.85rem; cursor: pointer;">$5</button>
                    <button onclick="setFiatAmount(10)" style="flex: 1; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: #3b82f6; font-weight: 700; font-size: 0.85rem; cursor: pointer;">$10</button>
                    <button onclick="setFiatAmount(25)" style="flex: 1; padding: 10px; background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 10px; color: #3b82f6; font-weight: 700; font-size: 0.85rem; cursor: pointer;">$25</button>
                    <button onclick="setFiatAmount(100)" style="flex: 1; padding: 10px; background: rgba(59, 130, 246, 0.15); border: 1px solid rgba(59, 130, 246, 0.4); border-radius: 10px; color: #3b82f6; font-weight: 700; font-size: 0.85rem; cursor: pointer;">$100</button>
                </div>

                <!-- Credits Preview -->
                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9ca3af; font-size: 0.9rem;">You'll receive:</span>
                        <span id="fiatCreditsPreview" style="font-weight: 800; color: #22c55e; font-size: 1.3rem;">0 SUITE</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 4px;">$1 USD = 1,000 SUITE credits</div>
                </div>

                <button onclick="processFiatDeposit()"
                    style="width: 100%; padding: 18px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 14px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
                    Pay with Card
                </button>
            </div>

            <!-- â•â•â• CRYPTO DIRECT TAB â•â•â• -->
            <div id="depositTabCrypto" style="display: none;">
                <div style="text-align: center; padding: 20px; background: rgba(255, 149, 0, 0.1); border: 2px solid rgba(255, 149, 0, 0.3); border-radius: 16px; margin-bottom: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">ðŸ’°</div>
                    <div style="font-weight: 700; color: #ffffff; font-size: 1.1rem; margin-bottom: 4px;">Crypto Direct</div>
                    <div style="font-size: 0.85rem; color: #9ca3af;">Send USDC â†’ Get credits instantly</div>
                </div>

                <!-- USDC Balance -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 14px; margin-bottom: 16px;">
                    <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Your USDC Balance</div>
                    <div id="cryptoDirectBalance" style="font-size: 1.4rem; font-weight: 800; color: #22c55e;">$0.00</div>
                </div>

                <!-- Amount Input -->
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Amount (USDC)</div>
                    <div style="position: relative;">
                        <input type="number" id="cryptoDirectAmount" placeholder="0.00" min="1" step="0.01"
                            style="width: 100%; padding: 14px 70px 14px 16px; font-size: 1.2rem; font-weight: 700; background: rgba(0,0,0,0.4); border: 2px solid rgba(255, 149, 0, 0.3); border-radius: 12px; color: #ff9500; outline: none;"
                            oninput="updateCryptoDirectPreview()">
                        <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; font-weight: 700; color: #9ca3af;">USDC</span>
                    </div>
                </div>

                <!-- Slider -->
                <div style="padding: 0 4px; margin-bottom: 16px;">
                    <input type="range" id="cryptoDirectSlider" min="0" max="100" value="0"
                        style="width: 100%; accent-color: #ff9500; cursor: pointer;"
                        oninput="updateCryptoDirectFromSlider(this.value)">
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button onclick="setCryptoDirectPercent(25)" style="flex: 1; padding: 8px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 8px; color: #ff9500; font-weight: 700; font-size: 0.75rem; cursor: pointer;">25%</button>
                        <button onclick="setCryptoDirectPercent(50)" style="flex: 1; padding: 8px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 8px; color: #ff9500; font-weight: 700; font-size: 0.75rem; cursor: pointer;">50%</button>
                        <button onclick="setCryptoDirectPercent(75)" style="flex: 1; padding: 8px; background: rgba(255, 149, 0, 0.1); border: 1px solid rgba(255, 149, 0, 0.3); border-radius: 8px; color: #ff9500; font-weight: 700; font-size: 0.75rem; cursor: pointer;">75%</button>
                        <button onclick="setCryptoDirectPercent(100)" style="flex: 1; padding: 8px; background: rgba(255, 149, 0, 0.2); border: 1px solid rgba(255, 149, 0, 0.4); border-radius: 8px; color: #ff9500; font-weight: 700; font-size: 0.75rem; cursor: pointer;">MAX</button>
                    </div>
                </div>

                <!-- Credits Preview -->
                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9ca3af; font-size: 0.9rem;">You'll receive:</span>
                        <span id="cryptoDirectCreditsPreview" style="font-weight: 800; color: #22c55e; font-size: 1.3rem;">0 SUITE</span>
                    </div>
                </div>

                <button onclick="processCryptoDirectDeposit()"
                    style="width: 100%; padding: 18px; background: linear-gradient(135deg, #ff9500, #f97316); color: white; border: none; border-radius: 14px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
                    Send USDC & Get Credits
                </button>
            </div>

            <!-- â•â•â• CRYPTO YIELD TAB â•â•â• -->
            <div id="depositTabYield" style="display: none;">
                <div style="text-align: center; padding: 20px; background: rgba(168, 85, 247, 0.1); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 16px; margin-bottom: 20px;">
                    <div style="font-size: 2rem; margin-bottom: 8px;">ðŸ“ˆ</div>
                    <div style="font-weight: 700; color: #ffffff; font-size: 1.1rem; margin-bottom: 4px;">Crypto + Yield</div>
                    <div style="font-size: 0.85rem; color: #9ca3af;">Deposit USDC â†’ Credits + Earn ~42% APY</div>
                </div>

                <!-- How it works -->
                <div style="background: rgba(168, 85, 247, 0.08); border-radius: 12px; padding: 14px; margin-bottom: 16px; font-size: 0.8rem; color: #c4b5fd;">
                    <div style="font-weight: 700; color: #a855f7; margin-bottom: 6px;">How it works:</div>
                    <div>1. Deposit USDC â†’ Receive credits equal to deposit</div>
                    <div>2. Your USDC earns yield in the treasury</div>
                    <div>3. Yield is converted to additional credits over time</div>
                </div>

                <!-- USDC Balance -->
                <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 14px; margin-bottom: 16px;">
                    <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Your USDC Balance</div>
                    <div id="modalUsdcBalance" style="font-size: 1.4rem; font-weight: 800; color: #22c55e;">$0.00</div>
                </div>

                <!-- Amount Input -->
                <div style="margin-bottom: 16px;">
                    <div style="font-size: 0.85rem; font-weight: 600; color: #ffffff; margin-bottom: 8px;">Deposit Amount (USDC)</div>
                    <div style="position: relative;">
                        <input type="number" id="modalDepositAmount" placeholder="0.00" min="1" step="0.01"
                            style="width: 100%; padding: 14px 70px 14px 16px; font-size: 1.2rem; font-weight: 700; background: rgba(0,0,0,0.4); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 12px; color: #a855f7; outline: none;"
                            oninput="updateYieldDepositPreview()">
                        <span style="position: absolute; right: 16px; top: 50%; transform: translateY(-50%); font-size: 0.9rem; font-weight: 700; color: #9ca3af;">USDC</span>
                    </div>
                </div>

                <!-- Slider -->
                <div style="padding: 0 4px; margin-bottom: 16px;">
                    <input type="range" id="depositAmountSlider" min="0" max="100" value="0"
                        style="width: 100%; accent-color: #a855f7; cursor: pointer;"
                        oninput="updateModalDepositFromSlider(this.value)">
                    <div style="display: flex; gap: 6px; margin-top: 8px;">
                        <button onclick="setModalDepositPercent(25)" style="flex: 1; padding: 8px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; color: #a855f7; font-weight: 700; font-size: 0.75rem; cursor: pointer;">25%</button>
                        <button onclick="setModalDepositPercent(50)" style="flex: 1; padding: 8px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; color: #a855f7; font-weight: 700; font-size: 0.75rem; cursor: pointer;">50%</button>
                        <button onclick="setModalDepositPercent(75)" style="flex: 1; padding: 8px; background: rgba(168, 85, 247, 0.1); border: 1px solid rgba(168, 85, 247, 0.3); border-radius: 8px; color: #a855f7; font-weight: 700; font-size: 0.75rem; cursor: pointer;">75%</button>
                        <button onclick="setModalDepositPercent(100)" style="flex: 1; padding: 8px; background: rgba(168, 85, 247, 0.2); border: 1px solid rgba(168, 85, 247, 0.4); border-radius: 8px; color: #a855f7; font-weight: 700; font-size: 0.75rem; cursor: pointer;">MAX</button>
                    </div>
                </div>

                <!-- Yield Allocation -->
                <div style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(236, 72, 153, 0.1)); border: 2px solid rgba(168, 85, 247, 0.3); border-radius: 14px; padding: 16px; margin-bottom: 16px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <span style="font-weight: 700; color: #a855f7; font-size: 0.85rem;">âš¡ Yield Allocation</span>
                        <div style="text-align: right;">
                            <span style="font-weight: 800; color: #22c55e;" id="modalKeepPercent">90%</span>
                            <span style="color: #6b7280; margin: 0 2px;">/</span>
                            <span style="font-weight: 800; color: #a855f7;" id="modalFundPercent">10%</span>
                            <span style="font-size: 0.65rem; color: #6b7280; margin-left: 4px;">You/Apps</span>
                        </div>
                    </div>
                    <input type="range" id="modalYieldSlider" min="0" max="90" value="90"
                        style="width: 100%; accent-color: #a855f7; cursor: pointer;"
                        oninput="updateModalYieldSplit(this.value)">
                    <div style="display: flex; justify-content: space-between; margin-top: 4px; font-size: 0.65rem; color: #6b7280;">
                        <span>100% to apps</span>
                        <span>Keep 90%</span>
                    </div>
                </div>

                <!-- Summary -->
                <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <span style="color: #9ca3af; font-size: 0.85rem;">Instant credits:</span>
                        <span id="yieldInstantCredits" style="font-weight: 800; color: #22c55e; font-size: 1.1rem;">0 SUITE</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <span style="color: #9ca3af; font-size: 0.85rem;">Est. yearly yield:</span>
                        <span id="modalEstimatedYield" style="font-weight: 700; color: #a855f7;">+$0.00/year</span>
                    </div>
                    <div style="font-size: 0.7rem; color: #6b7280; margin-top: 8px; padding-top: 8px; border-top: 1px solid rgba(255,255,255,0.1);">
                        Yield is paid as additional credits to your account
                    </div>
                </div>

                <button onclick="confirmDeposit()"
                    style="width: 100%; padding: 18px; background: linear-gradient(135deg, #a855f7, #8b5cf6); color: white; border: none; border-radius: 14px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease;">
                    Deposit & Start Earning
                </button>
            </div>
        </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- WITHDRAW MODAL -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div id="withdrawModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(8px);">
        <div style="background: linear-gradient(135deg, #1a1a2e, #16213e); border-radius: 24px; padding: 32px; max-width: 480px; width: 90%; max-height: 90vh; overflow-y: auto; border: 2px solid rgba(239, 68, 68, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
            <!-- Header -->
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                <div style="display: flex; align-items: center; gap: 12px;">
                    <img src="/assets/usdc-logo.png" alt="USDC" style="width: 40px; height: 40px;">
                    <div>
                        <div style="font-size: 1.3rem; font-weight: 800; color: #ffffff;">Withdraw USDC</div>
                        <div style="font-size: 0.85rem; color: #9ca3af;">from AI Fleet Vault</div>
                    </div>
                </div>
                <button onclick="closeWithdrawModal()" style="background: none; border: none; color: #9ca3af; font-size: 1.5rem; cursor: pointer; padding: 4px;">&times;</button>
            </div>

            <!-- Position Summary -->
            <div style="background: rgba(255,255,255,0.05); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div>
                        <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Vault Share</div>
                        <div id="modalVaultShare" style="font-size: 1.2rem; font-weight: 800; color: #ffffff;">$0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Credits Used</div>
                        <div id="modalCreditsUsed" style="font-size: 1.2rem; font-weight: 800; color: #f97316;">-$0.00</div>
                    </div>
                </div>
                <div style="border-top: 1px solid rgba(255,255,255,0.1); margin-top: 12px; padding-top: 12px;">
                    <div style="font-size: 0.7rem; color: #22c55e; text-transform: uppercase;">Available to Withdraw</div>
                    <div id="modalAvailableWithdraw" style="font-size: 1.6rem; font-weight: 800; color: #22c55e;">$0.00</div>
                </div>
            </div>

            <!-- Amount Selection -->
            <div style="margin-bottom: 24px;">
                <div style="font-size: 0.85rem; font-weight: 600; color: #ffffff; margin-bottom: 12px;">Withdraw Amount</div>

                <!-- Amount Display -->
                <div style="position: relative; margin-bottom: 16px;">
                    <input type="text" id="modalWithdrawAmount" value="0.00"
                        style="width: 100%; padding: 16px 80px 16px 24px; font-size: 1.8rem; font-weight: 800; text-align: center; background: rgba(0,0,0,0.4); border: 2px solid rgba(239, 68, 68, 0.3); border-radius: 16px; color: #ef4444; outline: none;"
                        oninput="updateWithdrawFromInput(this.value)">
                    <span style="position: absolute; right: 20px; top: 50%; transform: translateY(-50%); font-size: 1rem; font-weight: 700; color: #9ca3af;">USDC</span>
                </div>

                <!-- Percent Slider -->
                <div style="padding: 0 8px; margin-bottom: 12px;">
                    <input type="range" id="withdrawAmountSlider" min="0" max="100" value="0"
                        style="width: 100%; accent-color: #ef4444; cursor: pointer;"
                        oninput="updateWithdrawFromSlider(this.value)">
                    <div style="display: flex; justify-content: space-between; font-size: 0.7rem; color: #6b7280; margin-top: 4px;">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                        <span>75%</span>
                        <span>100%</span>
                    </div>
                </div>

                <!-- Preset Buttons -->
                <div style="display: flex; gap: 8px;">
                    <button onclick="setWithdrawPercent(25)" style="flex: 1; padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: #ef4444; font-weight: 700; font-size: 0.85rem; cursor: pointer;">25%</button>
                    <button onclick="setWithdrawPercent(50)" style="flex: 1; padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: #ef4444; font-weight: 700; font-size: 0.85rem; cursor: pointer;">50%</button>
                    <button onclick="setWithdrawPercent(75)" style="flex: 1; padding: 10px; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 10px; color: #ef4444; font-weight: 700; font-size: 0.85rem; cursor: pointer;">75%</button>
                    <button onclick="setWithdrawPercent(100)" style="flex: 1; padding: 10px; background: linear-gradient(135deg, #ef4444, #dc2626); border: none; border-radius: 10px; color: white; font-weight: 700; font-size: 0.85rem; cursor: pointer;">MAX</button>
                </div>
            </div>

            <!-- Info Notice -->
            <div style="background: rgba(34, 197, 94, 0.1); border: 1px solid rgba(34, 197, 94, 0.3); border-radius: 12px; padding: 14px; margin-bottom: 20px;">
                <div style="display: flex; gap: 10px; align-items: flex-start;">
                    <span style="font-size: 1.2rem;">âš¡</span>
                    <div style="font-size: 0.8rem; color: #22c55e; line-height: 1.5;">
                        Instant withdrawals when funds are available. If funds are deployed to yield strategies, a withdrawal request will be created.
                    </div>
                </div>
            </div>

            <!-- Confirm Button -->
            <button id="confirmWithdrawBtn" onclick="confirmWithdraw()"
                style="width: 100%; padding: 18px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 14px; font-weight: 800; font-size: 1.1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 20px rgba(34, 197, 94, 0.3);"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 30px rgba(34, 197, 94, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 20px rgba(34, 197, 94, 0.3)';">
                Withdraw Instantly
            </button>
        </div>
    </div>

    <script>
        // ========== DEPOSIT/WITHDRAW MODAL FUNCTIONS ==========
        let userUsdcBalance = 0;
        let userAvailableWithdraw = 0;
        let userVaultShare = 0;
        let userCreditsUsedAmount = 0;
        let currentDepositTab = 'fiat';

        // Tab switching
        function switchDepositTab(tab) {
            currentDepositTab = tab;

            // Hide all tabs
            document.getElementById('depositTabFiat').style.display = 'none';
            document.getElementById('depositTabCrypto').style.display = 'none';
            document.getElementById('depositTabYield').style.display = 'none';

            // Reset tab button styles
            document.getElementById('tabFiat').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('tabFiat').style.color = '#9ca3af';
            document.getElementById('tabCryptoDirect').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('tabCryptoDirect').style.color = '#9ca3af';
            document.getElementById('tabCryptoYield').style.background = 'rgba(255,255,255,0.05)';
            document.getElementById('tabCryptoYield').style.color = '#9ca3af';

            // Show selected tab
            if (tab === 'fiat') {
                document.getElementById('depositTabFiat').style.display = 'block';
                document.getElementById('tabFiat').style.background = 'linear-gradient(135deg, #3b82f6, #2563eb)';
                document.getElementById('tabFiat').style.color = 'white';
            } else if (tab === 'crypto') {
                document.getElementById('depositTabCrypto').style.display = 'block';
                document.getElementById('tabCryptoDirect').style.background = 'linear-gradient(135deg, #ff9500, #f97316)';
                document.getElementById('tabCryptoDirect').style.color = 'white';
            } else if (tab === 'yield') {
                document.getElementById('depositTabYield').style.display = 'block';
                document.getElementById('tabCryptoYield').style.background = 'linear-gradient(135deg, #a855f7, #8b5cf6)';
                document.getElementById('tabCryptoYield').style.color = 'white';
            }
        }

        // Fiat tab functions
        function setFiatAmount(amount) {
            document.getElementById('fiatDepositAmount').value = amount;
            updateFiatCreditsPreview();
        }

        function updateFiatCreditsPreview() {
            const amount = parseFloat(document.getElementById('fiatDepositAmount')?.value) || 0;
            const credits = amount * 1000;
            document.getElementById('fiatCreditsPreview').textContent = credits.toLocaleString() + ' SUITE';
        }

        async function processFiatDeposit() {
            const amount = parseFloat(document.getElementById('fiatDepositAmount')?.value);
            if (!amount || amount < 1) {
                showNotification('âš ï¸', 'Error', 'Minimum amount is $1');
                return;
            }
            // TODO: Integrate Stripe payment
            showNotification('â„¹ï¸', 'Coming Soon', 'Card payments will be available soon via Stripe');
        }

        // Crypto Direct tab functions
        function updateCryptoDirectPreview() {
            const amount = parseFloat(document.getElementById('cryptoDirectAmount')?.value) || 0;
            const credits = amount * 1000;
            document.getElementById('cryptoDirectCreditsPreview').textContent = credits.toLocaleString() + ' SUITE';
            // Update slider
            const percent = userUsdcBalance > 0 ? Math.min(100, (amount / userUsdcBalance) * 100) : 0;
            document.getElementById('cryptoDirectSlider').value = percent;
        }

        function updateCryptoDirectFromSlider(percent) {
            const amount = (userUsdcBalance * percent / 100).toFixed(2);
            document.getElementById('cryptoDirectAmount').value = amount;
            updateCryptoDirectPreview();
        }

        function setCryptoDirectPercent(percent) {
            document.getElementById('cryptoDirectSlider').value = percent;
            updateCryptoDirectFromSlider(percent);
        }

        async function processCryptoDirectDeposit() {
            const amount = parseFloat(document.getElementById('cryptoDirectAmount')?.value);
            if (!amount || amount <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }
            if (amount > userUsdcBalance) {
                showNotification('âš ï¸', 'Error', `Insufficient balance. You have $${userUsdcBalance.toFixed(2)} USDC`);
                return;
            }

            closeDepositModal();

            // Execute USDC transfer to treasury and add credits
            document.getElementById('vaultDepositAmount').value = amount;
            await executeCryptoDirectDeposit(amount);
        }

        async function executeCryptoDirectDeposit(amount) {
            if (!window.ethereum) {
                showNotification('âš ï¸', 'Error', 'Please install MetaMask or another wallet');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const fromAddress = accounts[0];
                const amountUSDC = Math.floor(parseFloat(amount) * 1e6);

                // Check allowance and approve if needed
                showNotification('ðŸ¦', 'Processing', 'Checking USDC approval...');

                const allowanceData = '0xdd62ed3e' +
                    fromAddress.slice(2).padStart(64, '0') +
                    VAULT_TREASURY_ADDRESS.slice(2).padStart(64, '0');

                const allowanceHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: VAULT_USDC_ADDRESS, data: allowanceData }, 'latest']
                });
                const currentAllowance = parseInt(allowanceHex, 16);

                if (currentAllowance < amountUSDC) {
                    showNotification('ðŸ¦', 'Approving', 'Please approve USDC spending...');
                    const approveData = '0x095ea7b3' +
                        VAULT_TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                        amountUSDC.toString(16).padStart(64, '0'); // Approve exact amount only

                    const approveTx = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{ from: fromAddress, to: VAULT_USDC_ADDRESS, data: approveData }]
                    });
                    await waitForVaultTransaction(approveTx);
                }

                // Transfer USDC to treasury
                showNotification('ðŸ¦', 'Depositing', 'Please confirm the deposit...');
                const transferData = '0xa9059cbb' +
                    VAULT_TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                    amountUSDC.toString(16).padStart(64, '0');

                const transferTx = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{ from: fromAddress, to: VAULT_USDC_ADDRESS, data: transferData }]
                });
                await waitForVaultTransaction(transferTx);

                // Add credits directly (no LP tokens, just credits)
                const credits = amount * 1000;
                await fetch(`${VAULT_SUPABASE_URL}/rest/v1/rpc/add_suite_credits`, {
                    method: 'POST',
                    headers: {
                        'apikey': VAULT_SUPABASE_KEY,
                        'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        p_wallet: fromAddress.toLowerCase(),
                        p_amount: credits,
                        p_type: 'deposit',
                        p_description: `Crypto direct deposit: $${amount} USDC`
                    })
                });

                showNotification('âœ…', 'Success!', `Received ${credits.toLocaleString()} SUITE credits!`);

                // Refresh balances
                if (typeof fetchWalletBalances === 'function') {
                    await fetchWalletBalances(fromAddress);
                }
            } catch (error) {
                console.error('Crypto direct deposit error:', error);
                if (error.code === 4001) {
                    showNotification('âš ï¸', 'Cancelled', 'Transaction was rejected');
                } else {
                    showNotification('âŒ', 'Error', error.message || 'Deposit failed');
                }
            }
        }

        // Yield tab functions
        function updateYieldDepositPreview() {
            const amount = parseFloat(document.getElementById('modalDepositAmount')?.value) || 0;
            const credits = amount * 1000;
            document.getElementById('yieldInstantCredits').textContent = credits.toLocaleString() + ' SUITE';
            // Update slider
            const percent = userUsdcBalance > 0 ? Math.min(100, (amount / userUsdcBalance) * 100) : 0;
            document.getElementById('depositAmountSlider').value = percent;
            updateModalEstimatedYield();
        }

        async function openDepositModal() {
            const modal = document.getElementById('depositModal');
            if (!modal) return;

            modal.style.display = 'flex';
            switchDepositTab('fiat'); // Default to fiat tab

            // Fetch USDC balance for crypto tabs
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        const address = accounts[0];
                        const balanceData = '0x70a08231' + address.slice(2).padStart(64, '0');
                        const balanceHex = await window.ethereum.request({
                            method: 'eth_call',
                            params: [{ to: VAULT_USDC_ADDRESS, data: balanceData }, 'latest']
                        });
                        userUsdcBalance = parseInt(balanceHex, 16) / 1e6;

                        // Update all balance displays
                        const balanceText = '$' + userUsdcBalance.toFixed(2);
                        document.getElementById('modalUsdcBalance').textContent = balanceText;
                        document.getElementById('cryptoDirectBalance').textContent = balanceText;
                    }
                } catch (e) {
                    console.error('Failed to fetch USDC balance:', e);
                }
            }

            // Load yield preference for yield tab
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    const res = await fetch(
                        `${VAULT_SUPABASE_URL}/rest/v1/treasury_yield_preferences?wallet_address=eq.${accounts[0].toLowerCase()}&select=keep_percent`,
                        { headers: { 'apikey': VAULT_SUPABASE_KEY, 'Authorization': `Bearer ${VAULT_SUPABASE_KEY}` } }
                    );
                    const data = await res.json();
                    if (data && data.length > 0 && data[0].keep_percent !== undefined) {
                        document.getElementById('modalYieldSlider').value = data[0].keep_percent;
                        updateModalYieldSplit(data[0].keep_percent);
                    }
                }
            } catch (e) {
                console.error('Failed to load yield preference:', e);
            }

            // Reset amounts
            document.getElementById('fiatDepositAmount').value = '';
            document.getElementById('cryptoDirectAmount').value = '';
            document.getElementById('modalDepositAmount').value = '';
            document.getElementById('depositAmountSlider').value = 0;
            document.getElementById('cryptoDirectSlider').value = 0;
            updateFiatCreditsPreview();
            updateCryptoDirectPreview();
            updateYieldDepositPreview();
        }

        function closeDepositModal() {
            document.getElementById('depositModal').style.display = 'none';
        }

        // Deposit Options Modal Functions
        function openDepositOptionsModal() {
            document.getElementById('depositOptionsModal').style.display = 'flex';
        }

        function closeDepositOptionsModal() {
            document.getElementById('depositOptionsModal').style.display = 'none';
        }

        function selectDepositOption(option) {
            closeDepositOptionsModal();

            if (option === 'yield') {
                // Expand the vault deposit panel with yield tab
                const content = document.getElementById('depositExpandedContent');
                if (content) {
                    content.style.display = 'block';
                    switchDepositInlineTab('yield');
                }
            } else if (option === 'crypto') {
                // Expand the vault deposit panel with direct swap tab
                const content = document.getElementById('depositExpandedContent');
                if (content) {
                    content.style.display = 'block';
                    switchDepositInlineTab('direct');
                }
            } else {
                // Open the detailed modal for fiat
                const modal = document.getElementById('depositModal');
                modal.style.display = 'flex';

                // Show the fiat tab
                document.getElementById('depositTabFiat').style.display = 'block';
                document.getElementById('depositTabCrypto').style.display = 'none';
                if (document.getElementById('depositTabYield')) {
                    document.getElementById('depositTabYield').style.display = 'none';
                }

                // Update title
                document.getElementById('depositModalTitle').textContent = 'Pay with Card';
                document.getElementById('depositModalSubtitle').textContent = 'Instant credits via Stripe';
            }
        }

        function backToDepositOptions() {
            closeDepositModal();
            openDepositOptionsModal();
        }

        // ========== INLINE DEPOSIT TAB FUNCTIONS ==========
        function switchDepositInlineTab(tab) {
            const yieldTab = document.getElementById('depositYieldTab');
            const directTab = document.getElementById('depositDirectTab');
            const yieldBtn = document.getElementById('depositTabYieldBtn');
            const directBtn = document.getElementById('depositTabDirectBtn');

            if (tab === 'yield') {
                yieldTab.style.display = 'block';
                directTab.style.display = 'none';
                yieldBtn.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
                yieldBtn.style.color = 'white';
                directBtn.style.background = 'rgba(255,255,255,0.05)';
                directBtn.style.color = '#9ca3af';
            } else {
                yieldTab.style.display = 'none';
                directTab.style.display = 'block';
                yieldBtn.style.background = 'rgba(255,255,255,0.05)';
                yieldBtn.style.color = '#9ca3af';
                directBtn.style.background = 'linear-gradient(135deg, #ff9500, #f97316)';
                directBtn.style.color = 'white';
            }
        }

        // Direct Swap functions
        function updateDirectSwapPreview() {
            const amount = parseFloat(document.getElementById('directSwapAmountInput')?.value) || 0;
            const credits = amount * 1000;
            document.getElementById('directSwapCreditsPreview').textContent = credits.toLocaleString() + ' Credits';
            // Update slider
            const percent = userUsdcBalance > 0 ? Math.min(100, (amount / userUsdcBalance) * 100) : 0;
            document.getElementById('directSwapSlider').value = percent;
            document.getElementById('directSwapPercentDisplay').textContent = Math.round(percent) + '%';
        }

        function updateDirectSwapFromSlider(percent) {
            const amount = (userUsdcBalance * percent / 100).toFixed(2);
            document.getElementById('directSwapAmountInput').value = amount;
            document.getElementById('directSwapPercentDisplay').textContent = Math.round(percent) + '%';
            updateDirectSwapPreview();
        }

        function setMaxDirectSwap() {
            document.getElementById('directSwapSlider').value = 100;
            updateDirectSwapFromSlider(100);
        }

        async function executeDirectSwap() {
            const amount = parseFloat(document.getElementById('directSwapAmountInput')?.value);
            if (!amount || amount <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }
            if (amount > userUsdcBalance) {
                showNotification('âš ï¸', 'Error', `Insufficient balance. You have $${userUsdcBalance.toFixed(2)} USDC`);
                return;
            }

            // Use the same crypto direct deposit logic
            document.getElementById('vaultDepositAmount').value = amount;
            await executeCryptoDirectDeposit(amount);
        }

        async function openWithdrawModal() {
            const modal = document.getElementById('withdrawModal');
            if (!modal) return;

            modal.style.display = 'flex';

            // Fetch withdrawable amount
            if (window.ethereum) {
                try {
                    const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                    if (accounts.length > 0) {
                        const withdrawable = await calculateUserWithdrawable(accounts[0]);
                        userVaultShare = withdrawable.vaultShare;
                        userCreditsUsedAmount = withdrawable.creditsUsed;
                        userAvailableWithdraw = withdrawable.available;

                        document.getElementById('modalVaultShare').textContent = '$' + userVaultShare.toFixed(2);
                        document.getElementById('modalCreditsUsed').textContent = '-$' + userCreditsUsedAmount.toFixed(2);
                        document.getElementById('modalAvailableWithdraw').textContent = '$' + userAvailableWithdraw.toFixed(2);
                    }
                } catch (e) {
                    console.error('Failed to fetch withdrawable:', e);
                }
            }

            // Reset amount
            document.getElementById('modalWithdrawAmount').value = '0.00';
            document.getElementById('withdrawAmountSlider').value = 0;
        }

        function closeWithdrawModal() {
            document.getElementById('withdrawModal').style.display = 'none';
        }

        function updateModalDepositFromSlider(percent) {
            const amount = (userUsdcBalance * percent / 100).toFixed(2);
            document.getElementById('modalDepositAmount').value = amount;
            updateYieldDepositPreview();
        }

        function setModalDepositPercent(percent) {
            document.getElementById('depositAmountSlider').value = percent;
            updateModalDepositFromSlider(percent);
        }

        function updateWithdrawFromSlider(percent) {
            const amount = (userAvailableWithdraw * percent / 100).toFixed(2);
            document.getElementById('modalWithdrawAmount').value = amount;
        }

        function updateWithdrawFromInput(value) {
            const amount = parseFloat(value) || 0;
            const percent = userAvailableWithdraw > 0 ? Math.min(100, (amount / userAvailableWithdraw) * 100) : 0;
            document.getElementById('withdrawAmountSlider').value = percent;
        }

        function setWithdrawPercent(percent) {
            document.getElementById('withdrawAmountSlider').value = percent;
            updateWithdrawFromSlider(percent);
        }

        function updateModalYieldSplit(keepPercent) {
            const fundPercent = 100 - keepPercent;
            document.getElementById('modalKeepPercent').textContent = keepPercent + '%';
            document.getElementById('modalFundPercent').textContent = fundPercent + '%';
            updateModalEstimatedYield();
        }

        function updateModalEstimatedYield() {
            const amount = parseFloat(document.getElementById('modalDepositAmount')?.value) || 0;
            const keepPercent = parseInt(document.getElementById('modalYieldSlider')?.value) || 90;
            // Assuming ~42% combined APY
            const yearlyYield = amount * 0.42 * (keepPercent / 100);
            document.getElementById('modalEstimatedYield').textContent = '+$' + yearlyYield.toFixed(2) + '/year';
        }

        async function confirmDeposit() {
            const amount = parseFloat(document.getElementById('modalDepositAmount')?.value);
            const keepPercent = parseInt(document.getElementById('modalYieldSlider')?.value) || 90;

            if (!amount || amount <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }

            if (amount > userUsdcBalance) {
                showNotification('âš ï¸', 'Error', `Insufficient balance. You have $${userUsdcBalance.toFixed(2)} USDC`);
                return;
            }

            // Close modal first
            closeDepositModal();

            // Save yield preference
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    const wallet = accounts[0].toLowerCase();
                    await fetch(`${VAULT_SUPABASE_URL}/rest/v1/treasury_yield_preferences`, {
                        method: 'POST',
                        headers: {
                            'apikey': VAULT_SUPABASE_KEY,
                            'Authorization': `Bearer ${VAULT_SUPABASE_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'resolution=merge-duplicates'
                        },
                        body: JSON.stringify({
                            wallet_address: wallet,
                            keep_percent: keepPercent
                        })
                    });

                    // Also update the main yield split display
                    if (document.getElementById('yieldSplitSlider')) {
                        document.getElementById('yieldSplitSlider').value = keepPercent;
                        updateYieldSplit(keepPercent);
                    }
                }
            } catch (e) {
                console.error('Failed to save yield preference:', e);
            }

            // Set the amount in the hidden input and execute deposit
            document.getElementById('vaultDepositAmount').value = amount;
            await executeVaultDeposit();
        }

        async function confirmWithdraw() {
            const amount = parseFloat(document.getElementById('modalWithdrawAmount')?.value);

            if (!amount || amount <= 0) {
                showNotification('âš ï¸', 'Error', 'Please enter an amount');
                return;
            }

            if (amount > userAvailableWithdraw) {
                showNotification('âš ï¸', 'Error', `Maximum withdrawable: $${userAvailableWithdraw.toFixed(2)}`);
                return;
            }

            // Close modal
            closeWithdrawModal();

            // Set the amount and execute withdrawal
            document.getElementById('vaultWithdrawAmount').value = amount;
            await executeVaultWithdraw();
        }

        // Close modals when clicking outside
        document.getElementById('depositModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeDepositModal();
        });
        document.getElementById('withdrawModal')?.addEventListener('click', function(e) {
            if (e.target === this) closeWithdrawModal();
        });
    </script>
</body>

</html>