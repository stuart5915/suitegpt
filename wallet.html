<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Vault | SUITE</title>
    <link rel="icon" type="image/png" href="assets/suite-logo-new.png">
    <meta name="description"
        content="Your SUITE Vault - deposit, withdraw, earn with Community Arbitrage, and view Treasury stats.">
    <!-- Ethers.js for blockchain interactions -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="suite-styles.css">
    <link rel="stylesheet" href="nav.css">
    <style>
        /* ============================================
           BUBBLY WALLET PAGE - PancakeSwap Vibes
           ============================================ */

        :root {
            --gradient-warm: linear-gradient(135deg, #fff5eb 0%, #ffe4d4 20%, #ffd4e3 50%, #e8d5f9 80%, #d4e5ff 100%);
            --accent-orange: #ff9500;
            --accent-pink: #ff6b9d;
            --accent-purple: #a855f7;
            --text-dark: #2d1b4e;
            --text-medium: #5a4a6f;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.12);
            --radius-xl: 28px;
            --radius-lg: 20px;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--gradient-warm);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Animated background blobs */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        .blob-1 {
            width: 500px;
            height: 500px;
            background: #ffb3d9;
            top: -100px;
            left: -100px;
        }

        .blob-2 {
            width: 400px;
            height: 400px;
            background: #b3d4ff;
            top: 50%;
            right: -100px;
            animation-delay: -5s;
        }

        .blob-3 {
            width: 350px;
            height: 350px;
            background: #ffe0b3;
            bottom: -50px;
            left: 30%;
            animation-delay: -10s;
        }

        @keyframes float {

            0%,
            100% {
                transform: translate(0, 0) scale(1);
            }

            33% {
                transform: translate(30px, -30px) scale(1.05);
            }

            66% {
                transform: translate(-20px, 20px) scale(0.95);
            }
        }

        @keyframes float-reverse {

            0%,
            100% {
                transform: scaleX(-1) translate(0, 0);
            }

            33% {
                transform: scaleX(-1) translate(-30px, 30px);
            }

            66% {
                transform: scaleX(-1) translate(20px, -20px);
            }
        }

        /* Ensure CTA button stays white */
        .nav-links a.nav-cta,
        .nav-links a.nav-cta:hover,
        .nav-links a.nav-cta:active {
            color: #ffffff !important;
        }

        /* Wallet Page Container */
        .wallet-page {
            padding-top: 100px;
            min-height: 100vh;
            position: relative;
        }

        .wallet-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px 24px 16px;
        }

        /* Hero Header with Gradient Title */
        .wallet-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .wallet-header h1 {
            font-size: 2rem;
            font-weight: 900;
            font-style: italic;
            background: linear-gradient(135deg, #ff9500 0%, #ff6b9d 50%, #ff9a8b 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            animation: bounce-in 0.6s ease;
        }

        @keyframes bounce-in {
            0% {
                opacity: 0;
                transform: translateY(-20px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .wallet-address {
            display: flex;
            align-items: center;
            gap: 10px;
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            padding: 12px 20px;
            border-radius: 100px;
            font-family: monospace;
            font-size: 0.9rem;
            box-shadow: var(--shadow-soft);
        }

        .wallet-address .dot {
            width: 10px;
            height: 10px;
            background: #22c55e;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                transform: scale(1);
                opacity: 1;
            }

            50% {
                transform: scale(0.85);
                opacity: 0.7;
            }
        }

        .disconnect-btn {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-medium);
            padding: 10px 20px;
            border-radius: 100px;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .disconnect-btn:hover {
            border-color: #ef4444;
            color: #ef4444;
            transform: translateY(-2px);
        }

        .connect-btn-inline {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            border: none;
            color: white;
            padding: 14px 28px;
            border-radius: 100px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 24px rgba(255, 149, 0, 0.3);
        }

        .connect-btn-inline:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 16px 40px rgba(255, 149, 0, 0.4);
        }

        /* Main Content Wrapper - Unified Container */
        .wallet-main-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: var(--radius-lg);
            padding: 20px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 20px;
        }

        /* UX Notice - Subtle inside wrapper */
        .ux-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px 16px;
            background: rgba(255, 149, 0, 0.06);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .ux-notice-icon {
            font-size: 1.4rem;
            animation: bounce 2s ease-in-out infinite;
        }

        @keyframes bounce {

            0%,
            100% {
                transform: translateY(0);
            }

            50% {
                transform: translateY(-6px);
            }
        }

        .ux-notice-text {
            font-size: 0.85rem;
            color: var(--text-medium);
            line-height: 1.5;
        }

        .ux-notice-text strong {
            color: var(--accent-orange);
            font-weight: 700;
        }

        /* Glassmorphism Balance Cards */
        .balance-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }

        .balance-card {
            padding: 14px 12px;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .balance-card:hover {
            transform: translateY(-4px);
        }

        .balance-card.primary {
            background: linear-gradient(135deg, rgba(255, 149, 0, 0.1), rgba(255, 107, 157, 0.08));
            border-radius: var(--radius-lg);
        }

        .balance-label {
            font-size: 0.7rem;
            color: var(--text-medium);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .balance-value {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--text-dark), var(--accent-purple));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .balance-sub {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 4px;
            font-weight: 600;
        }

        /* Add to Wallet Button */
        .add-to-wallet-btn {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-medium);
            padding: 12px 24px;
            border-radius: 100px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--shadow-soft);
        }

        .add-to-wallet-btn:hover {
            border-color: var(--accent-orange);
            color: var(--accent-orange);
            background: rgba(255, 149, 0, 0.1);
            transform: translateY(-2px);
        }

        /* Treasury Stats - Glassmorphism */
        .treasury-stats {
            display: flex;
            gap: 10px;
            margin-bottom: 16px;
            flex-wrap: wrap;
        }

        .treasury-stat {
            flex: 1;
            min-width: 160px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 14px;
            background: rgba(34, 197, 94, 0.06);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .treasury-stat:hover {
            background: rgba(34, 197, 94, 0.1);
        }

        .treasury-label {
            font-size: 0.75rem;
            color: var(--text-medium);
            font-weight: 600;
        }

        .treasury-value {
            font-size: 1rem;
            font-weight: 800;
            color: #22c55e;
        }

        .treasury-value-stacked {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 2px;
        }

        .treasury-usd {
            font-size: 1.1rem;
            font-weight: 800;
            color: #22c55e;
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        .treasury-eth {
            font-size: 0.75rem;
            font-weight: 500;
            color: var(--text-medium);
            font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
        }

        /* Admin Panel - Keep functional but style-update */
        .admin-panel {
            border: 2px solid #ef4444 !important;
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(239, 68, 68, 0.02)) !important;
        }

        .admin-notice {
            color: #ef4444;
            font-size: 0.9rem;
            margin-bottom: 16px;
            font-weight: 600;
        }

        .admin-stats {
            display: flex;
            gap: 16px;
            margin-bottom: 20px;
        }

        .admin-stat {
            flex: 1;
            background: rgba(239, 68, 68, 0.1);
            padding: 14px 18px;
            border-radius: var(--radius-lg);
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .admin-label {
            font-size: 0.8rem;
            color: var(--text-medium);
        }

        .admin-value {
            font-size: 1.2rem;
            font-weight: 800;
            color: #ef4444;
            font-family: 'SF Mono', monospace;
        }

        .admin-actions {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
        }

        .admin-btn {
            flex: 1;
            padding: 14px 18px;
            border-radius: 100px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            border: none;
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: white;
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.25);
        }

        .admin-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 30px rgba(34, 197, 94, 0.35);
        }

        .admin-btn.danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            box-shadow: 0 6px 20px rgba(239, 68, 68, 0.25);
        }

        .admin-btn.danger:hover {
            box-shadow: 0 10px 30px rgba(239, 68, 68, 0.35);
        }

        .admin-btn.secondary {
            background: var(--card-bg);
            color: var(--text-dark);
            border: 1px solid rgba(0, 0, 0, 0.08);
            box-shadow: var(--shadow-soft);
        }

        .admin-ownership {
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            padding-top: 18px;
        }

        .admin-ownership h4 {
            margin-bottom: 12px;
            color: var(--text-medium);
            font-size: 0.9rem;
            font-weight: 700;
        }

        .admin-input {
            width: 100%;
            padding: 14px 18px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            border-radius: 100px;
            background: var(--card-bg);
            color: var(--text-dark);
            margin-bottom: 12px;
            font-family: 'SF Mono', monospace;
            font-size: 0.85rem;
        }

        .admin-input:focus {
            outline: none;
            border-color: var(--accent-orange);
            box-shadow: 0 0 0 3px rgba(255, 149, 0, 0.1);
        }

        /* Action Buttons - Bouncy */
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .action-btn {
            flex: 1;
            min-width: 120px;
            padding: 12px 20px;
            border-radius: 100px;
            font-size: 0.95rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .action-btn.deposit {
            background: linear-gradient(135deg, #22c55e, #10b981);
            border: none;
            color: white;
            box-shadow: 0 8px 28px rgba(34, 197, 94, 0.3);
        }

        .action-btn.deposit:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 14px 40px rgba(34, 197, 94, 0.4);
        }

        .action-btn.withdraw {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(0, 0, 0, 0.08);
            color: var(--text-dark);
            box-shadow: var(--shadow-soft);
        }

        .action-btn.withdraw:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-hover);
        }

        .action-btn.stake {
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), rgba(168, 85, 247, 0.05));
            border: 2px solid rgba(168, 85, 247, 0.3);
            color: var(--accent-purple);
        }

        .action-btn.stake:hover {
            transform: translateY(-4px);
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.15), rgba(168, 85, 247, 0.08));
            box-shadow: 0 10px 30px rgba(168, 85, 247, 0.2);
        }

        /* Sections - Glassmorphism */
        .wallet-section {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: var(--radius-lg);
            padding: 18px;
            margin-bottom: 16px;
            box-shadow: var(--shadow-soft);
            position: relative;
            z-index: 10;
        }

        .wallet-section h3 {
            font-size: 1rem;
            font-weight: 800;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-dark);
        }

        /* Transaction History */
        .tx-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .tx-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .tx-info {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .tx-action {
            font-weight: 500;
        }

        .tx-date {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .tx-amount {
            font-weight: 600;
        }

        .tx-amount.positive {
            color: #22c55e;
        }

        .tx-amount.negative {
            color: #ef4444;
        }

        /* Voting Section */
        .vote-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .vote-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: var(--bg-tertiary);
            border: 1px solid transparent;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .vote-option:hover {
            border-color: var(--accent-primary);
        }

        .vote-option input {
            display: none;
        }

        .vote-radio {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 50%;
            position: relative;
        }

        .vote-option input:checked+.vote-radio {
            border-color: var(--accent-primary);
        }

        .vote-option input:checked+.vote-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: var(--accent-primary);
            border-radius: 50%;
        }

        .vote-label {
            flex: 1;
        }

        .vote-count {
            font-size: 0.85rem;
            color: var(--text-tertiary);
        }

        .vote-btn {
            width: 100%;
            margin-top: 16px;
            padding: 14px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            cursor: pointer;
        }

        /* Connected Apps */
        .apps-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }

        .app-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 14px;
            background: var(--bg-tertiary);
            border-radius: 10px;
        }

        .app-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.2), rgba(236, 72, 153, 0.1));
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .app-name {
            font-weight: 500;
        }

        .app-status {
            font-size: 0.75rem;
            color: #22c55e;
        }

        /* UX Notice */
        .ux-notice {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: linear-gradient(135deg, rgba(34, 211, 238, 0.1), rgba(168, 85, 247, 0.05));
            border: 1px solid rgba(34, 211, 238, 0.3);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .ux-notice-icon {
            font-size: 1.5rem;
        }

        .ux-notice-text {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.5;
        }

        .ux-notice-text strong {
            color: #22d3ee;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(4px);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }

        .modal-overlay.active {
            display: flex;
        }

        .modal {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 32px;
            max-width: 480px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            z-index: 10000;
            pointer-events: auto;
        }

        .modal * {
            pointer-events: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-header h2 {
            font-size: 1.4rem;
        }

        .modal-close {
            background: transparent;
            border: none;
            color: var(--text-tertiary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px 12px;
            position: relative;
            z-index: 1001;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        /* Amount Selector */
        .amount-selector {
            margin-bottom: 24px;
        }

        .amount-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 12px;
        }

        .amount-options {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 12px;
        }

        .amount-option {
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .amount-option:hover,
        .amount-option.selected {
            border-color: var(--accent-primary);
            background: rgba(168, 85, 247, 0.1);
        }

        .custom-amount {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .custom-amount input {
            flex: 1;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-primary);
            font-size: 1rem;
        }

        .custom-amount input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .suite-preview {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, rgba(168, 85, 247, 0.1), transparent);
            border-radius: 12px;
            margin-bottom: 24px;
        }

        .suite-preview-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-primary);
        }

        .suite-preview-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* Payment Options */
        .payment-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .payment-option {
            display: flex;
            align-items: center;
            gap: 16px;
            padding: 16px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .payment-option:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .payment-icon {
            font-size: 1.5rem;
        }

        .payment-info {
            flex: 1;
        }

        .payment-name {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .payment-desc {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .payment-arrow {
            color: var(--text-tertiary);
        }

        /* Withdraw specific */
        .balance-display {
            text-align: center;
            padding: 16px;
            background: var(--bg-tertiary);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .balance-display-value {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .balance-display-label {
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }

        .fee-notice {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-tertiary);
            margin-top: 16px;
        }

        /* Boost Cards */
        .boost-item {
            display: flex;
            align-items: center;
            gap: 10px;
            background: rgba(255, 149, 0, 0.1);
            border: 2px solid rgba(255, 149, 0, 0.2);
            padding: 12px 16px;
            border-radius: 14px;
            transition: all 0.2s;
        }

        .boost-item:hover {
            border-color: var(--accent-orange);
            transform: translateY(-2px);
        }

        .boost-item-icon {
            font-size: 1.5rem;
        }

        .boost-item-info {
            flex: 1;
        }

        .boost-item-name {
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-dark);
        }

        .boost-item-status {
            font-size: 0.75rem;
            color: var(--text-medium);
        }

        .boost-item-btn {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
        }

        .boost-item-btn.mint {
            background: linear-gradient(135deg, var(--accent-orange), var(--accent-pink));
            color: white;
        }

        .boost-item-btn.mint:hover {
            transform: scale(1.05);
        }

        .boost-item-btn.redeem {
            background: linear-gradient(135deg, #22c55e, #10b981);
            color: white;
        }

        .boost-item-btn.redeem:hover {
            transform: scale(1.05);
        }

        .boost-item-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .info-tooltip {
            cursor: help;
            font-size: 0.75rem;
            opacity: 0.7;
        }

        .info-tooltip:hover {
            opacity: 1;
        }

        /* New Dashboard Grid Layout */
        .wallet-grid {
            display: grid;
            grid-template-columns: 1.6fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        @media (max-width: 900px) {
            .wallet-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Glassmorphism Card Base */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 20px;
            /* Readjusted radius */
            padding: 20px;
            /* Reduced from 24px */
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08);
        }

        /* Vault Hero Card Specifics - Horizontal */
        .vault-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.8), rgba(255, 248, 240, 0.8));
            border: 2px solid rgba(255, 149, 0, 0.1);
            display: flex;
            flex-direction: row;
            /* Horizontal layout */
            justify-content: space-between;
            align-items: center;
            padding: 30px 40px;
            margin-bottom: 24px;
            position: relative;
            overflow: hidden;
            flex-wrap: wrap;
            gap: 20px;
        }

        .vault-content-left {
            text-align: left;
        }

        .vault-content-right {
            display: flex;
            align-items: center;
            gap: 32px;
        }

        .dashboard-bottom {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        @media (max-width: 900px) {
            .vault-card {
                flex-direction: column;
                text-align: center;
            }

            .vault-content-left {
                text-align: center;
            }

            .vault-content-right {
                flex-direction: column;
                width: 100%;
            }

            .dashboard-bottom {
                gap: 16px;
            }

            /* Stack Treasury Vault and Open Market cards vertically on mobile */
            .wallet-main-content>div[style*="grid-template-columns: 1fr 1fr"] {
                grid-template-columns: 1fr !important;
            }
        }

        .vault-balance-large {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #2d1b4e 0%, #8b5cf6 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
            line-height: 1.1;
        }

        .vault-actions-row {
            display: flex;
            gap: 16px;
            margin-top: 32px;
            width: 100%;
            justify-content: center;
        }

        .btn-deposit-hero {
            padding: 16px 40px;
            font-size: 1.1rem;
            border-radius: 18px;
            background: linear-gradient(135deg, #ff9500, #ff7b00);
            box-shadow: 0 4px 15px rgba(255, 149, 0, 0.4);
            color: white;
            font-weight: 800;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-withdraw-hero {
            padding: 16px 40px;
            font-size: 1.1rem;
            border-radius: 18px;
            background: rgba(255, 255, 255, 0.5);
            border: 2px solid #2d1b4e;
            color: #2d1b4e;
            font-weight: 800;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-withdraw-hero:hover {
            background: rgba(45, 27, 78, 0.05);
            transform: translateY(-2px);
        }

        /* Right Sidebar Stack */
        .sidebar-stack {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .stat-card-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info-pill {
            background: rgba(139, 92, 246, 0.1);
            color: #8b5cf6;
            padding: 6px 14px;
            border-radius: 100px;
            font-size: 0.8rem;
            font-weight: 700;
        }

        .section-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            margin-top: 40px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #2d1b4e;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Tabs */
        .wallet-tabs {
            display: flex;
            gap: 20px;
            border-bottom: 2px solid rgba(0, 0, 0, 0.05);
            margin-bottom: 24px;
        }

        .wallet-tab {
            padding: 12px 4px;
            font-weight: 700;
            color: var(--text-tertiary);
            cursor: pointer;
            position: relative;
            transition: all 0.2s;
        }

        .wallet-tab.active {
            color: var(--accent-primary);
        }

        .wallet-tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--accent-primary);
            border-radius: 2px;
        }

        /* Connect Buttons Hover Effects */
        #discordLoginBtn2:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(88, 101, 242, 0.4);
        }

        #connectWalletBtn2:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 149, 0, 0.4);
        }

        /* Yield Allocation Slider Styles */
        .yield-slider {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            outline: none;
            cursor: pointer;
        }

        .yield-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.15s ease;
        }

        .yield-slider::-webkit-slider-thumb:hover {
            transform: scale(1.1);
        }

        .yield-slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #22c55e, #16a34a);
            cursor: pointer;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        .yield-slider::-moz-range-track {
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
        }
    </style>
</head>

<body>
    <!-- Navigation -->
    <nav id="main-nav"></nav>
    <script src="nav-component.js"></script>

    <!-- Animated Background Blobs -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <main class="wallet-page">
        <div class="wallet-container">
            <!-- Clay Treasure Chest - Fixed to right side of page (behind everything) -->
            <!-- How It Works Tooltip (Hidden by default, positioned near icon) -->
            <div id="howItWorksTooltip"
                style="display: none; position: absolute; background: white; border-radius: 12px; padding: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.15); max-width: 280px; z-index: 100; border: 2px solid rgba(139,92,246,0.2);">
                <div style="font-size: 0.85rem; font-weight: 700; color: #2d1b4e; margin-bottom: 8px;">üí° How it works
                </div>
                <div style="font-size: 0.8rem; color: #6b7280; line-height: 1.5;">Deposit <span
                        style="font-weight: 700; color: #627EEA;">ETH</span> or <span
                        style="font-weight: 700; color: #2775CA;">USDC</span>, and get <span
                        style="font-weight: 700; color: #ff9500;">SUITE</span> tokens! Or buy SUITE on the open market
                    (or execute community arbitrage!)</div>
            </div>

            <img src="assets/clay/treasure-chest.png" alt=""
                style="position: absolute; top: 700px; right: 50px; width: 630px; height: auto; opacity: 1; pointer-events: none; z-index: 0;" />

            <!-- Wallet Dashboard (always visible) -->
            <section class="wallet-dashboard connected" id="walletDashboard">

                <!-- Header with Clay Mascot (no wallet address here anymore) -->
                <div class="wallet-header" style="position: relative;">
                    <!-- Clay Wallet with Wings Mascot -->
                    <img src="assets/clay/wallet-wings.png" alt=""
                        style="position: absolute; top: 0px; left: -250px; width: 420px; height: auto; opacity: 0.9; pointer-events: none; animation: float 4s ease-in-out infinite;" />
                </div>

                <!-- Main Content Wrapper -->
                <div class="wallet-main-content" style="position: relative; z-index: 10;">

                    <!-- Top Row: UX Notice removed for compactness -->

                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- TREASURY VAULT - Redesigned -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div style="margin-bottom: 16px;">

                        <div class="glass-card"
                            style="background: linear-gradient(135deg, rgba(255,255,255,0.95), rgba(252,231,243,0.9)); border: 1px solid rgba(139,92,246,0.15); padding: 24px; position: relative; overflow: hidden;">

                            <!-- Compact Header Row -->
                            <div
                                style="display: flex; align-items: center; justify-content: space-between; gap: 24px; flex-wrap: wrap;">

                                <!-- Left: Icon + Title -->
                                <div style="display: flex; align-items: center; gap: 16px;">
                                    <div
                                        style="width: 56px; height: 56px; background: linear-gradient(135deg, #627EEA, #2775CA); border-radius: 16px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <span style="font-size: 1.5rem;">üè¶</span>
                                    </div>
                                    <div>
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            <span style="font-size: 1.3rem; font-weight: 800; color: #2d1b4e;">Treasury
                                                Vault</span>
                                            <span
                                                style="font-size: 0.65rem; background: rgba(34, 197, 94, 0.15); color: #22c55e; padding: 3px 8px; border-radius: 100px; font-weight: 700;">LIVE</span>
                                        </div>
                                        <div style="font-size: 0.85rem; color: #6b7280;">Deposit USDC ‚Ä¢ Earn ~42% APY</div>
                                    </div>
                                </div>

                                <!-- Center: Stats -->
                                <div style="display: flex; gap: 32px; flex-wrap: wrap;">
                                    <div style="text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                            Est. APR</div>
                                        <div style="font-size: 1.4rem; font-weight: 800; color: #22c55e;">~42%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                            TVL</div>
                                        <div style="font-size: 1.4rem; font-weight: 800; color: #2d1b4e;" id="vaultTVL">
                                            $50.2K</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px;">
                                            Your Deposit</div>
                                        <div style="font-size: 1.4rem; font-weight: 800; color: #a855f7;"
                                            id="vaultDeposit">$0.00</div>
                                    </div>
                                </div>

                                <!-- Right: Action Buttons -->
                                <div style="display: flex; gap: 12px; flex-shrink: 0;">
                                    <button onclick="toggleVaultDetails()" id="vaultDetailsBtn"
                                        style="padding: 14px 20px; background: white; color: #6b7280; border: 2px solid #e5e7eb; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease;"
                                        onmouseover="this.style.borderColor='#a855f7'; this.style.color='#a855f7';"
                                        onmouseout="this.style.borderColor='#e5e7eb'; this.style.color='#6b7280';">
                                        Details ‚ñº
                                    </button>
                                    <button
                                        onclick="toggleVaultDetails(); setTimeout(() => document.getElementById('vaultDepositAmount')?.focus(), 100);"
                                        style="padding: 14px 24px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 0.9rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 14px rgba(34, 197, 94, 0.3);"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 24px rgba(34, 197, 94, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 14px rgba(34, 197, 94, 0.3)';">
                                        üí∞ Deposit
                                    </button>
                                </div>
                            </div>

                            <!-- Expandable Vault Details Panel -->
                            <div id="vaultDetailsPanel"
                                style="display: none; margin-top: 24px; padding-top: 24px; border-top: 2px solid rgba(139,92,246,0.1);">

                                <!-- Tabs -->
                                <div
                                    style="display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 2px solid rgba(0,0,0,0.05); padding-bottom: 12px;">
                                    <button onclick="switchVaultTab('deposit')" id="vaultTabDeposit"
                                        class="vault-tab active"
                                        style="padding: 8px 16px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; font-weight: 700; font-size: 0.85rem; cursor: pointer;">
                                        Deposit
                                    </button>
                                    <button onclick="switchVaultTab('withdraw')" id="vaultTabWithdraw" class="vault-tab"
                                        style="padding: 8px 16px; background: rgba(0,0,0,0.05); color: #6b7280; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer;">
                                        Withdraw
                                    </button>
                                    <button onclick="switchVaultTab('yield')" id="vaultTabYield" class="vault-tab"
                                        style="padding: 8px 16px; background: rgba(0,0,0,0.05); color: #6b7280; border: none; border-radius: 8px; font-weight: 600; font-size: 0.85rem; cursor: pointer;">
                                        Yield Allocation
                                    </button>
                                </div>

                                <!-- Deposit Tab Content -->
                                <div id="vaultDepositTab">
                                    <div
                                        style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 16px; align-items: end; margin-bottom: 24px;">
                                        <div>
                                            <label
                                                style="display: block; font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-bottom: 8px;">Asset</label>
                                            <!-- Custom Asset Selector -->
                                            <div id="assetSelector" style="position: relative;">
                                                <button type="button" onclick="toggleAssetDropdown()"
                                                    id="assetSelectorBtn"
                                                    style="width: 100%; padding: 12px 16px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; font-weight: 600; background: white; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: all 0.2s;"
                                                    onmouseover="this.style.borderColor='#a855f7';"
                                                    onmouseout="this.style.borderColor='#e5e7eb';">
                                                    <img id="selectedAssetIcon"
                                                        src="https://raw.githubusercontent.com/spothq/cryptocurrency-icons/master/svg/color/usdc.svg"
                                                        style="width: 28px; height: 28px; border-radius: 50%;">
                                                    <span id="selectedAssetName"
                                                        style="flex: 1; text-align: left; color: #2d1b4e;">USDC</span>
                                                </button>
                                                <input type="hidden" id="depositAssetSelect" value="USDC">
                                            </div>
                                        </div>
                                        <div>
                                            <label
                                                style="display: block; font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-bottom: 8px;">Amount</label>
                                            <div style="position: relative;">
                                                <input type="number" id="vaultDepositAmount" placeholder="0.00"
                                                    style="width: 100%; padding: 14px 16px; padding-right: 60px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; font-weight: 600;">
                                                <button onclick="setMaxDeposit()"
                                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(168, 85, 247, 0.1); color: #a855f7; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer;">
                                                    MAX
                                                </button>
                                            </div>
                                        </div>
                                        <button onclick="executeVaultDeposit()"
                                            style="padding: 14px 32px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; white-space: nowrap;"
                                            onmouseover="this.style.transform='translateY(-2px)';"
                                            onmouseout="this.style.transform='translateY(0)';">
                                            Deposit ‚Üí
                                        </button>
                                    </div>
                                </div>

                                <!-- Withdraw Tab Content (hidden by default) -->
                                <div id="vaultWithdrawTab" style="display: none;">
                                    <div
                                        style="display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: end; margin-bottom: 24px;">
                                        <div>
                                            <label
                                                style="display: block; font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-bottom: 8px;">Amount
                                                to Withdraw</label>
                                            <div style="position: relative;">
                                                <input type="number" id="vaultWithdrawAmount" placeholder="0.00"
                                                    style="width: 100%; padding: 14px 16px; padding-right: 60px; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 1rem; font-weight: 600;">
                                                <button onclick="setMaxWithdraw()"
                                                    style="position: absolute; right: 8px; top: 50%; transform: translateY(-50%); background: rgba(239, 68, 68, 0.1); color: #ef4444; border: none; padding: 6px 12px; border-radius: 8px; font-size: 0.75rem; font-weight: 700; cursor: pointer;">
                                                    MAX
                                                </button>
                                            </div>
                                        </div>
                                        <button onclick="executeVaultWithdraw()"
                                            style="padding: 14px 32px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 12px; font-weight: 700; font-size: 0.95rem; cursor: pointer; transition: all 0.3s; white-space: nowrap;">
                                            Withdraw ‚Üí
                                        </button>
                                    </div>
                                </div>

                                <!-- Yield Allocation Tab Content -->
                                <div id="vaultYieldTab" style="display: none;">
                                    <!-- Yield Split Slider -->
                                    <div style="background: rgba(255,255,255,0.8); border-radius: 16px; padding: 24px; margin-bottom: 20px;">
                                        <div style="text-align: center; margin-bottom: 20px;">
                                            <div style="font-size: 0.8rem; color: #6b7280; margin-bottom: 4px;">Your Yield Split</div>
                                            <div style="font-size: 2rem; font-weight: 800; color: #2d1b4e;">
                                                <span id="keepPercentDisplay" style="color: #22c55e;">90%</span>
                                                <span style="color: #9ca3af; font-size: 1rem; margin: 0 8px;">/</span>
                                                <span id="fundPercentDisplay" style="color: #a855f7;">10%</span>
                                            </div>
                                            <div style="font-size: 0.75rem; color: #9ca3af; margin-top: 4px;">
                                                <span style="color: #22c55e;">You keep</span> / <span style="color: #a855f7;">Fund apps</span>
                                            </div>
                                        </div>

                                        <!-- Slider -->
                                        <div style="padding: 0 8px;">
                                            <input type="range" id="yieldSplitSlider" class="yield-slider" min="0" max="90" value="90"
                                                oninput="updateYieldSplit(this.value)">
                                        </div>

                                        <!-- Labels -->
                                        <div style="display: flex; justify-content: space-between; margin-top: 8px; font-size: 0.75rem; color: #9ca3af;">
                                            <span>100% to apps</span>
                                            <span>90% keep / 10% to apps</span>
                                        </div>

                                        <!-- Estimated earnings -->
                                        <div style="margin-top: 20px; padding: 16px; background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(34, 197, 94, 0.02)); border-radius: 12px;">
                                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                                <span style="font-size: 0.85rem; color: #6b7280;">Based on $1,000 deposit:</span>
                                                <span id="estimatedEarnings" style="font-weight: 800; color: #22c55e; font-size: 1.1rem;">~$378/year</span>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Info Note -->
                                    <div style="padding: 14px; background: rgba(59, 130, 246, 0.08); border-radius: 12px; display: flex; align-items: flex-start; gap: 10px;">
                                        <span style="font-size: 1.2rem;">üí°</span>
                                        <div style="font-size: 0.8rem; color: #4b5563; line-height: 1.5;">
                                            <strong>How it works:</strong> Your deposit earns yield from DeFi protocols.
                                            You choose how much to keep vs allocate to fund AI Fleet app development.
                                            Minimum 10% always goes to apps.
                                        </div>
                                    </div>
                                </div>

                                <!-- Info Grid -->
                                <div
                                    style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">

                                    <!-- Fees Card -->
                                    <div style="background: rgba(255,255,255,0.8); border-radius: 16px; padding: 20px;">
                                        <div
                                            style="font-weight: 700; color: #2d1b4e; margin-bottom: 12px; font-size: 0.95rem;">
                                            üíµ Fees</div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">Deposit Fee</span>
                                            <span style="font-weight: 700; color: #22c55e;">0%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">Withdrawal Fee</span>
                                            <span style="font-weight: 700; color: #22c55e;">0%</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">Min App Allocation</span>
                                            <span style="font-weight: 700; color: #a855f7;">10%</span>
                                        </div>
                                    </div>

                                    <!-- Strategies Card -->
                                    <div style="background: rgba(255,255,255,0.8); border-radius: 16px; padding: 20px;">
                                        <div style="font-weight: 700; color: #2d1b4e; margin-bottom: 12px; font-size: 0.95rem;">
                                            üìä Active Strategy</div>

                                        <!-- USDC yVault Strategy -->
                                        <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.08), rgba(59, 130, 246, 0.05)); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 14px;">
                                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                                                <div style="width: 32px; height: 32px; background: linear-gradient(135deg, #2775CA, #1a5fb4); border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                                                    <span style="color: white; font-weight: 800; font-size: 0.7rem;">USDC</span>
                                                </div>
                                                <div style="flex: 1;">
                                                    <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem;">USDC yVault</div>
                                                    <div style="font-size: 0.7rem; color: #6b7280;">Katana ‚Ä¢ Vault Bridge</div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-weight: 800; color: #22c55e; font-size: 1.1rem;">42.10%</div>
                                                    <div style="font-size: 0.65rem; color: #6b7280;">APR</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: #6b7280; padding-top: 8px; border-top: 1px solid rgba(0,0,0,0.05);">
                                                <span>TVL: $90.06M</span>
                                                <a href="https://basescan.org/address/0x80c34BD3A3569E126e7055831036aa7b212cB159" target="_blank" style="color: #3b82f6; text-decoration: none;">View Contract ‚Üó</a>
                                            </div>
                                        </div>

                                        <div style="margin-top: 10px; font-size: 0.7rem; color: #9ca3af; line-height: 1.4;">
                                            Multi-strategy vault via Yearn. Eligible for STEER points + KAT rewards.
                                        </div>
                                    </div>

                                    <!-- Your Position Card -->
                                    <div
                                        style="background: rgba(168, 85, 247, 0.08); border: 1px solid rgba(168, 85, 247, 0.15); border-radius: 16px; padding: 20px;">
                                        <div
                                            style="font-weight: 700; color: #a855f7; margin-bottom: 12px; font-size: 0.95rem;">
                                            üìà Your Position</div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">Deposited</span>
                                            <span style="font-weight: 700; color: #2d1b4e;">$0.00</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">Earned</span>
                                            <span style="font-weight: 700; color: #22c55e;">$0.00</span>
                                        </div>
                                        <div style="display: flex; justify-content: space-between;">
                                            <span style="color: #6b7280; font-size: 0.85rem;">LP Tokens</span>
                                            <span style="font-weight: 700; color: #2d1b4e;">0</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <!-- STAKING SECTION - Prominent in Main View -->
                    <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                    <div class="glass-card"
                        style="background: linear-gradient(135deg, rgba(168, 85, 247, 0.08), rgba(236, 72, 153, 0.05)); border: 2px solid rgba(168, 85, 247, 0.15); padding: 24px; margin-bottom: 16px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div
                                    style="width: 48px; height: 48px; background: linear-gradient(135deg, #a855f7, #ec4899); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 1.4rem;">
                                    ‚ö°</div>
                                <div>
                                    <div style="font-size: 1.3rem; font-weight: 800; color: #2d1b4e;">Stake LP
                                        Tokens
                                    </div>
                                    <div style="font-size: 0.85rem; color: #6b7280;">Power app development with your
                                        tokens</div>
                                </div>
                            </div>
                            <div style="text-align: right;">
                                <div
                                    style="font-size: 0.75rem; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.5px;">
                                    Your Stake</div>
                                <div id="stakingTotalStakedMain"
                                    style="font-size: 1.4rem; font-weight: 800; color: #a855f7;">0 SUITE</div>
                            </div>
                        </div>

                        <!-- Quick Stake Row -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
                            <div>
                                <label
                                    style="font-size: 0.75rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 4px;">Stake
                                    Amount</label>
                                <input type="number" id="stakeAmountMain" placeholder="100"
                                    style="width: 100%; padding: 12px 14px; border: 2px solid rgba(168, 85, 247, 0.2); border-radius: 10px; font-size: 1rem; font-weight: 600; background: white;">
                            </div>
                            <div>
                                <label
                                    style="font-size: 0.75rem; font-weight: 600; color: #6b7280; display: block; margin-bottom: 4px;">Allocate
                                    To</label>
                                <select id="stakingAppSelectMain"
                                    style="width: 100%; padding: 12px 14px; border: 2px solid rgba(168, 85, 247, 0.2); border-radius: 10px; font-size: 0.9rem; font-weight: 600; background: white; cursor: pointer;">
                                    <option value="">Choose app...</option>
                                </select>
                            </div>
                            <button onclick="stakeAndAllocate()"
                                style="padding: 12px 24px; background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; border-radius: 10px; font-weight: 700; font-size: 0.95rem; cursor: pointer; white-space: nowrap; transition: all 0.2s;"
                                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(168, 85, 247, 0.3)';"
                                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none';">
                                ‚ö° Stake & Allocate
                            </button>
                        </div>

                        <!-- Staking Stats Row -->
                        <div
                            style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(168, 85, 247, 0.1);">
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Total
                                    Staked</div>
                                <div id="stakingTotalStaked" style="font-weight: 700; color: #2d1b4e;">0 SUITE</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Allocated
                                </div>
                                <div id="stakingAllocated" style="font-weight: 700; color: #a855f7;">0 SUITE</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 0.7rem; color: #9ca3af; text-transform: uppercase;">Available
                                </div>
                                <div id="stakingAvailable" style="font-weight: 700; color: #22c55e;">0 SUITE</div>
                            </div>
                        </div>

                        <!-- Your Allocations -->
                        <div
                            style="margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(168, 85, 247, 0.1);">
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem; margin-bottom: 12px;">
                                üì± Your App Allocations</div>
                            <div id="stakingAllocationsList"
                                style="display: flex; flex-direction: column; gap: 8px; max-height: 200px; overflow-y: auto;">
                                <div style="text-align: center; padding: 16px; color: #9ca3af; font-size: 0.85rem;">
                                    No allocations yet. Deposit ETH/USDC and stake LP tokens to support an app!
                                </div>
                            </div>
                        </div>

                        <!-- Development Tiers Info -->
                        <div
                            style="margin-top: 16px; padding: 16px; background: rgba(168, 85, 247, 0.05); border-radius: 12px;">
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem; margin-bottom: 8px;">üèÜ
                                Development Tiers</div>
                            <div
                                style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; text-align: center;">
                                <div>
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Tier
                                        1</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7;">10K</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Tier
                                        2</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7;">50K</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Tier
                                        3</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7;">200K</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Tier
                                        4</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7;">500K</div>
                                </div>
                                <div>
                                    <div style="font-size: 0.65rem; color: #9ca3af; text-transform: uppercase;">Tier
                                        5</div>
                                    <div style="font-size: 0.75rem; font-weight: 700; color: #a855f7;">1M</div>
                                </div>
                            </div>
                            <div style="margin-top: 8px; font-size: 0.75rem; color: #6b7280; text-align: center;">
                                Higher tiers unlock priority updates, new features, and ecosystem benefits
                            </div>
                        </div>

                        <!-- Withdraw Section -->
                        <div
                            style="margin-top: 16px; padding: 16px; background: rgba(0,0,0,0.02); border-radius: 12px;">
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem; margin-bottom: 12px;">
                                Withdraw SUITE</div>
                            <div style="display: flex; gap: 8px;">
                                <input type="number" id="withdrawAmountMain" placeholder="Amount to withdraw"
                                    style="flex: 1; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                <button onclick="withdrawStake()"
                                    style="padding: 10px 20px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    Withdraw
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Dashboard Bottom Grid -->
                <div class="dashboard-bottom" style="width: 100%;">

                    <!-- Tabs Section -->
                    <div id="earn">
                        <div class="wallet-tabs" style="margin-bottom: 16px;">
                            <div class="wallet-tab active" onclick="switchTab('earn')">Yield</div>
                            <div class="wallet-tab" onclick="switchTab('activity')">Recent Activity</div>
                            <div class="wallet-tab" onclick="switchTab('boosts')">Active Boosts</div>
                            <div class="wallet-tab" onclick="switchTab('governance')">Governance</div>
                        </div>

                        <!-- Tab Content: Activity -->
                        <div id="tab-activity" class="tab-content" style="display: none;">
                            <div class="glass-card"
                                style="min-height: 150px; display: flex; align-items: center; justify-content: center; color: #9ca3af; flex-direction: column; gap: 8px;">
                                <div style="font-size: 1.5rem;">üì≠</div>
                                <div style="font-size: 0.9rem;">No recent activity.</div>
                            </div>
                        </div>

                        <!-- Tab Content: Yield Allocation (redirects to vault) -->
                        <div id="tab-earn" class="tab-content active">
                            <div class="glass-card" style="padding: 24px; text-align: center;">
                                <div style="font-size: 2.5rem; margin-bottom: 16px;">üí∞</div>
                                <h4 style="margin: 0 0 12px 0; color: #2d1b4e; font-size: 1.2rem; font-weight: 800;">
                                    Yield Allocation
                                </h4>
                                <p style="margin: 0 0 20px 0; color: #6b7280; font-size: 0.9rem; max-width: 300px; margin-left: auto; margin-right: auto;">
                                    Manage your yield allocation in the Treasury Vault panel above. Click "Deposit" then select the "Yield Allocation" tab.
                                </p>
                                <button onclick="toggleVaultDetails(); setTimeout(() => switchVaultTab('yield'), 100);"
                                    style="padding: 12px 24px; background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">
                                    Open Yield Settings
                                </button>
                            </div>
                        </div>

                        <!-- Tab Content: Boosts -->
                        <div id="tab-boosts" class="tab-content" style="display: none;">
                            <div class="glass-card">
                                <h4 style="margin: 0 0 12px 0; color: #2d1b4e; font-size: 1rem;">Your Active
                                    Boosts
                                </h4>
                                <!-- Boosts Lists -->
                                <div id="databaseBoostsList" style="margin-bottom: 16px;">
                                    <div
                                        style="font-size: 0.8rem; font-weight: 700; color: var(--text-medium); margin-bottom: 8px;">
                                        ?? Account Boosts</div>
                                    <div id="databaseBoostsContent" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <span style="color: var(--text-tertiary); font-size: 0.8rem;">Connect
                                            Discord</span>
                                    </div>
                                </div>
                                <div id="nftBoostsList">
                                    <div
                                        style="font-size: 0.8rem; font-weight: 700; color: var(--text-medium); margin-bottom: 8px;">
                                        ?? NFT Boosts</div>
                                    <div id="nftBoostsContent" style="display: flex; flex-wrap: wrap; gap: 8px;">
                                        <span style="color: var(--text-tertiary); font-size: 0.8rem;">Connect
                                            wallet</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tab Content: Governance -->
                        <div id="tab-governance" class="tab-content" style="display: none;">
                            <div class="glass-card" style="text-align: center; padding: 24px;">
                                <h3 style="font-size: 1.1rem; margin-bottom: 8px;">Governance Portal</h3>
                                <p style="color: #6b7280; margin-bottom: 16px; font-size: 0.9rem;">Vote on
                                    treasury
                                    proposals.</p>
                                <button
                                    style="padding: 8px 16px; background: rgba(0,0,0,0.05); border-radius: 100px; border: none; font-weight: 600; color: #6b7280; cursor: not-allowed; font-size: 0.8rem;">Coming
                                    Soon</button>
                            </div>
                        </div>

                        <!-- Tab Content: Staking -->
                        <div id="tab-staking" class="tab-content" style="display: none;">
                            <div class="glass-card" style="padding: 24px;">
                                <!-- Staking Header -->
                                <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                                    <div
                                        style="width: 48px; height: 48px; background: linear-gradient(135deg, #a855f7, #ec4899); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                        ‚ö°</div>
                                    <div>
                                        <h4 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e;">
                                            Stake LP Tokens</h4>
                                        <p style="margin: 0; font-size: 0.85rem; color: #6b7280;">Stake tokens
                                            to power app development</p>
                                    </div>
                                </div>

                                <!-- Current Stake Stats -->
                                <div
                                    style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px;">
                                    <div
                                        style="background: rgba(168, 85, 247, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Total Staked</div>
                                        <div id="stakingTotalStaked"
                                            style="font-size: 1.3rem; font-weight: 800; color: #a855f7;">0 SUITE
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(34, 197, 94, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Allocated</div>
                                        <div id="stakingAllocated"
                                            style="font-size: 1.3rem; font-weight: 800; color: #22c55e;">0 SUITE
                                        </div>
                                    </div>
                                    <div
                                        style="background: rgba(249, 115, 22, 0.08); border-radius: 12px; padding: 16px; text-align: center;">
                                        <div
                                            style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase; letter-spacing: 0.5px;">
                                            Available</div>
                                        <div id="stakingAvailable"
                                            style="font-size: 1.3rem; font-weight: 800; color: #f97316;">0 SUITE
                                        </div>
                                    </div>
                                </div>

                                <!-- Stake/Withdraw Actions -->
                                <div
                                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 24px;">
                                    <div
                                        style="background: rgba(168, 85, 247, 0.05); border: 2px solid rgba(168, 85, 247, 0.2); border-radius: 12px; padding: 16px;">
                                        <div
                                            style="font-size: 0.8rem; font-weight: 700; color: #a855f7; margin-bottom: 8px;">
                                            Stake LP Tokens</div>
                                        <input type="number" id="stakeAmount" placeholder="Amount to stake"
                                            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; margin-bottom: 8px; box-sizing: border-box;">
                                        <button onclick="stakeSUITE()"
                                            style="width: 100%; padding: 10px 16px; background: linear-gradient(135deg, #a855f7, #ec4899); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Stake</button>
                                    </div>
                                    <div
                                        style="background: rgba(0, 0, 0, 0.02); border: 2px solid rgba(0, 0, 0, 0.08); border-radius: 12px; padding: 16px;">
                                        <div
                                            style="font-size: 0.8rem; font-weight: 700; color: #6b7280; margin-bottom: 8px;">
                                            Withdraw SUITE</div>
                                        <input type="number" id="withdrawStakeAmount" placeholder="Amount to withdraw"
                                            style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; margin-bottom: 8px; box-sizing: border-box;">
                                        <button onclick="withdrawStake()"
                                            style="width: 100%; padding: 10px 16px; background: white; color: #6b7280; border: 1px solid #e5e7eb; border-radius: 8px; font-weight: 600; cursor: pointer;">Withdraw</button>
                                    </div>
                                </div>

                                <!-- Allocate Power Section -->
                                <div style="border-top: 1px solid rgba(0, 0, 0, 0.06); padding-top: 20px;">
                                    <h5 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 700; color: #2d1b4e;">
                                        üéØ Allocate Power to Apps</h5>
                                    <p style="font-size: 0.85rem; color: #6b7280; margin-bottom: 16px;">Support
                                        apps to unlock development tiers. Power can be moved freely.</p>

                                    <div
                                        style="display: grid; grid-template-columns: 2fr 1fr auto; gap: 12px; align-items: end;">
                                        <div>
                                            <label
                                                style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Select
                                                App</label>
                                            <select id="stakingAppSelect"
                                                style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; background: white;">
                                                <option value="">Choose an app...</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label
                                                style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Power</label>
                                            <input type="number" id="allocateAmount" placeholder="0"
                                                style="width: 100%; padding: 10px 12px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.9rem; box-sizing: border-box;">
                                        </div>
                                        <button onclick="allocatePower()"
                                            style="padding: 10px 20px; background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; border-radius: 8px; font-weight: 700; cursor: pointer;">Allocate</button>
                                    </div>
                                </div>

                                <!-- Your Allocations -->
                                <div
                                    style="border-top: 1px solid rgba(0, 0, 0, 0.06); padding-top: 20px; margin-top: 20px;">
                                    <h5 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 700; color: #2d1b4e;">
                                        üìä Your Allocations</h5>
                                    <div id="stakingAllocationsList"
                                        style="display: flex; flex-direction: column; gap: 10px;">
                                        <div
                                            style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">
                                            Connect wallet to view allocations
                                        </div>
                                    </div>
                                </div>

                                <!-- Tier Info -->
                                <div
                                    style="border-top: 1px solid rgba(0, 0, 0, 0.06); padding-top: 20px; margin-top: 20px;">
                                    <h5 style="margin: 0 0 12px 0; font-size: 1rem; font-weight: 700; color: #2d1b4e;">
                                        üèÜ Development Tiers</h5>
                                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px;">
                                        <div
                                            style="background: rgba(34, 197, 94, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                            <div style="font-weight: 800; color: #22c55e;">Tier 1</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">10k SUITE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">
                                                Bug Fixes</div>
                                        </div>
                                        <div
                                            style="background: rgba(59, 130, 246, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                            <div style="font-weight: 800; color: #3b82f6;">Tier 2</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">50k SUITE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">2
                                                Features/wk</div>
                                        </div>
                                        <div
                                            style="background: rgba(168, 85, 247, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                            <div style="font-weight: 800; color: #a855f7;">Tier 3</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">200k SUITE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">
                                                Marketing</div>
                                        </div>
                                        <div
                                            style="background: rgba(249, 115, 22, 0.08); border-radius: 8px; padding: 10px; text-align: center;">
                                            <div style="font-weight: 800; color: #f97316;">Tier 4</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">500k SUITE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">
                                                Human QA</div>
                                        </div>
                                        <div
                                            style="background: linear-gradient(135deg, rgba(255, 149, 0, 0.15), rgba(255, 107, 157, 0.1)); border-radius: 8px; padding: 10px; text-align: center;">
                                            <div
                                                style="font-weight: 800; background: linear-gradient(135deg, #ff9500, #ff6b9d); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                                                Tier 5</div>
                                            <div style="font-size: 0.7rem; color: #6b7280;">1M SUITE</div>
                                            <div style="font-size: 0.65rem; color: #9ca3af; margin-top: 4px;">
                                                Full Team</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>


                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <!-- ADMIN DASHBOARD (Only visible to admin wallets) -->
                <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
                <div id="adminDashboard" style="display: none; margin-top: 24px;">
                    <div class="glass-card"
                        style="background: linear-gradient(135deg, rgba(239, 68, 68, 0.08), rgba(220, 38, 38, 0.05)); border: 2px solid rgba(239, 68, 68, 0.2); padding: 24px;">

                        <!-- Admin Header -->
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 20px;">
                            <div
                                style="width: 48px; height: 48px; background: linear-gradient(135deg, #ef4444, #dc2626); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
                                üîê</div>
                            <div>
                                <h4 style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #dc2626;">Treasury
                                    Admin Dashboard</h4>
                                <p style="margin: 0; font-size: 0.85rem; color: #6b7280;">Multi-sig admin wallet
                                    connected</p>
                            </div>
                            <div
                                style="margin-left: auto; background: rgba(34, 197, 94, 0.1); color: #22c55e; padding: 4px 12px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">
                                ‚óè Admin Active
                            </div>
                        </div>

                        <!-- Treasury Overview Grid -->
                        <div
                            style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px;">
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Reported
                                    Value</div>
                                <div id="adminReportedValue"
                                    style="font-size: 1.3rem; font-weight: 800; color: #2d1b4e;">$0</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Contract
                                    Balance</div>
                                <div id="adminContractBalance"
                                    style="font-size: 1.3rem; font-weight: 800; color: #3b82f6;">0 ETH</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Estimated
                                    APY</div>
                                <div id="adminEstimatedAPY"
                                    style="font-size: 1.3rem; font-weight: 800; color: #22c55e;">0%</div>
                            </div>
                            <div
                                style="background: rgba(255,255,255,0.8); border-radius: 12px; padding: 16px; text-align: center;">
                                <div style="font-size: 0.7rem; color: #6b7280; text-transform: uppercase;">Last
                                    Updated</div>
                                <div id="adminLastUpdated" style="font-size: 0.9rem; font-weight: 700; color: #6b7280;">
                                    Never</div>
                            </div>
                        </div>

                        <!-- Value Update Section -->
                        <div
                            style="background: rgba(255,255,255,0.6); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem; margin-bottom: 12px;">
                                üìä Update Treasury Value</div>
                            <div
                                style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; align-items: end;">
                                <div>
                                    <label
                                        style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Total
                                        Value (USD)</label>
                                    <input type="number" id="adminNewValue" placeholder="500000"
                                        style="width: 100%; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <div>
                                    <label
                                        style="font-size: 0.75rem; color: #6b7280; display: block; margin-bottom: 4px;">Estimated
                                        APY (%)</label>
                                    <input type="number" id="adminNewAPY" placeholder="20"
                                        style="width: 100%; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                </div>
                                <button onclick="updateTreasuryValues()"
                                    style="padding: 10px 20px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                    Update Values
                                </button>
                            </div>
                        </div>

                        <!-- Fund Management -->
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 16px;">
                            <!-- Withdraw to Admin -->
                            <div
                                style="background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #dc2626; font-size: 0.9rem; margin-bottom: 12px;">
                                    ‚¨ÜÔ∏è Withdraw to Admin Wallet</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="adminWithdrawAmount" placeholder="ETH amount"
                                        style="flex: 1; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                    <button onclick="adminWithdraw()"
                                        style="padding: 10px 16px; background: #ef4444; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        Withdraw
                                    </button>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 8px;">Sends ETH to your
                                    connected admin wallet for deployment</div>
                            </div>

                            <!-- Deposit from Admin -->
                            <div
                                style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; color: #22c55e; font-size: 0.9rem; margin-bottom: 12px;">
                                    ‚¨áÔ∏è Deposit from Admin Wallet</div>
                                <div style="display: flex; gap: 8px;">
                                    <input type="number" id="adminDepositAmount" placeholder="ETH amount"
                                        style="flex: 1; padding: 10px 14px; border: 1px solid rgba(0,0,0,0.1); border-radius: 8px; font-size: 0.9rem;">
                                    <button onclick="adminDeposit()"
                                        style="padding: 10px 16px; background: #22c55e; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
                                        Deposit
                                    </button>
                                </div>
                                <div style="font-size: 0.75rem; color: #6b7280; margin-top: 8px;">Return funds from
                                    your wallet back to treasury</div>
                            </div>
                        </div>

                        <!-- Position Tracking -->
                        <div
                            style="background: rgba(255,255,255,0.6); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: #2d1b4e; font-size: 0.9rem;">üìç Deployed
                                    Positions (Manual Tracking)</div>
                                <button onclick="addPosition()"
                                    style="padding: 6px 12px; background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.2); border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">
                                    + Add Position
                                </button>
                            </div>
                            <div id="positionsTable" style="display: flex; flex-direction: column; gap: 8px;">
                                <div
                                    style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 10px 12px; background: rgba(59, 130, 246, 0.05); border-radius: 8px; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #2d1b4e; font-size: 0.85rem;">Kinetic
                                            (Flare) - ETH Lending</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">Collateral for USDT borrow
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Value</div>
                                        <div style="font-weight: 700; color: #2d1b4e;">$0</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">APY</div>
                                        <div style="font-weight: 700; color: #22c55e;">~8%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Chain</div>
                                        <div style="font-weight: 600; color: #f97316;">Flare</div>
                                    </div>
                                    <button
                                        style="padding: 4px 8px; background: rgba(0,0,0,0.05); border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Edit</button>
                                </div>
                                <div
                                    style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 10px 12px; background: rgba(34, 197, 94, 0.05); border-radius: 8px; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #2d1b4e; font-size: 0.85rem;">SparkDex
                                            - ETH/USDT LP</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">Liquidity provision</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Value</div>
                                        <div style="font-weight: 700; color: #2d1b4e;">$0</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">APY</div>
                                        <div style="font-weight: 700; color: #22c55e;">~25%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Chain</div>
                                        <div style="font-weight: 600; color: #f97316;">Flare</div>
                                    </div>
                                    <button
                                        style="padding: 4px 8px; background: rgba(0,0,0,0.05); border: none; border-radius: 4px; font-size: 0.7rem; cursor: pointer;">Edit</button>
                                </div>
                                <div
                                    style="display: grid; grid-template-columns: 2fr 1fr 1fr 1fr auto; gap: 8px; padding: 10px 12px; background: rgba(139, 92, 246, 0.05); border-radius: 8px; align-items: center;">
                                    <div>
                                        <div style="font-weight: 600; color: #2d1b4e; font-size: 0.85rem;">Liquid
                                            Reserve (Base)</div>
                                        <div style="font-size: 0.7rem; color: #6b7280;">Instant withdrawals</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Value</div>
                                        <div id="liquidReserveValue" style="font-weight: 700; color: #2d1b4e;">$0
                                        </div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">APY</div>
                                        <div style="font-weight: 700; color: #6b7280;">0%</div>
                                    </div>
                                    <div style="text-align: center;">
                                        <div style="font-size: 0.65rem; color: #9ca3af;">Chain</div>
                                        <div style="font-weight: 600; color: #3b82f6;">Base</div>
                                    </div>
                                    <div style="font-size: 0.7rem; color: #22c55e; font-weight: 600;">Auto</div>
                                </div>
                            </div>
                        </div>

                        <!-- Pending Withdrawals -->
                        <div
                            style="background: rgba(249, 115, 22, 0.05); border: 1px solid rgba(249, 115, 22, 0.2); border-radius: 12px; padding: 16px;">
                            <div
                                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <div style="font-weight: 700; color: #f97316; font-size: 0.9rem;">‚è≥ Pending User
                                    Withdrawals</div>
                                <button onclick="processAllWithdrawals()"
                                    style="padding: 6px 12px; background: #f97316; color: white; border: none; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">
                                    Process All Ready
                                </button>
                            </div>
                            <div id="pendingWithdrawalsList"
                                style="font-size: 0.85rem; color: #6b7280; text-align: center; padding: 12px;">
                                No pending withdrawals
                            </div>
                        </div>

                        <!-- Emergency Controls -->
                        <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(239, 68, 68, 0.2);">
                            <div style="display: flex; gap: 12px; justify-content: flex-end;">
                                <button onclick="togglePauseWithdrawals()" id="pauseWithdrawalsBtn"
                                    style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                    ‚è∏Ô∏è Pause Withdrawals
                                </button>
                                <button onclick="togglePauseDeposits()" id="pauseDepositsBtn"
                                    style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                    ‚è∏Ô∏è Pause Deposits
                                </button>
                            </div>
                        </div>

                    </div>

                    <!-- All Apps (Admin) Section -->
                    <div class="glass-card" style="margin-top: 20px; padding: 24px;">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h3
                                style="margin: 0; font-size: 1.2rem; font-weight: 800; color: #2d1b4e; display: flex; align-items: center; gap: 10px;">
                                üõ°Ô∏è All Apps (Admin)
                            </h3>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <button class="refresh-btn" onclick="loadAllAppsAdmin()" title="Refresh"
                                    style="background: none; border: none; cursor: pointer; padding: 4px;">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#ff9500"
                                        stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                        <path d="M21 2v6h-6" />
                                        <path d="M3 12a9 9 0 0 1 15-6.7L21 8" />
                                        <path d="M3 22v-6h6" />
                                        <path d="M21 12a9 9 0 0 1-15 6.7L3 16" />
                                    </svg>
                                </button>
                                <span id="adminAppCount"
                                    style="background: linear-gradient(135deg, #ff9500, #ff6b9d); color: white; padding: 4px 12px; border-radius: 100px; font-weight: 700; font-size: 0.8rem;">0
                                    apps</span>
                            </div>
                        </div>
                        <div id="adminAppsGrid"
                            style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 16px;">
                            <div
                                style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem; grid-column: 1 / -1;">
                                üì≠ Loading apps...
                            </div>
                        </div>
                    </div>

                </div>

            </section>
        </div>
    </main>

    <!-- Add Funds Modal -->
    <div class="modal-overlay" id="depositModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Get SUITE</h2>
                <button class="modal-close" onclick="closeModal('depositModal')">?</button>
            </div>



            <div class="payment-options">
                <div class="payment-option" onclick="handlePayment('card')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Credit / Debit Card</div>
                        <div class="payment-desc">Visa, Mastercard, Amex</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handlePayment('apple')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Apple Pay</div>
                        <div class="payment-desc">One-tap checkout</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handlePayment('crypto')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Crypto (USDC / ETH)</div>
                        <div class="payment-desc">Send from any wallet</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
            </div>

            <p class="fee-notice">0.5% deposit fee ? Your funds are always withdrawable</p>
        </div>
    </div>

    <!-- Crypto Deposit Modal -->
    <div class="modal-overlay" id="cryptoDepositModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Deposit Crypto</h2>
                <button class="modal-close" onclick="closeModal('cryptoDepositModal')">?</button>
            </div>

            <!-- Network Warning -->
            <div class="network-warning" id="networkWarning" style="display: none;">
                <span></span>
                <span>Please switch to <strong>Base</strong> network in MetaMask</span>
                <button onclick="switchToBase()" class="switch-network-btn">Switch Network</button>
            </div>

            <!-- Wallet Balances -->
            <div class="wallet-balances-display">
                <div class="balance-header">Your Base Wallet</div>
                <div class="crypto-balance-row">
                    <div class="crypto-icon eth"></div>
                    <div class="crypto-info">
                        <span class="crypto-name">ETH</span>
                        <span class="crypto-balance" id="ethBalance">0.0000</span>
                    </div>
                    <span class="crypto-usd" id="ethUsdValue">~$0.00</span>
                </div>
                <div class="crypto-balance-row">
                    <div class="crypto-icon usdc"></div>
                    <div class="crypto-info">
                        <span class="crypto-name">USDC</span>
                        <span class="crypto-balance" id="usdcBalance">0.00</span>
                    </div>
                    <span class="crypto-usd" id="usdcUsdValue">~$0.00</span>
                </div>
            </div>

            <!-- Asset Selector -->
            <div class="asset-selector">
                <div class="asset-label">Deposit Asset:</div>
                <div class="asset-tabs">
                    <button class="asset-tab active" data-asset="eth" onclick="selectAsset('eth', this)">
                        ?? ETH
                    </button>
                    <button class="asset-tab" data-asset="usdc" onclick="selectAsset('usdc', this)">
                        ?? USDC
                    </button>
                </div>
            </div>

            <!-- Amount Input -->
            <div class="deposit-amount-section">
                <div class="amount-label">Amount to deposit:</div>
                <div class="crypto-amount-input-wrapper">
                    <button class="amount-adjust-btn minus" onclick="adjustAmount(-0.00001)">-</button>
                    <div class="crypto-amount-input">
                        <input type="number" id="cryptoDepositAmount" placeholder="0.000000" step="0.000001" min="0"
                            oninput="updateCryptoPreview()">
                        <span class="input-asset" id="inputAssetLabel">ETH</span>
                    </div>
                    <button class="amount-adjust-btn plus" onclick="adjustAmount(0.00001)">+</button>
                </div>
                <div class="percentage-buttons">
                    <button onclick="setPercentage(25)">25%</button>
                    <button onclick="setPercentage(50)">50%</button>
                    <button onclick="setPercentage(75)">75%</button>
                    <button onclick="setPercentage(100)">MAX</button>
                </div>
            </div>

            <!-- SUITE Preview -->
            <div class="suite-receive-preview">
                <div class="receive-label">You'll receive:</div>
                <div class="receive-value">
                    <span id="cryptoSuitePreview">0 SUITE</span>
                    <span class="receive-usd" id="cryptoUsdPreview">(~$0.00)</span>
                </div>
                <div class="receive-note">After 0.5% deposit fee ? Earning ~18% APY</div>
            </div>

            <!-- Deposit Button -->
            <button class="crypto-deposit-btn" id="cryptoDepositBtn" onclick="executeCryptoDeposit()">
                ?? Deposit Now
            </button>

            <p class="fee-notice">Funds are always withdrawable ? No lock-up period</p>
        </div>
    </div>

    <!-- Custom Notification Modal -->
    <div class="modal-overlay" id="notificationModal">
        <div class="modal notification-modal">
            <div class="notification-icon" id="notificationIcon">??</div>
            <h2 id="notificationTitle">Success!</h2>
            <p id="notificationMessage">Your transaction was submitted.</p>
            <div class="notification-details" id="notificationDetails"></div>
            <button class="notification-btn" onclick="closeNotification()">Got it</button>
        </div>
    </div>

    <!-- Full Edit App Modal -->
    <div class="edit-modal-overlay" id="editModalOverlay">
        <div class="edit-modal">
            <h3>‚úèÔ∏è Edit App</h3>
            <form id="editAppForm">
                <input type="hidden" id="editAppSlug">
                <div class="form-group">
                    <label for="editName">App Name</label>
                    <input type="text" id="editName" required>
                </div>
                <div class="form-group">
                    <label for="editTagline">Tagline</label>
                    <input type="text" id="editTagline" placeholder="Short description...">
                </div>
                <div class="form-group">
                    <label for="editDescription">Description</label>
                    <textarea id="editDescription" placeholder="Detailed description..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="editCategory">Category</label>
                        <select id="editCategory">
                            <option value="productivity">Productivity</option>
                            <option value="health">Health</option>
                            <option value="lifestyle">Lifestyle</option>
                            <option value="fitness">Fitness</option>
                            <option value="finance">Finance</option>
                            <option value="entertainment">Entertainment</option>
                            <option value="education">Education</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="editStatus">Status</label>
                        <select id="editStatus">
                            <option value="approved">üü¢ Live</option>
                            <option value="development">üü° Development</option>
                            <option value="paused">‚è∏Ô∏è Paused</option>
                            <option value="featured">‚≠ê Featured</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>App Icon</label>
                    <div class="upload-zone" id="iconUploadZone" ondrop="handleEditDrop(event, 'editIconUrl')"
                        ondragover="handleEditDragOver(event)" onclick="document.getElementById('iconFileInput').click()">
                        <img class="upload-preview" id="iconPreview" style="display: none;">
                        <div class="upload-placeholder" id="iconPlaceholder">
                            <span>üì∑</span>
                            <span>Drop image or click to upload</span>
                        </div>
                        <input type="file" id="iconFileInput" accept="image/*" style="display:none"
                            onchange="handleEditFileSelect(event, 'editIconUrl', 'iconPreview', 'iconPlaceholder')">
                    </div>
                    <input type="hidden" id="editIconUrl">
                </div>
                <div class="form-group">
                    <label for="editAppUrl">App URL (PWA Link)</label>
                    <input type="url" id="editAppUrl" placeholder="https://yourapp.vercel.app">
                </div>
                <div class="form-group">
                    <label>Screenshots</label>
                    <div class="screenshots-grid">
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot1')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss1FileInput').click()">
                            <button type="button" class="remove-btn" id="ss1Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot1', 'ss1Preview', 'ss1Placeholder', 'ss1Remove')">√ó</button>
                            <img class="upload-preview" id="ss1Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss1Placeholder"><span>üì∑ 1</span></div>
                            <input type="file" id="ss1FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot1', 'ss1Preview', 'ss1Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot2')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss2FileInput').click()">
                            <button type="button" class="remove-btn" id="ss2Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot2', 'ss2Preview', 'ss2Placeholder', 'ss2Remove')">√ó</button>
                            <img class="upload-preview" id="ss2Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss2Placeholder"><span>üì∑ 2</span></div>
                            <input type="file" id="ss2FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot2', 'ss2Preview', 'ss2Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot3')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss3FileInput').click()">
                            <button type="button" class="remove-btn" id="ss3Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot3', 'ss3Preview', 'ss3Placeholder', 'ss3Remove')">√ó</button>
                            <img class="upload-preview" id="ss3Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss3Placeholder"><span>üì∑ 3</span></div>
                            <input type="file" id="ss3FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot3', 'ss3Preview', 'ss3Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot4')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss4FileInput').click()">
                            <button type="button" class="remove-btn" id="ss4Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot4', 'ss4Preview', 'ss4Placeholder', 'ss4Remove')">√ó</button>
                            <img class="upload-preview" id="ss4Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss4Placeholder"><span>üì∑ 4</span></div>
                            <input type="file" id="ss4FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot4', 'ss4Preview', 'ss4Placeholder')">
                        </div>
                        <div class="upload-zone small" ondrop="handleEditDrop(event, 'editScreenshot5')"
                            ondragover="handleEditDragOver(event)" onclick="document.getElementById('ss5FileInput').click()">
                            <button type="button" class="remove-btn" id="ss5Remove" onclick="event.stopPropagation(); removeScreenshot('editScreenshot5', 'ss5Preview', 'ss5Placeholder', 'ss5Remove')">√ó</button>
                            <img class="upload-preview" id="ss5Preview" style="display: none;">
                            <div class="upload-placeholder" id="ss5Placeholder"><span>üì∑ 5</span></div>
                            <input type="file" id="ss5FileInput" accept="image/*" style="display:none"
                                onchange="handleEditFileSelect(event, 'editScreenshot5', 'ss5Preview', 'ss5Placeholder')">
                        </div>
                    </div>
                    <input type="hidden" id="editScreenshot1">
                    <input type="hidden" id="editScreenshot2">
                    <input type="hidden" id="editScreenshot3">
                    <input type="hidden" id="editScreenshot4">
                    <input type="hidden" id="editScreenshot5">
                </div>

                <!-- Free vs Pro Features Section -->
                <div style="border-top: 2px dashed #e5e7eb; margin: 20px 0; padding-top: 20px;">
                    <label style="font-weight: 800; font-size: 1.1rem; color: #1f2937; display: flex; align-items: center; gap: 8px; margin-bottom: 16px;">
                        üîì Feature Tiers
                        <span style="font-size: 0.75rem; font-weight: 500; color: #6b7280;">(Shown on app store page)</span>
                    </label>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="editFreeFeatures" style="color: #16a34a;">
                                üÜì Free Features <span style="font-weight: 400; color: #6b7280;">(one per line)</span>
                            </label>
                            <textarea id="editFreeFeatures" placeholder="Basic AI analysis
Barcode scanning
Food logging
Weekly summary" style="min-height: 120px;"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="editProFeatures" style="color: #f59e0b;">
                                <img src="assets/suite-logo-new.png" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 4px;"> AI Features <span style="font-weight: 400; color: #6b7280;">(one per line)</span>
                            </label>
                            <textarea id="editProFeatures" placeholder="Advanced AI Pro model
Photo recognition
Micronutrient tracking
Personalized insights" style="min-height: 120px;"></textarea>
                        </div>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeEditModal()">Cancel</button>
                    <button type="submit" class="btn-save">üíæ Save Changes</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Edit Modal Styles */
        .edit-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 20px;
        }
        .edit-modal-overlay.active { display: flex; }
        .edit-modal {
            background: white;
            border-radius: 24px;
            padding: 32px;
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .edit-modal h3 {
            font-size: 1.4rem;
            font-weight: 800;
            color: #2d1b4e;
            margin-bottom: 24px;
        }
        .edit-modal .form-group { margin-bottom: 20px; }
        .edit-modal .form-group label {
            display: block;
            font-weight: 700;
            color: #2d1b4e;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .edit-modal .form-group input,
        .edit-modal .form-group select,
        .edit-modal .form-group textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            font-family: inherit;
            box-sizing: border-box;
        }
        .edit-modal .form-group input:focus,
        .edit-modal .form-group select:focus,
        .edit-modal .form-group textarea:focus {
            outline: none;
            border-color: #ff9500;
        }
        .edit-modal .form-group textarea { min-height: 100px; resize: vertical; }
        .edit-modal .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .edit-modal .modal-actions { display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px; }
        .edit-modal .btn-cancel {
            background: #f3f4f6;
            color: #5a4a6f;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        .edit-modal .btn-save {
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: 700;
            cursor: pointer;
        }
        .edit-modal .upload-zone {
            border: 2px dashed #d1d5db;
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .edit-modal .upload-zone:hover { border-color: #ff9500; background: #fff8f0; }
        .edit-modal .upload-zone.small { min-height: 80px; padding: 12px; }
        .edit-modal .upload-preview {
            max-width: 100%;
            max-height: 150px;
            object-fit: contain;
            border-radius: 8px;
        }
        .edit-modal .upload-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            color: #9ca3af;
            font-size: 0.85rem;
        }
        .edit-modal .screenshots-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }
        .edit-modal .upload-zone .remove-btn {
            position: absolute;
            top: 4px;
            right: 4px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.9);
            color: white;
            border: none;
            font-size: 14px;
            line-height: 1;
            cursor: pointer;
            display: none;
            z-index: 10;
            padding: 0;
        }
        .edit-modal .upload-zone .remove-btn:hover {
            background: #dc2626;
        }
    </style>

    <style>
        /* Crypto Deposit Modal Styles */
        .network-warning {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 16px;
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid rgba(239, 68, 68, 0.3);
            border-radius: 10px;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }

        .switch-network-btn {
            margin-left: auto;
            padding: 6px 12px;
            background: #ef4444;
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .wallet-balances-display {
            background: var(--bg-tertiary);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 20px;
        }

        .balance-header {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 12px;
        }

        .crypto-balance-row {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .crypto-balance-row:last-child {
            border-bottom: none;
        }

        .crypto-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .crypto-icon.eth {
            background: rgba(98, 126, 234, 0.2);
        }

        .crypto-icon.usdc {
            background: rgba(39, 117, 202, 0.2);
        }

        .crypto-info {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .crypto-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .crypto-balance {
            font-size: 1.1rem;
            font-weight: 700;
            font-family: monospace;
        }

        .crypto-usd {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .asset-selector {
            margin-bottom: 20px;
        }

        .asset-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
            margin-bottom: 10px;
        }

        .asset-tabs {
            display: flex;
            gap: 8px;
        }

        .asset-tab {
            flex: 1;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            color: var(--text-secondary);
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .asset-tab:hover {
            border-color: var(--accent-primary);
        }

        .asset-tab.active {
            background: rgba(168, 85, 247, 0.15);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .deposit-amount-section {
            margin-bottom: 20px;
        }

        .crypto-amount-input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }

        .amount-adjust-btn {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            border: 2px solid var(--accent-primary);
            background: transparent;
            color: var(--accent-primary);
            font-size: 1.5rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .amount-adjust-btn:hover {
            background: var(--accent-primary);
            color: white;
            transform: scale(1.05);
        }

        .amount-adjust-btn:active {
            transform: scale(0.95);
        }

        .crypto-amount-input {
            flex: 1;
            display: flex;
            align-items: center;
            background: var(--bg-tertiary);
            border: 2px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
        }

        .crypto-amount-input:focus-within {
            border-color: var(--accent-primary);
        }

        .crypto-amount-input input {
            flex: 1;
            padding: 14px 16px;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1.2rem;
            font-weight: 600;
        }

        .crypto-amount-input input:focus {
            outline: none;
        }

        .input-asset {
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.05);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .percentage-buttons {
            display: flex;
            gap: 8px;
        }

        .percentage-buttons button {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .percentage-buttons button:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .suite-receive-preview {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, rgba(232, 93, 59, 0.15), rgba(249, 115, 22, 0.1));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .receive-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .receive-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--accent-primary);
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .receive-usd {
            font-size: 1.1rem;
            font-weight: 500;
            color: #22c55e;
        }

        .receive-note {
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-top: 6px;
        }

        .crypto-deposit-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #22c55e, #10b981);
            border: none;
            border-radius: 12px;
            color: white;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .crypto-deposit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(34, 197, 94, 0.3);
        }

        .crypto-deposit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* Notification Modal Styles */
        .notification-modal {
            text-align: center;
            padding: 30px;
            max-width: 400px;
        }

        .notification-icon {
            font-size: 3rem;
            margin-bottom: 16px;
        }

        .notification-modal h2 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-size: 1.5rem;
        }

        .notification-modal p {
            color: var(--text-secondary);
            margin-bottom: 16px;
            line-height: 1.5;
        }

        .notification-details {
            background: var(--bg-tertiary);
            border-radius: 10px;
            padding: 12px 16px;
            margin-bottom: 20px;
            font-family: monospace;
            font-size: 0.85rem;
            color: var(--text-secondary);
            word-break: break-all;
        }

        .notification-details:empty {
            display: none;
        }

        .notification-btn {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, #ff9500, #ff6b9d);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .notification-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(255, 149, 0, 0.3);
        }
    </style>

    <!-- Cash Out Modal -->
    <div class="modal-overlay" id="withdrawModal">
        <div class="modal">
            <div class="modal-header">
                <h2>?? Cash Out</h2>
                <button class="modal-close" onclick="closeModal('withdrawModal')">?</button>
            </div>

            <div class="balance-display">
                <div class="balance-display-value" id="cashOutBalance">0 SUITE</div>
                <div class="balance-display-label">Available to cash out ? ? $0.00</div>
            </div>

            <div class="amount-selector">
                <div class="amount-label">How much would you like to cash out?</div>
                <div class="custom-amount">
                    <input type="number" id="withdrawAmount" placeholder="Amount in SUITE" value="0">
                    <button class="amount-option" onclick="document.getElementById('withdrawAmount').value = 0"
                        style="padding: 12px 20px;">MAX</button>
                </div>
            </div>

            <div class="payment-options">
                <div class="payment-option" onclick="handleWithdraw('paypal')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">PayPal</div>
                        <div class="payment-desc">Instant to your PayPal email</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('card')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Original Card</div>
                        <div class="payment-desc">Refund to card you deposited with</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('giftcard')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Gift Card</div>
                        <div class="payment-desc">Amazon, Visa Prepaid, more</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('crypto')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Crypto Wallet</div>
                        <div class="payment-desc">Send USDC to any address</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
                <div class="payment-option" onclick="handleWithdraw('bank')">
                    <span class="payment-icon"></span>
                    <div class="payment-info">
                        <div class="payment-name">Bank Transfer</div>
                        <div class="payment-desc">Interac e-Transfer (Canada) or Wire</div>
                    </div>
                    <span class="payment-arrow">?</span>
                </div>
            </div>

            <p class="fee-notice">0.5% withdrawal fee applies</p>
        </div>
    </div>


    <script>
        // ============================================
        // ADMIN WALLET CONFIGURATION
        // ============================================
        const ADMIN_WALLETS = [
            '0x92D67D8ad8B986e78b369bE0272E121AE5ACAd59'.toLowerCase(),  // Laptop MetaMask
            '0xDEfc3AE5a990206101463d208E7e1446c58a72bD'.toLowerCase(),  // PC MetaMask  
            '0x53cf707eF11cD213D8f1710996C22049a45B8215'.toLowerCase()   // PC Hardware Wallet
        ];

        // TreasuryVault contract address (update after deployment)
        const TREASURY_VAULT_ADDRESS = '0x0000000000000000000000000000000000000000'; // TODO: Update after deploy

        // TreasuryVault ABI (simplified)
        const TREASURY_VAULT_ABI = [
            'function isAdmin(address) view returns (bool)',
            'function treasuryValue() view returns (uint256)',
            'function estimatedAPY() view returns (uint256)',
            'function lastValueUpdate() view returns (uint256)',
            'function withdrawalsPaused() view returns (bool)',
            'function depositsPaused() view returns (bool)',
            'function updateTreasuryValue(uint256 newValue)',
            'function updateEstimatedAPY(uint256 newAPY)',
            'function withdrawToAdmin(uint256 amount)',
            'function depositFromAdmin() payable',
            'function pauseWithdrawals(bool paused)',
            'function pauseDeposits(bool paused)',
            'function getPendingWithdrawalsCount() view returns (uint256)'
        ];

        let treasuryVaultContract = null;

        // Check if connected wallet is admin
        function isAdminWallet(address) {
            if (!address) return false;
            return ADMIN_WALLETS.includes(address.toLowerCase());
        }

        // Show/hide admin dashboard based on connected wallet
        function updateAdminDashboardVisibility() {
            const adminDashboard = document.getElementById('adminDashboard');
            if (adminDashboard && walletAddress) {
                if (isAdminWallet(walletAddress)) {
                    adminDashboard.style.display = 'block';
                    loadAdminData();
                } else {
                    adminDashboard.style.display = 'none';
                }
            }
        }

        // Load admin dashboard data
        async function loadAdminData() {
            try {
                // For now, show placeholder data until contract is deployed
                // Once deployed, this will read from the actual contract
                document.getElementById('adminReportedValue').textContent = '$0';
                document.getElementById('adminContractBalance').textContent = '0 ETH';
                document.getElementById('adminEstimatedAPY').textContent = '0%';
                document.getElementById('adminLastUpdated').textContent = 'Not deployed';

                // Update liquid reserve display with actual contract balance
                if (provider) {
                    try {
                        const balance = await provider.getBalance(TREASURY_VAULT_ADDRESS);
                        const ethBalance = parseFloat(ethers.formatEther(balance));
                        document.getElementById('adminContractBalance').textContent = `${ethBalance.toFixed(4)} ETH`;
                        document.getElementById('liquidReserveValue').textContent = `$${(ethBalance * 2500).toLocaleString()}`; // Rough ETH price
                    } catch (e) {
                        // Contract not deployed yet
                    }
                }
            } catch (error) {
                console.error('Error loading admin data:', error);
            }
        }

        // Update treasury value and APY
        async function updateTreasuryValues() {
            const newValue = document.getElementById('adminNewValue')?.value;
            const newAPY = document.getElementById('adminNewAPY')?.value;

            if (!newValue && !newAPY) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a value or APY to update');
                return;
            }

            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }

            try {
                showNotification('‚è≥', 'Updating', 'Please confirm the transaction...');

                // For now, just update the UI (contract calls will be added after deployment)
                if (newValue) {
                    document.getElementById('adminReportedValue').textContent = `$${parseFloat(newValue).toLocaleString()}`;
                    document.getElementById('adminNewValue').value = '';
                }
                if (newAPY) {
                    document.getElementById('adminEstimatedAPY').textContent = `${newAPY}%`;
                    document.getElementById('adminNewAPY').value = '';
                }
                document.getElementById('adminLastUpdated').textContent = new Date().toLocaleString();

                showNotification('‚úÖ', 'Updated', 'Treasury values updated (contract integration pending)');
            } catch (error) {
                console.error('Update error:', error);
                showNotification('‚ùå', 'Error', error.message || 'Update failed');
            }
        }

        // Withdraw ETH to admin wallet
        async function adminWithdraw() {
            const amount = document.getElementById('adminWithdrawAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }

            try {
                showNotification('‚è≥', 'Withdrawing', 'Please confirm the transaction...');

                // Contract call will be added after deployment
                showNotification('‚ö†Ô∏è', 'Pending', 'Contract not deployed yet. Deploy TreasuryVault first.');
                document.getElementById('adminWithdrawAmount').value = '';
            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('‚ùå', 'Error', error.message || 'Withdrawal failed');
            }
        }

        // Deposit ETH from admin wallet
        async function adminDeposit() {
            const amount = document.getElementById('adminDepositAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }

            try {
                showNotification('‚è≥', 'Depositing', 'Please confirm the transaction...');

                // Contract call will be added after deployment
                showNotification('‚ö†Ô∏è', 'Pending', 'Contract not deployed yet. Deploy TreasuryVault first.');
                document.getElementById('adminDepositAmount').value = '';
            } catch (error) {
                console.error('Deposit error:', error);
                showNotification('‚ùå', 'Error', error.message || 'Deposit failed');
            }
        }

        // Toggle pause withdrawals
        async function togglePauseWithdrawals() {
            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }
            showNotification('‚ö†Ô∏è', 'Pending', 'Contract not deployed yet');
        }

        // Toggle pause deposits
        async function togglePauseDeposits() {
            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }
            showNotification('‚ö†Ô∏è', 'Pending', 'Contract not deployed yet');
        }

        // Process all ready withdrawals
        async function processAllWithdrawals() {
            if (!signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet');
                return;
            }
            showNotification('‚ö†Ô∏è', 'Pending', 'Contract not deployed yet');
        }

        // Add new position (placeholder)
        function addPosition() {
            showNotification('üìç', 'Positions', 'Position tracking is manual - update values in the UI');
        }

        // Tab switching function
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
                tab.classList.remove('active');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.wallet-tab').forEach(tab => {
                tab.classList.remove('active');
            });

            // Show the selected tab content
            const selectedTab = document.getElementById('tab-' + tabName);
            if (selectedTab) {
                selectedTab.style.display = 'block';
                selectedTab.classList.add('active');
            }

            // Add active class to clicked tab
            event.target.classList.add('active');

            // Load staking data when switching to staking tab
            if (tabName === 'staking') {
                loadStakingData();
                loadAppsForStaking();
            }
        }

        // ========== STAKING SYSTEM ==========

        // AppStaking Contract on Base Mainnet
        const APP_STAKING_ADDRESS = '0x6074E2aD3871Bd0c6981b597280c544b68C1AF4c';
        const APP_STAKING_ABI = [
            "function stake(uint256 amount) external",
            "function withdraw(uint256 amount) external",
            "function allocate(bytes32 appId, uint256 amount) external",
            "function deallocate(bytes32 appId, uint256 amount) external",
            "function getUserStake(address user) view returns (uint256 totalStaked, uint256 unallocatedPower, uint256 allocatedPower)",
            "function getUserAllocation(address user, bytes32 appId) view returns (uint256)",
            "function getAppTier(bytes32 appId) view returns (uint256)",
            "function getAppProgress(bytes32 appId) view returns (uint256 currentTier, uint256 currentPower, uint256 nextThreshold, uint256 progressBps)"
        ];

        let stakingContract = null;

        // Initialize staking contract when wallet connects
        async function initStakingContract() {
            if (!window.ethereum || !signer) return null;
            try {
                stakingContract = new ethers.Contract(APP_STAKING_ADDRESS, APP_STAKING_ABI, signer);
                return stakingContract;
            } catch (error) {
                console.error('Error initializing staking contract:', error);
                return null;
            }
        }

        // Load apps for the staking dropdown (populates BOTH main and tab dropdowns)
        async function loadAppsForStaking() {
            const selectMain = document.getElementById('stakingAppSelectMain');
            const selectTab = document.getElementById('stakingAppSelect');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?select=id,name,slug&status=in.(published,approved,featured)&order=name`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const apps = await response.json();

                // Populate both dropdowns
                [selectMain, selectTab].forEach(select => {
                    if (!select) return;
                    select.innerHTML = '<option value="">Choose an app...</option>';
                    apps.forEach(app => {
                        const option = document.createElement('option');
                        option.value = app.slug;
                        option.textContent = app.name;
                        select.appendChild(option);
                    });
                });
            } catch (error) {
                console.error('Error loading apps for staking:', error);
            }
        }

        // Combined Stake + Allocate for main view quick action
        async function stakeAndAllocate() {
            const amountInput = document.getElementById('stakeAmountMain');
            const appSelect = document.getElementById('stakingAppSelectMain');
            const amount = amountInput?.value;
            const appSlug = appSelect?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a stake amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('‚è≥', 'Staking', 'Please approve SUITE spending...');

                // First approve SUITE spending
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);
                const amountWei = ethers.parseEther(amount);

                const allowance = await suiteToken.allowance(walletAddress, APP_STAKING_ADDRESS);
                if (allowance < amountWei) {
                    const approveTx = await suiteToken.approve(APP_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                showNotification('‚è≥', 'Staking', 'Please confirm the stake transaction...');

                if (!stakingContract) await initStakingContract();
                const stakeTx = await stakingContract.stake(amountWei);
                await stakeTx.wait();

                // If an app is selected, allocate to it
                if (appSlug) {
                    showNotification('‚è≥', 'Allocating', 'Please confirm allocation...');
                    const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                    const allocateTx = await stakingContract.allocate(appId, amountWei);
                    await allocateTx.wait();
                    showNotification('‚úÖ', 'Success', `Staked ${amount} SUITE and allocated to ${appSelect.options[appSelect.selectedIndex].text}!`);
                } else {
                    showNotification('‚úÖ', 'Success', `Staked ${amount} SUITE!`);
                }

                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Stake error:', error);
                showNotification('‚ùå', 'Error', error.reason || error.message || 'Staking failed');
            }
        }

        // Load apps on page load
        document.addEventListener('DOMContentLoaded', function () {
            loadAppsForStaking();
        });

        // Load user's staking data
        async function loadStakingData() {
            const updateEl = (id, text) => {
                const el = document.getElementById(id);
                if (el) el.textContent = text;
            };

            if (!walletAddress) {
                updateEl('stakingTotalStaked', '0 SUITE');
                updateEl('stakingAllocated', '0 SUITE');
                updateEl('stakingAvailable', '0 SUITE');
                updateEl('stakingTotalStakedMain', '0 SUITE');
                return;
            }

            try {
                if (!stakingContract) await initStakingContract();
                if (!stakingContract) return;

                const [totalStaked, unallocatedPower, allocatedPower] = await stakingContract.getUserStake(walletAddress);

                const totalFormatted = `${formatNumber(ethers.formatEther(totalStaked))} SUITE`;
                const allocatedFormatted = `${formatNumber(ethers.formatEther(allocatedPower))} SUITE`;
                const availableFormatted = `${formatNumber(ethers.formatEther(unallocatedPower))} SUITE`;

                // Update both main view and tab view
                updateEl('stakingTotalStaked', totalFormatted);
                updateEl('stakingAllocated', allocatedFormatted);
                updateEl('stakingAvailable', availableFormatted);
                updateEl('stakingTotalStakedMain', totalFormatted);

                // Load allocations
                await loadUserAllocations();
            } catch (error) {
                console.error('Error loading staking data:', error);
            }
        }

        // Load user's allocations
        async function loadUserAllocations() {
            const listEl = document.getElementById('stakingAllocationsList');
            if (!listEl || !walletAddress) return;

            try {
                // Fetch from Supabase (cached data)
                const response = await fetch(`${SUPABASE_URL}/rest/v1/app_stakes?staker_address=eq.${walletAddress.toLowerCase()}&select=*,apps(name,slug,icon_url)`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const allocations = await response.json();

                if (!allocations || allocations.length === 0) {
                    listEl.innerHTML = '<div style="text-align: center; padding: 24px; color: #9ca3af; font-size: 0.9rem;">No allocations yet. Deposit ETH/USDC and stake LP tokens to support an app!</div>';
                    return;
                }

                listEl.innerHTML = allocations.map(alloc => `
                    <div style="display: flex; align-items: center; gap: 12px; padding: 12px 16px; background: rgba(168, 85, 247, 0.05); border-radius: 12px;">
                        <img src="${alloc.apps?.icon_url || 'assets/suite-logo-new.png'}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;" onerror="this.src='assets/suite-logo-new.png'">
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: #2d1b4e;">${alloc.apps?.name || 'Unknown App'}</div>
                            <div style="font-size: 0.8rem; color: #6b7280;">${formatNumber(alloc.amount_staked)} SUITE allocated</div>
                        </div>
                        <button onclick="deallocatePower('${alloc.apps?.slug}', ${alloc.amount_staked})" style="padding: 6px 12px; background: white; color: #ef4444; border: 1px solid #ef4444; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer;">Remove</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Error loading allocations:', error);
                listEl.innerHTML = '<div style="text-align: center; padding: 24px; color: #ef4444; font-size: 0.9rem;">Error loading allocations</div>';
            }
        }

        // Stake SUITE tokens
        async function stakeSUITE() {
            const amountInput = document.getElementById('stakeAmount');
            const amount = amountInput?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('‚è≥', 'Staking', 'Please approve SUITE spending...');

                // First approve SUITE spending
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);
                const amountWei = ethers.parseEther(amount);

                const allowance = await suiteToken.allowance(walletAddress, APP_STAKING_ADDRESS);
                if (allowance < amountWei) {
                    const approveTx = await suiteToken.approve(APP_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                showNotification('‚è≥', 'Staking', 'Please confirm the stake transaction...');

                if (!stakingContract) await initStakingContract();
                const tx = await stakingContract.stake(amountWei);
                await tx.wait();

                showNotification('‚úÖ', 'Success', `Staked ${amount} SUITE!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Stake error:', error);
                showNotification('‚ùå', 'Error', error.reason || error.message || 'Staking failed');
            }
        }

        // Withdraw staked SUITE
        async function withdrawStake() {
            const amountInput = document.getElementById('withdrawStakeAmount');
            const amount = amountInput?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('‚è≥', 'Withdrawing', 'Please confirm the withdrawal...');

                if (!stakingContract) await initStakingContract();
                const amountWei = ethers.parseEther(amount);
                const tx = await stakingContract.withdraw(amountWei);
                await tx.wait();

                showNotification('‚úÖ', 'Success', `Withdrawn ${amount} SUITE!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Withdraw error:', error);
                showNotification('‚ùå', 'Error', error.reason || error.message || 'Withdrawal failed');
            }
        }

        // Allocate power to an app
        async function allocatePower() {
            const appSelect = document.getElementById('stakingAppSelect');
            const amountInput = document.getElementById('allocateAmount');
            const appSlug = appSelect?.value;
            const amount = amountInput?.value;

            if (!appSlug) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please select an app');
                return;
            }

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter a valid amount');
                return;
            }

            if (!walletAddress || !signer) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please connect your wallet first');
                return;
            }

            try {
                showNotification('‚è≥', 'Allocating', 'Please confirm the allocation...');

                if (!stakingContract) await initStakingContract();

                // Convert app slug to bytes32
                const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                const amountWei = ethers.parseEther(amount);

                const tx = await stakingContract.allocate(appId, amountWei);
                await tx.wait();

                showNotification('‚úÖ', 'Success', `Allocated ${amount} power to ${appSelect.options[appSelect.selectedIndex].text}!`);
                amountInput.value = '';
                await loadStakingData();
            } catch (error) {
                console.error('Allocate error:', error);
                showNotification('‚ùå', 'Error', error.reason || error.message || 'Allocation failed');
            }
        }

        // Deallocate power from an app
        async function deallocatePower(appSlug, amount) {
            if (!confirm(`Remove ${formatNumber(amount)} power from this app?`)) return;

            try {
                showNotification('‚è≥', 'Removing', 'Please confirm the deallocation...');

                if (!stakingContract) await initStakingContract();

                const appId = ethers.keccak256(ethers.toUtf8Bytes(appSlug));
                const amountWei = ethers.parseEther(amount.toString());

                const tx = await stakingContract.deallocate(appId, amountWei);
                await tx.wait();

                showNotification('‚úÖ', 'Success', 'Power removed!');
                await loadStakingData();
            } catch (error) {
                console.error('Deallocate error:', error);
                showNotification('‚ùå', 'Error', error.reason || error.message || 'Deallocation failed');
            }
        }

        // Helper to format numbers
        function formatNumber(num) {
            const n = parseFloat(num);
            if (isNaN(n)) return '0';
            if (n >= 1000000) return (n / 1000000).toFixed(2) + 'M';
            if (n >= 1000) return (n / 1000).toFixed(2) + 'K';
            return n.toFixed(2);
        }

        // Wallet Connection Logic
        const walletDashboard = document.getElementById('walletDashboard');
        const connectBtn = document.getElementById('connectWalletBtn');
        const disconnectBtn = document.getElementById('disconnectBtn');
        const addressDisplay = document.getElementById('walletAddressDisplay');
        const connectedInfo = document.getElementById('walletConnectedInfo');

        // Check if MetaMask is installed
        const isMetaMaskInstalled = () => typeof window.ethereum !== 'undefined';

        // Connect wallet
        connectBtn.addEventListener('click', async () => {
            if (!isMetaMaskInstalled()) {
                alert('Please install MetaMask to connect your wallet!');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });

                if (accounts.length > 0) {
                    const address = accounts[0];
                    showConnectedState(address);
                }
            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        });

        // Disconnect wallet
        disconnectBtn.addEventListener('click', () => {
            showDisconnectedState();
        });

        function showConnectedState(address) {
            const shortAddress = `${address.slice(0, 6)}...${address.slice(-4)}`;
            addressDisplay.textContent = shortAddress;

            // Show connected UI, hide connect button
            connectBtn.style.display = 'none';
            connectedInfo.style.display = 'flex';
            disconnectBtn.style.display = 'block';

            // Set initial balances to 0 (real values come from fetchTreasuryStats)
            document.getElementById('availableBalance').textContent = '0';
            document.getElementById('stakedBalance').textContent = '0';
            document.getElementById('totalValue').textContent = '$0.00';

            // Fetch real balance from chain
            fetchUserSuiteBalance(address);

            // Fetch and show wallet ETH balance
            fetchWalletEthBalance(address);

            // Check if connected wallet is the contract owner
            checkIfOwner(address);
        }

        async function fetchWalletEthBalance(address) {
            try {
                if (!window.ethereum) return;

                // Get ETH balance
                const balanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                });

                const ethBalance = parseInt(balanceHex, 16) / 1e18;
                const usdValue = ethBalance * ETH_PRICE_USD;

                // Update UI
                document.getElementById('walletEthBalance').textContent = `${ethBalance.toFixed(6)} ETH`;
                document.getElementById('walletEthValue').textContent = `~$${usdValue.toFixed(2)}`;
                document.getElementById('walletEthSection').style.display = 'block';

            } catch (error) {
                console.error('Error fetching wallet ETH balance:', error);
            }
        }

        async function fetchUserSuiteBalance(address) {
            try {
                if (!window.ethereum) return;

                const provider = new ethers.BrowserProvider(window.ethereum);
                const suiteContract = new ethers.Contract(SUITE_TOKEN_ADDRESS, SUITE_ABI, provider);

                const balance = await suiteContract.balanceOf(address);
                const formattedBalance = ethers.formatUnits(balance, 18);
                const numericBalance = parseFloat(formattedBalance);
                const displayBalance = numericBalance.toLocaleString(undefined, { maximumFractionDigits: 2 });

                document.getElementById('availableBalance').textContent = displayBalance;

                // Calculate USD value based on backing rate from treasury
                // Get backing rate from displayed value or calculate
                const backingRateText = document.getElementById('backingRate').textContent;
                const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;

                // Total Value = balance * backing rate (after 0.5% fee)
                const totalUsdValue = numericBalance * backingRate * 0.995;
                document.getElementById('totalValue').textContent = `$${totalUsdValue.toFixed(2)}`;

            } catch (error) {
                console.log('Could not fetch SUITE balance:', error);
            }
        }

        // Add SUITE token to MetaMask
        async function addSuiteToWallet() {
            if (!isMetaMaskInstalled()) {
                showNotification('??', 'MetaMask Required', 'Please install MetaMask to add tokens to your wallet.');
                return;
            }

            try {
                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: SUITE_TOKEN_ADDRESS,
                            symbol: 'SUITE',
                            decimals: 18,
                            image: 'https://your-domain.com/suite-icon.png' // Optional: Add your logo URL
                        },
                    },
                });

                if (wasAdded) {
                    showNotification('?', 'Token Added!', 'SUITE has been added to your MetaMask wallet.');
                }
            } catch (error) {
                console.error('Error adding token:', error);
                showNotification('?', 'Failed to Add Token', error.message || 'Could not add SUITE to wallet.');
            }
        }

        function showDisconnectedState() {
            // Show connect button, hide connected UI
            connectBtn.style.display = 'block';
            connectedInfo.style.display = 'none';
            disconnectBtn.style.display = 'none';

            // Hide admin panel
            document.getElementById('adminPanel').style.display = 'none';

            // Reset balances to 0 but keep dashboard visible
            document.getElementById('availableBalance').textContent = '0';
            document.getElementById('stakedBalance').textContent = '0';
            document.getElementById('totalValue').textContent = '$0.00';
        }

        // Check if already connected
        async function checkConnection() {
            if (isMetaMaskInstalled()) {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    showConnectedState(accounts[0]);
                }
            }
        }

        // Listen for account changes
        if (isMetaMaskInstalled()) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    showDisconnectedState();
                } else {
                    showConnectedState(accounts[0]);
                }
            });
        }

        // Check connection on load
        checkConnection();

        // Modal Functions
        let selectedAmount = 50;

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        // Custom notification modal functions
        function showNotification(icon, title, message, details = '') {
            document.getElementById('notificationIcon').textContent = icon;
            document.getElementById('notificationTitle').textContent = title;
            document.getElementById('notificationMessage').textContent = message;
            document.getElementById('notificationDetails').textContent = details;
            openModal('notificationModal');
        }

        function closeNotification() {
            closeModal('notificationModal');
            // Refresh balances after closing notification
            checkConnection();
            fetchTreasuryStats();
        }

        // Close modal when clicking overlay
        document.querySelectorAll('.modal-overlay').forEach(overlay => {
            overlay.addEventListener('click', (e) => {
                if (e.target === overlay) {
                    overlay.classList.remove('active');
                }
            });
        });

        function selectAmount(amount, element) {
            selectedAmount = amount;
            document.querySelectorAll('.amount-option').forEach(opt => opt.classList.remove('selected'));
            element.classList.add('selected');
            const customAmountEl = document.getElementById('customAmount');
            if (customAmountEl) customAmountEl.value = '';
            updateSuitePreview();
        }

        function updateSuitePreview() {
            const customAmountEl = document.getElementById('customAmount');
            const suitePreviewEl = document.getElementById('suitePreviewValue');
            if (!suitePreviewEl) return;

            const customAmount = customAmountEl ? parseFloat(customAmountEl.value) : '';
            const amount = customAmount ? parseFloat(customAmount) : selectedAmount;
            const suiteAmount = (amount * 1000).toLocaleString();
            suitePreviewEl.textContent = suiteAmount + ' SUITE';
        }

        function handlePayment(method) {
            // Get amount safely (customAmount might not exist in simplified modal)
            const customAmountEl = document.getElementById('customAmount');
            const amount = customAmountEl ? (parseFloat(customAmountEl.value) || selectedAmount) : selectedAmount;

            switch (method) {
                case 'card':
                    alert(`[STRIPE] Would open Stripe checkout for $${amount}\n\nThis will:\n1. Charge your card $${amount}\n2. Deposit to treasury\n3. Mint ${(amount * 1000).toLocaleString()} SUITE to your wallet\n4. ONE popup (approval + deposit bundled)`);
                    closeModal('depositModal');
                    break;
                case 'apple':
                    alert(`[APPLE PAY] Would trigger Apple Pay for $${amount}`);
                    closeModal('depositModal');
                    break;
                case 'crypto':
                    // Open the new crypto deposit modal
                    closeModal('depositModal');
                    openCryptoDepositModal();
                    break;
            }
        }

        // Open crypto deposit modal
        function openCryptoDepositModal() {
            showCryptoDeposit();
        }

        // ===== CRYPTO DEPOSIT FUNCTIONS =====

        // Configuration - DEPLOYED CONTRACTS
        const BASE_CHAIN_ID = '0x2105'; // Base Mainnet: 8453
        const BASE_SEPOLIA_CHAIN_ID = '0x14A34'; // Base Sepolia: 84532
        const ETH_PRICE_USD = 3650; // For UI display only - V4 uses proportional shares

        // ===== DEPLOYED SUITE CONTRACTS =====
        const SUITE_TOKEN_ADDRESS = '0xE6892803DF59D79cFB4794e7da9549df4eE70f71';
        const TREASURY_ADDRESS = '0xf121C51E18aD8f8C9B38EEAA377aD4393E16e3d1'; // TreasuryV4 with 0x
        const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // Base Mainnet USDC

        // ===== 0x API CONFIG =====
        // API key is optional - 0x has free public access
        // Get a key from https://dashboard.0x.org for higher rate limits
        const ZERO_X_API_KEY = ''; // Optional - leave empty for free tier
        const ZERO_X_API_URL = 'https://base.api.0x.org'; // Base mainnet endpoint

        // TreasuryV4 ABI (proportional share model with 0x)
        const TREASURY_ABI = [
            'function depositETH() external payable',
            'function depositWithSwap(address sellToken, uint256 sellAmount, bytes calldata swapCalldata) external',
            'function withdraw(uint256 suiteAmount) external',
            'function previewDeposit(uint256 ethAmount) external view returns (uint256)',
            'function previewWithdraw(uint256 suiteAmount) external view returns (uint256)',
            'function getTreasuryStats() external view returns (uint256 treasuryETH, uint256 totalSupply, uint256 suitePerETH)',
            'function totalTreasuryETH() external view returns (uint256)'
        ];

        // SUITE Token ABI
        const SUITE_ABI = [
            'function totalSupply() external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)'
        ];

        // ERC-20 ABI for approvals and balances
        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) external returns (bool)',
            'function allowance(address owner, address spender) external view returns (uint256)',
            'function balanceOf(address account) external view returns (uint256)',
            'function decimals() external view returns (uint8)'
        ];

        // Function to get 0x swap quote
        async function get0xQuote(sellToken, buyToken, sellAmount) {
            const params = new URLSearchParams({
                sellToken: sellToken,
                buyToken: buyToken,
                sellAmount: sellAmount,
                takerAddress: await getConnectedAddress()
            });

            // Build headers - only include API key if provided
            const headers = {};
            if (ZERO_X_API_KEY) {
                headers['0x-api-key'] = ZERO_X_API_KEY;
            }

            const response = await fetch(`${ZERO_X_API_URL}/swap/v1/quote?${params}`, { headers });

            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.reason || 'Failed to get 0x quote');
            }

            return await response.json();
        }

        async function getConnectedAddress() {
            const accounts = await window.ethereum.request({ method: 'eth_accounts' });
            return accounts[0];
        }

        let selectedCryptoAsset = 'eth';
        let walletBalances = { eth: 0, usdc: 0 };

        // Fetch and display live treasury values
        async function fetchTreasuryStats() {
            try {
                // Get ETH balance of treasury contract directly
                const treasuryBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [TREASURY_ADDRESS, 'latest']
                });
                const treasuryEth = treasuryBalanceHex ? parseInt(treasuryBalanceHex, 16) / 1e18 : 0;

                // Get total SUITE supply
                const supplyData = '0x18160ddd'; // totalSupply()
                const supplyHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: SUITE_TOKEN_ADDRESS, data: supplyData }, 'latest']
                });
                const totalSupply = supplyHex && supplyHex !== '0x' ? parseInt(supplyHex, 16) / 1e18 : 0;

                // Calculate total treasury value in USD
                const treasuryValueUsd = isNaN(treasuryEth) ? 0 : treasuryEth * ETH_PRICE_USD;
                const displayEth = isNaN(treasuryEth) ? 0 : treasuryEth;
                const displaySupply = isNaN(totalSupply) ? 0 : totalSupply;

                // Update UI - stacked display with precision
                document.getElementById('treasuryValueUsd').textContent = '$' + treasuryValueUsd.toFixed(6);
                document.getElementById('treasuryValueEth').textContent = displayEth.toFixed(10) + ' ETH';
                document.getElementById('totalSupply').textContent =
                    displaySupply.toLocaleString() + ' SUITE';

                // Calculate backing rate (floor price)
                const backingRate = displaySupply > 0 ? treasuryValueUsd / displaySupply : 0;
                document.getElementById('backingRate').textContent =
                    '$' + backingRate.toFixed(6) + '/SUITE';

                // Calculate market cap (floor price * supply = treasury value for now)
                // When DEX is live, this would be DEX price * supply
                const marketCap = treasuryValueUsd; // For now, market cap = treasury value
                document.getElementById('marketCap').textContent =
                    '$' + marketCap.toFixed(2);

                // Fees collected (placeholder - would come from contract events)
                document.getElementById('feesCollected').textContent = '$0.00';

            } catch (error) {
                console.error('Error fetching treasury stats:', error);
                // Show zeros if contract not ready
                document.getElementById('treasuryValueUsd').textContent = '$0.000000';
                document.getElementById('treasuryValueEth').textContent = '0.0000000000 ETH';
                document.getElementById('totalSupply').textContent = '0 SUITE';
                document.getElementById('backingRate').textContent = '$0.000000/SUITE';
            }
        }

        async function openCryptoDepositModal() {
            // First, just open the modal immediately
            openModal('cryptoDepositModal');

            // Then try to fetch data (don't block modal opening)
            try {
                await fetchWalletBalances();
            } catch (e) { console.log('fetchWalletBalances error:', e); }

            try {
                await checkNetwork();
            } catch (e) { console.log('checkNetwork error:', e); }

            try {
                await fetchTreasuryStats();
            } catch (e) { console.log('fetchTreasuryStats error:', e); }

            try {
                updateCryptoPreview();
            } catch (e) { console.log('updateCryptoPreview error:', e); }
        }

        async function checkNetwork() {
            if (!isMetaMaskInstalled()) return;

            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                const isBase = chainId === BASE_CHAIN_ID || chainId === BASE_SEPOLIA_CHAIN_ID;

                document.getElementById('networkWarning').style.display = isBase ? 'none' : 'flex';
            } catch (error) {
                console.error('Error checking network:', error);
            }
        }

        async function switchToBase() {
            try {
                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BASE_CHAIN_ID }],
                });
                document.getElementById('networkWarning').style.display = 'none';
                await fetchWalletBalances();
            } catch (switchError) {
                // Chain not added to MetaMask - add it
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BASE_CHAIN_ID,
                                chainName: 'Base',
                                nativeCurrency: { name: 'Ethereum', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org'],
                            }],
                        });
                    } catch (addError) {
                        console.error('Error adding Base network:', addError);
                    }
                }
            }
        }

        async function fetchWalletBalances() {
            if (!isMetaMaskInstalled()) return;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                const address = accounts[0];

                // Fetch ETH balance
                const ethBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [address, 'latest']
                });
                const ethBalance = parseInt(ethBalanceHex, 16) / 1e18;
                walletBalances.eth = ethBalance;

                // Update UI
                document.getElementById('ethBalance').textContent = ethBalance.toFixed(4);
                document.getElementById('ethUsdValue').textContent = `~$${(ethBalance * ETH_PRICE_USD).toFixed(2)}`;

                // Fetch USDC balance (ERC-20)
                try {
                    const usdcBalanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{
                            to: USDC_ADDRESS,
                            data: '0x70a08231000000000000000000000000' + address.slice(2)
                        }, 'latest']
                    });
                    const usdcBalance = parseInt(usdcBalanceHex, 16) / 1e6; // USDC has 6 decimals
                    walletBalances.usdc = usdcBalance;

                    document.getElementById('usdcBalance').textContent = usdcBalance.toFixed(2);
                    document.getElementById('usdcUsdValue').textContent = `~$${usdcBalance.toFixed(2)}`;
                } catch (e) {
                    // USDC might not be on the current network
                    document.getElementById('usdcBalance').textContent = '0.00';
                    document.getElementById('usdcUsdValue').textContent = '~$0.00';
                }

            } catch (error) {
                console.error('Error fetching balances:', error);
            }
        }

        function selectAsset(asset, element) {
            selectedCryptoAsset = asset;
            document.querySelectorAll('.asset-tab').forEach(tab => tab.classList.remove('active'));
            element.classList.add('active');
            document.getElementById('inputAssetLabel').textContent = asset.toUpperCase();
            document.getElementById('cryptoDepositAmount').value = '';
            updateCryptoPreview();
        }

        function adjustAmount(delta) {
            const input = document.getElementById('cryptoDepositAmount');
            const currentValue = parseFloat(input.value) || 0;
            const newValue = Math.max(0, currentValue + delta);
            // Show 6 decimals for ETH, 2 for USDC
            const decimals = selectedCryptoAsset === 'eth' ? 6 : 2;
            input.value = newValue.toFixed(decimals);
            updateCryptoPreview();
        }

        function setPercentage(percent) {
            const balance = selectedCryptoAsset === 'eth' ? walletBalances.eth : walletBalances.usdc;
            const amount = (balance * percent / 100);

            // For ETH, leave a little for gas
            const finalAmount = selectedCryptoAsset === 'eth' && percent === 100
                ? Math.max(0, amount - 0.0005) // leave 0.0005 for gas
                : amount;

            // Show 6 decimals for ETH, 2 for USDC
            const decimals = selectedCryptoAsset === 'eth' ? 6 : 2;
            document.getElementById('cryptoDepositAmount').value = finalAmount.toFixed(decimals);
            updateCryptoPreview();
        }

        function updateCryptoPreview() {
            const amount = parseFloat(document.getElementById('cryptoDepositAmount').value) || 0;
            let usdValue = 0;

            if (selectedCryptoAsset === 'eth') {
                usdValue = amount * ETH_PRICE_USD;
            } else {
                usdValue = amount; // USDC is 1:1 with USD
            }

            // After 0.5% fee
            const afterFee = usdValue * 0.995;
            // 1000 SUITE per $1
            const suiteAmount = Math.floor(afterFee * 1000);

            document.getElementById('cryptoSuitePreview').textContent =
                suiteAmount.toLocaleString() + ' SUITE';

            // Show USD value
            document.getElementById('cryptoUsdPreview').textContent =
                `(~$${afterFee.toFixed(2)})`;

            // Enable/disable deposit button
            document.getElementById('cryptoDepositBtn').disabled = suiteAmount === 0;
        }

        async function executeCryptoDeposit() {
            const amount = parseFloat(document.getElementById('cryptoDepositAmount').value) || 0;
            if (amount <= 0) {
                showNotification('??', 'Enter an Amount', 'Please enter an amount to deposit.');
                return;
            }

            const btn = document.getElementById('cryptoDepositBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '? Processing...';
            btn.disabled = true;

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    showNotification('??', 'Connect Wallet', 'Please connect your wallet first.');
                    return;
                }

                const fromAddress = accounts[0];

                if (selectedCryptoAsset === 'eth') {
                    // For ETH deposits - call depositETH() on Treasury
                    // This will mint SUITE tokens to the user
                    const amountWei = '0x' + Math.floor(amount * 1e18).toString(16);

                    // depositETH() function selector
                    const depositEthData = '0xf6326fb3'; // depositETH()

                    btn.innerHTML = '?? Depositing ETH...';

                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: fromAddress,
                            to: TREASURY_ADDRESS,
                            value: amountWei,
                            data: depositEthData,
                        }],
                    });

                    const suiteReceived = Math.floor(amount * ETH_PRICE_USD * 0.995 * 1000);
                    closeModal('cryptoDepositModal');
                    showNotification(
                        '?',
                        'ETH Deposit Submitted!',
                        `You'll receive ~${suiteReceived.toLocaleString()} SUITE once the transaction confirms.`,
                        `Tx: ${txHash}`
                    );

                    // Prompt to link Discord if not logged in (to use credits in apps)
                    const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                    if (!currentUser?.id) {
                        setTimeout(() => showDiscordLinkPrompt(fromAddress), 2000);
                    }

                    // Refresh treasury stats after deposit
                    setTimeout(() => {
                        fetchTreasuryStats();
                        checkConnection();
                    }, 5000);

                } else {
                    // USDC deposits via Treasury contract
                    const amountUSDC = Math.floor(amount * 1e6); // USDC has 6 decimals

                    // Step 1: Check if we need to approve USDC spending
                    btn.innerHTML = '?? Checking approval...';

                    // Check current allowance
                    const allowanceData = '0xdd62ed3e' +
                        fromAddress.slice(2).padStart(64, '0') +
                        TREASURY_ADDRESS.slice(2).padStart(64, '0');

                    const allowanceHex = await window.ethereum.request({
                        method: 'eth_call',
                        params: [{ to: USDC_ADDRESS, data: allowanceData }, 'latest']
                    });

                    const currentAllowance = parseInt(allowanceHex, 16);

                    if (currentAllowance < amountUSDC) {
                        // Need to approve
                        btn.innerHTML = '?? Approve USDC...';

                        const approveData = '0x095ea7b3' +
                            TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                            'ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

                        await window.ethereum.request({
                            method: 'eth_sendTransaction',
                            params: [{
                                from: fromAddress,
                                to: USDC_ADDRESS,
                                data: approveData,
                            }]
                        });

                        alert('? USDC Approved!\n\nNow click Deposit again to complete the deposit.');
                        btn.innerHTML = '?? Deposit Now';
                        btn.disabled = false;
                        return;
                    }

                    // Step 2: Deposit USDC to Treasury
                    btn.innerHTML = '?? Depositing...';

                    // Encode depositUSDC(amount) call
                    const depositData = '0x47e7ef24' +
                        amountUSDC.toString(16).padStart(64, '0');

                    const txHash = await window.ethereum.request({
                        method: 'eth_sendTransaction',
                        params: [{
                            from: fromAddress,
                            to: TREASURY_ADDRESS,
                            data: depositData,
                        }]
                    });

                    const suiteReceived = Math.floor(amount * 0.995 * 1000);
                    closeModal('cryptoDepositModal');
                    showNotification(
                        '?',
                        'USDC Deposit Submitted!',
                        `You'll receive ~${suiteReceived.toLocaleString()} SUITE once the transaction confirms.`,
                        `Tx: ${txHash}`
                    );

                    // Prompt to link Discord if not logged in (to use credits in apps)
                    const currentUserUSDC = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                    if (!currentUserUSDC?.id) {
                        setTimeout(() => showDiscordLinkPrompt(fromAddress), 2000);
                    }

                    // Refresh after deposit
                    setTimeout(() => {
                        fetchTreasuryStats();
                        checkConnection();
                    }, 5000);
                }

            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction was cancelled.');
                } else {
                    showNotification('?', 'Transaction Failed', 'Something went wrong. Please try again.', error.message || '');
                }
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        async function handleWithdraw(method) {
            const amount = parseFloat(document.getElementById('withdrawAmount').value) || 0;

            // Get backing rate for precise calculation
            const backingRateText = document.getElementById('backingRate').textContent;
            const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
            const usdValue = (amount * backingRate * 0.995); // After 0.5% fee
            const usdcValue = usdValue.toFixed(6); // 6 decimals for USDC precision

            switch (method) {
                case 'paypal':
                    closeModal('withdrawModal');
                    showNotification('???', 'PayPal Cash Out', `Would send $${usdcValue} to your PayPal email.`, 'Coming soon!');
                    break;
                case 'card':
                    closeModal('withdrawModal');
                    showNotification('??', 'Card Refund', `Would refund $${usdcValue} to your original card.`, 'Coming soon!');
                    break;
                case 'giftcard':
                    closeModal('withdrawModal');
                    showNotification('??', 'Gift Card', `Choose a gift card worth $${usdcValue}`, 'Coming soon!');
                    break;
                case 'crypto':
                    // Actually execute the crypto withdrawal
                    await executeCryptoWithdraw(amount);
                    break;
                case 'bank':
                    closeModal('withdrawModal');
                    showNotification('??', 'Bank Transfer', `Would initiate $${usdcValue} transfer.`, 'Coming soon!');
                    break;
            }
        }

        async function executeCryptoWithdraw(suiteAmount) {
            if (suiteAmount <= 0) {
                showNotification('??', 'Enter Amount', 'Please enter an amount to withdraw.');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    showNotification('??', 'Connect Wallet', 'Please connect your wallet first.');
                    return;
                }

                const fromAddress = accounts[0];

                closeModal('withdrawModal');
                showNotification('?', 'Processing Withdrawal', 'Please confirm the transaction in MetaMask...', '');

                // Convert SUITE amount to wei (18 decimals)
                const suiteWei = '0x' + Math.floor(suiteAmount * 1e18).toString(16);

                // First: Approve Treasury to spend SUITE tokens
                // approve(address spender, uint256 amount)
                const approveData = '0x095ea7b3' +
                    TREASURY_ADDRESS.slice(2).padStart(64, '0') +
                    suiteWei.slice(2).padStart(64, '0');

                await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: SUITE_TOKEN_ADDRESS,
                        data: approveData,
                    }],
                });

                // Wait a bit for approval to process
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Second: Call withdraw(uint256 suiteAmount) on Treasury
                // Function selector for withdraw(uint256)
                const withdrawData = '0x2e1a7d4d' + suiteWei.slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: fromAddress,
                        to: TREASURY_ADDRESS,
                        data: withdrawData,
                    }],
                });

                // Calculate expected ETH received
                const backingRateText = document.getElementById('backingRate').textContent;
                const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
                const expectedUsd = suiteAmount * backingRate * 0.995;
                const expectedEth = (expectedUsd / ETH_PRICE_USD).toFixed(8);

                showNotification(
                    '?',
                    'Withdrawal Submitted!',
                    `You'll receive ~${expectedEth} ETH (~$${expectedUsd.toFixed(6)}) once confirmed.`,
                    `Tx: ${txHash}`
                );

                // Refresh balances
                setTimeout(() => {
                    checkConnection();
                    fetchTreasuryStats();
                }, 5000);

            } catch (error) {
                console.error('Withdraw error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction was cancelled.');
                } else {
                    showNotification('?', 'Withdrawal Failed', 'Something went wrong.', error.message || '');
                }
            }
        }

        // Wire up buttons
        document.getElementById('depositBtn').addEventListener('click', () => {
            openModal('depositModal');
        });

        document.getElementById('withdrawBtn').addEventListener('click', () => {
            // Get balance from the displayed available balance
            const availableBalanceText = document.getElementById('availableBalance').textContent;
            const availableBalance = parseFloat(availableBalanceText.replace(/,/g, '')) || 0;

            // Get backing rate for USD calculation
            const backingRateText = document.getElementById('backingRate').textContent;
            const backingRate = parseFloat(backingRateText.replace('$', '').replace('/SUITE', '')) || 0;
            const usdValue = (availableBalance * backingRate * 0.995).toFixed(2);

            // Update Cash Out modal with actual balance
            document.getElementById('cashOutBalance').textContent = `${availableBalance.toLocaleString()} SUITE`;
            document.querySelector('#withdrawModal .balance-display-label').textContent = `Available to cash out ? ? $${usdValue}`;
            document.getElementById('withdrawAmount').value = availableBalance;
            document.getElementById('withdrawAmount').max = availableBalance;

            // Update MAX button
            const maxBtn = document.querySelector('#withdrawModal .amount-option');
            if (maxBtn) {
                maxBtn.onclick = () => { document.getElementById('withdrawAmount').value = availableBalance; };
            }

            openModal('withdrawModal');
        });

        document.getElementById('stakeBtn').addEventListener('click', () => {
            showNotification('?', 'Staking Coming Soon', 'Stake your SUITE to earn voting power and unlock charity voting.');
        });

        // ===== ADMIN PANEL FUNCTIONS =====

        // Hardcoded admin addresses (can see admin panel)
        const ADMIN_ADDRESSES = [
            '0x92d67d8ad8b986e78b369be0272e121ae5acad59', // Stuart's primary wallet
            '0xdefc3ae5a990206101463d208e7e1446c58a72bd', // Treasury owner (deployer)
        ];

        async function checkIfOwner(connectedAddress) {
            try {
                const connectedLower = connectedAddress.toLowerCase();

                // Check if in admin list first
                const isAdmin = ADMIN_ADDRESSES.includes(connectedLower);

                // Also check contract owner
                const ownerData = '0x8da5cb5b'; // owner()
                const ownerHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: TREASURY_ADDRESS, data: ownerData }, 'latest']
                });

                // Extract address from response (remove 0x and leading zeros)
                const ownerAddress = '0x' + ownerHex.slice(26).toLowerCase();
                const isContractOwner = connectedLower === ownerAddress;

                console.log('Admin check:', { connectedLower, ownerAddress, isAdmin, isContractOwner });

                if (isAdmin || isContractOwner) {
                    document.getElementById('adminPanel').style.display = 'block';
                    updateAdminStats();
                } else {
                    document.getElementById('adminPanel').style.display = 'none';
                }

                return isAdmin || isContractOwner;
            } catch (error) {
                console.log('Could not check owner:', error);
                return false;
            }
        }

        async function updateAdminStats() {
            try {
                // Get treasury ETH balance
                const treasuryBalanceHex = await window.ethereum.request({
                    method: 'eth_getBalance',
                    params: [TREASURY_ADDRESS, 'latest']
                });
                const treasuryEth = parseInt(treasuryBalanceHex, 16) / 1e18;
                const treasuryUsd = treasuryEth * ETH_PRICE_USD;

                // Get actual accumulatedFees from contract
                const feesData = '0x79ddb121'; // accumulatedFees()
                const feesHex = await window.ethereum.request({
                    method: 'eth_call',
                    params: [{ to: TREASURY_ADDRESS, data: feesData }, 'latest']
                });
                const accumulatedFeesWei = feesHex && feesHex !== '0x' ? parseInt(feesHex, 16) : 0;
                const accumulatedFeesEth = accumulatedFeesWei / 1e18;
                const accumulatedFeesUsd = accumulatedFeesEth * ETH_PRICE_USD;

                document.getElementById('adminTreasuryEth').textContent = treasuryEth.toFixed(10) + ' ETH';
                document.getElementById('accumulatedFees').textContent = '$' + accumulatedFeesUsd.toFixed(6);

                // Enable/disable withdraw button based on minimum threshold (0.001 ETH)
                const withdrawBtn = document.getElementById('withdrawFeesBtn');
                const withdrawHelper = document.getElementById('withdrawFeesHelper');
                const MIN_WITHDRAW_ETH = 0.001;

                if (accumulatedFeesEth >= MIN_WITHDRAW_ETH) {
                    withdrawBtn.disabled = false;
                    withdrawHelper.textContent = `${accumulatedFeesEth.toFixed(6)} ETH available to withdraw`;
                    withdrawHelper.style.color = '#2ecc71';
                } else {
                    withdrawBtn.disabled = true;
                    withdrawHelper.textContent = `Minimum ${MIN_WITHDRAW_ETH} ETH in fees required (current: ${accumulatedFeesEth.toFixed(6)} ETH)`;
                    withdrawHelper.style.color = '#888';
                }
            } catch (error) {
                console.log('Could not update admin stats:', error);
            }
        }

        async function withdrawFees() {
            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                showNotification('?', 'Processing', 'Please confirm in MetaMask...');

                // withdrawFees(address to) function selector: 0x476343ee + address
                // Send fees to the caller's address
                const withdrawFeesData = '0x476343ee' + accounts[0].slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: TREASURY_ADDRESS,
                        data: withdrawFeesData,
                    }],
                });

                showNotification('?', 'Fees Withdrawn!', 'Transaction submitted.', `Tx: ${txHash}`);
                setTimeout(updateAdminStats, 5000);
            } catch (error) {
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled.');
                } else {
                    showNotification('?', 'Error', error.message || 'Failed to withdraw fees.');
                }
            }
        }

        // Community Arbitrage execution
        async function executeArb() {
            const btn = document.getElementById('executeArbBtn');
            const originalText = btn.innerHTML;

            try {
                // Update button to loading state
                btn.disabled = true;
                btn.innerHTML = '<span style="font-size: 1.2rem;">?</span> Executing...';
                btn.style.opacity = '0.7';

                // Mock execution - in production this would:
                // 1. Mint SUITE from Treasury at floor price
                // 2. Sell on DEX at market price
                // 3. Split profit 50/50 (user/treasury)

                await new Promise(resolve => setTimeout(resolve, 2000));

                // Show success
                showNotification('??', 'Arb Executed!', 'You earned +120 SUITE! Treasury received +120 SUITE.');

                // Update button to success
                btn.innerHTML = '<span style="font-size: 1.2rem;">?</span> Success! +120 SUITE';
                btn.style.background = 'linear-gradient(135deg, #22c55e, #16a34a)';

                // Reset after 3 seconds
                setTimeout(() => {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.style.opacity = '1';
                }, 3000);

            } catch (error) {
                showNotification('?', 'Failed', error.message || 'Could not execute arb.');
                btn.disabled = false;
                btn.innerHTML = originalText;
                btn.style.opacity = '1';
            }
        }

        // Note: emergencyWithdraw removed - not supported in TreasuryV4

        async function transferOwnership() {
            const newOwner = document.getElementById('newOwnerAddress').value.trim();

            if (!newOwner || !newOwner.startsWith('0x') || newOwner.length !== 42) {
                showNotification('??', 'Invalid Address', 'Please enter a valid Ethereum address.');
                return;
            }

            if (!confirm(`Transfer ownership to:\n${newOwner}\n\nYou will lose admin access. Continue?`)) {
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) return;

                showNotification('?', 'Processing', 'Please confirm in MetaMask...');

                // transferOwnership(address) function selector + encoded address
                const transferData = '0xf2fde38b' + newOwner.slice(2).padStart(64, '0');

                const txHash = await window.ethereum.request({
                    method: 'eth_sendTransaction',
                    params: [{
                        from: accounts[0],
                        to: TREASURY_ADDRESS,
                        data: transferData,
                    }],
                });

                showNotification('?', 'Ownership Transferred', `New owner: ${newOwner.slice(0, 10)}...`, `Tx: ${txHash}`);
                document.getElementById('adminPanel').style.display = 'none';
            } catch (error) {
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled.');
                } else {
                    showNotification('?', 'Error', error.message || 'Failed to transfer ownership.');
                }
            }
        }

        // Fetch treasury stats and check connection on page load
        if (window.ethereum) {
            fetchTreasuryStats();
            checkConnection(); // Auto-connect if already authorized
            // Refresh every 30 seconds
            setInterval(fetchTreasuryStats, 30000);
        }

        // Fetch ad revenue stats from Supabase
        async function fetchAdRevenueStats() {
            const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.rTqKxT2LYhPt5nQEjLxMxdRDqvVoT7eILWHhBo1MVHU';

            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${SUPABASE_URL}/rest/v1/ad_events?created_at=gte.${today}T00:00:00&event_type=eq.credited&select=error_message,suite_amount`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const events = await response.json();

                if (!Array.isArray(events)) return;

                // Calculate stats
                const totalSuite = events.length * 2; // 2 SUITE per ad
                const verified = events.filter(e => e.error_message?.includes('verified:true')).length;
                const verifiedPercent = events.length > 0 ? Math.round((verified / events.length) * 100) : 0;
                const estimatedRevenue = events.length * 0.002; // ~$0.002 per ad

                // Update UI
                const adRevenueEl = document.getElementById('adRevenueToday');
                const suiteIssuedEl = document.getElementById('suiteIssuedAds');
                const verifiedEl = document.getElementById('verifiedAdsPercent');

                if (adRevenueEl) adRevenueEl.textContent = '$' + estimatedRevenue.toFixed(2);
                if (suiteIssuedEl) suiteIssuedEl.textContent = totalSuite;
                if (verifiedEl) {
                    verifiedEl.textContent = verifiedPercent + '%';
                    // Color based on percentage
                    if (verifiedPercent >= 80) verifiedEl.style.color = '#22c55e';
                    else if (verifiedPercent >= 50) verifiedEl.style.color = '#f59e0b';
                    else verifiedEl.style.color = '#ef4444';
                }
            } catch (error) {
                console.log('Could not fetch ad stats:', error);
            }
        }

        // Load ad stats on page load
        fetchAdRevenueStats();
        setInterval(fetchAdRevenueStats, 60000); // Refresh every minute

        // ============================================
        // BOOST NFT SYSTEM
        // ============================================

        const SUITE_BOOSTS_ADDRESS = null; // TODO: Set after deployment
        const SUITE_BOOSTS_ABI = [
            "function balanceOf(address account, uint256 id) view returns (uint256)",
            "function getAllBoostBalances(address account) view returns (uint256[5])",
            "function redeem(uint256 boostType, uint256 amount)"
        ];

        const BOOST_TYPES = {
            1: { name: 'Priority Queue', icon: '?', dbType: 'priority-queue' },
            2: { name: 'AI Pack', icon: '??', dbType: 'ai-pack' },
            3: { name: 'App Slot', icon: '??', dbType: 'app-slot' },
            4: { name: 'Featured Week', icon: '?', dbType: 'featured-week' },
            5: { name: '2x Earn', icon: '2??', dbType: '2x-earn' }
        };

        // Load database boosts (from Discord/Supabase)
        async function loadDatabaseBoosts() {
            const container = document.getElementById('databaseBoostsContent');
            if (!container) return;

            // Check for Discord user in localStorage
            const savedUser = localStorage.getItem('suiteUser');
            if (!savedUser) {
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">Connect Discord on <a href="earn.html" style="color: var(--accent-orange);">Earn page</a> to view boosts</span>';
                return;
            }

            const user = JSON.parse(savedUser);

            try {
                const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
                const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.rTqKxT2LYhPt5nQEjLxMxdRDqvVoT7eILWHhBo1MVHU';

                const response = await fetch(`${SUPABASE_URL}/rest/v1/user_boosts?discord_id=eq.${user.id}&status=eq.active&select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                const boosts = await response.json();

                if (!Array.isArray(boosts) || boosts.length === 0) {
                    container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">No account boosts. <a href="boost.html" style="color: var(--accent-orange);">Buy some ?</a></span>';
                    return;
                }

                container.innerHTML = boosts.map(boost => {
                    const boostInfo = Object.values(BOOST_TYPES).find(b => b.dbType === boost.boost_type) || { name: boost.boost_type, icon: '??' };
                    return `
                        <div class="boost-item">
                            <span class="boost-item-icon">${boostInfo.icon}</span>
                            <div class="boost-item-info">
                                <div class="boost-item-name">${boostInfo.name}</div>
                                <div class="boost-item-status">Active ? ${boost.status}</div>
                            </div>
                            <button class="boost-item-btn mint" onclick="mintBoostAsNFT('${boost.id}')" ${!walletAddress ? 'disabled title="Connect wallet first"' : ''}>
                                Mint NFT
                            </button>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading database boosts:', error);
                container.innerHTML = '<span style="color: #ef4444; font-size: 0.9rem;">Error loading boosts</span>';
            }
        }

        // Load NFT boosts (from wallet)
        async function loadNFTBoosts() {
            const container = document.getElementById('nftBoostsContent');
            if (!container) return;

            if (!walletAddress || !SUITE_BOOSTS_ADDRESS) {
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">' +
                    (!walletAddress ? 'Connect wallet to view NFT boosts' : 'NFT contract not deployed yet') + '</span>';
                return;
            }

            try {
                const boostsContract = new ethers.Contract(SUITE_BOOSTS_ADDRESS, SUITE_BOOSTS_ABI, provider);
                const balances = await boostsContract.getAllBoostBalances(walletAddress);

                let html = '';
                for (let i = 0; i < 5; i++) {
                    const count = Number(balances[i]);
                    if (count > 0) {
                        const boostType = BOOST_TYPES[i + 1];
                        html += `
                            <div class="boost-item">
                                <span class="boost-item-icon">${boostType.icon}</span>
                                <div class="boost-item-info">
                                    <div class="boost-item-name">${boostType.name}</div>
                                    <div class="boost-item-status">NFT ? ${count}x owned</div>
                                </div>
                                <button class="boost-item-btn redeem" onclick="redeemNFTBoost(${i + 1})">
                                    Redeem
                                </button>
                            </div>
                        `;
                    }
                }

                container.innerHTML = html || '<span style="color: var(--text-tertiary); font-size: 0.9rem;">No NFT boosts. Mint from account boosts above.</span>';

            } catch (error) {
                console.error('Error loading NFT boosts:', error);
                container.innerHTML = '<span style="color: var(--text-tertiary); font-size: 0.9rem;">NFT contract not deployed yet</span>';
            }
        }

        // Mint a database boost as NFT
        async function mintBoostAsNFT(boostId) {
            if (!walletAddress) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Minting...';

                // Call backend to mint (backend handles state machine + on-chain minting)
                const response = await fetch('/api/boost-mint', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        boost_id: boostId,
                        wallet_address: walletAddress
                    })
                });

                const result = await response.json();

                if (result.success) {
                    alert('? Boost minted as NFT! Check your wallet.');
                    await loadDatabaseBoosts();
                    await loadNFTBoosts();
                } else {
                    throw new Error(result.error || 'Minting failed');
                }

            } catch (error) {
                console.error('Mint error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Redeem an NFT boost back to database
        async function redeemNFTBoost(boostType) {
            if (!walletAddress || !signer) {
                alert('Please connect your wallet first');
                return;
            }

            try {
                const boostsContract = new ethers.Contract(SUITE_BOOSTS_ADDRESS, SUITE_BOOSTS_ABI, signer);

                // User burns the NFT
                const tx = await boostsContract.redeem(boostType, 1);
                alert('Transaction submitted. Please wait...');
                await tx.wait();

                // Tell backend to credit the database boost
                const savedUser = localStorage.getItem('suiteUser');
                if (savedUser) {
                    const user = JSON.parse(savedUser);
                    await fetch('/api/boost-redeem', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            discord_id: user.id,
                            boost_type: boostType,
                            tx_hash: tx.hash
                        })
                    });
                }

                alert('? Boost redeemed to your account!');
                await loadDatabaseBoosts();
                await loadNFTBoosts();

            } catch (error) {
                console.error('Redeem error:', error);
                alert('Error: ' + error.message);
            }
        }

        // Load boosts when wallet connects or page loads
        document.addEventListener('DOMContentLoaded', () => {
            loadDatabaseBoosts();
            loadNFTBoosts();
        });

        // Refresh boosts when wallet connects
        const originalUpdateUI = typeof updateUI === 'function' ? updateUI : null;
        if (originalUpdateUI) {
            window.updateUI = async function () {
                await originalUpdateUI.apply(this, arguments);
                await loadDatabaseBoosts();
                await loadNFTBoosts();
            };
        }

        // ========== DISCORD BRIDGE FUNCTIONS ==========

        const BRIDGE_ADDRESS = '0x0000000000000000000000000000000000000000'; // TODO: Deploy and update
        const DISCORD_CLIENT_ID = '1457474266390986865';
        const BRIDGE_REDIRECT_URI = window.location.origin + '/wallet.html';

        const BRIDGE_ABI = [
            "function deposit(string calldata discordId, uint256 amount) external",
            "function bridgeBalance() view returns (uint256)"
        ];

        // ERC20_ABI already declared above - reuse it for bridge

        // Check Discord connection for bridge on page load
        document.addEventListener('DOMContentLoaded', () => {
            checkBridgeDiscordConnection();
            loadBridgeBalances();
        });

        function checkBridgeDiscordConnection() {
            const savedUser = localStorage.getItem('suiteUser');
            const statusEl = document.getElementById('bridgeDiscordStatus');
            const connectBtn = document.getElementById('bridgeConnectDiscord');
            const userEl = document.getElementById('bridgeDiscordUser');

            if (savedUser) {
                const user = JSON.parse(savedUser);
                if (statusEl) statusEl.style.display = 'block';
                if (userEl) userEl.textContent = `? Connected as ${user.username}`;
                if (connectBtn) connectBtn.style.display = 'none';
            } else {
                if (statusEl) statusEl.style.display = 'none';
                if (connectBtn) connectBtn.style.display = 'flex';
            }
        }

        function connectDiscordForBridge() {
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(BRIDGE_REDIRECT_URI)}&response_type=token&scope=identify`;
            window.location.href = authUrl;
        }

        async function loadBridgeBalances() {
            // Load wallet SUITE balance (will be updated when wallet connects)
            const walletBalanceEl = document.getElementById('bridgeWalletBalance');
            const discordBalanceEl = document.getElementById('bridgeDiscordBalance');

            // Wallet balance (from existing availableBalance element)
            const availableBal = document.getElementById('availableBalance');
            if (availableBal && walletBalanceEl) {
                walletBalanceEl.textContent = availableBal.textContent || '0';
            }

            // Discord balance from Supabase
            const savedUser = localStorage.getItem('suiteUser');
            if (savedUser && discordBalanceEl) {
                const user = JSON.parse(savedUser);
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/user_balances?discord_id=eq.${user.id}&select=balance`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    const data = await response.json();
                    if (data && data[0]) {
                        discordBalanceEl.textContent = Number(data[0].balance).toLocaleString();
                    }
                } catch (error) {
                    console.error('Error loading Discord balance:', error);
                }
            }
        }

        async function depositToDiscord() {
            const amountInput = document.getElementById('bridgeAmount');
            const amount = amountInput?.value;

            if (!amount || amount <= 0) {
                alert('Please enter an amount');
                return;
            }

            // Check Discord connection
            const savedUser = localStorage.getItem('suiteUser');
            if (!savedUser) {
                alert('Please connect Discord first');
                return;
            }
            const user = JSON.parse(savedUser);

            // Check wallet connection
            if (!window.ethereum) {
                alert('Please install MetaMask');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length === 0) {
                    alert('Please connect your wallet first');
                    return;
                }

                const provider = new ethers.BrowserProvider(window.ethereum);
                const signer = await provider.getSigner();
                const amountWei = ethers.parseEther(amount.toString());

                // Get SUITE token address from treasury
                const suiteToken = new ethers.Contract(SUITE_TOKEN_ADDRESS, ERC20_ABI, signer);

                // Check allowance
                const allowance = await suiteToken.allowance(accounts[0], BRIDGE_ADDRESS);
                if (allowance < amountWei) {
                    showNotification('?', 'Approving', 'Please approve SUITE spending...');
                    const approveTx = await suiteToken.approve(BRIDGE_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                // Deposit to bridge
                showNotification('?', 'Depositing', 'Please confirm the deposit...');
                const bridgeContract = new ethers.Contract(BRIDGE_ADDRESS, BRIDGE_ABI, signer);
                const depositTx = await bridgeContract.deposit(user.id, amountWei);
                await depositTx.wait();

                showNotification('?', 'Success!', `Deposited ${amount} SUITE to Discord. It will appear in your balance shortly.`);
                amountInput.value = '';

                // Reload balances after a short delay
                setTimeout(loadBridgeBalances, 5000);

            } catch (error) {
                console.error('Deposit error:', error);
                if (error.code === 4001) {
                    showNotification('?', 'Cancelled', 'Transaction cancelled');
                } else {
                    showNotification('?', 'Error', error.message || 'Deposit failed');
                }
            }
        }

        // Handle OAuth callback for bridge
        (function handleBridgeOAuth() {
            const hash = window.location.hash.substring(1);
            if (!hash) return;

            const params = new URLSearchParams(hash);
            const accessToken = params.get('access_token');

            if (accessToken) {
                fetch('https://discord.com/api/users/@me', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                })
                    .then(res => res.json())
                    .then(user => {
                        const userData = {
                            id: user.id,
                            username: user.username,
                            avatar: user.avatar
                                ? `https://cdn.discordapp.com/avatars/${user.id}/${user.avatar}.png`
                                : `https://cdn.discordapp.com/embed/avatars/${parseInt(user.discriminator || '0') % 5}.png`
                        };
                        localStorage.setItem('suiteUser', JSON.stringify(userData));
                        window.history.replaceState(null, '', window.location.pathname);
                        checkBridgeDiscordConnection();
                        loadBridgeBalances();
                    });
            }
        })();

        // Tab Switching Logic
        window.switchTab = function (tabId) {
            // Hide all contents
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
                el.classList.remove('active');
            });

            // Show target content
            const target = document.getElementById('tab-' + tabId);
            if (target) {
                target.style.display = 'block';
                setTimeout(() => target.classList.add('active'), 10);
            }

            // Update tabs
            document.querySelectorAll('.wallet-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.getAttribute('onclick')?.includes(`'${tabId}'`)) {
                    tab.classList.add('active');
                }
            });
        };

        window.openLockModal = function () {
            alert("? Staking for Reputation is coming soon!");
        };
    </script>

    <!-- Stu Helper Widget -->
    <link rel="stylesheet" href="stu-helper.css">
    <script src="stu-helper.js"></script>
    <script>
        // ========== USER CREDITS SYSTEM ==========
        async function loadUserCredits() {
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (!currentUser || !currentUser.id) return;

            try {
                const response = await fetch(
                    `${SUPABASE_URL}/rest/v1/user_credits?discord_id=eq.${currentUser.id}&select=*`,
                    { headers: { 'apikey': SUPABASE_ANON_KEY } }
                );
                const data = await response.json();

                if (data && data.length > 0) {
                    const credits = parseFloat(data[0].credits) || 0;
                    const creditsEl = document.getElementById('userCredits');
                    if (creditsEl && credits > 0) {
                        creditsEl.innerHTML = `${credits.toFixed(0)} <button onclick="claimCredits(${credits})" style="background: linear-gradient(135deg, #22c55e, #10b981); color: white; border: none; padding: 4px 12px; border-radius: 100px; font-size: 0.7rem; font-weight: 700; cursor: pointer; margin-left: 8px;">Claim</button>`;
                    } else if (creditsEl) {
                        creditsEl.textContent = '0';
                    }
                }
            } catch (err) {
                console.error('Error loading credits:', err);
            }
        }

        async function claimCredits(amount) {
            if (!amount || amount <= 0) { alert('No credits to claim!'); return; }
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (!currentUser) { alert('Please log in via Discord first.'); return; }
            if (!userAddress) { alert('Please connect your wallet first.'); return; }

            if (!confirm(`Claim ${amount} credits?\n\nWill send ${amount} SUITE to ${userAddress.slice(0, 6)}...${userAddress.slice(-4)}`)) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/rpc/claim_credits`, {
                    method: 'POST',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ p_discord_id: currentUser.id, p_amount: amount })
                });
                const success = await response.json();
                if (!success) { alert('Failed - insufficient balance.'); return; }

                alert(`Claimed ${amount} credits! SUITE transfer pending Treasury integration.`);
                loadUserCredits();
            } catch (err) {
                alert('Error claiming credits.');
            }
        }

        document.addEventListener('DOMContentLoaded', loadUserCredits);
        window.loadUserCredits = loadUserCredits;

        // ========== DISCORD LOGIN ==========
        function loginWithDiscord() {
            // Discord OAuth2 URL - using the same flow as developer portal
            const DISCORD_CLIENT_ID = '1311757088540311633'; // Your Discord App Client ID
            const REDIRECT_URI = encodeURIComponent(window.location.origin + '/oauth-callback.html');
            const SCOPE = encodeURIComponent('identify email');

            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${REDIRECT_URI}&response_type=code&scope=${SCOPE}`;

            // Open Discord auth in a popup
            const popup = window.open(authUrl, 'Discord Login', 'width=500,height=700');

            // Listen for the callback
            window.addEventListener('message', function handleAuthMessage(event) {
                if (event.origin !== window.location.origin) return;
                if (event.data && event.data.type === 'discord-auth-success') {
                    const user = event.data.user;
                    localStorage.setItem('suiteDev', JSON.stringify(user));
                    updateAuthUI(user);
                    popup.close();
                    window.removeEventListener('message', handleAuthMessage);
                }
            });
        }

        function updateAuthUI(user) {
            const discordBtn = document.getElementById('discordLoginBtn');
            if (discordBtn && user) {
                discordBtn.innerHTML = `<img src="${user.avatar ? 'https://cdn.discordapp.com/avatars/' + user.id + '/' + user.avatar + '.png' : 'https://cdn.discordapp.com/embed/avatars/0.png'}" style="width: 24px; height: 24px; border-radius: 50%;"> ${user.username}`;
                discordBtn.onclick = () => {
                    if (confirm('Log out of Discord?')) {
                        localStorage.removeItem('suiteDev');
                        location.reload();
                    }
                };
            }
        }

        // Check if already logged in on page load
        document.addEventListener('DOMContentLoaded', async function () {
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
            if (currentUser) {
                updateAuthUI(currentUser);
                // Check for pending wallet link (after Discord OAuth redirect)
                await checkPendingWalletLink();
            }
        });

        // ========== WALLET CONNECTION ==========

        // Link wallet address to Discord account in Supabase
        async function linkWalletToDiscord(walletAddress, discordId) {
            try {
                // Upsert to user_credits - links wallet to Discord
                const response = await fetch(`${ADMIN_SUPABASE_URL}/rest/v1/user_credits`, {
                    method: 'POST',
                    headers: {
                        'apikey': ADMIN_SUPABASE_KEY,
                        'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        discord_id: discordId,
                        wallet_address: walletAddress.toLowerCase(),
                        updated_at: new Date().toISOString()
                    })
                });

                if (response.ok) {
                    console.log(`Linked wallet ${walletAddress.slice(0,8)}... to Discord ${discordId}`);
                    showNotification('üîó', 'Wallet Linked', 'Your wallet is now linked to your Discord account');
                }
            } catch (error) {
                console.error('Failed to link wallet to Discord:', error);
            }
        }

        // Show prompt to link Discord after deposit (if not logged in)
        function showDiscordLinkPrompt(walletAddress) {
            const existing = document.getElementById('discordLinkPrompt');
            if (existing) existing.remove();

            const prompt = document.createElement('div');
            prompt.id = 'discordLinkPrompt';
            prompt.innerHTML = `
                <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
                            background: linear-gradient(135deg, #1a1225 0%, #2d1b4e 100%);
                            padding: 32px; border-radius: 20px; z-index: 10000; max-width: 400px;
                            border: 1px solid rgba(139, 92, 246, 0.3); box-shadow: 0 20px 60px rgba(0,0,0,0.5);">
                    <h3 style="color: white; margin: 0 0 12px 0; font-size: 1.3rem;">üéâ Deposit Successful!</h3>
                    <p style="color: rgba(255,255,255,0.7); margin: 0 0 20px 0; line-height: 1.5;">
                        Link your Discord to use credits in SUITE apps like FoodVitals, OpticRep, and more.
                    </p>
                    <button onclick="loginWithDiscordForLink('${walletAddress}')"
                            style="width: 100%; padding: 14px; background: #5865F2; color: white;
                                   border: none; border-radius: 12px; font-weight: 600; font-size: 1rem;
                                   cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px;">
                        <svg width="20" height="20" viewBox="0 0 71 55" fill="white">
                            <path d="M60.1 4.9A58.5 58.5 0 0045.4.2a.2.2 0 00-.2.1 40.8 40.8 0 00-1.8 3.7 54 54 0 00-16.2 0A37.4 37.4 0 0025.4.3a.2.2 0 00-.2-.1 58.4 58.4 0 00-14.7 4.6.2.2 0 00-.1 0A60 60 0 00.4 43.8a.2.2 0 000 .2 58.7 58.7 0 0017.7 9 .2.2 0 00.2-.1 42 42 0 003.6-5.9.2.2 0 00-.1-.3 38.7 38.7 0 01-5.5-2.6.2.2 0 010-.4l1.1-.9a.2.2 0 01.2 0 41.8 41.8 0 0035.6 0 .2.2 0 01.2 0l1.1.9a.2.2 0 010 .4 36.4 36.4 0 01-5.5 2.6.2.2 0 00-.1.3 47.2 47.2 0 003.6 5.9.2.2 0 00.3.1 58.5 58.5 0 0017.7-9 .2.2 0 000-.2c1.2-12.7-2-23.7-8.4-33.5a.2.2 0 00-.1 0zM23.7 35.9c-2.9 0-5.3-2.7-5.3-6s2.3-6 5.3-6 5.4 2.7 5.3 6-2.3 6-5.3 6zm19.6 0c-2.9 0-5.3-2.7-5.3-6s2.3-6 5.3-6 5.4 2.7 5.3 6-2.3 6-5.3 6z"/>
                        </svg>
                        Connect Discord
                    </button>
                    <button onclick="document.getElementById('discordLinkPrompt').remove()"
                            style="width: 100%; padding: 12px; background: transparent; color: rgba(255,255,255,0.5);
                                   border: none; margin-top: 12px; cursor: pointer; font-size: 0.9rem;">
                        Skip for now
                    </button>
                </div>
                <div onclick="document.getElementById('discordLinkPrompt').remove()"
                     style="position: fixed; top: 0; left: 0; right: 0; bottom: 0;
                            background: rgba(0,0,0,0.7); z-index: 9999;"></div>
            `;
            document.body.appendChild(prompt);
        }

        // Login with Discord specifically for linking wallet
        function loginWithDiscordForLink(walletAddress) {
            // Store wallet address to link after OAuth
            localStorage.setItem('pendingWalletLink', walletAddress);
            // Trigger Discord OAuth
            const DISCORD_CLIENT_ID = '1311757088540311633';
            const REDIRECT_URI = window.location.origin + '/wallet.html';
            const SCOPE = 'identify';
            const authUrl = `https://discord.com/api/oauth2/authorize?client_id=${DISCORD_CLIENT_ID}&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&response_type=code&scope=${SCOPE}`;
            window.location.href = authUrl;
        }

        // Check for pending wallet link after Discord OAuth
        async function checkPendingWalletLink() {
            const pendingWallet = localStorage.getItem('pendingWalletLink');
            const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');

            if (pendingWallet && currentUser?.id) {
                await linkWalletToDiscord(pendingWallet, currentUser.id);
                localStorage.removeItem('pendingWalletLink');
            }
        }

        async function connectWallet() {
            const walletBtn = document.querySelector('.nav-wallet');

            // Check if already connected - disconnect if so
            if (walletBtn && walletBtn.classList.contains('connected')) {
                walletBtn.classList.remove('connected');
                walletBtn.innerHTML = 'üîó Connect Wallet';
                localStorage.removeItem('suiteWallet');
                localStorage.removeItem('suiteWalletAddress');
                window.walletAddress = null;

                // Hide admin dashboard
                const adminDashboard = document.getElementById('adminDashboard');
                if (adminDashboard) {
                    adminDashboard.style.display = 'none';
                }
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or another Web3 wallet to connect.');
                window.open('https://metamask.io/download/', '_blank');
                return;
            }

            try {
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                const address = accounts[0];

                // Store connected wallet (both keys for compatibility)
                localStorage.setItem('suiteWallet', address);
                localStorage.setItem('suiteWalletAddress', address); // For nav-component.js

                // Update nav wallet button (shared nav)
                const navWalletBtn = document.querySelector('.nav-wallet');
                if (navWalletBtn) {
                    navWalletBtn.classList.add('connected');
                    navWalletBtn.innerHTML = `‚úÖ ${address.slice(0, 6)}...${address.slice(-4)}`;
                }

                // Update old style wallet button if exists
                const walletBtn = document.getElementById('connectWalletBtn');
                if (walletBtn) {
                    walletBtn.innerHTML = `‚úÖ ${address.slice(0, 6)}...${address.slice(-4)}`;
                    walletBtn.onclick = disconnectWallet;
                }

                // Update global wallet address if it exists
                if (typeof userAddress !== 'undefined') {
                    window.userAddress = address;
                }

                // Check for admin dashboard visibility
                window.walletAddress = address;
                if (typeof updateAdminDashboardVisibility === 'function') {
                    updateAdminDashboardVisibility();
                }

                // Load yield allocation from Supabase
                loadYieldAllocation(address).then(savedKeep => {
                    if (savedKeep !== null) {
                        const slider = document.getElementById('yieldSplitSlider');
                        if (slider) {
                            slider.value = savedKeep;
                            updateYieldSplit(savedKeep);
                        }
                    }
                });

                // Auto-link wallet to Discord if logged in
                const currentUser = JSON.parse(localStorage.getItem('suiteDev') || 'null');
                if (currentUser?.id) {
                    await linkWalletToDiscord(address, currentUser.id);
                }

                console.log('Connected wallet:', address);
            } catch (error) {
                console.error('Wallet connection failed:', error);
                alert('Failed to connect wallet. Please try again.');
            }
        }

        function disconnectWallet() {
            localStorage.removeItem('suiteWallet');
            localStorage.removeItem('suiteWalletAddress'); // Also clear nav-component key
            window.walletAddress = null;

            // Hide admin dashboard
            const adminDashboard = document.getElementById('adminDashboard');
            if (adminDashboard) {
                adminDashboard.style.display = 'none';
            }

            const walletBtn = document.getElementById('connectWalletBtn');
            if (walletBtn) {
                walletBtn.innerHTML = 'üîó Connect Wallet';
                walletBtn.onclick = connectWallet;
            }
        }

        // Toggle tooltip visibility and position near the clicked button
        function toggleTooltip(tooltipId, event) {
            event.stopPropagation();
            const tooltip = document.getElementById(tooltipId);
            const button = event.target.closest('button');

            if (tooltip && button) {
                const isVisible = tooltip.style.display === 'block';

                // Hide all tooltips first
                document.querySelectorAll('#howItWorksTooltip, #arbTooltip').forEach(t => {
                    t.style.display = 'none';
                });

                if (!isVisible) {
                    // Position tooltip near the button
                    const rect = button.getBoundingClientRect();
                    tooltip.style.left = (rect.left + window.scrollX - 10) + 'px';
                    tooltip.style.top = (rect.bottom + window.scrollY + 8) + 'px';
                    tooltip.style.display = 'block';
                }
            }
        }

        // Close tooltips when clicking outside
        document.addEventListener('click', function (e) {
            const tooltips = document.querySelectorAll('#howItWorksTooltip, #arbTooltip');
            const isInfoButton = e.target.closest('button[onclick*="toggleTooltip"]');

            if (!isInfoButton) {
                tooltips.forEach(tooltip => {
                    if (!tooltip.contains(e.target)) {
                        tooltip.style.display = 'none';
                    }
                });
            }
        });

        // Restore wallet connection on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedWallet = localStorage.getItem('suiteWallet');
            if (savedWallet) {
                const walletBtn = document.getElementById('connectWalletBtn');
                if (walletBtn) {
                    walletBtn.innerHTML = `‚úÖ ${savedWallet.slice(0, 6)}...${savedWallet.slice(-4)}`;
                    walletBtn.onclick = disconnectWallet;
                }

                // Check for admin dashboard visibility
                window.walletAddress = savedWallet;
                if (typeof updateAdminDashboardVisibility === 'function') {
                    updateAdminDashboardVisibility();
                }

                // Load yield allocation from Supabase for saved wallet
                if (typeof loadYieldAllocation === 'function') {
                    loadYieldAllocation(savedWallet).then(savedKeep => {
                        if (savedKeep !== null) {
                            const slider = document.getElementById('yieldSplitSlider');
                            if (slider) {
                                slider.value = savedKeep;
                                updateYieldSplit(savedKeep);
                            }
                        }
                    });
                }
            }
        });

        // Yield Allocation Slider Logic
        function updateYieldSplit(keepPercent) {
            keepPercent = parseInt(keepPercent);
            // Enforce max 90% (minimum 10% to apps)
            if (keepPercent > 90) keepPercent = 90;
            const fundPercent = 100 - keepPercent;

            // Update display values
            const keepDisplay = document.getElementById('keepPercentDisplay');
            const fundDisplay = document.getElementById('fundPercentDisplay');
            if (keepDisplay) keepDisplay.textContent = keepPercent + '%';
            if (fundDisplay) fundDisplay.textContent = fundPercent + '%';

            // Calculate user APY (42% total from yVault, user keeps their portion)
            const totalApy = 42;
            const userApy = (totalApy * keepPercent / 100).toFixed(1);

            // Update estimated earnings (based on $1000)
            const yearlyEarnings = (1000 * totalApy / 100 * keepPercent / 100).toFixed(0);
            const earningsDisplay = document.getElementById('estimatedEarnings');
            if (earningsDisplay) earningsDisplay.textContent = '~$' + yearlyEarnings + '/year';

            // Save to localStorage
            localStorage.setItem('yieldKeepPercent', keepPercent);

            // Save to Supabase if wallet connected
            if (window.walletAddress) {
                saveYieldAllocation(window.walletAddress, keepPercent);
            }
        }

        // ========== YIELD ALLOCATION DATABASE FUNCTIONS ==========
        const YIELD_SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const YIELD_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.rTqKxT2LYhPt5nQEjLxMxdRDqvVoT7eILWHhBo1MVHU';

        // Save yield allocation to Supabase
        async function saveYieldAllocation(walletAddress, keepPercent) {
            if (!walletAddress) return;

            try {
                // Use upsert to insert or update
                const response = await fetch(`${YIELD_SUPABASE_URL}/rest/v1/yield_allocations`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': YIELD_SUPABASE_KEY,
                        'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`,
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify({
                        wallet_address: walletAddress.toLowerCase(),
                        keep_percent: parseInt(keepPercent),
                        updated_at: new Date().toISOString()
                    })
                });

                if (!response.ok) {
                    console.error('Failed to save yield allocation:', await response.text());
                } else {
                    console.log('Yield allocation saved:', keepPercent + '% keep');
                }
            } catch (error) {
                console.error('Error saving yield allocation:', error);
            }
        }

        // Load yield allocation from Supabase
        async function loadYieldAllocation(walletAddress) {
            if (!walletAddress) return null;

            try {
                const response = await fetch(
                    `${YIELD_SUPABASE_URL}/rest/v1/yield_allocations?wallet_address=eq.${walletAddress.toLowerCase()}&select=keep_percent`,
                    {
                        headers: {
                            'apikey': YIELD_SUPABASE_KEY,
                            'Authorization': `Bearer ${YIELD_SUPABASE_KEY}`
                        }
                    }
                );

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.length > 0) {
                        const keepPercent = Math.min(data[0].keep_percent, 90); // Enforce max 90%
                        console.log('Loaded yield allocation from DB:', keepPercent + '% keep');
                        return keepPercent;
                    }
                }
            } catch (error) {
                console.error('Error loading yield allocation:', error);
            }

            return null; // No saved allocation found
        }

        // Initialize yield slider on page load
        document.addEventListener('DOMContentLoaded', function () {
            const savedKeepPercent = Math.min(localStorage.getItem('yieldKeepPercent') || 90, 90);
            const slider = document.getElementById('yieldSplitSlider');
            if (slider) {
                slider.value = savedKeepPercent;
                updateYieldSplit(savedKeepPercent);
            }
        });

        // ========== VAULT DETAILS PANEL ==========
        function toggleVaultDetails() {
            const panel = document.getElementById('vaultDetailsPanel');
            const btn = document.getElementById('vaultDetailsBtn');
            if (!panel) return;

            const isHidden = panel.style.display === 'none';
            panel.style.display = isHidden ? 'block' : 'none';
            if (btn) {
                btn.textContent = isHidden ? 'Details ‚ñ≤' : 'Details ‚ñº';
            }
        }

        function switchVaultTab(tab) {
            const depositTab = document.getElementById('vaultDepositTab');
            const withdrawTab = document.getElementById('vaultWithdrawTab');
            const yieldTab = document.getElementById('vaultYieldTab');
            const depositBtn = document.getElementById('vaultTabDeposit');
            const withdrawBtn = document.getElementById('vaultTabWithdraw');
            const yieldBtn = document.getElementById('vaultTabYield');

            // Hide all tabs, reset all buttons
            depositTab.style.display = 'none';
            withdrawTab.style.display = 'none';
            if (yieldTab) yieldTab.style.display = 'none';

            depositBtn.style.background = 'rgba(0,0,0,0.05)';
            depositBtn.style.color = '#6b7280';
            withdrawBtn.style.background = 'rgba(0,0,0,0.05)';
            withdrawBtn.style.color = '#6b7280';
            if (yieldBtn) {
                yieldBtn.style.background = 'rgba(0,0,0,0.05)';
                yieldBtn.style.color = '#6b7280';
            }

            if (tab === 'deposit') {
                depositTab.style.display = 'block';
                depositBtn.style.background = 'linear-gradient(135deg, #22c55e, #10b981)';
                depositBtn.style.color = 'white';
            } else if (tab === 'withdraw') {
                withdrawTab.style.display = 'block';
                withdrawBtn.style.background = 'linear-gradient(135deg, #ef4444, #dc2626)';
                withdrawBtn.style.color = 'white';
            } else if (tab === 'yield') {
                if (yieldTab) yieldTab.style.display = 'block';
                if (yieldBtn) {
                    yieldBtn.style.background = 'linear-gradient(135deg, #a855f7, #ec4899)';
                    yieldBtn.style.color = 'white';
                }
            }
        }

        function setMaxDeposit() {
            // TODO: Get actual wallet balance
            showNotification('‚ÑπÔ∏è', 'Coming Soon', 'Max deposit will use your wallet balance');
        }

        // Custom Asset Dropdown Functions
        function toggleAssetDropdown() {
            const dropdown = document.getElementById('assetDropdown');
            if (dropdown) {
                dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
            }
        }

        function selectAsset(symbol, iconUrl) {
            document.getElementById('selectedAssetIcon').src = iconUrl;
            document.getElementById('selectedAssetName').textContent = symbol;
            document.getElementById('depositAssetSelect').value = symbol;
            document.getElementById('assetDropdown').style.display = 'none';
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function (e) {
            const assetSelector = document.getElementById('assetSelector');
            if (assetSelector && !assetSelector.contains(e.target)) {
                document.getElementById('assetDropdown').style.display = 'none';
            }
        });

        function setMaxWithdraw() {
            // TODO: Get actual vault position
            showNotification('‚ÑπÔ∏è', 'Coming Soon', 'Max withdraw will use your vault position');
        }

        async function executeVaultDeposit() {
            const asset = document.getElementById('depositAssetSelect')?.value;
            const amount = document.getElementById('vaultDepositAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter an amount');
                return;
            }

            showNotification('üè¶', 'Deposit', `Depositing ${amount} ${asset} to vault...`);
            // TODO: Implement actual deposit logic with web3
        }

        async function executeVaultWithdraw() {
            const amount = document.getElementById('vaultWithdrawAmount')?.value;

            if (!amount || parseFloat(amount) <= 0) {
                showNotification('‚ö†Ô∏è', 'Error', 'Please enter an amount');
                return;
            }

            showNotification('üè¶', 'Withdraw', `Withdrawing $${amount} from vault...`);
            // TODO: Implement actual withdraw logic
        }

        // ========== ALL APPS ADMIN SECTION ==========
        const ADMIN_DISCORD_ID = '1135315153824993402';
        const ADMIN_API_URL = 'http://10.0.0.142:3000/api/admin';
        const ADMIN_SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const ADMIN_SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.rTqKxT2LYhPt5nQEjLxMxdRDqvVoT7eILWHhBo1MVHU';
        let adminApps = [];

        // Fetch features from app_features table for an app
        async function fetchAppFeatures(appId) {
            try {
                const response = await fetch(
                    `${ADMIN_SUPABASE_URL}/rest/v1/app_features?app_id=eq.${appId}&select=*`,
                    {
                        headers: {
                            'apikey': ADMIN_SUPABASE_KEY,
                            'Authorization': `Bearer ${ADMIN_SUPABASE_KEY}`
                        }
                    }
                );
                if (!response.ok) return { free: [], paid: [] };
                const features = await response.json();

                // Separate free and paid features
                const free = features
                    .filter(f => f.type === 'free' || f.type === 'freemium')
                    .map(f => f.name);
                const paid = features
                    .filter(f => f.type === 'paid')
                    .map(f => `${f.name} (${f.credit_cost || 0} credits)`);

                return { free, paid };
            } catch (err) {
                console.error('Error fetching app features:', err);
                return { free: [], paid: [] };
            }
        }

        async function loadAllAppsAdmin() {
            const grid = document.getElementById('adminAppsGrid');
            const count = document.getElementById('adminAppCount');
            if (!grid) return;

            try {
                const response = await fetch(`${ADMIN_API_URL}/get-apps?discord_id=${ADMIN_DISCORD_ID}`);
                const result = await response.json();
                if (!result.success) throw new Error(result.error);
                adminApps = result.apps || [];
                renderAdminApps();
            } catch (err) {
                console.error('Error loading admin apps:', err);
                grid.innerHTML = `<div style="text-align: center; padding: 40px; color: #ef4444; font-size: 0.9rem; grid-column: 1 / -1;">‚ö†Ô∏è ${err.message || 'Could not load apps'}</div>`;
            }
        }

        function renderAdminApps() {
            const grid = document.getElementById('adminAppsGrid');
            const count = document.getElementById('adminAppCount');

            if (adminApps.length === 0) {
                grid.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af; font-size: 0.9rem; grid-column: 1 / -1;">üì≠ No apps found.</div>';
                count.textContent = '0 apps';
                return;
            }

            count.textContent = `${adminApps.length} app${adminApps.length !== 1 ? 's' : ''}`;

            grid.innerHTML = adminApps.map(app => {
                const isLive = app.status === 'approved' || app.status === 'featured';
                const statusColor = isLive ? '#22c55e' : app.status === 'pending' ? '#f59e0b' : '#9ca3af';
                const statusLabel = app.status === 'approved' ? 'Live' :
                    app.status === 'featured' ? 'Featured' :
                        app.status === 'pending' ? 'Pending' : 'Offline';

                return `
                    <div style="background: rgba(255,255,255,0.8); border-radius: 16px; padding: 16px; display: flex; flex-direction: column; gap: 12px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <img src="${app.icon_url || 'assets/suite-logo-new.png'}" alt="${app.name}" 
                                style="width: 48px; height: 48px; border-radius: 12px; object-fit: cover;"
                                onerror="this.src='assets/suite-logo-new.png'">
                            <div style="flex: 1; min-width: 0;">
                                <div style="font-weight: 700; color: #2d1b4e; font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.name}</div>
                                <div style="font-size: 0.8rem; color: #6b7280; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.tagline || 'No tagline'}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                            <span style="display: inline-flex; align-items: center; gap: 4px; background: rgba(34, 197, 94, 0.1); color: ${statusColor}; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 700;">
                                <span style="width: 6px; height: 6px; background: ${statusColor}; border-radius: 50%;"></span>
                                ${statusLabel}
                            </span>
                            <span style="background: rgba(168, 85, 247, 0.1); color: #a855f7; padding: 4px 10px; border-radius: 100px; font-size: 0.75rem; font-weight: 600;">${app.category || 'app'}</span>
                        </div>
                        <div style="display: flex; gap: 8px; margin-top: auto;">
                            <a href="app.html?slug=${app.slug}" target="_blank"
                                style="flex: 1; text-align: center; padding: 8px; background: rgba(0,0,0,0.04); color: #2d1b4e; border-radius: 8px; font-size: 0.8rem; font-weight: 600; text-decoration: none;">View</a>
                            <button onclick="openEditModal('${app.slug}')"
                                style="flex: 1; padding: 8px; background: rgba(139, 92, 246, 0.1); color: #8b5cf6; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">Edit</button>
                            <button onclick="toggleAppLive('${app.slug}', ${isLive})"
                                style="flex: 1; padding: 8px; background: ${isLive ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'}; color: ${isLive ? '#ef4444' : '#22c55e'}; border: none; border-radius: 8px; font-size: 0.8rem; font-weight: 600; cursor: pointer;">
                                ${isLive ? 'Take Offline' : 'Go Live'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function toggleAppLive(slug, currentlyLive) {
            const newStatus = currentlyLive ? 'pending' : 'approved';
            try {
                const response = await fetch(`${ADMIN_API_URL}/update-app`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discord_id: ADMIN_DISCORD_ID,
                        slug: slug,
                        updates: { status: newStatus }
                    })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                // Update local state
                const app = adminApps.find(a => a.slug === slug);
                if (app) app.status = newStatus;
                renderAdminApps();
                showNotification(currentlyLive ? '‚è∏Ô∏è' : 'üü¢', 'Updated', `${slug} is now ${currentlyLive ? 'offline' : 'live'}`);
            } catch (err) {
                console.error('Toggle failed:', err);
                showNotification('‚ö†Ô∏è', 'Error', err.message);
            }
        }

        // Edit Modal Functions
        async function openEditModal(slug) {
            const app = adminApps.find(a => a.slug === slug);
            if (!app) {
                showNotification('‚ö†Ô∏è', 'Error', 'App not found');
                return;
            }

            document.getElementById('editAppSlug').value = slug;
            document.getElementById('editName').value = app.name || '';
            document.getElementById('editTagline').value = app.tagline || '';
            document.getElementById('editDescription').value = app.description || '';
            document.getElementById('editCategory').value = app.category || 'lifestyle';
            document.getElementById('editStatus').value = app.status || 'approved';
            document.getElementById('editAppUrl').value = app.app_url || '';
            document.getElementById('editIconUrl').value = app.icon_url || '';
            document.getElementById('editScreenshot1').value = app.screenshot_1 || '';
            document.getElementById('editScreenshot2').value = app.screenshot_2 || '';
            document.getElementById('editScreenshot3').value = app.screenshot_3 || '';
            document.getElementById('editScreenshot4').value = app.screenshot_4 || '';
            document.getElementById('editScreenshot5').value = app.screenshot_5 || '';

            // Fetch features from app_features table (auto-populate if defined in code)
            const dbFeatures = await fetchAppFeatures(slug);

            // Use database features if available, otherwise fall back to stored app data
            if (dbFeatures.free.length > 0 || dbFeatures.paid.length > 0) {
                document.getElementById('editFreeFeatures').value = dbFeatures.free.join('\n');
                document.getElementById('editProFeatures').value = dbFeatures.paid.join('\n');
            } else {
                document.getElementById('editFreeFeatures').value = app.free_features || '';
                document.getElementById('editProFeatures').value = app.pro_features || '';
            }

            // Show existing images
            showPreviewIfExists('iconPreview', 'iconPlaceholder', app.icon_url);
            showPreviewIfExists('ss1Preview', 'ss1Placeholder', app.screenshot_1, 'ss1Remove');
            showPreviewIfExists('ss2Preview', 'ss2Placeholder', app.screenshot_2, 'ss2Remove');
            showPreviewIfExists('ss3Preview', 'ss3Placeholder', app.screenshot_3, 'ss3Remove');
            showPreviewIfExists('ss4Preview', 'ss4Placeholder', app.screenshot_4, 'ss4Remove');
            showPreviewIfExists('ss5Preview', 'ss5Placeholder', app.screenshot_5, 'ss5Remove');

            document.getElementById('editModalOverlay').classList.add('active');
        }

        function showPreviewIfExists(previewId, placeholderId, url, removeId = null) {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            const removeBtn = removeId ? document.getElementById(removeId) : null;
            if (url) {
                preview.src = url;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
                if (removeBtn) removeBtn.style.display = 'block';
            } else {
                preview.style.display = 'none';
                placeholder.style.display = 'flex';
                if (removeBtn) removeBtn.style.display = 'none';
            }
        }

        function removeScreenshot(hiddenId, previewId, placeholderId, removeId) {
            document.getElementById(hiddenId).value = '';
            document.getElementById(previewId).style.display = 'none';
            document.getElementById(previewId).src = '';
            document.getElementById(placeholderId).style.display = 'flex';
            document.getElementById(removeId).style.display = 'none';
        }

        function closeEditModal() {
            document.getElementById('editModalOverlay').classList.remove('active');
        }

        // Close modal when clicking overlay
        document.getElementById('editModalOverlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) closeEditModal();
        });

        function handleEditDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        async function handleEditDrop(e, hiddenInputId) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type.startsWith('image/')) {
                await uploadEditImage(file, hiddenInputId);
            }
        }

        async function handleEditFileSelect(e, hiddenInputId, previewId, placeholderId) {
            const file = e.target.files[0];
            if (file) {
                const url = await uploadEditImage(file, hiddenInputId);
                if (url) {
                    // Derive remove button ID from preview ID (ss1Preview -> ss1Remove)
                    const removeId = previewId.replace('Preview', 'Remove');
                    showPreviewIfExists(previewId, placeholderId, url, removeId);
                }
            }
        }

        async function uploadEditImage(file, hiddenInputId) {
            // Upload to server
            const formData = new FormData();
            formData.append('file', file);
            formData.append('discord_id', ADMIN_DISCORD_ID);

            try {
                const response = await fetch(`${ADMIN_API_URL}/upload-image`, {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById(hiddenInputId).value = result.url;
                    console.log('Uploaded:', result.url);
                    return result.url;
                } else {
                    throw new Error(result.error);
                }
            } catch (err) {
                console.error('Upload failed:', err);
                showNotification('‚ö†Ô∏è', 'Upload Failed', err.message);
                return null;
            }
        }

        // Form submission
        document.getElementById('editAppForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const slug = document.getElementById('editAppSlug').value;
            const updates = {
                name: document.getElementById('editName').value,
                tagline: document.getElementById('editTagline').value,
                description: document.getElementById('editDescription').value,
                category: document.getElementById('editCategory').value,
                status: document.getElementById('editStatus').value,
                app_url: document.getElementById('editAppUrl').value,
                icon_url: document.getElementById('editIconUrl').value,
                free_features: document.getElementById('editFreeFeatures').value,
                pro_features: document.getElementById('editProFeatures').value,
                screenshot_1: document.getElementById('editScreenshot1').value || null,
                screenshot_2: document.getElementById('editScreenshot2').value || null,
                screenshot_3: document.getElementById('editScreenshot3').value || null,
                screenshot_4: document.getElementById('editScreenshot4').value || null,
                screenshot_5: document.getElementById('editScreenshot5').value || null
            };

            try {
                const response = await fetch(`${ADMIN_API_URL}/update-app`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        discord_id: ADMIN_DISCORD_ID,
                        slug: slug,
                        updates: updates
                    })
                });
                const result = await response.json();
                if (!result.success) throw new Error(result.error);

                // Update local state
                const app = adminApps.find(a => a.slug === slug);
                if (app) Object.assign(app, updates);

                renderAdminApps();
                closeEditModal();
                showNotification('‚úÖ', 'Saved', `${updates.name} has been updated`);
            } catch (err) {
                console.error('Save failed:', err);
                showNotification('‚ö†Ô∏è', 'Error', err.message);
            }
        });

        // Load admin apps when admin dashboard becomes visible
        const adminDashboard = document.getElementById('adminDashboard');
        if (adminDashboard) {
            const observer = new MutationObserver((mutations) => {
                mutations.forEach((mutation) => {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                        if (adminDashboard.style.display !== 'none') {
                            loadAllAppsAdmin();
                        }
                    }
                });
            });
            observer.observe(adminDashboard, { attributes: true });
        }
    </script>
</body>

</html>