<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | SUITE</title>
    <link rel="icon" type="image/png" href="/assets/suite-logo-new.png">
    <meta name="description" content="Your SUITE Profile - Buy credits, withdraw to USDC, and manage connected accounts.">

    <!-- Open Graph / Social Sharing -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://getsuite.app/profile.html">
    <meta property="og:title" content="Profile | SUITE">
    <meta property="og:description" content="Manage your SUITE profile, buy credits, and track your balance.">
    <meta property="og:image" content="https://getsuite.app/assets/images/1200x630-getsuite.jpg">
    <meta property="og:site_name" content="SUITE">

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Profile | SUITE">
    <meta name="twitter:description" content="Manage your SUITE profile, buy credits, and track your balance.">
    <meta name="twitter:image" content="https://getsuite.app/assets/images/1200x630-getsuite.jpg">
    <script src="https://cdn.jsdelivr.net/npm/ethers@6/dist/ethers.umd.min.js"></script>
    <link rel="stylesheet" href="/suite-styles.css">
    <link rel="stylesheet" href="/nav.css">
    <style>
        :root {
            --gradient-warm: linear-gradient(135deg, #FFFBF7 0%, #FEF7ED 30%, #FFF5EB 60%, #FEF3E7 100%);
            --accent-orange: #E8935A;
            --accent-terracotta: #C4725F;
            --accent-sage: #7D9B8A;
            --accent-green: #22c55e;
            --text-dark: #2D3748;
            --text-medium: #5A6578;
            --text-light: #8b9aaf;
            --card-bg: rgba(255, 255, 255, 0.85);
            --shadow-soft: 0 8px 32px rgba(0, 0, 0, 0.08);
            --shadow-hover: 0 16px 48px rgba(0, 0, 0, 0.12);
        }

        *, *::before, *::after {
            box-sizing: border-box;
        }

        body {
            font-family: 'Nunito', sans-serif;
            background: var(--gradient-warm);
            min-height: 100vh;
            color: var(--text-dark);
            overflow-x: hidden;
        }

        /* Animated background blobs */
        .bg-blob {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.4;
            z-index: -1;
            animation: float 20s ease-in-out infinite;
        }

        .blob-1 { width: 500px; height: 500px; background: #ffb3d9; top: -100px; left: -100px; }
        .blob-2 { width: 400px; height: 400px; background: #b3d4ff; top: 50%; right: -100px; animation-delay: -5s; }
        .blob-3 { width: 350px; height: 350px; background: #ffe0b3; bottom: -50px; left: 30%; animation-delay: -10s; }

        @keyframes float {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -30px) scale(1.05); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        .profile-page {
            padding-top: 100px;
            min-height: 100vh;
        }

        .profile-container {
            max-width: 600px;
            margin: 0 auto;
            padding: 0 16px 40px 16px;
        }

        /* Glass Card */
        .glass-card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            border-radius: 24px;
            padding: 24px;
            box-shadow: var(--shadow-soft);
            margin-bottom: 20px;
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 16px;
        }

        .card-header-icon {
            font-size: 1.5rem;
        }

        .card-header h2 {
            margin: 0;
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        /* Profile Card */
        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .profile-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
        }

        .profile-row-label {
            font-size: 0.9rem;
            color: var(--text-medium);
        }

        .profile-row-value {
            font-family: monospace;
            font-size: 0.9rem;
            color: var(--text-dark);
            font-weight: 600;
        }

        .profile-row-value a {
            color: var(--accent-terracotta);
            text-decoration: none;
        }

        .profile-row-value a:hover {
            text-decoration: underline;
        }

        /* Credits Row (Integrated in Profile) */
        .credits-row {
            background: linear-gradient(135deg, rgba(196, 114, 95, 0.08), rgba(232, 147, 90, 0.08)) !important;
            border: 1px solid rgba(196, 114, 95, 0.15);
            flex-wrap: wrap;
            gap: 12px;
        }

        .credits-inline-value {
            font-size: 1.4rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .redemption-badge {
            background: linear-gradient(135deg, var(--accent-sage), #5a8a6f);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
        }

        .credits-inline-actions {
            display: flex;
            gap: 8px;
        }

        .btn-credits-sm {
            padding: 8px 14px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-buy-sm {
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            color: white;
        }

        .btn-buy-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(196, 114, 95, 0.3);
        }

        .btn-withdraw-sm {
            background: linear-gradient(135deg, var(--accent-green), #10b981);
            color: white;
        }

        .btn-withdraw-sm:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .btn-credits-sm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Legacy Credits Card styles (kept for modals) */
        .credits-balance {
            text-align: center;
            padding: 24px;
            background: linear-gradient(135deg, rgba(196, 114, 95, 0.1), rgba(232, 147, 90, 0.1));
            border-radius: 16px;
            margin-bottom: 20px;
        }

        .credits-balance-value {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 0;
        }

        .credits-balance-label {
            font-size: 1rem;
            color: var(--text-medium);
            margin-top: 4px;
        }

        .credits-actions {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn-credits {
            padding: 16px 24px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-buy {
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            color: white;
            box-shadow: 0 4px 15px rgba(196, 114, 95, 0.3);
        }

        .btn-buy:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(196, 114, 95, 0.4);
        }

        .btn-withdraw {
            background: linear-gradient(135deg, var(--accent-green), #10b981);
            color: white;
            box-shadow: 0 4px 15px rgba(34, 197, 94, 0.3);
        }

        .btn-withdraw:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(34, 197, 94, 0.4);
        }

        .btn-credits:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .credits-info {
            text-align: center;
            font-size: 0.85rem;
            color: var(--text-light);
            padding: 12px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .defi-link {
            display: block;
            text-align: center;
            margin-top: 16px;
            font-size: 0.85rem;
            color: var(--text-light);
            text-decoration: none;
        }

        .defi-link:hover {
            color: var(--accent-terracotta);
        }

        @media (max-width: 480px) {
            .credits-row {
                flex-direction: column;
                align-items: stretch !important;
                gap: 12px;
            }

            .credits-row > div:first-child {
                justify-content: space-between;
            }

            .credits-inline-actions {
                justify-content: stretch;
            }

            .btn-credits-sm {
                flex: 1;
                justify-content: center;
            }
        }

        /* Connected Accounts */
        .account-item {
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 14px 16px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            margin-bottom: 10px;
        }

        .account-item:last-child {
            margin-bottom: 0;
        }

        .account-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .account-icon.wallet {
            background: rgba(196, 114, 95, 0.15);
        }

        .account-icon.telegram {
            background: rgba(0, 136, 204, 0.15);
            color: #0088cc;
        }

        .account-info {
            flex: 1;
        }

        .account-type {
            font-size: 0.8rem;
            color: var(--text-light);
        }

        .account-value {
            font-weight: 600;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .btn-account {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-disconnect {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
        }

        .btn-disconnect:hover {
            background: rgba(239, 68, 68, 0.2);
        }

        .btn-connect {
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            color: white;
        }

        .btn-connect:hover {
            transform: translateY(-1px);
        }

        /* Admin Section */
        .admin-card {
            border: 2px solid rgba(239, 68, 68, 0.2);
        }

        .admin-badge {
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: auto;
        }

        .admin-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn-admin {
            padding: 14px 20px;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.5);
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .btn-admin:hover {
            background: rgba(255, 255, 255, 0.8);
            transform: translateX(4px);
        }

        .btn-admin-icon {
            font-size: 1.2rem;
        }

        /* Action Buttons (Vote, Request) */
        .btn-action {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 12px 20px;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.2s ease;
            cursor: pointer;
            border: none;
        }

        .btn-action-dark {
            background: var(--text-dark);
        }

        .btn-action-dark:hover {
            background: #1a202c;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .btn-action-gradient {
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
        }

        .btn-action-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(196, 114, 95, 0.4);
            filter: brightness(1.1);
        }

        /* Not Connected State */
        .not-connected {
            text-align: center;
            padding: 40px 20px;
        }

        .not-connected-icon {
            font-size: 4rem;
            margin-bottom: 16px;
        }

        .not-connected h2 {
            margin: 0 0 10px 0;
            font-size: 1.5rem;
        }

        .not-connected p {
            color: var(--text-medium);
            margin-bottom: 24px;
        }

        .btn-connect-large {
            padding: 16px 40px;
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            color: white;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 4px 20px rgba(196, 114, 95, 0.3);
        }

        .btn-connect-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(196, 114, 95, 0.4);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: white;
            border-radius: 24px;
            padding: clamp(20px, 5vw, 28px);
            width: 95%;
            max-width: min(400px, 95vw);
            position: relative;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
            margin: 0 auto;
        }

        .modal-close {
            position: absolute;
            top: 16px;
            right: 16px;
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-light);
            cursor: pointer;
        }

        .modal h3 {
            margin: 0 0 20px 0;
            font-size: 1.3rem;
        }

        .modal-input-group {
            margin-bottom: 16px;
        }

        .modal-input-group label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-bottom: 8px;
        }

        .modal-input {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .modal-input:focus {
            outline: none;
            border-color: var(--accent-terracotta);
        }

        .modal-preview {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, rgba(196, 114, 95, 0.1), rgba(232, 147, 90, 0.1));
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .modal-preview-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-dark);
        }

        .modal-preview-label {
            font-size: 0.85rem;
            color: var(--text-medium);
        }

        .btn-modal-action {
            width: 100%;
            padding: 16px;
            border: none;
            border-radius: 14px;
            font-size: 1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-modal-action.buy {
            background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange));
            color: white;
        }

        .btn-modal-action.withdraw {
            background: linear-gradient(135deg, var(--accent-green), #10b981);
            color: white;
        }

        .btn-modal-action:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal-note {
            text-align: center;
            font-size: 0.8rem;
            color: var(--text-light);
            margin-top: 12px;
        }

        /* Fiat amount buttons */
        .fiat-amount-btn {
            flex: 1;
            padding: 10px 8px;
            border: 2px solid rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
            font-weight: 700;
            font-size: 0.9rem;
            color: var(--text-dark);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .fiat-amount-btn:hover {
            border-color: var(--accent-terracotta);
            background: rgba(196, 114, 95, 0.1);
        }

        .fiat-amount-btn.active {
            border-color: var(--accent-terracotta);
            background: var(--accent-terracotta);
            color: white;
        }

        /* Toast notifications */
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--text-dark);
            color: white;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            z-index: 10001;
            opacity: 0;
            transition: all 0.3s ease;
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .toast.success {
            background: var(--accent-green);
        }

        .toast.error {
            background: #ef4444;
        }

        @media (max-width: 500px) {
            .credits-actions {
                grid-template-columns: 1fr;
            }
        }

        /* Small phone responsive (375-480px) */
        @media (max-width: 480px) {
            .profile-page {
                padding-top: 80px;
            }

            .profile-container {
                padding: 0 12px 30px;
            }

            .glass-card {
                padding: 20px 16px;
                border-radius: 20px;
            }

            .card-header h2 {
                font-size: 1.1rem;
            }

            .credits-balance-value {
                font-size: 2.5rem;
            }

            .btn-credits {
                padding: 14px 20px;
                font-size: 0.95rem;
            }

            .modal h3 {
                font-size: 1.15rem;
            }

            .modal-input {
                padding: 12px 14px;
                font-size: 0.95rem;
            }

            .fiat-amount-btn {
                padding: 10px 6px;
                font-size: 0.85rem;
            }

            .not-connected {
                padding: 30px 16px;
            }

            .not-connected-icon {
                font-size: 3rem;
            }

            .not-connected h2 {
                font-size: 1.3rem;
            }

            .btn-connect-large {
                padding: 14px 32px;
                font-size: 1rem;
            }
        }

        /* Extra small screens (320-375px) */
        @media (max-width: 375px) {
            .profile-page {
                padding-top: 70px;
            }

            .profile-container {
                padding: 0 8px 24px;
            }

            .glass-card {
                padding: 16px 12px;
                border-radius: 16px;
            }

            .card-header h2 {
                font-size: 1rem;
            }

            .profile-row {
                padding: 10px 12px;
                flex-wrap: wrap;
                gap: 8px;
            }

            .profile-row-label,
            .profile-row-value {
                font-size: 0.85rem;
            }

            .credits-inline-value {
                font-size: 1.2rem;
            }

            .btn-credits-sm {
                padding: 6px 10px;
                font-size: 0.75rem;
            }

            .credits-balance-value {
                font-size: 2rem;
            }

            .account-item {
                padding: 12px;
                gap: 10px;
            }

            .account-icon {
                width: 36px;
                height: 36px;
                font-size: 1rem;
            }

            .account-value {
                font-size: 0.8rem;
            }

            .btn-account {
                padding: 6px 12px;
                font-size: 0.75rem;
            }

            .toast {
                padding: 12px 20px;
                font-size: 0.9rem;
                max-width: 90vw;
            }
        }
    </style>
</head>

<body>
    <!-- Background blobs -->
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div class="bg-blob blob-3"></div>

    <nav id="main-nav"></nav>
    <script src="/nav-component.js"></script>

    <div class="profile-page">
        <div class="profile-container">
            <!-- Not Connected State -->
            <div id="notConnectedState" class="glass-card not-connected">
                <div class="not-connected-icon">&#128100;</div>
                <h2>Welcome to SUITE</h2>
                <p>Connect to view your profile, buy credits, and use SUITE apps.</p>
                <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 20px;">
                    <button class="btn-connect-large" onclick="connectWalletFromNav()">
                        <span style="margin-right: 8px;">&#128279;</span> Connect Wallet
                    </button>
                    <button class="btn-connect-large" style="background: linear-gradient(135deg, #0088cc, #00a8e8);" onclick="loginWithTelegramWidget()">
                        <span style="margin-right: 8px;">&#9993;</span> Continue with Telegram
                    </button>
                </div>
                <p style="font-size: 0.8rem; color: var(--text-light); margin-top: 16px;">
                    Wallet required to buy credits. Telegram lets you vote &amp; submit ideas.
                </p>
            </div>

            <!-- Connected State (hidden by default) -->
            <div id="connectedState" style="display: none;">
                <!-- Profile Card (with integrated Credits) -->
                <div class="glass-card">
                    <div class="card-header">
                        <span class="card-header-icon">&#128100;</span>
                        <h2>Your Profile</h2>
                    </div>
                    <div class="profile-info">
                        <!-- Wallet Row -->
                        <div class="profile-row">
                            <span class="profile-row-label">Wallet</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="profile-row-value" id="profileWalletAddress">-</span>
                                <button class="btn-account btn-connect" onclick="connectWalletFromNav()" id="btnConnectWallet" style="display: none;">Connect</button>
                                <button class="btn-account btn-disconnect" onclick="disconnectWallet(); checkConnection();" id="btnDisconnectWallet">Disconnect</button>
                            </div>
                        </div>
                        <!-- Telegram Row -->
                        <div class="profile-row" id="telegramRow">
                            <span class="profile-row-label">Telegram</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="profile-row-value" id="profileTelegram">Not linked</span>
                                <button class="btn-account btn-connect" onclick="loginWithTelegramWidget()" id="btnLinkTelegram">Link</button>
                                <button class="btn-account btn-disconnect" onclick="disconnectTelegram(); checkConnection();" id="btnUnlinkTelegram" style="display: none;">Unlink</button>
                            </div>
                        </div>
                        <!-- Credits Row (integrated) -->
                        <div class="profile-row credits-row">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span class="profile-row-label">Credits</span>
                                <span class="credits-inline-value" id="creditsBalance">0</span>
                            </div>
                            <div class="credits-inline-actions">
                                <button class="btn-credits-sm btn-buy-sm" onclick="openBuyModal()" id="btnBuy" title="Buy Credits">
                                    <span>+</span> Buy
                                </button>
                                <button class="btn-credits-sm btn-withdraw-sm" onclick="openWithdrawModal()" id="btnWithdraw" title="Withdraw to USDC">
                                    Withdraw
                                </button>
                            </div>
                        </div>
                        <!-- Bonus Credits Row -->
                        <div class="profile-row" style="background: rgba(125, 155, 138, 0.08); border: 1px solid rgba(125, 155, 138, 0.15);">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span class="profile-row-label">Bonus Credits</span>
                                <span style="font-weight: 700; color: var(--accent-sage);" id="bonusCreditsBalance">0</span>
                            </div>
                            <a href="/docs/vault/" style="font-size: 0.8rem; color: var(--accent-sage); text-decoration: none;">Learn more →</a>
                        </div>
                    </div>
                </div>

                <!-- Vote for Apps Card -->
                <div class="glass-card">
                    <div class="card-header">
                        <span class="card-header-icon">&#128499;</span>
                        <h2>Vote for Apps</h2>
                    </div>
                    <div style="text-align: center; padding: 16px 0;">
                        <p style="color: var(--text-medium); margin-bottom: 20px; font-size: 0.95rem;">
                            Help decide what gets built next. Vote on polls or request a new app.
                        </p>
                        <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                            <a href="https://x.com/getsuiteapp" target="_blank" rel="noopener" class="btn-action btn-action-dark">
                                Vote on <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="vertical-align: middle;"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg>
                            </a>
                            <a href="/factory.html?tab=governance" class="btn-action btn-action-gradient">
                                Request an App
                            </a>
                        </div>
                    </div>
                </div>

                <!-- Admin Card (hidden by default) -->
                <div class="glass-card admin-card" id="adminSection" style="display: none;">
                    <div class="card-header">
                        <span class="card-header-icon">&#9881;&#65039;</span>
                        <h2>Admin</h2>
                        <span class="admin-badge">ADMIN ONLY</span>
                    </div>

                    <!-- Apps Admin Dashboard -->
                    <div id="appsAdminPanel" style="margin-bottom: 24px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-dark);">Apps Dashboard</h3>
                            <button onclick="openAddAppModal()" style="padding: 8px 14px; background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange)); color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 0.85rem;">+ Add App</button>
                        </div>

                        <!-- Apps List -->
                        <div id="appsAdminList" style="display: flex; flex-direction: column; gap: 10px; max-height: 400px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px; color: var(--text-light);">Loading apps...</div>
                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid rgba(0,0,0,0.08); margin: 20px 0;">

                    <!-- Redemption Dashboard (always visible for admins) -->
                    <div id="redemptionPanel" style="margin-top: 8px;">
                        <div style="padding-top: 8px;">

                            <!-- Rate Display -->
                            <div style="text-align: center; padding: 20px; background: linear-gradient(135deg, rgba(196, 114, 95, 0.1), rgba(232, 147, 90, 0.1)); border-radius: 16px; margin-bottom: 20px;">
                                <div style="font-size: 2.5rem; font-weight: 900; background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange)); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;" id="adminRedemptionRate">--%</div>
                                <div style="font-size: 0.9rem; color: var(--text-medium);">Current Redemption Rate</div>
                            </div>

                            <!-- Stats Grid -->
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                                <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--accent-terracotta);" id="adminTotalCredits">--</div>
                                    <div style="font-size: 0.75rem; color: var(--text-medium);">Total Bonus Credits</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--accent-green);" id="adminReportedValue">$--</div>
                                    <div style="font-size: 0.75rem; color: var(--text-medium);">Reported Value</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 1.3rem; font-weight: 800; color: var(--accent-orange);" id="adminPendingRequests">$--</div>
                                    <div style="font-size: 0.75rem; color: var(--text-medium);">Pending Requests</div>
                                </div>
                                <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; text-align: center;">
                                    <div style="font-size: 1.3rem; font-weight: 800; color: #3b82f6;" id="adminFundedPool">$--</div>
                                    <div style="font-size: 0.75rem; color: var(--text-medium);">Funded Pool</div>
                                </div>
                            </div>

                            <!-- Report Liquid Value -->
                            <div style="background: rgba(196, 114, 95, 0.05); border: 1px solid rgba(196, 114, 95, 0.2); border-radius: 12px; padding: 16px; margin-bottom: 16px;">
                                <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-terracotta);">Report Liquid Value</div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="adminLiquidValueInput" placeholder="Enter USDC"
                                           style="flex: 1; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 1rem;"
                                           oninput="previewAdminRate()">
                                    <button onclick="adminReportValue()" id="btnAdminReport"
                                            style="padding: 12px 20px; background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange)); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">
                                        Update
                                    </button>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 8px;" id="adminRatePreview">Enter value to preview new rate</div>
                            </div>

                            <!-- Fund Pool -->
                            <div style="background: rgba(34, 197, 94, 0.05); border: 1px solid rgba(34, 197, 94, 0.2); border-radius: 12px; padding: 16px;">
                                <div style="font-weight: 700; margin-bottom: 12px; color: var(--accent-green);">Fund Pool</div>
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="adminFundInput" placeholder="USDC amount"
                                           style="flex: 1; padding: 12px; border: 1px solid #e5e7eb; border-radius: 10px; font-size: 1rem;">
                                    <button onclick="adminFundPool()" id="btnAdminFund"
                                            style="padding: 12px 20px; background: linear-gradient(135deg, var(--accent-green), #10b981); color: white; border: none; border-radius: 10px; font-weight: 700; cursor: pointer;">
                                        Fund
                                    </button>
                                </div>
                                <div style="font-size: 0.8rem; color: var(--text-light); margin-top: 8px;">
                                    <a href="#" onclick="autoFillAdminPending(); return false;" style="color: var(--accent-green);">Fill pending amount</a>
                                </div>
                            </div>

                            <!-- Contract Not Deployed Warning -->
                            <div id="contractNotDeployed" style="display: none; text-align: center; padding: 20px; background: rgba(239, 68, 68, 0.1); border-radius: 12px; margin-top: 16px;">
                                <div style="font-size: 1.5rem; margin-bottom: 8px;">&#128679;</div>
                                <div style="font-weight: 700; color: #ef4444;">Contract Not Deployed</div>
                                <div style="font-size: 0.85rem; color: var(--text-medium);">Deploy UsdcWithdrawals and update the address</div>
                            </div>

                        </div>
                    </div>

                    <hr style="border: none; border-top: 1px solid rgba(0,0,0,0.08); margin: 20px 0;">

                    <!-- Operator Applications Panel -->
                    <div id="operatorApplicationsPanel" style="margin-top: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px;">
                            <h3 style="margin: 0; font-size: 1rem; font-weight: 700; color: var(--text-dark);">Operator Applications</h3>
                            <div style="display: flex; gap: 8px;">
                                <select id="appFilterSelect" onchange="filterApplications()" style="padding: 6px 10px; border: 1px solid #e5e7eb; border-radius: 8px; font-size: 0.8rem; background: white;">
                                    <option value="pending">Pending</option>
                                    <option value="under_review">Under Review</option>
                                    <option value="accepted">Accepted</option>
                                    <option value="rejected">Rejected</option>
                                    <option value="all">All</option>
                                </select>
                                <button onclick="refreshApplications()" style="padding: 6px 12px; background: rgba(255,255,255,0.5); border: 1px solid #e5e7eb; border-radius: 8px; cursor: pointer; font-size: 0.8rem;">Refresh</button>
                            </div>
                        </div>

                        <!-- Applications Stats -->
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; margin-bottom: 16px;">
                            <div style="background: rgba(251, 191, 36, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 800; color: #f59e0b;" id="pendingCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-medium);">Pending</div>
                            </div>
                            <div style="background: rgba(59, 130, 246, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 800; color: #3b82f6;" id="reviewCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-medium);">Reviewing</div>
                            </div>
                            <div style="background: rgba(34, 197, 94, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 800; color: #22c55e;" id="acceptedCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-medium);">Accepted</div>
                            </div>
                            <div style="background: rgba(239, 68, 68, 0.1); border-radius: 10px; padding: 12px; text-align: center;">
                                <div style="font-size: 1.3rem; font-weight: 800; color: #ef4444;" id="rejectedCount">0</div>
                                <div style="font-size: 0.7rem; color: var(--text-medium);">Rejected</div>
                            </div>
                        </div>

                        <!-- Applications List -->
                        <div id="operatorApplicationsList" style="display: flex; flex-direction: column; gap: 12px; max-height: 500px; overflow-y: auto;">
                            <div style="text-align: center; padding: 24px; color: var(--text-light);">Loading applications...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Buy Credits Modal -->
    <div class="modal-overlay" id="buyModal" onclick="if(event.target === this) closeBuyModal()">
        <div class="modal">
            <button class="modal-close" onclick="closeBuyModal()">&times;</button>

            <!-- Step 1: Choose Payment Method -->
            <div id="buyMethodState">
                <h3>Buy Credits</h3>
                <p style="color: var(--text-medium); font-size: 0.9rem; margin-bottom: 20px;">Choose how you'd like to pay</p>

                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button onclick="showBuyCryptoState()" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: rgba(255, 255, 255, 0.5); border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 14px; cursor: pointer; transition: all 0.2s ease; text-align: left;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, #627EEA, #3B5998); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem;">&#9830;</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--text-dark);">Pay with Crypto</div>
                            <div style="font-size: 0.8rem; color: var(--text-medium);">USDC on Base network</div>
                        </div>
                        <span style="color: var(--text-light);">&#8250;</span>
                    </button>

                    <button onclick="showBuyFiatState()" style="display: flex; align-items: center; gap: 14px; padding: 16px; background: rgba(255, 255, 255, 0.5); border: 2px solid rgba(0, 0, 0, 0.1); border-radius: 14px; cursor: pointer; transition: all 0.2s ease; text-align: left;">
                        <div style="width: 44px; height: 44px; background: linear-gradient(135deg, var(--accent-terracotta), var(--accent-orange)); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.3rem;">&#128179;</div>
                        <div style="flex: 1;">
                            <div style="font-weight: 700; color: var(--text-dark);">Pay with Card</div>
                            <div style="font-size: 0.8rem; color: var(--text-medium);">Credit/debit card via Stripe</div>
                        </div>
                        <span style="color: var(--text-light);">&#8250;</span>
                    </button>
                </div>

                <div style="text-align: center; margin-top: 20px; padding-top: 16px; border-top: 1px solid rgba(0,0,0,0.1);">
                    <div style="font-size: 0.85rem; color: var(--text-medium);"><strong>$1 = 1,000 Credits</strong></div>
                </div>
            </div>

            <!-- Step 2a: Crypto Payment -->
            <div id="buyCryptoState" style="display: none;">
                <div onclick="showBuyMethodState()" style="color: var(--text-medium); font-size: 0.85rem; cursor: pointer; margin-bottom: 16px;">&#8592; Back</div>
                <h3>Pay with Crypto</h3>
                <div class="modal-input-group">
                    <label>Amount (USDC)</label>
                    <input type="number" class="modal-input" id="buyAmount" placeholder="10" min="1" step="1" oninput="updateBuyPreview()">
                </div>
                <div class="modal-preview">
                    <div class="modal-preview-value" id="buyPreviewCredits">10,000</div>
                    <div class="modal-preview-label">Credits you'll receive</div>
                </div>
                <button class="btn-modal-action buy" id="btnBuyConfirm" onclick="executeBuy()">
                    Pay with USDC
                </button>
                <p class="modal-note">Requires USDC on Base network</p>
                <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px; font-size: 0.75rem; color: var(--text-light); line-height: 1.5;">
                    <strong style="color: var(--text-medium);">Please note:</strong> Your credits are used for AI features in apps. As the reward pool grows, you'll earn bonus credits that can be withdrawn. Pool performance can go up or down. <a href="/docs/vault/" style="color: var(--accent-terracotta);">Learn more →</a>
                </div>
            </div>

            <!-- Step 2b: Fiat Payment -->
            <div id="buyFiatState" style="display: none;">
                <div onclick="showBuyMethodState()" style="color: var(--text-medium); font-size: 0.85rem; cursor: pointer; margin-bottom: 16px;">&#8592; Back</div>
                <h3>Pay with Card</h3>

                <div class="modal-input-group">
                    <label>Amount (USD)</label>
                    <div style="display: flex; gap: 8px; margin-bottom: 12px;">
                        <button onclick="setFiatAmount(5)" class="fiat-amount-btn" data-amount="5">$5</button>
                        <button onclick="setFiatAmount(10)" class="fiat-amount-btn active" data-amount="10">$10</button>
                        <button onclick="setFiatAmount(25)" class="fiat-amount-btn" data-amount="25">$25</button>
                        <button onclick="setFiatAmount(50)" class="fiat-amount-btn" data-amount="50">$50</button>
                    </div>
                    <input type="number" class="modal-input" id="fiatAmount" placeholder="10" min="1" max="1000" step="1" value="10" oninput="updateFiatPreview()">
                </div>
                <div class="modal-preview">
                    <div class="modal-preview-value" id="fiatPreviewCredits">10,000</div>
                    <div class="modal-preview-label">Credits you'll receive</div>
                </div>
                <button class="btn-modal-action buy" id="btnFiatPay" onclick="initiateStripeCheckout()">
                    <span id="fiatPayText">Pay $10 with Card</span>
                </button>
                <p class="modal-note" style="display: flex; align-items: center; justify-content: center; gap: 6px;">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    Secure payment via Stripe
                </p>
                <div style="margin-top: 16px; padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px; font-size: 0.75rem; color: var(--text-light); line-height: 1.5;">
                    <strong style="color: var(--text-medium);">Please note:</strong> Your credits are used for AI features in apps. As the reward pool grows, you'll earn bonus credits that can be withdrawn. Pool performance can go up or down. <a href="/docs/vault/" style="color: var(--accent-terracotta);">Learn more →</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Withdraw Modal -->
    <div class="modal-overlay" id="withdrawModal" onclick="if(event.target === this) closeWithdrawModal()">
        <div class="modal">
            <button class="modal-close" onclick="closeWithdrawModal()">&times;</button>

            <!-- Default State: Request Withdrawal -->
            <div id="withdrawRequestState">
                <h3>Withdraw Credits</h3>
                <p style="color: var(--text-medium); font-size: 0.85rem; margin-bottom: 16px;">Convert your credits back to USDC</p>

                <!-- Rate Info -->
                <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(16, 185, 129, 0.1)); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--accent-green);" id="withdrawRate">--%</div>
                    <div style="font-size: 0.85rem; color: var(--text-medium);">Current Rate</div>
                </div>

                <div style="background: rgba(255,255,255,0.5); border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--text-medium); font-size: 0.9rem;">Your Bonus Credits</span>
                        <span style="font-weight: 700;" id="withdrawBonusCredits">0</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="color: var(--text-medium); font-size: 0.9rem;">Max Redeemable</span>
                        <span style="font-weight: 700; color: var(--accent-green);" id="withdrawMaxUsdc">$0.00</span>
                    </div>
                </div>

                <div class="modal-input-group">
                    <label>Amount to withdraw (USDC)</label>
                    <input type="number" class="modal-input" id="withdrawAmount" placeholder="0.00" step="0.01" oninput="updateWithdrawPreview()">
                </div>

                <div class="modal-preview">
                    <div class="modal-preview-value" id="withdrawPreviewCredits">0</div>
                    <div class="modal-preview-label">Credits will be used</div>
                </div>

                <button class="btn-modal-action withdraw" id="btnWithdrawRequest" onclick="requestWithdrawal()">
                    Request Withdrawal
                </button>
                <p class="modal-note">You'll be able to claim once the pool is funded</p>
            </div>

            <!-- Pending State: Waiting for funding -->
            <div id="withdrawPendingState" style="display: none;">
                <h3>Withdrawal Pending</h3>

                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">&#9203;</div>
                    <div style="font-size: 1.8rem; font-weight: 800; color: var(--accent-orange);" id="pendingAmount">$0.00</div>
                    <div style="color: var(--text-medium); margin-top: 8px;">Waiting for pool funding</div>
                </div>

                <div style="background: rgba(255, 149, 0, 0.1); border-radius: 12px; padding: 16px; margin-bottom: 20px; text-align: center;">
                    <div style="font-size: 0.9rem; color: var(--text-medium);">
                        Your request is in queue. You'll be able to claim once funded.
                    </div>
                </div>

                <button class="btn-modal-action" style="background: rgba(239, 68, 68, 0.1); color: #ef4444;" onclick="cancelWithdrawal()">
                    Cancel Request
                </button>
                <p class="modal-note">Canceling will return your credits</p>
            </div>

            <!-- Claimable State: Ready to claim -->
            <div id="withdrawClaimState" style="display: none;">
                <h3>Ready to Claim!</h3>

                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">&#127881;</div>
                    <div style="font-size: 2.5rem; font-weight: 800; color: var(--accent-green);" id="claimAmount">$0.00</div>
                    <div style="color: var(--text-medium); margin-top: 8px;">USDC ready to claim</div>
                </div>

                <button class="btn-modal-action withdraw" id="btnClaim" onclick="claimWithdrawal()">
                    Claim USDC
                </button>
                <p class="modal-note">USDC will be sent to your wallet</p>
            </div>

            <!-- No Bonus Credits State -->
            <div id="withdrawNoCreditsState" style="display: none;">
                <h3>No Bonus Credits</h3>

                <div style="text-align: center; padding: 30px 0;">
                    <div style="font-size: 3rem; margin-bottom: 16px;">&#128566;</div>
                    <div style="color: var(--text-medium);">
                        You don't have any bonus credits to withdraw.<br><br>
                        Bonus credits are earned through rewards and promotions.<br><br>
                        <a href="/docs/suite-token.html" style="color: var(--accent-terracotta); text-decoration: none; font-weight: 600;">Learn more &rarr;</a>
                    </div>
                </div>

                <button class="btn-modal-action" style="background: var(--text-light); color: var(--text-dark);" onclick="closeWithdrawModal()">
                    Got it
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- App Edit Modal -->
    <div class="modal-overlay" id="appEditModal" onclick="if(event.target === this) closeAppEditModal()">
        <div class="modal" style="max-width: 500px;">
            <button class="modal-close" onclick="closeAppEditModal()">&times;</button>
            <h3 id="appEditModalTitle">Edit App</h3>

            <div style="display: flex; flex-direction: column; gap: 14px;">
                <input type="hidden" id="appEditId">

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>App Name</label>
                    <input type="text" class="modal-input" id="appEditName" placeholder="e.g. TrueForm">
                </div>

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>Slug (URL-friendly)</label>
                    <input type="text" class="modal-input" id="appEditSlug" placeholder="e.g. trueform" style="font-family: monospace;">
                </div>

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>Short Tagline</label>
                    <input type="text" class="modal-input" id="appEditTagline" placeholder="e.g. Recovery tracking">
                </div>

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>Description</label>
                    <textarea class="modal-input" id="appEditDescription" placeholder="Full description of the app..." rows="3" style="resize: vertical;"></textarea>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                    <div class="modal-input-group" style="margin-bottom: 0;">
                        <label>Category</label>
                        <select class="modal-input" id="appEditCategory">
                            <option value="health">Health</option>
                            <option value="productivity">Productivity</option>
                            <option value="finance">Finance</option>
                            <option value="creative">Creative</option>
                            <option value="games">Games</option>
                        </select>
                    </div>

                    <div class="modal-input-group" style="margin-bottom: 0;">
                        <label>Status</label>
                        <select class="modal-input" id="appEditStatus">
                            <option value="approved">Approved (Live)</option>
                            <option value="pending">Pending</option>
                            <option value="beta">Beta</option>
                            <option value="hidden">Hidden</option>
                        </select>
                    </div>
                    <div class="modal-input-group" style="margin-bottom: 0;">
                        <label>Best Viewed On</label>
                        <select class="modal-input" id="appEditPlatform">
                            <option value="both">📱💻 Mobile & Web</option>
                            <option value="mobile">📱 Mobile First</option>
                            <option value="web">💻 Web First</option>
                        </select>
                    </div>
                </div>

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>App Icon</label>
                    <div id="iconDropZone" style="border: 2px dashed rgba(0,0,0,0.2); border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.2s; background: rgba(255,255,255,0.5);">
                        <img id="appEditIconPreview" src="" style="width: 64px; height: 64px; border-radius: 12px; object-fit: cover; display: none; margin: 0 auto 8px;">
                        <div id="iconDropText" style="color: var(--text-light); font-size: 0.85rem;">
                            📁 Drop image here or click to upload
                        </div>
                        <input type="file" id="iconFileInput" accept="image/*" style="display: none;">
                        <div id="iconUploadProgress" style="display: none; margin-top: 8px;">
                            <div style="background: rgba(0,0,0,0.1); border-radius: 4px; height: 4px; overflow: hidden;">
                                <div id="iconProgressBar" style="background: var(--accent-green); height: 100%; width: 0%; transition: width 0.3s;"></div>
                            </div>
                            <span style="font-size: 0.75rem; color: var(--text-light);">Uploading...</span>
                        </div>
                    </div>
                    <input type="hidden" id="appEditIcon">
                    <div style="margin-top: 8px; font-size: 0.75rem; color: var(--text-light);">
                        Or enter URL directly: <input type="text" id="appEditIconUrl" class="modal-input" style="margin-top: 4px; font-size: 0.85rem;" placeholder="https://... or /assets/icons/...">
                    </div>
                </div>

                <div class="modal-input-group" style="margin-bottom: 12px;">
                    <label>Screenshots (up to 5)</label>
                    <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-top: 8px;">
                        <div class="screenshot-drop-zone" style="aspect-ratio: 9/16; border: 2px dashed rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.3); font-size: 1.5rem; color: var(--text-light);">
                            +
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                        <div class="screenshot-drop-zone" style="aspect-ratio: 9/16; border: 2px dashed rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.3); font-size: 1.5rem; color: var(--text-light);">
                            +
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                        <div class="screenshot-drop-zone" style="aspect-ratio: 9/16; border: 2px dashed rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.3); font-size: 1.5rem; color: var(--text-light);">
                            +
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                        <div class="screenshot-drop-zone" style="aspect-ratio: 9/16; border: 2px dashed rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.3); font-size: 1.5rem; color: var(--text-light);">
                            +
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                        <div class="screenshot-drop-zone" style="aspect-ratio: 9/16; border: 2px dashed rgba(0,0,0,0.2); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.3); font-size: 1.5rem; color: var(--text-light);">
                            +
                            <input type="file" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    <input type="hidden" id="appEditScreenshot1">
                    <input type="hidden" id="appEditScreenshot2">
                    <input type="hidden" id="appEditScreenshot3">
                    <input type="hidden" id="appEditScreenshot4">
                    <input type="hidden" id="appEditScreenshot5">
                </div>

                <div class="modal-input-group" style="margin-bottom: 0;">
                    <label>App URL (if external)</label>
                    <input type="text" class="modal-input" id="appEditUrl" placeholder="Leave blank for suite-shell apps">
                </div>

                <div style="display: flex; gap: 12px; margin-top: 8px;">
                    <button onclick="saveAppEdit()" class="btn-modal-action buy" style="flex: 1;">
                        Save App
                    </button>
                    <button onclick="deleteApp()" id="btnDeleteApp" class="btn-modal-action" style="flex: 0 0 auto; background: rgba(239, 68, 68, 0.1); color: #ef4444; display: none;">
                        Delete
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Contract config
        const SUITE_STAKING_ADDRESS = '0x539d3fE65339c0dA7aaa6D0a528b520d8B010F54';
        const USDC_WITHDRAWALS_ADDRESS = '0x543f3cE1cF4482F1b44d7B0D4f5e96615a4C6412';
        const USDC_ADDRESS = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913'; // Base USDC
        const BASE_CHAIN_ID = 8453;
        const BASE_RPC = 'https://mainnet.base.org';
        const CREDITS_PER_USDC = 1000;

        // Admin addresses (lowercase)
        const ADMIN_ADDRESSES = [
            '0x92d67d8ad8b986e78b369be0272e121ae5acad59'
        ];

        const STAKING_ABI = [
            'function availableCredits(address) view returns (uint256)',
            'function stakedBalance(address) view returns (uint256)',
            'function bonusCredits(address) view returns (uint256)',
            'function totalBonusCredits() view returns (uint256)',
            'function buyAndStake(uint256 usdcAmount) external',
            'function suitePerUsdc() view returns (uint256)'
        ];

        const WITHDRAWALS_ABI = [
            'function reportedLiquidValue() view returns (uint256)',
            'function totalPendingRequests() view returns (uint256)',
            'function fundedPool() view returns (uint256)',
            'function getRedemptionPercentage() view returns (uint256)',
            'function getMaxRedeemable(address) view returns (uint256)',
            'function pendingRequests(address) view returns (uint256)',
            'function reportLiquidValue(uint256 newValue) external',
            'function fundPool(uint256 amount) external',
            'function requestRedemption(uint256 usdcAmount) external',
            'function cancelRequest() external',
            'function claim() external'
        ];

        const ERC20_ABI = [
            'function approve(address spender, uint256 amount) returns (bool)',
            'function allowance(address owner, address spender) view returns (uint256)',
            'function balanceOf(address) view returns (uint256)'
        ];

        let provider, signer, stakingContract, usdcContract;
        let currentCredits = 0;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            checkConnection();
        });

        // Listen for wallet changes from nav
        window.addEventListener('navAuthChanged', () => {
            checkConnection();
        });

        async function checkConnection() {
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            const tgUser = JSON.parse(localStorage.getItem('telegram_user') || 'null');

            if (wallet) {
                document.getElementById('notConnectedState').style.display = 'none';
                document.getElementById('connectedState').style.display = 'block';
                await loadProfile(wallet, tgUser);
            } else if (tgUser) {
                // Telegram only - show limited profile
                document.getElementById('notConnectedState').style.display = 'none';
                document.getElementById('connectedState').style.display = 'block';
                loadTelegramOnlyProfile(tgUser);
            } else {
                document.getElementById('notConnectedState').style.display = 'block';
                document.getElementById('connectedState').style.display = 'none';
            }
        }

        async function loadProfile(wallet, tgUser) {
            // Wallet row - show Disconnect button, hide Connect
            document.getElementById('profileWalletAddress').textContent =
                wallet.slice(0, 6) + '...' + wallet.slice(-4);
            document.getElementById('btnConnectWallet').style.display = 'none';
            document.getElementById('btnDisconnectWallet').style.display = 'inline-block';

            // Telegram row - show appropriate button
            if (tgUser) {
                document.getElementById('profileTelegram').textContent = '@' + (tgUser.username || tgUser.first_name);
                document.getElementById('btnLinkTelegram').style.display = 'none';
                document.getElementById('btnUnlinkTelegram').style.display = 'inline-block';
            } else {
                document.getElementById('profileTelegram').textContent = 'Not linked';
                document.getElementById('btnLinkTelegram').style.display = 'inline-block';
                document.getElementById('btnUnlinkTelegram').style.display = 'none';
            }

            // Load credits from contract
            await loadCredits(wallet);

            // Enable buy button (wallet is connected)
            document.getElementById('btnBuy').disabled = false;
            document.getElementById('btnBuy').title = '';

            // Check if admin
            if (ADMIN_ADDRESSES.includes(wallet.toLowerCase())) {
                document.getElementById('adminSection').style.display = 'block';
                loadRedemptionData(); // Load redemption data when admin section is shown
                loadOperatorApplications(); // Load operator applications
            } else {
                document.getElementById('adminSection').style.display = 'none';
            }
        }

        function loadTelegramOnlyProfile(tgUser) {
            // Wallet row - show Connect button
            document.getElementById('profileWalletAddress').textContent = 'Not connected';
            document.getElementById('btnConnectWallet').style.display = 'inline-block';
            document.getElementById('btnDisconnectWallet').style.display = 'none';

            // Telegram row - show Unlink button
            document.getElementById('profileTelegram').textContent = '@' + (tgUser.username || tgUser.first_name);
            document.getElementById('btnLinkTelegram').style.display = 'none';
            document.getElementById('btnUnlinkTelegram').style.display = 'inline-block';

            // Credits - disabled without wallet
            document.getElementById('creditsBalance').textContent = '0';
            document.getElementById('bonusCreditsBalance').textContent = '0';
            document.getElementById('btnBuy').disabled = true;
            document.getElementById('btnBuy').title = 'Connect wallet to buy credits';
            document.getElementById('btnWithdraw').disabled = true;
            document.getElementById('adminSection').style.display = 'none';
        }

        async function loadCredits(wallet) {
            let onChainCredits = 0;
            let onChainBonus = 0;
            let dbCredits = 0;
            let dbBonus = 0;

            // Fetch from blockchain (crypto purchases)
            try {
                const readProvider = new ethers.JsonRpcProvider(BASE_RPC);
                const readStaking = new ethers.Contract(SUITE_STAKING_ADDRESS, STAKING_ABI, readProvider);

                const [creditsRaw, bonusRaw] = await Promise.all([
                    readStaking.availableCredits(wallet),
                    readStaking.bonusCredits(wallet)
                ]);

                onChainCredits = Number(creditsRaw) / 1e18;
                onChainBonus = Number(bonusRaw) / 1e18;
            } catch (err) {
                console.error('Failed to load on-chain credits:', err);
            }

            // Fetch from Supabase (fiat purchases)
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/users?wallet_address=eq.${wallet.toLowerCase()}&select=credits,bonus_credits`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const users = await response.json();
                if (users && users.length > 0) {
                    dbCredits = users[0].credits || 0;
                    dbBonus = users[0].bonus_credits || 0;
                }
            } catch (err) {
                console.error('Failed to load database credits:', err);
            }

            // Combine both sources
            currentCredits = onChainCredits + dbCredits;
            const totalBonus = onChainBonus + dbBonus;

            document.getElementById('creditsBalance').textContent = Math.floor(currentCredits).toLocaleString();
            document.getElementById('bonusCreditsBalance').textContent = Math.floor(totalBonus).toLocaleString();
            document.getElementById('btnWithdraw').disabled = totalBonus < 1000;
        }

        // Modal functions
        function openBuyModal() {
            // Reset to method selection
            showBuyMethodState();
            document.getElementById('buyAmount').value = '10';
            updateBuyPreview();
            document.getElementById('buyModal').classList.add('active');
        }

        function closeBuyModal() {
            document.getElementById('buyModal').classList.remove('active');
        }

        function showBuyMethodState() {
            document.getElementById('buyMethodState').style.display = 'block';
            document.getElementById('buyCryptoState').style.display = 'none';
            document.getElementById('buyFiatState').style.display = 'none';
        }

        function showBuyCryptoState() {
            document.getElementById('buyMethodState').style.display = 'none';
            document.getElementById('buyCryptoState').style.display = 'block';
            document.getElementById('buyFiatState').style.display = 'none';
        }

        function showBuyFiatState() {
            document.getElementById('buyMethodState').style.display = 'none';
            document.getElementById('buyCryptoState').style.display = 'none';
            document.getElementById('buyFiatState').style.display = 'block';
            updateFiatPreview();
        }

        // Fiat payment functions
        function setFiatAmount(amount) {
            document.getElementById('fiatAmount').value = amount;
            document.querySelectorAll('.fiat-amount-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.fiat-amount-btn[data-amount="${amount}"]`)?.classList.add('active');
            updateFiatPreview();
        }

        function updateFiatPreview() {
            const amount = parseFloat(document.getElementById('fiatAmount').value) || 0;
            const credits = amount * CREDITS_PER_USDC;
            document.getElementById('fiatPreviewCredits').textContent = credits.toLocaleString();
            document.getElementById('fiatPayText').textContent = `Pay $${amount} with Card`;
        }

        // Ensure user exists in Supabase before checkout (calls secure server-side API)
        async function ensureUserExists(walletAddress) {
            const response = await fetch('/api/ensure-user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ walletAddress })
            });

            const data = await response.json();

            if (!response.ok || data.error) {
                console.error('Failed to ensure user exists:', data.error);
                throw new Error('Failed to set up user account');
            }

            console.log('User ready:', data.created ? 'created new' : 'already exists');
        }

        async function initiateStripeCheckout() {
            const amount = parseFloat(document.getElementById('fiatAmount').value) || 0;
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');

            if (!wallet) {
                showToast('Please connect your wallet first', 'error');
                return;
            }

            if (amount < 1 || amount > 1000) {
                showToast('Amount must be between $1 and $1000', 'error');
                return;
            }

            const btn = document.getElementById('btnFiatPay');
            const originalText = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<span>Setting up...</span>';

            try {
                // Ensure user exists in database before checkout
                await ensureUserExists(wallet);

                btn.innerHTML = '<span>Redirecting to Stripe...</span>';

                const response = await fetch('/api/create-checkout', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount, walletAddress: wallet })
                });

                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error);
                }

                // Redirect to Stripe Checkout
                window.location.href = data.url;

            } catch (error) {
                console.error('Stripe checkout error:', error);
                showToast('Failed to start checkout: ' + error.message, 'error');
                btn.disabled = false;
                btn.innerHTML = originalText;
            }
        }

        // Refresh credits display
        async function refreshCreditsDisplay() {
            const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
            if (wallet) {
                await loadCredits(wallet);
            }
        }

        // Check for payment success on page load
        function checkPaymentStatus() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('payment') === 'success') {
                showToast('Payment successful! Credits added to your account.', 'success');
                // Clean up URL
                window.history.replaceState({}, '', '/profile.html');
                // Refresh balance after a short delay
                setTimeout(() => refreshCreditsDisplay(), 1000);
            } else if (params.get('payment') === 'cancelled') {
                showToast('Payment was cancelled', 'info');
                window.history.replaceState({}, '', '/profile.html');
            }
        }

        // Call on page load
        document.addEventListener('DOMContentLoaded', checkPaymentStatus);

        function updateBuyPreview() {
            const amount = parseFloat(document.getElementById('buyAmount').value) || 0;
            const credits = amount * CREDITS_PER_USDC;
            document.getElementById('buyPreviewCredits').textContent = credits.toLocaleString();
        }

        let userWithdrawData = {
            bonusCredits: 0,
            maxRedeemable: 0,
            pendingRequest: 0,
            redemptionRate: 0,
            fundedPool: 0
        };

        async function openWithdrawModal() {
            document.getElementById('withdrawModal').classList.add('active');

            // Hide all states first
            document.getElementById('withdrawRequestState').style.display = 'none';
            document.getElementById('withdrawPendingState').style.display = 'none';
            document.getElementById('withdrawClaimState').style.display = 'none';
            document.getElementById('withdrawNoCreditsState').style.display = 'none';

            // Check if contract deployed
            if (USDC_WITHDRAWALS_ADDRESS === '0x0000000000000000000000000000000000000000') {
                document.getElementById('withdrawNoCreditsState').style.display = 'block';
                document.getElementById('withdrawNoCreditsState').innerHTML = `
                    <h3>Coming Soon</h3>
                    <div style="text-align: center; padding: 30px 0;">
                        <div style="font-size: 3rem; margin-bottom: 16px;">&#128679;</div>
                        <div style="color: var(--text-medium);">
                            USDC withdrawals are coming soon.<br><br>
                            Check back later!
                        </div>
                    </div>
                    <button class="btn-modal-action" style="background: var(--text-light); color: var(--text-dark);" onclick="closeWithdrawModal()">
                        Got it
                    </button>
                `;
                return;
            }

            try {
                const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                const readProvider = new ethers.JsonRpcProvider(BASE_RPC);
                const staking = new ethers.Contract(SUITE_STAKING_ADDRESS, STAKING_ABI, readProvider);
                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, readProvider);

                const [bonusCredits, maxRedeemable, pendingRequest, redemptionPct, fundedPool] = await Promise.all([
                    staking.bonusCredits(wallet),
                    withdrawals.getMaxRedeemable(wallet),
                    withdrawals.pendingRequests(wallet),
                    withdrawals.getRedemptionPercentage().catch(() => 0n),
                    withdrawals.fundedPool()
                ]);

                userWithdrawData = {
                    bonusCredits: Number(bonusCredits) / 1e18,
                    maxRedeemable: Number(maxRedeemable) / 1e6,
                    pendingRequest: Number(pendingRequest) / 1e6,
                    redemptionRate: Number(redemptionPct) / 1e16,
                    fundedPool: Number(fundedPool) / 1e6
                };

                // Determine which state to show
                if (userWithdrawData.pendingRequest > 0) {
                    // Has pending request
                    if (userWithdrawData.fundedPool >= userWithdrawData.pendingRequest) {
                        // Can claim!
                        document.getElementById('claimAmount').textContent = '$' + userWithdrawData.pendingRequest.toFixed(2);
                        document.getElementById('withdrawClaimState').style.display = 'block';
                    } else {
                        // Waiting for funding
                        document.getElementById('pendingAmount').textContent = '$' + userWithdrawData.pendingRequest.toFixed(2);
                        document.getElementById('withdrawPendingState').style.display = 'block';
                    }
                } else if (userWithdrawData.bonusCredits > 0 && userWithdrawData.maxRedeemable > 0) {
                    // Can request
                    document.getElementById('withdrawRate').textContent = userWithdrawData.redemptionRate.toFixed(0) + '%';
                    document.getElementById('withdrawBonusCredits').textContent = Math.floor(userWithdrawData.bonusCredits).toLocaleString();
                    document.getElementById('withdrawMaxUsdc').textContent = '$' + userWithdrawData.maxRedeemable.toFixed(2);
                    document.getElementById('withdrawAmount').value = '';
                    document.getElementById('withdrawAmount').max = userWithdrawData.maxRedeemable;
                    document.getElementById('withdrawPreviewCredits').textContent = '0';
                    document.getElementById('withdrawRequestState').style.display = 'block';
                } else {
                    // No bonus credits
                    document.getElementById('withdrawNoCreditsState').style.display = 'block';
                }

            } catch (err) {
                console.error('Failed to load withdrawal data:', err);
                showToast('Failed to load data', 'error');
            }
        }

        function closeWithdrawModal() {
            document.getElementById('withdrawModal').classList.remove('active');
        }

        function updateWithdrawPreview() {
            const usdc = parseFloat(document.getElementById('withdrawAmount').value) || 0;
            // Calculate credits that will be used
            if (userWithdrawData.maxRedeemable > 0) {
                const creditsRatio = userWithdrawData.bonusCredits / userWithdrawData.maxRedeemable;
                const credits = Math.floor(usdc * creditsRatio);
                document.getElementById('withdrawPreviewCredits').textContent = credits.toLocaleString();
            }
        }

        async function requestWithdrawal() {
            const btn = document.getElementById('btnWithdrawRequest');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Connecting...';

                const usdcAmount = parseFloat(document.getElementById('withdrawAmount').value);
                if (!usdcAmount || usdcAmount <= 0) throw new Error('Enter a valid amount');
                if (usdcAmount > userWithdrawData.maxRedeemable) throw new Error('Amount exceeds max redeemable');

                await ensureBaseNetwork();
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const amountWei = ethers.parseUnits(usdcAmount.toFixed(6), 6);
                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, signer);

                btn.textContent = 'Requesting...';
                const tx = await withdrawals.requestRedemption(amountWei);
                await tx.wait();

                showToast('Withdrawal requested!', 'success');
                closeWithdrawModal();

                // Reload credits
                const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                await loadCredits(wallet);

            } catch (err) {
                console.error('Request failed:', err);
                showToast(err.reason || err.message || 'Request failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function cancelWithdrawal() {
            try {
                await ensureBaseNetwork();
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, signer);

                showToast('Canceling...', 'info');
                const tx = await withdrawals.cancelRequest();
                await tx.wait();

                showToast('Request canceled', 'success');
                closeWithdrawModal();

                const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                await loadCredits(wallet);

            } catch (err) {
                console.error('Cancel failed:', err);
                showToast(err.reason || err.message || 'Cancel failed', 'error');
            }
        }

        async function claimWithdrawal() {
            const btn = document.getElementById('btnClaim');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Claiming...';

                await ensureBaseNetwork();
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, signer);
                const tx = await withdrawals.claim();
                await tx.wait();

                showToast('USDC claimed!', 'success');
                closeWithdrawModal();

                const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                await loadCredits(wallet);

            } catch (err) {
                console.error('Claim failed:', err);
                showToast(err.reason || err.message || 'Claim failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // Execute transactions
        async function executeBuy() {
            const btn = document.getElementById('btnBuyConfirm');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = 'Connecting...';

                // Check network and switch if needed
                await ensureBaseNetwork();

                // Get signer
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const usdcAmount = parseFloat(document.getElementById('buyAmount').value);
                if (!usdcAmount || usdcAmount <= 0) {
                    throw new Error('Please enter a valid amount');
                }

                // USDC has 6 decimals
                const usdcAmountWei = ethers.parseUnits(usdcAmount.toString(), 6);

                // Check USDC balance
                usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                const balance = await usdcContract.balanceOf(await signer.getAddress());
                if (balance < usdcAmountWei) {
                    throw new Error('Insufficient USDC balance');
                }

                // Check and approve USDC
                btn.textContent = 'Checking approval...';
                const allowance = await usdcContract.allowance(await signer.getAddress(), SUITE_STAKING_ADDRESS);
                if (allowance < usdcAmountWei) {
                    btn.textContent = 'Approving USDC...';
                    const approveTx = await usdcContract.approve(SUITE_STAKING_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                // Buy and stake
                btn.textContent = 'Buying credits...';
                stakingContract = new ethers.Contract(SUITE_STAKING_ADDRESS, STAKING_ABI, signer);
                const tx = await stakingContract.buyAndStake(usdcAmountWei);
                await tx.wait();

                // Success
                closeBuyModal();
                showToast('Credits purchased successfully!', 'success');

                // Reload credits
                const wallet = localStorage.getItem('connectedWallet') || localStorage.getItem('suiteWalletAddress');
                await loadCredits(wallet);
                if (window.refreshNavCredits) window.refreshNavCredits();

            } catch (err) {
                console.error('Buy failed:', err);
                showToast(err.message || 'Transaction failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function ensureBaseNetwork() {
            if (!window.ethereum) {
                throw new Error('Please install MetaMask');
            }

            const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
            const chainId = parseInt(chainIdHex, 16);

            if (chainId !== BASE_CHAIN_ID) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: '0x' + BASE_CHAIN_ID.toString(16) }]
                    });
                } catch (switchError) {
                    if (switchError.code === 4902) {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: '0x' + BASE_CHAIN_ID.toString(16),
                                chainName: 'Base',
                                nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
                                rpcUrls: ['https://mainnet.base.org'],
                                blockExplorerUrls: ['https://basescan.org']
                            }]
                        });
                    } else {
                        throw new Error('Please switch to Base network');
                    }
                }
            }
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' show';
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ============ Redemption Admin Functions ============

        let adminData = {};

        async function loadRedemptionData() {
            // Check if contract is deployed
            if (USDC_WITHDRAWALS_ADDRESS === '0x0000000000000000000000000000000000000000') {
                document.getElementById('contractNotDeployed').style.display = 'block';
                document.getElementById('adminRedemptionRate').textContent = '--%';
                document.getElementById('adminTotalCredits').textContent = '--';
                document.getElementById('adminReportedValue').textContent = '$--';
                document.getElementById('adminPendingRequests').textContent = '$--';
                document.getElementById('adminFundedPool').textContent = '$--';
                return;
            }

            document.getElementById('contractNotDeployed').style.display = 'none';

            try {
                const readProvider = new ethers.JsonRpcProvider(BASE_RPC);
                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, readProvider);
                const staking = new ethers.Contract(SUITE_STAKING_ADDRESS, STAKING_ABI, readProvider);

                const [reportedValue, totalPending, fundedPool, redemptionPct, totalBonusCredits] = await Promise.all([
                    withdrawals.reportedLiquidValue(),
                    withdrawals.totalPendingRequests(),
                    withdrawals.fundedPool(),
                    withdrawals.getRedemptionPercentage().catch(() => 0n),
                    staking.totalBonusCredits()
                ]);

                adminData = {
                    reportedValue: Number(reportedValue) / 1e6,
                    totalPending: Number(totalPending) / 1e6,
                    fundedPool: Number(fundedPool) / 1e6,
                    redemptionPct: Number(redemptionPct) / 1e16,
                    totalBonusCredits: Number(totalBonusCredits) / 1e18
                };

                document.getElementById('adminRedemptionRate').textContent = adminData.redemptionPct.toFixed(0) + '%';
                document.getElementById('adminTotalCredits').textContent = formatAdminNumber(adminData.totalBonusCredits);
                document.getElementById('adminReportedValue').textContent = '$' + formatAdminNumber(adminData.reportedValue);
                document.getElementById('adminPendingRequests').textContent = '$' + formatAdminNumber(adminData.totalPending);
                document.getElementById('adminFundedPool').textContent = '$' + formatAdminNumber(adminData.fundedPool);

            } catch (err) {
                console.error('Failed to load redemption data:', err);
            }
        }

        function formatAdminNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num.toLocaleString(undefined, { maximumFractionDigits: 2 });
        }

        function previewAdminRate() {
            const newValue = parseFloat(document.getElementById('adminLiquidValueInput').value) || 0;
            const faceValue = adminData.totalBonusCredits / 1000;

            if (faceValue > 0) {
                const newRate = (newValue / faceValue * 100).toFixed(1);
                document.getElementById('adminRatePreview').textContent = `New rate: ${newRate}%`;
            }
        }

        async function adminReportValue() {
            const btn = document.getElementById('btnAdminReport');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = '...';

                await ensureBaseNetwork();
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const newValue = parseFloat(document.getElementById('adminLiquidValueInput').value);
                if (!newValue || newValue < 0) throw new Error('Enter a valid value');

                const valueWei = ethers.parseUnits(newValue.toString(), 6);
                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, signer);

                btn.textContent = 'Updating...';
                const tx = await withdrawals.reportLiquidValue(valueWei);
                await tx.wait();

                showToast('Value updated!', 'success');
                document.getElementById('adminLiquidValueInput').value = '';
                await loadRedemptionData();

            } catch (err) {
                console.error('Failed:', err);
                showToast(err.message || 'Failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function adminFundPool() {
            const btn = document.getElementById('btnAdminFund');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.textContent = '...';

                await ensureBaseNetwork();
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                const amount = parseFloat(document.getElementById('adminFundInput').value);
                if (!amount || amount <= 0) throw new Error('Enter a valid amount');

                const amountWei = ethers.parseUnits(amount.toString(), 6);

                // Check and approve USDC
                const usdcContract = new ethers.Contract(USDC_ADDRESS, ERC20_ABI, signer);
                const allowance = await usdcContract.allowance(await signer.getAddress(), USDC_WITHDRAWALS_ADDRESS);

                if (allowance < amountWei) {
                    btn.textContent = 'Approving...';
                    const approveTx = await usdcContract.approve(USDC_WITHDRAWALS_ADDRESS, ethers.MaxUint256);
                    await approveTx.wait();
                }

                btn.textContent = 'Funding...';
                const withdrawals = new ethers.Contract(USDC_WITHDRAWALS_ADDRESS, WITHDRAWALS_ABI, signer);
                const tx = await withdrawals.fundPool(amountWei);
                await tx.wait();

                showToast('Pool funded!', 'success');
                document.getElementById('adminFundInput').value = '';
                await loadRedemptionData();

            } catch (err) {
                console.error('Failed:', err);
                showToast(err.message || 'Failed', 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        function autoFillAdminPending() {
            document.getElementById('adminFundInput').value = adminData.totalPending.toFixed(2);
        }

        // ============ Apps Admin Functions ============

        const SUPABASE_URL = 'https://rdsmdywbdiskxknluiym.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJkc21keXdiZGlza3hrbmx1aXltIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njc3ODk3MTgsImV4cCI6MjA4MzM2NTcxOH0.DcLpWs8Lf1s4Flf54J5LubokSYrd7h-XvI_X0jj6bLM';

        let appsData = [];

        async function loadAppsAdmin() {
            const list = document.getElementById('appsAdminList');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?order=name.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load apps');

                appsData = await response.json();

                if (appsData.length === 0) {
                    list.innerHTML = '<div style="text-align: center; padding: 20px; color: var(--text-light);">No apps yet. Click "Add App" to create one.</div>';
                    return;
                }

                list.innerHTML = appsData.map(app => `
                    <div onclick="openEditAppModal('${app.id}')" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: rgba(255,255,255,0.5); border-radius: 12px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.5)'">
                        <img src="${app.icon_url || '/assets/suite-logo-new.png'}" style="width: 40px; height: 40px; border-radius: 10px; object-fit: cover;" onerror="this.src='/assets/suite-logo-new.png'">
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 700; font-size: 0.95rem; color: var(--text-dark);">${app.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-light); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${app.tagline || 'No tagline'}</div>
                        </div>
                        <div style="display: flex; flex-direction: column; align-items: flex-end; gap: 4px;">
                            <span style="padding: 2px 8px; border-radius: 6px; font-size: 0.7rem; font-weight: 600; background: ${getStatusColor(app.status)}; color: white;">${app.status || 'live'}</span>
                            <span style="font-size: 0.7rem; color: var(--text-light);">${app.category || 'other'}</span>
                        </div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Failed to load apps:', err);
                list.innerHTML = '<div style="text-align: center; padding: 20px; color: #ef4444;">Failed to load apps</div>';
            }
        }

        function getStatusColor(status) {
            switch (status) {
                case 'approved': return 'var(--accent-green)';
                case 'live': return 'var(--accent-green)';
                case 'pending': return 'var(--accent-orange)';
                case 'coming_soon': return 'var(--accent-orange)';
                case 'beta': return '#3b82f6';
                case 'hidden': return '#6b7280';
                default: return 'var(--accent-green)';
            }
        }

        function openAddAppModal() {
            document.getElementById('appEditModalTitle').textContent = 'Add New App';
            document.getElementById('appEditId').value = '';
            document.getElementById('appEditName').value = '';
            document.getElementById('appEditSlug').value = '';
            document.getElementById('appEditTagline').value = '';
            document.getElementById('appEditDescription').value = '';
            document.getElementById('appEditCategory').value = 'productivity';
            document.getElementById('appEditStatus').value = 'pending';
            document.getElementById('appEditPlatform').value = 'both';
            document.getElementById('appEditIcon').value = '';
            document.getElementById('appEditIconUrl').value = '';
            document.getElementById('appEditUrl').value = '';
            document.getElementById('appEditIconPreview').style.display = 'none';
            document.getElementById('iconDropText').style.display = 'block';
            document.getElementById('btnDeleteApp').style.display = 'none';

            // Clear screenshots
            for (let i = 1; i <= 5; i++) {
                document.getElementById(`appEditScreenshot${i}`).value = '';
            }
            resetScreenshotZones();

            document.getElementById('appEditModal').classList.add('active');
        }

        function resetScreenshotZones() {
            const zones = document.querySelectorAll('.screenshot-drop-zone');
            zones.forEach(zone => {
                zone.innerHTML = `+<input type="file" accept="image/*" style="display: none;">`;
            });
        }

        function openEditAppModal(appId) {
            const app = appsData.find(a => a.id === appId);
            if (!app) return;

            document.getElementById('appEditModalTitle').textContent = 'Edit App';
            document.getElementById('appEditId').value = app.id;
            document.getElementById('appEditName').value = app.name || '';
            document.getElementById('appEditSlug').value = app.slug || '';
            document.getElementById('appEditTagline').value = app.tagline || '';
            document.getElementById('appEditDescription').value = app.description || '';
            document.getElementById('appEditCategory').value = app.category || 'productivity';
            document.getElementById('appEditStatus').value = app.status || 'approved';
            document.getElementById('appEditPlatform').value = app.type || 'both';
            document.getElementById('appEditIcon').value = app.icon_url || '';
            document.getElementById('appEditIconUrl').value = app.icon_url || '';
            document.getElementById('appEditUrl').value = app.app_url || '';

            // Show icon preview
            if (app.icon_url) {
                document.getElementById('appEditIconPreview').src = app.icon_url;
                document.getElementById('appEditIconPreview').style.display = 'block';
                document.getElementById('iconDropText').style.display = 'none';
            } else {
                document.getElementById('appEditIconPreview').style.display = 'none';
                document.getElementById('iconDropText').style.display = 'block';
            }

            // Load screenshots
            resetScreenshotZones();
            const zones = document.querySelectorAll('.screenshot-drop-zone');
            for (let i = 1; i <= 5; i++) {
                const screenshotUrl = app[`screenshot_${i}`];
                document.getElementById(`appEditScreenshot${i}`).value = screenshotUrl || '';
                if (screenshotUrl && zones[i-1]) {
                    zones[i-1].innerHTML = `<img src="${screenshotUrl}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"><input type="file" accept="image/*" style="display: none;">`;
                }
            }

            document.getElementById('btnDeleteApp').style.display = 'inline-block';
            document.getElementById('appEditModal').classList.add('active');
        }

        function closeAppEditModal() {
            document.getElementById('appEditModal').classList.remove('active');
        }

        // ============ Icon/Screenshot Upload Functions ============

        async function uploadToSupabase(file, type = 'icon') {
            const bucket = 'app-assets';
            const fileExt = file.name.split('.').pop();
            const fileName = `${Date.now()}-${Math.random().toString(36).substring(2, 9)}.${fileExt}`;
            const filePath = `uploads/${fileName}`;

            const response = await fetch(`${SUPABASE_URL}/storage/v1/object/${bucket}/${filePath}`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': file.type,
                    'x-upsert': 'true'
                },
                body: file
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Upload failed: ${errorText}`);
            }

            return `${SUPABASE_URL}/storage/v1/object/public/${bucket}/${filePath}`;
        }

        // Icon upload handlers
        document.addEventListener('DOMContentLoaded', () => {
            const dropZone = document.getElementById('iconDropZone');
            const fileInput = document.getElementById('iconFileInput');
            const urlInput = document.getElementById('appEditIconUrl');
            const hiddenInput = document.getElementById('appEditIcon');
            const preview = document.getElementById('appEditIconPreview');
            const dropText = document.getElementById('iconDropText');
            const progressDiv = document.getElementById('iconUploadProgress');
            const progressBar = document.getElementById('iconProgressBar');

            if (!dropZone) return;

            // Click to upload
            dropZone.addEventListener('click', () => fileInput.click());

            // Drag events
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'var(--accent-green)';
                dropZone.style.background = 'rgba(34, 197, 94, 0.1)';
            });

            dropZone.addEventListener('dragleave', () => {
                dropZone.style.borderColor = 'rgba(0,0,0,0.2)';
                dropZone.style.background = 'rgba(255,255,255,0.5)';
            });

            dropZone.addEventListener('drop', async (e) => {
                e.preventDefault();
                dropZone.style.borderColor = 'rgba(0,0,0,0.2)';
                dropZone.style.background = 'rgba(255,255,255,0.5)';

                const file = e.dataTransfer.files[0];
                if (file && file.type.startsWith('image/')) {
                    await handleIconUpload(file);
                }
            });

            // File input change
            fileInput.addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) await handleIconUpload(file);
            });

            // URL input
            if (urlInput) {
                urlInput.addEventListener('input', () => {
                    const url = urlInput.value.trim();
                    if (url) {
                        hiddenInput.value = url;
                        preview.src = url;
                        preview.style.display = 'block';
                        dropText.style.display = 'none';
                    }
                });
            }

            async function handleIconUpload(file) {
                try {
                    dropText.style.display = 'none';
                    progressDiv.style.display = 'block';
                    progressBar.style.width = '30%';

                    const url = await uploadToSupabase(file, 'icon');

                    progressBar.style.width = '100%';

                    hiddenInput.value = url;
                    if (urlInput) urlInput.value = url;
                    preview.src = url;
                    preview.style.display = 'block';

                    setTimeout(() => {
                        progressDiv.style.display = 'none';
                        progressBar.style.width = '0%';
                    }, 500);

                    showToast('Icon uploaded!', 'success');
                } catch (err) {
                    console.error('Icon upload failed:', err);
                    progressDiv.style.display = 'none';
                    dropText.style.display = 'block';
                    showToast('Upload failed: ' + err.message, 'error');
                }
            }

            // Screenshot uploads
            document.querySelectorAll('.screenshot-drop-zone').forEach((zone, index) => {
                const input = zone.querySelector('input[type="file"]');
                const preview = zone.querySelector('.screenshot-preview');
                const hiddenInput = document.getElementById(`appEditScreenshot${index + 1}`);

                zone.addEventListener('click', () => input.click());

                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.style.borderColor = 'var(--accent-green)';
                });

                zone.addEventListener('dragleave', () => {
                    zone.style.borderColor = 'rgba(0,0,0,0.2)';
                });

                zone.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    zone.style.borderColor = 'rgba(0,0,0,0.2)';
                    const file = e.dataTransfer.files[0];
                    if (file && file.type.startsWith('image/')) {
                        await handleScreenshotUpload(file, index + 1, zone, preview, hiddenInput);
                    }
                });

                input.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) await handleScreenshotUpload(file, index + 1, zone, preview, hiddenInput);
                });
            });

            async function handleScreenshotUpload(file, num, zone, preview, hiddenInput) {
                try {
                    zone.innerHTML = '<span style="color: var(--text-light);">Uploading...</span>';
                    const url = await uploadToSupabase(file, 'screenshot');

                    hiddenInput.value = url;
                    zone.innerHTML = `<img src="${url}" style="width: 100%; height: 100%; object-fit: cover; border-radius: 8px;"><input type="file" accept="image/*" style="display: none;">`;

                    // Re-attach event listeners
                    const newInput = zone.querySelector('input[type="file"]');
                    zone.addEventListener('click', () => newInput.click());
                    newInput.addEventListener('change', async (e) => {
                        const file = e.target.files[0];
                        if (file) await handleScreenshotUpload(file, num, zone, preview, hiddenInput);
                    });

                    showToast(`Screenshot ${num} uploaded!`, 'success');
                } catch (err) {
                    console.error('Screenshot upload failed:', err);
                    zone.innerHTML = `<span style="color: #ef4444;">Failed</span><input type="file" accept="image/*" style="display: none;">`;
                    showToast('Upload failed', 'error');
                }
            }
        });

        async function saveAppEdit() {
            const id = document.getElementById('appEditId').value;
            const appData = {
                name: document.getElementById('appEditName').value.trim(),
                slug: document.getElementById('appEditSlug').value.trim().toLowerCase().replace(/[^a-z0-9-]/g, ''),
                tagline: document.getElementById('appEditTagline').value.trim(),
                description: document.getElementById('appEditDescription').value.trim(),
                category: document.getElementById('appEditCategory').value,
                status: document.getElementById('appEditStatus').value,
                type: document.getElementById('appEditPlatform').value,
                icon_url: document.getElementById('appEditIcon').value.trim(),
                app_url: document.getElementById('appEditUrl').value.trim() || null,
                screenshot_1: document.getElementById('appEditScreenshot1').value.trim() || null,
                screenshot_2: document.getElementById('appEditScreenshot2').value.trim() || null,
                screenshot_3: document.getElementById('appEditScreenshot3').value.trim() || null,
                screenshot_4: document.getElementById('appEditScreenshot4').value.trim() || null,
                screenshot_5: document.getElementById('appEditScreenshot5').value.trim() || null
            };

            if (!appData.name || !appData.slug) {
                showToast('Name and slug are required', 'error');
                return;
            }

            try {
                let response;
                if (id) {
                    // Update existing app
                    response = await fetch(`${SUPABASE_URL}/rest/v1/apps?id=eq.${id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(appData)
                    });
                } else {
                    // Create new app - add required creator_name
                    appData.creator_name = 'SUITE';
                    appData.creator_username = 'Stu';
                    response = await fetch(`${SUPABASE_URL}/rest/v1/apps`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(appData)
                    });
                }

                if (!response.ok) {
                    const err = await response.text();
                    throw new Error(err);
                }

                showToast(id ? 'App updated!' : 'App created!', 'success');
                closeAppEditModal();
                await loadAppsAdmin();

            } catch (err) {
                console.error('Failed to save app:', err);
                showToast('Failed to save: ' + err.message, 'error');
            }
        }

        async function deleteApp() {
            const id = document.getElementById('appEditId').value;
            if (!id) return;

            const app = appsData.find(a => a.id === id);
            if (!confirm(`Delete "${app?.name}"? This cannot be undone.`)) return;

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/apps?id=eq.${id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Delete failed');

                showToast('App deleted', 'success');
                closeAppEditModal();
                await loadAppsAdmin();

            } catch (err) {
                console.error('Failed to delete app:', err);
                showToast('Failed to delete', 'error');
            }
        }

        // ============ Operator Applications Management ============
        let operatorApplicationsData = [];
        let currentApplicationFilter = 'pending';

        async function loadOperatorApplications() {
            const list = document.getElementById('operatorApplicationsList');
            const filter = document.getElementById('appFilterSelect').value;
            currentApplicationFilter = filter;

            try {
                let url = `${SUPABASE_URL}/rest/v1/app_operator_applications?order=created_at.desc`;
                if (filter !== 'all') {
                    url += `&status=eq.${filter}`;
                }

                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });

                if (!response.ok) throw new Error('Failed to load applications');

                operatorApplicationsData = await response.json();

                // Update counts
                updateApplicationCounts();

                if (operatorApplicationsData.length === 0) {
                    list.innerHTML = `<div style="text-align: center; padding: 24px; color: var(--text-light);">No ${filter === 'all' ? '' : filter} applications</div>`;
                    return;
                }

                list.innerHTML = operatorApplicationsData.map(app => `
                    <div onclick="openApplicationDetail('${app.id}')" style="background: rgba(255,255,255,0.5); border: 1px solid rgba(0,0,0,0.08); border-radius: 14px; padding: 16px; cursor: pointer; transition: all 0.2s ease;" onmouseover="this.style.background='rgba(255,255,255,0.8)'" onmouseout="this.style.background='rgba(255,255,255,0.5)'">
                        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 10px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 0.9rem;">${(app.discord_username || app.email || '?').charAt(0).toUpperCase()}</div>
                                <div>
                                    <div style="font-weight: 700; font-size: 0.95rem; color: var(--text-dark);">${app.discord_username || app.email || 'Unknown'}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-light);">${app.email || 'No email'}</div>
                                </div>
                            </div>
                            <span style="padding: 4px 10px; border-radius: 8px; font-size: 0.7rem; font-weight: 600; ${getApplicationStatusStyle(app.status)}">${app.status}</span>
                        </div>
                        <div style="display: flex; gap: 16px; font-size: 0.8rem; color: var(--text-medium);">
                            <span><strong>App:</strong> ${app.preferred_app_slug || 'Any'}</span>
                            <span><strong>Hours:</strong> ${app.hours_per_week || 10}/wk</span>
                        </div>
                        <div style="margin-top: 10px; font-size: 0.85rem; color: var(--text-medium); line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;">${(app.motivation || '').substring(0, 150)}${(app.motivation || '').length > 150 ? '...' : ''}</div>
                        <div style="margin-top: 10px; font-size: 0.75rem; color: var(--text-light);">${new Date(app.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                    </div>
                `).join('');

            } catch (err) {
                console.error('Failed to load applications:', err);
                list.innerHTML = '<div style="text-align: center; padding: 24px; color: #ef4444;">Failed to load applications. Table may not exist yet - run the migration.</div>';
            }
        }

        async function updateApplicationCounts() {
            try {
                const counts = { pending: 0, under_review: 0, accepted: 0, rejected: 0 };

                for (const status of Object.keys(counts)) {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/app_operator_applications?status=eq.${status}&select=count`, {
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Prefer': 'count=exact'
                        }
                    });
                    const count = response.headers.get('content-range');
                    if (count) {
                        const match = count.match(/\/(\d+)/);
                        counts[status] = match ? parseInt(match[1]) : 0;
                    }
                }

                document.getElementById('pendingCount').textContent = counts.pending;
                document.getElementById('reviewCount').textContent = counts.under_review;
                document.getElementById('acceptedCount').textContent = counts.accepted;
                document.getElementById('rejectedCount').textContent = counts.rejected;

            } catch (err) {
                console.error('Failed to update counts:', err);
            }
        }

        function getApplicationStatusStyle(status) {
            switch (status) {
                case 'pending': return 'background: rgba(251, 191, 36, 0.15); color: #f59e0b;';
                case 'under_review': return 'background: rgba(59, 130, 246, 0.15); color: #3b82f6;';
                case 'accepted': return 'background: rgba(34, 197, 94, 0.15); color: #22c55e;';
                case 'rejected': return 'background: rgba(239, 68, 68, 0.15); color: #ef4444;';
                default: return 'background: rgba(0, 0, 0, 0.1); color: var(--text-medium);';
            }
        }

        function filterApplications() {
            loadOperatorApplications();
        }

        function refreshApplications() {
            loadOperatorApplications();
        }

        function openApplicationDetail(appId) {
            const app = operatorApplicationsData.find(a => a.id === appId);
            if (!app) return;

            const modal = document.createElement('div');
            modal.id = 'applicationDetailModal';
            modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 9999; padding: 20px;';
            modal.onclick = (e) => { if (e.target === modal) modal.remove(); };

            modal.innerHTML = `
                <div style="background: white; border-radius: 20px; max-width: 500px; width: 100%; max-height: 90vh; overflow-y: auto; padding: 28px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; font-size: 1.2rem;">Application Details</h3>
                        <button onclick="document.getElementById('applicationDetailModal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: var(--text-light);">&times;</button>
                    </div>

                    <div style="display: flex; align-items: center; gap: 14px; padding: 16px; background: rgba(0,0,0,0.03); border-radius: 14px; margin-bottom: 20px;">
                        <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f97316, #ea580c); border-radius: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: 1.2rem;">${(app.discord_username || app.email || '?').charAt(0).toUpperCase()}</div>
                        <div>
                            <div style="font-weight: 700; font-size: 1.1rem;">${app.discord_username || 'No Discord'}</div>
                            <div style="font-size: 0.85rem; color: var(--text-medium);">${app.email || 'No email'}</div>
                        </div>
                    </div>

                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 20px;">
                        <div style="padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px;">Status</div>
                            <span style="padding: 4px 10px; border-radius: 8px; font-size: 0.8rem; font-weight: 600; ${getApplicationStatusStyle(app.status)}">${app.status}</span>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px;">Preferred App</div>
                            <div style="font-weight: 600;">${app.preferred_app_slug || 'Any'}</div>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px;">Hours/Week</div>
                            <div style="font-weight: 600;">${app.hours_per_week || 10} hours</div>
                        </div>
                        <div style="padding: 12px; background: rgba(0,0,0,0.03); border-radius: 10px;">
                            <div style="font-size: 0.75rem; color: var(--text-light); margin-bottom: 4px;">Referral</div>
                            <div style="font-weight: 600;">${app.referral_source || 'Unknown'}</div>
                        </div>
                    </div>

                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Motivation</div>
                        <div style="padding: 14px; background: rgba(0,0,0,0.03); border-radius: 10px; font-size: 0.9rem; line-height: 1.6; color: var(--text-medium);">${app.motivation || 'No motivation provided'}</div>
                    </div>

                    ${app.experience ? `
                    <div style="margin-bottom: 16px;">
                        <div style="font-size: 0.85rem; font-weight: 600; color: var(--text-dark); margin-bottom: 8px;">Experience</div>
                        <div style="padding: 14px; background: rgba(0,0,0,0.03); border-radius: 10px; font-size: 0.9rem; line-height: 1.6; color: var(--text-medium);">${app.experience}</div>
                    </div>
                    ` : ''}

                    <div style="font-size: 0.8rem; color: var(--text-light); margin-bottom: 20px;">
                        Applied: ${new Date(app.created_at).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}
                    </div>

                    ${app.status === 'pending' || app.status === 'under_review' ? `
                    <div style="display: flex; gap: 10px;">
                        <button onclick="updateApplicationStatus('${app.id}', 'accepted')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #22c55e, #16a34a); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">Accept</button>
                        <button onclick="updateApplicationStatus('${app.id}', 'under_review')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">Review</button>
                        <button onclick="updateApplicationStatus('${app.id}', 'rejected')" style="flex: 1; padding: 14px; background: linear-gradient(135deg, #ef4444, #dc2626); color: white; border: none; border-radius: 12px; font-weight: 700; cursor: pointer;">Reject</button>
                    </div>
                    ` : ''}
                </div>
            `;

            document.body.appendChild(modal);
        }

        async function updateApplicationStatus(appId, newStatus) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/app_operator_applications?id=eq.${appId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        status: newStatus,
                        reviewed_at: new Date().toISOString()
                    })
                });

                if (!response.ok) throw new Error('Update failed');

                // If accepted, create operator record
                if (newStatus === 'accepted') {
                    const app = operatorApplicationsData.find(a => a.id === appId);
                    if (app && app.preferred_app_slug) {
                        await createOperatorFromApplication(app);
                    }
                }

                showToast(`Application ${newStatus}`, 'success');
                document.getElementById('applicationDetailModal')?.remove();
                loadOperatorApplications();

            } catch (err) {
                console.error('Failed to update status:', err);
                showToast('Failed to update', 'error');
            }
        }

        async function createOperatorFromApplication(app) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/app_operators`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify({
                        app_slug: app.preferred_app_slug,
                        user_discord_id: app.discord_id,
                        user_telegram_id: app.telegram_id,
                        user_wallet_address: app.wallet_address,
                        operator_name: app.discord_username || app.email,
                        ownership_percent: 90,
                        marketing_budget_monthly: 10000,
                        status: 'active',
                        application_id: app.id
                    })
                });

                if (!response.ok) {
                    const err = await response.json();
                    console.error('Failed to create operator:', err);
                    showToast('Application accepted but failed to create operator record', 'warning');
                } else {
                    showToast('Operator created successfully!', 'success');
                }
            } catch (err) {
                console.error('Failed to create operator:', err);
            }
        }

        // Load apps when admin section becomes visible
        const originalLoadProfile = loadProfile;
        loadProfile = async function(wallet, tgUser) {
            await originalLoadProfile(wallet, tgUser);
            if (ADMIN_ADDRESSES.includes(wallet.toLowerCase())) {
                loadAppsAdmin();
            }
        };
    </script>
</body>
</html>
